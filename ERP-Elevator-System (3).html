<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ambivare Solutions - Elevator Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ea580c;
            --border: #e2e8f0;
            --bg-light: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 20px;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-card {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 48px;
            max-width: 420px;
            width: 100%;
            box-shadow: var(--shadow-lg);
        }

        .logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo h1 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .logo p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-light);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #c2410c;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .main-app {
            display: none;
            min-height: 100vh;
        }

        .main-app.active {
            display: block;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .header-left h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-left p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .offline-badge {
            background: var(--warning);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: none;
        }

        .offline-badge.show {
            display: block;
        }

        .user-badge {
            background: var(--bg-light);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .nav-tabs {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 0;
        }

        .nav-tabs-container {
            display: flex;
            gap: 0;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 14px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-light);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .content {
            padding: 24px 0;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--bg-light);
            border-radius: 6px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 16px;
            position: relative;
        }

        .chart-container canvas {
            max-height: 300px !important;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .charts-grid .card {
            height: 400px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 16px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background: var(--bg-light);
        }

        .table th {
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }

        .table td {
            padding: 12px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        .table tbody tr:hover {
            background: var(--bg-light);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-primary {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-secondary {
            background: var(--bg-light);
            color: var(--text-secondary);
        }

        .search-box {
            position: relative;
            margin-bottom: 16px;
        }

        .search-box input {
            width: 100%;
            max-width: 400px;
            padding: 10px 12px 10px 36px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .search-box::before {
            content: "ðŸ”";
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-dialog {
            background: white;
            border-radius: 8px;
            max-width: 540px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            margin: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-light);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .project-items {
            margin-top: 8px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 4px;
            font-size: 13px;
        }

        .project-items p {
            margin: 4px 0;
            color: var(--text-secondary);
        }

        .low-stock-alert {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .low-stock-alert .icon {
            font-size: 20px;
        }

        .low-stock-list {
            list-style: none;
            padding: 0;
        }

        .low-stock-list li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .low-stock-list li:last-child {
            border-bottom: none;
        }

        .barcode-reader {
            padding: 20px;
            text-align: center;
        }

        #barcodeVideo {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: #000;
        }

        .barcode-result {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 6px;
            font-weight: 600;
            color: var(--primary);
        }

        .camera-permission-info {
            padding: 16px;
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #1e40af;
        }

        .scan-status {
            margin-top: 12px;
            padding: 8px;
            background: #dbeafe;
            border-radius: 4px;
            font-size: 13px;
            color: #1e40af;
        }

        .scan-status.scanning {
            background: #dcfce7;
            color: #166534;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid .card {
                height: 350px;
            }

            .login-card {
                padding: 32px 24px;
            }

            .card {
                padding: 16px;
            }

            .header-right {
                flex-wrap: wrap;
                width: 100%;
            }

            .user-name {
                display: none;
            }

            .filters {
                flex-direction: column;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        /* Billing System Styles */
        .form-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .form-section h4 {
            margin-bottom: 16px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .invoice-items-container {
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            overflow-x: auto;
        }

        .invoice-item-header {
            display: grid;
            grid-template-columns: 2fr 80px 80px 120px 120px 80px;
            gap: 12px;
            padding: 12px;
            background: var(--bg-light);
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
            min-width: 600px;
        }

        .invoice-item {
            display: grid;
            grid-template-columns: 2fr 80px 80px 120px 120px 80px;
            gap: 12px;
            padding: 12px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            min-width: 600px;
        }

        .invoice-item:last-child {
            border-bottom: none;
        }

        .invoice-item input,
        .invoice-item select {
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }

        .invoice-totals {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .total-display {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .total-amount {
            font-size: 18px;
            color: var(--success);
        }

        .billing-stats-grid .stat-card {
            text-align: center;
        }

        .invoice-status-paid {
            background: #dcfce7;
            color: #166534;
        }

        .invoice-status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .invoice-status-overdue {
            background: #fef2f2;
            color: #991b1b;
        }

        .invoice-status-draft {
            background: #f1f5f9;
            color: #475569;
        }

        .invoice-status-sent {
            background: #dbeafe;
            color: #1e40af;
        }

        .invoice-status-cancelled {
            background: #f3f4f6;
            color: #6b7280;
        }

        /* Mobile Billing Optimizations */
        @media (max-width: 768px) {
            .billing-stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
            }

            .filters {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 12px !important;
            }

            .filters input,
            .filters select {
                width: 100% !important;
                min-width: auto !important;
            }

            .card-header {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 16px !important;
            }

            .card-header > div {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            .action-buttons {
                flex-direction: column !important;
                gap: 6px !important;
            }

            .action-buttons .btn {
                width: 100%;
                justify-content: center;
            }

            /* Invoice Modal Mobile Optimization */
            #invoiceModal .modal-dialog {
                max-width: 95% !important;
                margin: 10px !important;
            }

            .invoice-items-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .invoice-item-header {
                min-width: 700px;
                font-size: 12px;
                padding: 8px;
                gap: 8px;
            }

            .invoice-item {
                min-width: 700px;
                padding: 8px;
                gap: 8px;
            }

            .invoice-item input {
                font-size: 13px;
                padding: 4px 6px;
            }

            .invoice-totals .form-row {
                flex-direction: column !important;
            }

            .form-section h4 {
                font-size: 14px;
                margin-bottom: 12px;
            }

            .form-row {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* Table responsiveness for billing */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table-responsive table {
                min-width: 700px;
            }

            .table-responsive th,
            .table-responsive td {
                padding: 8px 6px;
                font-size: 13px;
                white-space: nowrap;
            }

            /* Stats cards mobile */
            .stat-card {
                padding: 16px !important;
            }

            .stat-value {
                font-size: 24px !important;
            }

            .stat-label {
                font-size: 13px !important;
            }
        }

        @media (max-width: 480px) {
            .billing-stats-grid {
                grid-template-columns: 1fr !important;
            }

            .table-responsive table {
                min-width: 600px;
            }

            .invoice-item-header,
            .invoice-item {
                min-width: 600px;
                grid-template-columns: 1.5fr 60px 60px 100px 100px 60px;
                font-size: 11px;
            }

            .card-header h3 {
                font-size: 16px;
            }

            .modal-dialog {
                margin: 5px !important;
            }
        }

        /* Progress Bar Styles */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-light);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        /* Project Details Styles */
        .project-details {
            margin-top: 4px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .project-details small {
            display: block;
            margin-bottom: 2px;
        }

        /* Form Section Styles */
        .form-section {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h4 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }

    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="logo">
                <img src="ambivare.png" alt="Ambivare Solutions" style="max-width: 150px; margin-bottom: 16px;">
                <h1>Ambivare Solutions</h1>
                <p>Elevator Management System</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" class="form-control" id="username" required placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-control" id="password" required placeholder="Enter password">
                </div>
                <div id="loginError" class="alert alert-danger" style="display: none;"></div>
                <button type="submit" class="btn btn-primary" id="loginBtn">Sign In</button>
            </form>
        </div>
    </div>

    <div class="main-app" id="mainApp">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="header-left" style="display: flex; align-items: center; gap: 12px;">
                        <img src="ambivare.png" alt="Ambivare Solutions" style="height: 40px;">
                        <div>
                            <h2>Ambivare Solutions</h2>
                            <p>Elevator Management Portal</p>
                        </div>
                    </div>
                    <div class="header-right">
                        <div class="offline-badge" id="offlineBadge">OFFLINE MODE</div>
                        <span class="user-badge" id="userRole">USER</span>
                        <span class="user-name" id="userName">User</span>
                        <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <div class="container">
                <div class="nav-tabs-container">
                    <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
                    <button class="nav-tab" onclick="showTab('warehouse')">Warehouse</button>
                    <button class="nav-tab" onclick="showTab('service-van')">Service Van</button>
                    <button class="nav-tab" onclick="showTab('office')">Office</button>
                    <button class="nav-tab" onclick="showTab('projects')">Projects</button>
                    <button class="nav-tab" onclick="showTab('maintenance')">Maintenance</button>
                    <button class="nav-tab" onclick="showTab('activities')">Activities</button>
                    <button class="nav-tab" onclick="showTab('billing')">Billing</button>
                    <button class="nav-tab" id="usersTabBtn" onclick="showTab('users')" style="display: none;">Users</button>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="container">
                <div class="tab-pane active" id="dashboardTab">
                    <div id="lowStockAlerts"></div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">Total Parts</div>
                            <div class="stat-value" id="totalItems">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Warehouse Stock</div>
                            <div class="stat-value" id="warehouseItems">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Service Van Stock</div>
                            <div class="stat-value" id="serviceVanItems">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Office Supplies</div>
                            <div class="stat-value" id="officeItems">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Active Projects</div>
                            <div class="stat-value" id="activeProjects">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Maintenance Due</div>
                            <div class="stat-value" id="maintenanceDue">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Elevators Installed</div>
                            <div class="stat-value" id="elevatorsInstalled">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Low Stock Items</div>
                            <div class="stat-value" id="lowStockItems">0</div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="card">
                            <h3 class="card-title">Inventory by Location</h3>
                            <div class="chart-container">
                                <canvas id="locationChart"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <h3 class="card-title">Stock Levels</h3>
                            <div class="chart-container">
                                <canvas id="stockChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Warehouse Tab -->
                <div class="tab-pane" id="warehouseTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Warehouse Inventory</h3>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" onclick="showBarcodeScanner('warehouse')">ðŸ“· Scan Barcode</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportLocationPDF('warehouse')">ðŸ“¥ Export PDF</button>
                                <button class="btn btn-success btn-sm" onclick="showAddInventoryModal('warehouse')">+ Add Item</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchWarehouse" placeholder="Search..." oninput="filterLocation('warehouse')">
                            </div>
                            <div class="filter-group">
                                <label>Category</label>
                                <select id="categoryFilterWarehouse" onchange="filterLocation('warehouse')">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="statusFilterWarehouse" onchange="filterLocation('warehouse')">
                                    <option value="">All Status</option>
                                    <option value="good">Good Stock</option>
                                    <option value="medium">Medium Stock</option>
                                    <option value="low">Low Stock</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="warehouseList">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Office Tab -->
                <div class="tab-pane" id="officeTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Office Inventory</h3>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" onclick="showBarcodeScanner('office')">ðŸ“· Scan Barcode</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportLocationPDF('office')">ðŸ“¥ Export PDF</button>
                                <button class="btn btn-success btn-sm" onclick="showAddInventoryModal('office')">+ Add Item</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchOffice" placeholder="Search..." oninput="filterLocation('office')">
                            </div>
                            <div class="filter-group">
                                <label>Category</label>
                                <select id="categoryFilterOffice" onchange="filterLocation('office')">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="statusFilterOffice" onchange="filterLocation('office')">
                                    <option value="">All Status</option>
                                    <option value="good">Good Stock</option>
                                    <option value="medium">Medium Stock</option>
                                    <option value="low">Low Stock</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="officeList">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Service Van Tab -->
                <div class="tab-pane" id="service-vanTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Service Van Inventory</h3>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" onclick="showBarcodeScanner('service-van')">ðŸ“· Scan Barcode</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportLocationPDF('service-van')">ðŸ“¥ Export PDF</button>
                                <button class="btn btn-success btn-sm" onclick="showAddInventoryModal('service-van')">+ Add Item</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchServiceVan" placeholder="Search..." oninput="filterLocation('service-van')">
                            </div>
                            <div class="filter-group">
                                <label>Category</label>
                                <select id="categoryFilterServiceVan" onchange="filterLocation('service-van')">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="statusFilterServiceVan" onchange="filterLocation('service-van')">
                                    <option value="">All Status</option>
                                    <option value="good">Good Stock</option>
                                    <option value="medium">Medium Stock</option>
                                    <option value="low">Low Stock</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="serviceVanList">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Projects Tab -->
                <div class="tab-pane" id="projectsTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Project Management</h3>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="exportProjectsPDF()">ðŸ“¥ Export PDF</button>
                                <button class="btn btn-success btn-sm" onclick="showAddProjectModal()">+ Create Project</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchProjects" placeholder="Search..." oninput="filterProjects()">
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="projectStatusFilter" onchange="filterProjects()">
                                    <option value="">All Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Completed">Completed</option>
                                    <option value="On Hold">On Hold</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Project Name</th>
                                        <th>Code</th>
                                        <th>Client</th>
                                        <th>Elevators</th>
                                        <th>Progress</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="projectList">
                                    <tr><td colspan="7" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Maintenance Tab -->
                <div class="tab-pane" id="maintenanceTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Maintenance Management</h3>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="exportMaintenancePDF()">ðŸ“¥ Export PDF</button>
                                <button class="btn btn-success btn-sm" onclick="showAddMaintenanceModal()">+ Schedule Maintenance</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchMaintenance" placeholder="Search..." oninput="filterMaintenance()">
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="maintenanceStatusFilter" onchange="filterMaintenance()">
                                    <option value="">All Status</option>
                                    <option value="Scheduled">Scheduled</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Overdue">Overdue</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Priority</label>
                                <select id="maintenancePriorityFilter" onchange="filterMaintenance()">
                                    <option value="">All Priority</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Assigned To</label>
                                <select id="maintenanceAssigneeFilter" onchange="filterMaintenance()">
                                    <option value="">All Technicians</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Elevator ID</th>
                                        <th>Project</th>
                                        <th>Issue</th>
                                        <th>Priority</th>
                                        <th>Assigned To</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenanceList">
                                    <tr><td colspan="8" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Activities Tab -->
                <div class="tab-pane" id="activitiesTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Activity Logs</h3>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('day')">ðŸ“¥ Day</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('week')">ðŸ“¥ Week</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('month')">ðŸ“¥ Month</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('quarter')">ðŸ“¥ Quarter</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('halfyear')">ðŸ“¥ Half Year</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('year')">ðŸ“¥ Year</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchActivities" placeholder="Search..." oninput="filterActivities()">
                            </div>
                            <div class="filter-group">
                                <label>Date Range</label>
                                <select id="activityDateFilter" onchange="filterActivities()">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="halfyear">Last 6 Months</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>User</label>
                                <select id="activityUserFilter" onchange="filterActivities()">
                                    <option value="">All Users</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>Action</th>
                                        <th>User</th>
                                    </tr>
                                </thead>
                                <tbody id="activityList">
                                    <tr><td colspan="3" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div class="tab-pane" id="usersTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">User Management</h3>
                            <button class="btn btn-success btn-sm" onclick="showAddUserModal()">+ Add User</button>
                        </div>
                        <div class="search-box">
                            <input type="text" id="searchUsers" placeholder="Search users..." onkeyup="filterUsers()">
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Full Name</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersList">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Billing Tab -->
                <div class="tab-pane" id="billingTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Billing & Invoicing</h3>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-success" onclick="showCreateInvoiceModal()">+ Create Invoice</button>
                                <button class="btn btn-primary" onclick="showQuotationModal()">+ Create Quotation</button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 20px; margin-bottom: 24px;">
                            <div class="filters">
                                <input type="text" id="searchInvoices" placeholder="Search invoices..." oninput="filterInvoices()">
                                <select id="invoiceStatusFilter" onchange="filterInvoices()">
                                    <option value="">All Status</option>
                                    <option value="draft">Draft</option>
                                    <option value="sent">Sent</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <select id="invoiceTypeFilter" onchange="filterInvoices()">
                                    <option value="">All Types</option>
                                    <option value="invoice">Invoice</option>
                                    <option value="quotation">Quotation</option>
                                </select>
                            </div>
                        </div>

                        <div class="billing-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div class="stat-card">
                                <div class="stat-value" id="totalInvoices">0</div>
                                <div class="stat-label">Total Invoices</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="totalRevenue">â‚¹0</div>
                                <div class="stat-label">Total Revenue</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="pendingAmount">â‚¹0</div>
                                <div class="stat-label">Pending Amount</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="overdueInvoices">0</div>
                                <div class="stat-label">Overdue Invoices</div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Type</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Due Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoicesList">
                                    <tr><td colspan="8" class="empty-state"><div class="empty-state-icon">ðŸ“„</div><p>No invoices created yet. Click "Create Invoice" to get started.</p></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div class="modal" id="inventoryModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title" id="inventoryModalTitle">Add Inventory Item</h3>
                <button class="modal-close" onclick="closeModal('inventoryModal')">&times;</button>
            </div>
            <form id="inventoryForm">
                <div class="modal-body">
                    <input type="hidden" id="editItemId">
                    <input type="hidden" id="itemLocation">
                    <div class="form-group">
                        <label>Item Name *</label>
                        <input type="text" class="form-control" id="itemName" required>
                    </div>
                    <div class="form-group">
                        <label>Barcode/SKU</label>
                        <input type="text" class="form-control" id="itemBarcode" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select class="form-control" id="itemCategory" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Quantity *</label>
                            <input type="number" class="form-control" id="itemQuantity" required min="0">
                        </div>
                        <div class="form-group">
                            <label>Unit *</label>
                            <input type="text" class="form-control" id="itemUnit" required placeholder="e.g. pcs, kg, m">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" class="form-control" id="itemDescription" placeholder="Additional details">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('inventoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Use Inventory Modal -->
    <div class="modal" id="useModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Use Inventory</h3>
                <button class="modal-close" onclick="closeModal('useModal')">&times;</button>
            </div>
            <form id="useForm">
                <div class="modal-body">
                    <input type="hidden" id="useItemId">
                    <div class="form-group">
                        <label>Item: <strong id="useItemName"></strong></label>
                        <p class="info-text">Available: <span id="useAvailable"></span></p>
                    </div>
                    <div class="form-group">
                        <label>Quantity to Use *</label>
                        <input type="number" class="form-control" id="useQuantity" required min="1">
                    </div>
                    <div class="form-group">
                        <label>Assign to Project *</label>
                        <select class="form-control" id="useProject" required>
                            <option value="">Select Project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" class="form-control" id="useNotes" placeholder="Optional notes">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('useModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Use & Assign</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div class="modal" id="addStockModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Add Stock</h3>
                <button class="modal-close" onclick="closeModal('addStockModal')">&times;</button>
            </div>
            <form id="addStockForm">
                <div class="modal-body">
                    <input type="hidden" id="addStockItemId">
                    <div class="form-group">
                        <label>Item: <strong id="addStockItemName"></strong></label>
                        <p class="info-text">Current: <span id="addStockCurrent"></span></p>
                    </div>
                    <div class="form-group">
                        <label>Quantity to Add *</label>
                        <input type="number" class="form-control" id="addStockQuantity" required min="1">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" class="form-control" id="addStockNotes" placeholder="Optional notes">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addStockModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Stock</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title" id="projectModalTitle">Create New Project</h3>
                <button class="modal-close" onclick="closeModal('projectModal')">&times;</button>
            </div>
            <form id="projectForm">
                <div class="modal-body">
                    <input type="hidden" id="editProjectId">
                    <div class="form-group">
                        <label>Project Name *</label>
                        <input type="text" class="form-control" id="projectName" required>
                    </div>
                    <div class="form-group">
                        <label>Project Code *</label>
                        <input type="text" class="form-control" id="projectCode" required>
                    </div>
                    <div class="form-group">
                        <label>Client/Customer *</label>
                        <input type="text" class="form-control" id="projectClient" required placeholder="Enter client name">
                    </div>
                    <div class="form-group">
                        <label>Project Type *</label>
                        <select class="form-control" id="projectType" required>
                            <option value="">Select Type</option>
                            <option value="Installation">New Installation</option>
                            <option value="Modernization">Modernization</option>
                            <option value="Maintenance">Maintenance Contract</option>
                            <option value="Repair">Emergency Repair</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Building Address</label>
                        <textarea class="form-control" id="projectAddress" rows="2" placeholder="Enter complete building address"></textarea>
                    </div>
                    
                    <!-- Elevator Configuration -->
                    <div class="form-section">
                        <h4>Elevator Configuration</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Number of Elevators *</label>
                                <input type="number" class="form-control" id="projectElevatorCount" min="1" required onchange="generateElevatorFields()">
                            </div>
                            <div class="form-group">
                                <label>Elevator Type *</label>
                                <select class="form-control" id="projectElevatorType" required>
                                    <option value="">Select Type</option>
                                    <option value="Passenger">Passenger Elevator</option>
                                    <option value="Freight">Freight Elevator</option>
                                    <option value="Hospital">Hospital Elevator</option>
                                    <option value="Service">Service Elevator</option>
                                    <option value="Residential">Residential Elevator</option>
                                </select>
                            </div>
                        </div>
                        <div id="elevatorDetails" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Capacity (Persons/Kg)</label>
                                    <input type="text" class="form-control" id="projectCapacity" placeholder="e.g., 8 persons / 630kg">
                                </div>
                                <div class="form-group">
                                    <label>Floors Served</label>
                                    <input type="text" class="form-control" id="projectFloors" placeholder="e.g., G+5 floors">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Machine Type</label>
                                    <select class="form-control" id="projectMachineType">
                                        <option value="">Select Machine Type</option>
                                        <option value="Geared">Geared Traction</option>
                                        <option value="Gearless">Gearless Traction</option>
                                        <option value="Hydraulic">Hydraulic</option>
                                        <option value="MRL">Machine Room Less (MRL)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Speed (m/s)</label>
                                    <input type="number" class="form-control" id="projectSpeed" step="0.1" placeholder="e.g., 1.0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" class="form-control" id="projectStartDate">
                        </div>
                        <div class="form-group">
                            <label>Expected Completion</label>
                            <input type="date" class="form-control" id="projectEndDate">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Status *</label>
                            <select class="form-control" id="projectStatus" required>
                                <option value="Active">Active</option>
                                <option value="Completed">Completed</option>
                                <option value="On Hold">On Hold</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Progress %</label>
                            <input type="number" class="form-control" id="projectProgress" min="0" max="100" value="0">
                        </div>
                    </div>
                    <div id="projectItemsSection" style="display: none;">
                        <div class="form-group">
                            <label>Allocated Items</label>
                            <div id="projectItemsList" class="project-items"></div>
                        </div>
                        <div class="form-group">
                            <label>Return Remaining Stock</label>
                            <div id="returnItemsList"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                    <button type="submit" class="btn btn-success" id="projectSubmitBtn">Create Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div class="modal" id="userModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">Add User</h3>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <form id="userForm">
                <div class="modal-body">
                    <input type="hidden" id="editUserId">
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" class="form-control" id="newUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" class="form-control" id="newFullName" required>
                    </div>
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="password" class="form-control" id="newPassword" required minlength="6">
                        <p class="info-text">Minimum 6 characters</p>
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <select class="form-control" id="newUserRole" required>
                            <option value="">Select Role</option>
                            <option value="admin">Admin</option>
                            <option value="user">User</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status *</label>
                        <select class="form-control" id="newUserStatus" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div class="modal" id="barcodeModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Barcode Scanner</h3>
                <button class="modal-close" onclick="closeBarcodeScanner()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="camera-permission-info" id="cameraPermissionInfo" style="display: none;">
                    â„¹ï¸ Camera access is required to scan barcodes. Please allow camera permission when prompted.
                </div>
                <div class="barcode-reader">
                    <video id="barcodeVideo" autoplay playsinline></video>
                    <div id="scanStatus" class="scan-status">Initializing scanner...</div>
                    <div id="barcodeResult" class="barcode-result" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeBarcodeScanner()">Close</button>
            </div>
        </div>
    </div>

    <!-- Maintenance Modal -->
    <div class="modal" id="maintenanceModal">
        <div class="modal-dialog" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title" id="maintenanceModalTitle">Schedule Maintenance</h3>
                <button class="modal-close" onclick="closeModal('maintenanceModal')">&times;</button>
            </div>
            <form id="maintenanceForm">
                <div class="modal-body">
                    <input type="hidden" id="editMaintenanceId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maintenanceProject">Project *</label>
                            <select class="form-control" id="maintenanceProject" required onchange="loadElevators()">
                                <option value="">Select Project</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maintenanceElevator">Elevator *</label>
                            <select class="form-control" id="maintenanceElevator" required>
                                <option value="">Select Elevator</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenanceIssue">Issue Description *</label>
                        <textarea class="form-control" id="maintenanceIssue" rows="3" required placeholder="Describe the issue or maintenance task"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maintenancePriority">Priority *</label>
                            <select class="form-control" id="maintenancePriority" required>
                                <option value="">Select Priority</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maintenanceAssignee">Assign To *</label>
                            <select class="form-control" id="maintenanceAssignee" required>
                                <option value="">Select Technician</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maintenanceDueDate">Due Date *</label>
                            <input type="date" class="form-control" id="maintenanceDueDate" required>
                        </div>
                        <div class="form-group">
                            <label for="maintenanceStatus">Status</label>
                            <select class="form-control" id="maintenanceStatus">
                                <option value="Scheduled">Scheduled</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenanceNotes">Additional Notes</label>
                        <textarea class="form-control" id="maintenanceNotes" rows="2" placeholder="Any additional notes or instructions"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('maintenanceModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Schedule Maintenance</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invoice/Quotation Modal -->
    <div class="modal" id="invoiceModal">
        <div class="modal-dialog" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="invoiceModalTitle">Create Invoice</h3>
                <button class="modal-close" onclick="closeModal('invoiceModal')">&times;</button>
            </div>
            <form id="invoiceForm">
                <div class="modal-body">
                    <input type="hidden" id="editInvoiceId">
                    <input type="hidden" id="invoiceType" value="invoice">

                    <!-- Client Information -->
                    <div class="form-section">
                        <h4>Client Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clientName">Client Name *</label>
                                <input type="text" class="form-control" id="clientName" required>
                            </div>
                            <div class="form-group">
                                <label for="clientEmail">Email</label>
                                <input type="email" class="form-control" id="clientEmail">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clientPhone">Phone</label>
                                <input type="text" class="form-control" id="clientPhone">
                            </div>
                            <div class="form-group">
                                <label for="clientGST">GST Number</label>
                                <input type="text" class="form-control" id="clientGST">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="clientAddress">Address</label>
                            <textarea class="form-control" id="clientAddress" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- Invoice Details -->
                    <div class="form-section">
                        <h4>Invoice Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="invoiceNumber">Invoice Number *</label>
                                <input type="text" class="form-control" id="invoiceNumber" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceDate">Invoice Date *</label>
                                <input type="date" class="form-control" id="invoiceDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dueDate">Due Date</label>
                                <input type="date" class="form-control" id="dueDate">
                            </div>
                            <div class="form-group">
                                <label for="poNumber">PO Number</label>
                                <input type="text" class="form-control" id="poNumber">
                            </div>
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h4>Items</h4>
                            <button type="button" class="btn btn-success btn-sm" onclick="addInvoiceItem()">+ Add Item</button>
                        </div>
                        <div class="invoice-items-container">
                            <div class="invoice-item-header">
                                <div>Description</div>
                                <div>Qty</div>
                                <div>Unit</div>
                                <div>Rate (â‚¹)</div>
                                <div>Amount (â‚¹)</div>
                                <div>Action</div>
                            </div>
                            <div id="invoiceItemsList">
                                <!-- Invoice items will be added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Totals -->
                    <div class="form-section">
                        <div class="invoice-totals">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Subtotal</label>
                                    <div class="total-display" id="subtotalDisplay">â‚¹0.00</div>
                                </div>
                                <div class="form-group">
                                    <label for="discountPercent">Discount (%)</label>
                                    <input type="number" class="form-control" id="discountPercent" min="0" max="100" step="0.01" value="0" onchange="calculateInvoiceTotal()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="gstPercent">GST (%)</label>
                                    <input type="number" class="form-control" id="gstPercent" min="0" max="100" step="0.01" value="18" onchange="calculateInvoiceTotal()">
                                </div>
                                <div class="form-group">
                                    <label>Total Amount</label>
                                    <div class="total-display total-amount" id="totalAmountDisplay">â‚¹0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-section">
                        <div class="form-group">
                            <label for="invoiceNotes">Notes</label>
                            <textarea class="form-control" id="invoiceNotes" rows="3" placeholder="Payment terms, additional information..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('invoiceModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Company Settings Modal -->
    <div class="modal" id="companyModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Company Settings</h3>
                <button class="modal-close" onclick="closeModal('companyModal')">&times;</button>
            </div>
            <form id="companyForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="companyName">Company Name *</label>
                        <input type="text" class="form-control" id="companyName" value="Ambivare Solutions" required>
                    </div>
                    <div class="form-group">
                        <label for="companyAddress">Address</label>
                        <textarea class="form-control" id="companyAddress" rows="3" placeholder="Company address"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyPhone">Phone</label>
                            <input type="text" class="form-control" id="companyPhone">
                        </div>
                        <div class="form-group">
                            <label for="companyEmail">Email</label>
                            <input type="email" class="form-control" id="companyEmail">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyGST">GST Number</label>
                            <input type="text" class="form-control" id="companyGST">
                        </div>
                        <div class="form-group">
                            <label for="companyCIN">CIN Number</label>
                            <input type="text" class="form-control" id="companyCIN">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="companyBankDetails">Bank Details</label>
                        <textarea class="form-control" id="companyBankDetails" rows="3" placeholder="Bank name, account number, IFSC code, etc."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('companyModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Settings</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyC2jWIdCA6VQMrZB8yanb3HQFzN9e6KXY0",
            authDomain: "dazzlojewellers.firebaseapp.com",
            projectId: "dazzlojewellers",
            storageBucket: "dazzlojewellers.firebasestorage.app",
            messagingSenderId: "334783357818",
            appId: "1:334783357818:web:3009541b14699606fd2cc3",
            measurementId: "G-288DC3S9LM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const ADMIN_USERNAME = "Testing";
        const ADMIN_PASSWORD = "Testing";
        const SESSION_KEY = "ambivare_session";

        const CATEGORIES = {
            warehouse: ["Motors", "Controllers", "Cables", "Rails", "Car Equipment", "Safety Components", "Door Systems", "Fixtures", "Tools", "Hardware", "Other"],
            office: ["Stationery", "Paper", "Folders", "Pens", "Markers", "Toner", "Printer Supplies", "Furniture", "Electronics", "Other"],
            "service-van": ["Emergency Parts", "Tools", "Testing Equipment", "Safety Gear", "Sensors", "Controllers", "Cables", "Car Parts", "Door Parts", "Other"]
        };

        let currentUser = null;
        let inventory = { warehouse: [], office: [], "service-van": [] };
        let projects = [];
        let maintenance = [];
        let activities = [];
        let users = [];
        let invoices = [];
        let companySettings = {
            name: 'Ambivare Solutions',
            address: '',
            phone: '',
            email: '',
            gst: '',
            cin: '',
            bankDetails: ''
        };
        let isOnline = navigator.onLine;
        let locationChart = null;
        let stockChart = null;
        let barcodeCodeReader = null;
        let barcodeStream = null;
        let scanningActive = false;
        let currentScanLocation = null;

        window.addEventListener('online', () => {
            isOnline = true;
            document.getElementById('offlineBadge').classList.remove('show');
            syncOfflineData();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            document.getElementById('offlineBadge').classList.add('show');
        });

        window.addEventListener('load', () => {
            checkSession();
        });

        function checkSession() {
            try {
                const savedSession = localStorage.getItem(SESSION_KEY);
                if (savedSession) {
                    const sessionData = JSON.parse(savedSession);
                    if (sessionData && sessionData.user) {
                        currentUser = sessionData.user;
                        showMainApp();
                        loadData();
                    }
                }
            } catch (error) {
                console.error('Error restoring session:', error);
                localStorage.removeItem(SESSION_KEY);
            }
        }

        function saveSession(user) {
            try {
                const sessionData = {
                    user: user,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
            } catch (error) {
                console.error('Error saving session:', error);
            }
        }

        function clearSession() {
            localStorage.removeItem(SESSION_KEY);
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            loginError.style.display = 'none';

            try {
                if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                    currentUser = {
                        id: 'admin',
                        username: ADMIN_USERNAME,
                        fullName: 'Administrator',
                        role: 'admin',
                        status: 'active'
                    };
                    saveSession(currentUser);
                    showMainApp();
                    await loadData();
                    return;
                }

                if (isOnline) {
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    let foundUser = null;

                    usersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.username === username && userData.password === password) {
                            foundUser = { id: doc.id, ...userData };
                        }
                    });

                    if (foundUser && foundUser.status === 'active') {
                        currentUser = foundUser;
                        saveSession(currentUser);
                        showMainApp();
                        await loadData();
                    } else {
                        throw new Error('Invalid credentials or account is inactive');
                    }
                } else {
                    throw new Error('Cannot login in offline mode. Please check your internet connection.');
                }
            } catch (error) {
                loginError.textContent = error.message;
                loginError.style.display = 'block';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        });

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('active');
            document.getElementById('userName').textContent = currentUser.fullName || currentUser.username;
            document.getElementById('userRole').textContent = currentUser.role.toUpperCase();
            
            if (currentUser.role === 'admin') {
                document.getElementById('usersTabBtn').style.display = 'block';
            }

            if (!isOnline) {
                document.getElementById('offlineBadge').classList.add('show');
            }
        }

        window.logout = () => {
            if (confirm('Are you sure you want to logout?')) {
                clearSession();
                currentUser = null;
                document.getElementById('mainApp').classList.remove('active');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginForm').reset();
                document.getElementById('usersTabBtn').style.display = 'none';
                showTab('dashboard');
            }
        };

        async function loadData() {
            try {
                await Promise.all([
                    loadInventory(),
                    loadProjects(),
                    loadMaintenance(),
                    loadActivities(),
                    loadUsers(),
                    loadInvoices(),
                    loadCompanySettings()
                ]);
                updateDashboard();
                renderCharts();
                checkLowStock();
                populateCategoryFilters();
                populateActivityUserFilter();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        async function loadInventory() {
            const snapshot = await getDocs(collection(db, 'inventory'));
            inventory = { warehouse: [], office: [], "service-van": [] };
            snapshot.docs.forEach(doc => {
                const item = { id: doc.id, ...doc.data() };
                if (inventory[item.location]) {
                    inventory[item.location].push(item);
                }
            });
            renderLocation('warehouse');
            renderLocation('office');
            renderLocation('service-van');
        }

        async function loadProjects() {
            const snapshot = await getDocs(collection(db, 'projects'));
            projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderProjects();
        }

        async function loadMaintenance() {
            const snapshot = await getDocs(collection(db, 'maintenance'));
            maintenance = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderMaintenance();
        }

        async function loadActivities() {
            const q = query(collection(db, 'activities'), orderBy('date', 'desc'));
            const snapshot = await getDocs(q);
            activities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderActivities();
        }

        async function loadUsers() {
            if (currentUser.role !== 'admin') return;
            const snapshot = await getDocs(collection(db, 'users'));
            users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderUsers();
        }

        function syncOfflineData() {
            loadData();
        }

        function getAllItems() {
            return [...inventory.warehouse, ...inventory.office, ...inventory["service-van"]];
        }

        function updateDashboard() {
            const allItems = getAllItems();
            document.getElementById('totalItems').textContent = allItems.length;
            document.getElementById('warehouseItems').textContent = inventory.warehouse.length;
            document.getElementById('serviceVanItems').textContent = inventory["service-van"].length;
            document.getElementById('officeItems').textContent = inventory.office.length;
            document.getElementById('activeProjects').textContent = projects.filter(p => p.status === 'Active').length;
            document.getElementById('maintenanceDue').textContent = maintenance.filter(m => m.status === 'Scheduled' || m.status === 'Overdue').length;
            
            // Calculate total elevators installed
            const totalElevators = projects.reduce((sum, project) => {
                return sum + (project.elevators ? project.elevators.length : 0);
            }, 0);
            document.getElementById('elevatorsInstalled').textContent = totalElevators;
            
            const lowStock = allItems.filter(item => item.quantity < 50).length;
            document.getElementById('lowStockItems').textContent = lowStock;
        }

        function checkLowStock() {
            const allItems = getAllItems();
            const lowStockItems = allItems.filter(item => item.quantity < 50);
            const alertContainer = document.getElementById('lowStockAlerts');
            
            if (lowStockItems.length > 0) {
                alertContainer.innerHTML = `
                    <div class="low-stock-alert">
                        <span class="icon">âš ï¸</span>
                        <div style="flex: 1;">
                            <strong>Low Stock Alert!</strong>
                            <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-secondary);">
                                ${lowStockItems.length} item(s) are running low
                            </p>
                            <ul class="low-stock-list" style="margin-top: 8px;">
                                ${lowStockItems.slice(0, 5).map(item => `
                                    <li>
                                        <strong>${item.name}</strong> (${item.location}): ${item.quantity} ${item.unit} remaining
                                    </li>
                                `).join('')}
                                ${lowStockItems.length > 5 ? `<li>... and ${lowStockItems.length - 5} more</li>` : ''}
                            </ul>
                        </div>
                    </div>
                `;
            } else {
                alertContainer.innerHTML = '';
            }
        }

        function renderCharts() {
            renderLocationChart();
            renderStockChart();
        }

        function renderLocationChart() {
            const ctx = document.getElementById('locationChart');
            if (!ctx) return;

            const data = {
                Store: inventory.store.length,
                Office: inventory.office.length,
                Kitchen: inventory.kitchen.length
            };

            if (locationChart) locationChart.destroy();

            locationChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: ['#2563eb', '#16a34a', '#ea580c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderStockChart() {
            const ctx = document.getElementById('stockChart');
            if (!ctx) return;

            const allItems = getAllItems();
            const goodStock = allItems.filter(i => i.quantity >= 200).length;
            const mediumStock = allItems.filter(i => i.quantity >= 50 && i.quantity < 200).length;
            const lowStock = allItems.filter(i => i.quantity < 50).length;

            if (stockChart) stockChart.destroy();

            stockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Good Stock', 'Medium Stock', 'Low Stock'],
                    datasets: [{
                        label: 'Items',
                        data: [goodStock, mediumStock, lowStock],
                        backgroundColor: ['#16a34a', '#ea580c', '#dc2626']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function getFilteredLocationItems(location) {
            const searchValue = document.getElementById(`search${location.charAt(0).toUpperCase() + location.slice(1)}`).value.toLowerCase();
            const categoryValue = document.getElementById(`categoryFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            const statusValue = document.getElementById(`statusFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            
            return inventory[location].filter(item => {
                const text = `${item.name} ${item.category} ${item.description || ''}`.toLowerCase();
                const matchesSearch = text.includes(searchValue);
                const matchesCategory = !categoryValue || item.category === categoryValue;
                
                let matchesStatus = true;
                if (statusValue) {
                    const stockClass = item.quantity < 50 ? 'low' : item.quantity < 200 ? 'medium' : 'good';
                    matchesStatus = stockClass === statusValue;
                }
                
                return matchesSearch && matchesCategory && matchesStatus;
            });
        }

        function getFilteredProjects() {
            const searchValue = document.getElementById('searchProjects').value.toLowerCase();
            const statusValue = document.getElementById('projectStatusFilter').value;
            
            return projects.filter(proj => {
                const text = `${proj.name} ${proj.code} ${proj.client || ''} ${proj.description || ''}`.toLowerCase();
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusValue || proj.status === statusValue;
                
                return matchesSearch && matchesStatus;
            });
        }

        function getFilteredActivities() {
            const searchValue = document.getElementById('searchActivities').value.toLowerCase();
            const dateRange = document.getElementById('activityDateFilter').value;
            const userFilter = document.getElementById('activityUserFilter').value;
            
            const now = new Date();
            
            return activities.filter(act => {
                const text = act.action.toLowerCase();
                const user = act.user || '';
                const date = new Date(act.date);
                
                const matchesSearch = text.includes(searchValue);
                const matchesUser = !userFilter || user === userFilter;
                
                let matchesDate = true;
                if (dateRange !== 'all') {
                    const dayMs = 24 * 60 * 60 * 1000;
                    const diff = now - date;
                    
                    switch(dateRange) {
                        case 'today':
                            matchesDate = diff < dayMs;
                            break;
                        case 'week':
                            matchesDate = diff < 7 * dayMs;
                            break;
                        case 'month':
                            matchesDate = diff < 30 * dayMs;
                            break;
                        case 'quarter':
                            matchesDate = diff < 90 * dayMs;
                            break;
                        case 'halfyear':
                            matchesDate = diff < 180 * dayMs;
                            break;
                        case 'year':
                            matchesDate = diff < 365 * dayMs;
                            break;
                    }
                }
                
                return matchesSearch && matchesUser && matchesDate;
            });
        }

        function renderLocation(location) {
            const tbody = document.getElementById(`${location}List`);
            const items = inventory[location];
            
            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">ðŸ“¦</div><p>No items in ${location}. Click "Add Item" to get started.</p></td></tr>`;
                return;
            }

            tbody.innerHTML = items.map(item => {
                const stockClass = item.quantity < 50 ? 'danger' : item.quantity < 200 ? 'warning' : 'success';
                const stockText = item.quantity < 50 ? 'Low Stock' : item.quantity < 200 ? 'Medium' : 'Good';
                const stockStatus = item.quantity < 50 ? 'low' : item.quantity < 200 ? 'medium' : 'good';
                
                return `
                    <tr data-category="${item.category}" data-status="${stockStatus}">
                        <td>
                            <strong>${item.name}</strong>
                            ${item.barcode ? `<br><small style="color: var(--text-secondary);">SKU: ${item.barcode}</small>` : ''}
                            ${item.description ? `<br><small style="color: var(--text-secondary);">${item.description}</small>` : ''}
                        </td>
                        <td>${item.category}</td>
                        <td><strong>${item.quantity}</strong> ${item.unit}</td>
                        <td><span class="badge badge-${stockClass}">${stockText}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-success btn-sm" onclick="showAddStockModal('${item.id}')">+ Add</button>
                                <button class="btn btn-primary btn-sm" onclick="showUseModal('${item.id}')">Use</button>
                                <button class="btn btn-secondary btn-sm" onclick="editInventory('${item.id}')">Edit</button>
                                ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteInventory('${item.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderProjects() {
            const tbody = document.getElementById('projectList');
            if (projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">ðŸ“‹</div><p>No projects. Click "Create Project" to get started.</p></td></tr>';
                return;
            }

            tbody.innerHTML = projects.map(proj => {
                const statusClass = proj.status === 'Active' ? 'success' : proj.status === 'Completed' ? 'primary' : 'secondary';
                const elevatorInfo = proj.elevatorCount ? `${proj.elevatorCount} ${proj.elevatorType || 'Elevator'}(s)` : 'Not specified';
                const progressBar = proj.progress ? `<div class="progress-bar"><div class="progress-fill" style="width: ${proj.progress}%"></div></div><small>${proj.progress}%</small>` : '';
                
                return `
                    <tr data-status="${proj.status}">
                        <td>
                            <strong>${proj.name}</strong>
                            <div class="project-details">
                                <small>${proj.type || 'Project'} for ${proj.client}</small>
                                ${proj.address ? `<br><small>ðŸ“ ${proj.address}</small>` : ''}
                            </div>
                        </td>
                        <td>${proj.code}</td>
                        <td>${proj.client || '-'}</td>
                        <td>${elevatorInfo}</td>
                        <td>${progressBar}</td>
                        <td><span class="badge badge-${statusClass}">${proj.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editProject('${proj.id}')">Edit</button>
                                ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteProject('${proj.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderMaintenance() {
            const tbody = document.getElementById('maintenanceList');
            if (maintenance.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">ðŸ”§</div><p>No maintenance scheduled. Click "Schedule Maintenance" to get started.</p></td></tr>';
                return;
            }

            tbody.innerHTML = maintenance.map(maint => {
                const statusClass = maint.status === 'Completed' ? 'success' : 
                                  maint.status === 'In Progress' ? 'warning' : 
                                  maint.status === 'Overdue' ? 'danger' : 'secondary';
                const priorityClass = maint.priority === 'High' ? 'danger' : 
                                     maint.priority === 'Medium' ? 'warning' : 'secondary';
                
                // Check if overdue
                const isOverdue = new Date(maint.dueDate) < new Date() && maint.status !== 'Completed';
                const actualStatus = isOverdue ? 'Overdue' : maint.status;
                const actualStatusClass = isOverdue ? 'danger' : statusClass;
                
                return `
                    <tr data-status="${maint.status}" data-priority="${maint.priority}">
                        <td>${maint.elevatorId}</td>
                        <td>${maint.projectName || '-'}</td>
                        <td>${maint.issue}</td>
                        <td><span class="badge badge-${priorityClass}">${maint.priority}</span></td>
                        <td>${maint.assignedTo}</td>
                        <td>${new Date(maint.dueDate).toLocaleDateString()}</td>
                        <td><span class="badge badge-${actualStatusClass}">${actualStatus}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editMaintenance('${maint.id}')">Edit</button>
                                ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteMaintenance('${maint.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderActivities() {
            const tbody = document.getElementById('activityList');
            if (activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No activities recorded</td></tr>';
            } else {
                tbody.innerHTML = activities.map(act => `
                    <tr data-user="${act.user}" data-date="${act.date}">
                        <td>${new Date(act.date).toLocaleString()}</td>
                        <td>${act.action}</td>
                        <td>${act.user}</td>
                    </tr>
                `).join('');
            }
        }

        function renderUsers() {
            const tbody = document.getElementById('usersList');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">ðŸ‘¥</div><p>No users found.</p></td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const statusClass = user.status === 'active' ? 'success' : 'secondary';
                const roleClass = user.role === 'admin' ? 'primary' : 'secondary';
                
                return `
                    <tr>
                        <td><strong>${user.username}</strong></td>
                        <td>${user.fullName || '-'}</td>
                        <td><span class="badge badge-${roleClass}">${user.role.toUpperCase()}</span></td>
                        <td><span class="badge badge-${statusClass}">${user.status.toUpperCase()}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editUser('${user.id}')">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function populateCategoryFilters() {
            ['store', 'office', 'kitchen'].forEach(location => {
                const select = document.getElementById(`categoryFilter${location.charAt(0).toUpperCase() + location.slice(1)}`);
                const categories = [...new Set(inventory[location].map(i => i.category))].sort();
                select.innerHTML = '<option value="">All Categories</option>' + 
                    categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            });
        }

        function populateActivityUserFilter() {
            const select = document.getElementById('activityUserFilter');
            const users = [...new Set(activities.map(a => a.user))].sort();
            select.innerHTML = '<option value="">All Users</option>' + 
                users.map(user => `<option value="${user}">${user}</option>`).join('');
        }

        // Billing System Functions
        async function loadInvoices() {
            try {
                const snapshot = await getDocs(collection(db, 'invoices'));
                invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderInvoices();
                updateBillingStats();
            } catch (error) {
                console.error('Error loading invoices:', error);
            }
        }

        async function loadCompanySettings() {
            try {
                const snapshot = await getDocs(collection(db, 'company_settings'));
                if (!snapshot.empty) {
                    const settingsDoc = snapshot.docs[0];
                    companySettings = { id: settingsDoc.id, ...settingsDoc.data() };
                }
            } catch (error) {
                console.error('Error loading company settings:', error);
            }
        }

        function renderInvoices() {
            const tbody = document.getElementById('invoicesList');
            if (invoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">ðŸ“„</div><p>No invoices created yet. Click "Create Invoice" to get started.</p></td></tr>';
                return;
            }

            tbody.innerHTML = invoices.map(invoice => {
                const statusClass = getInvoiceStatusClass(invoice.status);
                const dueDate = invoice.dueDate ? new Date(invoice.dueDate).toLocaleDateString('en-IN') : '-';
                const invoiceDate = new Date(invoice.invoiceDate).toLocaleDateString('en-IN');
                
                return `
                    <tr data-status="${invoice.status}" data-type="${invoice.type}">
                        <td><strong>${invoice.invoiceNumber}</strong></td>
                        <td><span class="badge badge-${invoice.type === 'quotation' ? 'secondary' : 'primary'}">${invoice.type.toUpperCase()}</span></td>
                        <td>${invoice.clientName}</td>
                        <td>${invoiceDate}</td>
                        <td>${dueDate}</td>
                        <td><strong>â‚¹${invoice.totalAmount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></td>
                        <td><span class="badge invoice-status-${invoice.status}">${invoice.status.toUpperCase()}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="downloadInvoicePDF('${invoice.id}')">ðŸ“„ PDF</button>
                                <button class="btn btn-secondary btn-sm" onclick="editInvoice('${invoice.id}')">Edit</button>
                                ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateBillingStats() {
            const totalInvoicesCount = invoices.filter(inv => inv.type === 'invoice').length;
            const totalRevenue = invoices.filter(inv => inv.type === 'invoice' && inv.status === 'paid')
                .reduce((sum, inv) => sum + inv.totalAmount, 0);
            const pendingAmount = invoices.filter(inv => inv.type === 'invoice' && ['sent', 'overdue'].includes(inv.status))
                .reduce((sum, inv) => sum + inv.totalAmount, 0);
            const overdueCount = invoices.filter(inv => inv.type === 'invoice' && inv.status === 'overdue').length;

            document.getElementById('totalInvoices').textContent = totalInvoicesCount;
            document.getElementById('totalRevenue').textContent = `â‚¹${totalRevenue.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('pendingAmount').textContent = `â‚¹${pendingAmount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('overdueInvoices').textContent = overdueCount;
        }

        function getInvoiceStatusClass(status) {
            const statusClasses = {
                'paid': 'success',
                'sent': 'primary',
                'draft': 'secondary',
                'overdue': 'danger',
                'cancelled': 'secondary'
            };
            return statusClasses[status] || 'secondary';
        }

        window.showCreateInvoiceModal = () => {
            document.getElementById('invoiceModalTitle').textContent = 'Create Invoice';
            document.getElementById('invoiceType').value = 'invoice';
            document.getElementById('invoiceForm').reset();
            document.getElementById('editInvoiceId').value = '';
            
            // Set default invoice number
            const invoiceCount = invoices.filter(inv => inv.type === 'invoice').length;
            document.getElementById('invoiceNumber').value = `INV-${String(invoiceCount + 1).padStart(4, '0')}`;
            
            // Set default date
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            
            // Set default due date (30 days from now)
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];

            clearInvoiceItems();
            addInvoiceItem();
            document.getElementById('invoiceModal').classList.add('active');
        };

        window.showQuotationModal = () => {
            document.getElementById('invoiceModalTitle').textContent = 'Create Quotation';
            document.getElementById('invoiceType').value = 'quotation';
            document.getElementById('invoiceForm').reset();
            document.getElementById('editInvoiceId').value = '';
            
            // Set default quotation number
            const quotationCount = invoices.filter(inv => inv.type === 'quotation').length;
            document.getElementById('invoiceNumber').value = `QUO-${String(quotationCount + 1).padStart(4, '0')}`;
            
            // Set default date
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];

            clearInvoiceItems();
            addInvoiceItem();
            document.getElementById('invoiceModal').classList.add('active');
        };

        window.addInvoiceItem = () => {
            const container = document.getElementById('invoiceItemsList');
            const itemIndex = container.children.length;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'invoice-item';
            itemDiv.innerHTML = `
                <input type="text" placeholder="Item description" onchange="calculateInvoiceTotal()" required>
                <input type="number" min="1" step="0.01" placeholder="1" onchange="calculateInvoiceTotal()" required>
                <input type="text" placeholder="pcs" onchange="calculateInvoiceTotal()">
                <input type="number" min="0" step="0.01" placeholder="0.00" onchange="calculateInvoiceTotal()" required>
                <input type="number" min="0" step="0.01" placeholder="0.00" readonly>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)">Ã—</button>
            `;
            container.appendChild(itemDiv);
            calculateInvoiceTotal();
        };

        window.removeInvoiceItem = (button) => {
            button.closest('.invoice-item').remove();
            calculateInvoiceTotal();
        };

        function clearInvoiceItems() {
            document.getElementById('invoiceItemsList').innerHTML = '';
        }

        window.calculateInvoiceTotal = () => {
            const items = document.querySelectorAll('#invoiceItemsList .invoice-item');
            let subtotal = 0;

            items.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const qty = parseFloat(inputs[1].value) || 0;
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = qty * rate;
                
                inputs[4].value = amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                subtotal += amount;
            });

            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const gstPercent = parseFloat(document.getElementById('gstPercent').value) || 0;

            const discountAmount = (subtotal * discountPercent) / 100;
            const afterDiscount = subtotal - discountAmount;
            const gstAmount = (afterDiscount * gstPercent) / 100;
            const total = afterDiscount + gstAmount;

            document.getElementById('subtotalDisplay').textContent = `â‚¹${subtotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('totalAmountDisplay').textContent = `â‚¹${total.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        };

        window.filterInvoices = () => {
            const searchValue = document.getElementById('searchInvoices').value.toLowerCase();
            const statusValue = document.getElementById('invoiceStatusFilter').value;
            const typeValue = document.getElementById('invoiceTypeFilter').value;
            
            const rows = document.querySelectorAll('#invoicesList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const status = row.dataset.status || '';
                const type = row.dataset.type || '';
                
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusValue || status === statusValue;
                const matchesType = !typeValue || type === typeValue;
                
                row.style.display = (matchesSearch && matchesStatus && matchesType) ? '' : 'none';
            });
        };

        window.editInvoice = (invoiceId) => {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            document.getElementById('invoiceModalTitle').textContent = `Edit ${invoice.type === 'quotation' ? 'Quotation' : 'Invoice'}`;
            document.getElementById('editInvoiceId').value = invoice.id;
            document.getElementById('invoiceType').value = invoice.type;
            
            // Fill form fields
            document.getElementById('clientName').value = invoice.clientName;
            document.getElementById('clientEmail').value = invoice.clientEmail || '';
            document.getElementById('clientPhone').value = invoice.clientPhone || '';
            document.getElementById('clientGST').value = invoice.clientGST || '';
            document.getElementById('clientAddress').value = invoice.clientAddress || '';
            
            document.getElementById('invoiceNumber').value = invoice.invoiceNumber;
            document.getElementById('invoiceDate').value = invoice.invoiceDate;
            document.getElementById('dueDate').value = invoice.dueDate || '';
            document.getElementById('poNumber').value = invoice.poNumber || '';
            
            document.getElementById('discountPercent').value = invoice.discountPercent || 0;
            document.getElementById('gstPercent').value = invoice.gstPercent || 18;
            document.getElementById('invoiceNotes').value = invoice.notes || '';

            // Fill items
            clearInvoiceItems();
            invoice.items.forEach(item => {
                addInvoiceItem();
                const lastItem = document.querySelector('#invoiceItemsList .invoice-item:last-child');
                const inputs = lastItem.querySelectorAll('input');
                inputs[0].value = item.description;
                inputs[1].value = item.quantity;
                inputs[2].value = item.unit;
                inputs[3].value = item.rate;
            });

            calculateInvoiceTotal();
            document.getElementById('invoiceModal').classList.add('active');
        };

        window.deleteInvoice = async (invoiceId) => {
            if (confirm('Are you sure you want to delete this invoice?')) {
                try {
                    await deleteDoc(doc(db, 'invoices', invoiceId));
                    await addDoc(collection(db, 'activities'), {
                        action: `Deleted invoice`,
                        user: currentUser.fullName || currentUser.username,
                        date: new Date().toISOString()
                    });
                    loadInvoices();
                } catch (error) {
                    alert('Error deleting invoice: ' + error.message);
                }
            }
        };

        window.downloadInvoicePDF = async (invoiceId) => {
            try {
                // Ensure jsPDF is available (loads dynamically if required)
                try {
                    await ensureJsPDF();
                } catch (e) {
                    alert('PDF library not loaded. Please refresh the page.');
                    return;
                }

                const invoice = invoices.find(inv => inv.id === invoiceId);
                if (!invoice) {
                    alert('Invoice not found.');
                    return;
                }

                // Validate invoice has required data
                if (!invoice.items || invoice.items.length === 0) {
                    alert('Invoice has no items. Cannot generate PDF.');
                    return;
                }

                await generateInvoicePDF(invoice);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF: ' + error.message);
            }
        };

        window.showAddInventoryModal = (location) => {
            document.getElementById('inventoryModalTitle').textContent = `Add ${location.charAt(0).toUpperCase() + location.slice(1)} Item`;
            document.getElementById('inventoryForm').reset();
            document.getElementById('editItemId').value = '';
            document.getElementById('itemLocation').value = location;
            
            const categorySelect = document.getElementById('itemCategory');
            categorySelect.innerHTML = '<option value="">Select Category</option>' + 
                CATEGORIES[location].map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            document.getElementById('inventoryModal').classList.add('active');
        };

        window.editInventory = (id) => {
            const allItems = getAllItems();
            const item = allItems.find(i => i.id === id);
            
            document.getElementById('inventoryModalTitle').textContent = 'Edit Inventory Item';
            document.getElementById('editItemId').value = item.id;
            document.getElementById('itemLocation').value = item.location;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemBarcode').value = item.barcode || '';
            
            const categorySelect = document.getElementById('itemCategory');
            categorySelect.innerHTML = '<option value="">Select Category</option>' + 
                CATEGORIES[item.location].map(cat => `<option value="${cat}">${cat}</option>`).join('');
            categorySelect.value = item.category;
            
            document.getElementById('itemQuantity').value = item.quantity;
            document.getElementById('itemUnit').value = item.unit;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('inventoryModal').classList.add('active');
        };

        window.deleteInventory = async (id) => {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            const allItems = getAllItems();
            const item = allItems.find(i => i.id === id);
            
            if (isOnline) {
                await deleteDoc(doc(db, 'inventory', id));
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Deleted ${item.location} inventory: ${item.name}`,
                    user: currentUser.username
                });
            }
            
            await loadData();
        };

        document.getElementById('inventoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editItemId').value;
            const location = document.getElementById('itemLocation').value;
            const itemData = {
                name: document.getElementById('itemName').value,
                barcode: document.getElementById('itemBarcode').value,
                category: document.getElementById('itemCategory').value,
                quantity: parseInt(document.getElementById('itemQuantity').value),
                unit: document.getElementById('itemUnit').value,
                description: document.getElementById('itemDescription').value,
                location: location
            };

            try {
                if (isOnline) {
                    if (id) {
                        await updateDoc(doc(db, 'inventory', id), itemData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Updated ${location} inventory: ${itemData.name}`,
                            user: currentUser.username
                        });
                    } else {
                        await addDoc(collection(db, 'inventory'), itemData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Added ${location} inventory: ${itemData.name}`,
                            user: currentUser.username
                        });
                    }
                }

                closeModal('inventoryModal');
                await loadData();
            } catch (error) {
                alert('Error saving inventory: ' + error.message);
            }
        });

        window.showAddStockModal = (id) => {
            const allItems = getAllItems();
            const item = allItems.find(i => i.id === id);
            document.getElementById('addStockItemId').value = item.id;
            document.getElementById('addStockItemName').textContent = item.name;
            document.getElementById('addStockCurrent').textContent = `${item.quantity} ${item.unit}`;
            document.getElementById('addStockForm').reset();
            document.getElementById('addStockModal').classList.add('active');
        };

        document.getElementById('addStockForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = document.getElementById('addStockItemId').value;
            const quantity = parseInt(document.getElementById('addStockQuantity').value);
            const notes = document.getElementById('addStockNotes').value;

            const allItems = getAllItems();
            const item = allItems.find(i => i.id === itemId);
            const newQuantity = item.quantity + quantity;

            if (isOnline) {
                await updateDoc(doc(db, 'inventory', itemId), { quantity: newQuantity });
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Added ${quantity} ${item.unit} to ${item.name} (${item.location})${notes ? ' - ' + notes : ''}`,
                    user: currentUser.username
                });
            }

            closeModal('addStockModal');
            await loadData();
        });

        window.showUseModal = (id) => {
            const allItems = getAllItems();
            const item = allItems.find(i => i.id === id);
            document.getElementById('useItemId').value = item.id;
            document.getElementById('useItemName').textContent = item.name;
            document.getElementById('useAvailable').textContent = `${item.quantity} ${item.unit}`;
            document.getElementById('useQuantity').max = item.quantity;
            
            const projectSelect = document.getElementById('useProject');
            projectSelect.innerHTML = '<option value="">Select Project</option>' + 
                projects.filter(p => p.status === 'Active').map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
            
            document.getElementById('useForm').reset();
            document.getElementById('useModal').classList.add('active');
        };

        document.getElementById('useForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = document.getElementById('useItemId').value;
            const quantity = parseInt(document.getElementById('useQuantity').value);
            const projectId = document.getElementById('useProject').value;
            const notes = document.getElementById('useNotes').value;

            const allItems = getAllItems();
            const item = allItems.find(i => i.id === itemId);
            const project = projects.find(p => p.id === projectId);

            if (quantity > item.quantity) {
                alert('Not enough stock available!');
                return;
            }

            const newQuantity = item.quantity - quantity;
            const projectItems = project.items || [];
            const existingItem = projectItems.find(pi => pi.itemId === itemId);

            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                projectItems.push({
                    itemId: item.id,
                    name: item.name,
                    quantity: quantity,
                    unit: item.unit,
                    location: item.location
                });
            }

            if (isOnline) {
                await updateDoc(doc(db, 'inventory', itemId), { quantity: newQuantity });
                await updateDoc(doc(db, 'projects', projectId), { items: projectItems });
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Used ${quantity} ${item.unit} of ${item.name} (${item.location}) for ${project.name}${notes ? ' - ' + notes : ''}`,
                    user: currentUser.username
                });
            }

            closeModal('useModal');
            await loadData();
        });

        window.showAddProjectModal = () => {
            document.getElementById('projectModalTitle').textContent = 'Create New Project';
            document.getElementById('projectForm').reset();
            document.getElementById('editProjectId').value = '';
            document.getElementById('projectItemsSection').style.display = 'none';
            document.getElementById('projectSubmitBtn').textContent = 'Create Project';
            document.getElementById('projectModal').classList.add('active');
        };

        window.editProject = (id) => {
            const project = projects.find(p => p.id === id);
            
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('editProjectId').value = project.id;
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectCode').value = project.code;
            document.getElementById('projectClient').value = project.client || '';
            document.getElementById('projectType').value = project.type || '';
            document.getElementById('projectAddress').value = project.address || '';
            document.getElementById('projectElevatorCount').value = project.elevatorCount || '';
            document.getElementById('projectElevatorType').value = project.elevatorType || '';
            document.getElementById('projectCapacity').value = project.capacity || '';
            document.getElementById('projectFloors').value = project.floors || '';
            document.getElementById('projectMachineType').value = project.machineType || '';
            document.getElementById('projectSpeed').value = project.speed || '';
            document.getElementById('projectStartDate').value = project.startDate || '';
            document.getElementById('projectEndDate').value = project.endDate || '';
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('projectProgress').value = project.progress || 0;
            document.getElementById('projectSubmitBtn').textContent = 'Update Project';
            
            // Show elevator details if elevator count is set
            if (project.elevatorCount) {
                document.getElementById('elevatorDetails').style.display = 'block';
            }
            
            const items = project.items || [];
            if (items.length > 0) {
                document.getElementById('projectItemsSection').style.display = 'block';
                document.getElementById('projectItemsList').innerHTML = items.map(item => 
                    `<p>â€¢ ${item.name}: ${item.quantity} ${item.unit} (${item.location})</p>`
                ).join('');
                
                document.getElementById('returnItemsList').innerHTML = items.map(item => `
                    <div style="margin-bottom: 12px; padding: 8px; background: var(--bg-light); border-radius: 4px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="return_${item.itemId}" onchange="toggleReturnQuantity('${item.itemId}')">
                            <strong>${item.name}</strong> - Currently allocated: ${item.quantity} ${item.unit}
                        </label>
                        <div id="returnQty_${item.itemId}" style="display: none; margin-top: 8px; margin-left: 24px;">
                            <label style="font-size: 13px;">Quantity to return:</label>
                            <input type="number" class="form-control" id="returnAmount_${item.itemId}" min="0" max="${item.quantity}" value="${item.quantity}" style="margin-top: 4px;">
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('projectItemsSection').style.display = 'none';
            }
            
            document.getElementById('projectModal').classList.add('active');
        };

        window.toggleReturnQuantity = (itemId) => {
            const checkbox = document.getElementById(`return_${itemId}`);
            const qtyDiv = document.getElementById(`returnQty_${itemId}`);
            qtyDiv.style.display = checkbox.checked ? 'block' : 'none';
        };

        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const projectId = document.getElementById('editProjectId').value;
            const projectData = {
                name: document.getElementById('projectName').value,
                code: document.getElementById('projectCode').value,
                client: document.getElementById('projectClient').value,
                type: document.getElementById('projectType').value,
                address: document.getElementById('projectAddress').value,
                elevatorCount: document.getElementById('projectElevatorCount').value,
                elevatorType: document.getElementById('projectElevatorType').value,
                capacity: document.getElementById('projectCapacity').value,
                floors: document.getElementById('projectFloors').value,
                machineType: document.getElementById('projectMachineType').value,
                speed: document.getElementById('projectSpeed').value,
                startDate: document.getElementById('projectStartDate').value,
                endDate: document.getElementById('projectEndDate').value,
                status: document.getElementById('projectStatus').value,
                progress: document.getElementById('projectProgress').value || 0
            };

            if (isOnline) {
                if (projectId) {
                    const project = projects.find(p => p.id === projectId);
                    const items = project.items || [];
                    
                    for (const item of items) {
                        const returnCheckbox = document.getElementById(`return_${item.itemId}`);
                        if (returnCheckbox && returnCheckbox.checked) {
                            const returnAmount = parseInt(document.getElementById(`returnAmount_${item.itemId}`).value);
                            if (returnAmount > 0) {
                                const inventoryItem = getAllItems().find(i => i.id === item.itemId);
                                if (inventoryItem) {
                                    await updateDoc(doc(db, 'inventory', item.itemId), {
                                        quantity: inventoryItem.quantity + returnAmount
                                    });
                                    
                                    item.quantity -= returnAmount;
                                    
                                    await addDoc(collection(db, 'activities'), {
                                        date: new Date().toISOString(),
                                        action: `Returned ${returnAmount} ${item.unit} of ${item.name} from project ${project.name} to ${inventoryItem.location}`,
                                        user: currentUser.username
                                    });
                                }
                            }
                        }
                    }
                    
                    projectData.items = items.filter(item => item.quantity > 0);
                    
                    await updateDoc(doc(db, 'projects', projectId), projectData);
                    await addDoc(collection(db, 'activities'), {
                        date: new Date().toISOString(),
                        action: `Updated project: ${projectData.name}`,
                        user: currentUser.username
                    });
                } else {
                    projectData.items = [];
                    await addDoc(collection(db, 'projects'), projectData);
                    await addDoc(collection(db, 'activities'), {
                        date: new Date().toISOString(),
                        action: `Created project: ${projectData.name}`,
                        user: currentUser.username
                    });
                }
            }

            closeModal('projectModal');
            await loadData();
        });

        window.deleteProject = async (id) => {
            if (!confirm('Are you sure you want to delete this project? Items will be returned to inventory.')) return;
            
            const project = projects.find(p => p.id === id);
            const items = project.items || [];

            for (const projItem of items) {
                const invItem = getAllItems().find(i => i.id === projItem.itemId);
                if (invItem && isOnline) {
                    await updateDoc(doc(db, 'inventory', projItem.itemId), {
                        quantity: invItem.quantity + projItem.quantity
                    });
                }
            }

            if (isOnline) {
                await deleteDoc(doc(db, 'projects', id));
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Deleted project: ${project.name}`,
                    user: currentUser.username
                });
            }

            await loadData();
        };

        // Function to generate elevator fields based on count
        window.generateElevatorFields = () => {
            const count = parseInt(document.getElementById('projectElevatorCount').value);
            const detailsDiv = document.getElementById('elevatorDetails');
            
            if (count > 0) {
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
        };

        // Function to load elevators for maintenance modal
        window.loadElevators = () => {
            const projectId = document.getElementById('maintenanceProject').value;
            const elevatorSelect = document.getElementById('maintenanceElevator');
            
            elevatorSelect.innerHTML = '<option value="">Select Elevator</option>';
            
            if (projectId) {
                const project = projects.find(p => p.id === projectId);
                if (project && project.elevatorCount) {
                    const count = parseInt(project.elevatorCount) || 1;
                    for (let i = 1; i <= count; i++) {
                        elevatorSelect.innerHTML += `<option value="Elevator-${i}">Elevator ${i}</option>`;
                    }
                }
            }
        };

        // Function to show maintenance modal
        window.showAddMaintenanceModal = () => {
            document.getElementById('maintenanceModalTitle').textContent = 'Schedule Maintenance';
            document.getElementById('maintenanceForm').reset();
            document.getElementById('editMaintenanceId').value = '';
            
            // Populate projects dropdown
            const projectSelect = document.getElementById('maintenanceProject');
            projectSelect.innerHTML = '<option value="">Select Project</option>' + 
                projects.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
            
            // Populate technicians dropdown
            const assigneeSelect = document.getElementById('maintenanceAssignee');
            assigneeSelect.innerHTML = '<option value="">Select Technician</option>' + 
                users.filter(u => u.role === 'user' && u.status === 'active')
                     .map(u => `<option value="${u.username}">${u.fullName || u.username}</option>`).join('');
            
            document.getElementById('maintenanceModal').classList.add('active');
        };

        // Maintenance form submission
        document.getElementById('maintenanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const maintenanceId = document.getElementById('editMaintenanceId').value;
            const maintenanceData = {
                projectId: document.getElementById('maintenanceProject').value,
                projectName: projects.find(p => p.id === document.getElementById('maintenanceProject').value)?.name,
                elevatorId: document.getElementById('maintenanceElevator').value,
                issue: document.getElementById('maintenanceIssue').value,
                priority: document.getElementById('maintenancePriority').value,
                assignedTo: document.getElementById('maintenanceAssignee').value,
                dueDate: document.getElementById('maintenanceDueDate').value,
                status: document.getElementById('maintenanceStatus').value || 'Scheduled',
                notes: document.getElementById('maintenanceNotes').value,
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser.username
            };

            if (!maintenanceId) {
                maintenanceData.createdAt = new Date().toISOString();
                maintenanceData.createdBy = currentUser.username;
            }

            try {
                if (isOnline) {
                    if (maintenanceId) {
                        await updateDoc(doc(db, 'maintenance', maintenanceId), maintenanceData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Updated maintenance for ${maintenanceData.elevatorId} in project ${maintenanceData.projectName} - Status: ${maintenanceData.status}`,
                            user: currentUser.username
                        });
                    } else {
                        await addDoc(collection(db, 'maintenance'), maintenanceData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Scheduled maintenance for ${maintenanceData.elevatorId} in project ${maintenanceData.projectName} - Priority: ${maintenanceData.priority}`,
                            user: currentUser.username
                        });
                    }
                }

                closeModal('maintenanceModal');
                await loadData();
                alert(`Maintenance ${maintenanceId ? 'updated' : 'scheduled'} and ${maintenanceData.assignedTo} has been notified!`);
            } catch (error) {
                alert('Error scheduling maintenance: ' + error.message);
            }
        });

        window.editMaintenance = (id) => {
            const maint = maintenance.find(m => m.id === id);
            
            document.getElementById('maintenanceModalTitle').textContent = 'Edit Maintenance';
            document.getElementById('editMaintenanceId').value = maint.id;
            document.getElementById('maintenanceProject').value = maint.projectId || '';
            loadElevators();
            document.getElementById('maintenanceElevator').value = maint.elevatorId || '';
            document.getElementById('maintenanceIssue').value = maint.issue || '';
            document.getElementById('maintenancePriority').value = maint.priority || '';
            document.getElementById('maintenanceAssignee').value = maint.assignedTo || '';
            document.getElementById('maintenanceDueDate').value = maint.dueDate || '';
            document.getElementById('maintenanceStatus').value = maint.status || 'Scheduled';
            document.getElementById('maintenanceNotes').value = maint.notes || '';
            
            // Populate dropdowns
            const projectSelect = document.getElementById('maintenanceProject');
            projectSelect.innerHTML = '<option value="">Select Project</option>' + 
                projects.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
            document.getElementById('maintenanceProject').value = maint.projectId || '';
            
            const assigneeSelect = document.getElementById('maintenanceAssignee');
            assigneeSelect.innerHTML = '<option value="">Select Technician</option>' + 
                users.filter(u => u.role === 'user' && u.status === 'active')
                     .map(u => `<option value="${u.username}">${u.fullName || u.username}</option>`).join('');
            document.getElementById('maintenanceAssignee').value = maint.assignedTo || '';
            
            document.getElementById('maintenanceModal').classList.add('active');
        };

        window.deleteMaintenance = async (id) => {
            if (!confirm('Are you sure you want to delete this maintenance record?')) return;
            
            const maint = maintenance.find(m => m.id === id);
            
            if (isOnline) {
                await deleteDoc(doc(db, 'maintenance', id));
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Deleted maintenance record for ${maint.elevatorId} in project ${maint.projectName}`,
                    user: currentUser.username
                });
            }

            await loadData();
        };

        window.showAddUserModal = () => {
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userForm').reset();
            document.getElementById('editUserId').value = '';
            document.getElementById('newPassword').required = true;
            document.getElementById('newUsername').disabled = false;
            document.getElementById('userModal').classList.add('active');
        };

        window.editUser = (id) => {
            const user = users.find(u => u.id === id);
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('editUserId').value = user.id;
            document.getElementById('newUsername').value = user.username;
            document.getElementById('newUsername').disabled = true;
            document.getElementById('newFullName').value = user.fullName || '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newPassword').required = false;
            document.getElementById('newUserRole').value = user.role;
            document.getElementById('newUserStatus').value = user.status;
            document.getElementById('userModal').classList.add('active');
        };

        window.deleteUser = async (id) => {
            const user = users.find(u => u.id === id);
            if (!confirm(`Are you sure you want to delete user "${user.username}"?`)) return;

            if (isOnline) {
                await deleteDoc(doc(db, 'users', id));
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Deleted user: ${user.username}`,
                    user: currentUser.username
                });
            }

            await loadUsers();
        };

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editUserId').value;
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const fullName = document.getElementById('newFullName').value;
            const role = document.getElementById('newUserRole').value;
            const status = document.getElementById('newUserStatus').value;

            try {
                if (isOnline) {
                    if (id) {
                        const userData = { fullName, role, status };
                        if (password) {
                            userData.password = password;
                        }
                        await updateDoc(doc(db, 'users', id), userData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Updated user: ${username}`,
                            user: currentUser.username
                        });
                    } else {
                        const existingUser = users.find(u => u.username === username);
                        if (existingUser) {
                            throw new Error('Username already exists');
                        }

                        await addDoc(collection(db, 'users'), {
                            username: username,
                            password: password,
                            fullName: fullName,
                            role: role,
                            status: status
                        });
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Created user: ${username}`,
                            user: currentUser.username
                        });
                    }
                } else {
                    throw new Error('Cannot manage users in offline mode');
                }

                document.getElementById('newUsername').disabled = false;
                closeModal('userModal');
                await loadUsers();
            } catch (error) {
                alert('Error saving user: ' + error.message);
            }
        });

        // Invoice Form Handler
        document.getElementById('invoiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const invoiceId = document.getElementById('editInvoiceId').value;
            const type = document.getElementById('invoiceType').value;
            
            // Collect form data
            const formData = {
                type: type,
                clientName: document.getElementById('clientName').value.trim(),
                clientEmail: document.getElementById('clientEmail').value.trim(),
                clientPhone: document.getElementById('clientPhone').value.trim(),
                clientGST: document.getElementById('clientGST').value.trim(),
                clientAddress: document.getElementById('clientAddress').value.trim(),
                invoiceNumber: document.getElementById('invoiceNumber').value.trim(),
                invoiceDate: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                poNumber: document.getElementById('poNumber').value.trim(),
                discountPercent: parseFloat(document.getElementById('discountPercent').value) || 0,
                gstPercent: parseFloat(document.getElementById('gstPercent').value) || 0,
                notes: document.getElementById('invoiceNotes').value.trim(),
                status: invoiceId ? invoices.find(inv => inv.id === invoiceId)?.status || 'draft' : 'draft'
            };

            // Collect items
            const itemElements = document.querySelectorAll('#invoiceItemsList .invoice-item');
            formData.items = [];
            let subtotal = 0;

            itemElements.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const description = inputs[0].value.trim();
                const quantity = parseFloat(inputs[1].value) || 0;
                const unit = inputs[2].value.trim() || 'pcs';
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = quantity * rate;

                if (description && quantity > 0 && rate >= 0) {
                    formData.items.push({
                        description,
                        quantity,
                        unit,
                        rate,
                        amount
                    });
                    subtotal += amount;
                }
            });

            if (formData.items.length === 0) {
                alert('Please add at least one item');
                return;
            }

            // Calculate totals
            const discountAmount = (subtotal * formData.discountPercent) / 100;
            const afterDiscount = subtotal - discountAmount;
            const gstAmount = (afterDiscount * formData.gstPercent) / 100;
            
            formData.subtotal = subtotal;
            formData.discountAmount = discountAmount;
            formData.gstAmount = gstAmount;
            formData.totalAmount = afterDiscount + gstAmount;
            formData.updatedAt = new Date().toISOString();

            try {
                if (invoiceId) {
                    await updateDoc(doc(db, 'invoices', invoiceId), formData);
                    await addDoc(collection(db, 'activities'), {
                        action: `Updated ${type} ${formData.invoiceNumber}`,
                        user: currentUser.fullName || currentUser.username,
                        date: new Date().toISOString()
                    });
                } else {
                    formData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'invoices'), formData);
                    await addDoc(collection(db, 'activities'), {
                        action: `Created ${type} ${formData.invoiceNumber} for ${formData.clientName}`,
                        user: currentUser.fullName || currentUser.username,
                        date: new Date().toISOString()
                    });
                }

                closeModal('invoiceModal');
                loadInvoices();
            } catch (error) {
                alert('Error saving invoice: ' + error.message);
            }
        });

        // Helper function to load image as data URL.
        // Returns a data URL string or null if the image cannot be loaded or would taint the canvas.
        async function loadImageAsDataUrl(src) {
            if (!src) return null;
            // If already a data URL, return as-is
            if (typeof src === 'string' && src.startsWith('data:')) return src;

            // Try fetching the image as a blob first (preferred - avoids crossOrigin issues when possible)
            try {
                const resp = await fetch(src, { mode: 'cors' });
                if (resp && resp.ok) {
                    const blob = await resp.blob();
                    return await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => resolve(null);
                        reader.readAsDataURL(blob);
                    });
                }
            } catch (e) {
                // fetch may fail for file:// pages or strict CORS; fall through to image approach
                // console.warn('fetch image failed, falling back to Image element:', e);
            }

            // Fallback: attempt to load via Image with crossOrigin first. If drawing the image taints the canvas
            // the toDataURL call will throw â€” catch that and return null instead of letting it bubble up.
            return await new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width || 1;
                        canvas.height = img.height || 1;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        try {
                            const data = canvas.toDataURL('image/png');
                            resolve(data);
                        } catch (err) {
                            // Tainted canvas or other security error
                            console.warn('toDataURL failed (tainted canvas or CORS):', err);
                            resolve(null);
                        }
                    } catch (err) {
                        console.warn('drawImage failed:', err);
                        resolve(null);
                    }
                };
                img.onerror = () => {
                    // Last-resort: try an existing DOM <img> that may already be loaded (helps when page has the image)
                    try {
                        const parts = (src || '').split('?')[0].split('/');
                        const filename = parts[parts.length - 1];
                        const domImg = document.querySelector(`img[src$="${filename}"]`) || document.querySelector(`img[src="${src}"]`);
                        if (domImg && domImg.complete) {
                            try {
                                const canvas = document.createElement('canvas');
                                canvas.width = domImg.naturalWidth || domImg.width || 1;
                                canvas.height = domImg.naturalHeight || domImg.height || 1;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(domImg, 0, 0);
                                try {
                                    const data = canvas.toDataURL('image/png');
                                    resolve(data);
                                    return;
                                } catch (err) {
                                    console.warn('toDataURL failed on DOM image (tainted):', err);
                                }
                            } catch (err) {
                                console.warn('drawImage for DOM image failed:', err);
                            }
                        }
                    } catch (e) {
                        console.warn('DOM image fallback failed:', e);
                    }
                    // Last-resort: try without crossOrigin (may still taint)
                    const img2 = new Image();
                    img2.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            canvas.width = img2.width || 1;
                            canvas.height = img2.height || 1;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img2, 0, 0);
                            try {
                                const data = canvas.toDataURL('image/png');
                                resolve(data);
                            } catch (err) {
                                console.warn('toDataURL failed on fallback (tainted):', err);
                                resolve(null);
                            }
                        } catch (err) {
                            console.warn('drawImage fallback failed:', err);
                            resolve(null);
                        }
                    };
                    img2.onerror = () => resolve(null);
                    img2.src = src;
                };
                img.src = src;
            });
        }

        // Ensure jsPDF is available in module context (tries global first, then dynamic import)
        async function ensureJsPDF() {
            if (window.jspdf) return window.jspdf;
            try {
                // Try local copy first (if you add libs/jspdf.umd.min.js to the repo)
                try {
                    const localMod = await import('./libs/jspdf.umd.min.js');
                    const localObj = localMod.jspdf || localMod.default || localMod;
                    if (localObj) {
                        window.jspdf = localObj;
                        return window.jspdf;
                    }
                } catch (localErr) {
                    // local may not exist; fallback to CDN
                    // console.info('Local jsPDF not found or failed, falling back to CDN:', localErr);
                }

                // Fallback dynamic import from CDN
                const mod = await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
                // UMD may export as { jspdf: { jsPDF } } or default; normalize
                const jspdfObj = mod.jspdf || mod.default || mod;
                window.jspdf = jspdfObj;
                return window.jspdf;
            } catch (err) {
                console.error('Failed to load jsPDF dynamically:', err);
                throw err;
            }
        }

        // PDF Generation Function
        async function generateInvoicePDF(invoice) {
            try {
                // Ensure jsPDF is available (works both when included as UMD or via module dynamic import)
                const jspdf = await ensureJsPDF();
                const { jsPDF } = jspdf;
                const doc = new jsPDF();
                
                // Colors and styles
                const primaryColor = [37, 99, 235];
                const darkColor = [15, 23, 42];
                const grayColor = [100, 116, 139];
                
                // Helper function to format currency properly for PDF
                const formatCurrency = (amount) => {
                    const num = parseFloat(amount);
                    if (isNaN(num)) return 'Rs. 0.00';
                    const formatted = num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    return 'Rs. ' + formatted;
                };
                
                // Helper function to format number properly for PDF
                const formatNumber = (num) => {
                    const parsed = parseFloat(num);
                    if (isNaN(parsed)) return '0.00';
                    return parsed.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                };
                
                // Load logo (try multiple methods but don't fail PDF generation if unavailable)
                let logoImg = null;
                try {
                    logoImg = await loadImageAsDataUrl('ambivare.png');
                    if (!logoImg) {
                        // try absolute URL
                        const logoUrl = new URL('ambivare.png', window.location.href).href;
                        logoImg = await loadImageAsDataUrl(logoUrl);
                    }
                } catch (e) {
                    console.warn('Logo load attempted and failed:', e);
                    logoImg = null;
                }

                // Final fallback: try a pre-embedded local file containing the base64 data URI
                if (!logoImg) {
                    try {
                        const resp = await fetch('./libs/embedded_logo.txt');
                        if (resp && resp.ok) {
                            logoImg = await resp.text();
                        }
                    } catch (e) {
                        // ignore
                    }
                }

                // If logo found, draw it. If not, proceed (PDF will render without logo).
                if (logoImg) {
                    try {
                        doc.addImage(logoImg, 'PNG', 20, 12, 40, 18);
                    } catch (e) {
                        console.warn('Adding logo to PDF failed:', e);
                    }
                }

                // Header: Company name (left) and Invoice/Quotation title (right) to avoid overlap
                const companyName = companySettings.name || 'Ambivare Solutions';
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(18);
                doc.setTextColor(...primaryColor);
                const nameX = logoImg ? 70 : 20;
                doc.text(companyName, nameX, 25);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                if (companySettings.address) {
                    doc.text(companySettings.address, 20, 35);
                }
                if (companySettings.phone || companySettings.email) {
                    doc.text(`${companySettings.phone || ''} | ${companySettings.email || ''}`, 20, 42);
                }
                if (companySettings.gst) {
                    doc.text(`GST: ${companySettings.gst}`, 20, 49);
                }

                // Invoice/Quotation Title
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(16);
                doc.setTextColor(...darkColor);
                const title = invoice.type === 'quotation' ? 'QUOTATION' : 'INVOICE';
                // Right-align the title to avoid overlapping long company names
                doc.text(title, 190, 25, { align: 'right' });

                // Invoice details box (right column)
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`${title} #: ${invoice.invoiceNumber}`, 190, 35, { align: 'right' });
                doc.text(`Date: ${new Date(invoice.invoiceDate).toLocaleDateString('en-GB')}`, 190, 42, { align: 'right' });
                if (invoice.dueDate) {
                    doc.text(`Due Date: ${new Date(invoice.dueDate).toLocaleDateString('en-GB')}`, 190, 49, { align: 'right' });
                }
                if (invoice.poNumber) {
                    doc.text(`PO #: ${invoice.poNumber}`, 190, 56, { align: 'right' });
                }

                // Bill To section
                let yPos = 70;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(...darkColor);
                doc.text('BILL TO:', 20, yPos);
                
                yPos += 8;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text(invoice.clientName, 20, yPos);
                
                yPos += 6;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                
                if (invoice.clientAddress) {
                    const addressLines = invoice.clientAddress.split('\n');
                    addressLines.forEach(line => {
                        doc.text(line, 20, yPos);
                        yPos += 5;
                    });
                }
                
                if (invoice.clientPhone) {
                    doc.text(`Phone: ${invoice.clientPhone}`, 20, yPos);
                    yPos += 5;
                }
                
                if (invoice.clientEmail) {
                    doc.text(`Email: ${invoice.clientEmail}`, 20, yPos);
                    yPos += 5;
                }
                
                if (invoice.clientGST) {
                    doc.text(`GST: ${invoice.clientGST}`, 20, yPos);
                    yPos += 5;
                }

                // Items table
                yPos += 15;
                const tableStartY = yPos;
                
                // Table header
                doc.setFillColor(248, 250, 252);
                doc.rect(20, yPos - 5, 170, 12, 'F');
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(10);
                doc.setTextColor(...darkColor);
                
                doc.text('#', 25, yPos + 2);
                doc.text('Description', 35, yPos + 2);
                doc.text('Qty', 115, yPos + 2);
                doc.text('Unit', 130, yPos + 2);
                doc.text('Rate', 145, yPos + 2);
                doc.text('Amount', 165, yPos + 2);
                
                yPos += 15;

                // Table items
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                
                invoice.items.forEach((item, index) => {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 30;
                    }
                    
                    // Alternating row background
                    if (index % 2 === 0) {
                        doc.setFillColor(249, 250, 251);
                        doc.rect(20, yPos - 5, 170, 10, 'F');
                    }
                    
                    doc.setTextColor(...darkColor);
                    doc.text(String(index + 1), 25, yPos);
                    
                    // Wrap long descriptions
                    const description = String(item.description);
                    if (description.length > 35) {
                        const wrappedText = doc.splitTextToSize(description, 75);
                        doc.text(wrappedText[0], 35, yPos);
                        if (wrappedText.length > 1) {
                            doc.setFontSize(8);
                            doc.text(wrappedText[1], 35, yPos + 4);
                            doc.setFontSize(9);
                        }
                    } else {
                        doc.text(description, 35, yPos);
                    }
                    
                    // Format numbers properly
                    doc.text(String(item.quantity), 115, yPos);
                    doc.text(String(item.unit), 130, yPos);
                    doc.text(formatNumber(item.rate), 145, yPos);
                    doc.text(formatNumber(item.amount), 165, yPos);
                    
                    yPos += 12;
                });

                // Totals section
                yPos += 10;
                const totalsStartY = yPos;
                
                doc.setDrawColor(226, 232, 240);
                doc.line(120, yPos - 5, 190, yPos - 5);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                
                doc.text('Subtotal:', 130, yPos);
                doc.text(formatCurrency(invoice.subtotal), 165, yPos);
                yPos += 8;
                
                if (invoice.discountPercent > 0) {
                    doc.text(`Discount (${invoice.discountPercent}%):`, 130, yPos);
                    doc.text('-' + formatCurrency(invoice.discountAmount), 165, yPos);
                    yPos += 8;
                }
                
                if (invoice.gstPercent > 0) {
                    doc.text(`GST (${invoice.gstPercent}%):`, 130, yPos);
                    doc.text(formatCurrency(invoice.gstAmount), 165, yPos);
                    yPos += 8;
                }
                
                // Total line
                doc.setDrawColor(226, 232, 240);
                doc.line(120, yPos + 2, 190, yPos + 2);
                yPos += 8;
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(...darkColor);
                doc.text('TOTAL:', 130, yPos);
                doc.text(formatCurrency(invoice.totalAmount), 165, yPos);

                // Notes section
                if (invoice.notes) {
                    yPos += 20;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(...darkColor);
                    doc.text('Notes:', 20, yPos);
                    
                    yPos += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...grayColor);
                    const noteLines = doc.splitTextToSize(invoice.notes, 170);
                    doc.text(noteLines, 20, yPos);
                }

                // Bank details
                if (companySettings.bankDetails) {
                    yPos += 25;
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 30;
                    }
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(...darkColor);
                    doc.text('Bank Details:', 20, yPos);
                    
                    yPos += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...grayColor);
                    const bankLines = doc.splitTextToSize(companySettings.bankDetails, 170);
                    doc.text(bankLines, 20, yPos);
                }

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(...grayColor);
                doc.text('This is a computer-generated document.', 20, 285);
                doc.text(`Generated on ${new Date().toLocaleDateString('en-GB')}`, 150, 285);

                // Save PDF
                const fileName = `${invoice.type}_${invoice.invoiceNumber}_${invoice.clientName.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
            } catch (error) {
                console.error('PDF generation error:', error);
                throw error;
            }
        }

        window.filterLocation = (location) => {
            const searchValue = document.getElementById(`search${location.charAt(0).toUpperCase() + location.slice(1)}`).value.toLowerCase();
            const categoryValue = document.getElementById(`categoryFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            const statusValue = document.getElementById(`statusFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            
            const rows = document.querySelectorAll(`#${location}List tr`);
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const category = row.dataset.category || '';
                const status = row.dataset.status || '';
                
                const matchesSearch = text.includes(searchValue);
                const matchesCategory = !categoryValue || category === categoryValue;
                const matchesStatus = !statusValue || status === statusValue;
                
                row.style.display = (matchesSearch && matchesCategory && matchesStatus) ? '' : 'none';
            });
        };

        window.filterProjects = () => {
            const searchValue = document.getElementById('searchProjects').value.toLowerCase();
            const statusValue = document.getElementById('projectStatusFilter').value;
            
            const rows = document.querySelectorAll('#projectList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const status = row.dataset.status || '';
                
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusValue || status === statusValue;
                
                row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
            });
        };

        window.filterMaintenance = () => {
            const searchValue = document.getElementById('searchMaintenance').value.toLowerCase();
            const statusValue = document.getElementById('maintenanceStatusFilter').value;
            const priorityValue = document.getElementById('maintenancePriorityFilter').value;
            const assigneeValue = document.getElementById('maintenanceAssigneeFilter').value;
            
            const rows = document.querySelectorAll('#maintenanceList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const status = row.dataset.status || '';
                const priority = row.dataset.priority || '';
                
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusValue || status === statusValue;
                const matchesPriority = !priorityValue || priority === priorityValue;
                const matchesAssignee = !assigneeValue || text.includes(assigneeValue.toLowerCase());
                
                row.style.display = (matchesSearch && matchesStatus && matchesPriority && matchesAssignee) ? '' : 'none';
            });
        };

        window.filterActivities = () => {
            const searchValue = document.getElementById('searchActivities').value.toLowerCase();
            const dateRange = document.getElementById('activityDateFilter').value;
            const userFilter = document.getElementById('activityUserFilter').value;
            
            const now = new Date();
            const rows = document.querySelectorAll('#activityList tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const user = row.dataset.user || '';
                const dateStr = row.dataset.date || '';
                const date = new Date(dateStr);
                
                const matchesSearch = text.includes(searchValue);
                const matchesUser = !userFilter || user === userFilter;
                
                let matchesDate = true;
                if (dateRange !== 'all') {
                    const dayMs = 24 * 60 * 60 * 1000;
                    const diff = now - date;
                    
                    switch(dateRange) {
                        case 'today':
                            matchesDate = diff < dayMs;
                            break;
                        case 'week':
                            matchesDate = diff < 7 * dayMs;
                            break;
                        case 'month':
                            matchesDate = diff < 30 * dayMs;
                            break;
                        case 'quarter':
                            matchesDate = diff < 90 * dayMs;
                            break;
                        case 'halfyear':
                            matchesDate = diff < 180 * dayMs;
                            break;
                        case 'year':
                            matchesDate = diff < 365 * dayMs;
                            break;
                    }
                }
                
                row.style.display = (matchesSearch && matchesUser && matchesDate) ? '' : 'none';
            });
        };

        window.filterUsers = () => {
            const search = document.getElementById('searchUsers').value.toLowerCase();
            const rows = document.querySelectorAll('#usersList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        // PDF EXPORT FUNCTIONS - IMPROVED AND FILTERED

        window.exportLocationPDF = async (location) => {
            const jspdf = await ensureJsPDF();
            const { jsPDF } = jspdf;
            const doc = new jsPDF();
            // Try to embed local logo (non-fatal if it fails)
            let logoImg = null;
            try {
                logoImg = await loadImageAsDataUrl('ambivare.png');
                if (!logoImg) {
                    const logoUrl = new URL('ambivare.png', window.location.href).href;
                    logoImg = await loadImageAsDataUrl(logoUrl);
                }
            } catch (err) {
                console.warn('Could not load logo for location PDF:', err);
            }
            // Fallback to local embedded base64 file
            if (!logoImg) {
                try {
                    const resp = await fetch('./libs/embedded_logo.txt');
                    if (resp && resp.ok) logoImg = await resp.text();
                } catch (e) {
                    // ignore
                }
            }
            
            const filteredItems = getFilteredLocationItems(location);
            
            // Header with company branding
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            // If logo exists, draw it on the header (left) then center the title
            if (logoImg) {
                try { doc.addImage(logoImg, 'PNG', 18, 7, 30, 16); } catch (e) { console.warn('addImage failed:', e); }
            }
            doc.text('AMBIVARE SOLUTIONS', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`${location.toUpperCase()} INVENTORY REPORT`, 105, 26, { align: 'center' });
            
            // Report metadata
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 45);
            doc.text(`By: ${currentUser.fullName || currentUser.username}`, 20, 52);
            doc.text(`Total Items: ${filteredItems.length}`, 20, 59);
            
            // Add filter information
            const searchValue = document.getElementById(`search${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            const categoryValue = document.getElementById(`categoryFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            const statusValue = document.getElementById(`statusFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            
            let filterText = 'Filters Applied: ';
            const filters = [];
            if (searchValue) filters.push(`Search: "${searchValue}"`);
            if (categoryValue) filters.push(`Category: ${categoryValue}`);
            if (statusValue) filters.push(`Status: ${statusValue}`);
            
            if (filters.length > 0) {
                doc.setFontSize(9);
                doc.setTextColor(100, 116, 139);
                doc.text(filterText + filters.join(', '), 20, 66);
            }
            
            doc.setDrawColor(226, 232, 240);
            doc.setLineWidth(0.5);
            doc.line(20, 72, 190, 72);
            
            // Table header
            let y = 82;
            doc.setFillColor(248, 250, 252);
            doc.rect(20, y - 7, 170, 10, 'F');
            
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('#', 22, y);
            doc.text('Item Name', 32, y);
            doc.text('Category', 95, y);
            doc.text('Quantity', 135, y);
            doc.text('Status', 165, y);
            
            doc.setDrawColor(226, 232, 240);
            doc.line(20, y + 2, 190, y + 2);
            
            y += 10;
            
            // Table content
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            if (filteredItems.length === 0) {
                doc.setTextColor(100, 116, 139);
                doc.text('No items match the current filters.', 105, y + 10, { align: 'center' });
            } else {
                filteredItems.forEach((item, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                        
                        // Repeat header on new page
                        doc.setFillColor(248, 250, 252);
                        doc.rect(20, y - 7, 170, 10, 'F');
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(15, 23, 42);
                        doc.text('#', 22, y);
                        doc.text('Item Name', 32, y);
                        doc.text('Category', 95, y);
                        doc.text('Quantity', 135, y);
                        doc.text('Status', 165, y);
                        doc.line(20, y + 2, 190, y + 2);
                        y += 10;
                        doc.setFont(undefined, 'normal');
                    }
                    
                    const stockText = item.quantity < 50 ? 'Low' : item.quantity < 200 ? 'Medium' : 'Good';
                    const stockColor = item.quantity < 50 ? [220, 38, 38] : item.quantity < 200 ? [234, 88, 12] : [22, 163, 74];
                    
                    // Alternating row background
                    if (index % 2 === 0) {
                        doc.setFillColor(249, 250, 251);
                        doc.rect(20, y - 6, 170, 8, 'F');
                    }
                    
                    doc.setTextColor(15, 23, 42);
                    doc.text(`${index + 1}`, 22, y);
                    
                    // Truncate long names
                    let itemName = item.name.length > 35 ? item.name.substring(0, 32) + '...' : item.name;
                    doc.text(itemName, 32, y);
                    
                    doc.setTextColor(100, 116, 139);
                    doc.text(item.category, 95, y);
                    
                    doc.setTextColor(15, 23, 42);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${item.quantity} ${item.unit}`, 135, y);
                    
                    doc.setTextColor(...stockColor);
                    doc.text(stockText, 165, y);
                    
                    doc.setFont(undefined, 'normal');
                    
                    // Add description if exists
                    if (item.description) {
                        y += 5;
                        doc.setFontSize(8);
                        doc.setTextColor(100, 116, 139);
                        const desc = item.description.length > 70 ? item.description.substring(0, 67) + '...' : item.description;
                        doc.text(desc, 32, y);
                        doc.setFontSize(9);
                        y += 3;
                    }
                    
                    y += 8;
                });
            }
            
            // Summary section at bottom of last page
            if (filteredItems.length > 0) {
                const goodStock = filteredItems.filter(i => i.quantity >= 200).length;
                const mediumStock = filteredItems.filter(i => i.quantity >= 50 && i.quantity < 200).length;
                const lowStock = filteredItems.filter(i => i.quantity < 50).length;
                
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                y += 10;
                doc.setDrawColor(226, 232, 240);
                doc.line(20, y, 190, y);
                y += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(15, 23, 42);
                doc.text('SUMMARY', 20, y);
                
                y += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(22, 163, 74);
                doc.text(`Good Stock: ${goodStock} items`, 25, y);
                
                y += 7;
                doc.setTextColor(234, 88, 12);
                doc.text(`Medium Stock: ${mediumStock} items`, 25, y);
                
                y += 7;
                doc.setTextColor(220, 38, 38);
                doc.text(`Low Stock: ${lowStock} items`, 25, y);
            }
            
            // Footer on all pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 116, 139);
                doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                doc.text('Ambivare Solutions - Confidential', 20, 290);
            }
            
            doc.save(`${location}_inventory_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        window.exportProjectsPDF = async () => {
            const jspdf = await ensureJsPDF();
            const { jsPDF } = jspdf;
            const doc = new jsPDF();
            let logoImg = null;
            try {
                logoImg = await loadImageAsDataUrl('ambivare.png');
                if (!logoImg) {
                    const logoUrl = new URL('ambivare.png', window.location.href).href;
                    logoImg = await loadImageAsDataUrl(logoUrl);
                }
            } catch (err) {
                console.warn('Could not load logo for projects PDF:', err);
            }
            if (!logoImg) {
                try { const resp = await fetch('./libs/embedded_logo.txt'); if (resp && resp.ok) logoImg = await resp.text(); } catch (e) {}
            }
            
            const filteredProjects = getFilteredProjects();
            
            // Header
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            if (logoImg) {
                try { doc.addImage(logoImg, 'PNG', 18, 7, 30, 16); } catch (e) { console.warn('addImage failed:', e); }
            }
            doc.text('AMBIVARE SOLUTIONS', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('PROJECTS REPORT', 105, 26, { align: 'center' });
            
            // Metadata
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 45);
            doc.text(`By: ${currentUser.fullName || currentUser.username}`, 20, 52);
            doc.text(`Total Projects: ${filteredProjects.length}`, 20, 59);
            
            // Filter info
            const searchValue = document.getElementById('searchProjects').value;
            const statusValue = document.getElementById('projectStatusFilter').value;
            
            if (searchValue || statusValue) {
                doc.setFontSize(9);
                doc.setTextColor(100, 116, 139);
                const filters = [];
                if (searchValue) filters.push(`Search: "${searchValue}"`);
                if (statusValue) filters.push(`Status: ${statusValue}`);
                doc.text('Filters Applied: ' + filters.join(', '), 20, 66);
            }
            
            doc.setDrawColor(226, 232, 240);
            doc.setLineWidth(0.5);
            doc.line(20, 72, 190, 72);
            
            let y = 82;
            
            if (filteredProjects.length === 0) {
                doc.setTextColor(100, 116, 139);
                doc.text('No projects match the current filters.', 105, y + 10, { align: 'center' });
            } else {
                filteredProjects.forEach((project, index) => {
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    // Project header box
                    doc.setFillColor(248, 250, 252);
                    doc.rect(20, y - 2, 170, 8, 'F');
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(37, 99, 235);
                    doc.text(`${index + 1}. ${project.name}`, 22, y + 4);
                    
                    // Status badge
                    const statusColor = project.status === 'Active' ? [22, 163, 74] : 
                                      project.status === 'Completed' ? [37, 99, 235] : [100, 116, 139];
                    doc.setTextColor(...statusColor);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text(project.status.toUpperCase(), 180, y + 4);
                    
                    y += 12;
                    
                    // Project details
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(15, 23, 42);
                    
                    doc.setFont(undefined, 'bold');
                    doc.text('Code:', 25, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(project.code, 45, y);
                    
                    y += 6;
                    doc.setFont(undefined, 'bold');
                    doc.text('Client:', 25, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(project.client || 'N/A', 45, y);
                    
                    if (project.description) {
                        y += 6;
                        doc.setFont(undefined, 'bold');
                        doc.text('Description:', 25, y);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(100, 116, 139);
                        const desc = project.description.length > 70 ? project.description.substring(0, 67) + '...' : project.description;
                        doc.text(desc, 25, y + 5);
                        doc.setTextColor(15, 23, 42);
                        y += 5;
                    }
                    
                    // Allocated items
                    const items = project.items || [];
                    if (items.length > 0) {
                        y += 8;
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(10);
                        doc.setTextColor(37, 99, 235);
                        doc.text('Allocated Items:', 25, y);
                        
                        y += 6;
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(15, 23, 42);
                        
                        items.forEach((item) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            doc.text(`â€¢ ${item.name}: ${item.quantity} ${item.unit} (${item.location})`, 30, y);
                            y += 5;
                        });
                    }
                    
                    y += 8;
                    doc.setDrawColor(226, 232, 240);
                    doc.line(20, y, 190, y);
                    y += 10;
                });
            }
            
            // Summary
            if (filteredProjects.length > 0) {
                const activeCount = filteredProjects.filter(p => p.status === 'Active').length;
                const completedCount = filteredProjects.filter(p => p.status === 'Completed').length;
                const onHoldCount = filteredProjects.filter(p => p.status === 'On Hold').length;
                
                if (y > 260) {
                    doc.addPage();
                    y = 20;
                }
                
                y += 5;
                doc.setDrawColor(226, 232, 240);
                doc.line(20, y, 190, y);
                y += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(15, 23, 42);
                doc.text('PROJECT SUMMARY', 20, y);
                
                y += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(22, 163, 74);
                doc.text(`Active Projects: ${activeCount}`, 25, y);
                
                y += 7;
                doc.setTextColor(37, 99, 235);
                doc.text(`Completed Projects: ${completedCount}`, 25, y);
                
                y += 7;
                doc.setTextColor(100, 116, 139);
                doc.text(`On Hold Projects: ${onHoldCount}`, 25, y);
            }
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 116, 139);
                doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                doc.text('Ambivare Solutions - Confidential', 20, 290);
            }
            
            doc.save(`projects_report_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        window.exportActivitiesPDF = async (period) => {
            const jspdf = await ensureJsPDF();
            const { jsPDF } = jspdf;
            const doc = new jsPDF();
            let logoImg = null;
            try {
                logoImg = await loadImageAsDataUrl('ambivare.png');
                if (!logoImg) {
                    const logoUrl = new URL('ambivare.png', window.location.href).href;
                    logoImg = await loadImageAsDataUrl(logoUrl);
                }
            } catch (err) {
                console.warn('Could not load logo for activities PDF:', err);
            }
            if (!logoImg) {
                try { const resp = await fetch('./libs/embedded_logo.txt'); if (resp && resp.ok) logoImg = await resp.text(); } catch (e) {}
            }
            
            // Filter activities based on period
            const now = new Date();
            let filteredActivities = [];
            let periodText = '';
            const dayMs = 24 * 60 * 60 * 1000;
            
            switch(period) {
                case 'day':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < dayMs);
                    periodText = 'Today';
                    break;
                case 'week':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 7 * dayMs);
                    periodText = 'This Week';
                    break;
                case 'month':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 30 * dayMs);
                    periodText = 'This Month';
                    break;
                case 'quarter':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 90 * dayMs);
                    periodText = 'This Quarter';
                    break;
                case 'halfyear':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 180 * dayMs);
                    periodText = 'Last 6 Months';
                    break;
                case 'year':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 365 * dayMs);
                    periodText = 'This Year';
                    break;
                default:
                    filteredActivities = [...activities];
                    periodText = 'All Time';
            }
            
            // Apply current UI filters
            const searchValue = document.getElementById('searchActivities').value.toLowerCase();
            const userFilter = document.getElementById('activityUserFilter').value;
            
            if (searchValue || userFilter) {
                filteredActivities = filteredActivities.filter(act => {
                    const matchesSearch = !searchValue || act.action.toLowerCase().includes(searchValue);
                    const matchesUser = !userFilter || act.user === userFilter;
                    return matchesSearch && matchesUser;
                });
            }
            
            // Header
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            if (logoImg) {
                try { doc.addImage(logoImg, 'PNG', 18, 7, 30, 16); } catch (e) { console.warn('addImage failed:', e); }
            }
            doc.text('AMBIVARE SOLUTIONS', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('ACTIVITY LOG REPORT', 105, 26, { align: 'center' });
            
            // Metadata
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.text(`Period: ${periodText}`, 20, 45);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 52);
            doc.text(`By: ${currentUser.fullName || currentUser.username}`, 20, 59);
            doc.text(`Total Activities: ${filteredActivities.length}`, 20, 66);
            
            // Filter info
            if (searchValue || userFilter) {
                doc.setFontSize(9);
                doc.setTextColor(100, 116, 139);
                const filters = [];
                if (searchValue) filters.push(`Search: "${searchValue}"`);
                if (userFilter) filters.push(`User: ${userFilter}`);
                doc.text('Filters Applied: ' + filters.join(', '), 20, 73);
            }
            
            doc.setDrawColor(226, 232, 240);
            doc.setLineWidth(0.5);
            doc.line(20, 79, 190, 79);
            
            // Table header
            let y = 89;
            doc.setFillColor(248, 250, 252);
            doc.rect(20, y - 7, 170, 10, 'F');
            
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('#', 22, y);
            doc.text('Date & Time', 30, y);
            doc.text('User', 75, y);
            doc.text('Action', 105, y);
            
            doc.setDrawColor(226, 232, 240);
            doc.line(20, y + 2, 190, y + 2);
            
            y += 10;
            
            // Table content
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            if (filteredActivities.length === 0) {
                doc.setTextColor(100, 116, 139);
                doc.text(`No activities recorded for ${periodText.toLowerCase()}.`, 105, y + 10, { align: 'center' });
            } else {
                filteredActivities.forEach((activity, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                        
                        // Repeat header on new page
                        doc.setFillColor(248, 250, 252);
                        doc.rect(20, y - 7, 170, 10, 'F');
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(15, 23, 42);
                        doc.text('#', 22, y);
                        doc.text('Date & Time', 30, y);
                        doc.text('User', 75, y);
                        doc.text('Action', 105, y);
                        doc.line(20, y + 2, 190, y + 2);
                        y += 10;
                        doc.setFont(undefined, 'normal');
                    }
                    
                    // Alternating row background
                    if (index % 2 === 0) {
                        doc.setFillColor(249, 250, 251);
                        doc.rect(20, y - 6, 170, 12, 'F');
                    }
                    
                    doc.setTextColor(15, 23, 42);
                    doc.text(`${index + 1}`, 22, y);
                    
                    const date = new Date(activity.date);
                    const dateStr = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const timeStr = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    
                    doc.setFontSize(9);
                    doc.text(dateStr, 30, y);
                    doc.setFontSize(8);
                    doc.setTextColor(100, 116, 139);
                    doc.text(timeStr, 30, y + 4);
                    
                    doc.setFontSize(9);
                    doc.setTextColor(37, 99, 235);
                    doc.setFont(undefined, 'bold');
                    doc.text(activity.user.length > 12 ? activity.user.substring(0, 10) + '..' : activity.user, 75, y);
                    
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(15, 23, 42);
                    
                    // Wrap long action text
                    const maxWidth = 80;
                    let actionText = activity.action;
                    if (actionText.length > 60) {
                        const line1 = actionText.substring(0, 60);
                        const line2 = actionText.substring(60, 120) + (actionText.length > 120 ? '...' : '');
                        doc.text(line1, 105, y);
                        doc.setFontSize(8);
                        doc.setTextColor(100, 116, 139);
                        doc.text(line2, 105, y + 4);
                        y += 4;
                    } else {
                        doc.text(actionText, 105, y);
                    }
                    
                    y += 10;
                });
            }
            
            // Summary section
            if (filteredActivities.length > 0) {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                y += 10;
                doc.setDrawColor(226, 232, 240);
                doc.line(20, y, 190, y);
                y += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(15, 23, 42);
                doc.text('ACTIVITY BREAKDOWN', 20, y);
                
                y += 10;
                
                // Count activity types
                const addedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('added')).length;
                const updatedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('updated')).length;
                const deletedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('deleted')).length;
                const usedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('used')).length;
                const returnedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('returned')).length;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                if (addedItems > 0) {
                    doc.setTextColor(22, 163, 74);
                    doc.text(`Added/Created: ${addedItems} activities`, 25, y);
                    y += 7;
                }
                
                if (updatedItems > 0) {
                    doc.setTextColor(37, 99, 235);
                    doc.text(`Updated: ${updatedItems} activities`, 25, y);
                    y += 7;
                }
                
                if (usedItems > 0) {
                    doc.setTextColor(234, 88, 12);
                    doc.text(`Used/Assigned: ${usedItems} activities`, 25, y);
                    y += 7;
                }
                
                if (returnedItems > 0) {
                    doc.setTextColor(147, 51, 234);
                    doc.text(`Returned: ${returnedItems} activities`, 25, y);
                    y += 7;
                }
                
                if (deletedItems > 0) {
                    doc.setTextColor(220, 38, 38);
                    doc.text(`Deleted: ${deletedItems} activities`, 25, y);
                    y += 7;
                }
                
                // Most active users
                const userCounts = {};
                filteredActivities.forEach(a => {
                    userCounts[a.user] = (userCounts[a.user] || 0) + 1;
                });
                
                const topUsers = Object.entries(userCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                if (topUsers.length > 0) {
                    y += 8;
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(15, 23, 42);
                    doc.text('Most Active Users:', 25, y);
                    
                    y += 7;
                    doc.setFont(undefined, 'normal');
                    topUsers.forEach(([user, count]) => {
                        doc.setTextColor(100, 116, 139);
                        doc.text(`${user}: ${count} activities`, 30, y);
                        y += 6;
                    });
                }
            }
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 116, 139);
                doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                doc.text('Ambivare Solutions - Confidential', 20, 290);
            }
            
            doc.save(`activities_${period}_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        window.showBarcodeScanner = async (location) => {
            currentScanLocation = location;
            const modal = document.getElementById('barcodeModal');
            const permissionInfo = document.getElementById('cameraPermissionInfo');
            const scanStatus = document.getElementById('scanStatus');
            
            modal.classList.add('active');
            permissionInfo.style.display = 'block';
            scanStatus.textContent = 'Requesting camera access...';
            scanStatus.className = 'scan-status';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        focusMode: 'continuous',
                        frameRate: { ideal: 30 }
                    } 
                });
                
                const videoElement = document.getElementById('barcodeVideo');
                videoElement.srcObject = stream;
                barcodeStream = stream;
                
                permissionInfo.style.display = 'none';
                scanStatus.textContent = 'Camera ready. Position barcode in view...';
                scanStatus.className = 'scan-status scanning';
                
                await new Promise(resolve => {
                    videoElement.onloadedmetadata = () => {
                        videoElement.play();
                        resolve();
                    };
                });
                
                startBarcodeScanning();
            } catch (error) {
                console.error('Camera error:', error);
                permissionInfo.innerHTML = 'âš ï¸ Camera access denied. Please allow camera permission in your browser settings and try again.';
                permissionInfo.style.background = '#fee2e2';
                permissionInfo.style.borderColor = '#fecaca';
                permissionInfo.style.color = '#991b1b';
                scanStatus.textContent = 'Camera access failed';
                scanStatus.style.background = '#fee2e2';
                scanStatus.style.color = '#991b1b';
            }
        };

        function startBarcodeScanning() {
            scanningActive = true;
            const codeReader = new ZXing.BrowserMultiFormatReader();
            barcodeCodeReader = codeReader;
            
            const hints = new Map();
            hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
            hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                ZXing.BarcodeFormat.EAN_13,
                ZXing.BarcodeFormat.EAN_8,
                ZXing.BarcodeFormat.CODE_128,
                ZXing.BarcodeFormat.CODE_39,
                ZXing.BarcodeFormat.UPC_A,
                ZXing.BarcodeFormat.UPC_E,
                ZXing.BarcodeFormat.QR_CODE
            ]);
            
            const videoElement = document.getElementById('barcodeVideo');
            const scanStatus = document.getElementById('scanStatus');
            
            const scan = async () => {
                if (!scanningActive) return;
                
                try {
                    const result = await codeReader.decodeFromVideoElement(videoElement, hints);
                    
                    if (result) {
                        const barcode = result.text;
                        scanStatus.textContent = `âœ“ Barcode detected: ${barcode}`;
                        scanStatus.style.background = '#dcfce7';
                        scanStatus.style.color = '#166534';
                        
                        document.getElementById('barcodeResult').textContent = `Found: ${barcode}`;
                        document.getElementById('barcodeResult').style.display = 'block';
                        document.getElementById('barcodeResult').style.background = '#dcfce7';
                        document.getElementById('barcodeResult').style.color = '#166534';
                        
                        const allItems = getAllItems();
                        const item = allItems.find(i => i.barcode === barcode && i.location === currentScanLocation);
                        
                        if (item) {
                            scanStatus.textContent = `âœ“ Item found: ${item.name}`;
                            setTimeout(() => {
                                closeBarcodeScanner();
                                editInventory(item.id);
                            }, 1000);
                        } else {
                            scanStatus.textContent = `âš ï¸ Item not found in ${currentScanLocation}`;
                            scanStatus.style.background = '#fef3c7';
                            scanStatus.style.color = '#92400e';
                            
                            document.getElementById('barcodeResult').textContent = `Item not found in ${currentScanLocation} inventory. Add new item with this barcode?`;
                            document.getElementById('barcodeResult').style.background = '#fef3c7';
                            document.getElementById('barcodeResult').style.color = '#92400e';
                            
                            setTimeout(() => {
                                closeBarcodeScanner();
                                showAddInventoryModal(currentScanLocation);
                                document.getElementById('itemBarcode').value = barcode;
                            }, 2000);
                        }
                        return;
                    }
                } catch (error) {
                    if (error.name !== 'NotFoundException') {
                        console.error('Scan error:', error);
                    }
                }
                
                if (scanningActive) {
                    requestAnimationFrame(scan);
                }
            };
            
            scan();
        }

        window.closeBarcodeScanner = () => {
            scanningActive = false;
            
            if (barcodeCodeReader) {
                try {
                    barcodeCodeReader.reset();
                } catch (e) {
                    console.log('CodeReader reset error:', e);
                }
                barcodeCodeReader = null;
            }
            
            if (barcodeStream) {
                barcodeStream.getTracks().forEach(track => track.stop());
                barcodeStream = null;
            }
            
            const videoElement = document.getElementById('barcodeVideo');
            videoElement.srcObject = null;
            
            document.getElementById('barcodeResult').style.display = 'none';
            document.getElementById('barcodeResult').style.background = 'var(--bg-light)';
            document.getElementById('barcodeResult').style.color = 'var(--primary)';
            document.getElementById('cameraPermissionInfo').style.display = 'none';
            
            const scanStatus = document.getElementById('scanStatus');
            scanStatus.textContent = 'Initializing scanner...';
            scanStatus.className = 'scan-status';
            
            currentScanLocation = null;
            closeModal('barcodeModal');
        };

        window.showTab = (tab) => {
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(content => content.classList.remove('active'));
            
            const clickedTab = event ? event.target : document.querySelector(`.nav-tab[onclick="showTab('${tab}')"]`);
            if (clickedTab) clickedTab.classList.add('active');
            
            document.getElementById(tab + 'Tab').classList.add('active');
        };

        window.closeModal = (modalId) => {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'userModal') {
                document.getElementById('newUsername').disabled = false;
            }
        };

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>