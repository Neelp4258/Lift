<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avant Elevators - Elevator Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ea580c;
            --border: #e2e8f0;
            --bg-light: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 20px;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-card {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 48px;
            max-width: 420px;
            width: 100%;
            box-shadow: var(--shadow-lg);
        }

        .logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo h1 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .logo p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-light);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #c2410c;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .main-app {
            display: none;
            min-height: 100vh;
        }

        .main-app.active {
            display: block;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .header-left h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-left p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .offline-badge {
            background: var(--warning);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: none;
        }

        .offline-badge.show {
            display: block;
        }

        .user-badge {
            background: var(--bg-light);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .nav-tabs {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 0;
        }

        .nav-tabs-container {
            display: flex;
            gap: 0;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 14px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-light);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .content {
            padding: 24px 0;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--bg-light);
            border-radius: 6px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 16px;
            position: relative;
        }

        .chart-container canvas {
            max-height: 300px !important;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .charts-grid .card {
            height: 400px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 16px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background: var(--bg-light);
        }

        .table th {
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }

        .table td {
            padding: 12px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        .table tbody tr:hover {
            background: var(--bg-light);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-primary {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-secondary {
            background: var(--bg-light);
            color: var(--text-secondary);
        }

        .search-box {
            position: relative;
            margin-bottom: 16px;
        }

        .search-box input {
            width: 100%;
            max-width: 400px;
            padding: 10px 12px 10px 36px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .search-box::before {
            content: "ðŸ”";
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-dialog {
            background: white;
            border-radius: 8px;
            max-width: 540px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            margin: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-light);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .project-items {
            margin-top: 8px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 4px;
            font-size: 13px;
        }

        .project-items p {
            margin: 4px 0;
            color: var(--text-secondary);
        }

        .low-stock-alert {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .low-stock-alert .icon {
            font-size: 20px;
        }

        .low-stock-list {
            list-style: none;
            padding: 0;
        }

        .low-stock-list li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .low-stock-list li:last-child {
            border-bottom: none;
        }

        .barcode-reader {
            padding: 20px;
            text-align: center;
        }

        #barcodeVideo {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: #000;
        }

        .barcode-result {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 6px;
            font-weight: 600;
            color: var(--primary);
        }

        .camera-permission-info {
            padding: 16px;
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #1e40af;
        }

        .scan-status {
            margin-top: 12px;
            padding: 8px;
            background: #dbeafe;
            border-radius: 4px;
            font-size: 13px;
            color: #1e40af;
        }

        .scan-status.scanning {
            background: #dcfce7;
            color: #166534;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid .card {
                height: 350px;
            }

            .login-card {
                padding: 32px 24px;
            }

            .card {
                padding: 16px;
            }

            .header-right {
                flex-wrap: wrap;
                width: 100%;
            }

            .user-name {
                display: none;
            }

            .filters {
                flex-direction: column;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        /* Billing System Styles */
        .form-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .form-section h4 {
            margin-bottom: 16px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .invoice-items-container {
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            overflow-x: auto;
        }

        .invoice-item-header {
            display: grid;
            grid-template-columns: 2fr 80px 80px 120px 120px 80px;
            gap: 12px;
            padding: 12px;
            background: var(--bg-light);
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
            min-width: 600px;
        }

        .invoice-item {
            display: grid;
            grid-template-columns: 2fr 80px 80px 120px 120px 80px;
            gap: 12px;
            padding: 12px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            min-width: 600px;
        }

        .invoice-item:last-child {
            border-bottom: none;
        }

        .invoice-item input,
        .invoice-item select {
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }

        .invoice-totals {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .total-display {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .total-amount {
            font-size: 18px;
            color: var(--success);
        }

        .billing-stats-grid .stat-card {
            text-align: center;
        }

        .invoice-status-paid {
            background: #dcfce7;
            color: #166534;
        }

        .invoice-status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .invoice-status-overdue {
            background: #fef2f2;
            color: #991b1b;
        }

        .invoice-status-draft {
            background: #f1f5f9;
            color: #475569;
        }

        .invoice-status-sent {
            background: #dbeafe;
            color: #1e40af;
        }

        .invoice-status-cancelled {
            background: #f3f4f6;
            color: #6b7280;
        }

        /* Mobile Billing Optimizations */
        @media (max-width: 768px) {
            .billing-stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
            }

            .filters {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 12px !important;
            }

            .filters input,
            .filters select {
                width: 100% !important;
                min-width: auto !important;
            }

            .card-header {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 16px !important;
            }

            .card-header > div {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            .action-buttons {
                flex-direction: column !important;
                gap: 6px !important;
            }

            .action-buttons .btn {
                width: 100%;
                justify-content: center;
            }

            /* Invoice Modal Mobile Optimization */
            #invoiceModal .modal-dialog {
                max-width: 95% !important;
                margin: 10px !important;
            }

            .invoice-items-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .invoice-item-header {
                min-width: 700px;
                font-size: 12px;
                padding: 8px;
                gap: 8px;
            }

            .invoice-item {
                min-width: 700px;
                padding: 8px;
                gap: 8px;
            }

            .invoice-item input {
                font-size: 13px;
                padding: 4px 6px;
            }

            .invoice-totals .form-row {
                flex-direction: column !important;
            }

            .form-section h4 {
                font-size: 14px;
                margin-bottom: 12px;
            }

            .form-row {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* Table responsiveness for billing */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table-responsive table {
                min-width: 700px;
            }

            .table-responsive th,
            .table-responsive td {
                padding: 8px 6px;
                font-size: 13px;
                white-space: nowrap;
            }

            /* Stats cards mobile */
            .stat-card {
                padding: 16px !important;
            }

            .stat-value {
                font-size: 24px !important;
            }

            .stat-label {
                font-size: 13px !important;
            }
        }

        @media (max-width: 480px) {
            .billing-stats-grid {
                grid-template-columns: 1fr !important;
            }

            .table-responsive table {
                min-width: 600px;
            }

            .invoice-item-header,
            .invoice-item {
                min-width: 600px;
                grid-template-columns: 1.5fr 60px 60px 100px 100px 60px;
                font-size: 11px;
            }

            .card-header h3 {
                font-size: 16px;
            }

            .modal-dialog {
                margin: 5px !important;
            }
        }

        /* Progress Bar Styles */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-light);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        /* Project Details Styles */
        .project-details {
            margin-top: 4px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .project-details small {
            display: block;
            margin-bottom: 2px;
        }

        /* Form Section Styles */
        .form-section {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h4 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }

    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="logo">
                <img src="ambivare.png" alt="Avant Elevators" style="max-width: 150px; margin-bottom: 16px;">
                <h1 data-translate="company_name">Avant Elevators</h1>
                <p data-translate="system_title">Elevator Management System</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label data-translate="username">Username</label>
                    <input type="text" class="form-control" id="username" required data-translate-placeholder="enter_username" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label data-translate="password">Password</label>
                    <input type="password" class="form-control" id="password" required data-translate-placeholder="enter_password" placeholder="Enter password">
                </div>
                <div id="loginError" class="alert alert-danger" style="display: none;"></div>
                <button type="submit" class="btn btn-primary" id="loginBtn" data-translate="sign_in">Sign In</button>
            </form>
        </div>
    </div>

    <div class="main-app" id="mainApp">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="header-left" style="display: flex; align-items: center; gap: 12px;">
                        <img src="ambivare.png" alt="Avant Elevators" style="height: 40px;">
                        <div>
                            <h2 data-translate="company_name">Avant Elevators</h2>
                            <p data-translate="portal_subtitle">Elevator Management Portal</p>
                        </div>
                    </div>
                    <div class="header-right" style="display: flex; align-items: center; gap: 12px;">
                        <div class="language-switcher" style="margin-right: 12px;">
                            <select id="languageSelector" onchange="changeLanguage()" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px;">
                                <option value="en">English</option>
                                <option value="hi">à¤¹à¤¿à¤‚à¤¦à¥€</option>
                                <option value="mr">à¤®à¤°à¤¾à¤ à¥€</option>
                            </select>
                        </div>
                        <div class="offline-badge" id="offlineBadge">OFFLINE MODE</div>
                        <span class="user-badge" id="userRole">USER</span>
                        <span class="user-name" id="userName">User</span>
                        <button class="btn btn-secondary btn-sm" onclick="logout()" data-translate="logout">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <div class="container">
                <div class="nav-tabs-container">
                    <button class="nav-tab active" onclick="showTab('dashboard')" data-translate="dashboard">Dashboard</button>
                    <button class="nav-tab" onclick="showTab('warehouse')" data-translate="warehouse">Warehouse</button>
                    <button class="nav-tab" onclick="showTab('service-van')" data-translate="service_van">Service Van</button>
                    <button class="nav-tab" onclick="showTab('office')" data-translate="office">Office</button>
                    <button class="nav-tab" onclick="showTab('projects')" data-translate="projects">Projects</button>
                    <button class="nav-tab" onclick="showTab('maintenance')" data-translate="maintenance">Maintenance</button>
                    <button class="nav-tab" id="salesTabBtn" onclick="showTab('sales')" style="display: none;" data-translate="sales">Sales</button>
                    <button class="nav-tab" onclick="showTab('activities')" data-translate="activities">Activities</button>
                    <button class="nav-tab" id="billingTabBtn" onclick="showTab('billing')" data-translate="billing">Billing</button>
                    <button class="nav-tab" id="usersTabBtn" onclick="showTab('users')" style="display: none;" data-translate="users">Users</button>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="container">
                <div class="tab-pane active" id="dashboardTab">
                    <div id="lowStockAlerts"></div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label" data-translate="total_items">Total Parts</div>
                            <div class="stat-value" id="totalItems">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label" data-translate="warehouse_items">Warehouse Stock</div>
                            <div class="stat-value" id="warehouseItems">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label" data-translate="service_van_items">Service Van Stock</div>
                            <div class="stat-value" id="serviceVanItems">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label" data-translate="office_items">Office Supplies</div>
                            <div class="stat-value" id="officeItems">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label" data-translate="active_projects">Active Projects</div>
                            <div class="stat-value" id="activeProjects">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label" data-translate="maintenance_due">Maintenance Due</div>
                            <div class="stat-value" id="maintenanceDue">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Elevators Installed</div>
                            <div class="stat-value" id="elevatorsInstalled">0</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-label">Low Stock Items</div>
                            <div class="stat-value" id="lowStockItems">0</div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 class="card-title" style="margin: 0;">Inventory by Location</h3>
                                <button class="btn btn-sm btn-secondary" onclick="renderCharts()" style="font-size: 12px; padding: 4px 8px;">Refresh Charts</button>
                            </div>
                            <div class="chart-container">
                                <canvas id="locationChart"></canvas>
                            </div>
                        </div>
                        <div class="card">
                            <h3 class="card-title">Stock Levels</h3>
                            <div class="chart-container">
                                <canvas id="stockChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Warehouse Tab -->
                <div class="tab-pane" id="warehouseTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Warehouse Inventory</h3>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" onclick="showBarcodeScanner('warehouse')">ðŸ“· Scan Barcode</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportLocationPDF('warehouse')">ðŸ“¥ Export PDF</button>
                                <button class="btn btn-success btn-sm" onclick="showAddInventoryModal('warehouse')">+ Add Item</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchWarehouse" placeholder="Search..." oninput="filterLocation('warehouse')">
                            </div>
                            <div class="filter-group">
                                <label>Category</label>
                                <select id="categoryFilterWarehouse" onchange="filterLocation('warehouse')">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="statusFilterWarehouse" onchange="filterLocation('warehouse')">
                                    <option value="">All Status</option>
                                    <option value="good">Good Stock</option>
                                    <option value="medium">Medium Stock</option>
                                    <option value="low">Low Stock</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="warehouseList">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Office Tab -->
                <div class="tab-pane" id="officeTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Office Inventory</h3>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" onclick="showBarcodeScanner('office')">ðŸ“· Scan Barcode</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportLocationPDF('office')">ðŸ“¥ Export PDF</button>
                                <button class="btn btn-success btn-sm" onclick="showAddInventoryModal('office')">+ Add Item</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchOffice" placeholder="Search..." oninput="filterLocation('office')">
                            </div>
                            <div class="filter-group">
                                <label>Category</label>
                                <select id="categoryFilterOffice" onchange="filterLocation('office')">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="statusFilterOffice" onchange="filterLocation('office')">
                                    <option value="">All Status</option>
                                    <option value="good">Good Stock</option>
                                    <option value="medium">Medium Stock</option>
                                    <option value="low">Low Stock</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="officeList">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Service Van Tab -->
                <div class="tab-pane" id="service-vanTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Service Van Inventory</h3>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" onclick="showBarcodeScanner('service-van')">ðŸ“· Scan Barcode</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportLocationPDF('service-van')">ðŸ“¥ Export PDF</button>
                                <button class="btn btn-success btn-sm" onclick="showAddInventoryModal('service-van')">+ Add Item</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchServiceVan" placeholder="Search..." oninput="filterLocation('service-van')">
                            </div>
                            <div class="filter-group">
                                <label>Category</label>
                                <select id="categoryFilterServiceVan" onchange="filterLocation('service-van')">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="statusFilterServiceVan" onchange="filterLocation('service-van')">
                                    <option value="">All Status</option>
                                    <option value="good">Good Stock</option>
                                    <option value="medium">Medium Stock</option>
                                    <option value="low">Low Stock</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="serviceVanList">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Projects Tab -->
                <div class="tab-pane" id="projectsTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Project Management</h3>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="exportProjectsPDF()">ðŸ“¥ Export PDF</button>
                                <button class="btn btn-warning btn-sm" onclick="exportHoldReportPDF('projects')">Export Hold Report</button>
                                <button class="btn btn-success btn-sm" onclick="showAddProjectModal()">+ Create Project</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchProjects" placeholder="Search..." oninput="filterProjects()">
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="projectStatusFilter" onchange="filterProjects()">
                                    <option value="">All Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Completed">Completed</option>
                                    <option value="On Hold">On Hold</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Project Name</th>
                                        <th>Code</th>
                                        <th>Client</th>
                                        <th>Elevators</th>
                                        <th>Progress</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="projectList">
                                    <tr><td colspan="7" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Maintenance Tab -->
                <div class="tab-pane" id="maintenanceTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Maintenance Management</h3>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="exportMaintenancePDF()">ðŸ“¥ Export PDF</button>
                                <button class="btn btn-warning btn-sm" onclick="exportHoldReportPDF('maintenance')">Export Hold Report</button>
                                <button class="btn btn-success btn-sm" onclick="showAddMaintenanceModal()">+ Schedule Maintenance</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchMaintenance" placeholder="Search..." oninput="filterMaintenance()">
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="maintenanceStatusFilter" onchange="filterMaintenance()">
                                    <option value="">All Status</option>
                                    <option value="Scheduled">Scheduled</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Overdue">Overdue</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Priority</label>
                                <select id="maintenancePriorityFilter" onchange="filterMaintenance()">
                                    <option value="">All Priority</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Assigned To</label>
                                <select id="maintenanceAssigneeFilter" onchange="filterMaintenance()">
                                    <option value="">All Technicians</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Elevator ID</th>
                                        <th>Project</th>
                                        <th>Issue</th>
                                        <th>Complaint By</th>
                                        <th>Priority</th>
                                        <th>Assigned To</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenanceList">
                                    <tr><td colspan="8" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Activities Tab -->
                <div class="tab-pane" id="activitiesTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Activity Logs</h3>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('day')">ðŸ“¥ Day</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('week')">ðŸ“¥ Week</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('month')">ðŸ“¥ Month</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('quarter')">ðŸ“¥ Quarter</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('halfyear')">ðŸ“¥ Half Year</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('year')">ðŸ“¥ Year</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchActivities" placeholder="Search..." oninput="filterActivities()">
                            </div>
                            <div class="filter-group">
                                <label>Date Range</label>
                                <select id="activityDateFilter" onchange="filterActivities()">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="halfyear">Last 6 Months</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>User</label>
                                <select id="activityUserFilter" onchange="filterActivities()">
                                    <option value="">All Users</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>Action</th>
                                        <th>User</th>
                                    </tr>
                                </thead>
                                <tbody id="activityList">
                                    <tr><td colspan="3" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div class="tab-pane" id="usersTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">User Management</h3>
                            <button class="btn btn-success btn-sm" onclick="showAddUserModal()">+ Add User</button>
                        </div>
                        <div class="search-box">
                            <input type="text" id="searchUsers" placeholder="Search users..." onkeyup="filterUsers()">
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Username</th>
                                        <th>Full Name</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="usersList">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Billing Tab -->
                <div class="tab-pane" id="billingTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Billing & Invoicing</h3>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-success" onclick="showCreateInvoiceModal()">+ Create Invoice</button>
                                <button class="btn btn-primary" onclick="showQuotationModal()">+ Create Quotation</button>
                            </div>
                        </div>

                        <div style="display: flex; gap: 20px; margin-bottom: 24px;">
                            <div class="filters">
                                <input type="text" id="searchInvoices" placeholder="Search invoices..." oninput="filterInvoices()">
                                <select id="invoiceStatusFilter" onchange="filterInvoices()">
                                    <option value="">All Status</option>
                                    <option value="draft">Draft</option>
                                    <option value="sent">Sent</option>
                                    <option value="paid">Paid</option>
                                    <option value="overdue">Overdue</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                                <select id="invoiceTypeFilter" onchange="filterInvoices()">
                                    <option value="">All Types</option>
                                    <option value="invoice">Invoice</option>
                                    <option value="quotation">Quotation</option>
                                </select>
                            </div>
                        </div>

                        <div class="billing-stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div class="stat-card">
                                <div class="stat-value" id="totalInvoices">0</div>
                                <div class="stat-label">Total Invoices</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="totalRevenue">â‚¹0</div>
                                <div class="stat-label">Total Revenue</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="pendingAmount">â‚¹0</div>
                                <div class="stat-label">Pending Amount</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="overdueInvoices">0</div>
                                <div class="stat-label">Overdue Invoices</div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Invoice #</th>
                                        <th>Type</th>
                                        <th>Client</th>
                                        <th>Date</th>
                                        <th>Due Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoicesList">
                                    <tr><td colspan="8" class="empty-state"><div class="empty-state-icon">ðŸ“„</div><p>No invoices created yet. Click "Create Invoice" to get started.</p></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Sales Tab -->
                <div class="tab-pane" id="salesTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Lead Management</h3>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="exportLeadsPDF()">ðŸ“¥ Export Leads</button>
                                <button class="btn btn-warning btn-sm" onclick="exportHoldReportPDF('leads')">Export Hold Report</button>
                                <button class="btn btn-primary btn-sm" onclick="bulkImportLeads()">ðŸ“‚ Import Leads</button>
                                <button class="btn btn-success btn-sm" onclick="showAddLeadModal()">+ Add Lead</button>
                            </div>
                        </div>

                        <!-- Lead Statistics -->
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div class="stat-card">
                                <div class="stat-value" id="totalLeads">0</div>
                                <div class="stat-label">Total Leads</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="hotLeads">0</div>
                                <div class="stat-label">Hot Leads</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="convertedLeads">0</div>
                                <div class="stat-label">Converted</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="monthlyRevenue">â‚¹0</div>
                                <div class="stat-label">Monthly Revenue</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="conversionRate">0%</div>
                                <div class="stat-label">Conversion Rate</div>
                            </div>
                        </div>

                        <!-- Lead Filters -->
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchLeads" placeholder="Search leads..." oninput="filterLeads()">
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="leadStatusFilter" onchange="filterLeads()">
                                    <option value="">All Status</option>
                                    <option value="New">New</option>
                                    <option value="Contacted">Contacted</option>
                                    <option value="Qualified">Qualified</option>
                                    <option value="Proposal">Proposal</option>
                                    <option value="Negotiation">Negotiation</option>
                                    <option value="Converted">Converted</option>
                                    <option value="Lost">Lost</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Priority</label>
                                <select id="leadPriorityFilter" onchange="filterLeads()">
                                    <option value="">All Priority</option>
                                    <option value="Hot">Hot</option>
                                    <option value="Warm">Warm</option>
                                    <option value="Cold">Cold</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Assigned To</label>
                                <select id="leadAssignedFilter" onchange="filterLeads()">
                                    <option value="">All Sales Reps</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Source</label>
                                <select id="leadSourceFilter" onchange="filterLeads()">
                                    <option value="">All Sources</option>
                                    <option value="Website">Website</option>
                                    <option value="Referral">Referral</option>
                                    <option value="Cold Call">Cold Call</option>
                                    <option value="Exhibition">Exhibition</option>
                                    <option value="Social Media">Social Media</option>
                                    <option value="Print Ad">Print Ad</option>
                                    <option value="Direct Visit">Direct Visit</option>
                                </select>
                            </div>
                        </div>

                        <!-- Leads Table -->
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Lead Info</th>
                                        <th>Company</th>
                                        <th>Contact</th>
                                        <th>Requirements</th>
                                        <th>Value</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Assigned To</th>
                                        <th>Last Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="leadsList">
                                    <tr><td colspan="10" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Lead Modal -->
    <div class="modal" id="leadModal">
        <div class="modal-dialog" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="leadModalTitle">Add New Lead</h3>
                <button class="modal-close" onclick="closeModal('leadModal')">&times;</button>
            </div>
            <form id="leadForm">
                <div class="modal-body">
                    <input type="hidden" id="editLeadId">
                    
                    <!-- Basic Information -->
                    <div class="card" style="background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 20px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #1e40af; font-size: 16px;">ðŸ‘¤ Contact Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadName">Contact Person *</label>
                                <input type="text" class="form-control" id="leadName" required placeholder="Full name">
                            </div>
                            <div class="form-group">
                                <label for="leadDesignation">Designation</label>
                                <input type="text" class="form-control" id="leadDesignation" placeholder="e.g. Project Manager, Owner">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadPhone">Phone Number *</label>
                                <input type="tel" class="form-control" id="leadPhone" required placeholder="Primary contact number">
                            </div>
                            <div class="form-group">
                                <label for="leadAlternatePhone">Alternate Phone</label>
                                <input type="tel" class="form-control" id="leadAlternatePhone" placeholder="Secondary number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="leadEmail">Email Address</label>
                            <input type="email" class="form-control" id="leadEmail" placeholder="contact@company.com">
                        </div>
                    </div>

                    <!-- Company Information -->
                    <div class="card" style="background: #fef7ff; border: 1px solid #e9d5ff; margin-bottom: 20px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #7c3aed; font-size: 16px;">ðŸ¢ Company Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadCompany">Company Name *</label>
                                <input type="text" class="form-control" id="leadCompany" required placeholder="Company or project name">
                            </div>
                            <div class="form-group">
                                <label for="leadIndustry">Industry Type</label>
                                <select class="form-control" id="leadIndustry">
                                    <option value="">Select Industry</option>
                                    <option value="Residential">Residential Complex</option>
                                    <option value="Commercial">Commercial Building</option>
                                    <option value="Hospital">Hospital/Healthcare</option>
                                    <option value="Hotel">Hotel/Hospitality</option>
                                    <option value="Mall">Shopping Mall</option>
                                    <option value="Office">Office Complex</option>
                                    <option value="Industrial">Industrial</option>
                                    <option value="Educational">Educational Institution</option>
                                    <option value="Government">Government Building</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="leadAddress">Project Address *</label>
                            <textarea class="form-control" id="leadAddress" rows="2" required placeholder="Complete project/building address"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadCity">City *</label>
                                <input type="text" class="form-control" id="leadCity" required placeholder="City">
                            </div>
                            <div class="form-group">
                                <label for="leadState">State</label>
                                <input type="text" class="form-control" id="leadState" placeholder="State">
                            </div>
                        </div>
                    </div>

                    <!-- Project Requirements -->
                    <div class="card" style="background: #fff7ed; border: 1px solid #fed7aa; margin-bottom: 20px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #ea580c; font-size: 16px;">ðŸ—ï¸ Project Requirements</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadElevatorType">Elevator Type *</label>
                                <select class="form-control" id="leadElevatorType" required>
                                    <option value="">Select Type</option>
                                    <option value="Passenger">Passenger Elevator</option>
                                    <option value="Goods">Goods/Freight Elevator</option>
                                    <option value="Hospital">Hospital/Bed Elevator</option>
                                    <option value="Car">Car Elevator</option>
                                    <option value="Home">Home/Villa Elevator</option>
                                    <option value="Dumbwaiter">Dumbwaiter</option>
                                    <option value="Escalator">Escalator</option>
                                    <option value="Moving Walkway">Moving Walkway</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leadQuantity">Quantity Required *</label>
                                <input type="number" class="form-control" id="leadQuantity" required min="1" placeholder="Number of elevators">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadCapacity">Load Capacity (kg)</label>
                                <select class="form-control" id="leadCapacity">
                                    <option value="">Select Capacity</option>
                                    <option value="320">320 kg (4-5 persons)</option>
                                    <option value="450">450 kg (6 persons)</option>
                                    <option value="630">630 kg (8 persons)</option>
                                    <option value="800">800 kg (10 persons)</option>
                                    <option value="1000">1000 kg (13 persons)</option>
                                    <option value="1350">1350 kg (18 persons)</option>
                                    <option value="1600">1600 kg (21 persons)</option>
                                    <option value="2000">2000 kg (Goods/Freight)</option>
                                    <option value="3000">3000 kg (Heavy Goods)</option>
                                    <option value="5000">5000+ kg (Industrial)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leadFloors">Number of Floors</label>
                                <input type="number" class="form-control" id="leadFloors" min="2" placeholder="Total floors to serve">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="leadSpecifications">Special Requirements</label>
                            <textarea class="form-control" id="leadSpecifications" rows="2" placeholder="Any special requirements, features, or constraints"></textarea>
                        </div>
                    </div>

                    <!-- Business Information -->
                    <div class="card" style="background: #f0fdf4; border: 1px solid #bbf7d0; margin-bottom: 20px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #16a34a; font-size: 16px;">ðŸ’° Business Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadBudget">Estimated Budget (â‚¹)</label>
                                <select class="form-control" id="leadBudget">
                                    <option value="">Select Budget Range</option>
                                    <option value="5-10 Lakhs">â‚¹5-10 Lakhs</option>
                                    <option value="10-20 Lakhs">â‚¹10-20 Lakhs</option>
                                    <option value="20-50 Lakhs">â‚¹20-50 Lakhs</option>
                                    <option value="50 Lakhs - 1 Crore">â‚¹50 Lakhs - 1 Crore</option>
                                    <option value="1-2 Crore">â‚¹1-2 Crore</option>
                                    <option value="2+ Crore">â‚¹2+ Crore</option>
                                    <option value="Custom">Custom Quote</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leadTimeline">Project Timeline</label>
                                <select class="form-control" id="leadTimeline">
                                    <option value="">Select Timeline</option>
                                    <option value="Immediate">Immediate (Within 1 month)</option>
                                    <option value="1-3 months">1-3 months</option>
                                    <option value="3-6 months">3-6 months</option>
                                    <option value="6-12 months">6-12 months</option>
                                    <option value="12+ months">12+ months</option>
                                    <option value="Planning stage">Still in planning</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadValue">Estimated Deal Value (â‚¹)</label>
                                <input type="number" class="form-control" id="leadValue" step="0.01" placeholder="Expected contract value">
                            </div>
                            <div class="form-group">
                                <label for="leadProbability">Success Probability (%)</label>
                                <select class="form-control" id="leadProbability">
                                    <option value="">Select Probability</option>
                                    <option value="10">10% - Just inquiring</option>
                                    <option value="25">25% - Interested</option>
                                    <option value="50">50% - Serious consideration</option>
                                    <option value="75">75% - Very likely</option>
                                    <option value="90">90% - Almost confirmed</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Lead Management -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="leadSource">Lead Source *</label>
                            <select class="form-control" id="leadSource" required>
                                <option value="">Select Source</option>
                                <option value="Website">Website Inquiry</option>
                                <option value="Referral">Referral</option>
                                <option value="Cold Call">Cold Call</option>
                                <option value="Exhibition">Exhibition/Trade Show</option>
                                <option value="Social Media">Social Media</option>
                                <option value="Print Ad">Print Advertisement</option>
                                <option value="Direct Visit">Direct Visit</option>
                                <option value="Partner">Channel Partner</option>
                                <option value="Existing Customer">Existing Customer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leadPriority">Lead Priority *</label>
                            <select class="form-control" id="leadPriority" required>
                                <option value="">Select Priority</option>
                                <option value="Hot">Hot - Immediate opportunity</option>
                                <option value="Warm">Warm - Interested</option>
                                <option value="Cold">Cold - Future potential</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="leadStatus">Lead Status</label>
                            <select class="form-control" id="leadStatus" onchange="toggleHoldFields('lead')">
                                <option value="New">New</option>
                                <option value="Contacted">Contacted</option>
                                <option value="Qualified">Qualified</option>
                                <option value="Proposal">Proposal Sent</option>
                                <option value="Negotiation">Negotiation</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Converted">Converted</option>
                                <option value="Lost">Lost</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leadAssignedTo">Assign To *</label>
                            <select class="form-control" id="leadAssignedTo" required>
                                <option value="">Select Sales Rep</option>
                            </select>
                        </div>
                    </div>

                    <!-- Hold Information (initially hidden) -->
                    <div class="hold-fields" id="leadHoldFields" style="display: none;">
                        <div class="card" style="background: #fef3c7; border: 1px solid #f59e0b; margin-bottom: 20px; padding: 16px;">
                            <h4 style="margin: 0 0 16px 0; color: #d97706; font-size: 16px;">Hold Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="leadHoldReason">Hold Reason *</label>
                                    <select class="form-control" id="leadHoldReason">
                                        <option value="">Select Reason</option>
                                        <option value="Client Budget Constraints">Client Budget Constraints</option>
                                        <option value="Project Timeline Delayed">Project Timeline Delayed</option>
                                        <option value="Approval Pending">Approval Pending</option>
                                        <option value="Site Not Ready">Site Not Ready</option>
                                        <option value="Technical Clarifications">Technical Clarifications Required</option>
                                        <option value="Competition Analysis">Competition Analysis in Progress</option>
                                        <option value="Monsoon/Weather">Monsoon/Weather Related</option>
                                        <option value="Regulatory Approvals">Regulatory Approvals Pending</option>
                                        <option value="Client Request">Client Request</option>
                                        <option value="Internal Review">Internal Review</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="leadHoldDate">Hold Date *</label>
                                    <input type="date" class="form-control" id="leadHoldDate">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="leadExpectedResumeDate">Expected Resume Date</label>
                                    <input type="date" class="form-control" id="leadExpectedResumeDate">
                                </div>
                                <div class="form-group">
                                    <label for="leadHoldDuration">Estimated Hold Duration</label>
                                    <select class="form-control" id="leadHoldDuration">
                                        <option value="">Select Duration</option>
                                        <option value="1-2 weeks">1-2 weeks</option>
                                        <option value="1 month">1 month</option>
                                        <option value="2-3 months">2-3 months</option>
                                        <option value="3-6 months">3-6 months</option>
                                        <option value="6-12 months">6-12 months</option>
                                        <option value="Indefinite">Indefinite</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="leadHoldNotes">Hold Description *</label>
                                <textarea class="form-control" id="leadHoldNotes" rows="3" placeholder="Detailed explanation of why the lead is on hold and any specific conditions for resuming"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="leadNotes">Notes & Comments</label>
                        <textarea class="form-control" id="leadNotes" rows="3" placeholder="Any additional notes, conversation history, or important details"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('leadModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Lead</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lead Details Modal -->
    <div class="modal" id="leadDetailsModal">
        <div class="modal-dialog" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Lead Details & Activity</h3>
                <button class="modal-close" onclick="closeModal('leadDetailsModal')">&times;</button>
            </div>
            <div class="modal-body" id="leadDetailsContent">
                <!-- Content populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('leadDetailsModal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="addLeadActivity()">+ Add Activity</button>
            </div>
        </div>
    </div>

    <!-- Lead Activity Modal -->
    <div class="modal" id="leadActivityModal">
        <div class="modal-dialog" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="leadActivityModalTitle">Add Lead Activity</h3>
                <button class="modal-close" onclick="closeModal('leadActivityModal')">&times;</button>
            </div>
            <form id="leadActivityForm">
                <div class="modal-body">
                    <input type="hidden" id="currentLeadId">
                    
                    <!-- Activity Type -->
                    <div class="form-group">
                        <label for="activityType">Activity Type *</label>
                        <select class="form-control" id="activityType" required onchange="toggleActivityFields()">
                            <option value="">Select Activity Type</option>
                            <option value="call">Phone Call</option>
                            <option value="email">Email</option>
                            <option value="meeting">Meeting</option>
                            <option value="site_visit">Site Visit</option>
                            <option value="proposal">Proposal Sent</option>
                            <option value="quotation">Quotation Sent</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="follow_up">Follow Up</option>
                            <option value="demo">Product Demo</option>
                            <option value="requirement">Requirement Discussion</option>
                            <option value="contract">Contract Discussion</option>
                            <option value="converted">Lead Converted</option>
                            <option value="lost">Lead Lost</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <!-- Activity Details -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="activityDate">Activity Date & Time *</label>
                            <input type="datetime-local" class="form-control" id="activityDate" required>
                        </div>
                        <div class="form-group">
                            <label for="activityDuration">Duration (minutes)</label>
                            <input type="number" class="form-control" id="activityDuration" min="1" placeholder="e.g., 30">
                        </div>
                    </div>

                    <!-- Contact Person -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contactedPerson">Person Contacted *</label>
                            <input type="text" class="form-control" id="contactedPerson" required placeholder="Name of person you spoke with">
                        </div>
                        <div class="form-group">
                            <label for="contactDesignation">Their Designation</label>
                            <input type="text" class="form-control" id="contactDesignation" placeholder="e.g., Project Manager, Owner">
                        </div>
                    </div>

                    <!-- Activity Description -->
                    <div class="form-group">
                        <label for="activityDescription">Activity Description *</label>
                        <textarea class="form-control" id="activityDescription" rows="3" required placeholder="Describe what was discussed, outcomes, next steps, etc."></textarea>
                    </div>

                    <!-- Call Specific Fields -->
                    <div id="callFields" class="activity-specific-fields" style="display: none;">
                        <div class="card" style="background: #f0f9ff; border: 1px solid #0ea5e9; margin: 16px 0; padding: 16px;">
                            <h5 style="color: #0369a1; margin: 0 0 12px 0;">Call Details</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="callStatus">Call Status</label>
                                    <select class="form-control" id="callStatus">
                                        <option value="successful">Successful - Person Available</option>
                                        <option value="busy">Line Busy</option>
                                        <option value="no_answer">No Answer</option>
                                        <option value="voicemail">Voicemail Left</option>
                                        <option value="wrong_number">Wrong Number</option>
                                        <option value="callback_requested">Callback Requested</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="nextCallDate">Next Call Scheduled</label>
                                    <input type="datetime-local" class="form-control" id="nextCallDate">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Meeting Specific Fields -->
                    <div id="meetingFields" class="activity-specific-fields" style="display: none;">
                        <div class="card" style="background: #f0fdf4; border: 1px solid #22c55e; margin: 16px 0; padding: 16px;">
                            <h5 style="color: #166534; margin: 0 0 12px 0;">Meeting Details</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="meetingLocation">Meeting Location</label>
                                    <input type="text" class="form-control" id="meetingLocation" placeholder="Office address, online, site location, etc.">
                                </div>
                                <div class="form-group">
                                    <label for="attendees">Attendees</label>
                                    <input type="text" class="form-control" id="attendees" placeholder="Names of all attendees">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="nextMeeting">Next Meeting Scheduled</label>
                                <input type="datetime-local" class="form-control" id="nextMeeting">
                            </div>
                        </div>
                    </div>

                    <!-- Proposal/Quotation Fields -->
                    <div id="proposalFields" class="activity-specific-fields" style="display: none;">
                        <div class="card" style="background: #fef3c7; border: 1px solid #f59e0b; margin: 16px 0; padding: 16px;">
                            <h5 style="color: #92400e; margin: 0 0 12px 0;">Proposal/Quotation Details</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="proposalAmount">Quoted Amount (â‚¹)</label>
                                    <input type="number" class="form-control" id="proposalAmount" step="0.01" placeholder="Total quoted amount">
                                </div>
                                <div class="form-group">
                                    <label for="validityPeriod">Validity Period (days)</label>
                                    <input type="number" class="form-control" id="validityPeriod" min="1" placeholder="e.g., 30">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="proposalReference">Reference Number</label>
                                <input type="text" class="form-control" id="proposalReference" placeholder="Proposal/Quotation reference number">
                            </div>
                        </div>
                    </div>

                    <!-- Outcome & Follow-up -->
                    <div class="form-section">
                        <h5 style="color: #374151; margin: 16px 0 12px 0;">Outcome & Next Steps</h5>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="activityOutcome">Activity Outcome</label>
                                <select class="form-control" id="activityOutcome">
                                    <option value="">Select Outcome</option>
                                    <option value="positive">Positive Response</option>
                                    <option value="interested">Showed Interest</option>
                                    <option value="neutral">Neutral Response</option>
                                    <option value="negative">Not Interested</option>
                                    <option value="needs_info">Requested More Information</option>
                                    <option value="decision_pending">Decision Pending</option>
                                    <option value="budget_issue">Budget Constraints</option>
                                    <option value="competitor">Considering Competitors</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leadTemperature">Lead Temperature</label>
                                <select class="form-control" id="leadTemperature">
                                    <option value="">Current Temperature</option>
                                    <option value="hot">Hot - Ready to Buy</option>
                                    <option value="warm">Warm - Interested</option>
                                    <option value="cold">Cold - Future Potential</option>
                                    <option value="frozen">Frozen - Lost Interest</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="nextAction">Next Action Required</label>
                                <select class="form-control" id="nextAction">
                                    <option value="">Select Next Action</option>
                                    <option value="follow_up_call">Follow-up Call</option>
                                    <option value="send_info">Send Information</option>
                                    <option value="schedule_meeting">Schedule Meeting</option>
                                    <option value="site_visit">Site Visit</option>
                                    <option value="prepare_proposal">Prepare Proposal</option>
                                    <option value="price_revision">Revise Pricing</option>
                                    <option value="technical_clarification">Technical Clarification</option>
                                    <option value="contract_preparation">Prepare Contract</option>
                                    <option value="wait_customer">Wait for Customer</option>
                                    <option value="no_action">No Further Action</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="nextActionDate">Next Action Date</label>
                                <input type="datetime-local" class="form-control" id="nextActionDate">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="nextStepNotes">Next Steps / Reminders</label>
                            <textarea class="form-control" id="nextStepNotes" rows="2" placeholder="What needs to be done next? Any reminders or important points to remember..."></textarea>
                        </div>
                    </div>

                    <!-- Internal Notes -->
                    <div class="form-group">
                        <label for="internalNotes">Internal Notes</label>
                        <textarea class="form-control" id="internalNotes" rows="2" placeholder="Private notes for team use (not visible to customer)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('leadActivityModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Activity</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div class="modal" id="inventoryModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title" id="inventoryModalTitle">Add Inventory Item</h3>
                <button class="modal-close" onclick="closeModal('inventoryModal')">&times;</button>
            </div>
            <form id="inventoryForm">
                <div class="modal-body">
                    <input type="hidden" id="editItemId">
                    <input type="hidden" id="itemLocation">
                    <div class="form-group">
                        <label>Item Name *</label>
                        <input type="text" class="form-control" id="itemName" required>
                    </div>
                    <div class="form-group">
                        <label>Barcode/SKU</label>
                        <input type="text" class="form-control" id="itemBarcode" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select class="form-control" id="itemCategory" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Quantity *</label>
                            <input type="number" class="form-control" id="itemQuantity" required min="0">
                        </div>
                        <div class="form-group">
                            <label>Unit *</label>
                            <input type="text" class="form-control" id="itemUnit" required placeholder="e.g. pcs, kg, m">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" class="form-control" id="itemDescription" placeholder="Additional details">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('inventoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Use Inventory Modal -->
    <div class="modal" id="useModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Use Inventory</h3>
                <button class="modal-close" onclick="closeModal('useModal')">&times;</button>
            </div>
            <form id="useForm">
                <div class="modal-body">
                    <input type="hidden" id="useItemId">
                    <div class="form-group">
                        <label>Item: <strong id="useItemName"></strong></label>
                        <p class="info-text">Available: <span id="useAvailable"></span></p>
                    </div>
                    <div class="form-group">
                        <label>Quantity to Use *</label>
                        <input type="number" class="form-control" id="useQuantity" required min="1">
                    </div>
                    <div class="form-group">
                        <label>Assign to Project *</label>
                        <select class="form-control" id="useProject" required>
                            <option value="">Select Project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" class="form-control" id="useNotes" placeholder="Optional notes">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('useModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Use & Assign</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div class="modal" id="addStockModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Add Stock</h3>
                <button class="modal-close" onclick="closeModal('addStockModal')">&times;</button>
            </div>
            <form id="addStockForm">
                <div class="modal-body">
                    <input type="hidden" id="addStockItemId">
                    <div class="form-group">
                        <label>Item: <strong id="addStockItemName"></strong></label>
                        <p class="info-text">Current: <span id="addStockCurrent"></span></p>
                    </div>
                    <div class="form-group">
                        <label>Quantity to Add *</label>
                        <input type="number" class="form-control" id="addStockQuantity" required min="1">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" class="form-control" id="addStockNotes" placeholder="Optional notes">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addStockModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Stock</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title" id="projectModalTitle">Create New Project</h3>
                <button class="modal-close" onclick="closeModal('projectModal')">&times;</button>
            </div>
            <form id="projectForm">
                <div class="modal-body">
                    <input type="hidden" id="editProjectId">
                    <div class="form-group">
                        <label>Project Name *</label>
                        <input type="text" class="form-control" id="projectName" required>
                    </div>
                    <div class="form-group">
                        <label>Project Code *</label>
                        <input type="text" class="form-control" id="projectCode" required>
                    </div>
                    <div class="form-group">
                        <label>Client/Customer *</label>
                        <input type="text" class="form-control" id="projectClient" required placeholder="Enter client name">
                    </div>
                    <div class="form-group">
                        <label>Project Type *</label>
                        <select class="form-control" id="projectType" required>
                            <option value="">Select Type</option>
                            <option value="Installation">New Installation</option>
                            <option value="Modernization">Modernization</option>
                            <option value="Maintenance">Maintenance Contract</option>
                            <option value="Repair">Emergency Repair</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Building Address</label>
                        <textarea class="form-control" id="projectAddress" rows="2" placeholder="Enter complete building address"></textarea>
                    </div>
                    
                    <!-- Elevator Configuration -->
                    <div class="form-section">
                        <h4>Elevator Configuration</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Number of Elevators *</label>
                                <input type="number" class="form-control" id="projectElevatorCount" min="1" required onchange="generateElevatorFields()">
                            </div>
                            <div class="form-group">
                                <label>Elevator Type *</label>
                                <select class="form-control" id="projectElevatorType" required>
                                    <option value="">Select Type</option>
                                    <option value="Passenger">Passenger Elevator</option>
                                    <option value="Freight">Freight Elevator</option>
                                    <option value="Hospital">Hospital Elevator</option>
                                    <option value="Service">Service Elevator</option>
                                    <option value="Residential">Residential Elevator</option>
                                </select>
                            </div>
                        </div>
                        <div id="elevatorDetails" style="display: none;">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Capacity (Persons/Kg)</label>
                                    <input type="text" class="form-control" id="projectCapacity" placeholder="e.g., 8 persons / 630kg">
                                </div>
                                <div class="form-group">
                                    <label>Floors Served</label>
                                    <input type="text" class="form-control" id="projectFloors" placeholder="e.g., G+5 floors">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Machine Type</label>
                                    <select class="form-control" id="projectMachineType">
                                        <option value="">Select Machine Type</option>
                                        <option value="Geared">Geared Traction</option>
                                        <option value="Gearless">Gearless Traction</option>
                                        <option value="Hydraulic">Hydraulic</option>
                                        <option value="MRL">Machine Room Less (MRL)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Speed (m/s)</label>
                                    <input type="number" class="form-control" id="projectSpeed" step="0.1" placeholder="e.g., 1.0">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" class="form-control" id="projectStartDate">
                        </div>
                        <div class="form-group">
                            <label>Expected Completion</label>
                            <input type="date" class="form-control" id="projectEndDate">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Status *</label>
                            <select class="form-control" id="projectStatus" required onchange="toggleHoldFields('project')">
                                <option value="Active">Active</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Progress %</label>
                            <input type="number" class="form-control" id="projectProgress" min="0" max="100" value="0">
                        </div>
                    </div>

                    <!-- Hold Information for Projects (initially hidden) -->
                    <div class="hold-fields" id="projectHoldFields" style="display: none;">
                        <div class="card" style="background: #fef3c7; border: 1px solid #f59e0b; margin-bottom: 20px; padding: 16px;">
                            <h4 style="margin: 0 0 16px 0; color: #d97706; font-size: 16px;">Hold Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="projectHoldReason">Hold Reason *</label>
                                    <select class="form-control" id="projectHoldReason">
                                        <option value="">Select Reason</option>
                                        <option value="Client Budget Issues">Client Budget Issues</option>
                                        <option value="Site Not Ready">Site Not Ready</option>
                                        <option value="Material Shortage">Material Shortage</option>
                                        <option value="Design Changes">Design Changes Required</option>
                                        <option value="Permit Delays">Permit/Approval Delays</option>
                                        <option value="Weather Conditions">Weather Conditions</option>
                                        <option value="Client Request">Client Request</option>
                                        <option value="Safety Concerns">Safety Concerns</option>
                                        <option value="Technical Issues">Technical Issues</option>
                                        <option value="Resource Unavailability">Resource Unavailability</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="projectHoldDate">Hold Date *</label>
                                    <input type="date" class="form-control" id="projectHoldDate">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="projectExpectedResumeDate">Expected Resume Date</label>
                                    <input type="date" class="form-control" id="projectExpectedResumeDate">
                                </div>
                                <div class="form-group">
                                    <label for="projectHoldDuration">Estimated Hold Duration</label>
                                    <select class="form-control" id="projectHoldDuration">
                                        <option value="">Select Duration</option>
                                        <option value="1-2 weeks">1-2 weeks</option>
                                        <option value="1 month">1 month</option>
                                        <option value="2-3 months">2-3 months</option>
                                        <option value="3-6 months">3-6 months</option>
                                        <option value="6-12 months">6-12 months</option>
                                        <option value="Indefinite">Indefinite</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="projectHoldNotes">Hold Description *</label>
                                <textarea class="form-control" id="projectHoldNotes" rows="3" placeholder="Detailed explanation of why the project is on hold and conditions for resuming"></textarea>
                            </div>
                        </div>
                    </div>

                    <div id="projectItemsSection" style="display: none;">
                        <div class="form-group">
                            <label>Allocated Items</label>
                            <div id="projectItemsList" class="project-items"></div>
                        </div>
                        <div class="form-group">
                            <label>Return Remaining Stock</label>
                            <div id="returnItemsList"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                    <button type="submit" class="btn btn-success" id="projectSubmitBtn">Create Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Modal -->
    <div class="modal" id="userModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title" id="userModalTitle">Add User</h3>
                <button class="modal-close" onclick="closeModal('userModal')">&times;</button>
            </div>
            <form id="userForm">
                <div class="modal-body">
                    <input type="hidden" id="editUserId">
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" class="form-control" id="newUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Full Name *</label>
                        <input type="text" class="form-control" id="newFullName" required>
                    </div>
                    <div class="form-group">
                        <label>Password *</label>
                        <input type="password" class="form-control" id="newPassword" required minlength="6">
                        <p class="info-text">Minimum 6 characters</p>
                    </div>
                    <div class="form-group">
                        <label>Role *</label>
                        <select class="form-control" id="newUserRole" required>
                            <option value="">Select Role</option>
                            <option value="admin">Admin</option>
                            <option value="technician">Technician</option>
                            <option value="reception">Reception</option>
                            <option value="sales">Sales Representative</option>
                            <option value="user">General User</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status *</label>
                        <select class="form-control" id="newUserStatus" required>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('userModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save User</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div class="modal" id="barcodeModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Barcode Scanner</h3>
                <button class="modal-close" onclick="closeBarcodeScanner()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="camera-permission-info" id="cameraPermissionInfo" style="display: none;">
                    â„¹ï¸ Camera access is required to scan barcodes. Please allow camera permission when prompted.
                </div>
                <div class="barcode-reader">
                    <video id="barcodeVideo" autoplay playsinline></video>
                    <div id="scanStatus" class="scan-status">Initializing scanner...</div>
                    <div id="barcodeResult" class="barcode-result" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeBarcodeScanner()">Close</button>
            </div>
        </div>
    </div>

    <!-- Maintenance Modal -->
    <div class="modal" id="maintenanceModal">
        <div class="modal-dialog" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="maintenanceModalTitle">Schedule Maintenance</h3>
                <button class="modal-close" onclick="closeModal('maintenanceModal')">&times;</button>
            </div>
            <form id="maintenanceForm">
                <div class="modal-body">
                    <input type="hidden" id="editMaintenanceId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maintenanceProject">Project *</label>
                            <select class="form-control" id="maintenanceProject" required onchange="loadElevators()">
                                <option value="">Select Project</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maintenanceElevator">Select Elevators * <small style="color: var(--text-secondary);">(Hold Ctrl/Cmd to select multiple)</small></label>
                            <select class="form-control" id="maintenanceElevator" multiple required style="min-height: 100px;">
                                <option value="">Loading elevators...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenanceIssue">Issue Description *</label>
                        <textarea class="form-control" id="maintenanceIssue" rows="3" required placeholder="Describe the issue or maintenance task"></textarea>
                    </div>

                    <!-- Complaint Person Details -->
                    <div class="card" style="background: #f8fafc; border: 1px solid #e2e8f0; margin: 16px 0; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #1e40af; font-size: 16px;">Complaint Person Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="complaintPersonName">Person Name *</label>
                                <input type="text" class="form-control" id="complaintPersonName" required placeholder="Name of person who reported the issue">
                            </div>
                            <div class="form-group">
                                <label for="complaintPersonPhone">Phone Number *</label>
                                <input type="tel" class="form-control" id="complaintPersonPhone" required placeholder="Contact number">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="complaintPersonEmail">Email</label>
                                <input type="email" class="form-control" id="complaintPersonEmail" placeholder="Email address (optional)">
                            </div>
                            <div class="form-group">
                                <label for="complaintPersonDesignation">Designation</label>
                                <input type="text" class="form-control" id="complaintPersonDesignation" placeholder="e.g. Building Manager, Resident, etc.">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="complaintPersonAddress">Building Address *</label>
                            <textarea class="form-control" id="complaintPersonAddress" rows="2" required placeholder="Complete building address"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="complaintDate">Complaint Date *</label>
                            <input type="datetime-local" class="form-control" id="complaintDate" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maintenancePriority">Priority *</label>
                            <select class="form-control" id="maintenancePriority" required>
                                <option value="">Select Priority</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maintenanceAssignee">Assign To *</label>
                            <select class="form-control" id="maintenanceAssignee" required>
                                <option value="">Select Technician</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maintenanceDueDate">Due Date *</label>
                            <input type="date" class="form-control" id="maintenanceDueDate" required>
                        </div>
                        <div class="form-group">
                            <label for="maintenanceStatus">Status</label>
                            <select class="form-control" id="maintenanceStatus" onchange="toggleSignatureSection(); toggleHoldFields('maintenance')">
                                <option value="Scheduled">Scheduled</option>
                                <option value="In Progress">In Progress</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Hold Information for Maintenance (initially hidden) -->
                    <div class="hold-fields" id="maintenanceHoldFields" style="display: none;">
                        <div class="card" style="background: #fef3c7; border: 1px solid #f59e0b; margin-bottom: 20px; padding: 16px;">
                            <h4 style="margin: 0 0 16px 0; color: #d97706; font-size: 16px;">Hold Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="maintenanceHoldReason">Hold Reason *</label>
                                    <select class="form-control" id="maintenanceHoldReason">
                                        <option value="">Select Reason</option>
                                        <option value="Client Unavailable">Client Unavailable</option>
                                        <option value="Site Access Issues">Site Access Issues</option>
                                        <option value="Parts Not Available">Parts Not Available</option>
                                        <option value="Safety Concerns">Safety Concerns</option>
                                        <option value="Elevator in Use">Elevator in Use - Cannot Stop</option>
                                        <option value="Weather Conditions">Weather Conditions</option>
                                        <option value="Client Request">Client Request</option>
                                        <option value="Technician Unavailable">Technician Unavailable</option>
                                        <option value="Regulatory Issues">Regulatory/Permit Issues</option>
                                        <option value="Equipment Issues">Equipment/Tools Issues</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="maintenanceHoldDate">Hold Date *</label>
                                    <input type="date" class="form-control" id="maintenanceHoldDate">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="maintenanceExpectedResumeDate">Expected Resume Date</label>
                                    <input type="date" class="form-control" id="maintenanceExpectedResumeDate">
                                </div>
                                <div class="form-group">
                                    <label for="maintenanceHoldDuration">Estimated Hold Duration</label>
                                    <select class="form-control" id="maintenanceHoldDuration">
                                        <option value="">Select Duration</option>
                                        <option value="1-3 days">1-3 days</option>
                                        <option value="1 week">1 week</option>
                                        <option value="2 weeks">2 weeks</option>
                                        <option value="1 month">1 month</option>
                                        <option value="2-3 months">2-3 months</option>
                                        <option value="Indefinite">Indefinite</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="maintenanceHoldNotes">Hold Description *</label>
                                <textarea class="form-control" id="maintenanceHoldNotes" rows="3" placeholder="Detailed explanation of why the maintenance is on hold and conditions for resuming"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Technician Arrival Signature (when status is In Progress) -->
                    <div id="arrivalSignatureSection" class="card" style="background: #fef3c7; border: 1px solid #fbbf24; margin: 16px 0; padding: 16px; display: none;">
                        <h4 style="margin: 0 0 16px 0; color: #92400e; font-size: 16px;">Technician Arrival Confirmation</h4>
                        <div class="form-group">
                            <label>Building Representative Signature (Arrival) *</label>
                            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; margin-top: 8px;">
                                <canvas id="arrivalSignatureCanvas" width="400" height="200" style="display: block; cursor: crosshair;"></canvas>
                            </div>
                            <div style="margin-top: 8px; display: flex; gap: 8px;">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignature('arrival')">Clear</button>
                                <span style="font-size: 12px; color: #64748b; line-height: 32px;">Sign above to confirm technician arrival</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="arrivalTime">Arrival Time</label>
                            <input type="datetime-local" class="form-control" id="arrivalTime">
                        </div>
                    </div>

                    <!-- Work Completion Signature (when status is Completed) -->
                    <div id="completionSignatureSection" class="card" style="background: #dcfce7; border: 1px solid #16a34a; margin: 16px 0; padding: 16px; display: none;">
                        <h4 style="margin: 0 0 16px 0; color: #166534; font-size: 16px;">Work Completion Confirmation</h4>
                        <div class="form-group">
                            <label for="workDescription">Work Performed *</label>
                            <textarea class="form-control" id="workDescription" rows="3" placeholder="Describe the maintenance/repair work completed"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="partsUsed">Parts/Materials Used</label>
                                <textarea class="form-control" id="partsUsed" rows="2" placeholder="List any parts or materials used"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="workCost">Work Cost (â‚¹)</label>
                                <input type="number" class="form-control" id="workCost" step="0.01" placeholder="Total cost including parts and labor">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Building Representative Signature (Completion) *</label>
                            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; margin-top: 8px;">
                                <canvas id="completionSignatureCanvas" width="400" height="200" style="display: block; cursor: crosshair;"></canvas>
                            </div>
                            <div style="margin-top: 8px; display: flex; gap: 8px;">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignature('completion')">Clear</button>
                                <span style="font-size: 12px; color: #64748b; line-height: 32px;">Sign above to confirm work completion</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="completionTime">Completion Time</label>
                                <input type="datetime-local" class="form-control" id="completionTime">
                            </div>
                            <div class="form-group">
                                <label for="signatoryName">Signatory Name</label>
                                <input type="text" class="form-control" id="signatoryName" placeholder="Name of person signing">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenanceNotes">Additional Notes</label>
                        <textarea class="form-control" id="maintenanceNotes" rows="2" placeholder="Any additional notes or instructions"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('maintenanceModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="exportMaintenanceReport()" id="exportBtn" style="display: none;">ðŸ“¥ Export PDF</button>
                    <button type="submit" class="btn btn-success">Schedule Maintenance</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invoice/Quotation Modal -->
    <div class="modal" id="invoiceModal">
        <div class="modal-dialog" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="invoiceModalTitle">Create Invoice</h3>
                <button class="modal-close" onclick="closeModal('invoiceModal')">&times;</button>
            </div>
            <form id="invoiceForm">
                <div class="modal-body">
                    <input type="hidden" id="editInvoiceId">
                    <input type="hidden" id="invoiceType" value="invoice">

                    <!-- Client Information -->
                    <div class="form-section">
                        <h4>Client Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clientName">Client Name *</label>
                                <input type="text" class="form-control" id="clientName" required>
                            </div>
                            <div class="form-group">
                                <label for="clientEmail">Email</label>
                                <input type="email" class="form-control" id="clientEmail">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clientPhone">Phone</label>
                                <input type="text" class="form-control" id="clientPhone">
                            </div>
                            <div class="form-group">
                                <label for="clientGST">GST Number</label>
                                <input type="text" class="form-control" id="clientGST">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="clientAddress">Address</label>
                            <textarea class="form-control" id="clientAddress" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- Invoice Details -->
                    <div class="form-section">
                        <h4>Invoice Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="invoiceNumber">Invoice Number *</label>
                                <input type="text" class="form-control" id="invoiceNumber" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceDate">Invoice Date *</label>
                                <input type="date" class="form-control" id="invoiceDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dueDate">Due Date</label>
                                <input type="date" class="form-control" id="dueDate">
                            </div>
                            <div class="form-group">
                                <label for="poNumber">PO Number</label>
                                <input type="text" class="form-control" id="poNumber">
                            </div>
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h4>Items</h4>
                            <button type="button" class="btn btn-success btn-sm" onclick="addInvoiceItem()">+ Add Item</button>
                        </div>
                        <div class="invoice-items-container">
                            <div class="invoice-item-header">
                                <div>Description</div>
                                <div>Qty</div>
                                <div>Unit</div>
                                <div>Rate (â‚¹)</div>
                                <div>Amount (â‚¹)</div>
                                <div>Action</div>
                            </div>
                            <div id="invoiceItemsList">
                                <!-- Invoice items will be added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Totals -->
                    <div class="form-section">
                        <div class="invoice-totals">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Subtotal</label>
                                    <div class="total-display" id="subtotalDisplay">â‚¹0.00</div>
                                </div>
                                <div class="form-group">
                                    <label for="discountPercent">Discount (%)</label>
                                    <input type="number" class="form-control" id="discountPercent" min="0" max="100" step="0.01" value="0" onchange="calculateInvoiceTotal()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="gstPercent">GST (%)</label>
                                    <input type="number" class="form-control" id="gstPercent" min="0" max="100" step="0.01" value="18" onchange="calculateInvoiceTotal()">
                                </div>
                                <div class="form-group">
                                    <label>Total Amount</label>
                                    <div class="total-display total-amount" id="totalAmountDisplay">â‚¹0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advance Payment Section -->
                    <div class="form-section">
                        <h4 style="color: #059669; margin-bottom: 16px;">Advance Payment Management</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="paymentTerms">Payment Terms</label>
                                <select class="form-control" id="paymentTerms" onchange="toggleAdvanceSection()">
                                    <option value="full">Full Payment</option>
                                    <option value="advance">Advance + Balance</option>
                                    <option value="installments">Multiple Installments</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="invoiceStatus">Invoice Status</label>
                                <select class="form-control" id="invoiceStatus">
                                    <option value="draft">Draft</option>
                                    <option value="sent">Sent</option>
                                    <option value="partial">Partially Paid</option>
                                    <option value="paid">Fully Paid</option>
                                    <option value="overdue">Overdue</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>

                        <!-- Advance Payment Details (initially hidden) -->
                        <div id="advancePaymentSection" style="display: none;">
                            <div class="card" style="background: #f0fdfa; border: 1px solid #14b8a6; margin: 16px 0; padding: 16px;">
                                <h5 style="color: #0f766e; margin: 0 0 12px 0;">Advance Payment Details</h5>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="advanceAmount">Advance Amount (â‚¹) *</label>
                                        <input type="number" class="form-control" id="advanceAmount" min="0" step="0.01" onchange="calculateAdvancePercentage()">
                                    </div>
                                    <div class="form-group">
                                        <label for="advancePercentage">Advance Percentage (%) *</label>
                                        <input type="number" class="form-control" id="advancePercentage" min="0" max="100" step="0.01" onchange="calculateAdvanceAmount()">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="advanceDate">Advance Payment Date</label>
                                        <input type="date" class="form-control" id="advanceDate">
                                    </div>
                                    <div class="form-group">
                                        <label for="advanceMethod">Payment Method</label>
                                        <select class="form-control" id="advanceMethod">
                                            <option value="">Select Method</option>
                                            <option value="cash">Cash</option>
                                            <option value="cheque">Cheque</option>
                                            <option value="bank_transfer">Bank Transfer</option>
                                            <option value="upi">UPI</option>
                                            <option value="card">Credit/Debit Card</option>
                                            <option value="online">Online Payment</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="advanceReference">Transaction Reference</label>
                                        <input type="text" class="form-control" id="advanceReference" placeholder="Cheque number, transaction ID, etc.">
                                    </div>
                                    <div class="form-group">
                                        <label for="balanceDueDate">Balance Due Date</label>
                                        <input type="date" class="form-control" id="balanceDueDate">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="advanceNotes">Advance Payment Notes</label>
                                    <textarea class="form-control" id="advanceNotes" rows="2" placeholder="Any additional notes about the advance payment"></textarea>
                                </div>

                                <!-- Payment Summary -->
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #a7f3d0; margin-top: 12px;">
                                    <h6 style="color: #065f46; margin: 0 0 8px 0;">Payment Breakdown:</h6>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                        <div><strong>Total Amount:</strong> <span id="paymentTotalAmount">â‚¹0.00</span></div>
                                        <div><strong>Advance Amount:</strong> <span id="paymentAdvanceAmount">â‚¹0.00</span></div>
                                        <div><strong>Balance Amount:</strong> <span id="paymentBalanceAmount">â‚¹0.00</span></div>
                                        <div><strong>Balance Percentage:</strong> <span id="paymentBalancePercent">0%</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Multiple Installments Section (initially hidden) -->
                        <div id="installmentsSection" style="display: none;">
                            <div class="card" style="background: #fff7ed; border: 1px solid #fb923c; margin: 16px 0; padding: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h5 style="color: #ea580c; margin: 0;">Multiple Installments</h5>
                                    <button type="button" class="btn btn-success btn-sm" onclick="addInstallment()">+ Add Installment</button>
                                </div>
                                
                                <div id="installmentsList">
                                    <!-- Installments will be added here -->
                                </div>
                                
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #fed7aa; margin-top: 12px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 13px;">
                                        <div><strong>Total Amount:</strong> <span id="installmentTotalAmount">â‚¹0.00</span></div>
                                        <div><strong>Planned Amount:</strong> <span id="installmentPlannedAmount">â‚¹0.00</span></div>
                                        <div><strong>Remaining:</strong> <span id="installmentRemainingAmount">â‚¹0.00</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-section">
                        <div class="form-group">
                            <label for="invoiceNotes">Notes</label>
                            <textarea class="form-control" id="invoiceNotes" rows="3" placeholder="Payment terms, additional information..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('invoiceModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Company Settings Modal -->
    <div class="modal" id="companyModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Company Settings</h3>
                <button class="modal-close" onclick="closeModal('companyModal')">&times;</button>
            </div>
            <form id="companyForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="companyName">Company Name *</label>
                        <input type="text" class="form-control" id="companyName" value="Avant Elevators" required>
                    </div>
                    <div class="form-group">
                        <label for="companyAddress">Address</label>
                        <textarea class="form-control" id="companyAddress" rows="3" placeholder="Company address"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyPhone">Phone</label>
                            <input type="text" class="form-control" id="companyPhone">
                        </div>
                        <div class="form-group">
                            <label for="companyEmail">Email</label>
                            <input type="email" class="form-control" id="companyEmail">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyGST">GST Number</label>
                            <input type="text" class="form-control" id="companyGST">
                        </div>
                        <div class="form-group">
                            <label for="companyCIN">CIN Number</label>
                            <input type="text" class="form-control" id="companyCIN">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="companyBankDetails">Bank Details</label>
                        <textarea class="form-control" id="companyBankDetails" rows="3" placeholder="Bank name, account number, IFSC code, etc."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('companyModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Settings</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, query, orderBy, limit, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyC2jWIdCA6VQMrZB8yanb3HQFzN9e6KXY0",
            authDomain: "dazzlojewellers.firebaseapp.com",
            projectId: "dazzlojewellers",
            storageBucket: "dazzlojewellers.firebasestorage.app",
            messagingSenderId: "334783357818",
            appId: "1:334783357818:web:3009541b14699606fd2cc3",
            measurementId: "G-288DC3S9LM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Enable offline persistence
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.log('Persistence failed: Multiple tabs open');
            } else if (err.code == 'unimplemented') {
                console.log('Persistence not available');
            }
        });

        const ADMIN_USERNAME = "Testing";
        const ADMIN_PASSWORD = "Testing";
        const SESSION_KEY = "ambivare_session";

        const CATEGORIES = {
            warehouse: ["Motors", "Controllers", "Cables", "Rails", "Car Equipment", "Safety Components", "Door Systems", "Fixtures", "Tools", "Hardware", "Other"],
            office: ["Stationery", "Paper", "Folders", "Pens", "Markers", "Toner", "Printer Supplies", "Furniture", "Electronics", "Other"],
            "service-van": ["Emergency Parts", "Tools", "Testing Equipment", "Safety Gear", "Sensors", "Controllers", "Cables", "Car Parts", "Door Parts", "Other"]
        };

        let currentUser = null;
        let inventory = { warehouse: [], office: [], "service-van": [] };
        let projects = [];
        let maintenance = [];
        let leads = [];
        let activities = [];
        let users = [];
        let invoices = [];
        let companySettings = {
            name: 'Avant Elevators',
            logo: 'ambivare.png',
            address: '',
            phone: '',
            email: 'avantelevator@gmail.com',
            gst: '',
            cin: '',
            bankDetails: ''
        };

        // Multi-language Translation System
        const translations = {
            en: {
                // Header & Navigation
                company_name: 'Avant Elevators',
                portal_subtitle: 'Elevator Management Portal',
                system_title: 'Elevator Management System',
                dashboard: 'Dashboard',
                warehouse: 'Warehouse',
                service_van: 'Service Van',
                office: 'Office',
                projects: 'Projects',
                maintenance: 'Maintenance',
                sales: 'Sales',
                activities: 'Activities',
                billing: 'Billing',
                users: 'Users',
                logout: 'Logout',
                
                // Login
                username: 'Username',
                password: 'Password',
                sign_in: 'Sign In',
                enter_username: 'Enter your username',
                enter_password: 'Enter password',
                
                // Common
                add: 'Add',
                edit: 'Edit',
                delete: 'Delete',
                save: 'Save',
                cancel: 'Cancel',
                close: 'Close',
                search: 'Search',
                filter: 'Filter',
                export: 'Export',
                create: 'Create',
                update: 'Update',
                
                // Dashboard
                total_items: 'Total Items',
                warehouse_items: 'Warehouse Items',
                service_van_items: 'Service Van Items',
                office_items: 'Office Items',
                active_projects: 'Active Projects',
                maintenance_due: 'Maintenance Due',
                
                // Forms
                name: 'Name',
                email: 'Email',
                phone: 'Phone',
                address: 'Address',
                status: 'Status',
                priority: 'Priority',
                date: 'Date',
                description: 'Description',
                notes: 'Notes'
            },
            
            hi: {
                // Header & Navigation
                company_name: 'à¤…à¤µà¤‚à¤¤ à¤à¤²à¤¿à¤µà¥‡à¤Ÿà¤°à¥à¤¸',
                portal_subtitle: 'à¤à¤²à¤¿à¤µà¥‡à¤Ÿà¤° à¤ªà¥à¤°à¤¬à¤‚à¤§à¤¨ à¤ªà¥‹à¤°à¥à¤Ÿà¤²',
                system_title: 'à¤à¤²à¤¿à¤µà¥‡à¤Ÿà¤° à¤ªà¥à¤°à¤¬à¤‚à¤§à¤¨ à¤ªà¥à¤°à¤£à¤¾à¤²à¥€',
                dashboard: 'à¤¡à¥ˆà¤¶à¤¬à¥‹à¤°à¥à¤¡',
                warehouse: 'à¤—à¥‹à¤¦à¤¾à¤®',
                service_van: 'à¤¸à¤°à¥à¤µà¤¿à¤¸ à¤µà¥ˆà¤¨',
                office: 'à¤•à¤¾à¤°à¥à¤¯à¤¾à¤²à¤¯',
                projects: 'à¤ªà¤°à¤¿à¤¯à¥‹à¤œà¤¨à¤¾à¤à¤‚',
                maintenance: 'à¤°à¤–à¤°à¤–à¤¾à¤µ',
                sales: 'à¤¬à¤¿à¤•à¥à¤°à¥€',
                activities: 'à¤—à¤¤à¤¿à¤µà¤¿à¤§à¤¿à¤¯à¤¾à¤‚',
                billing: 'à¤¬à¤¿à¤²à¤¿à¤‚à¤—',
                users: 'à¤‰à¤ªà¤¯à¥‹à¤—à¤•à¤°à¥à¤¤à¤¾',
                logout: 'à¤²à¥‰à¤—à¤†à¤‰à¤Ÿ',
                
                // Login
                username: 'à¤‰à¤ªà¤¯à¥‹à¤—à¤•à¤°à¥à¤¤à¤¾ à¤¨à¤¾à¤®',
                password: 'à¤ªà¤¾à¤¸à¤µà¤°à¥à¤¡',
                sign_in: 'à¤¸à¤¾à¤‡à¤¨ à¤‡à¤¨',
                enter_username: 'à¤…à¤ªà¤¨à¤¾ à¤‰à¤ªà¤¯à¥‹à¤—à¤•à¤°à¥à¤¤à¤¾ à¤¨à¤¾à¤® à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚',
                enter_password: 'à¤ªà¤¾à¤¸à¤µà¤°à¥à¤¡ à¤¦à¤°à¥à¤œ à¤•à¤°à¥‡à¤‚',
                
                // Common
                add: 'à¤œà¥‹à¤¡à¤¼à¥‡à¤‚',
                edit: 'à¤¸à¤‚à¤ªà¤¾à¤¦à¤¿à¤¤ à¤•à¤°à¥‡à¤‚',
                delete: 'à¤¹à¤Ÿà¤¾à¤à¤‚',
                save: 'à¤¸à¤¹à¥‡à¤œà¥‡à¤‚',
                cancel: 'à¤°à¤¦à¥à¤¦ à¤•à¤°à¥‡à¤‚',
                close: 'à¤¬à¤‚à¤¦ à¤•à¤°à¥‡à¤‚',
                search: 'à¤–à¥‹à¤œà¥‡à¤‚',
                filter: 'à¤«à¤¼à¤¿à¤²à¥à¤Ÿà¤°',
                export: 'à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤',
                create: 'à¤¬à¤¨à¤¾à¤à¤‚',
                update: 'à¤…à¤ªà¤¡à¥‡à¤Ÿ',
                
                // Dashboard
                total_items: 'à¤•à¥à¤² à¤†à¤‡à¤Ÿà¤®',
                warehouse_items: 'à¤—à¥‹à¤¦à¤¾à¤® à¤†à¤‡à¤Ÿà¤®',
                service_van_items: 'à¤¸à¤°à¥à¤µà¤¿à¤¸ à¤µà¥ˆà¤¨ à¤†à¤‡à¤Ÿà¤®',
                office_items: 'à¤•à¤¾à¤°à¥à¤¯à¤¾à¤²à¤¯ à¤†à¤‡à¤Ÿà¤®',
                active_projects: 'à¤¸à¤•à¥à¤°à¤¿à¤¯ à¤ªà¤°à¤¿à¤¯à¥‹à¤œà¤¨à¤¾à¤à¤‚',
                maintenance_due: 'à¤°à¤–à¤°à¤–à¤¾à¤µ à¤¬à¤•à¤¾à¤¯à¤¾',
                
                // Forms
                name: 'à¤¨à¤¾à¤®',
                email: 'à¤ˆà¤®à¥‡à¤²',
                phone: 'à¤«à¥‹à¤¨',
                address: 'à¤ªà¤¤à¤¾',
                status: 'à¤¸à¥à¤¥à¤¿à¤¤à¤¿',
                priority: 'à¤ªà¥à¤°à¤¾à¤¥à¤®à¤¿à¤•à¤¤à¤¾',
                date: 'à¤¤à¤¾à¤°à¥€à¤–',
                description: 'à¤µà¤¿à¤µà¤°à¤£',
                notes: 'à¤¨à¥‹à¤Ÿà¥à¤¸'
            },
            
            mr: {
                // Header & Navigation
                company_name: 'à¤…à¤µà¤‚à¤¤ à¤à¤²à¤¿à¤µà¥à¤¹à¥‡à¤Ÿà¤°à¥à¤¸',
                portal_subtitle: 'à¤à¤²à¤¿à¤µà¥à¤¹à¥‡à¤Ÿà¤° à¤µà¥à¤¯à¤µà¤¸à¥à¤¥à¤¾à¤ªà¤¨ à¤ªà¥‹à¤°à¥à¤Ÿà¤²',
                system_title: 'à¤à¤²à¤¿à¤µà¥à¤¹à¥‡à¤Ÿà¤° à¤µà¥à¤¯à¤µà¤¸à¥à¤¥à¤¾à¤ªà¤¨ à¤ªà¥à¤°à¤£à¤¾à¤²à¥€',
                dashboard: 'à¤¡à¥…à¤¶à¤¬à¥‹à¤°à¥à¤¡',
                warehouse: 'à¤—à¥‹à¤¦à¤¾à¤®',
                service_van: 'à¤¸à¤°à¥à¤µà¥à¤¹à¤¿à¤¸ à¤µà¥à¤¹à¥…à¤¨',
                office: 'à¤•à¤¾à¤°à¥à¤¯à¤¾à¤²à¤¯',
                projects: 'à¤ªà¥à¤°à¤•à¤²à¥à¤ª',
                maintenance: 'à¤¦à¥‡à¤–à¤­à¤¾à¤²',
                sales: 'à¤µà¤¿à¤•à¥à¤°à¥€',
                activities: 'à¤•à¥à¤°à¤¿à¤¯à¤¾à¤•à¤²à¤¾à¤ª',
                billing: 'à¤¬à¤¿à¤²à¤¿à¤‚à¤—',
                users: 'à¤µà¤¾à¤ªà¤°à¤•à¤°à¥à¤¤à¥‡',
                logout: 'à¤²à¥‰à¤—à¤†à¤‰à¤Ÿ',
                
                // Login
                username: 'à¤µà¤¾à¤ªà¤°à¤•à¤°à¥à¤¤à¥à¤¯à¤¾à¤šà¥‡ à¤¨à¤¾à¤µ',
                password: 'à¤ªà¤¾à¤¸à¤µà¤°à¥à¤¡',
                sign_in: 'à¤¸à¤¾à¤‡à¤¨ à¤‡à¤¨',
                enter_username: 'à¤¤à¥à¤®à¤šà¥‡ à¤µà¤¾à¤ªà¤°à¤•à¤°à¥à¤¤à¤¾ à¤¨à¤¾à¤µ à¤Ÿà¤¾à¤•à¤¾',
                enter_password: 'à¤ªà¤¾à¤¸à¤µà¤°à¥à¤¡ à¤Ÿà¤¾à¤•à¤¾',
                
                // Common
                add: 'à¤œà¥‹à¤¡à¤¾',
                edit: 'à¤¸à¤‚à¤ªà¤¾à¤¦à¤¿à¤¤ à¤•à¤°à¤¾',
                delete: 'à¤¹à¤Ÿà¤µà¤¾',
                save: 'à¤œà¤¤à¤¨ à¤•à¤°à¤¾',
                cancel: 'à¤°à¤¦à¥à¤¦ à¤•à¤°à¤¾',
                close: 'à¤¬à¤‚à¤¦ à¤•à¤°à¤¾',
                search: 'à¤¶à¥‹à¤§à¤¾',
                filter: 'à¤«à¤¿à¤²à¥à¤Ÿà¤°',
                export: 'à¤¨à¤¿à¤°à¥à¤¯à¤¾à¤¤',
                create: 'à¤¤à¤¯à¤¾à¤° à¤•à¤°à¤¾',
                update: 'à¤…à¤ªà¤¡à¥‡à¤Ÿ',
                
                // Dashboard
                total_items: 'à¤à¤•à¥‚à¤£ à¤µà¤¸à¥à¤¤à¥‚',
                warehouse_items: 'à¤—à¥‹à¤¦à¤¾à¤® à¤µà¤¸à¥à¤¤à¥‚',
                service_van_items: 'à¤¸à¤°à¥à¤µà¥à¤¹à¤¿à¤¸ à¤µà¥à¤¹à¥…à¤¨ à¤µà¤¸à¥à¤¤à¥‚',
                office_items: 'à¤•à¤¾à¤°à¥à¤¯à¤¾à¤²à¤¯ à¤µà¤¸à¥à¤¤à¥‚',
                active_projects: 'à¤¸à¤•à¥à¤°à¤¿à¤¯ à¤ªà¥à¤°à¤•à¤²à¥à¤ª',
                maintenance_due: 'à¤¦à¥‡à¤–à¤­à¤¾à¤² à¤¬à¤¾à¤•à¥€',
                
                // Forms
                name: 'à¤¨à¤¾à¤µ',
                email: 'à¤ˆà¤®à¥‡à¤²',
                phone: 'à¤«à¥‹à¤¨',
                address: 'à¤ªà¤¤à¥à¤¤à¤¾',
                status: 'à¤¸à¥à¤¥à¤¿à¤¤à¥€',
                priority: 'à¤ªà¥à¤°à¤¾à¤§à¤¾à¤¨à¥à¤¯',
                date: 'à¤¤à¤¾à¤°à¥€à¤–',
                description: 'à¤µà¤°à¥à¤£à¤¨',
                notes: 'à¤¨à¥‹à¤Ÿà¥à¤¸'
            }
        };

        // Current language (default: English)
        let currentLanguage = localStorage.getItem('selectedLanguage') || 'en';

        // Language change function
        window.changeLanguage = () => {
            const selector = document.getElementById('languageSelector');
            currentLanguage = selector.value;
            localStorage.setItem('selectedLanguage', currentLanguage);
            applyTranslations();
        };

        // Apply translations to the page
        function applyTranslations() {
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });

            // Handle placeholders
            const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
            placeholderElements.forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.placeholder = translations[currentLanguage][key];
                }
            });
        }

        // Initialize language on page load
        window.addEventListener('load', () => {
            const selector = document.getElementById('languageSelector');
            if (selector) {
                selector.value = currentLanguage;
                applyTranslations();
            }
        });

        // Apply translations when main app is shown
        function applyTranslationsOnLogin() {
            setTimeout(() => {
                const selector = document.getElementById('languageSelector');
                if (selector) {
                    selector.value = currentLanguage;
                    applyTranslations();
                }
            }, 100);
        }

        let isOnline = navigator.onLine;
        let locationChart = null;
        let stockChart = null;
        let barcodeCodeReader = null;
        let barcodeStream = null;
        let scanningActive = false;
        let currentScanLocation = null;

        window.addEventListener('online', () => {
            isOnline = true;
            document.getElementById('offlineBadge').classList.remove('show');
            syncOfflineData();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            document.getElementById('offlineBadge').classList.add('show');
        });

        window.addEventListener('load', () => {
            checkSession();
        });

        function checkSession() {
            try {
                const savedSession = localStorage.getItem(SESSION_KEY);
                if (savedSession) {
                    const sessionData = JSON.parse(savedSession);
                    if (sessionData && sessionData.user) {
                        currentUser = sessionData.user;
                        showMainApp();
                        loadData();
                    }
                }
            } catch (error) {
                console.error('Error restoring session:', error);
                localStorage.removeItem(SESSION_KEY);
            }
        }

        function saveSession(user) {
            try {
                const sessionData = {
                    user: user,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
            } catch (error) {
                console.error('Error saving session:', error);
            }
        }

        function clearSession() {
            localStorage.removeItem(SESSION_KEY);
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            loginError.style.display = 'none';

            try {
                if (!username || !password) {
                    throw new Error('Please enter both username and password');
                }
                
                if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                    currentUser = {
                        id: 'admin',
                        username: ADMIN_USERNAME,
                        fullName: 'Administrator',
                        role: 'admin',
                        status: 'active'
                    };
                    saveSession(currentUser);
                    showMainApp();
                    await loadData();
                    return;
                }

                if (isOnline) {
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    let foundUser = null;

                    usersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.username === username && userData.password === password) {
                            foundUser = { id: doc.id, ...userData };
                        }
                    });

                    if (foundUser && foundUser.status === 'active') {
                        currentUser = foundUser;
                        saveSession(currentUser);
                        showMainApp();
                        await loadData();
                    } else {
                        throw new Error('Invalid credentials or account is inactive');
                    }
                } else {
                    throw new Error('Cannot login in offline mode. Please check your internet connection.');
                }
            } catch (error) {
                loginError.textContent = error.message;
                loginError.style.display = 'block';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        });

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('active');
            document.getElementById('userName').textContent = currentUser.fullName || currentUser.username;
            document.getElementById('userRole').textContent = currentUser.role.toUpperCase();
            
            // Apply translations
            applyTranslationsOnLogin();
            
            // Role-based access control
            const userRole = currentUser.role;
            
            // Admin - Full access to everything
            if (userRole === 'admin') {
                document.getElementById('usersTabBtn').style.display = 'block';
                document.getElementById('salesTabBtn').style.display = 'block';
                document.getElementById('billingTabBtn').style.display = 'block';
            }
            
            // Sales Representative - Access to sales, projects, maintenance, activities, billing
            else if (userRole === 'sales') {
                document.getElementById('usersTabBtn').style.display = 'none';
                document.getElementById('salesTabBtn').style.display = 'block';
                document.getElementById('billingTabBtn').style.display = 'block';
                // Hide sensitive inventory locations from sales
                hideTabsForRole(['users']);
            }
            
            // Technician - Access to maintenance, inventory, projects, activities 
            else if (userRole === 'technician') {
                document.getElementById('usersTabBtn').style.display = 'none';
                document.getElementById('salesTabBtn').style.display = 'none';
                document.getElementById('billingTabBtn').style.display = 'none';
                hideTabsForRole(['users', 'sales', 'billing']);
            }
            
            // Reception - Access to projects, maintenance, basic inventory, activities, billing
            else if (userRole === 'reception') {
                document.getElementById('usersTabBtn').style.display = 'none';
                document.getElementById('salesTabBtn').style.display = 'none';
                document.getElementById('billingTabBtn').style.display = 'block';
                hideTabsForRole(['users', 'sales']);
            }
            
            // General User - Limited access
            else {
                document.getElementById('usersTabBtn').style.display = 'none';
                document.getElementById('salesTabBtn').style.display = 'none';
                document.getElementById('billingTabBtn').style.display = 'none';
                hideTabsForRole(['users', 'sales', 'billing']);
            }

            if (!isOnline) {
                document.getElementById('offlineBadge').classList.add('show');
            }
        }

        window.logout = () => {
            if (confirm('Are you sure you want to logout?')) {
                clearSession();
                currentUser = null;
                document.getElementById('mainApp').classList.remove('active');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginForm').reset();
                document.getElementById('usersTabBtn').style.display = 'none';
                document.getElementById('salesTabBtn').style.display = 'none';
                showTab('dashboard');
            }
        };

        async function loadData() {
            try {
                // Initialize arrays if they're undefined
                if (!inventory) inventory = { warehouse: [], office: [], "service-van": [] };
                if (!projects) projects = [];
                if (!maintenance) maintenance = [];
                if (!leads) leads = [];
                if (!activities) activities = [];
                if (!users) users = [];
                if (!invoices) invoices = [];
                
                // Show loading indicator
                const dashboardCards = document.querySelectorAll('.dashboard-card .value');
                dashboardCards.forEach(card => {
                    if (card) card.style.opacity = '0.5';
                });
                
                // Load data with individual error handling
                try { await loadInventory(); } catch (e) { console.warn('Failed to load inventory:', e); }
                
                // Add sample data for demo if inventory is empty
                if (getAllItems().length === 0) {
                    console.log('Adding sample inventory data for charts...');
                    inventory.warehouse.push(
                        { id: 'sample1', name: 'Motor Cable', quantity: 150, location: 'warehouse' },
                        { id: 'sample2', name: 'Control Panel', quantity: 75, location: 'warehouse' }
                    );
                    inventory.office.push(
                        { id: 'sample3', name: 'Office Supplies', quantity: 200, location: 'office' }
                    );
                    inventory["service-van"].push(
                        { id: 'sample4', name: 'Tools Kit', quantity: 25, location: 'service-van' }
                    );
                }
                
                try { await loadProjects(); } catch (e) { console.warn('Failed to load projects:', e); }
                try { await loadMaintenance(); } catch (e) { console.warn('Failed to load maintenance:', e); }
                try { await loadLeads(); } catch (e) { console.warn('Failed to load leads:', e); }
                try { await loadActivities(); } catch (e) { console.warn('Failed to load activities:', e); }
                try { await loadUsers(); } catch (e) { console.warn('Failed to load users:', e); }
                try { await loadInvoices(); } catch (e) { console.warn('Failed to load invoices:', e); }
                try { await loadCompanySettings(); } catch (e) { console.warn('Failed to load company settings:', e); }
                
                // Hide loading indicator
                dashboardCards.forEach(card => {
                    if (card) card.style.opacity = '1';
                });
                
                updateDashboard();
                
                // Delay chart rendering to ensure Chart.js is fully loaded
                setTimeout(() => {
                    renderCharts();
                }, 500);
                
                checkLowStock();
                populateCategoryFilters();
                populateActivityUserFilter();
            } catch (error) {
                console.error('Error loading data:', error);
                // Still update dashboard with cached data
                updateDashboard();
                
                // Delay chart rendering to ensure Chart.js is fully loaded
                setTimeout(() => {
                    renderCharts();
                }, 500);
                checkLowStock();
                populateCategoryFilters();
                populateActivityUserFilter();
            }
        }

        async function loadInventory() {
            try {
                const snapshot = await getDocs(collection(db, 'inventory'));
                inventory = { warehouse: [], office: [], "service-van": [] };
                snapshot.docs.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    if (inventory[item.location]) {
                        inventory[item.location].push(item);
                    }
                });
                // Cache the data
                localStorage.setItem('cachedInventory', JSON.stringify(inventory));
                renderLocation('warehouse');
                renderLocation('office');
                renderLocation('service-van');
            } catch (error) {
                console.error('Error loading inventory:', error);
                // Try to load from cache
                const cachedInventory = localStorage.getItem('cachedInventory');
                if (cachedInventory) {
                    inventory = JSON.parse(cachedInventory);
                    renderLocation('warehouse');
                    renderLocation('office');
                    renderLocation('service-van');
                }
            }
        }

        async function loadProjects() {
            try {
                const snapshot = await getDocs(collection(db, 'projects'));
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Cache the data
                localStorage.setItem('cachedProjects', JSON.stringify(projects));
                renderProjects();
            } catch (error) {
                console.error('Error loading projects:', error);
                // Try to load from cache
                const cachedProjects = localStorage.getItem('cachedProjects');
                if (cachedProjects) {
                    projects = JSON.parse(cachedProjects);
                    renderProjects();
                }
            }
        }

        async function loadMaintenance() {
            try {
                const snapshot = await getDocs(collection(db, 'maintenance'));
                maintenance = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Cache the data
                localStorage.setItem('cachedMaintenance', JSON.stringify(maintenance));
                renderMaintenance();
            } catch (error) {
                console.error('Error loading maintenance:', error);
                // Try to load from cache
                const cachedMaintenance = localStorage.getItem('cachedMaintenance');
                if (cachedMaintenance) {
                    maintenance = JSON.parse(cachedMaintenance);
                    renderMaintenance();
                }
            }
        }

        async function loadActivities() {
            try {
                const q = query(collection(db, 'activities'), orderBy('date', 'desc'));
                const snapshot = await getDocs(q);
                activities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Cache the data
                localStorage.setItem('cachedActivities', JSON.stringify(activities));
                renderActivities();
            } catch (error) {
                console.error('Error loading activities:', error);
                // Try to load from cache
                const cachedActivities = localStorage.getItem('cachedActivities');
                if (cachedActivities) {
                    activities = JSON.parse(cachedActivities);
                    renderActivities();
                }
            }
        }

        async function loadUsers() {
            if (currentUser.role !== 'admin') return;
            try {
                const snapshot = await getDocs(collection(db, 'users'));
                users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Cache the data
                localStorage.setItem('cachedUsers', JSON.stringify(users));
                renderUsers();
            } catch (error) {
                console.error('Error loading users:', error);
                // Try to load from cache
                const cachedUsers = localStorage.getItem('cachedUsers');
                if (cachedUsers) {
                    users = JSON.parse(cachedUsers);
                    renderUsers();
                }
            }
        }

        function syncOfflineData() {
            loadData();
        }

        function getAllItems() {
            return [...inventory.warehouse, ...inventory.office, ...inventory["service-van"]];
        }

        function updateDashboard() {
            const allItems = getAllItems();
            document.getElementById('totalItems').textContent = allItems ? allItems.length : 0;
            document.getElementById('warehouseItems').textContent = inventory.warehouse ? inventory.warehouse.length : 0;
            document.getElementById('serviceVanItems').textContent = inventory["service-van"] ? inventory["service-van"].length : 0;
            document.getElementById('officeItems').textContent = inventory.office ? inventory.office.length : 0;
            document.getElementById('activeProjects').textContent = projects ? projects.filter(p => p.status === 'Active').length : 0;
            document.getElementById('maintenanceDue').textContent = maintenance ? maintenance.filter(m => m.status === 'Scheduled' || m.status === 'Overdue').length : 0;
            
            // Calculate total elevators installed
            const totalElevators = projects ? projects.reduce((sum, project) => {
                return sum + (project.elevators ? project.elevators.length : 0);
            }, 0) : 0;
            document.getElementById('elevatorsInstalled').textContent = totalElevators;
            
            const lowStock = allItems ? allItems.filter(item => item.quantity < 50).length : 0;
            document.getElementById('lowStockItems').textContent = lowStock;
        }

        function checkLowStock() {
            const allItems = getAllItems();
            const lowStockItems = allItems.filter(item => item.quantity < 50);
            const alertContainer = document.getElementById('lowStockAlerts');
            
            if (lowStockItems.length > 0) {
                alertContainer.innerHTML = `
                    <div class="low-stock-alert">
                        <span class="icon">âš ï¸</span>
                        <div style="flex: 1;">
                            <strong>Low Stock Alert!</strong>
                            <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-secondary);">
                                ${lowStockItems.length} item(s) are running low
                            </p>
                            <ul class="low-stock-list" style="margin-top: 8px;">
                                ${lowStockItems.slice(0, 5).map(item => `
                                    <li>
                                        <strong>${item.name}</strong> (${item.location}): ${item.quantity} ${item.unit} remaining
                                    </li>
                                `).join('')}
                                ${lowStockItems.length > 5 ? `<li>... and ${lowStockItems.length - 5} more</li>` : ''}
                            </ul>
                        </div>
                    </div>
                `;
            } else {
                alertContainer.innerHTML = '';
            }
        }

        function renderCharts() {
            console.log('Rendering charts...');
            try {
                renderLocationChart();
                renderStockChart();
            } catch (error) {
                console.error('Error rendering charts:', error);
            }
        }

        function renderLocationChart() {
            console.log('Rendering location chart...');
            const ctx = document.getElementById('locationChart');
            if (!ctx) {
                console.warn('Location chart canvas not found');
                return;
            }

            // Use correct inventory structure with safety checks
            const data = {
                Warehouse: (inventory?.warehouse?.length) || 0,
                Office: (inventory?.office?.length) || 0,
                "Service Van": (inventory?.["service-van"]?.length) || 0
            };

            console.log('Location chart data:', data);

            if (locationChart) {
                locationChart.destroy();
                locationChart = null;
            }

            try {
                locationChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data),
                        datasets: [{
                            data: Object.values(data),
                            backgroundColor: ['#2563eb', '#16a34a', '#ea580c']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 1.5,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                console.log('Location chart created successfully');
            } catch (error) {
                console.error('Error creating location chart:', error);
            }
        }

        function renderStockChart() {
            console.log('Rendering stock chart...');
            const ctx = document.getElementById('stockChart');
            if (!ctx) {
                console.warn('Stock chart canvas not found');
                return;
            }

            try {
                const allItems = getAllItems();
                console.log('All items for stock chart:', allItems.length);
                
                const goodStock = allItems.filter(i => i && i.quantity >= 200).length;
                const mediumStock = allItems.filter(i => i && i.quantity >= 50 && i.quantity < 200).length;
                const lowStock = allItems.filter(i => i && i.quantity < 50).length;

                console.log('Stock levels:', { goodStock, mediumStock, lowStock });

                if (stockChart) {
                    stockChart.destroy();
                    stockChart = null;
                }

                stockChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Good Stock', 'Medium Stock', 'Low Stock'],
                        datasets: [{
                            label: 'Items',
                            data: [goodStock, mediumStock, lowStock],
                            backgroundColor: ['#16a34a', '#ea580c', '#dc2626']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                console.log('Stock chart created successfully');
            } catch (error) {
                console.error('Error creating stock chart:', error);
            }
        }

        function getFilteredLocationItems(location) {
            const searchValue = document.getElementById(`search${location.charAt(0).toUpperCase() + location.slice(1)}`).value.toLowerCase();
            const categoryValue = document.getElementById(`categoryFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            const statusValue = document.getElementById(`statusFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            
            return inventory[location].filter(item => {
                const text = `${item.name} ${item.category} ${item.description || ''}`.toLowerCase();
                const matchesSearch = text.includes(searchValue);
                const matchesCategory = !categoryValue || item.category === categoryValue;
                
                let matchesStatus = true;
                if (statusValue) {
                    const stockClass = item.quantity < 50 ? 'low' : item.quantity < 200 ? 'medium' : 'good';
                    matchesStatus = stockClass === statusValue;
                }
                
                return matchesSearch && matchesCategory && matchesStatus;
            });
        }

        function getFilteredProjects() {
            const searchValue = document.getElementById('searchProjects').value.toLowerCase();
            const statusValue = document.getElementById('projectStatusFilter').value;
            
            return projects.filter(proj => {
                const text = `${proj.name} ${proj.code} ${proj.client || ''} ${proj.description || ''}`.toLowerCase();
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusValue || proj.status === statusValue;
                
                return matchesSearch && matchesStatus;
            });
        }

        function getFilteredActivities() {
            const searchValue = document.getElementById('searchActivities').value.toLowerCase();
            const dateRange = document.getElementById('activityDateFilter').value;
            const userFilter = document.getElementById('activityUserFilter').value;
            
            const now = new Date();
            
            return activities.filter(act => {
                const text = act.action.toLowerCase();
                const user = act.user || '';
                const date = new Date(act.date);
                
                const matchesSearch = text.includes(searchValue);
                const matchesUser = !userFilter || user === userFilter;
                
                let matchesDate = true;
                if (dateRange !== 'all') {
                    const dayMs = 24 * 60 * 60 * 1000;
                    const diff = now - date;
                    
                    switch(dateRange) {
                        case 'today':
                            matchesDate = diff < dayMs;
                            break;
                        case 'week':
                            matchesDate = diff < 7 * dayMs;
                            break;
                        case 'month':
                            matchesDate = diff < 30 * dayMs;
                            break;
                        case 'quarter':
                            matchesDate = diff < 90 * dayMs;
                            break;
                        case 'halfyear':
                            matchesDate = diff < 180 * dayMs;
                            break;
                        case 'year':
                            matchesDate = diff < 365 * dayMs;
                            break;
                    }
                }
                
                return matchesSearch && matchesUser && matchesDate;
            });
        }

        function renderLocation(location) {
            // Handle service-van special case (ID is serviceVanList not service-vanList)
            const tbodyId = location === 'service-van' ? 'serviceVanList' : `${location}List`;
            const tbody = document.getElementById(tbodyId);
            const items = inventory[location];
            
            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">ðŸ“¦</div><p>No items in ${location}. Click "Add Item" to get started.</p></td></tr>`;
                return;
            }

            tbody.innerHTML = items.map(item => {
                const stockClass = item.quantity < 50 ? 'danger' : item.quantity < 200 ? 'warning' : 'success';
                const stockText = item.quantity < 50 ? 'Low Stock' : item.quantity < 200 ? 'Medium' : 'Good';
                const stockStatus = item.quantity < 50 ? 'low' : item.quantity < 200 ? 'medium' : 'good';
                
                return `
                    <tr data-category="${item.category}" data-status="${stockStatus}">
                        <td>
                            <strong>${item.name}</strong>
                            ${item.barcode ? `<br><small style="color: var(--text-secondary);">SKU: ${item.barcode}</small>` : ''}
                            ${item.description ? `<br><small style="color: var(--text-secondary);">${item.description}</small>` : ''}
                        </td>
                        <td>${item.category}</td>
                        <td><strong>${item.quantity}</strong> ${item.unit}</td>
                        <td><span class="badge badge-${stockClass}">${stockText}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-success btn-sm" onclick="showAddStockModal('${item.id}')">+ Add</button>
                                <button class="btn btn-primary btn-sm" onclick="showUseModal('${item.id}')">Use</button>
                                <button class="btn btn-secondary btn-sm" onclick="editInventory('${item.id}')">Edit</button>
                                ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteInventory('${item.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderProjects() {
            const tbody = document.getElementById('projectList');
            if (!tbody) return;
            
            if (!projects || projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">ðŸ“‹</div><p>No projects. Click "Create Project" to get started.</p></td></tr>';
                return;
            }

            tbody.innerHTML = projects.map(proj => {
                const statusClass = proj.status === 'Active' ? 'success' : proj.status === 'Completed' ? 'primary' : 'secondary';
                const elevatorInfo = proj.elevatorCount ? `${proj.elevatorCount} ${proj.elevatorType || 'Elevator'}(s)` : 'Not specified';
                const progressBar = proj.progress ? `<div class="progress-bar"><div class="progress-fill" style="width: ${proj.progress}%"></div></div><small>${proj.progress}%</small>` : '';
                
                return `
                    <tr data-status="${proj.status}">
                        <td>
                            <strong>${proj.name}</strong>
                            <div class="project-details">
                                <small>${proj.type || 'Project'} for ${proj.client}</small>
                                ${proj.address ? `<br><small>ðŸ“ ${proj.address}</small>` : ''}
                            </div>
                        </td>
                        <td>${proj.code}</td>
                        <td>${proj.client || '-'}</td>
                        <td>${elevatorInfo}</td>
                        <td>${progressBar}</td>
                        <td><span class="badge badge-${statusClass}">${proj.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editProject('${proj.id}')">Edit</button>
                                ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteProject('${proj.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderMaintenance() {
            const tbody = document.getElementById('maintenanceList');
            if (!tbody) return;
            
            if (!maintenance || maintenance.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty-state"><div class="empty-state-icon">ðŸ”§</div><p>No maintenance scheduled. Click "Schedule Maintenance" to get started.</p></td></tr>';
                return;
            }

            tbody.innerHTML = maintenance.map(maint => {
                const statusClass = maint.status === 'Completed' ? 'success' : 
                                  maint.status === 'In Progress' ? 'warning' : 
                                  maint.status === 'Overdue' ? 'danger' : 'secondary';
                const priorityClass = maint.priority === 'High' ? 'danger' : 
                                     maint.priority === 'Medium' ? 'warning' : 'secondary';
                
                // Check if overdue
                const isOverdue = new Date(maint.dueDate) < new Date() && maint.status !== 'Completed';
                const actualStatus = isOverdue ? 'Overdue' : maint.status;
                const actualStatusClass = isOverdue ? 'danger' : statusClass;
                
                const complaintPerson = maint.complaintPersonName || 'N/A';
                const hasSignatures = maint.arrivalSignature || maint.completionSignature;
                
                return `
                    <tr data-status="${maint.status}" data-priority="${maint.priority}">
                        <td>${maint.elevatorId}</td>
                        <td>${maint.projectName || '-'}</td>
                        <td>${maint.issue}</td>
                        <td>
                            <strong>${complaintPerson}</strong>
                            ${maint.complaintPersonPhone ? `<br><small style="color: var(--text-secondary);">${maint.complaintPersonPhone}</small>` : ''}
                            ${maint.complaintPersonDesignation ? `<br><small style="color: var(--text-secondary);">${maint.complaintPersonDesignation}</small>` : ''}
                        </td>
                        <td><span class="badge badge-${priorityClass}">${maint.priority}</span></td>
                        <td>${maint.assignedTo}</td>
                        <td>${new Date(maint.dueDate).toLocaleDateString()}</td>
                        <td>
                            <span class="badge badge-${actualStatusClass}">${actualStatus}</span>
                            ${hasSignatures ? '<br><small style="color: var(--success); font-weight: 600;">ðŸ“ Signed</small>' : ''}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editMaintenance('${maint.id}')">Edit</button>
                                ${maint.status === 'Completed' && hasSignatures ? `<button class="btn btn-primary btn-sm" onclick="exportMaintenanceReport('${maint.id}')">ðŸ“¥ PDF</button>` : ''}
                                ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteMaintenance('${maint.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderActivities() {
            const tbody = document.getElementById('activityList');
            if (activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No activities recorded</td></tr>';
            } else {
                tbody.innerHTML = activities.map(act => `
                    <tr data-user="${act.user}" data-date="${act.date}">
                        <td>${new Date(act.date).toLocaleString()}</td>
                        <td>${act.action}</td>
                        <td>${act.user}</td>
                    </tr>
                `).join('');
            }
        }

        function renderUsers() {
            const tbody = document.getElementById('usersList');
            if (!tbody) return;
            
            if (!users || users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">ðŸ‘¥</div><p>No users found.</p></td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => {
                const statusClass = user.status === 'active' ? 'success' : 'secondary';
                const roleClass = user.role === 'admin' ? 'primary' : 
                                user.role === 'sales' ? 'success' :
                                user.role === 'technician' ? 'warning' :
                                user.role === 'reception' ? 'info' : 'secondary';
                
                return `
                    <tr>
                        <td><strong>${user.username}</strong></td>
                        <td>${user.fullName || '-'}</td>
                        <td><span class="badge badge-${roleClass}">${user.role.toUpperCase()}</span></td>
                        <td><span class="badge badge-${statusClass}">${user.status.toUpperCase()}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editUser('${user.id}')">Edit</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function populateCategoryFilters() {
            ['warehouse', 'office', 'service-van'].forEach(location => {
                // Handle service-van special case for element IDs
                const locationId = location === 'service-van' ? 'ServiceVan' : location.charAt(0).toUpperCase() + location.slice(1);
                const select = document.getElementById(`categoryFilter${locationId}`);
                if (select) {
                    const categories = [...new Set(inventory[location].map(i => i.category))].sort();
                    select.innerHTML = '<option value="">All Categories</option>' + 
                        categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                }
            });
        }

        function populateActivityUserFilter() {
            const select = document.getElementById('activityUserFilter');
            const users = [...new Set(activities.map(a => a.user))].sort();
            select.innerHTML = '<option value="">All Users</option>' + 
                users.map(user => `<option value="${user}">${user}</option>`).join('');
        }

        // Billing System Functions
        async function loadInvoices() {
            try {
                const snapshot = await getDocs(collection(db, 'invoices'));
                invoices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Cache the data
                localStorage.setItem('cachedInvoices', JSON.stringify(invoices));
                renderInvoices();
                updateBillingStats();
            } catch (error) {
                console.error('Error loading invoices:', error);
                // Try to load from cache
                const cachedInvoices = localStorage.getItem('cachedInvoices');
                if (cachedInvoices) {
                    invoices = JSON.parse(cachedInvoices);
                    renderInvoices();
                    updateBillingStats();
                }
            }
        }

        async function loadCompanySettings() {
            try {
                const snapshot = await getDocs(collection(db, 'company_settings'));
                if (!snapshot.empty) {
                    const settingsDoc = snapshot.docs[0];
                    companySettings = { id: settingsDoc.id, ...settingsDoc.data() };
                }
            } catch (error) {
                console.error('Error loading company settings:', error);
            }
        }

        function renderInvoices() {
            const tbody = document.getElementById('invoicesList');
            if (invoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">ðŸ“„</div><p>No invoices created yet. Click "Create Invoice" to get started.</p></td></tr>';
                return;
            }

            tbody.innerHTML = invoices.map(invoice => {
                const statusClass = getInvoiceStatusClass(invoice.status);
                const dueDate = invoice.dueDate ? new Date(invoice.dueDate).toLocaleDateString('en-IN') : '-';
                const invoiceDate = new Date(invoice.invoiceDate).toLocaleDateString('en-IN');
                
                return `
                    <tr data-status="${invoice.status}" data-type="${invoice.type}">
                        <td><strong>${invoice.invoiceNumber}</strong></td>
                        <td><span class="badge badge-${invoice.type === 'quotation' ? 'secondary' : 'primary'}">${invoice.type.toUpperCase()}</span></td>
                        <td>${invoice.clientName}</td>
                        <td>${invoiceDate}</td>
                        <td>${dueDate}</td>
                        <td><strong>â‚¹${invoice.totalAmount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong></td>
                        <td><span class="badge invoice-status-${invoice.status}">${invoice.status.toUpperCase()}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="downloadInvoicePDF('${invoice.id}')">ðŸ“„ PDF</button>
                                <button class="btn btn-secondary btn-sm" onclick="editInvoice('${invoice.id}')">Edit</button>
                                ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateBillingStats() {
            const totalInvoicesCount = invoices.filter(inv => inv.type === 'invoice').length;
            const totalRevenue = invoices.filter(inv => inv.type === 'invoice' && inv.status === 'paid')
                .reduce((sum, inv) => sum + inv.totalAmount, 0);
            const pendingAmount = invoices.filter(inv => inv.type === 'invoice' && ['sent', 'overdue'].includes(inv.status))
                .reduce((sum, inv) => sum + inv.totalAmount, 0);
            const overdueCount = invoices.filter(inv => inv.type === 'invoice' && inv.status === 'overdue').length;

            document.getElementById('totalInvoices').textContent = totalInvoicesCount;
            document.getElementById('totalRevenue').textContent = `â‚¹${totalRevenue.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('pendingAmount').textContent = `â‚¹${pendingAmount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('overdueInvoices').textContent = overdueCount;
        }

        function getInvoiceStatusClass(status) {
            const statusClasses = {
                'paid': 'success',
                'sent': 'primary',
                'draft': 'secondary',
                'overdue': 'danger',
                'cancelled': 'secondary'
            };
            return statusClasses[status] || 'secondary';
        }

        window.showCreateInvoiceModal = () => {
            document.getElementById('invoiceModalTitle').textContent = 'Create Invoice';
            document.getElementById('invoiceType').value = 'invoice';
            document.getElementById('invoiceForm').reset();
            document.getElementById('editInvoiceId').value = '';
            
            // Set default invoice number
            const invoiceCount = invoices.filter(inv => inv.type === 'invoice').length;
            document.getElementById('invoiceNumber').value = `INV-${String(invoiceCount + 1).padStart(4, '0')}`;
            
            // Set default date
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];
            
            // Set default due date (30 days from now)
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];

            clearInvoiceItems();
            addInvoiceItem();
            document.getElementById('invoiceModal').classList.add('active');
        };

        window.showQuotationModal = () => {
            document.getElementById('invoiceModalTitle').textContent = 'Create Quotation';
            document.getElementById('invoiceType').value = 'quotation';
            document.getElementById('invoiceForm').reset();
            document.getElementById('editInvoiceId').value = '';
            
            // Set default quotation number
            const quotationCount = invoices.filter(inv => inv.type === 'quotation').length;
            document.getElementById('invoiceNumber').value = `QUO-${String(quotationCount + 1).padStart(4, '0')}`;
            
            // Set default date
            document.getElementById('invoiceDate').value = new Date().toISOString().split('T')[0];

            clearInvoiceItems();
            addInvoiceItem();
            document.getElementById('invoiceModal').classList.add('active');
        };

        window.addInvoiceItem = () => {
            const container = document.getElementById('invoiceItemsList');
            const itemIndex = container.children.length;
            
            const itemDiv = document.createElement('div');
            itemDiv.className = 'invoice-item';
            itemDiv.innerHTML = `
                <input type="text" placeholder="Item description" onchange="calculateInvoiceTotal()" required>
                <input type="number" min="1" step="0.01" placeholder="1" onchange="calculateInvoiceTotal()" required>
                <input type="text" placeholder="pcs" onchange="calculateInvoiceTotal()">
                <input type="number" min="0" step="0.01" placeholder="0.00" onchange="calculateInvoiceTotal()" required>
                <input type="number" min="0" step="0.01" placeholder="0.00" readonly>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)">Ã—</button>
            `;
            container.appendChild(itemDiv);
            calculateInvoiceTotal();
        };

        window.removeInvoiceItem = (button) => {
            button.closest('.invoice-item').remove();
            calculateInvoiceTotal();
        };

        function clearInvoiceItems() {
            document.getElementById('invoiceItemsList').innerHTML = '';
        }

        window.calculateInvoiceTotal = () => {
            const items = document.querySelectorAll('#invoiceItemsList .invoice-item');
            let subtotal = 0;

            items.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const qty = parseFloat(inputs[1].value) || 0;
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = qty * rate;
                
                inputs[4].value = amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                subtotal += amount;
            });

            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const gstPercent = parseFloat(document.getElementById('gstPercent').value) || 0;

            const discountAmount = (subtotal * discountPercent) / 100;
            const afterDiscount = subtotal - discountAmount;
            const gstAmount = (afterDiscount * gstPercent) / 100;
            const total = afterDiscount + gstAmount;

            document.getElementById('subtotalDisplay').textContent = `â‚¹${subtotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('totalAmountDisplay').textContent = `â‚¹${total.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        };

        // Advance Payment Functions
        window.toggleAdvanceSection = () => {
            const paymentTerms = document.getElementById('paymentTerms').value;
            const advanceSection = document.getElementById('advancePaymentSection');
            const installmentsSection = document.getElementById('installmentsSection');
            
            // Hide all sections first
            advanceSection.style.display = 'none';
            installmentsSection.style.display = 'none';
            
            if (paymentTerms === 'advance') {
                advanceSection.style.display = 'block';
                updatePaymentSummary();
            } else if (paymentTerms === 'installments') {
                installmentsSection.style.display = 'block';
                updateInstallmentSummary();
            }
        };

        window.calculateAdvancePercentage = () => {
            const totalAmount = getTotalAmount();
            const advanceAmount = parseFloat(document.getElementById('advanceAmount').value) || 0;
            
            if (totalAmount > 0) {
                const percentage = (advanceAmount / totalAmount) * 100;
                document.getElementById('advancePercentage').value = percentage.toFixed(2);
            }
            updatePaymentSummary();
        };

        window.calculateAdvanceAmount = () => {
            const totalAmount = getTotalAmount();
            const advancePercentage = parseFloat(document.getElementById('advancePercentage').value) || 0;
            
            if (totalAmount > 0) {
                const advanceAmount = (totalAmount * advancePercentage) / 100;
                document.getElementById('advanceAmount').value = advanceAmount.toFixed(2);
            }
            updatePaymentSummary();
        };

        function getTotalAmount() {
            const totalDisplay = document.getElementById('totalAmountDisplay').textContent;
            const amount = totalDisplay.replace('â‚¹', '').replace(/,/g, '');
            return parseFloat(amount) || 0;
        }

        function updatePaymentSummary() {
            const totalAmount = getTotalAmount();
            const advanceAmount = parseFloat(document.getElementById('advanceAmount').value) || 0;
            const balanceAmount = totalAmount - advanceAmount;
            const balancePercentage = totalAmount > 0 ? ((balanceAmount / totalAmount) * 100) : 0;

            document.getElementById('paymentTotalAmount').textContent = `â‚¹${totalAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            document.getElementById('paymentAdvanceAmount').textContent = `â‚¹${advanceAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            document.getElementById('paymentBalanceAmount').textContent = `â‚¹${balanceAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            document.getElementById('paymentBalancePercent').textContent = `${balancePercentage.toFixed(1)}%`;
        }

        window.addInstallment = () => {
            const installmentsList = document.getElementById('installmentsList');
            const installmentIndex = installmentsList.children.length + 1;
            
            const installmentDiv = document.createElement('div');
            installmentDiv.className = 'installment-item';
            installmentDiv.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; align-items: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #fed7aa;';
            
            installmentDiv.innerHTML = `
                <input type="number" class="form-control" placeholder="Amount (â‚¹)" min="0" step="0.01" onchange="updateInstallmentSummary()" required>
                <input type="number" class="form-control" placeholder="Percentage (%)" min="0" max="100" step="0.01" onchange="calculateInstallmentFromPercentage(this)" required>
                <input type="date" class="form-control" required>
                <select class="form-control" required>
                    <option value="">Payment Method</option>
                    <option value="cash">Cash</option>
                    <option value="cheque">Cheque</option>
                    <option value="bank_transfer">Bank Transfer</option>
                    <option value="upi">UPI</option>
                    <option value="card">Card</option>
                    <option value="online">Online</option>
                </select>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeInstallment(this)" style="padding: 4px 8px;">Ã—</button>
            `;
            
            installmentsList.appendChild(installmentDiv);
            updateInstallmentSummary();
        };

        window.calculateInstallmentFromPercentage = (percentageInput) => {
            const row = percentageInput.closest('.installment-item');
            const amountInput = row.querySelector('input[type="number"]');
            const percentage = parseFloat(percentageInput.value) || 0;
            const totalAmount = getTotalAmount();
            
            if (totalAmount > 0) {
                const amount = (totalAmount * percentage) / 100;
                amountInput.value = amount.toFixed(2);
            }
            updateInstallmentSummary();
        };

        window.removeInstallment = (button) => {
            button.closest('.installment-item').remove();
            updateInstallmentSummary();
        };

        function updateInstallmentSummary() {
            const totalAmount = getTotalAmount();
            const installmentItems = document.querySelectorAll('.installment-item');
            let plannedAmount = 0;
            
            installmentItems.forEach(item => {
                const amountInput = item.querySelector('input[type="number"]');
                plannedAmount += parseFloat(amountInput.value) || 0;
            });
            
            const remainingAmount = totalAmount - plannedAmount;
            
            document.getElementById('installmentTotalAmount').textContent = `â‚¹${totalAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            document.getElementById('installmentPlannedAmount').textContent = `â‚¹${plannedAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            document.getElementById('installmentRemainingAmount').textContent = `â‚¹${remainingAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            
            // Update color based on remaining amount
            const remainingElement = document.getElementById('installmentRemainingAmount');
            if (remainingAmount < 0) {
                remainingElement.style.color = '#dc2626';
            } else if (remainingAmount === 0) {
                remainingElement.style.color = '#059669';
            } else {
                remainingElement.style.color = '#ea580c';
            }
        }

        // Override calculateInvoiceTotal to update payment summaries
        const originalCalculateInvoiceTotal = window.calculateInvoiceTotal;
        window.calculateInvoiceTotal = () => {
            originalCalculateInvoiceTotal();
            
            // Update payment summaries if sections are visible
            if (document.getElementById('advancePaymentSection').style.display === 'block') {
                updatePaymentSummary();
            }
            if (document.getElementById('installmentsSection').style.display === 'block') {
                updateInstallmentSummary();
            }
        };

        window.filterInvoices = () => {
            const searchValue = document.getElementById('searchInvoices').value.toLowerCase();
            const statusValue = document.getElementById('invoiceStatusFilter').value;
            const typeValue = document.getElementById('invoiceTypeFilter').value;
            
            const rows = document.querySelectorAll('#invoicesList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const status = row.dataset.status || '';
                const type = row.dataset.type || '';
                
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusValue || status === statusValue;
                const matchesType = !typeValue || type === typeValue;
                
                row.style.display = (matchesSearch && matchesStatus && matchesType) ? '' : 'none';
            });
        };

        window.editInvoice = (invoiceId) => {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            document.getElementById('invoiceModalTitle').textContent = `Edit ${invoice.type === 'quotation' ? 'Quotation' : 'Invoice'}`;
            document.getElementById('editInvoiceId').value = invoice.id;
            document.getElementById('invoiceType').value = invoice.type;
            
            // Fill form fields
            document.getElementById('clientName').value = invoice.clientName;
            document.getElementById('clientEmail').value = invoice.clientEmail || '';
            document.getElementById('clientPhone').value = invoice.clientPhone || '';
            document.getElementById('clientGST').value = invoice.clientGST || '';
            document.getElementById('clientAddress').value = invoice.clientAddress || '';
            
            document.getElementById('invoiceNumber').value = invoice.invoiceNumber;
            document.getElementById('invoiceDate').value = invoice.invoiceDate;
            document.getElementById('dueDate').value = invoice.dueDate || '';
            document.getElementById('poNumber').value = invoice.poNumber || '';
            
            document.getElementById('discountPercent').value = invoice.discountPercent || 0;
            document.getElementById('gstPercent').value = invoice.gstPercent || 18;
            document.getElementById('invoiceNotes').value = invoice.notes || '';

            // Fill items
            clearInvoiceItems();
            invoice.items.forEach(item => {
                addInvoiceItem();
                const lastItem = document.querySelector('#invoiceItemsList .invoice-item:last-child');
                const inputs = lastItem.querySelectorAll('input');
                inputs[0].value = item.description;
                inputs[1].value = item.quantity;
                inputs[2].value = item.unit;
                inputs[3].value = item.rate;
            });

            calculateInvoiceTotal();

            // Populate payment information if exists
            if (invoice.paymentTerms) {
                document.getElementById('paymentTerms').value = invoice.paymentTerms;
                toggleAdvanceSection();
                
                if (invoice.paymentTerms === 'advance' && invoice.advancePayment) {
                    document.getElementById('advanceAmount').value = invoice.advancePayment.amount || '';
                    document.getElementById('advancePercentage').value = invoice.advancePayment.percentage || '';
                    document.getElementById('advanceDate').value = invoice.advancePayment.date || '';
                    document.getElementById('advanceMethod').value = invoice.advancePayment.method || '';
                    document.getElementById('advanceReference').value = invoice.advancePayment.reference || '';
                    document.getElementById('balanceDueDate').value = invoice.advancePayment.balanceDueDate || '';
                    document.getElementById('advanceNotes').value = invoice.advancePayment.notes || '';
                    
                    setTimeout(() => updatePaymentSummary(), 100);
                }
                
                if (invoice.paymentTerms === 'installments' && invoice.installments) {
                    // Clear existing installments
                    document.getElementById('installmentsList').innerHTML = '';
                    
                    // Add each installment
                    invoice.installments.forEach(installment => {
                        addInstallment();
                        const lastInstallment = document.querySelector('.installment-item:last-child');
                        const inputs = lastInstallment.querySelectorAll('input, select');
                        inputs[0].value = installment.amount;
                        inputs[1].value = installment.percentage;
                        inputs[2].value = installment.dueDate;
                        inputs[3].value = installment.paymentMethod;
                    });
                    
                    setTimeout(() => updateInstallmentSummary(), 100);
                }
            }
            
            // Set invoice status
            if (invoice.status) {
                document.getElementById('invoiceStatus').value = invoice.status;
            }

            document.getElementById('invoiceModal').classList.add('active');
        };

        window.deleteInvoice = async (invoiceId) => {
            if (confirm('Are you sure you want to delete this invoice?')) {
                try {
                    await deleteDoc(doc(db, 'invoices', invoiceId));
                    await addDoc(collection(db, 'activities'), {
                        action: `Deleted invoice`,
                        user: currentUser.fullName || currentUser.username,
                        date: new Date().toISOString()
                    });
                    loadInvoices();
                } catch (error) {
                    alert('Error deleting invoice: ' + error.message);
                }
            }
        };

        window.downloadInvoicePDF = async (invoiceId) => {
            try {
                // Ensure jsPDF is available (loads dynamically if required)
                try {
                    await ensureJsPDF();
                } catch (e) {
                    alert('PDF library not loaded. Please refresh the page.');
                    return;
                }

                const invoice = invoices.find(inv => inv.id === invoiceId);
                if (!invoice) {
                    alert('Invoice not found.');
                    return;
                }

                // Validate invoice has required data
                if (!invoice.items || invoice.items.length === 0) {
                    alert('Invoice has no items. Cannot generate PDF.');
                    return;
                }

                await generateInvoicePDF(invoice);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF: ' + error.message);
            }
        };

        window.showAddInventoryModal = (location) => {
            document.getElementById('inventoryModalTitle').textContent = `Add ${location.charAt(0).toUpperCase() + location.slice(1)} Item`;
            document.getElementById('inventoryForm').reset();
            document.getElementById('editItemId').value = '';
            document.getElementById('itemLocation').value = location;
            
            const categorySelect = document.getElementById('itemCategory');
            categorySelect.innerHTML = '<option value="">Select Category</option>' + 
                CATEGORIES[location].map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            document.getElementById('inventoryModal').classList.add('active');
        };

        window.editInventory = (id) => {
            const allItems = getAllItems();
            const item = allItems.find(i => i.id === id);
            
            document.getElementById('inventoryModalTitle').textContent = 'Edit Inventory Item';
            document.getElementById('editItemId').value = item.id;
            document.getElementById('itemLocation').value = item.location;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemBarcode').value = item.barcode || '';
            
            const categorySelect = document.getElementById('itemCategory');
            categorySelect.innerHTML = '<option value="">Select Category</option>' + 
                CATEGORIES[item.location].map(cat => `<option value="${cat}">${cat}</option>`).join('');
            categorySelect.value = item.category;
            
            document.getElementById('itemQuantity').value = item.quantity;
            document.getElementById('itemUnit').value = item.unit;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('inventoryModal').classList.add('active');
        };

        window.deleteInventory = async (id) => {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            const allItems = getAllItems();
            const item = allItems.find(i => i.id === id);
            
            if (isOnline) {
                await deleteDoc(doc(db, 'inventory', id));
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Deleted ${item.location} inventory: ${item.name}`,
                    user: currentUser.username
                });
            }
            
            await loadData();
        };

        document.getElementById('inventoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editItemId').value;
            const location = document.getElementById('itemLocation').value;
            const itemData = {
                name: document.getElementById('itemName').value,
                barcode: document.getElementById('itemBarcode').value,
                category: document.getElementById('itemCategory').value,
                quantity: parseInt(document.getElementById('itemQuantity').value),
                unit: document.getElementById('itemUnit').value,
                description: document.getElementById('itemDescription').value,
                location: location
            };

            try {
                if (isOnline) {
                    if (id) {
                        await updateDoc(doc(db, 'inventory', id), itemData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Updated ${location} inventory: ${itemData.name}`,
                            user: currentUser.username
                        });
                    } else {
                        await addDoc(collection(db, 'inventory'), itemData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Added ${location} inventory: ${itemData.name}`,
                            user: currentUser.username
                        });
                    }
                }

                closeModal('inventoryModal');
                await loadData();
            } catch (error) {
                alert('Error saving inventory: ' + error.message);
            }
        });

        window.showAddStockModal = (id) => {
            const allItems = getAllItems();
            const item = allItems.find(i => i.id === id);
            document.getElementById('addStockItemId').value = item.id;
            document.getElementById('addStockItemName').textContent = item.name;
            document.getElementById('addStockCurrent').textContent = `${item.quantity} ${item.unit}`;
            document.getElementById('addStockForm').reset();
            document.getElementById('addStockModal').classList.add('active');
        };

        document.getElementById('addStockForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = document.getElementById('addStockItemId').value;
            const quantity = parseInt(document.getElementById('addStockQuantity').value);
            const notes = document.getElementById('addStockNotes').value;

            const allItems = getAllItems();
            const item = allItems.find(i => i.id === itemId);
            const newQuantity = item.quantity + quantity;

            if (isOnline) {
                await updateDoc(doc(db, 'inventory', itemId), { quantity: newQuantity });
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Added ${quantity} ${item.unit} to ${item.name} (${item.location})${notes ? ' - ' + notes : ''}`,
                    user: currentUser.username
                });
            }

            closeModal('addStockModal');
            await loadData();
        });

        window.showUseModal = (id) => {
            const allItems = getAllItems();
            const item = allItems.find(i => i.id === id);
            document.getElementById('useItemId').value = item.id;
            document.getElementById('useItemName').textContent = item.name;
            document.getElementById('useAvailable').textContent = `${item.quantity} ${item.unit}`;
            document.getElementById('useQuantity').max = item.quantity;
            
            const projectSelect = document.getElementById('useProject');
            projectSelect.innerHTML = '<option value="">Select Project</option>' + 
                projects.filter(p => p.status === 'Active').map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
            
            document.getElementById('useForm').reset();
            document.getElementById('useModal').classList.add('active');
        };

        document.getElementById('useForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = document.getElementById('useItemId').value;
            const quantity = parseInt(document.getElementById('useQuantity').value);
            const projectId = document.getElementById('useProject').value;
            const notes = document.getElementById('useNotes').value;

            const allItems = getAllItems();
            const item = allItems.find(i => i.id === itemId);
            const project = projects.find(p => p.id === projectId);

            if (quantity > item.quantity) {
                alert('Not enough stock available!');
                return;
            }

            const newQuantity = item.quantity - quantity;
            const projectItems = project.items || [];
            const existingItem = projectItems.find(pi => pi.itemId === itemId);

            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                projectItems.push({
                    itemId: item.id,
                    name: item.name,
                    quantity: quantity,
                    unit: item.unit,
                    location: item.location
                });
            }

            if (isOnline) {
                await updateDoc(doc(db, 'inventory', itemId), { quantity: newQuantity });
                await updateDoc(doc(db, 'projects', projectId), { items: projectItems });
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Used ${quantity} ${item.unit} of ${item.name} (${item.location}) for ${project.name}${notes ? ' - ' + notes : ''}`,
                    user: currentUser.username
                });
            }

            closeModal('useModal');
            await loadData();
        });

        window.showAddProjectModal = () => {
            document.getElementById('projectModalTitle').textContent = 'Create New Project';
            document.getElementById('projectForm').reset();
            document.getElementById('editProjectId').value = '';
            document.getElementById('projectItemsSection').style.display = 'none';
            document.getElementById('projectSubmitBtn').textContent = 'Create Project';
            document.getElementById('projectModal').classList.add('active');
        };

        window.editProject = (id) => {
            const project = projects.find(p => p.id === id);
            
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('editProjectId').value = project.id;
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectCode').value = project.code;
            document.getElementById('projectClient').value = project.client || '';
            document.getElementById('projectType').value = project.type || '';
            document.getElementById('projectAddress').value = project.address || '';
            document.getElementById('projectElevatorCount').value = project.elevatorCount || '';
            document.getElementById('projectElevatorType').value = project.elevatorType || '';
            document.getElementById('projectCapacity').value = project.capacity || '';
            document.getElementById('projectFloors').value = project.floors || '';
            document.getElementById('projectMachineType').value = project.machineType || '';
            document.getElementById('projectSpeed').value = project.speed || '';
            document.getElementById('projectStartDate').value = project.startDate || '';
            document.getElementById('projectEndDate').value = project.endDate || '';
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('projectProgress').value = project.progress || 0;
            document.getElementById('projectSubmitBtn').textContent = 'Update Project';
            
            // Show elevator details if elevator count is set
            if (project.elevatorCount) {
                document.getElementById('elevatorDetails').style.display = 'block';
            }
            
            const items = project.items || [];
            if (items.length > 0) {
                document.getElementById('projectItemsSection').style.display = 'block';
                document.getElementById('projectItemsList').innerHTML = items.map(item => 
                    `<p>â€¢ ${item.name}: ${item.quantity} ${item.unit} (${item.location})</p>`
                ).join('');
                
                document.getElementById('returnItemsList').innerHTML = items.map(item => `
                    <div style="margin-bottom: 12px; padding: 8px; background: var(--bg-light); border-radius: 4px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="return_${item.itemId}" onchange="toggleReturnQuantity('${item.itemId}')">
                            <strong>${item.name}</strong> - Currently allocated: ${item.quantity} ${item.unit}
                        </label>
                        <div id="returnQty_${item.itemId}" style="display: none; margin-top: 8px; margin-left: 24px;">
                            <label style="font-size: 13px;">Quantity to return:</label>
                            <input type="number" class="form-control" id="returnAmount_${item.itemId}" min="0" max="${item.quantity}" value="${item.quantity}" style="margin-top: 4px;">
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('projectItemsSection').style.display = 'none';
            }

            // Populate hold information if exists
            if (project.holdInformation) {
                document.getElementById('projectHoldReason').value = project.holdInformation.reason || '';
                document.getElementById('projectHoldDate').value = project.holdInformation.holdDate || '';
                document.getElementById('projectExpectedResumeDate').value = project.holdInformation.expectedResumeDate || '';
                document.getElementById('projectHoldDuration').value = project.holdInformation.duration || '';
                document.getElementById('projectHoldNotes').value = project.holdInformation.notes || '';
            }

            // Toggle hold fields visibility
            setTimeout(() => {
                toggleHoldFields('project');
            }, 100);
            
            document.getElementById('projectModal').classList.add('active');
        };

        window.toggleReturnQuantity = (itemId) => {
            const checkbox = document.getElementById(`return_${itemId}`);
            const qtyDiv = document.getElementById(`returnQty_${itemId}`);
            qtyDiv.style.display = checkbox.checked ? 'block' : 'none';
        };

        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const projectId = document.getElementById('editProjectId').value;
            const projectData = {
                name: document.getElementById('projectName').value,
                code: document.getElementById('projectCode').value,
                client: document.getElementById('projectClient').value,
                type: document.getElementById('projectType').value,
                address: document.getElementById('projectAddress').value,
                elevatorCount: document.getElementById('projectElevatorCount').value,
                elevatorType: document.getElementById('projectElevatorType').value,
                capacity: document.getElementById('projectCapacity').value,
                floors: document.getElementById('projectFloors').value,
                machineType: document.getElementById('projectMachineType').value,
                speed: document.getElementById('projectSpeed').value,
                startDate: document.getElementById('projectStartDate').value,
                endDate: document.getElementById('projectEndDate').value,
                status: document.getElementById('projectStatus').value,
                progress: document.getElementById('projectProgress').value || 0
            };

            // Add hold information if status is "On Hold"
            if (projectData.status === 'On Hold') {
                projectData.holdInformation = {
                    reason: document.getElementById('projectHoldReason').value,
                    holdDate: document.getElementById('projectHoldDate').value,
                    expectedResumeDate: document.getElementById('projectExpectedResumeDate').value,
                    duration: document.getElementById('projectHoldDuration').value,
                    notes: document.getElementById('projectHoldNotes').value,
                    heldBy: currentUser.username,
                    heldAt: new Date().toISOString()
                };
            }

            if (isOnline) {
                if (projectId) {
                    const project = projects.find(p => p.id === projectId);
                    const items = project.items || [];
                    
                    for (const item of items) {
                        const returnCheckbox = document.getElementById(`return_${item.itemId}`);
                        if (returnCheckbox && returnCheckbox.checked) {
                            const returnAmount = parseInt(document.getElementById(`returnAmount_${item.itemId}`).value);
                            if (returnAmount > 0) {
                                const inventoryItem = getAllItems().find(i => i.id === item.itemId);
                                if (inventoryItem) {
                                    await updateDoc(doc(db, 'inventory', item.itemId), {
                                        quantity: inventoryItem.quantity + returnAmount
                                    });
                                    
                                    item.quantity -= returnAmount;
                                    
                                    await addDoc(collection(db, 'activities'), {
                                        date: new Date().toISOString(),
                                        action: `Returned ${returnAmount} ${item.unit} of ${item.name} from project ${project.name} to ${inventoryItem.location}`,
                                        user: currentUser.username
                                    });
                                }
                            }
                        }
                    }
                    
                    projectData.items = items.filter(item => item.quantity > 0);
                    
                    await updateDoc(doc(db, 'projects', projectId), projectData);
                    await addDoc(collection(db, 'activities'), {
                        date: new Date().toISOString(),
                        action: `Updated project: ${projectData.name}`,
                        user: currentUser.username
                    });
                } else {
                    projectData.items = [];
                    await addDoc(collection(db, 'projects'), projectData);
                    await addDoc(collection(db, 'activities'), {
                        date: new Date().toISOString(),
                        action: `Created project: ${projectData.name}`,
                        user: currentUser.username
                    });
                }
            }

            closeModal('projectModal');
            await loadData();
        });

        window.deleteProject = async (id) => {
            if (!confirm('Are you sure you want to delete this project? Items will be returned to inventory.')) return;
            
            const project = projects.find(p => p.id === id);
            const items = project.items || [];

            for (const projItem of items) {
                const invItem = getAllItems().find(i => i.id === projItem.itemId);
                if (invItem && isOnline) {
                    await updateDoc(doc(db, 'inventory', projItem.itemId), {
                        quantity: invItem.quantity + projItem.quantity
                    });
                }
            }

            if (isOnline) {
                await deleteDoc(doc(db, 'projects', id));
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Deleted project: ${project.name}`,
                    user: currentUser.username
                });
            }

            await loadData();
        };

        // Function to generate elevator fields based on count
        window.generateElevatorFields = () => {
            const count = parseInt(document.getElementById('projectElevatorCount').value);
            const detailsDiv = document.getElementById('elevatorDetails');
            
            if (count > 0) {
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
        };

        // Function to load elevators for maintenance modal
        window.loadElevators = () => {
            const projectId = document.getElementById('maintenanceProject').value;
            const elevatorSelect = document.getElementById('maintenanceElevator');
            
            // Clear current options
            elevatorSelect.innerHTML = '';
            
            if (projectId && projects) {
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    // Check if project has elevators array
                    if (project.elevators && Array.isArray(project.elevators) && project.elevators.length > 0) {
                        project.elevators.forEach(elevator => {
                            const elevatorId = elevator.id || elevator.elevatorId || `${projectId}-Elevator-${elevator.number || elevator.name}`;
                            const elevatorName = elevator.name || elevator.number || `Elevator ${elevator.number}`;
                            const option = document.createElement('option');
                            option.value = elevatorId;
                            option.textContent = elevatorName;
                            elevatorSelect.appendChild(option);
                        });
                    } 
                    // Fall back to elevator count if no elevators array
                    else if (project.elevatorCount) {
                        const count = parseInt(project.elevatorCount) || 1;
                        for (let i = 1; i <= count; i++) {
                            const elevatorId = `${projectId}-Elevator-${i}`;
                            const option = document.createElement('option');
                            option.value = elevatorId;
                            option.textContent = `Elevator ${i}`;
                            elevatorSelect.appendChild(option);
                        }
                    }
                    // If neither exists, create a default set based on common patterns
                    else {
                        // Default to creating at least 2 elevators for each project
                        const defaultCount = 2;
                        for (let i = 1; i <= defaultCount; i++) {
                            const elevatorId = `${projectId}-Elevator-${i}`;
                            const option = document.createElement('option');
                            option.value = elevatorId;
                            option.textContent = `Elevator ${i}`;
                            elevatorSelect.appendChild(option);
                        }
                    }
                } else {
                    elevatorSelect.innerHTML = '<option value="">No project selected</option>';
                }
            } else {
                elevatorSelect.innerHTML = '<option value="">Select a project first</option>';
            }
        };

        // Function to show maintenance modal
        // Maintenance form submission
        document.getElementById('maintenanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const maintenanceId = document.getElementById('editMaintenanceId').value;
            const elevatorSelect = document.getElementById('maintenanceElevator');
            const selectedElevators = Array.from(elevatorSelect.selectedOptions).map(opt => opt.value);
            
            // If multiple elevators are selected, create maintenance for each
            if (selectedElevators.length === 0) {
                alert('Please select at least one elevator');
                return;
            }
            
            try {
                const baseMaintenanceData = {
                    projectId: document.getElementById('maintenanceProject').value,
                    projectName: projects && projects.find ? projects.find(p => p.id === document.getElementById('maintenanceProject').value)?.name : '',
                    issue: document.getElementById('maintenanceIssue').value,
                    priority: document.getElementById('maintenancePriority').value,
                    assignedTo: document.getElementById('maintenanceAssignee').value,
                    dueDate: document.getElementById('maintenanceDueDate').value,
                    status: document.getElementById('maintenanceStatus').value || 'Scheduled',
                    notes: document.getElementById('maintenanceNotes').value,
                    
                    // Complaint person details
                    complaintPersonName: document.getElementById('complaintPersonName').value,
                    complaintPersonPhone: document.getElementById('complaintPersonPhone').value,
                    complaintPersonEmail: document.getElementById('complaintPersonEmail').value,
                    complaintPersonDesignation: document.getElementById('complaintPersonDesignation').value,
                    complaintPersonAddress: document.getElementById('complaintPersonAddress').value,
                    complaintDate: document.getElementById('complaintDate').value,
                    
                    // Work details
                    workDescription: document.getElementById('workDescription').value,
                    partsUsed: document.getElementById('partsUsed').value,
                    workCost: document.getElementById('workCost').value,
                    arrivalTime: document.getElementById('arrivalTime').value,
                    completionTime: document.getElementById('completionTime').value,
                    signatoryName: document.getElementById('signatoryName').value,
                    
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser ? currentUser.username : 'System'
                };

                // Add hold information if status is "On Hold"
                const status = document.getElementById('maintenanceStatus').value;
                if (status === 'On Hold') {
                    baseMaintenanceData.holdInformation = {
                        reason: document.getElementById('maintenanceHoldReason').value,
                        holdDate: document.getElementById('maintenanceHoldDate').value,
                        expectedResumeDate: document.getElementById('maintenanceExpectedResumeDate').value,
                        duration: document.getElementById('maintenanceHoldDuration').value,
                        notes: document.getElementById('maintenanceHoldNotes').value,
                        heldBy: currentUser ? currentUser.username : 'System',
                        heldAt: new Date().toISOString()
                    };
                }
                
                // If editing, only update single maintenance
                if (maintenanceId) {
                    const maintenanceData = {
                        ...baseMaintenanceData,
                        elevatorId: selectedElevators[0] // For editing, use first selected elevator
                    };

                    // Add signatures if they exist
                    const arrivalCanvas = document.getElementById('arrivalSignatureCanvas');
                    const completionCanvas = document.getElementById('completionSignatureCanvas');
                    
                    if (arrivalCanvas && !isCanvasEmpty(arrivalCanvas)) {
                        maintenanceData.arrivalSignature = arrivalCanvas.toDataURL('image/png');
                    }
                    
                    if (completionCanvas && !isCanvasEmpty(completionCanvas)) {
                        maintenanceData.completionSignature = completionCanvas.toDataURL('image/png');
                    }
                    
                    // Update existing maintenance
                    if (isOnline) {
                        await updateDoc(doc(db, 'maintenance', maintenanceId), maintenanceData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Updated maintenance for ${maintenanceData.elevatorId} in project ${maintenanceData.projectName} - Status: ${maintenanceData.status}`,
                            user: currentUser ? currentUser.username : 'System'
                        });
                    }
                } else {
                    // Create new maintenance for each selected elevator
                    for (const elevatorId of selectedElevators) {
                        const maintenanceData = {
                            ...baseMaintenanceData,
                            elevatorId: elevatorId,
                            createdAt: new Date().toISOString(),
                            createdBy: currentUser ? currentUser.username : 'System'
                        };
                        
                        // Add signatures if they exist
                        const arrivalCanvas = document.getElementById('arrivalSignatureCanvas');
                        const completionCanvas = document.getElementById('completionSignatureCanvas');
                        
                        if (arrivalCanvas && !isCanvasEmpty(arrivalCanvas)) {
                            maintenanceData.arrivalSignature = arrivalCanvas.toDataURL('image/png');
                        }
                        
                        if (completionCanvas && !isCanvasEmpty(completionCanvas)) {
                            maintenanceData.completionSignature = completionCanvas.toDataURL('image/png');
                        }
                        
                        if (isOnline) {
                            await addDoc(collection(db, 'maintenance'), maintenanceData);
                            await addDoc(collection(db, 'activities'), {
                                date: new Date().toISOString(),
                                action: `Scheduled maintenance for ${elevatorId} in project ${maintenanceData.projectName} - Priority: ${maintenanceData.priority}`,
                                user: currentUser ? currentUser.username : 'System'
                            });
                        }
                    }
                }
                
                closeModal('maintenanceModal');
                await loadData();
                const message = maintenanceId ? 
                    'Maintenance updated successfully!' : 
                    `Maintenance scheduled for ${selectedElevators.length} elevator(s) successfully!`;
                alert(message);
            } catch (error) {
                console.error('Error scheduling maintenance:', error);
                alert('Error scheduling maintenance: ' + error.message);
            }
        });

        window.editMaintenance = (id) => {
            const maint = maintenance && maintenance.find ? maintenance.find(m => m.id === id) : null;
            
            if (!maint) {
                alert('Maintenance record not found');
                return;
            }
            
            document.getElementById('maintenanceModalTitle').textContent = 'Edit Maintenance';
            document.getElementById('editMaintenanceId').value = maint.id;
            document.getElementById('maintenanceProject').value = maint.projectId || '';
            loadElevators();
            // Use setTimeout to ensure elevators are loaded before setting the value
            setTimeout(() => {
                const elevatorSelect = document.getElementById('maintenanceElevator');
                // For editing, only select the single elevator
                Array.from(elevatorSelect.options).forEach(option => {
                    option.selected = option.value === maint.elevatorId;
                });
            }, 100);
            document.getElementById('maintenanceIssue').value = maint.issue || '';
            document.getElementById('maintenancePriority').value = maint.priority || '';
            document.getElementById('maintenanceAssignee').value = maint.assignedTo || '';
            document.getElementById('maintenanceDueDate').value = maint.dueDate || '';
            document.getElementById('maintenanceStatus').value = maint.status || 'Scheduled';
            document.getElementById('maintenanceNotes').value = maint.notes || '';
            
            // Complaint person details
            document.getElementById('complaintPersonName').value = maint.complaintPersonName || '';
            document.getElementById('complaintPersonPhone').value = maint.complaintPersonPhone || '';
            document.getElementById('complaintPersonEmail').value = maint.complaintPersonEmail || '';
            document.getElementById('complaintPersonDesignation').value = maint.complaintPersonDesignation || '';
            document.getElementById('complaintPersonAddress').value = maint.complaintPersonAddress || '';
            document.getElementById('complaintDate').value = maint.complaintDate || '';
            
            // Work details
            document.getElementById('workDescription').value = maint.workDescription || '';
            document.getElementById('partsUsed').value = maint.partsUsed || '';
            document.getElementById('workCost').value = maint.workCost || '';
            document.getElementById('arrivalTime').value = maint.arrivalTime || '';
            document.getElementById('completionTime').value = maint.completionTime || '';
            document.getElementById('signatoryName').value = maint.signatoryName || '';
            
            // Load signatures if they exist
            if (maint.arrivalSignature) {
                loadSignatureToCanvas('arrivalSignatureCanvas', maint.arrivalSignature);
            }
            if (maint.completionSignature) {
                loadSignatureToCanvas('completionSignatureCanvas', maint.completionSignature);
            }
            
            // Populate dropdowns
            const projectSelect = document.getElementById('maintenanceProject');
            projectSelect.innerHTML = '<option value="">Select Project</option>' + 
                projects.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
            document.getElementById('maintenanceProject').value = maint.projectId || '';
            
            const assigneeSelect = document.getElementById('maintenanceAssignee');
            assigneeSelect.innerHTML = '<option value="">Select Technician</option>' + 
                users.filter(u => (u.role === 'technician' || u.role === 'user' || u.role === 'admin') && u.status === 'active')
                     .map(u => `<option value="${u.username}">${u.fullName || u.username}</option>`).join('');
            document.getElementById('maintenanceAssignee').value = maint.assignedTo || '';
            
            // Show export button if completed
            if (maint.status === 'Completed') {
                document.getElementById('exportBtn').style.display = 'inline-flex';
                document.getElementById('exportBtn').setAttribute('onclick', `exportMaintenanceReport('${maint.id}')`);
            } else {
                document.getElementById('exportBtn').style.display = 'none';
            }

            // Populate hold information if exists
            if (maint.holdInformation) {
                document.getElementById('maintenanceHoldReason').value = maint.holdInformation.reason || '';
                document.getElementById('maintenanceHoldDate').value = maint.holdInformation.holdDate || '';
                document.getElementById('maintenanceExpectedResumeDate').value = maint.holdInformation.expectedResumeDate || '';
                document.getElementById('maintenanceHoldDuration').value = maint.holdInformation.duration || '';
                document.getElementById('maintenanceHoldNotes').value = maint.holdInformation.notes || '';
            }
            
            // Toggle signature sections based on status
            toggleSignatureSection();

            // Toggle hold fields visibility
            setTimeout(() => {
                toggleHoldFields('maintenance');
            }, 100);
            
            document.getElementById('maintenanceModal').classList.add('active');
        };

        window.deleteMaintenance = async (id) => {
            if (!confirm('Are you sure you want to delete this maintenance record?')) return;
            
            const maint = maintenance.find(m => m.id === id);
            
            if (isOnline) {
                await deleteDoc(doc(db, 'maintenance', id));
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Deleted maintenance record for ${maint.elevatorId} in project ${maint.projectName}`,
                    user: currentUser.username
                });
            }

            await loadData();
        };

        window.showAddUserModal = () => {
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userForm').reset();
            document.getElementById('editUserId').value = '';
            document.getElementById('newPassword').required = true;
            document.getElementById('newUsername').disabled = false;
            document.getElementById('userModal').classList.add('active');
        };

        window.editUser = (id) => {
            const user = users.find(u => u.id === id);
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('editUserId').value = user.id;
            document.getElementById('newUsername').value = user.username;
            document.getElementById('newUsername').disabled = true;
            document.getElementById('newFullName').value = user.fullName || '';
            document.getElementById('newPassword').value = '';
            document.getElementById('newPassword').required = false;
            document.getElementById('newUserRole').value = user.role;
            document.getElementById('newUserStatus').value = user.status;
            document.getElementById('userModal').classList.add('active');
        };

        window.deleteUser = async (id) => {
            const user = users.find(u => u.id === id);
            if (!confirm(`Are you sure you want to delete user "${user.username}"?`)) return;

            if (isOnline) {
                await deleteDoc(doc(db, 'users', id));
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Deleted user: ${user.username}`,
                    user: currentUser.username
                });
            }

            await loadUsers();
        };

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editUserId').value;
            const username = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('newPassword').value;
            const fullName = document.getElementById('newFullName').value;
            const role = document.getElementById('newUserRole').value;
            const status = document.getElementById('newUserStatus').value;

            try {
                if (isOnline) {
                    if (id) {
                        const userData = { fullName, role, status };
                        if (password) {
                            userData.password = password;
                        }
                        await updateDoc(doc(db, 'users', id), userData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Updated user: ${username}`,
                            user: currentUser.username
                        });
                    } else {
                        const existingUser = users.find(u => u.username === username);
                        if (existingUser) {
                            throw new Error('Username already exists');
                        }

                        await addDoc(collection(db, 'users'), {
                            username: username,
                            password: password,
                            fullName: fullName,
                            role: role,
                            status: status
                        });
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Created user: ${username}`,
                            user: currentUser.username
                        });
                    }
                } else {
                    throw new Error('Cannot manage users in offline mode');
                }

                document.getElementById('newUsername').disabled = false;
                closeModal('userModal');
                await loadUsers();
            } catch (error) {
                alert('Error saving user: ' + error.message);
            }
        });

        // Invoice Form Handler
        document.getElementById('invoiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const invoiceId = document.getElementById('editInvoiceId').value;
            const type = document.getElementById('invoiceType').value;
            
            // Collect form data
            const formData = {
                type: type,
                clientName: document.getElementById('clientName').value.trim(),
                clientEmail: document.getElementById('clientEmail').value.trim(),
                clientPhone: document.getElementById('clientPhone').value.trim(),
                clientGST: document.getElementById('clientGST').value.trim(),
                clientAddress: document.getElementById('clientAddress').value.trim(),
                invoiceNumber: document.getElementById('invoiceNumber').value.trim(),
                invoiceDate: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                poNumber: document.getElementById('poNumber').value.trim(),
                discountPercent: parseFloat(document.getElementById('discountPercent').value) || 0,
                gstPercent: parseFloat(document.getElementById('gstPercent').value) || 0,
                notes: document.getElementById('invoiceNotes').value.trim(),
                status: invoiceId ? invoices.find(inv => inv.id === invoiceId)?.status || 'draft' : 'draft'
            };

            // Collect items
            const itemElements = document.querySelectorAll('#invoiceItemsList .invoice-item');
            formData.items = [];
            let subtotal = 0;

            itemElements.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const description = inputs[0].value.trim();
                const quantity = parseFloat(inputs[1].value) || 0;
                const unit = inputs[2].value.trim() || 'pcs';
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = quantity * rate;

                if (description && quantity > 0 && rate >= 0) {
                    formData.items.push({
                        description,
                        quantity,
                        unit,
                        rate,
                        amount
                    });
                    subtotal += amount;
                }
            });

            if (formData.items.length === 0) {
                alert('Please add at least one item');
                return;
            }

            // Calculate totals
            const discountAmount = (subtotal * formData.discountPercent) / 100;
            const afterDiscount = subtotal - discountAmount;
            const gstAmount = (afterDiscount * formData.gstPercent) / 100;
            
            formData.subtotal = subtotal;
            formData.discountAmount = discountAmount;
            formData.gstAmount = gstAmount;
            formData.totalAmount = afterDiscount + gstAmount;
            formData.updatedAt = new Date().toISOString();

            // Collect payment data
            const paymentTerms = document.getElementById('paymentTerms').value;
            const invoiceStatus = document.getElementById('invoiceStatus').value;
            
            formData.paymentTerms = paymentTerms;
            if (invoiceStatus) {
                formData.status = invoiceStatus;
            }

            // Add advance payment information if applicable
            if (paymentTerms === 'advance') {
                const advanceAmount = parseFloat(document.getElementById('advanceAmount').value) || 0;
                const advancePercentage = parseFloat(document.getElementById('advancePercentage').value) || 0;
                
                formData.advancePayment = {
                    amount: advanceAmount,
                    percentage: advancePercentage,
                    date: document.getElementById('advanceDate').value,
                    method: document.getElementById('advanceMethod').value,
                    reference: document.getElementById('advanceReference').value,
                    balanceDueDate: document.getElementById('balanceDueDate').value,
                    notes: document.getElementById('advanceNotes').value,
                    balanceAmount: formData.totalAmount - advanceAmount
                };
            }

            // Add installment information if applicable
            if (paymentTerms === 'installments') {
                const installmentItems = document.querySelectorAll('.installment-item');
                formData.installments = [];
                
                installmentItems.forEach((item, index) => {
                    const inputs = item.querySelectorAll('input, select');
                    const amount = parseFloat(inputs[0].value) || 0;
                    const percentage = parseFloat(inputs[1].value) || 0;
                    const date = inputs[2].value;
                    const method = inputs[3].value;
                    
                    if (amount > 0 && date && method) {
                        formData.installments.push({
                            installmentNumber: index + 1,
                            amount: amount,
                            percentage: percentage,
                            dueDate: date,
                            paymentMethod: method,
                            status: 'pending' // pending, paid, overdue
                        });
                    }
                });
            }

            try {
                if (invoiceId) {
                    await updateDoc(doc(db, 'invoices', invoiceId), formData);
                    await addDoc(collection(db, 'activities'), {
                        action: `Updated ${type} ${formData.invoiceNumber}`,
                        user: currentUser.fullName || currentUser.username,
                        date: new Date().toISOString()
                    });
                } else {
                    formData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'invoices'), formData);
                    await addDoc(collection(db, 'activities'), {
                        action: `Created ${type} ${formData.invoiceNumber} for ${formData.clientName}`,
                        user: currentUser.fullName || currentUser.username,
                        date: new Date().toISOString()
                    });
                }

                closeModal('invoiceModal');
                loadInvoices();
            } catch (error) {
                alert('Error saving invoice: ' + error.message);
            }
        });

        // Helper function to load image as data URL.
        // Returns a data URL string or null if the image cannot be loaded or would taint the canvas.
        async function loadImageAsDataUrl(src) {
            if (!src) return null;
            // If already a data URL, return as-is
            if (typeof src === 'string' && src.startsWith('data:')) return src;

            // Try fetching the image as a blob first (preferred - avoids crossOrigin issues when possible)
            try {
                const resp = await fetch(src, { mode: 'cors' });
                if (resp && resp.ok) {
                    const blob = await resp.blob();
                    return await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => resolve(null);
                        reader.readAsDataURL(blob);
                    });
                }
            } catch (e) {
                // fetch may fail for file:// pages or strict CORS; fall through to image approach
                // console.warn('fetch image failed, falling back to Image element:', e);
            }

            // Fallback: attempt to load via Image with crossOrigin first. If drawing the image taints the canvas
            // the toDataURL call will throw â€” catch that and return null instead of letting it bubble up.
            return await new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width || 1;
                        canvas.height = img.height || 1;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        try {
                            const data = canvas.toDataURL('image/png');
                            resolve(data);
                        } catch (err) {
                            // Tainted canvas or other security error
                            console.warn('toDataURL failed (tainted canvas or CORS):', err);
                            resolve(null);
                        }
                    } catch (err) {
                        console.warn('drawImage failed:', err);
                        resolve(null);
                    }
                };
                img.onerror = () => {
                    // Last-resort: try an existing DOM <img> that may already be loaded (helps when page has the image)
                    try {
                        const parts = (src || '').split('?')[0].split('/');
                        const filename = parts[parts.length - 1];
                        const domImg = document.querySelector(`img[src$="${filename}"]`) || document.querySelector(`img[src="${src}"]`);
                        if (domImg && domImg.complete) {
                            try {
                                const canvas = document.createElement('canvas');
                                canvas.width = domImg.naturalWidth || domImg.width || 1;
                                canvas.height = domImg.naturalHeight || domImg.height || 1;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(domImg, 0, 0);
                                try {
                                    const data = canvas.toDataURL('image/png');
                                    resolve(data);
                                    return;
                                } catch (err) {
                                    console.warn('toDataURL failed on DOM image (tainted):', err);
                                }
                            } catch (err) {
                                console.warn('drawImage for DOM image failed:', err);
                            }
                        }
                    } catch (e) {
                        console.warn('DOM image fallback failed:', e);
                    }
                    // Last-resort: try without crossOrigin (may still taint)
                    const img2 = new Image();
                    img2.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            canvas.width = img2.width || 1;
                            canvas.height = img2.height || 1;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img2, 0, 0);
                            try {
                                const data = canvas.toDataURL('image/png');
                                resolve(data);
                            } catch (err) {
                                console.warn('toDataURL failed on fallback (tainted):', err);
                                resolve(null);
                            }
                        } catch (err) {
                            console.warn('drawImage fallback failed:', err);
                            resolve(null);
                        }
                    };
                    img2.onerror = () => resolve(null);
                    img2.src = src;
                };
                img.src = src;
            });
        }

        // Ensure jsPDF is available in module context (tries global first, then dynamic import)
        async function ensureJsPDF() {
            if (window.jspdf) return window.jspdf;
            try {
                // Try local copy first (if you add libs/jspdf.umd.min.js to the repo)
                try {
                    const localMod = await import('./libs/jspdf.umd.min.js');
                    const localObj = localMod.jspdf || localMod.default || localMod;
                    if (localObj) {
                        window.jspdf = localObj;
                        return window.jspdf;
                    }
                } catch (localErr) {
                    // local may not exist; fallback to CDN
                    // console.info('Local jsPDF not found or failed, falling back to CDN:', localErr);
                }

                // Fallback dynamic import from CDN
                const mod = await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
                // UMD may export as { jspdf: { jsPDF } } or default; normalize
                const jspdfObj = mod.jspdf || mod.default || mod;
                window.jspdf = jspdfObj;
                return window.jspdf;
            } catch (err) {
                console.error('Failed to load jsPDF dynamically:', err);
                throw err;
            }
        }

        // PDF Generation Function
        async function generateInvoicePDF(invoice) {
            try {
                // Ensure jsPDF is available (works both when included as UMD or via module dynamic import)
                const jspdf = await ensureJsPDF();
                const { jsPDF } = jspdf;
                const doc = new jsPDF();
                
                // Colors and styles
                const primaryColor = [37, 99, 235];
                const darkColor = [15, 23, 42];
                const grayColor = [100, 116, 139];
                
                // Page dimensions and margins
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const leftMargin = 20;
                const rightMargin = 20;
                const topMargin = 20;
                const bottomMargin = 30;
                const contentWidth = pageWidth - leftMargin - rightMargin;
                const maxY = pageHeight - bottomMargin;
                
                let currentPage = 1;
                let totalPages = 1; // Will be updated after content is added
                
                // Helper function to format currency properly for PDF
                const formatCurrency = (amount) => {
                    const num = parseFloat(amount);
                    if (isNaN(num)) return 'Rs. 0.00';
                    const formatted = num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    return 'Rs. ' + formatted;
                };
                
                // Helper function to format number properly for PDF
                const formatNumber = (num) => {
                    const parsed = parseFloat(num);
                    if (isNaN(parsed)) return '0.00';
                    return parsed.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                };
                
                // Load logo (try multiple methods but don't fail PDF generation if unavailable)
                let logoImg = null;
                try {
                    logoImg = await loadImageAsDataUrl('ambivare.png');
                    if (!logoImg) {
                        // try absolute URL
                        const logoUrl = new URL('ambivare.png', window.location.href).href;
                        logoImg = await loadImageAsDataUrl(logoUrl);
                    }
                } catch (e) {
                    console.warn('Logo load attempted and failed:', e);
                    logoImg = null;
                }

                // Final fallback: try a pre-embedded local file containing the base64 data URI
                if (!logoImg) {
                    try {
                        const resp = await fetch('./libs/embedded_logo.txt');
                        if (resp && resp.ok) {
                            logoImg = await resp.text();
                        }
                    } catch (e) {
                        // ignore
                    }
                }
                
                // Function to add page header
                const addPageHeader = (pageNum) => {
                    // Header: Company name (left) and Invoice/Quotation title (right) to avoid overlap
                    const companyName = companySettings.name || 'Avant Elevators';
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(18);
                    doc.setTextColor(...primaryColor);
                    doc.text(companyName, 20, 25);
                    
                    // If logo found, draw it below company name. If not, proceed (PDF will render without logo).
                    if (logoImg && pageNum === 1) {
                        try {
                            // Place logo below company name at y=30, with size 35x15
                            doc.addImage(logoImg, 'PNG', 20, 30, 25, 25);
                        } catch (e) {
                            console.warn('Adding logo to PDF failed:', e);
                        }
                    }
                    
                    if (pageNum === 1) {
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(10);
                        doc.setTextColor(...grayColor);
                        // Adjust Y position based on whether logo is present
                        let detailsY = logoImg ? 50 : 35;
                        if (companySettings.address) {
                            doc.text(companySettings.address, 20, detailsY);
                            detailsY += 7;
                        }
                        if (companySettings.phone || companySettings.email) {
                            doc.text(`${companySettings.phone || ''} | ${companySettings.email || ''}`, 20, detailsY);
                            detailsY += 7;
                        }
                        if (companySettings.gst) {
                            doc.text(`GST: ${companySettings.gst}`, 20, detailsY);
                        }
                    }

                    // Invoice/Quotation Title
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(16);
                    doc.setTextColor(...darkColor);
                    const title = invoice.type === 'quotation' ? 'QUOTATION' : 'INVOICE';
                    // Right-align the title to avoid overlapping long company names
                    doc.text(title, 190, 25, { align: 'right' });

                    if (pageNum === 1) {
                        // Invoice details box (right column)
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${title} #: ${invoice.invoiceNumber}`, 190, 35, { align: 'right' });
                        doc.text(`Date: ${new Date(invoice.invoiceDate).toLocaleDateString('en-GB')}`, 190, 42, { align: 'right' });
                        if (invoice.dueDate) {
                            doc.text(`Due Date: ${new Date(invoice.dueDate).toLocaleDateString('en-GB')}`, 190, 49, { align: 'right' });
                        }
                        if (invoice.poNumber) {
                            doc.text(`PO #: ${invoice.poNumber}`, 190, 56, { align: 'right' });
                        }
                    } else {
                        // On continuation pages, show invoice number and page info
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${title} #: ${invoice.invoiceNumber}`, 190, 35, { align: 'right' });
                        doc.text(`Page ${pageNum}`, 190, 42, { align: 'right' });
                    }
                };
                
                // Function to add page footer
                const addPageFooter = (pageNum, totalPages) => {
                    doc.setFontSize(8);
                    doc.setTextColor(...grayColor);
                    doc.text('This is a computer-generated document.', leftMargin, pageHeight - 15);
                    doc.text(`Page ${pageNum} of ${totalPages}`, pageWidth / 2, pageHeight - 15, { align: 'center' });
                    doc.text(`Generated on ${new Date().toLocaleDateString('en-GB')}`, pageWidth - rightMargin, pageHeight - 15, { align: 'right' });
                };
                
                // Function to check if new page is needed
                const checkNewPage = (requiredSpace, isForTable = false) => {
                    if (yPos + requiredSpace > maxY) {
                        // Add footer to current page
                        addPageFooter(currentPage, '?');
                        
                        doc.addPage();
                        currentPage++;
                        addPageHeader(currentPage);
                        
                        if (isForTable) {
                            // Add table header on new page
                            yPos = 60;
                            addTableHeader();
                        } else {
                            yPos = 50;
                        }
                        
                        return true;
                    }
                    return false;
                };
                
                // Function to add table header
                const addTableHeader = () => {
                    // Table header
                    doc.setFillColor(248, 250, 252);
                    doc.rect(20, yPos - 5, 170, 12, 'F');
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(...darkColor);
                    
                    doc.text('#', 25, yPos + 2);
                    doc.text('Description', 35, yPos + 2);
                    doc.text('Qty', 115, yPos + 2);
                    doc.text('Unit', 130, yPos + 2);
                    doc.text('Rate', 145, yPos + 2);
                    doc.text('Amount', 165, yPos + 2);
                    
                    yPos += 15;
                };

                // Start first page
                addPageHeader(1);
                
                // Bill To section - adjust Y position based on whether we have logo
                let yPos = logoImg ? 80 : 70;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(...darkColor);
                doc.text('BILL TO:', 20, yPos);
                
                yPos += 8;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text(invoice.clientName, 20, yPos);
                
                yPos += 6;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                
                if (invoice.clientAddress) {
                    const addressLines = invoice.clientAddress.split('\n');
                    addressLines.forEach(line => {
                        checkNewPage(10);
                        doc.text(line, 20, yPos);
                        yPos += 5;
                    });
                }
                
                if (invoice.clientPhone) {
                    checkNewPage(10);
                    doc.text(`Phone: ${invoice.clientPhone}`, 20, yPos);
                    yPos += 5;
                }
                
                if (invoice.clientEmail) {
                    checkNewPage(10);
                    doc.text(`Email: ${invoice.clientEmail}`, 20, yPos);
                    yPos += 5;
                }
                
                if (invoice.clientGST) {
                    checkNewPage(10);
                    doc.text(`GST: ${invoice.clientGST}`, 20, yPos);
                    yPos += 5;
                }

                // Items table
                yPos += 15;
                checkNewPage(30, true);
                const tableStartY = yPos;
                
                addTableHeader();

                // Table items
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                
                invoice.items.forEach((item, index) => {
                    // Calculate required space for this item
                    const description = String(item.description);
                    const wrappedText = doc.splitTextToSize(description, 75);
                    const itemHeight = wrappedText.length > 1 ? 16 : 12;
                    
                    // Check if we need a new page
                    checkNewPage(itemHeight, true);
                    
                    // Alternating row background
                    if (index % 2 === 0) {
                        doc.setFillColor(249, 250, 251);
                        doc.rect(20, yPos - 5, 170, itemHeight - 2, 'F');
                    }
                    
                    doc.setTextColor(...darkColor);
                    doc.text(String(index + 1), 25, yPos);
                    
                    // Wrap long descriptions
                    if (description.length > 35) {
                        doc.text(wrappedText[0], 35, yPos);
                        if (wrappedText.length > 1) {
                            doc.setFontSize(8);
                            doc.text(wrappedText[1], 35, yPos + 4);
                            doc.setFontSize(9);
                        }
                    } else {
                        doc.text(description, 35, yPos);
                    }
                    
                    // Format numbers properly
                    doc.text(String(item.quantity), 115, yPos);
                    doc.text(String(item.unit), 130, yPos);
                    doc.text(formatNumber(item.rate), 145, yPos);
                    doc.text(formatNumber(item.amount), 165, yPos);
                    
                    yPos += itemHeight;
                });

                // Totals section
                yPos += 10;
                checkNewPage(50); // Reserve space for totals
                
                doc.setDrawColor(226, 232, 240);
                doc.line(120, yPos - 5, 190, yPos - 5);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                
                doc.text('Subtotal:', 130, yPos);
                doc.text(formatCurrency(invoice.subtotal), 165, yPos);
                yPos += 8;
                
                if (invoice.discountPercent > 0) {
                    doc.text(`Discount (${invoice.discountPercent}%):`, 130, yPos);
                    doc.text('-' + formatCurrency(invoice.discountAmount), 165, yPos);
                    yPos += 8;
                }
                
                if (invoice.gstPercent > 0) {
                    doc.text(`GST (${invoice.gstPercent}%):`, 130, yPos);
                    doc.text(formatCurrency(invoice.gstAmount), 165, yPos);
                    yPos += 8;
                }
                
                // Total line
                doc.setDrawColor(226, 232, 240);
                doc.line(120, yPos + 2, 190, yPos + 2);
                yPos += 8;
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(...darkColor);
                doc.text('TOTAL:', 130, yPos);
                doc.text(formatCurrency(invoice.totalAmount), 165, yPos);

                // Advance Payment Section
                if (invoice.paymentTerms === 'advance' && invoice.advancePayment) {
                    yPos += 12;
                    
                    // Advance payment header
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(...primaryColor);
                    doc.text('ADVANCE PAYMENT DETAILS:', 130, yPos);
                    yPos += 8;
                    
                    // Advance payment details
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(...grayColor);
                    
                    const advanceAmount = parseFloat(invoice.advancePayment.amount) || 0;
                    doc.text('Advance Paid:', 130, yPos);
                    doc.text('-' + formatCurrency(advanceAmount), 165, yPos);
                    yPos += 8;
                    
                    if (invoice.advancePayment.date) {
                        doc.text('Payment Date:', 130, yPos);
                        doc.text(new Date(invoice.advancePayment.date).toLocaleDateString(), 165, yPos);
                        yPos += 8;
                    }
                    
                    if (invoice.advancePayment.method) {
                        doc.text('Payment Method:', 130, yPos);
                        doc.text(invoice.advancePayment.method, 165, yPos);
                        yPos += 8;
                    }
                    
                    if (invoice.advancePayment.reference) {
                        doc.text('Reference:', 130, yPos);
                        doc.text(invoice.advancePayment.reference, 165, yPos);
                        yPos += 8;
                    }
                    
                    // Balance due calculation
                    const balanceDue = invoice.totalAmount - advanceAmount;
                    
                    // Balance due line with highlight
                    doc.setDrawColor(226, 232, 240);
                    doc.line(120, yPos + 2, 190, yPos + 2);
                    yPos += 10;
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.setTextColor(...primaryColor);
                    doc.text('BALANCE DUE:', 130, yPos);
                    doc.text(formatCurrency(balanceDue), 165, yPos);
                    
                    if (invoice.advancePayment.balanceDueDate) {
                        yPos += 8;
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(10);
                        doc.setTextColor(...grayColor);
                        doc.text('Due Date:', 130, yPos);
                        doc.text(new Date(invoice.advancePayment.balanceDueDate).toLocaleDateString(), 165, yPos);
                    }
                }

                // Installment Payment Section
                if (invoice.paymentTerms === 'installments' && invoice.installments && invoice.installments.length > 0) {
                    yPos += 12;
                    
                    // Installments header
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(...primaryColor);
                    doc.text('INSTALLMENT SCHEDULE:', 130, yPos);
                    yPos += 8;
                    
                    // Each installment
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(...grayColor);
                    
                    invoice.installments.forEach((installment, index) => {
                        const installmentAmount = parseFloat(installment.amount) || 0;
                        const dueDate = new Date(installment.dueDate).toLocaleDateString();
                        
                        checkNewPage(15);
                        
                        doc.text(`${index + 1}. ${installment.description || 'Installment ' + (index + 1)}:`, 130, yPos);
                        doc.text(formatCurrency(installmentAmount), 165, yPos);
                        yPos += 6;
                        
                        doc.setTextColor(...grayColor);
                        doc.text(`   Due: ${dueDate}`, 130, yPos);
                        yPos += 8;
                    });
                    
                    // Total paid in installments
                    const totalInstallments = invoice.installments.reduce((sum, inst) => sum + (parseFloat(inst.amount) || 0), 0);
                    const remainingBalance = invoice.totalAmount - totalInstallments;
                    
                    if (remainingBalance > 0) {
                        yPos += 4;
                        doc.setDrawColor(226, 232, 240);
                        doc.line(120, yPos, 190, yPos);
                        yPos += 8;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(10);
                        doc.setTextColor(...primaryColor);
                        doc.text('REMAINING BALANCE:', 130, yPos);
                        doc.text(formatCurrency(remainingBalance), 165, yPos);
                    }
                }

                // Notes section
                if (invoice.notes) {
                    yPos += 20;
                    const noteLines = doc.splitTextToSize(invoice.notes, 170);
                    checkNewPage(10 + (noteLines.length * 6));
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(...darkColor);
                    doc.text('Notes:', 20, yPos);
                    
                    yPos += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...grayColor);
                    noteLines.forEach(line => {
                        doc.text(line, 20, yPos);
                        yPos += 6;
                    });
                }

                // Bank details
                if (companySettings.bankDetails) {
                    yPos += 15;
                    const bankLines = doc.splitTextToSize(companySettings.bankDetails, 170);
                    checkNewPage(10 + (bankLines.length * 6));
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(...darkColor);
                    doc.text('Bank Details:', 20, yPos);
                    
                    yPos += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...grayColor);
                    bankLines.forEach(line => {
                        doc.text(line, 20, yPos);
                        yPos += 6;
                    });
                }

                // Update total pages and add footers
                totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    addPageFooter(i, totalPages);
                }

                // Save PDF
                const fileName = `${invoice.type}_${invoice.invoiceNumber}_${invoice.clientName.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
            } catch (error) {
                console.error('PDF generation error:', error);
                throw error;
            }
        }

        window.filterLocation = (location) => {
            // Handle service-van special case for element IDs
            const locationId = location === 'service-van' ? 'ServiceVan' : location.charAt(0).toUpperCase() + location.slice(1);
            const tableId = location === 'service-van' ? 'serviceVanList' : `${location}List`;
            
            const searchValue = document.getElementById(`search${locationId}`).value.toLowerCase();
            const categoryValue = document.getElementById(`categoryFilter${locationId}`).value;
            const statusValue = document.getElementById(`statusFilter${locationId}`).value;
            
            const rows = document.querySelectorAll(`#${tableId} tr`);
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const category = row.dataset.category || '';
                const status = row.dataset.status || '';
                
                const matchesSearch = text.includes(searchValue);
                const matchesCategory = !categoryValue || category === categoryValue;
                const matchesStatus = !statusValue || status === statusValue;
                
                row.style.display = (matchesSearch && matchesCategory && matchesStatus) ? '' : 'none';
            });
        };

        window.filterProjects = () => {
            const searchValue = document.getElementById('searchProjects').value.toLowerCase();
            const statusValue = document.getElementById('projectStatusFilter').value;
            
            const rows = document.querySelectorAll('#projectList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const status = row.dataset.status || '';
                
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusValue || status === statusValue;
                
                row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
            });
        };

        window.filterMaintenance = () => {
            const searchValue = document.getElementById('searchMaintenance').value.toLowerCase();
            const statusValue = document.getElementById('maintenanceStatusFilter').value;
            const priorityValue = document.getElementById('maintenancePriorityFilter').value;
            const assigneeValue = document.getElementById('maintenanceAssigneeFilter').value;
            
            const rows = document.querySelectorAll('#maintenanceList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const status = row.dataset.status || '';
                const priority = row.dataset.priority || '';
                
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusValue || status === statusValue;
                const matchesPriority = !priorityValue || priority === priorityValue;
                const matchesAssignee = !assigneeValue || text.includes(assigneeValue.toLowerCase());
                
                row.style.display = (matchesSearch && matchesStatus && matchesPriority && matchesAssignee) ? '' : 'none';
            });
        };

        window.filterActivities = () => {
            const searchValue = document.getElementById('searchActivities').value.toLowerCase();
            const dateRange = document.getElementById('activityDateFilter').value;
            const userFilter = document.getElementById('activityUserFilter').value;
            
            const now = new Date();
            const rows = document.querySelectorAll('#activityList tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const user = row.dataset.user || '';
                const dateStr = row.dataset.date || '';
                const date = new Date(dateStr);
                
                const matchesSearch = text.includes(searchValue);
                const matchesUser = !userFilter || user === userFilter;
                
                let matchesDate = true;
                if (dateRange !== 'all') {
                    const dayMs = 24 * 60 * 60 * 1000;
                    const diff = now - date;
                    
                    switch(dateRange) {
                        case 'today':
                            matchesDate = diff < dayMs;
                            break;
                        case 'week':
                            matchesDate = diff < 7 * dayMs;
                            break;
                        case 'month':
                            matchesDate = diff < 30 * dayMs;
                            break;
                        case 'quarter':
                            matchesDate = diff < 90 * dayMs;
                            break;
                        case 'halfyear':
                            matchesDate = diff < 180 * dayMs;
                            break;
                        case 'year':
                            matchesDate = diff < 365 * dayMs;
                            break;
                    }
                }
                
                row.style.display = (matchesSearch && matchesUser && matchesDate) ? '' : 'none';
            });
        };

        window.filterUsers = () => {
            const search = document.getElementById('searchUsers').value.toLowerCase();
            const rows = document.querySelectorAll('#usersList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        // PDF EXPORT FUNCTIONS - IMPROVED AND FILTERED

        window.exportLocationPDF = async (location) => {
            const jspdf = await ensureJsPDF();
            const { jsPDF } = jspdf;
            const doc = new jsPDF();
            // Try to embed local logo (non-fatal if it fails)
            let logoImg = null;
            try {
                logoImg = await loadImageAsDataUrl('ambivare.png');
                if (!logoImg) {
                    const logoUrl = new URL('ambivare.png', window.location.href).href;
                    logoImg = await loadImageAsDataUrl(logoUrl);
                }
            } catch (err) {
                console.warn('Could not load logo for location PDF:', err);
            }
            // Fallback to local embedded base64 file
            if (!logoImg) {
                try {
                    const resp = await fetch('./libs/embedded_logo.txt');
                    if (resp && resp.ok) logoImg = await resp.text();
                } catch (e) {
                    // ignore
                }
            }
            
            const filteredItems = getFilteredLocationItems(location);
            
            // Header with company branding
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            // If logo exists, draw it on the header (left) then center the title
            if (logoImg) {
                try { doc.addImage(logoImg, 'PNG', 18, 7, 20, 20); } catch (e) { console.warn('addImage failed:', e); }
            }
            doc.text('AVANT ELEVATORS', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`${location.toUpperCase()} INVENTORY REPORT`, 105, 26, { align: 'center' });
            
            // Report metadata
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 45);
            doc.text(`By: ${currentUser.fullName || currentUser.username}`, 20, 52);
            doc.text(`Total Items: ${filteredItems.length}`, 20, 59);
            
            // Add filter information
            const searchValue = document.getElementById(`search${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            const categoryValue = document.getElementById(`categoryFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            const statusValue = document.getElementById(`statusFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            
            let filterText = 'Filters Applied: ';
            const filters = [];
            if (searchValue) filters.push(`Search: "${searchValue}"`);
            if (categoryValue) filters.push(`Category: ${categoryValue}`);
            if (statusValue) filters.push(`Status: ${statusValue}`);
            
            if (filters.length > 0) {
                doc.setFontSize(9);
                doc.setTextColor(100, 116, 139);
                doc.text(filterText + filters.join(', '), 20, 66);
            }
            
            doc.setDrawColor(226, 232, 240);
            doc.setLineWidth(0.5);
            doc.line(20, 72, 190, 72);
            
            // Table header
            let y = 82;
            doc.setFillColor(248, 250, 252);
            doc.rect(20, y - 7, 170, 10, 'F');
            
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('#', 22, y);
            doc.text('Item Name', 32, y);
            doc.text('Category', 95, y);
            doc.text('Quantity', 135, y);
            doc.text('Status', 165, y);
            
            doc.setDrawColor(226, 232, 240);
            doc.line(20, y + 2, 190, y + 2);
            
            y += 10;
            
            // Table content
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            if (filteredItems.length === 0) {
                doc.setTextColor(100, 116, 139);
                doc.text('No items match the current filters.', 105, y + 10, { align: 'center' });
            } else {
                filteredItems.forEach((item, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                        
                        // Repeat header on new page
                        doc.setFillColor(248, 250, 252);
                        doc.rect(20, y - 7, 170, 10, 'F');
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(15, 23, 42);
                        doc.text('#', 22, y);
                        doc.text('Item Name', 32, y);
                        doc.text('Category', 95, y);
                        doc.text('Quantity', 135, y);
                        doc.text('Status', 165, y);
                        doc.line(20, y + 2, 190, y + 2);
                        y += 10;
                        doc.setFont(undefined, 'normal');
                    }
                    
                    const stockText = item.quantity < 50 ? 'Low' : item.quantity < 200 ? 'Medium' : 'Good';
                    const stockColor = item.quantity < 50 ? [220, 38, 38] : item.quantity < 200 ? [234, 88, 12] : [22, 163, 74];
                    
                    // Alternating row background
                    if (index % 2 === 0) {
                        doc.setFillColor(249, 250, 251);
                        doc.rect(20, y - 6, 170, 8, 'F');
                    }
                    
                    doc.setTextColor(15, 23, 42);
                    doc.text(`${index + 1}`, 22, y);
                    
                    // Truncate long names
                    let itemName = item.name.length > 35 ? item.name.substring(0, 32) + '...' : item.name;
                    doc.text(itemName, 32, y);
                    
                    doc.setTextColor(100, 116, 139);
                    doc.text(item.category, 95, y);
                    
                    doc.setTextColor(15, 23, 42);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${item.quantity} ${item.unit}`, 135, y);
                    
                    doc.setTextColor(...stockColor);
                    doc.text(stockText, 165, y);
                    
                    doc.setFont(undefined, 'normal');
                    
                    // Add description if exists
                    if (item.description) {
                        y += 5;
                        doc.setFontSize(8);
                        doc.setTextColor(100, 116, 139);
                        const desc = item.description.length > 70 ? item.description.substring(0, 67) + '...' : item.description;
                        doc.text(desc, 32, y);
                        doc.setFontSize(9);
                        y += 3;
                    }
                    
                    y += 8;
                });
            }
            
            // Summary section at bottom of last page
            if (filteredItems.length > 0) {
                const goodStock = filteredItems.filter(i => i.quantity >= 200).length;
                const mediumStock = filteredItems.filter(i => i.quantity >= 50 && i.quantity < 200).length;
                const lowStock = filteredItems.filter(i => i.quantity < 50).length;
                
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                y += 10;
                doc.setDrawColor(226, 232, 240);
                doc.line(20, y, 190, y);
                y += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(15, 23, 42);
                doc.text('SUMMARY', 20, y);
                
                y += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(22, 163, 74);
                doc.text(`Good Stock: ${goodStock} items`, 25, y);
                
                y += 7;
                doc.setTextColor(234, 88, 12);
                doc.text(`Medium Stock: ${mediumStock} items`, 25, y);
                
                y += 7;
                doc.setTextColor(220, 38, 38);
                doc.text(`Low Stock: ${lowStock} items`, 25, y);
            }
            
            // Footer on all pages
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 116, 139);
                doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                doc.text('Avant Elevators - Confidential', 20, 290);
            }
            
            doc.save(`${location}_inventory_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        window.exportProjectsPDF = async () => {
            const jspdf = await ensureJsPDF();
            const { jsPDF } = jspdf;
            const doc = new jsPDF();
            let logoImg = null;
            try {
                logoImg = await loadImageAsDataUrl('ambivare.png');
                if (!logoImg) {
                    const logoUrl = new URL('ambivare.png', window.location.href).href;
                    logoImg = await loadImageAsDataUrl(logoUrl);
                }
            } catch (err) {
                console.warn('Could not load logo for projects PDF:', err);
            }
            if (!logoImg) {
                try { const resp = await fetch('./libs/embedded_logo.txt'); if (resp && resp.ok) logoImg = await resp.text(); } catch (e) {}
            }
            
            const filteredProjects = getFilteredProjects();
            
            // Header
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            if (logoImg) {
                try { doc.addImage(logoImg, 'PNG', 18, 7, 20, 20); } catch (e) { console.warn('addImage failed:', e); }
            }
            doc.text('AVANT ELEVATORS', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('PROJECTS REPORT', 105, 26, { align: 'center' });
            
            // Metadata
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 45);
            doc.text(`By: ${currentUser.fullName || currentUser.username}`, 20, 52);
            doc.text(`Total Projects: ${filteredProjects.length}`, 20, 59);
            
            // Filter info
            const searchValue = document.getElementById('searchProjects').value;
            const statusValue = document.getElementById('projectStatusFilter').value;
            
            if (searchValue || statusValue) {
                doc.setFontSize(9);
                doc.setTextColor(100, 116, 139);
                const filters = [];
                if (searchValue) filters.push(`Search: "${searchValue}"`);
                if (statusValue) filters.push(`Status: ${statusValue}`);
                doc.text('Filters Applied: ' + filters.join(', '), 20, 66);
            }
            
            doc.setDrawColor(226, 232, 240);
            doc.setLineWidth(0.5);
            doc.line(20, 72, 190, 72);
            
            let y = 82;
            
            if (filteredProjects.length === 0) {
                doc.setTextColor(100, 116, 139);
                doc.text('No projects match the current filters.', 105, y + 10, { align: 'center' });
            } else {
                filteredProjects.forEach((project, index) => {
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    // Project header box
                    doc.setFillColor(248, 250, 252);
                    doc.rect(20, y - 2, 170, 8, 'F');
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(37, 99, 235);
                    doc.text(`${index + 1}. ${project.name}`, 22, y + 4);
                    
                    // Status badge
                    const statusColor = project.status === 'Active' ? [22, 163, 74] : 
                                      project.status === 'Completed' ? [37, 99, 235] : [100, 116, 139];
                    doc.setTextColor(...statusColor);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text(project.status.toUpperCase(), 180, y + 4);
                    
                    y += 12;
                    
                    // Project details
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(15, 23, 42);
                    
                    doc.setFont(undefined, 'bold');
                    doc.text('Code:', 25, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(project.code, 45, y);
                    
                    y += 6;
                    doc.setFont(undefined, 'bold');
                    doc.text('Client:', 25, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(project.client || 'N/A', 45, y);
                    
                    if (project.description) {
                        y += 6;
                        doc.setFont(undefined, 'bold');
                        doc.text('Description:', 25, y);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(100, 116, 139);
                        const desc = project.description.length > 70 ? project.description.substring(0, 67) + '...' : project.description;
                        doc.text(desc, 25, y + 5);
                        doc.setTextColor(15, 23, 42);
                        y += 5;
                    }
                    
                    // Allocated items
                    const items = project.items || [];
                    if (items.length > 0) {
                        y += 8;
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(10);
                        doc.setTextColor(37, 99, 235);
                        doc.text('Allocated Items:', 25, y);
                        
                        y += 6;
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(15, 23, 42);
                        
                        items.forEach((item) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            doc.text(`â€¢ ${item.name}: ${item.quantity} ${item.unit} (${item.location})`, 30, y);
                            y += 5;
                        });
                    }
                    
                    y += 8;
                    doc.setDrawColor(226, 232, 240);
                    doc.line(20, y, 190, y);
                    y += 10;
                });
            }
            
            // Summary
            if (filteredProjects.length > 0) {
                const activeCount = filteredProjects.filter(p => p.status === 'Active').length;
                const completedCount = filteredProjects.filter(p => p.status === 'Completed').length;
                const onHoldCount = filteredProjects.filter(p => p.status === 'On Hold').length;
                
                if (y > 260) {
                    doc.addPage();
                    y = 20;
                }
                
                y += 5;
                doc.setDrawColor(226, 232, 240);
                doc.line(20, y, 190, y);
                y += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(15, 23, 42);
                doc.text('PROJECT SUMMARY', 20, y);
                
                y += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(22, 163, 74);
                doc.text(`Active Projects: ${activeCount}`, 25, y);
                
                y += 7;
                doc.setTextColor(37, 99, 235);
                doc.text(`Completed Projects: ${completedCount}`, 25, y);
                
                y += 7;
                doc.setTextColor(100, 116, 139);
                doc.text(`On Hold Projects: ${onHoldCount}`, 25, y);
            }
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 116, 139);
                doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                doc.text('Avant Elevators - Confidential', 20, 290);
            }
            
            doc.save(`projects_report_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        window.exportActivitiesPDF = async (period) => {
            const jspdf = await ensureJsPDF();
            const { jsPDF } = jspdf;
            const doc = new jsPDF();
            let logoImg = null;
            try {
                logoImg = await loadImageAsDataUrl('ambivare.png');
                if (!logoImg) {
                    const logoUrl = new URL('ambivare.png', window.location.href).href;
                    logoImg = await loadImageAsDataUrl(logoUrl);
                }
            } catch (err) {
                console.warn('Could not load logo for activities PDF:', err);
            }
            if (!logoImg) {
                try { const resp = await fetch('./libs/embedded_logo.txt'); if (resp && resp.ok) logoImg = await resp.text(); } catch (e) {}
            }
            
            // Filter activities based on period
            const now = new Date();
            let filteredActivities = [];
            let periodText = '';
            const dayMs = 24 * 60 * 60 * 1000;
            
            switch(period) {
                case 'day':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < dayMs);
                    periodText = 'Today';
                    break;
                case 'week':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 7 * dayMs);
                    periodText = 'This Week';
                    break;
                case 'month':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 30 * dayMs);
                    periodText = 'This Month';
                    break;
                case 'quarter':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 90 * dayMs);
                    periodText = 'This Quarter';
                    break;
                case 'halfyear':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 180 * dayMs);
                    periodText = 'Last 6 Months';
                    break;
                case 'year':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 365 * dayMs);
                    periodText = 'This Year';
                    break;
                default:
                    filteredActivities = [...activities];
                    periodText = 'All Time';
            }
            
            // Apply current UI filters
            const searchValue = document.getElementById('searchActivities').value.toLowerCase();
            const userFilter = document.getElementById('activityUserFilter').value;
            
            if (searchValue || userFilter) {
                filteredActivities = filteredActivities.filter(act => {
                    const matchesSearch = !searchValue || act.action.toLowerCase().includes(searchValue);
                    const matchesUser = !userFilter || act.user === userFilter;
                    return matchesSearch && matchesUser;
                });
            }
            
            // Header
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            if (logoImg) {
                try { doc.addImage(logoImg, 'PNG', 18, 7, 20, 20); } catch (e) { console.warn('addImage failed:', e); }
            }
            doc.text('AVANT ELEVATORS', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('ACTIVITY LOG REPORT', 105, 26, { align: 'center' });
            
            // Metadata
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.text(`Period: ${periodText}`, 20, 45);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 52);
            doc.text(`By: ${currentUser.fullName || currentUser.username}`, 20, 59);
            doc.text(`Total Activities: ${filteredActivities.length}`, 20, 66);
            
            // Filter info
            if (searchValue || userFilter) {
                doc.setFontSize(9);
                doc.setTextColor(100, 116, 139);
                const filters = [];
                if (searchValue) filters.push(`Search: "${searchValue}"`);
                if (userFilter) filters.push(`User: ${userFilter}`);
                doc.text('Filters Applied: ' + filters.join(', '), 20, 73);
            }
            
            doc.setDrawColor(226, 232, 240);
            doc.setLineWidth(0.5);
            doc.line(20, 79, 190, 79);
            
            // Table header
            let y = 89;
            doc.setFillColor(248, 250, 252);
            doc.rect(20, y - 7, 170, 10, 'F');
            
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('#', 22, y);
            doc.text('Date & Time', 30, y);
            doc.text('User', 75, y);
            doc.text('Action', 105, y);
            
            doc.setDrawColor(226, 232, 240);
            doc.line(20, y + 2, 190, y + 2);
            
            y += 10;
            
            // Table content
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            if (filteredActivities.length === 0) {
                doc.setTextColor(100, 116, 139);
                doc.text(`No activities recorded for ${periodText.toLowerCase()}.`, 105, y + 10, { align: 'center' });
            } else {
                filteredActivities.forEach((activity, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                        
                        // Repeat header on new page
                        doc.setFillColor(248, 250, 252);
                        doc.rect(20, y - 7, 170, 10, 'F');
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(15, 23, 42);
                        doc.text('#', 22, y);
                        doc.text('Date & Time', 30, y);
                        doc.text('User', 75, y);
                        doc.text('Action', 105, y);
                        doc.line(20, y + 2, 190, y + 2);
                        y += 10;
                        doc.setFont(undefined, 'normal');
                    }
                    
                    // Alternating row background
                    if (index % 2 === 0) {
                        doc.setFillColor(249, 250, 251);
                        doc.rect(20, y - 6, 170, 12, 'F');
                    }
                    
                    doc.setTextColor(15, 23, 42);
                    doc.text(`${index + 1}`, 22, y);
                    
                    const date = new Date(activity.date);
                    const dateStr = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const timeStr = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    
                    doc.setFontSize(9);
                    doc.text(dateStr, 30, y);
                    doc.setFontSize(8);
                    doc.setTextColor(100, 116, 139);
                    doc.text(timeStr, 30, y + 4);
                    
                    doc.setFontSize(9);
                    doc.setTextColor(37, 99, 235);
                    doc.setFont(undefined, 'bold');
                    doc.text(activity.user.length > 12 ? activity.user.substring(0, 10) + '..' : activity.user, 75, y);
                    
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(15, 23, 42);
                    
                    // Wrap long action text
                    const maxWidth = 80;
                    let actionText = activity.action;
                    if (actionText.length > 60) {
                        const line1 = actionText.substring(0, 60);
                        const line2 = actionText.substring(60, 120) + (actionText.length > 120 ? '...' : '');
                        doc.text(line1, 105, y);
                        doc.setFontSize(8);
                        doc.setTextColor(100, 116, 139);
                        doc.text(line2, 105, y + 4);
                        y += 4;
                    } else {
                        doc.text(actionText, 105, y);
                    }
                    
                    y += 10;
                });
            }
            
            // Summary section
            if (filteredActivities.length > 0) {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                y += 10;
                doc.setDrawColor(226, 232, 240);
                doc.line(20, y, 190, y);
                y += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(15, 23, 42);
                doc.text('ACTIVITY BREAKDOWN', 20, y);
                
                y += 10;
                
                // Count activity types
                const addedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('added')).length;
                const updatedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('updated')).length;
                const deletedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('deleted')).length;
                const usedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('used')).length;
                const returnedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('returned')).length;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                if (addedItems > 0) {
                    doc.setTextColor(22, 163, 74);
                    doc.text(`Added/Created: ${addedItems} activities`, 25, y);
                    y += 7;
                }
                
                if (updatedItems > 0) {
                    doc.setTextColor(37, 99, 235);
                    doc.text(`Updated: ${updatedItems} activities`, 25, y);
                    y += 7;
                }
                
                if (usedItems > 0) {
                    doc.setTextColor(234, 88, 12);
                    doc.text(`Used/Assigned: ${usedItems} activities`, 25, y);
                    y += 7;
                }
                
                if (returnedItems > 0) {
                    doc.setTextColor(147, 51, 234);
                    doc.text(`Returned: ${returnedItems} activities`, 25, y);
                    y += 7;
                }
                
                if (deletedItems > 0) {
                    doc.setTextColor(220, 38, 38);
                    doc.text(`Deleted: ${deletedItems} activities`, 25, y);
                    y += 7;
                }
                
                // Most active users
                const userCounts = {};
                filteredActivities.forEach(a => {
                    userCounts[a.user] = (userCounts[a.user] || 0) + 1;
                });
                
                const topUsers = Object.entries(userCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                if (topUsers.length > 0) {
                    y += 8;
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(15, 23, 42);
                    doc.text('Most Active Users:', 25, y);
                    
                    y += 7;
                    doc.setFont(undefined, 'normal');
                    topUsers.forEach(([user, count]) => {
                        doc.setTextColor(100, 116, 139);
                        doc.text(`${user}: ${count} activities`, 30, y);
                        y += 6;
                    });
                }
            }
            
            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 116, 139);
                doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                doc.text('Avant Elevators - Confidential', 20, 290);
            }
            
            doc.save(`activities_${period}_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        window.showBarcodeScanner = async (location) => {
            currentScanLocation = location;
            const modal = document.getElementById('barcodeModal');
            const permissionInfo = document.getElementById('cameraPermissionInfo');
            const scanStatus = document.getElementById('scanStatus');
            
            modal.classList.add('active');
            permissionInfo.style.display = 'block';
            scanStatus.textContent = 'Requesting camera access...';
            scanStatus.className = 'scan-status';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        focusMode: 'continuous',
                        frameRate: { ideal: 30 }
                    } 
                });
                
                const videoElement = document.getElementById('barcodeVideo');
                videoElement.srcObject = stream;
                barcodeStream = stream;
                
                permissionInfo.style.display = 'none';
                scanStatus.textContent = 'Camera ready. Position barcode in view...';
                scanStatus.className = 'scan-status scanning';
                
                await new Promise(resolve => {
                    videoElement.onloadedmetadata = () => {
                        videoElement.play();
                        resolve();
                    };
                });
                
                startBarcodeScanning();
            } catch (error) {
                console.error('Camera error:', error);
                permissionInfo.innerHTML = 'âš ï¸ Camera access denied. Please allow camera permission in your browser settings and try again.';
                permissionInfo.style.background = '#fee2e2';
                permissionInfo.style.borderColor = '#fecaca';
                permissionInfo.style.color = '#991b1b';
                scanStatus.textContent = 'Camera access failed';
                scanStatus.style.background = '#fee2e2';
                scanStatus.style.color = '#991b1b';
            }
        };

        function startBarcodeScanning() {
            scanningActive = true;
            const codeReader = new ZXing.BrowserMultiFormatReader();
            barcodeCodeReader = codeReader;
            
            const hints = new Map();
            hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
            hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                ZXing.BarcodeFormat.EAN_13,
                ZXing.BarcodeFormat.EAN_8,
                ZXing.BarcodeFormat.CODE_128,
                ZXing.BarcodeFormat.CODE_39,
                ZXing.BarcodeFormat.UPC_A,
                ZXing.BarcodeFormat.UPC_E,
                ZXing.BarcodeFormat.QR_CODE
            ]);
            
            const videoElement = document.getElementById('barcodeVideo');
            const scanStatus = document.getElementById('scanStatus');
            
            const scan = async () => {
                if (!scanningActive) return;
                
                try {
                    const result = await codeReader.decodeFromVideoElement(videoElement, hints);
                    
                    if (result) {
                        const barcode = result.text;
                        scanStatus.textContent = `âœ“ Barcode detected: ${barcode}`;
                        scanStatus.style.background = '#dcfce7';
                        scanStatus.style.color = '#166534';
                        
                        document.getElementById('barcodeResult').textContent = `Found: ${barcode}`;
                        document.getElementById('barcodeResult').style.display = 'block';
                        document.getElementById('barcodeResult').style.background = '#dcfce7';
                        document.getElementById('barcodeResult').style.color = '#166534';
                        
                        const allItems = getAllItems();
                        const item = allItems.find(i => i.barcode === barcode && i.location === currentScanLocation);
                        
                        if (item) {
                            scanStatus.textContent = `âœ“ Item found: ${item.name}`;
                            setTimeout(() => {
                                closeBarcodeScanner();
                                editInventory(item.id);
                            }, 1000);
                        } else {
                            scanStatus.textContent = `âš ï¸ Item not found in ${currentScanLocation}`;
                            scanStatus.style.background = '#fef3c7';
                            scanStatus.style.color = '#92400e';
                            
                            document.getElementById('barcodeResult').textContent = `Item not found in ${currentScanLocation} inventory. Add new item with this barcode?`;
                            document.getElementById('barcodeResult').style.background = '#fef3c7';
                            document.getElementById('barcodeResult').style.color = '#92400e';
                            
                            setTimeout(() => {
                                closeBarcodeScanner();
                                showAddInventoryModal(currentScanLocation);
                                document.getElementById('itemBarcode').value = barcode;
                            }, 2000);
                        }
                        return;
                    }
                } catch (error) {
                    if (error.name !== 'NotFoundException') {
                        console.error('Scan error:', error);
                    }
                }
                
                if (scanningActive) {
                    requestAnimationFrame(scan);
                }
            };
            
            scan();
        }

        window.closeBarcodeScanner = () => {
            scanningActive = false;
            
            if (barcodeCodeReader) {
                try {
                    barcodeCodeReader.reset();
                } catch (e) {
                    console.log('CodeReader reset error:', e);
                }
                barcodeCodeReader = null;
            }
            
            if (barcodeStream) {
                barcodeStream.getTracks().forEach(track => track.stop());
                barcodeStream = null;
            }
            
            const videoElement = document.getElementById('barcodeVideo');
            videoElement.srcObject = null;
            
            document.getElementById('barcodeResult').style.display = 'none';
            document.getElementById('barcodeResult').style.background = 'var(--bg-light)';
            document.getElementById('barcodeResult').style.color = 'var(--primary)';
            document.getElementById('cameraPermissionInfo').style.display = 'none';
            
            const scanStatus = document.getElementById('scanStatus');
            scanStatus.textContent = 'Initializing scanner...';
            scanStatus.className = 'scan-status';
            
            currentScanLocation = null;
            closeModal('barcodeModal');
        };

        window.showTab = (tab) => {
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(content => content.classList.remove('active'));
            
            const clickedTab = event ? event.target : document.querySelector(`.nav-tab[onclick="showTab('${tab}')"]`);
            if (clickedTab) clickedTab.classList.add('active');
            
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // Refresh charts when dashboard is shown
            if (tab === 'dashboard') {
                setTimeout(() => {
                    console.log('Dashboard tab shown, refreshing charts...');
                    renderCharts();
                }, 200);
            }
        };

        // Role-based access control helper
        function hideTabsForRole(tabsToHide) {
            tabsToHide.forEach(tab => {
                const tabBtn = document.querySelector(`button[onclick="showTab('${tab}')"]`);
                if (tabBtn) tabBtn.style.display = 'none';
            });
        }

        // Leads Management Functions
        async function loadLeads() {
            try {
                const snapshot = await getDocs(collection(db, 'leads'));
                leads = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLeads();
                updateLeadStats();
                populateLeadFilters();
            } catch (error) {
                console.error('Error loading leads:', error);
                // If offline, try to load from localStorage
                const cachedLeads = localStorage.getItem('cachedLeads');
                if (cachedLeads) {
                    leads = JSON.parse(cachedLeads);
                    renderLeads();
                    updateLeadStats();
                    populateLeadFilters();
                }
            }
        }

        function renderLeads() {
            const tbody = document.getElementById('leadsList');
            if (!tbody) return;
            
            if (leads.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><div class="empty-state-icon">ðŸŽ¯</div><p>No leads yet. Click "Add Lead" to get started.</p></td></tr>';
                return;
            }

            tbody.innerHTML = leads.map(lead => {
                const statusClass = getStatusClass(lead.status);
                const priorityClass = getPriorityClass(lead.priority);
                const isOverdue = isLeadOverdue(lead);
                
                return `
                    <tr data-status="${lead.status}" data-priority="${lead.priority}" data-assigned="${lead.assignedTo}">
                        <td>
                            <strong>${lead.name}</strong>
                            ${lead.designation ? `<br><small style="color: var(--text-secondary);">${lead.designation}</small>` : ''}
                            <br><small style="color: var(--text-secondary);">${lead.phone}</small>
                        </td>
                        <td>
                            <strong>${lead.company}</strong>
                            ${lead.industry ? `<br><small style="color: var(--text-secondary);">${lead.industry}</small>` : ''}
                            <br><small style="color: var(--text-secondary);">${lead.city || ''}</small>
                        </td>
                        <td>
                            ${lead.email ? `ðŸ“§ ${lead.email}<br>` : ''}
                            ðŸ“ž ${lead.phone}
                            ${lead.alternatePhone ? `<br>ðŸ“± ${lead.alternatePhone}` : ''}
                        </td>
                        <td>
                            <strong>${lead.elevatorType}</strong> x ${lead.quantity}
                            ${lead.capacity ? `<br><small>${lead.capacity} kg</small>` : ''}
                            ${lead.floors ? `<br><small>${lead.floors} floors</small>` : ''}
                        </td>
                        <td>
                            ${lead.value ? `<strong>â‚¹${Number(lead.value).toLocaleString()}</strong>` : 'TBD'}
                            ${lead.budget ? `<br><small>${lead.budget}</small>` : ''}
                        </td>
                        <td>
                            <span class="badge badge-${priorityClass}">${lead.priority}</span>
                            ${isOverdue ? '<br><small style="color: var(--danger);">âš ï¸ Overdue</small>' : ''}
                        </td>
                        <td><span class="badge badge-${statusClass}">${lead.status}</span></td>
                        <td>${lead.assignedTo || 'Unassigned'}</td>
                        <td>
                            ${lead.lastContact ? new Date(lead.lastContact).toLocaleDateString() : 'Never'}
                            ${lead.nextFollowUp ? `<br><small>Next: ${new Date(lead.nextFollowUp).toLocaleDateString()}</small>` : ''}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="viewLeadDetails('${lead.id}')">View</button>
                                <button class="btn btn-secondary btn-sm" onclick="editLead('${lead.id}')">Edit</button>
                                ${canDeleteLead(lead) ? `<button class="btn btn-danger btn-sm" onclick="deleteLead('${lead.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getStatusClass(status) {
            const statusClasses = {
                'New': 'primary',
                'Contacted': 'secondary',
                'Qualified': 'warning',
                'Proposal': 'info',
                'Negotiation': 'warning',
                'Converted': 'success',
                'Lost': 'danger'
            };
            return statusClasses[status] || 'secondary';
        }

        function getPriorityClass(priority) {
            const priorityClasses = {
                'Hot': 'danger',
                'Warm': 'warning',
                'Cold': 'secondary'
            };
            return priorityClasses[priority] || 'secondary';
        }

        function isLeadOverdue(lead) {
            if (!lead.nextFollowUp) return false;
            return new Date(lead.nextFollowUp) < new Date();
        }

        function canDeleteLead(lead) {
            return currentUser.role === 'admin' || 
                   (currentUser.role === 'sales' && lead.assignedTo === currentUser.username);
        }

        function updateLeadStats() {
            if (!document.getElementById('totalLeads')) return;
            
            const totalLeads = leads.length;
            const hotLeads = leads.filter(l => l.priority === 'Hot').length;
            const convertedLeads = leads.filter(l => l.status === 'Converted').length;
            
            const monthlyRevenue = leads
                .filter(l => l.status === 'Converted' && l.value && 
                        new Date(l.updatedAt).getMonth() === new Date().getMonth())
                .reduce((sum, l) => sum + Number(l.value || 0), 0);
            
            const conversionRate = totalLeads > 0 ? ((convertedLeads / totalLeads) * 100).toFixed(1) : 0;
            
            document.getElementById('totalLeads').textContent = totalLeads;
            document.getElementById('hotLeads').textContent = hotLeads;
            document.getElementById('convertedLeads').textContent = convertedLeads;
            document.getElementById('monthlyRevenue').textContent = `â‚¹${monthlyRevenue.toLocaleString()}`;
            document.getElementById('conversionRate').textContent = `${conversionRate}%`;
        }

        function populateLeadFilters() {
            // Populate assigned filter
            const assignedFilter = document.getElementById('leadAssignedFilter');
            if (assignedFilter) {
                const salesReps = [...new Set(leads.map(l => l.assignedTo).filter(Boolean))];
                assignedFilter.innerHTML = '<option value="">All Sales Reps</option>' + 
                    salesReps.map(rep => `<option value="${rep}">${rep}</option>`).join('');
            }
            
            // Populate sales rep dropdown in lead form
            const assignedSelect = document.getElementById('leadAssignedTo');
            if (assignedSelect) {
                const salesUsers = users.filter(u => (u.role === 'sales' || u.role === 'admin') && u.status === 'active');
                assignedSelect.innerHTML = '<option value="">Select Sales Rep</option>' + 
                    salesUsers.map(u => `<option value="${u.username}">${u.fullName || u.username}</option>`).join('');
            }
        }

        window.showAddLeadModal = () => {
            document.getElementById('leadModalTitle').textContent = 'Add New Lead';
            document.getElementById('leadForm').reset();
            document.getElementById('editLeadId').value = '';
            populateLeadFilters();
            document.getElementById('leadModal').classList.add('active');
        };

        window.editLead = (id) => {
            const lead = leads.find(l => l.id === id);
            if (!lead) return;
            
            // Check permission
            if (currentUser.role !== 'admin' && currentUser.role !== 'sales') {
                alert('You do not have permission to edit leads');
                return;
            }
            
            document.getElementById('leadModalTitle').textContent = 'Edit Lead';
            document.getElementById('editLeadId').value = lead.id;
            
            // Populate form fields
            Object.keys(lead).forEach(key => {
                const element = document.getElementById('lead' + key.charAt(0).toUpperCase() + key.slice(1));
                if (element) {
                    element.value = lead[key] || '';
                }
            });

            // Populate hold information if exists
            if (lead.holdInformation) {
                document.getElementById('leadHoldReason').value = lead.holdInformation.reason || '';
                document.getElementById('leadHoldDate').value = lead.holdInformation.holdDate || '';
                document.getElementById('leadExpectedResumeDate').value = lead.holdInformation.expectedResumeDate || '';
                document.getElementById('leadHoldDuration').value = lead.holdInformation.duration || '';
                document.getElementById('leadHoldNotes').value = lead.holdInformation.notes || '';
            }

            // Toggle hold fields visibility
            setTimeout(() => {
                toggleHoldFields('lead');
            }, 100);
            
            populateLeadFilters();
            document.getElementById('leadModal').classList.add('active');
        };

        window.deleteLead = async (id) => {
            const lead = leads.find(l => l.id === id);
            if (!canDeleteLead(lead)) {
                alert('You do not have permission to delete this lead');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete lead "${lead.name}" from ${lead.company}?`)) return;
            
            try {
                if (isOnline) {
                    await deleteDoc(doc(db, 'leads', id));
                    await addDoc(collection(db, 'activities'), {
                        date: new Date().toISOString(),
                        action: `Deleted lead: ${lead.name} from ${lead.company}`,
                        user: currentUser.username
                    });
                }
                await loadLeads();
            } catch (error) {
                alert('Error deleting lead: ' + error.message);
            }
        };

        window.viewLeadDetails = (id) => {
            const lead = leads.find(l => l.id === id);
            if (!lead) return;
            
            const content = `
                <div class="lead-details">
                    <div class="detail-section">
                        <h4>ðŸ“‹ Basic Information</h4>
                        <p><strong>Name:</strong> ${lead.name}</p>
                        <p><strong>Designation:</strong> ${lead.designation || 'N/A'}</p>
                        <p><strong>Company:</strong> ${lead.company}</p>
                        <p><strong>Industry:</strong> ${lead.industry || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${lead.phone}</p>
                        <p><strong>Email:</strong> ${lead.email || 'N/A'}</p>
                        <p><strong>Address:</strong> ${lead.address}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>ðŸ—ï¸ Project Requirements</h4>
                        <p><strong>Elevator Type:</strong> ${lead.elevatorType}</p>
                        <p><strong>Quantity:</strong> ${lead.quantity}</p>
                        <p><strong>Capacity:</strong> ${lead.capacity || 'N/A'}</p>
                        <p><strong>Floors:</strong> ${lead.floors || 'N/A'}</p>
                        <p><strong>Budget:</strong> ${lead.budget || 'N/A'}</p>
                        <p><strong>Timeline:</strong> ${lead.timeline || 'N/A'}</p>
                        <p><strong>Specifications:</strong> ${lead.specifications || 'None'}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>ðŸ’¼ Business Information</h4>
                        <p><strong>Estimated Value:</strong> ${lead.value ? 'â‚¹' + Number(lead.value).toLocaleString() : 'TBD'}</p>
                        <p><strong>Success Probability:</strong> ${lead.probability || 'N/A'}%</p>
                        <p><strong>Source:</strong> ${lead.source}</p>
                        <p><strong>Priority:</strong> ${lead.priority}</p>
                        <p><strong>Status:</strong> ${lead.status}</p>
                        <p><strong>Assigned To:</strong> ${lead.assignedTo || 'Unassigned'}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>ðŸ“ Notes & Activity</h4>
                        <p>${lead.notes || 'No notes available'}</p>
                        <p><strong>Created:</strong> ${lead.createdAt ? new Date(lead.createdAt).toLocaleString() : 'N/A'}</p>
                        <p><strong>Last Updated:</strong> ${lead.updatedAt ? new Date(lead.updatedAt).toLocaleString() : 'N/A'}</p>
                    </div>
                </div>
                
                <style>
                .lead-details { max-height: 400px; overflow-y: auto; }
                .detail-section { margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; }
                .detail-section h4 { color: #1e40af; margin-bottom: 10px; }
                .detail-section p { margin: 5px 0; }
                </style>
            `;
            
            document.getElementById('leadDetailsContent').innerHTML = content;
            document.getElementById('leadDetailsModal').classList.add('active');
        };

        // Lead Activity Management Functions
        let currentActivityLeadId = null;

        window.addLeadActivity = () => {
            // Get the current lead ID from the details modal
            const leadDetailsContent = document.getElementById('leadDetailsContent').innerHTML;
            const leadIdMatch = leadDetailsContent.match(/data-lead-id="([^"]+)"/);
            
            if (!leadIdMatch) {
                // Try to find it from the currently displayed lead details
                const leadName = leadDetailsContent.match(/<strong>Name:<\/strong>\s*([^<]+)/);
                if (leadName) {
                    const lead = leads.find(l => l.name.trim() === leadName[1].trim());
                    if (lead) {
                        currentActivityLeadId = lead.id;
                    }
                }
            } else {
                currentActivityLeadId = leadIdMatch[1];
            }

            if (!currentActivityLeadId) {
                alert('Unable to identify lead. Please try again.');
                return;
            }

            // Reset form and set current date/time
            document.getElementById('leadActivityForm').reset();
            document.getElementById('currentLeadId').value = currentActivityLeadId;
            
            // Set current date/time as default
            const now = new Date();
            const localISOTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('activityDate').value = localISOTime;

            // Get lead details for auto-fill
            const lead = leads.find(l => l.id === currentActivityLeadId);
            if (lead) {
                document.getElementById('contactedPerson').value = lead.name || '';
                document.getElementById('contactDesignation').value = lead.designation || '';
            }

            // Hide all activity-specific fields
            document.querySelectorAll('.activity-specific-fields').forEach(field => {
                field.style.display = 'none';
            });

            document.getElementById('leadActivityModal').classList.add('active');
        };

        window.toggleActivityFields = () => {
            const activityType = document.getElementById('activityType').value;
            
            // Hide all activity-specific fields first
            document.querySelectorAll('.activity-specific-fields').forEach(field => {
                field.style.display = 'none';
            });

            // Show relevant fields based on activity type
            switch(activityType) {
                case 'call':
                    document.getElementById('callFields').style.display = 'block';
                    break;
                case 'meeting':
                case 'site_visit':
                case 'demo':
                    document.getElementById('meetingFields').style.display = 'block';
                    break;
                case 'proposal':
                case 'quotation':
                    document.getElementById('proposalFields').style.display = 'block';
                    break;
            }
        };

        // Handle lead activity form submission
        document.getElementById('leadActivityForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const leadId = document.getElementById('currentLeadId').value;
            if (!leadId) {
                alert('No lead selected');
                return;
            }

            // Collect activity data
            const activityData = {
                leadId: leadId,
                type: document.getElementById('activityType').value,
                date: document.getElementById('activityDate').value,
                duration: document.getElementById('activityDuration').value,
                contactedPerson: document.getElementById('contactedPerson').value,
                contactDesignation: document.getElementById('contactDesignation').value,
                description: document.getElementById('activityDescription').value,
                outcome: document.getElementById('activityOutcome').value,
                temperature: document.getElementById('leadTemperature').value,
                nextAction: document.getElementById('nextAction').value,
                nextActionDate: document.getElementById('nextActionDate').value,
                nextStepNotes: document.getElementById('nextStepNotes').value,
                internalNotes: document.getElementById('internalNotes').value,
                createdBy: currentUser.username,
                createdAt: new Date().toISOString()
            };

            // Add type-specific data
            const activityType = activityData.type;
            if (activityType === 'call') {
                activityData.callDetails = {
                    status: document.getElementById('callStatus').value,
                    nextCallDate: document.getElementById('nextCallDate').value
                };
            } else if (activityType === 'meeting' || activityType === 'site_visit' || activityType === 'demo') {
                activityData.meetingDetails = {
                    location: document.getElementById('meetingLocation').value,
                    attendees: document.getElementById('attendees').value,
                    nextMeeting: document.getElementById('nextMeeting').value
                };
            } else if (activityType === 'proposal' || activityType === 'quotation') {
                activityData.proposalDetails = {
                    amount: document.getElementById('proposalAmount').value,
                    validityPeriod: document.getElementById('validityPeriod').value,
                    reference: document.getElementById('proposalReference').value
                };
            }

            try {
                // Add unique ID for activity
                activityData.id = 'activity_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Save to Firebase if online
                if (isOnline) {
                    await addDoc(collection(db, 'leadActivities'), activityData);
                    
                    // Update lead with latest activity info
                    const lead = leads.find(l => l.id === leadId);
                    if (lead) {
                        const updateData = {
                            lastContact: new Date().toISOString(),
                            lastContactBy: currentUser.username,
                            lastActivity: activityData.type,
                            updatedAt: new Date().toISOString()
                        };

                        // Update lead temperature if specified
                        if (activityData.temperature) {
                            updateData.priority = activityData.temperature === 'hot' ? 'Hot' : 
                                                 activityData.temperature === 'warm' ? 'Warm' : 'Cold';
                        }

                        // Update lead status based on activity type
                        if (activityType === 'converted') {
                            updateData.status = 'Converted';
                        } else if (activityType === 'lost') {
                            updateData.status = 'Lost';
                        } else if (activityType === 'proposal' || activityType === 'quotation') {
                            updateData.status = 'Proposal';
                        }

                        await updateDoc(doc(db, 'leads', leadId), updateData);
                    }

                    // Log general activity
                    await addDoc(collection(db, 'activities'), {
                        date: new Date().toISOString(),
                        action: `Lead activity: ${activityData.type} for ${lead?.company} (${lead?.name})`,
                        user: currentUser.username
                    });
                }

                // Always save to localStorage for immediate display and offline backup
                const existingActivities = JSON.parse(localStorage.getItem('leadActivities_' + leadId) || '[]');
                existingActivities.unshift(activityData); // Add to beginning
                localStorage.setItem('leadActivities_' + leadId, JSON.stringify(existingActivities));

                // Close modal and refresh
                closeModal('leadActivityModal');
                await loadLeads();
                
                // Refresh lead details if modal is still open
                if (document.getElementById('leadDetailsModal').classList.contains('active')) {
                    viewLeadDetails(leadId);
                }

                alert('Activity saved successfully!');
            } catch (error) {
                console.error('Error saving activity:', error);
                alert('Error saving activity: ' + error.message);
            }
        });

        // Load and display lead activities
        async function loadLeadActivities(leadId) {
            try {
                if (!isOnline) {
                    // Try to load from localStorage when offline
                    const cachedActivities = localStorage.getItem('leadActivities_' + leadId);
                    return cachedActivities ? JSON.parse(cachedActivities) : [];
                }
                
                // Try simple query first without orderBy to avoid index issues
                const activitiesSnapshot = await getDocs(
                    query(collection(db, 'leadActivities'), where('leadId', '==', leadId))
                );
                
                const activities = activitiesSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));

                // Sort activities by date locally
                activities.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Cache activities locally
                localStorage.setItem('leadActivities_' + leadId, JSON.stringify(activities));
                
                return activities;
            } catch (error) {
                console.error('Error loading lead activities:', error);
                
                // Fallback to localStorage
                const cachedActivities = localStorage.getItem('leadActivities_' + leadId);
                return cachedActivities ? JSON.parse(cachedActivities) : [];
            }
        }

        // Update the viewLeadDetails function to include activities
        const originalViewLeadDetails = window.viewLeadDetails;
        window.viewLeadDetails = async (id) => {
            const lead = leads.find(l => l.id === id);
            if (!lead) return;
            
            console.log('Loading activities for lead:', id);
            
            // Load activities for this lead
            const activities = await loadLeadActivities(id);
            
            console.log('Activities loaded:', activities.length, activities);
            
            const content = `
                <div class="lead-details" data-lead-id="${id}">
                    <div class="detail-section">
                        <h4>ðŸ“‹ Basic Information</h4>
                        <p><strong>Name:</strong> ${lead.name}</p>
                        <p><strong>Designation:</strong> ${lead.designation || 'N/A'}</p>
                        <p><strong>Company:</strong> ${lead.company}</p>
                        <p><strong>Industry:</strong> ${lead.industry || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${lead.phone}</p>
                        <p><strong>Email:</strong> ${lead.email || 'N/A'}</p>
                        <p><strong>Address:</strong> ${lead.address}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>ðŸ—ï¸ Project Requirements</h4>
                        <p><strong>Elevator Type:</strong> ${lead.elevatorType}</p>
                        <p><strong>Quantity:</strong> ${lead.quantity}</p>
                        <p><strong>Capacity:</strong> ${lead.capacity || 'N/A'}</p>
                        <p><strong>Floors:</strong> ${lead.floors || 'N/A'}</p>
                        <p><strong>Budget:</strong> ${lead.budget || 'N/A'}</p>
                        <p><strong>Timeline:</strong> ${lead.timeline || 'N/A'}</p>
                        <p><strong>Specifications:</strong> ${lead.specifications || 'None'}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>ðŸ’¼ Business Information</h4>
                        <p><strong>Estimated Value:</strong> ${lead.value ? 'â‚¹' + Number(lead.value).toLocaleString() : 'TBD'}</p>
                        <p><strong>Success Probability:</strong> ${lead.probability || 'N/A'}%</p>
                        <p><strong>Source:</strong> ${lead.source}</p>
                        <p><strong>Priority:</strong> ${lead.priority}</p>
                        <p><strong>Status:</strong> ${lead.status}</p>
                        <p><strong>Assigned To:</strong> ${lead.assignedTo || 'Unassigned'}</p>
                    </div>
                    
                    ${lead.holdInformation ? `
                    <div class="detail-section" style="background: #fef3c7; border: 1px solid #f59e0b;">
                        <h4 style="color: #d97706;">Hold Information</h4>
                        <p><strong>Reason:</strong> ${lead.holdInformation.reason}</p>
                        <p><strong>Hold Date:</strong> ${new Date(lead.holdInformation.holdDate).toLocaleDateString()}</p>
                        <p><strong>Expected Resume:</strong> ${lead.holdInformation.expectedResumeDate ? new Date(lead.holdInformation.expectedResumeDate).toLocaleDateString() : 'TBD'}</p>
                        <p><strong>Duration:</strong> ${lead.holdInformation.duration || 'N/A'}</p>
                        <p><strong>Notes:</strong> ${lead.holdInformation.notes || 'None'}</p>
                    </div>
                    ` : ''}
                    
                    <div class="detail-section">
                        <h4>ðŸ“ Notes & Activity</h4>
                        <p>${lead.notes || 'No notes available'}</p>
                        <p><strong>Created:</strong> ${lead.createdAt ? new Date(lead.createdAt).toLocaleString() : 'N/A'}</p>
                        <p><strong>Last Updated:</strong> ${lead.updatedAt ? new Date(lead.updatedAt).toLocaleString() : 'N/A'}</p>
                        ${lead.lastContact ? `<p><strong>Last Contact:</strong> ${new Date(lead.lastContact).toLocaleString()} by ${lead.lastContactBy || 'Unknown'}</p>` : ''}
                        <p><strong>Activities Found:</strong> ${activities.length} activity(ies)</p>
                    </div>

                    <div class="detail-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4>ðŸ“ˆ Activity Timeline</h4>
                            <small style="color: #6b7280;">${activities.length} total</small>
                        </div>
                        ${activities.length > 0 ? `
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${activities.slice(0, 10).map(activity => `
                                <div style="border-left: 4px solid #3b82f6; padding: 8px; margin: 8px 0; background: white; border-radius: 4px;">
                                    <div style="font-weight: 600; color: #1e40af; margin-bottom: 4px;">
                                        ${getActivityIcon(activity.type)} ${formatActivityType(activity.type)}
                                        <span style="float: right; font-weight: normal; color: #6b7280; font-size: 12px;">
                                            ${new Date(activity.date).toLocaleDateString()}
                                        </span>
                                    </div>
                                    <div style="font-size: 14px; color: #374151;">
                                        <strong>Contact:</strong> ${activity.contactedPerson} ${activity.contactDesignation ? '(' + activity.contactDesignation + ')' : ''}<br>
                                        <strong>Description:</strong> ${activity.description}<br>
                                        ${activity.outcome ? `<strong>Outcome:</strong> ${formatActivityOutcome(activity.outcome)}<br>` : ''}
                                        ${activity.nextAction ? `<strong>Next Action:</strong> ${formatNextAction(activity.nextAction)}${activity.nextActionDate ? ' by ' + new Date(activity.nextActionDate).toLocaleDateString() : ''}<br>` : ''}
                                        ${activity.nextStepNotes ? `<strong>Notes:</strong> ${activity.nextStepNotes}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${activities.length > 10 ? `<p style="text-align: center; margin-top: 10px; color: #6b7280;">Showing last 10 activities (${activities.length} total)</p>` : ''}
                        ` : `
                        <div style="text-align: center; padding: 20px; color: #6b7280;">
                            <p>ðŸ“ No activities recorded yet</p>
                            <p style="font-size: 12px;">Click "Add Activity" below to track interactions with this lead</p>
                        </div>
                        `}
                    </div>
                </div>
                
                <style>
                .lead-details { max-height: 400px; overflow-y: auto; }
                .detail-section { margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; }
                .detail-section h4 { color: #1e40af; margin-bottom: 10px; }
                .detail-section p { margin: 5px 0; }
                </style>
            `;
            
            document.getElementById('leadDetailsContent').innerHTML = content;
            document.getElementById('leadDetailsModal').classList.add('active');
        };

        // Helper functions for formatting activity data
        function getActivityIcon(type) {
            const icons = {
                call: 'â€¢', email: 'â€¢', meeting: 'â€¢', site_visit: 'â€¢',
                proposal: 'â€¢', quotation: 'â€¢', negotiation: 'â€¢',
                follow_up: 'â€¢', demo: 'â€¢', requirement: 'â€¢',
                contract: 'â€¢', converted: 'âœ“', lost: 'âœ—', other: 'â€¢'
            };
            return icons[type] || 'â€¢';
        }

        function formatActivityType(type) {
            const types = {
                call: 'Phone Call', email: 'Email', meeting: 'Meeting',
                site_visit: 'Site Visit', proposal: 'Proposal Sent',
                quotation: 'Quotation Sent', negotiation: 'Negotiation',
                follow_up: 'Follow Up', demo: 'Product Demo',
                requirement: 'Requirement Discussion', contract: 'Contract Discussion',
                converted: 'Lead Converted', lost: 'Lead Lost', other: 'Other Activity'
            };
            return types[type] || type.charAt(0).toUpperCase() + type.slice(1);
        }

        function formatActivityOutcome(outcome) {
            const outcomes = {
                positive: 'Positive Response', interested: 'Showed Interest',
                neutral: 'Neutral Response', negative: 'Not Interested',
                needs_info: 'Requested More Information', decision_pending: 'Decision Pending',
                budget_issue: 'Budget Constraints', competitor: 'Considering Competitors'
            };
            return outcomes[outcome] || outcome;
        }

        function formatNextAction(action) {
            const actions = {
                follow_up_call: 'Follow-up Call', send_info: 'Send Information',
                schedule_meeting: 'Schedule Meeting', site_visit: 'Site Visit',
                prepare_proposal: 'Prepare Proposal', price_revision: 'Revise Pricing',
                technical_clarification: 'Technical Clarification',
                contract_preparation: 'Prepare Contract', wait_customer: 'Wait for Customer',
                no_action: 'No Further Action'
            };
            return actions[action] || action;
        }

        window.filterLeads = () => {
            const searchValue = document.getElementById('searchLeads')?.value.toLowerCase() || '';
            const statusValue = document.getElementById('leadStatusFilter')?.value || '';
            const priorityValue = document.getElementById('leadPriorityFilter')?.value || '';
            const assignedValue = document.getElementById('leadAssignedFilter')?.value || '';
            const sourceValue = document.getElementById('leadSourceFilter')?.value || '';
            
            const rows = document.querySelectorAll('#leadsList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const status = row.getAttribute('data-status');
                const priority = row.getAttribute('data-priority');
                const assigned = row.getAttribute('data-assigned');
                
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusValue || status === statusValue;
                const matchesPriority = !priorityValue || priority === priorityValue;
                const matchesAssigned = !assignedValue || assigned === assignedValue;
                const matchesSource = !sourceValue || text.includes(sourceValue.toLowerCase());
                
                row.style.display = matchesSearch && matchesStatus && matchesPriority && 
                                   matchesAssigned && matchesSource ? '' : 'none';
            });
        };

        window.exportLeadsPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt', 'a4'); // Landscape for better table fit
            
            doc.setFontSize(20);
            doc.setTextColor(37, 99, 235);
            doc.text('LEADS REPORT', 400, 40, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setTextColor(100, 116, 139);
            doc.text('Avant Elevators - Sales Department', 400, 60, { align: 'center' });
            doc.text(`Generated: ${new Date().toLocaleString()}`, 40, 90);
            
            // Summary stats
            let y = 120;
            doc.setFontSize(14);
            doc.setTextColor(15, 23, 42);
            doc.text('SUMMARY:', 40, y);
            
            y += 25;
            doc.setFontSize(10);
            const stats = [
                `Total Leads: ${leads.length}`,
                `Hot Leads: ${leads.filter(l => l.priority === 'Hot').length}`,
                `Converted: ${leads.filter(l => l.status === 'Converted').length}`,
                `Conversion Rate: ${leads.length > 0 ? ((leads.filter(l => l.status === 'Converted').length / leads.length) * 100).toFixed(1) : 0}%`
            ];
            
            stats.forEach((stat, index) => {
                doc.text(stat, 40 + (index * 150), y);
            });
            
            // Leads table
            y += 40;
            const headers = ['Name', 'Company', 'Contact', 'Type', 'Value', 'Status', 'Assigned'];
            const rowHeight = 20;
            const colWidths = [100, 120, 100, 80, 80, 70, 80];
            let x = 40;
            
            // Headers
            doc.setFont(undefined, 'bold');
            doc.setFontSize(9);
            headers.forEach((header, index) => {
                doc.text(header, x, y);
                x += colWidths[index];
            });
            
            // Data rows
            y += 15;
            doc.setFont(undefined, 'normal');
            leads.forEach(lead => {
                x = 40;
                const rowData = [
                    lead.name || '',
                    lead.company || '',
                    lead.phone || '',
                    lead.elevatorType || '',
                    lead.value ? 'â‚¹' + (Number(lead.value)/100000).toFixed(1) + 'L' : '',
                    lead.status || '',
                    lead.assignedTo || ''
                ];
                
                rowData.forEach((data, index) => {
                    const text = doc.splitTextToSize(data.toString(), colWidths[index] - 5);
                    doc.text(text, x, y);
                    x += colWidths[index];
                });
                
                y += rowHeight;
                if (y > 500) { // New page if needed
                    doc.addPage();
                    y = 40;
                }
            });
            
            doc.save(`leads_report_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        // Export hold reports for various modules
        window.exportHoldReportPDF = async (type) => {
            const jspdf = await ensureJsPDF();
            const { jsPDF } = jspdf;
            const doc = new jsPDF();

            // Try to load logo
            let logoImg = null;
            try {
                logoImg = await loadImageAsDataUrl('ambivare.png');
                if (!logoImg) {
                    const logoUrl = new URL('ambivare.png', window.location.href).href;
                    logoImg = await loadImageAsDataUrl(logoUrl);
                }
            } catch (err) {
                console.warn('Could not load logo for hold report:', err);
            }

            // Header with company branding
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            if (logoImg) {
                try { doc.addImage(logoImg, 'PNG', 18, 7, 20, 20); } catch (e) { console.warn('addImage failed:', e); }
            }
            doc.text('AVANT ELEVATORS', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`${type.toUpperCase()} ON HOLD REPORT`, 105, 26, { align: 'center' });
            
            // Report metadata
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 45);
            doc.text(`By: ${currentUser.fullName || currentUser.username}`, 20, 52);
            
            let holdItems = [];
            let headers = [];
            
            // Filter data based on type
            if (type === 'leads') {
                holdItems = leads.filter(item => item.status === 'On Hold' && item.holdInformation);
                headers = ['Lead Name', 'Company', 'Hold Reason', 'Hold Date', 'Expected Resume', 'Duration', 'Notes'];
                doc.text(`Total On Hold Leads: ${holdItems.length}`, 20, 59);
            } else if (type === 'projects') {
                holdItems = projects.filter(item => item.status === 'On Hold' && item.holdInformation);
                headers = ['Project Name', 'Client', 'Hold Reason', 'Hold Date', 'Expected Resume', 'Duration', 'Notes'];
                doc.text(`Total On Hold Projects: ${holdItems.length}`, 20, 59);
            } else if (type === 'maintenance') {
                holdItems = maintenance.filter(item => item.status === 'On Hold' && item.holdInformation);
                headers = ['Project', 'Elevator', 'Hold Reason', 'Hold Date', 'Expected Resume', 'Duration', 'Notes'];
                doc.text(`Total On Hold Maintenance: ${holdItems.length}`, 20, 59);
            }
            
            if (holdItems.length === 0) {
                doc.setFontSize(14);
                doc.setTextColor(100, 116, 139);
                doc.text(`No items are currently on hold for ${type}.`, 105, 100, { align: 'center' });
                doc.save(`${type}_hold_report_${new Date().toISOString().split('T')[0]}.pdf`);
                return;
            }
            
            // Table setup
            let y = 80;
            const pageHeight = doc.internal.pageSize.height;
            const lineHeight = 6;
            const cellPadding = 2;
            
            // Headers
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(37, 99, 235);
            
            let x = 20;
            const colWidths = type === 'maintenance' ? [35, 25, 35, 25, 25, 20, 45] : [40, 40, 35, 25, 25, 20, 45];
            
            headers.forEach((header, index) => {
                doc.text(header, x, y);
                x += colWidths[index];
            });
            
            y += lineHeight + 2;
            
            // Draw header line
            doc.setDrawColor(37, 99, 235);
            doc.line(20, y, 190, y);
            y += 4;
            
            // Data rows
            doc.setFont(undefined, 'normal');
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(8);
            
            holdItems.forEach((item, index) => {
                if (y > pageHeight - 40) {
                    doc.addPage();
                    y = 40;
                }
                
                x = 20;
                const hold = item.holdInformation;
                
                let rowData = [];
                if (type === 'leads') {
                    rowData = [
                        item.name || 'N/A',
                        item.company || 'N/A',
                        hold.reason || 'N/A',
                        hold.holdDate ? new Date(hold.holdDate).toLocaleDateString() : 'N/A',
                        hold.expectedResumeDate ? new Date(hold.expectedResumeDate).toLocaleDateString() : 'N/A',
                        hold.duration || 'N/A',
                        (hold.notes || '').substring(0, 50) + (hold.notes && hold.notes.length > 50 ? '...' : '')
                    ];
                } else if (type === 'projects') {
                    rowData = [
                        item.name || 'N/A',
                        item.client || 'N/A',
                        hold.reason || 'N/A',
                        hold.holdDate ? new Date(hold.holdDate).toLocaleDateString() : 'N/A',
                        hold.expectedResumeDate ? new Date(hold.expectedResumeDate).toLocaleDateString() : 'N/A',
                        hold.duration || 'N/A',
                        (hold.notes || '').substring(0, 50) + (hold.notes && hold.notes.length > 50 ? '...' : '')
                    ];
                } else if (type === 'maintenance') {
                    rowData = [
                        item.projectName || 'N/A',
                        item.elevatorId || 'N/A',
                        hold.reason || 'N/A',
                        hold.holdDate ? new Date(hold.holdDate).toLocaleDateString() : 'N/A',
                        hold.expectedResumeDate ? new Date(hold.expectedResumeDate).toLocaleDateString() : 'N/A',
                        hold.duration || 'N/A',
                        (hold.notes || '').substring(0, 40) + (hold.notes && hold.notes.length > 40 ? '...' : '')
                    ];
                }
                
                rowData.forEach((data, colIndex) => {
                    // Wrap text if too long
                    const text = String(data);
                    doc.text(text, x, y);
                    x += colWidths[colIndex];
                });
                
                y += lineHeight + 1;
                
                // Add separator line every 5 rows
                if ((index + 1) % 5 === 0) {
                    doc.setDrawColor(200, 200, 200);
                    doc.line(20, y, 190, y);
                    y += 2;
                }
            });
            
            // Summary section
            y += 10;
            if (y > pageHeight - 60) {
                doc.addPage();
                y = 40;
            }
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(37, 99, 235);
            doc.text('HOLD SUMMARY:', 20, y);
            
            y += 8;
            doc.setFont(undefined, 'normal');
            doc.setTextColor(15, 23, 42);
            
            // Group by hold reasons
            const reasonCounts = {};
            holdItems.forEach(item => {
                const reason = item.holdInformation?.reason || 'Unknown';
                reasonCounts[reason] = (reasonCounts[reason] || 0) + 1;
            });
            
            Object.entries(reasonCounts).forEach(([reason, count]) => {
                doc.text(`â€¢ ${reason}: ${count} items`, 25, y);
                y += 6;
            });
            
            // Footer
            const footer = `Report generated on ${new Date().toLocaleString()} | ${companySettings.name}`;
            doc.setFontSize(8);
            doc.setTextColor(100, 116, 139);
            doc.text(footer, 105, pageHeight - 10, { align: 'center' });
            
            doc.save(`${type}_hold_report_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        // Lead form submission
        document.addEventListener('DOMContentLoaded', function() {
            const leadForm = document.getElementById('leadForm');
            if (leadForm) {
                leadForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Check permissions
                    if (currentUser.role !== 'admin' && currentUser.role !== 'sales') {
                        alert('You do not have permission to create/edit leads');
                        return;
                    }
                    
                    const leadId = document.getElementById('editLeadId').value;
                    const leadData = {
                        name: document.getElementById('leadName').value,
                        designation: document.getElementById('leadDesignation').value,
                        phone: document.getElementById('leadPhone').value,
                        alternatePhone: document.getElementById('leadAlternatePhone').value,
                        email: document.getElementById('leadEmail').value,
                        company: document.getElementById('leadCompany').value,
                        industry: document.getElementById('leadIndustry').value,
                        address: document.getElementById('leadAddress').value,
                        city: document.getElementById('leadCity').value,
                        state: document.getElementById('leadState').value,
                        elevatorType: document.getElementById('leadElevatorType').value,
                        quantity: document.getElementById('leadQuantity').value,
                        capacity: document.getElementById('leadCapacity').value,
                        floors: document.getElementById('leadFloors').value,
                        specifications: document.getElementById('leadSpecifications').value,
                        budget: document.getElementById('leadBudget').value,
                        timeline: document.getElementById('leadTimeline').value,
                        value: document.getElementById('leadValue').value,
                        probability: document.getElementById('leadProbability').value,
                        source: document.getElementById('leadSource').value,
                        priority: document.getElementById('leadPriority').value,
                        status: document.getElementById('leadStatus').value,
                        assignedTo: document.getElementById('leadAssignedTo').value,
                        notes: document.getElementById('leadNotes').value,
                        updatedAt: new Date().toISOString(),
                        updatedBy: currentUser.username
                    };

                    // Add hold information if status is "On Hold"
                    if (leadData.status === 'On Hold') {
                        leadData.holdInformation = {
                            reason: document.getElementById('leadHoldReason').value,
                            holdDate: document.getElementById('leadHoldDate').value,
                            expectedResumeDate: document.getElementById('leadExpectedResumeDate').value,
                            duration: document.getElementById('leadHoldDuration').value,
                            notes: document.getElementById('leadHoldNotes').value,
                            heldBy: currentUser.username,
                            heldAt: new Date().toISOString()
                        };
                    }
                    
                    if (!leadId) {
                        leadData.createdAt = new Date().toISOString();
                        leadData.createdBy = currentUser.username;
                        leadData.lastContact = new Date().toISOString();
                    }
                    
                    try {
                        if (isOnline) {
                            if (leadId) {
                                await updateDoc(doc(db, 'leads', leadId), leadData);
                                await addDoc(collection(db, 'activities'), {
                                    date: new Date().toISOString(),
                                    action: `Updated lead: ${leadData.name} from ${leadData.company}`,
                                    user: currentUser.username
                                });
                            } else {
                                await addDoc(collection(db, 'leads'), leadData);
                                await addDoc(collection(db, 'activities'), {
                                    date: new Date().toISOString(),
                                    action: `Created new lead: ${leadData.name} from ${leadData.company}`,
                                    user: currentUser.username
                                });
                            }
                        }
                        
                        closeModal('leadModal');
                        await loadLeads();
                        // Also ensure cache is updated
                        localStorage.setItem('cachedLeads', JSON.stringify(leads));
                        alert(`Lead ${leadId ? 'updated' : 'created'} successfully!`);
                    } catch (error) {
                        alert('Error saving lead: ' + error.message);
                    }
                });
            }
        });

        window.closeModal = (modalId) => {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'userModal') {
                document.getElementById('newUsername').disabled = false;
            }
            if (modalId === 'maintenanceModal') {
                clearSignature('arrival');
                clearSignature('completion');
            }
        };

        // Signature Canvas Handling
        let isDrawing = false;
        let currentCanvas = null;

        function setupSignatureCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Set canvas size properly
            canvas.width = 400;
            canvas.height = 200;
            
            // Set drawing properties
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Fill background with white to ensure proper image generation
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Reset stroke style after filling background
            ctx.strokeStyle = '#000000';
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchend', function(e) {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                canvas.dispatchEvent(mouseEvent);
            });

            function startDrawing(e) {
                isDrawing = true;
                currentCanvas = canvas;
                const rect = canvas.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            }

            function draw(e) {
                if (!isDrawing || currentCanvas !== canvas) return;
                const rect = canvas.getBoundingClientRect();
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
            }

            function stopDrawing() {
                if (currentCanvas === canvas) {
                    isDrawing = false;
                    currentCanvas = null;
                    // Force a redraw to ensure signature is properly rendered
                    ctx.stroke();
                }
            }
        }

        window.clearSignature = (type) => {
            const canvasId = type + 'SignatureCanvas';
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                // Clear the canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // Fill with white background to ensure proper PDF generation
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // Reset stroke style
                ctx.strokeStyle = '#000000';
            }
        };

        window.toggleSignatureSection = () => {
            const status = document.getElementById('maintenanceStatus').value;
            const arrivalSection = document.getElementById('arrivalSignatureSection');
            const completionSection = document.getElementById('completionSignatureSection');
            const exportBtn = document.getElementById('exportBtn');
            
            if (status === 'In Progress') {
                arrivalSection.style.display = 'block';
                completionSection.style.display = 'none';
                exportBtn.style.display = 'none';
                
                // Setup arrival canvas with delay to ensure DOM is ready
                setTimeout(() => {
                    setupSignatureCanvas('arrivalSignatureCanvas');
                    // Initialize with white background
                    const canvas = document.getElementById('arrivalSignatureCanvas');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    }
                }, 200);
                
            } else if (status === 'Completed') {
                arrivalSection.style.display = 'block';
                completionSection.style.display = 'block';
                exportBtn.style.display = 'inline-flex';
                
                // Setup both canvases with delay
                setTimeout(() => {
                    setupSignatureCanvas('arrivalSignatureCanvas');
                    setupSignatureCanvas('completionSignatureCanvas');
                    
                    // Initialize both canvases with white background
                    ['arrivalSignatureCanvas', 'completionSignatureCanvas'].forEach(canvasId => {
                        const canvas = document.getElementById(canvasId);
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                        }
                    });
                }, 200);
                
            } else {
                arrivalSection.style.display = 'none';
                completionSection.style.display = 'none';
                exportBtn.style.display = 'none';
            }
        };

        // Toggle hold fields visibility based on status selection
        window.toggleHoldFields = (type) => {
            const statusElementId = type + 'Status';
            const holdFieldsId = type + 'HoldFields';
            
            const statusElement = document.getElementById(statusElementId);
            const holdFields = document.getElementById(holdFieldsId);
            
            if (!statusElement || !holdFields) return;
            
            const status = statusElement.value;
            
            if (status === 'On Hold') {
                holdFields.style.display = 'block';
                
                // Set today's date as default hold date
                const holdDateField = document.getElementById(type + 'HoldDate');
                if (holdDateField && !holdDateField.value) {
                    const today = new Date().toISOString().split('T')[0];
                    holdDateField.value = today;
                }
                
                // Make hold fields required when visible
                const holdReason = document.getElementById(type + 'HoldReason');
                const holdDate = document.getElementById(type + 'HoldDate');
                const holdNotes = document.getElementById(type + 'HoldNotes');
                
                if (holdReason) holdReason.required = true;
                if (holdDate) holdDate.required = true;
                if (holdNotes) holdNotes.required = true;
                
            } else {
                holdFields.style.display = 'none';
                
                // Remove required validation when hidden
                const holdReason = document.getElementById(type + 'HoldReason');
                const holdDate = document.getElementById(type + 'HoldDate');
                const holdNotes = document.getElementById(type + 'HoldNotes');
                
                if (holdReason) holdReason.required = false;
                if (holdDate) holdDate.required = false;
                if (holdNotes) holdNotes.required = false;
            }
        };

        function isCanvasEmpty(canvas) {
            const ctx = canvas.getContext('2d');
            const pixelBuffer = new Uint32Array(
                ctx.getImageData(0, 0, canvas.width, canvas.height).data.buffer
            );
            
            // Check if all pixels are white (RGBA: 255,255,255,255) or transparent
            // Since we fill with white background, we need to check for non-white pixels
            const whitePixel = 0xFFFFFFFF; // White in RGBA format
            const transparentPixel = 0x00000000; // Transparent
            
            return pixelBuffer.every(pixel => 
                pixel === whitePixel || pixel === transparentPixel
            );
        }

        function loadSignatureToCanvas(canvasId, dataURL) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Clear canvas and set white background first
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw the signature image
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            
            img.onerror = function() {
                console.error('Failed to load signature image');
                // Clear canvas on error
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            };
            
            img.src = dataURL;
        }

        // Set complaint date to current time when modal opens
        window.showAddMaintenanceModal = () => {
            document.getElementById('maintenanceModalTitle').textContent = 'Schedule Maintenance';
            document.getElementById('maintenanceForm').reset();
            document.getElementById('editMaintenanceId').value = '';
            document.getElementById('exportBtn').style.display = 'none';
            
            // Set current date/time for complaint
            const now = new Date();
            document.getElementById('complaintDate').value = now.toISOString().slice(0, 16);
            
            const projectSelect = document.getElementById('maintenanceProject');
            projectSelect.innerHTML = '<option value="">Select Project</option>' + 
                projects.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
            
            const assigneeSelect = document.getElementById('maintenanceAssignee');
            assigneeSelect.innerHTML = '<option value="">Select Technician</option>' + 
                users.filter(u => (u.role === 'technician' || u.role === 'user' || u.role === 'admin') && u.status === 'active')
                     .map(u => `<option value="${u.username}">${u.fullName || u.username}</option>`).join('');
            
            toggleSignatureSection();
            document.getElementById('maintenanceModal').classList.add('active');
        };

        // Export general maintenance list to PDF
        window.exportMaintenancePDF = async () => {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'pt', 'a4'); // Landscape for better table fit
                
                // Load logo
                let logoImg = null;
                try {
                    logoImg = await loadImageAsDataUrl('ambivare.png');
                    if (!logoImg) {
                        const logoUrl = new URL('ambivare.png', window.location.href).href;
                        logoImg = await loadImageAsDataUrl(logoUrl);
                    }
                } catch (e) {
                    console.warn('Logo load failed for maintenance list:', e);
                }

                // Colors
                const primaryColor = [37, 99, 235];
                const darkColor = [15, 23, 42];
                const grayColor = [100, 116, 139];
                
                // Header with company branding
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 842, 80, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                
                // Add logo if available
                if (logoImg) {
                    try {
                        doc.addImage(logoImg, 'PNG', 30, 20, 30, 30);
                    } catch (e) {
                        console.warn('Adding logo failed:', e);
                    }
                }
                
                doc.text('AVANT ELEVATORS', 421, 35, { align: 'center' });
                doc.setFontSize(14);
                doc.setFont('helvetica', 'normal');
                doc.text('MAINTENANCE SCHEDULE REPORT', 421, 55, { align: 'center' });
                
                // Report info
                doc.setTextColor(...darkColor);
                doc.setFontSize(10);
                let yPos = 110;
                doc.text(`Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}`, 30, yPos);
                doc.text(`Total Records: ${maintenance.length}`, 30, yPos + 15);
                
                // Table header
                yPos += 40;
                const tableHeaders = ['Project', 'Elevator ID', 'Issue', 'Priority', 'Assigned To', 'Due Date', 'Status'];
                const columnWidths = [120, 80, 150, 60, 100, 80, 80];
                let xPos = 30;
                
                // Header background
                doc.setFillColor(240, 240, 240);
                doc.rect(30, yPos - 15, 782, 20, 'F');
                
                doc.setTextColor(...darkColor);
                doc.setFontSize(9);
                doc.setFont('helvetica', 'bold');
                
                tableHeaders.forEach((header, index) => {
                    doc.text(header, xPos + 5, yPos - 5);
                    xPos += columnWidths[index];
                });
                
                // Table data
                yPos += 10;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                
                maintenance.forEach((item, index) => {
                    if (yPos > 500) { // New page if needed
                        doc.addPage();
                        yPos = 50;
                    }
                    
                    xPos = 30;
                    const rowData = [
                        item.projectName || 'N/A',
                        item.elevatorId || 'N/A',
                        (item.issue || 'N/A').substring(0, 25) + (item.issue && item.issue.length > 25 ? '...' : ''),
                        item.priority || 'N/A',
                        item.assignedTo || 'Unassigned',
                        item.dueDate ? new Date(item.dueDate).toLocaleDateString() : 'N/A',
                        item.status || 'N/A'
                    ];
                    
                    // Alternate row colors
                    if (index % 2 === 0) {
                        doc.setFillColor(250, 250, 250);
                        doc.rect(30, yPos - 8, 782, 15, 'F');
                    }
                    
                    rowData.forEach((data, colIndex) => {
                        doc.text(data.toString(), xPos + 5, yPos);
                        xPos += columnWidths[colIndex];
                    });
                    
                    yPos += 15;
                });
                
                // Footer
                doc.setFontSize(8);
                doc.setTextColor(...grayColor);
                doc.text('Generated by Avant Elevators Management System', 421, 580, { align: 'center' });
                
                doc.save(`Maintenance_Schedule_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error generating maintenance PDF:', error);
                alert('Error generating maintenance PDF: ' + error.message);
            }
        };

        // Enhanced maintenance report export with signatures
        window.exportMaintenanceReport = async (maintenanceId) => {
            const maint = maintenanceId ? 
                maintenance.find(m => m.id === maintenanceId) : 
                {
                    projectName: document.getElementById('maintenanceProject').selectedOptions[0]?.text || '',
                    elevatorId: document.getElementById('maintenanceElevator').value,
                    issue: document.getElementById('maintenanceIssue').value,
                    priority: document.getElementById('maintenancePriority').value,
                    assignedTo: document.getElementById('maintenanceAssignee').value,
                    dueDate: document.getElementById('maintenanceDueDate').value,
                    status: document.getElementById('maintenanceStatus').value,
                    notes: document.getElementById('maintenanceNotes').value,
                    complaintPersonName: document.getElementById('complaintPersonName').value,
                    complaintPersonPhone: document.getElementById('complaintPersonPhone').value,
                    complaintPersonEmail: document.getElementById('complaintPersonEmail').value,
                    complaintPersonDesignation: document.getElementById('complaintPersonDesignation').value,
                    complaintPersonAddress: document.getElementById('complaintPersonAddress').value,
                    complaintDate: document.getElementById('complaintDate').value,
                    workDescription: document.getElementById('workDescription').value,
                    partsUsed: document.getElementById('partsUsed').value,
                    workCost: document.getElementById('workCost').value,
                    arrivalTime: document.getElementById('arrivalTime').value,
                    completionTime: document.getElementById('completionTime').value,
                    signatoryName: document.getElementById('signatoryName').value,
                    arrivalSignature: document.getElementById('arrivalSignatureCanvas')?.toDataURL(),
                    completionSignature: document.getElementById('completionSignatureCanvas')?.toDataURL()
                };

            if (!maint) return;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Load logo (same method as invoice PDF)
                let logoImg = null;
                try {
                    logoImg = await loadImageAsDataUrl('ambivare.png');
                    if (!logoImg) {
                        // try absolute URL
                        const logoUrl = new URL('ambivare.png', window.location.href).href;
                        logoImg = await loadImageAsDataUrl(logoUrl);
                    }
                } catch (e) {
                    console.warn('Logo load failed for maintenance report:', e);
                    logoImg = null;
                }

                // Final fallback: try a pre-embedded local file containing the base64 data URI
                if (!logoImg) {
                    try {
                        const resp = await fetch('./libs/embedded_logo.txt');
                        if (resp && resp.ok) {
                            logoImg = await resp.text();
                        }
                    } catch (e) {
                        // ignore
                    }
                }
                
                // Colors
                const primaryColor = [37, 99, 235];
                const darkColor = [15, 23, 42];
                const grayColor = [100, 116, 139];
                
                // Header with logo
                doc.setFontSize(20);
                doc.setTextColor(...primaryColor);
                doc.text('MAINTENANCE REPORT', 105, 20, { align: 'center' });
                
                // Company name and logo
                doc.setFontSize(16);
                doc.setTextColor(...darkColor);
                doc.text('Avant Elevators', 20, 35);
                
                // Add logo if available
                if (logoImg) {
                    try {
                        doc.addImage(logoImg, 'PNG', 20, 40, 25, 25);
                    } catch (e) {
                        console.warn('Adding logo to maintenance PDF failed:', e);
                    }
                }
                
                // Company details
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                let detailsY = logoImg ? 60 : 45;
                doc.text('Professional Maintenance Services', 20, detailsY);
                
                if (companySettings.address) {
                    detailsY += 7;
                    doc.text(companySettings.address, 20, detailsY);
                }
                if (companySettings.phone || companySettings.email) {
                    detailsY += 7;
                    doc.text(`${companySettings.phone || ''} | ${companySettings.email || ''}`, 20, detailsY);
                }
                if (companySettings.gst) {
                    detailsY += 7;
                    doc.text(`GST: ${companySettings.gst}`, 20, detailsY);
                }
                
                // Report details
                let y = detailsY + 20;
                doc.setFontSize(10);
                doc.setTextColor(...darkColor);
                doc.text(`Report Generated: ${new Date().toLocaleString()}`, 20, y);
                doc.text(`Report ID: ${maint.id || 'DRAFT'}`, 20, y + 7);
            
            // Complaint Information
            y += 20;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.text('COMPLAINT DETAILS', 20, y);
            
            y += 10;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(10);
            
            const fields = [
                ['Project:', maint.projectName],
                ['Elevator ID:', maint.elevatorId],
                ['Issue Description:', maint.issue],
                ['Priority:', maint.priority],
                ['Complaint Date:', new Date(maint.complaintDate).toLocaleString()],
                ['Complainant:', maint.complaintPersonName],
                ['Phone:', maint.complaintPersonPhone],
                ['Email:', maint.complaintPersonEmail],
                ['Designation:', maint.complaintPersonDesignation],
                ['Address:', maint.complaintPersonAddress]
            ];
            
            fields.forEach(([label, value]) => {
                if (value) {
                    doc.setFont(undefined, 'bold');
                    doc.text(label, 20, y);
                    doc.setFont(undefined, 'normal');
                    const text = doc.splitTextToSize(value.toString(), 120);
                    doc.text(text, 60, y);
                    y += 7 * text.length;
                }
            });
            
            // Work Information
            if (maint.status === 'Completed') {
                y += 10;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.text('WORK PERFORMED', 20, y);
                
                y += 10;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                
                const workFields = [
                    ['Assigned Technician:', maint.assignedTo],
                    ['Work Description:', maint.workDescription],
                    ['Parts/Materials Used:', maint.partsUsed],
                    ['Total Cost:', maint.workCost ? `â‚¹${maint.workCost}` : ''],
                    ['Arrival Time:', maint.arrivalTime ? new Date(maint.arrivalTime).toLocaleString() : ''],
                    ['Completion Time:', maint.completionTime ? new Date(maint.completionTime).toLocaleString() : ''],
                    ['Signatory Name:', maint.signatoryName]
                ];
                
                workFields.forEach(([label, value]) => {
                    if (value) {
                        doc.setFont(undefined, 'bold');
                        doc.text(label, 20, y);
                        doc.setFont(undefined, 'normal');
                        const text = doc.splitTextToSize(value.toString(), 120);
                        doc.text(text, 60, y);
                        y += 7 * text.length;
                    }
                });
            }
            
            // Signatures - FORCE them on the first page!
            if (maint.arrivalSignature || maint.completionSignature) {
                // Never create a new page - work with whatever space we have
                // If we're past 240, move back up to make room
                if (y > 240) {
                    y = 240; // Force it to fit
                }
                
                y += 8;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.setTextColor(15, 23, 42);
                
                // Check if we need a new page for signatures (move signatures higher up)
                if (y > 240) {
                    doc.addPage();
                    y = 30;
                }
                
                doc.text('SIGNATURES', 20, y);
                y += 12;
                
                // Display both signatures side by side - ALWAYS on first page
                if (maint.arrivalSignature && maint.completionSignature) {
                    // Headers
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    doc.text('TECHNICIAN ARRIVAL:', 20, y);
                    doc.text('WORK COMPLETION:', 120, y);
                    
                    y += 6;
                    
                    try {
                        // Signatures - smaller to fit
                        doc.addImage(maint.arrivalSignature, 'PNG', 20, y, 80, 25);
                        doc.addImage(maint.completionSignature, 'PNG', 120, y, 80, 25);
                        
                        y += 27;
                        
                        // Details in small font
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(7);
                        doc.text('Building Representative', 20, y);
                        doc.text(maint.signatoryName || 'Building Representative', 120, y);
                        
                        y += 5;
                        if (maint.arrivalTime) {
                            doc.text(new Date(maint.arrivalTime).toLocaleString(), 20, y);
                        }
                        if (maint.completionTime) {
                            doc.text(new Date(maint.completionTime).toLocaleString(), 120, y);
                        }
                        
                        y += 5;
                        doc.text('Work completed under supervision', 120, y);
                        
                    } catch (e) {
                        console.error('Error adding signatures:', e);
                        doc.text('Signatures available', 20, y);
                    }
                }
                // Single signature handling
                else if (maint.arrivalSignature) {
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    doc.text('TECHNICIAN ARRIVAL:', 20, y);
                    y += 6;
                    try {
                        doc.addImage(maint.arrivalSignature, 'PNG', 20, y, 80, 25);
                        y += 27;
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(7);
                        doc.text('Building Representative', 20, y);
                        if (maint.arrivalTime) {
                            y += 5;
                            doc.text(new Date(maint.arrivalTime).toLocaleString(), 20, y);
                        }
                    } catch (e) {
                        doc.text('Arrival signature available', 20, y);
                    }
                }
                else if (maint.completionSignature) {
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    doc.text('WORK COMPLETION:', 20, y);
                    y += 6;
                    try {
                        doc.addImage(maint.completionSignature, 'PNG', 20, y, 80, 25);
                        y += 27;
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(7);
                        doc.text(maint.signatoryName || 'Building Representative', 20, y);
                        if (maint.completionTime) {
                            y += 5;
                            doc.text(new Date(maint.completionTime).toLocaleString(), 20, y);
                        }
                    } catch (e) {
                        doc.text('Completion signature available', 20, y);
                    }
                }
            }
            
            // Footer - ONLY on the actual last page (moved higher to prevent cutoff)
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 116, 139);
                doc.text(`Page ${i} of ${pageCount}`, 105, 280, { align: 'center' });
                doc.text('Avant Elevators - Confidential Report', 20, 280);
            }
            
            const fileName = `maintenance_report_${maint.elevatorId}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            } catch (error) {
                console.error('Error generating maintenance report PDF:', error);
                alert('Error generating maintenance report PDF: ' + error.message);
            }
        };

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
