<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avant Elevators - Elevator Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ea580c;
            --border: #e2e8f0;
            --bg-light: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-light);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            padding: 20px;
        }

        .login-screen.hidden {
            display: none;
        }

        .login-card {
            background: white;
            border-radius: 8px;
            border: 1px solid var(--border);
            padding: 48px;
            max-width: 420px;
            width: 100%;
            box-shadow: var(--shadow-lg);
        }

        .logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .logo h1 {
            color: var(--text-primary);
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .logo p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-light);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            display: inline-block;
            visibility: visible;
        }

        .btn-danger:hover {
            background: #b91c1c;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #c2410c;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 13px;
        }

        .main-app {
            display: none;
            min-height: 100vh;
        }

        .main-app.active {
            display: block;
        }

        .header {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .header-left h2 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .header-left p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .offline-badge {
            background: var(--warning);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            display: none;
        }

        .offline-badge.show {
            display: block;
        }

        .user-badge {
            background: var(--bg-light);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--primary);
            text-transform: uppercase;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .nav-tabs {
            background: white;
            border-bottom: 1px solid var(--border);
            padding: 0;
        }

        .nav-tabs-container {
            display: flex;
            gap: 0;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 14px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
            transition: all 0.2s;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-light);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .content {
            padding: 24px 0;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            box-shadow: var(--shadow);
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .filters {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            padding: 16px;
            background: var(--bg-light);
            border-radius: 6px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 150px;
        }

        .filter-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .filter-group select,
        .filter-group input {
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 13px;
            background: white;
        }

        .chart-container {
            width: 100%;
            height: 300px;
            margin-top: 16px;
            position: relative;
        }

        .chart-container canvas {
            max-height: 300px !important;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .charts-grid .card {
            height: 400px;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 16px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background: var(--bg-light);
        }

        .table th {
            padding: 12px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
        }

        .table td {
            padding: 12px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        .table tbody tr:hover {
            background: var(--bg-light);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-primary {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-secondary {
            background: var(--bg-light);
            color: var(--text-secondary);
        }

        .search-box {
            position: relative;
            margin-bottom: 16px;
        }

        .search-box input {
            width: 100%;
            max-width: 400px;
            padding: 10px 12px 10px 36px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .search-box::before {
            content: "üîç";
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-dialog {
            background: white;
            border-radius: 8px;
            max-width: 540px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            margin: auto;
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background: var(--bg-light);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Multi-elevator completion modal styles */
        .elevator-checkbox-card {
            transition: all 0.2s ease;
        }

        .elevator-checkbox-card:hover {
            background: var(--bg-light) !important;
            border-color: var(--primary) !important;
        }

        .elevator-checkbox-card:has(input:checked) {
            background: var(--primary-bg, #dbeafe) !important;
            border-color: var(--primary) !important;
        }

        .elevator-selection-grid {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background: var(--bg-light, #f8fafc);
        }

        .signature-grid {
            margin-top: 15px;
        }

        .signature-panel {
            min-height: 250px;
        }

        .signature-panel h5 {
            margin-bottom: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 600;
        }

        .completed-elevators {
            border-left: 4px solid var(--success);
        }

        .work-details {
            border-top: 2px solid var(--border-color);
            padding-top: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }

        .empty-state {
            text-align: center;
            padding: 48px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.3;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-text {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .project-items {
            margin-top: 8px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 4px;
            font-size: 13px;
        }

        .project-items p {
            margin: 4px 0;
            color: var(--text-secondary);
        }

        .low-stock-alert {
            background: #fef3c7;
            border: 1px solid #fde68a;
            border-radius: 6px;
            padding: 12px 16px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .low-stock-alert .icon {
            font-size: 20px;
        }

        .low-stock-list {
            list-style: none;
            padding: 0;
        }

        .low-stock-list li {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .low-stock-list li:last-child {
            border-bottom: none;
        }

        .barcode-reader {
            padding: 20px;
            text-align: center;
        }

        #barcodeVideo {
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            border: 2px solid var(--border);
            background: #000;
        }

        .barcode-result {
            margin-top: 16px;
            padding: 12px;
            background: var(--bg-light);
            border-radius: 6px;
            font-weight: 600;
            color: var(--primary);
        }

        .camera-permission-info {
            padding: 16px;
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
            color: #1e40af;
        }

        .scan-status {
            margin-top: 12px;
            padding: 8px;
            background: #dbeafe;
            border-radius: 4px;
            font-size: 13px;
            color: #1e40af;
        }

        .scan-status.scanning {
            background: #dcfce7;
            color: #166534;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid .card {
                height: 350px;
            }

            .login-card {
                padding: 32px 24px;
            }

            .card {
                padding: 16px;
            }

            .header-right {
                flex-wrap: wrap;
                width: 100%;
            }

            .user-name {
                display: none;
            }

            .filters {
                flex-direction: column;
            }

            /* Tracking Module Mobile Styles */
            #trackingContent {
                padding: 12px !important;
            }

            #trackingContent h2 {
                font-size: 18px !important;
                margin-bottom: 16px !important;
            }

            #trackingContent h3 {
                font-size: 16px !important;
                margin-bottom: 10px !important;
            }

            #trackingMap {
                height: 300px !important;
            }

            #technicianStatusCards > div {
                margin-bottom: 10px !important;
                padding: 12px !important;
            }

            #recentAlertsList > div {
                padding: 10px !important;
            }

            .tracking-actions {
                grid-template-columns: 1fr !important;
                gap: 8px !important;
            }

            /* Improve table readability on mobile */
            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 8px 4px !important;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-light);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary);
        }

        /* MapTiler/Mapbox GL Popup Styling */
        .mapboxgl-popup {
            max-width: 300px !important;
        }

        .mapboxgl-popup-content {
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
            padding: 0 !important;
        }

        .technician-popup .mapboxgl-popup-content {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        }

        .mapboxgl-popup-close-button {
            color: #64748b !important;
            font-size: 18px !important;
            padding: 4px !important;
            width: 24px !important;
            height: 24px !important;
        }

        .mapboxgl-popup-close-button:hover {
            background: var(--bg-light) !important;
            color: var(--text-primary) !important;
        }

        .mapboxgl-popup-tip {
            border-top-color: white !important;
        }

        /* Map container improvements */
        .mapboxgl-map {
            border-radius: 8px;
            overflow: hidden;
        }

        .mapboxgl-ctrl-group {
            border-radius: 6px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
        }

        .mapboxgl-ctrl button {
            border-radius: 0 !important;
        }

        .mapboxgl-ctrl-group button:first-child {
            border-top-left-radius: 6px !important;
            border-top-right-radius: 6px !important;
        }

        .mapboxgl-ctrl-group button:last-child {
            border-bottom-left-radius: 6px !important;
            border-bottom-right-radius: 6px !important;
        }

        /* Billing System Styles */
        .form-section {
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .form-section h4 {
            margin-bottom: 16px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        }

        .invoice-items-container {
            border: 1px solid var(--border);
            border-radius: 6px;
            overflow: hidden;
            overflow-x: auto;
        }

        .invoice-item-header {
            display: grid;
            grid-template-columns: 2fr 80px 80px 120px 120px 80px;
            gap: 12px;
            padding: 12px;
            background: var(--bg-light);
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border);
            min-width: 600px;
        }

        .invoice-item {
            display: grid;
            grid-template-columns: 2fr 80px 80px 120px 120px 80px;
            gap: 12px;
            padding: 12px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            min-width: 600px;
        }

        .invoice-item:last-child {
            border-bottom: none;
        }

        .invoice-item input,
        .invoice-item select {
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
        }

        .item-amount {
            font-weight: 600;
            color: var(--text-primary);
            padding: 6px 8px;
            background: var(--bg-light);
            border-radius: 4px;
            text-align: right;
        }

        .invoice-totals {
            background: var(--bg-light);
            padding: 20px;
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .total-display {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            padding: 8px 12px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 4px;
        }

        .total-amount {
            font-size: 18px;
            color: var(--success);
        }

        .billing-stats-grid .stat-card {
            text-align: center;
        }

        .invoice-status-paid {
            background: #dcfce7;
            color: #166534;
        }

        .invoice-status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .invoice-status-overdue {
            background: #fef2f2;
            color: #991b1b;
        }

        .invoice-status-draft {
            background: #f1f5f9;
            color: #475569;
        }

        .invoice-status-sent {
            background: #dbeafe;
            color: #1e40af;
        }

        .invoice-status-cancelled {
            background: #f3f4f6;
            color: #6b7280;
        }

        /* Mobile Billing Optimizations */
        @media (max-width: 768px) {
            .billing-stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 12px !important;
            }

            .filters {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 12px !important;
            }

            .filters input,
            .filters select {
                width: 100% !important;
                min-width: auto !important;
            }

            .card-header {
                flex-direction: column !important;
                align-items: stretch !important;
                gap: 16px !important;
            }

            .card-header > div {
                display: flex;
                gap: 8px;
                flex-wrap: wrap;
            }

            .action-buttons {
                flex-direction: column !important;
                gap: 6px !important;
            }

            .action-buttons .btn {
                width: 100%;
                justify-content: center;
            }

            /* Invoice Modal Mobile Optimization */
            #invoiceModal .modal-dialog {
                max-width: 95% !important;
                margin: 10px !important;
            }

            .invoice-items-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .invoice-item-header {
                min-width: 700px;
                font-size: 12px;
                padding: 8px;
                gap: 8px;
            }

            .invoice-item {
                min-width: 700px;
                padding: 8px;
                gap: 8px;
            }

            .invoice-item input {
                font-size: 13px;
                padding: 4px 6px;
            }

            .invoice-totals .form-row {
                flex-direction: column !important;
            }

            .form-section h4 {
                font-size: 14px;
                margin-bottom: 12px;
            }

            .form-row {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }

            /* Table responsiveness for billing */
            .table-responsive {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .table-responsive table {
                min-width: 700px;
            }

            .table-responsive th,
            .table-responsive td {
                padding: 8px 6px;
                font-size: 13px;
                white-space: nowrap;
            }

            /* Stats cards mobile */
            .stat-card {
                padding: 16px !important;
            }

            .stat-value {
                font-size: 24px !important;
            }

            .stat-label {
                font-size: 13px !important;
            }
        }

        @media (max-width: 480px) {
            .billing-stats-grid {
                grid-template-columns: 1fr !important;
            }

            .table-responsive table {
                min-width: 600px;
            }

            .invoice-item-header,
            .invoice-item {
                min-width: 600px;
                grid-template-columns: 1.5fr 60px 60px 100px 100px 60px;
                font-size: 11px;
            }

            .card-header h3 {
                font-size: 16px;
            }

            .modal-dialog {
                margin: 5px !important;
            }
        }

        /* Progress Bar Styles */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-light);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .progress-fill {
            height: 100%;
            background: var(--success);
            transition: width 0.3s ease;
        }

        /* Project Details Styles */
        .project-details {
            margin-top: 4px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .project-details small {
            display: block;
            margin-bottom: 2px;
        }

        /* Form Section Styles */
        .form-section {
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h4 {
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--primary);
        }

    </style>
    
    <!-- SMTP.js - Send emails directly from JavaScript -->
    <script src="https://smtpjs.com/v3/smtp.js"></script>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="logo">
                <img src="ambivare.png" alt="Avant Elevators" style="max-width: 150px; margin-bottom: 16px;">
                <h1 data-translate="company_name">Avant Elevators</h1>
                <p data-translate="system_title">Elevator Management System</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label data-translate="username">Username</label>
                    <input type="text" class="form-control" id="username" required data-translate-placeholder="enter_username" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label data-translate="password">Password</label>
                    <input type="password" class="form-control" id="password" required data-translate-placeholder="enter_password" placeholder="Enter password">
                </div>
                <div id="loginError" class="alert alert-danger" style="display: none;"></div>
                <button type="submit" class="btn btn-primary" id="loginBtn" data-translate="sign_in">Sign In</button>
            </form>
        </div>
    </div>

    <div class="main-app" id="mainApp">
        <div class="header">
            <div class="container">
                <div class="header-content">
                    <div class="header-left" style="display: flex; align-items: center; gap: 12px;">
                        <img src="ambivare.png" alt="Avant Elevators" style="height: 40px;">
                        <div>
                            <h2 data-translate="company_name">Avant Elevators</h2>
                            <p data-translate="portal_subtitle">Elevator Management Portal</p>
                        </div>
                    </div>
                    <div class="header-right" style="display: flex; align-items: center; gap: 12px;">
                        <div class="language-switcher" style="margin-right: 12px;">
                            <select id="languageSelector" onchange="changeLanguage()" style="padding: 4px 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px;">
                                <option value="en">English</option>
                                <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
                                <option value="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä</option>
                            </select>
                        </div>
                        <div class="offline-badge" id="offlineBadge">OFFLINE MODE</div>
                        <span class="user-badge" id="userRole">USER</span>
                        <span class="user-name" id="userName">User</span>
                        <button class="btn btn-secondary btn-sm" onclick="logout()" data-translate="logout">Logout</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="nav-tabs">
            <div class="container">
                <div class="nav-tabs-container">
                    <button class="nav-tab active" onclick="showTab('dashboard')" data-translate="dashboard">Dashboard</button>
                    <button class="nav-tab" onclick="showTab('warehouse')" data-translate="warehouse">Warehouse</button>
                    <button class="nav-tab" onclick="showTab('service-van')" data-translate="service_van">Service Van</button>
                    <button class="nav-tab" onclick="showTab('office')" data-translate="office">Office</button>
                    <button class="nav-tab" onclick="showTab('projects')" data-translate="projects">Projects</button>
                    <button class="nav-tab" onclick="showTab('maintenance')" data-translate="maintenance">RCI</button>
                    <button class="nav-tab" onclick="showTab('amc')" data-translate="amc">AMC</button>
                    <button class="nav-tab" onclick="showTab('tasks')" data-translate="tasks">Tasks</button>
                    <button class="nav-tab" onclick="showTab('tracking')" data-translate="tracking">üó∫Ô∏è Tracking</button>
                    <button class="nav-tab" id="billingTabBtn" onclick="showTab('billing')" data-translate="billing">Billing</button>
                    <button class="nav-tab" id="salesTabBtn" onclick="showTab('sales')" style="display: none;" data-translate="sales">Sales</button>
                    <button class="nav-tab" onclick="showTab('activities')" data-translate="activities">Activities</button>
                    <button class="nav-tab" id="usersTabBtn" onclick="showTab('hr')" style="display: none;" data-translate="hr">HR</button>
                    <button class="nav-tab" onclick="showTab('bom')" data-translate="bom">BOM</button>
                    <button class="nav-tab" id="settingsTabBtn" onclick="showTab('settings')" style="display: none;" data-translate="settings">Settings</button>
                </div>
            </div>
        </div>

        <div class="content">
            <div class="container">
                <div class="tab-pane active" id="dashboardTab">
                    <div id="lowStockAlerts"></div>

                    <!-- God-Level Analytics Overview -->
                    <div style="margin-bottom: 24px;">
                        <h2 style="font-size: 24px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">üìä Business Intelligence Dashboard</h2>
                        <p style="color: var(--text-secondary); font-size: 14px;">Comprehensive analytics and insights across all business operations</p>
                    </div>

                    <!-- Quick Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card" style="cursor: pointer;" onclick="openAnalyticsWindow('sales')">
                            <div class="stat-label">üí∞ Total Revenue</div>
                            <div class="stat-value" id="totalRevenue">‚Çπ0</div>
                            <small style="color: var(--text-secondary); font-size: 12px;">Click for Sales Analytics</small>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="openAnalyticsWindow('projects')">
                            <div class="stat-label">üèóÔ∏è Active Projects</div>
                            <div class="stat-value" id="activeProjects">0</div>
                            <small style="color: var(--text-secondary); font-size: 12px;">Click for Project Analytics</small>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="openAnalyticsWindow('leads')">
                            <div class="stat-label">üéØ Total Leads</div>
                            <div class="stat-value" id="totalLeadsCount">0</div>
                            <small style="color: var(--text-secondary); font-size: 12px;">Click for Lead Analytics</small>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="openAnalyticsWindow('amc')">
                            <div class="stat-label">üìù Active AMCs</div>
                            <div class="stat-value" id="activeAMCs">0</div>
                            <small style="color: var(--text-secondary); font-size: 12px;">Click for AMC Analytics</small>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="openAnalyticsWindow('maintenance')">
                            <div class="stat-label">üîß Maintenance Tasks</div>
                            <div class="stat-value" id="maintenanceDue">0</div>
                            <small style="color: var(--text-secondary); font-size: 12px;">Click for Maintenance Analytics</small>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="openAnalyticsWindow('hr')">
                            <div class="stat-label">üë• Total Employees</div>
                            <div class="stat-value" id="totalEmployees">0</div>
                            <small style="color: var(--text-secondary); font-size: 12px;">Click for HR Analytics</small>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="openAnalyticsWindow('inventory')">
                            <div class="stat-label">üì¶ Inventory Items</div>
                            <div class="stat-value" id="totalItems">0</div>
                            <small style="color: var(--text-secondary); font-size: 12px;">Click for Inventory Analytics</small>
                        </div>
                        <div class="stat-card" style="cursor: pointer;" onclick="openAnalyticsWindow('billing')">
                            <div class="stat-label">üí≥ Pending Invoices</div>
                            <div class="stat-value" id="pendingInvoices">0</div>
                            <small style="color: var(--text-secondary); font-size: 12px;">Click for Billing Analytics</small>
                        </div>
                    </div>

                    <!-- Analytics Cards Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; margin-top: 24px;">
                        
                        <!-- Sales Analytics Card -->
                        <div class="card" style="border-left: 4px solid #10b981;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 class="card-title" style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                    üí∞ Sales Analytics
                                </h3>
                                <button class="btn btn-sm btn-primary" onclick="openAnalyticsWindow('sales')">View Details</button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Monthly Revenue:</span>
                                    <strong id="monthlyRevenue">‚Çπ0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Quarterly Revenue:</span>
                                    <strong id="quarterlyRevenue">‚Çπ0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Yearly Revenue:</span>
                                    <strong id="yearlyRevenue">‚Çπ0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Conversion Rate:</span>
                                    <strong id="conversionRate">0%</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Project Analytics Card -->
                        <div class="card" style="border-left: 4px solid #3b82f6;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 class="card-title" style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                    üèóÔ∏è Project Analytics
                                </h3>
                                <button class="btn btn-sm btn-primary" onclick="openAnalyticsWindow('projects')">View Details</button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Active Projects:</span>
                                    <strong id="activeProjectsCount">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Completed:</span>
                                    <strong id="completedProjects">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">On Hold:</span>
                                    <strong id="onHoldProjects">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Avg Progress:</span>
                                    <strong id="avgProgress">0%</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Lead Analytics Card -->
                        <div class="card" style="border-left: 4px solid #f59e0b;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 class="card-title" style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                    üéØ Lead Analytics
                                </h3>
                                <button class="btn btn-sm btn-primary" onclick="openAnalyticsWindow('leads')">View Details</button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Total Leads:</span>
                                    <strong id="totalLeads">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Hot Leads:</span>
                                    <strong id="hotLeads">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Converted:</span>
                                    <strong id="convertedLeads">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Pipeline Value:</span>
                                    <strong id="pipelineValue">‚Çπ0</strong>
                                </div>
                            </div>
                        </div>

                        <!-- AMC Analytics Card -->
                        <div class="card" style="border-left: 4px solid #8b5cf6;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 class="card-title" style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                    üìù AMC Analytics
                                </h3>
                                <button class="btn btn-sm btn-primary" onclick="openAnalyticsWindow('amc')">View Details</button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Active Contracts:</span>
                                    <strong id="activeAMCCount">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Expiring Soon:</span>
                                    <strong id="expiringSoonAMC">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Total AMC Value:</span>
                                    <strong id="totalAMCValue">‚Çπ0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Renewal Rate:</span>
                                    <strong id="renewalRate">0%</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Maintenance Analytics Card -->
                        <div class="card" style="border-left: 4px solid #ef4444;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 class="card-title" style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                    üîß Maintenance Analytics
                                </h3>
                                <button class="btn btn-sm btn-primary" onclick="openAnalyticsWindow('maintenance')">View Details</button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Pending Tasks:</span>
                                    <strong id="pendingMaintenance">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">In Progress:</span>
                                    <strong id="inProgressMaintenance">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Completed (Month):</span>
                                    <strong id="completedMaintenance">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Overdue:</span>
                                    <strong style="color: var(--danger);" id="overdueMaintenance">0</strong>
                                </div>
                            </div>
                        </div>

                        <!-- HR Analytics Card -->
                        <div class="card" style="border-left: 4px solid #06b6d4;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 class="card-title" style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                    üë• HR Analytics
                                </h3>
                                <button class="btn btn-sm btn-primary" onclick="openAnalyticsWindow('hr')">View Details</button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Total Employees:</span>
                                    <strong id="totalEmployeesCount">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Active:</span>
                                    <strong id="activeEmployees">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Monthly Payroll:</span>
                                    <strong id="monthlyPayroll">‚Çπ0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Pending Salaries:</span>
                                    <strong id="pendingSalaries">0</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Inventory Analytics Card -->
                        <div class="card" style="border-left: 4px solid #ec4899;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 class="card-title" style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                    üì¶ Inventory Analytics
                                </h3>
                                <button class="btn btn-sm btn-primary" onclick="openAnalyticsWindow('inventory')">View Details</button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Total Items:</span>
                                    <strong id="totalInventoryItems">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Low Stock:</span>
                                    <strong style="color: var(--warning);" id="lowStockItems">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Warehouse:</span>
                                    <strong id="warehouseItems">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Service Van:</span>
                                    <strong id="serviceVanItems">0</strong>
                                </div>
                            </div>
                        </div>

                        <!-- Billing & Finance Analytics Card -->
                        <div class="card" style="border-left: 4px solid #14b8a6;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 class="card-title" style="margin: 0; display: flex; align-items: center; gap: 8px;">
                                    üí≥ Billing & Finance
                                </h3>
                                <button class="btn btn-sm btn-primary" onclick="openAnalyticsWindow('billing')">View Details</button>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Total Invoices:</span>
                                    <strong id="totalInvoices">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Pending:</span>
                                    <strong style="color: var(--warning);" id="pendingInvoicesCount">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Paid (Month):</span>
                                    <strong style="color: var(--success);" id="paidInvoices">0</strong>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--text-secondary);">Outstanding Amount:</span>
                                    <strong id="outstandingAmount">‚Çπ0</strong>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- Quick Actions -->
                    <div class="card" style="margin-top: 24px;">
                        <h3 class="card-title">‚ö° Quick Actions & Reports</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px;">
                            <button class="btn btn-primary" onclick="exportAllAnalyticsPDF()">üìä Export Full Report</button>
                            <button class="btn btn-success" onclick="exportSalesReport()">üí∞ Sales Report</button>
                            <button class="btn btn-warning" onclick="exportProjectReport()">üèóÔ∏è Project Report</button>
                            <button class="btn btn-secondary" onclick="exportHRReport()">üë• HR Report</button>
                            <button class="btn btn-primary" onclick="exportAMCReport()">üìù AMC Report</button>
                            <button class="btn btn-danger" onclick="exportMaintenanceReport()">üîß Maintenance Report</button>
                        </div>
                    </div>
                </div>

                <!-- Warehouse Tab -->
                <div class="tab-pane" id="warehouseTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Warehouse Inventory</h3>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" onclick="showBarcodeScanner('warehouse')">üì∑ Scan Barcode</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportLocationPDF('warehouse')">üì• Export PDF</button>
                                <button class="btn btn-success btn-sm" onclick="showAddInventoryModal('warehouse')">+ Add Item</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchWarehouse" placeholder="Search..." oninput="filterLocation('warehouse')">
                            </div>
                            <div class="filter-group">
                                <label>Category</label>
                                <select id="categoryFilterWarehouse" onchange="filterLocation('warehouse')">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="statusFilterWarehouse" onchange="filterLocation('warehouse')">
                                    <option value="">All Status</option>
                                    <option value="good">Good Stock</option>
                                    <option value="medium">Medium Stock</option>
                                    <option value="low">Low Stock</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="warehouseList">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Office Tab -->
                <div class="tab-pane" id="officeTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Office Inventory</h3>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" onclick="showBarcodeScanner('office')">üì∑ Scan Barcode</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportLocationPDF('office')">üì• Export PDF</button>
                                <button class="btn btn-success btn-sm" onclick="showAddInventoryModal('office')">+ Add Item</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchOffice" placeholder="Search..." oninput="filterLocation('office')">
                            </div>
                            <div class="filter-group">
                                <label>Category</label>
                                <select id="categoryFilterOffice" onchange="filterLocation('office')">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="statusFilterOffice" onchange="filterLocation('office')">
                                    <option value="">All Status</option>
                                    <option value="good">Good Stock</option>
                                    <option value="medium">Medium Stock</option>
                                    <option value="low">Low Stock</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="officeList">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Service Van Tab -->
                <div class="tab-pane" id="service-vanTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Service Van Inventory</h3>
                            <div class="action-buttons">
                                <button class="btn btn-warning btn-sm" onclick="showBarcodeScanner('service-van')">üì∑ Scan Barcode</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportLocationPDF('service-van')">üì• Export PDF</button>
                                <button class="btn btn-success btn-sm" onclick="showAddInventoryModal('service-van')">+ Add Item</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchServiceVan" placeholder="Search..." oninput="filterLocation('service-van')">
                            </div>
                            <div class="filter-group">
                                <label>Category</label>
                                <select id="categoryFilterServiceVan" onchange="filterLocation('service-van')">
                                    <option value="">All Categories</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="statusFilterServiceVan" onchange="filterLocation('service-van')">
                                    <option value="">All Status</option>
                                    <option value="good">Good Stock</option>
                                    <option value="medium">Medium Stock</option>
                                    <option value="low">Low Stock</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Item Name</th>
                                        <th>Category</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="serviceVanList">
                                    <tr><td colspan="5" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Projects Tab -->
                <div class="tab-pane" id="projectsTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Project Management</h3>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="exportProjectsPDF()">üì• Export PDF</button>
                                <button class="btn btn-warning btn-sm" onclick="exportHoldReportPDF('projects')">Export Hold Report</button>
                                <button class="btn btn-success btn-sm" onclick="showAddProjectModal()">+ Create Project</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchProjects" placeholder="Search..." oninput="filterProjects()">
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="projectStatusFilter" onchange="filterProjects()">
                                    <option value="">All Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Completed">Completed</option>
                                    <option value="On Hold">On Hold</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Project Name</th>
                                        <th>Code</th>
                                        <th>Client</th>
                                        <th>Elevators</th>
                                        <th>Progress</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="projectList">
                                    <tr><td colspan="7" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- RCI Tab (Repairs, Complaints & Maintenance) -->
                <div class="tab-pane" id="maintenanceTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">RCI - Repairs, Complaints & Maintenance</h3>
                            <div class="action-buttons">
                                <button class="btn btn-info btn-sm" onclick="showRCIAnalytics()">üìä Lift Health Analytics</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportMaintenancePDF()">üì• Export PDF</button>
                                <button class="btn btn-warning btn-sm" onclick="exportHoldReportPDF('maintenance')">Export Hold Report</button>
                                <button class="btn btn-success btn-sm" onclick="showAddMaintenanceModal()">+ New RCI Record</button>
                            </div>
                        </div>
                        
                        <!-- RCI Quick Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 20px;">
                            <div class="stat-card" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
                                <div class="stat-value" id="totalRCIRecords" style="color: #d97706;">0</div>
                                <div class="stat-label">Total Records</div>
                            </div>
                            <div class="stat-card" style="background: #fee2e2; border-left: 4px solid #dc2626;">
                                <div class="stat-value" id="repairsCount" style="color: #dc2626;">0</div>
                                <div class="stat-label">üîß Repairs</div>
                            </div>
                            <div class="stat-card" style="background: #fef3c7; border-left: 4px solid #f59e0b;">
                                <div class="stat-value" id="complaintsCount" style="color: #d97706;">0</div>
                                <div class="stat-label">üì¢ Complaints</div>
                            </div>
                            <div class="stat-card" style="background: #dbeafe; border-left: 4px solid #3b82f6;">
                                <div class="stat-value" id="maintenanceCount" style="color: #2563eb;">0</div>
                                <div class="stat-label">üõ†Ô∏è Maintenance</div>
                            </div>
                            <div class="stat-card" style="background: #fecaca; border-left: 4px solid #b91c1c;">
                                <div class="stat-value" id="defaultedLiftsCount" style="color: #b91c1c;">0</div>
                                <div class="stat-label">‚ö†Ô∏è Defaulted Lifts</div>
                            </div>
                            <div class="stat-card" style="background: #dcfce7; border-left: 4px solid #16a34a;">
                                <div class="stat-value" id="healthyLiftsCount" style="color: #16a34a;">0</div>
                                <div class="stat-label">‚úÖ Healthy Lifts</div>
                            </div>
                        </div>
                        
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchMaintenance" placeholder="Search..." oninput="filterMaintenance()">
                            </div>
                            <div class="filter-group">
                                <label>Type</label>
                                <select id="maintenanceTypeFilter" onchange="filterMaintenance()">
                                    <option value="">All Types</option>
                                    <option value="Repair">üîß Repair</option>
                                    <option value="Complaint">üì¢ Complaint</option>
                                    <option value="Maintenance">üõ†Ô∏è Maintenance</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="maintenanceStatusFilter" onchange="filterMaintenance()">
                                    <option value="">All Status</option>
                                    <option value="Scheduled">Scheduled</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Overdue">Overdue</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Priority</label>
                                <select id="maintenancePriorityFilter" onchange="filterMaintenance()">
                                    <option value="">All Priority</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Assigned To</label>
                                <select id="maintenanceAssigneeFilter" onchange="filterMaintenance()">
                                    <option value="">All Technicians</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Project</label>
                                <select id="maintenanceProjectFilter" onchange="filterMaintenance()">
                                    <option value="">All Projects</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th>Lift ID</th>
                                        <th>Project / Building</th>
                                        <th>Wing / Floor</th>
                                        <th>Issue Description</th>
                                        <th>Complaint By</th>
                                        <th>Priority</th>
                                        <th>Assigned To</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="maintenanceList">
                                    <tr><td colspan="11" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- AMC Tab -->
                <div class="tab-pane" id="amcTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">AMC Management</h3>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="exportAMCPDF()">üì• Export PDF</button>
                                <button class="btn btn-warning btn-sm" onclick="showRenewalsReport()">üìÖ Renewals Report</button>
                                <button class="btn btn-success btn-sm" onclick="showAddAMCModal()">+ Add AMC Contract</button>
                            </div>
                        </div>
                        
                        <!-- AMC Alerts -->
                        <div id="amcAlerts" class="alerts-section" style="margin-bottom: 20px;"></div>
                        
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchAMC" placeholder="Search..." oninput="filterAMC()">
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="amcStatusFilter" onchange="filterAMC()">
                                    <option value="">All Status</option>
                                    <option value="Active">Active</option>
                                    <option value="Expiring Soon">Expiring Soon</option>
                                    <option value="Expired">Expired</option>
                                    <option value="Terminated">Terminated</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Contract Type</label>
                                <select id="amcTypeFilter" onchange="filterAMC()">
                                    <option value="">All Types</option>
                                    <option value="New Installation">New Installation</option>
                                    <option value="Modernization">Modernization</option>
                                    <option value="Regular AMC">Regular AMC</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Payment Status</label>
                                <select id="amcPaymentFilter" onchange="filterAMC()">
                                    <option value="">All Payments</option>
                                    <option value="Paid">Paid</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Overdue">Overdue</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Project</th>
                                        <th>Contract Details</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Payment</th>
                                        <th>Status</th>
                                        <th>Free Maintenance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="amcList">
                                    <tr><td colspan="8" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Activities Tab -->
                <div class="tab-pane" id="activitiesTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Activity Logs</h3>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('day')">üì• Day</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('week')">üì• Week</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('month')">üì• Month</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('quarter')">üì• Quarter</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('halfyear')">üì• Half Year</button>
                                <button class="btn btn-secondary btn-sm" onclick="exportActivitiesPDF('year')">üì• Year</button>
                            </div>
                        </div>
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchActivities" placeholder="Search..." oninput="filterActivities()">
                            </div>
                            <div class="filter-group">
                                <label>Date Range</label>
                                <select id="activityDateFilter" onchange="filterActivities()">
                                    <option value="all">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="halfyear">Last 6 Months</option>
                                    <option value="year">This Year</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>User</label>
                                <select id="activityUserFilter" onchange="filterActivities()">
                                    <option value="">All Users</option>
                                </select>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date & Time</th>
                                        <th>Action</th>
                                        <th>User</th>
                                    </tr>
                                </thead>
                                <tbody id="activityList">
                                    <tr><td colspan="3" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- HR Management Tab -->
                <div class="tab-pane" id="hrTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">HR Management System</h3>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="exportAllHRPDF()">üì• Export All HR Data</button>
                                <button class="btn btn-info btn-sm" onclick="showSalarySlipModal()">üí∞ Generate Salary Slip</button>
                                <button class="btn btn-warning btn-sm" onclick="exportPayrollReport()">üí∞ Payroll Report</button>
                                <button class="btn btn-success btn-sm" onclick="showAddEmployeeModal()">+ Add Employee</button>
                            </div>
                        </div>
                        
                        <!-- HR Dashboard Stats -->
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-label">Total Employees</div>
                                <div class="stat-value" id="totalEmployees">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Active Employees</div>
                                <div class="stat-value" id="activeEmployees">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">New Joiners (This Month)</div>
                                <div class="stat-value" id="newJoiners">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Average Salary</div>
                                <div class="stat-value" id="avgSalary">Rs. 0</div>
                            </div>
                        </div>

                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchEmployees" placeholder="Search employees..." oninput="filterEmployees()">
                            </div>
                            <div class="filter-group">
                                <label>Department</label>
                                <select id="departmentFilter" onchange="filterEmployees()">
                                    <option value="">All Departments</option>
                                    <option value="Engineering">Engineering</option>
                                    <option value="Sales">Sales</option>
                                    <option value="HR">HR</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Operations">Operations</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Administration">Administration</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="statusFilter" onchange="filterEmployees()">
                                    <option value="">All Status</option>
                                    <option value="Active">Active</option>
                                    <option value="On Leave">On Leave</option>
                                    <option value="Resigned">Resigned</option>
                                    <option value="Terminated">Terminated</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Position</label>
                                <select id="positionFilter" onchange="filterEmployees()">
                                    <option value="">All Positions</option>
                                    <option value="Manager">Manager</option>
                                    <option value="Engineer">Engineer</option>
                                    <option value="Technician">Technician</option>
                                    <option value="Sales Executive">Sales Executive</option>
                                    <option value="Administrator">Administrator</option>
                                    <option value="Receptionist">Receptionist</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Employee Details</th>
                                        <th>Contact Info</th>
                                        <th>Position & Department</th>
                                        <th>Salary Details</th>
                                        <th>Service Period</th>
                                        <th>Status</th>
                                        <th>Login Access</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="employeesList">
                                    <tr><td colspan="8" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Salary Slips Section -->
                    <div class="card" style="margin-top: 24px;">
                        <div class="card-header">
                            <h3 class="card-title">üí∞ Salary Slips Management</h3>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="exportAllSalarySlipsPDF()">üì• Export All Slips</button>
                                <button class="btn btn-info btn-sm" onclick="showSalarySlipModal()">+ Generate New Slip</button>
                            </div>
                        </div>

                        <!-- Salary Slips Stats -->
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-label">Total Slips</div>
                                <div class="stat-value" id="totalSlips">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">This Month</div>
                                <div class="stat-value" id="thisMonthSlips">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Payout (Month)</div>
                                <div class="stat-value" id="totalMonthPayout">Rs. 0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Avg Salary</div>
                                <div class="stat-value" id="avgSlipSalary">Rs. 0</div>
                            </div>
                        </div>

                        <!-- Salary Slips Filters -->
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search Employee</label>
                                <input type="text" id="searchSalarySlips" placeholder="Search by name or ID..." oninput="filterSalarySlips()">
                            </div>
                            <div class="filter-group">
                                <label>Month</label>
                                <input type="month" id="slipMonthFilter" onchange="filterSalarySlips()">
                            </div>
                            <div class="filter-group">
                                <label>Employee</label>
                                <select id="slipEmployeeFilter" onchange="filterSalarySlips()">
                                    <option value="">All Employees</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Department</label>
                                <select id="slipDepartmentFilter" onchange="filterSalarySlips()">
                                    <option value="">All Departments</option>
                                    <option value="Engineering">Engineering</option>
                                    <option value="Sales">Sales</option>
                                    <option value="HR">HR</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Operations">Operations</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Administration">Administration</option>
                                </select>
                            </div>
                        </div>

                        <!-- Salary Slips Table -->
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Employee</th>
                                        <th>Month</th>
                                        <th>Gross Salary</th>
                                        <th>Deductions</th>
                                        <th>Net Salary</th>
                                        <th>Generated Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="salarySlipsList">
                                    <tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìÑ</div><p>No salary slips generated yet.</p></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tasks Tab -->
                <div class="tab-pane" id="tasksTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìã Task Management</h3>
                            <div class="action-buttons">
                                <button class="btn btn-success btn-sm" id="createTaskBtn" onclick="showAddTaskModal()" style="display: none;">+ Create Task</button>
                                <button class="btn btn-info btn-sm" onclick="showAddSelfTaskModal()">+ Self-Assign Task</button>
                            </div>
                        </div>
                        
                        <!-- Task Stats -->
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <div class="stat-label">Total Tasks</div>
                                <div class="stat-value" id="totalTasks">0</div>
                            </div>
                            <div class="stat-card" style="background: #3b82f6; color: white;">
                                <div class="stat-label">In Progress</div>
                                <div class="stat-value" id="inProgressTasks">0</div>
                            </div>
                            <div class="stat-card" style="background: #f59e0b; color: white;">
                                <div class="stat-label">Pending</div>
                                <div class="stat-value" id="pendingTasks">0</div>
                            </div>
                            <div class="stat-card" style="background: #16a34a; color: white;">
                                <div class="stat-label">Completed</div>
                                <div class="stat-value" id="completedTasks">0</div>
                            </div>
                            <div class="stat-card" style="background: #0ea5e9; color: white;">
                                <div class="stat-label">Self-Assigned</div>
                                <div class="stat-value" id="selfAssignedTasks">0</div>
                            </div>
                        </div>

                        <!-- Filters -->
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchTasks" placeholder="Search tasks..." oninput="filterTasks()">
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="taskStatusFilter" onchange="filterTasks()">
                                    <option value="">All Status</option>
                                    <option value="Pending">Pending</option>
                                    <option value="In Progress">In Progress</option>
                                    <option value="Completed">Completed</option>
                                    <option value="On Hold">On Hold</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Priority</label>
                                <select id="taskPriorityFilter" onchange="filterTasks()">
                                    <option value="">All Priority</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Category</label>
                                <select id="taskCategoryFilter" onchange="filterTasks()">
                                    <option value="">All Categories</option>
                                    <option value="Installation">Installation</option>
                                    <option value="Modernization">Modernization</option>
                                    <option value="AMC">AMC</option>
                                    <option value="Repair">Repair</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Sales">Sales</option>
                                    <option value="Admin">Admin</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Assigned To</label>
                                <select id="taskAssigneeFilter" onchange="filterTasks()">
                                    <option value="">All Assignees</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Assignment Type</label>
                                <select id="taskTypeFilter" onchange="filterTasks()">
                                    <option value="">All Types</option>
                                    <option value="assigned">Admin Assigned</option>
                                    <option value="self">Self-Assigned</option>
                                </select>
                            </div>
                        </div>

                        <!-- Tasks Table -->
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Task Details</th>
                                        <th>Assigned To</th>
                                        <th>Category</th>
                                        <th>Priority</th>
                                        <th>Due Date</th>
                                        <th>Status</th>
                                        <th>Progress</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tasksList">
                                    <tr>
                                        <td colspan="8" class="empty-state">
                                            <div class="empty-state-icon">üìã</div>
                                            <p>No tasks found. Click "Create Task" to get started.</p>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- BOM Tab -->
                <div class="tab-pane" id="bomTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìã Bill of Materials (BOM)</h3>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="showCreateBOMModal()">‚ûï Create New BOM</button>
                            </div>
                        </div>

                        <!-- BOM Statistics -->
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <div class="stat-label">Total BOMs</div>
                                <div class="stat-value" id="totalBOMs">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Installation BOMs</div>
                                <div class="stat-value" id="installationBOMs">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Maintenance BOMs</div>
                                <div class="stat-value" id="maintenanceBOMs">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total BOM Value</div>
                                <div class="stat-value" id="totalBOMValue">‚Çπ0</div>
                            </div>
                        </div>

                        <!-- Filter Section -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 24px; border: 1px solid var(--border);">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                                <div class="form-group">
                                    <label>Project Type</label>
                                    <select class="form-control" id="bomFilterType" onchange="filterBOMs()">
                                        <option value="">All Types</option>
                                        <option value="Installation">Installation</option>
                                        <option value="Maintenance">Maintenance</option>
                                        <option value="Repair">Repair</option>
                                        <option value="Modernization">Modernization</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Search BOM</label>
                                    <input type="text" class="form-control" id="bomSearchInput" placeholder="Search by project name, elevator..." onkeyup="filterBOMs()">
                                </div>
                            </div>
                        </div>

                        <!-- BOMs List -->
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>BOM ID</th>
                                        <th>Project Type</th>
                                        <th>Client Name</th>
                                        <th>Site Location</th>
                                        <th>Total Items</th>
                                        <th>Total Value</th>
                                        <th>Created Date</th>
                                        <th style="text-align: center;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="bomTableBody">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                            No BOMs created yet. Click "Create New BOM" to get started.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div class="tab-pane" id="settingsTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">‚öôÔ∏è System Settings</h3>
                        </div>

                        <!-- Settings Navigation -->
                        <div class="nav-tabs" style="margin-bottom: 24px; border-bottom: 2px solid #e2e8f0;">
                            <div class="nav-tabs-container" style="background: white; padding: 0 20px;">
                                <button class="nav-tab active" onclick="showSettingsSection('company')">üè¢ Company Settings</button>
                                <button class="nav-tab" onclick="showSettingsSection('email')">üìß Email Configuration</button>
                                <button class="nav-tab" onclick="showSettingsSection('materials')">üì¶ Materials</button>
                            </div>
                        </div>

                        <!-- Company Settings Section -->
                        <div id="companySettings" class="settings-section">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary);">Company Information</h4>
                            <p style="margin-bottom: 20px; color: var(--text-secondary); font-size: 14px;">
                                Configure your company details. These will appear on all generated PDFs including AMC, Billing, and Maintenance Completion certificates.
                            </p>
                            
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label>Company Name *</label>
                                    <input type="text" class="form-control" id="companyName" placeholder="Enter company name">
                                </div>
                                <div class="form-group">
                                    <label>Company Email *</label>
                                    <input type="email" class="form-control" id="companyEmail" placeholder="info@company.com">
                                </div>
                            </div>
                            
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label>Contact Number *</label>
                                    <input type="tel" class="form-control" id="companyContact" placeholder="+91 1234567890">
                                </div>
                                <div class="form-group">
                                    <label>Website</label>
                                    <input type="url" class="form-control" id="companyWebsite" placeholder="www.company.com">
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label>Company Address *</label>
                                <textarea class="form-control" id="companyAddress" rows="3" placeholder="Enter complete address"></textarea>
                            </div>
                            
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label>GST Number</label>
                                    <input type="text" class="form-control" id="companyGST" placeholder="22AAAAA0000A1Z5">
                                </div>
                                <div class="form-group">
                                    <label>PAN Number</label>
                                    <input type="text" class="form-control" id="companyPAN" placeholder="AAAAA0000A">
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" onclick="saveCompanySettings()">üíæ Save Company Settings</button>
                        </div>

                        <!-- Email Configuration Section -->
                        <div id="emailSettings" class="settings-section" style="display: none;">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary);">Email Configuration</h4>
                            <p style="margin-bottom: 20px; color: var(--text-secondary); font-size: 14px;">
                                Configure email settings to send PDFs directly to clients. Supports Gmail, Outlook, and Zoho with App Passwords.
                            </p>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label>Email Provider *</label>
                                <select class="form-control" id="emailProvider" onchange="updateEmailPorts()">
                                    <option value="">Select Email Provider</option>
                                    <option value="gmail">Gmail (smtp.gmail.com)</option>
                                    <option value="outlook">Outlook (smtp.office365.com)</option>
                                    <option value="zoho">Zoho Mail (smtp.zoho.com)</option>
                                    <option value="custom">Custom SMTP Server</option>
                                </select>
                            </div>
                            
                            <div class="form-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label>SMTP Server *</label>
                                    <input type="text" class="form-control" id="smtpServer" placeholder="smtp.gmail.com" readonly>
                                </div>
                                <div class="form-group">
                                    <label>SMTP Port *</label>
                                    <input type="number" class="form-control" id="smtpPort" placeholder="587" readonly>
                                </div>
                                <div class="form-group">
                                    <label>Encryption</label>
                                    <input type="text" class="form-control" id="smtpEncryption" value="TLS" readonly>
                                </div>
                            </div>
                            
                            <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label>Email Address *</label>
                                    <input type="email" class="form-control" id="senderEmail" placeholder="your-email@gmail.com">
                                </div>
                                <div class="form-group">
                                    <label>App Password * <a href="#" onclick="showAppPasswordHelp(); return false;" style="font-size: 12px;">(How to get?)</a></label>
                                    <input type="password" class="form-control" id="appPassword" placeholder="Enter app password (e.g., dkSJUyVSfv3A)">
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label>Sender Name</label>
                                <input type="text" class="form-control" id="senderName" placeholder="e.g., Avant Elevators">
                            </div>
                            
                            <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 6px; padding: 16px; margin-bottom: 20px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <span style="font-size: 20px;">‚ÑπÔ∏è</span>
                                    <strong style="color: #0369a1;">Email Configuration Status</strong>
                                </div>
                                <div id="emailConfigStatus" style="color: #64748b; font-size: 14px;">
                                    Not configured. Please fill in all required fields and validate the connection.
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-primary" onclick="validateEmailConfig()">üîç Test & Validate Connection</button>
                                <button class="btn btn-success" onclick="saveEmailConfig()" id="saveEmailBtn" disabled>üíæ Save Email Configuration</button>
                            </div>
                        </div>

                        <!-- Materials Settings Section -->
                        <div id="materialsSettings" class="settings-section" style="display: none;">
                            <h4 style="margin-bottom: 20px; color: var(--text-primary);">üì¶ Materials Management</h4>
                            <p style="margin-bottom: 20px; color: var(--text-secondary); font-size: 14px;">
                                Add and manage materials that will be available when creating Bill of Materials (BOM) for projects.
                            </p>
                            
                            <!-- Add New Material Form -->
                            <div style="background: #f8fafc; border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 24px;">
                                <h5 style="margin-bottom: 16px; color: var(--text-primary);">Add New Material</h5>
                                <div class="form-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                                    <div class="form-group">
                                        <label>Material Name *</label>
                                        <input type="text" class="form-control" id="newMaterialName" placeholder="e.g., Steel Cable 10mm">
                                    </div>
                                    <div class="form-group">
                                        <label>Unit *</label>
                                        <select class="form-control" id="newMaterialUnit">
                                            <option value="">Select Unit</option>
                                            <option value="Pcs">Pcs</option>
                                            <option value="Meter">Meter</option>
                                            <option value="Kg">Kg</option>
                                            <option value="Liter">Liter</option>
                                            <option value="Set">Set</option>
                                            <option value="Box">Box</option>
                                            <option value="Roll">Roll</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>Unit Price (‚Çπ)</label>
                                        <input type="number" class="form-control" id="newMaterialPrice" placeholder="0.00" step="0.01">
                                    </div>
                                    <div class="form-group">
                                        <label style="visibility: hidden;">Action</label>
                                        <button class="btn btn-primary" onclick="addMaterial()" style="width: 100%;">‚ûï Add</button>
                                    </div>
                                </div>
                                <div class="form-row" style="display: grid; grid-template-columns: 1fr 200px; gap: 16px; margin-bottom: 16px;">
                                    <div class="form-group">
                                        <label>Image URL (Optional)</label>
                                        <input type="url" class="form-control" id="newMaterialImage" placeholder="https://example.com/image.jpg" onchange="previewMaterialImage()">
                                        <small style="color: var(--text-secondary); font-size: 11px;">Enter direct image URL (jpg, png, gif)</small>
                                    </div>
                                    <div class="form-group">
                                        <label>Image Preview</label>
                                        <div id="materialImagePreview" style="width: 100%; height: 100px; border: 2px dashed var(--border); border-radius: 6px; display: flex; align-items: center; justify-content: center; background: white; overflow: hidden;">
                                            <span style="color: var(--text-secondary); font-size: 12px;">No image</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Materials List -->
                            <div style="background: white; border: 1px solid var(--border); border-radius: 8px; overflow: hidden;">
                                <div style="padding: 16px; border-bottom: 1px solid var(--border); background: #f8fafc;">
                                    <h5 style="margin: 0; color: var(--text-primary);">Materials List</h5>
                                </div>
                                <div style="overflow-x: auto;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #f8fafc; border-bottom: 2px solid var(--border);">
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">#</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">Image</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">Material Name</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">Unit</th>
                                                <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">Unit Price</th>
                                                <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-primary);">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="materialsTableBody">
                                            <tr>
                                                <td colspan="6" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                                                    No materials added yet. Add your first material above.
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tracking Tab -->
                <div class="tab-pane" id="trackingTab">
                    <div id="trackingContent">
                        <div style="padding: 40px; text-align: center; color: #64748b;">
                            <div style="font-size: 48px; margin-bottom: 16px;">üó∫Ô∏è</div>
                            <p>Loading tracking dashboard...</p>
                        </div>
                    </div>
                </div>

                <!-- Billing Tab -->
                <div class="tab-pane" id="billingTab">
                    <!-- Billing Header -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üí∞ Billing & Invoicing Management</h3>
                            <div class="action-buttons">
                                <button class="btn btn-success btn-sm" onclick="showQuotationModal()">üìã New Quotation</button>
                                <button class="btn btn-info btn-sm" onclick="showPurchaseOrderModal()">üì¶ New Purchase Order</button>
                                <button class="btn btn-warning btn-sm" onclick="showProformaInvoiceModal()">üìÑ New Proforma Invoice</button>
                                <button class="btn btn-primary btn-sm" onclick="showTaxInvoiceModal()">üíµ New Tax Invoice</button>
                            </div>
                        </div>

                        <!-- Billing Statistics -->
                        <div class="stats-grid" style="margin-bottom: 24px;">
                            <div class="stat-card">
                                <div class="stat-label">Total Quotations</div>
                                <div class="stat-value" id="totalQuotations">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Active PIs</div>
                                <div class="stat-value" id="activeProformaInvoices">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Tax Invoices</div>
                                <div class="stat-value" id="totalTaxInvoices">0</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-label">Total Revenue</div>
                                <div class="stat-value" id="totalBillingRevenue">Rs. 0</div>
                            </div>
                        </div>

                        <!-- Billing Tabs -->
                        <div class="nav-tabs" style="margin-bottom: 24px; border-bottom: 2px solid #e2e8f0;">
                            <button class="btn btn-secondary btn-sm" onclick="showBillingSection('quotations')" id="quotationsTabBtn" style="border-radius: 0; border-bottom: 3px solid #2563eb;">üìã Quotations</button>
                            <button class="btn btn-secondary btn-sm" onclick="showBillingSection('purchaseOrders')" id="purchaseOrdersTabBtn" style="border-radius: 0;">üì¶ Purchase Orders</button>
                            <button class="btn btn-secondary btn-sm" onclick="showBillingSection('proformaInvoices')" id="proformaInvoicesTabBtn" style="border-radius: 0;">üìÑ Proforma Invoices</button>
                            <button class="btn btn-secondary btn-sm" onclick="showBillingSection('taxInvoices')" id="taxInvoicesTabBtn" style="border-radius: 0;">üíµ Tax Invoices</button>
                        </div>

                        <!-- Quotations Section -->
                        <div id="quotationsSection" class="billing-section">
                            <div class="filters">
                                <input type="text" id="searchQuotations" placeholder="Search quotations..." oninput="filterQuotations()">
                                <select id="quotationTypeFilter" onchange="filterQuotations()">
                                    <option value="">All Types</option>
                                    <option value="New Installation">New Installation</option>
                                    <option value="Modernization">Modernization</option>
                                    <option value="Repair Work">Repair Work</option>
                                </select>
                                <select id="quotationStatusFilter" onchange="filterQuotations()">
                                    <option value="">All Status</option>
                                    <option value="Draft">Draft</option>
                                    <option value="Sent">Sent</option>
                                    <option value="Accepted">Accepted</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Quotation #</th>
                                            <th>Type</th>
                                            <th>Client</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="quotationsList">
                                        <tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìã</div><p>No quotations yet. Click "New Quotation" to create one.</p></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Purchase Orders Section -->
                        <div id="purchaseOrdersSection" class="billing-section" style="display: none;">
                            <div class="filters">
                                <input type="text" id="searchPurchaseOrders" placeholder="Search purchase orders..." oninput="filterPurchaseOrders()">
                                <select id="poTypeFilter" onchange="filterPurchaseOrders()">
                                    <option value="">All Types</option>
                                    <option value="New Installation">New Installation</option>
                                    <option value="Modernization">Modernization</option>
                                    <option value="Repair Work">Repair Work</option>
                                </select>
                            </div>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>PO #</th>
                                            <th>Type</th>
                                            <th>Vendor</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="purchaseOrdersList">
                                        <tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üì¶</div><p>No purchase orders yet.</p></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Proforma Invoices Section -->
                        <div id="proformaInvoicesSection" class="billing-section" style="display: none;">
                            <div class="filters">
                                <input type="text" id="searchProformaInvoices" placeholder="Search proforma invoices..." oninput="filterProformaInvoices()">
                                <select id="piStatusFilter" onchange="filterProformaInvoices()">
                                    <option value="">All Status</option>
                                    <option value="Pending">Pending Payment</option>
                                    <option value="Partial">Partially Paid</option>
                                    <option value="Paid">Fully Paid</option>
                                </select>
                            </div>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>PI #</th>
                                            <th>Client</th>
                                            <th>Date</th>
                                            <th>Total Amount</th>
                                            <th>Paid Amount</th>
                                            <th>Balance</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="proformaInvoicesList">
                                        <tr><td colspan="8" class="empty-state"><div class="empty-state-icon">üìÑ</div><p>No proforma invoices yet.</p></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Tax Invoices Section -->
                        <div id="taxInvoicesSection" class="billing-section" style="display: none;">
                            <div class="filters">
                                <input type="text" id="searchTaxInvoices" placeholder="Search tax invoices..." oninput="filterTaxInvoices()">
                                <select id="taxInvoiceStatusFilter" onchange="filterTaxInvoices()">
                                    <option value="">All Status</option>
                                    <option value="Paid">Paid</option>
                                    <option value="Pending">Pending</option>
                                    <option value="Overdue">Overdue</option>
                                </select>
                            </div>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Invoice #</th>
                                            <th>Client</th>
                                            <th>Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Linked PI</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="taxInvoicesList">
                                        <tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üíµ</div><p>No tax invoices yet.</p></td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sales Tab -->
                <div class="tab-pane" id="salesTab">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Lead Management</h3>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="exportLeadsPDF()">üì• Export Leads</button>
                                <button class="btn btn-warning btn-sm" onclick="exportHoldReportPDF('leads')">Export Hold Report</button>
                                <button class="btn btn-primary btn-sm" onclick="bulkImportLeads()">üìÇ Import Leads</button>
                                <button class="btn btn-success btn-sm" onclick="showAddLeadModal()">+ Add Lead</button>
                            </div>
                        </div>

                        <!-- Lead Statistics -->
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                            <div class="stat-card">
                                <div class="stat-value" id="totalLeads">0</div>
                                <div class="stat-label">Total Leads</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="hotLeads">0</div>
                                <div class="stat-label">Hot Leads</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="convertedLeads">0</div>
                                <div class="stat-label">Converted</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="monthlyRevenue">Rs. 0</div>
                                <div class="stat-label">Monthly Revenue</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="conversionRate">0%</div>
                                <div class="stat-label">Conversion Rate</div>
                            </div>
                        </div>

                        <!-- Lead Filters -->
                        <div class="filters">
                            <div class="filter-group">
                                <label>Search</label>
                                <input type="text" id="searchLeads" placeholder="Search leads..." oninput="filterLeads()">
                            </div>
                            <div class="filter-group">
                                <label>Status</label>
                                <select id="leadStatusFilter" onchange="filterLeads()">
                                    <option value="">All Status</option>
                                    <option value="New">New</option>
                                    <option value="Contacted">Contacted</option>
                                    <option value="Qualified">Qualified</option>
                                    <option value="Proposal">Proposal</option>
                                    <option value="Negotiation">Negotiation</option>
                                    <option value="Converted">Converted</option>
                                    <option value="Lost">Lost</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Priority</label>
                                <select id="leadPriorityFilter" onchange="filterLeads()">
                                    <option value="">All Priority</option>
                                    <option value="Hot">Hot</option>
                                    <option value="Warm">Warm</option>
                                    <option value="Cold">Cold</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Assigned To</label>
                                <select id="leadAssignedFilter" onchange="filterLeads()">
                                    <option value="">All Sales Reps</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label>Source</label>
                                <select id="leadSourceFilter" onchange="filterLeads()">
                                    <option value="">All Sources</option>
                                    <option value="Website">Website</option>
                                    <option value="Referral">Referral</option>
                                    <option value="Cold Call">Cold Call</option>
                                    <option value="Exhibition">Exhibition</option>
                                    <option value="Social Media">Social Media</option>
                                    <option value="Print Ad">Print Ad</option>
                                    <option value="Direct Visit">Direct Visit</option>
                                </select>
                            </div>
                        </div>

                        <!-- Leads Table -->
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Lead Info</th>
                                        <th>Company</th>
                                        <th>Contact</th>
                                        <th>Requirements</th>
                                        <th>Value</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Assigned To</th>
                                        <th>Last Contact</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="leadsList">
                                    <tr><td colspan="10" class="loading"><div class="spinner"></div>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Lead Modal -->
    <div class="modal" id="leadModal">
        <div class="modal-dialog" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="leadModalTitle">Add New Lead</h3>
                <button class="modal-close" onclick="closeModal('leadModal')">&times;</button>
            </div>
            <form id="leadForm">
                <div class="modal-body">
                    <input type="hidden" id="editLeadId">
                    
                    <!-- Basic Information -->
                    <div class="card" style="background: #f8fafc; border: 1px solid #e2e8f0; margin-bottom: 20px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #1e40af; font-size: 16px;">üë§ Contact Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadName">Contact Person *</label>
                                <input type="text" class="form-control" id="leadName" required placeholder="Full name">
                            </div>
                            <div class="form-group">
                                <label for="leadDesignation">Designation</label>
                                <input type="text" class="form-control" id="leadDesignation" placeholder="e.g. Project Manager, Owner">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadPhone">Phone Number *</label>
                                <input type="tel" class="form-control" id="leadPhone" required placeholder="Primary contact number">
                            </div>
                            <div class="form-group">
                                <label for="leadAlternatePhone">Alternate Phone</label>
                                <input type="tel" class="form-control" id="leadAlternatePhone" placeholder="Secondary number">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="leadEmail">Email Address</label>
                            <input type="email" class="form-control" id="leadEmail" placeholder="contact@company.com">
                        </div>
                    </div>

                    <!-- Company Information -->
                    <div class="card" style="background: #fef7ff; border: 1px solid #e9d5ff; margin-bottom: 20px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #7c3aed; font-size: 16px;">üè¢ Company Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadCompany">Company Name *</label>
                                <input type="text" class="form-control" id="leadCompany" required placeholder="Company or project name">
                            </div>
                            <div class="form-group">
                                <label for="leadIndustry">Industry Type</label>
                                <select class="form-control" id="leadIndustry">
                                    <option value="">Select Industry</option>
                                    <option value="Residential">Residential Complex</option>
                                    <option value="Commercial">Commercial Building</option>
                                    <option value="Hospital">Hospital/Healthcare</option>
                                    <option value="Hotel">Hotel/Hospitality</option>
                                    <option value="Mall">Shopping Mall</option>
                                    <option value="Office">Office Complex</option>
                                    <option value="Industrial">Industrial</option>
                                    <option value="Educational">Educational Institution</option>
                                    <option value="Government">Government Building</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="leadAddress">Project Address *</label>
                            <textarea class="form-control" id="leadAddress" rows="2" required placeholder="Complete project/building address"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadCity">City *</label>
                                <input type="text" class="form-control" id="leadCity" required placeholder="City">
                            </div>
                            <div class="form-group">
                                <label for="leadState">State</label>
                                <input type="text" class="form-control" id="leadState" placeholder="State">
                            </div>
                        </div>
                    </div>

                    <!-- Project Requirements -->
                    <div class="card" style="background: #fff7ed; border: 1px solid #fed7aa; margin-bottom: 20px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #ea580c; font-size: 16px;">üèóÔ∏è Project Requirements</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadElevatorType">Elevator Type *</label>
                                <select class="form-control" id="leadElevatorType" required>
                                    <option value="">Select Type</option>
                                    <option value="Passenger">Passenger Elevator</option>
                                    <option value="Goods">Goods/Freight Elevator</option>
                                    <option value="Hospital">Hospital/Bed Elevator</option>
                                    <option value="Car">Car Elevator</option>
                                    <option value="Home">Home/Villa Elevator</option>
                                    <option value="Dumbwaiter">Dumbwaiter</option>
                                    <option value="Escalator">Escalator</option>
                                    <option value="Moving Walkway">Moving Walkway</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leadQuantity">Quantity Required *</label>
                                <input type="number" class="form-control" id="leadQuantity" required min="1" placeholder="Number of elevators">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadCapacity">Load Capacity (kg)</label>
                                <select class="form-control" id="leadCapacity">
                                    <option value="">Select Capacity</option>
                                    <option value="320">320 kg (4-5 persons)</option>
                                    <option value="450">450 kg (6 persons)</option>
                                    <option value="630">630 kg (8 persons)</option>
                                    <option value="800">800 kg (10 persons)</option>
                                    <option value="1000">1000 kg (13 persons)</option>
                                    <option value="1350">1350 kg (18 persons)</option>
                                    <option value="1600">1600 kg (21 persons)</option>
                                    <option value="2000">2000 kg (Goods/Freight)</option>
                                    <option value="3000">3000 kg (Heavy Goods)</option>
                                    <option value="5000">5000+ kg (Industrial)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leadFloors">Number of Floors</label>
                                <input type="number" class="form-control" id="leadFloors" min="2" placeholder="Total floors to serve">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="leadSpecifications">Special Requirements</label>
                            <textarea class="form-control" id="leadSpecifications" rows="2" placeholder="Any special requirements, features, or constraints"></textarea>
                        </div>
                    </div>

                    <!-- Business Information -->
                    <div class="card" style="background: #f0fdf4; border: 1px solid #bbf7d0; margin-bottom: 20px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #16a34a; font-size: 16px;">üí∞ Business Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadBudget">Estimated Budget (Rs. )</label>
                                <select class="form-control" id="leadBudget">
                                    <option value="">Select Budget Range</option>
                                    <option value="5-10 Lakhs">Rs. 5-10 Lakhs</option>
                                    <option value="10-20 Lakhs">Rs. 10-20 Lakhs</option>
                                    <option value="20-50 Lakhs">Rs. 20-50 Lakhs</option>
                                    <option value="50 Lakhs - 1 Crore">Rs. 50 Lakhs - 1 Crore</option>
                                    <option value="1-2 Crore">Rs. 1-2 Crore</option>
                                    <option value="2+ Crore">Rs. 2+ Crore</option>
                                    <option value="Custom">Custom Quote</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leadTimeline">Project Timeline</label>
                                <select class="form-control" id="leadTimeline">
                                    <option value="">Select Timeline</option>
                                    <option value="Immediate">Immediate (Within 1 month)</option>
                                    <option value="1-3 months">1-3 months</option>
                                    <option value="3-6 months">3-6 months</option>
                                    <option value="6-12 months">6-12 months</option>
                                    <option value="12+ months">12+ months</option>
                                    <option value="Planning stage">Still in planning</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="leadValue">Estimated Deal Value (Rs. )</label>
                                <input type="number" class="form-control" id="leadValue" step="0.01" placeholder="Expected contract value">
                            </div>
                            <div class="form-group">
                                <label for="leadProbability">Success Probability (%)</label>
                                <select class="form-control" id="leadProbability">
                                    <option value="">Select Probability</option>
                                    <option value="10">10% - Just inquiring</option>
                                    <option value="25">25% - Interested</option>
                                    <option value="50">50% - Serious consideration</option>
                                    <option value="75">75% - Very likely</option>
                                    <option value="90">90% - Almost confirmed</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Lead Management -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="leadSource">Lead Source *</label>
                            <select class="form-control" id="leadSource" required>
                                <option value="">Select Source</option>
                                <option value="Website">Website Inquiry</option>
                                <option value="Referral">Referral</option>
                                <option value="Cold Call">Cold Call</option>
                                <option value="Exhibition">Exhibition/Trade Show</option>
                                <option value="Social Media">Social Media</option>
                                <option value="Print Ad">Print Advertisement</option>
                                <option value="Direct Visit">Direct Visit</option>
                                <option value="Partner">Channel Partner</option>
                                <option value="Existing Customer">Existing Customer</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leadPriority">Lead Priority *</label>
                            <select class="form-control" id="leadPriority" required>
                                <option value="">Select Priority</option>
                                <option value="Hot">Hot - Immediate opportunity</option>
                                <option value="Warm">Warm - Interested</option>
                                <option value="Cold">Cold - Future potential</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="leadStatus">Lead Status</label>
                            <select class="form-control" id="leadStatus" onchange="toggleHoldFields('lead')">
                                <option value="New">New</option>
                                <option value="Contacted">Contacted</option>
                                <option value="Qualified">Qualified</option>
                                <option value="Proposal">Proposal Sent</option>
                                <option value="Negotiation">Negotiation</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Converted">Converted</option>
                                <option value="Lost">Lost</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leadAssignedTo">Assign To *</label>
                            <select class="form-control" id="leadAssignedTo" required>
                                <option value="">Select Sales Rep</option>
                            </select>
                        </div>
                    </div>

                    <!-- Hold Information (initially hidden) -->
                    <div class="hold-fields" id="leadHoldFields" style="display: none;">
                        <div class="card" style="background: #fef3c7; border: 1px solid #f59e0b; margin-bottom: 20px; padding: 16px;">
                            <h4 style="margin: 0 0 16px 0; color: #d97706; font-size: 16px;">Hold Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="leadHoldReason">Hold Reason *</label>
                                    <select class="form-control" id="leadHoldReason">
                                        <option value="">Select Reason</option>
                                        <option value="Client Budget Constraints">Client Budget Constraints</option>
                                        <option value="Project Timeline Delayed">Project Timeline Delayed</option>
                                        <option value="Approval Pending">Approval Pending</option>
                                        <option value="Site Not Ready">Site Not Ready</option>
                                        <option value="Technical Clarifications">Technical Clarifications Required</option>
                                        <option value="Competition Analysis">Competition Analysis in Progress</option>
                                        <option value="Monsoon/Weather">Monsoon/Weather Related</option>
                                        <option value="Regulatory Approvals">Regulatory Approvals Pending</option>
                                        <option value="Client Request">Client Request</option>
                                        <option value="Internal Review">Internal Review</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="leadHoldDate">Hold Date *</label>
                                    <input type="date" class="form-control" id="leadHoldDate">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="leadExpectedResumeDate">Expected Resume Date</label>
                                    <input type="date" class="form-control" id="leadExpectedResumeDate">
                                </div>
                                <div class="form-group">
                                    <label for="leadHoldDuration">Estimated Hold Duration</label>
                                    <select class="form-control" id="leadHoldDuration">
                                        <option value="">Select Duration</option>
                                        <option value="1-2 weeks">1-2 weeks</option>
                                        <option value="1 month">1 month</option>
                                        <option value="2-3 months">2-3 months</option>
                                        <option value="3-6 months">3-6 months</option>
                                        <option value="6-12 months">6-12 months</option>
                                        <option value="Indefinite">Indefinite</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="leadHoldNotes">Hold Description *</label>
                                <textarea class="form-control" id="leadHoldNotes" rows="3" placeholder="Detailed explanation of why the lead is on hold and any specific conditions for resuming"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="leadNotes">Notes & Comments</label>
                        <textarea class="form-control" id="leadNotes" rows="3" placeholder="Any additional notes, conversation history, or important details"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('leadModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Lead</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lead Details Modal -->
    <div class="modal" id="leadDetailsModal">
        <div class="modal-dialog" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">Lead Details & Activity</h3>
                <button class="modal-close" onclick="closeModal('leadDetailsModal')">&times;</button>
            </div>
            <div class="modal-body" id="leadDetailsContent">
                <!-- Content populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('leadDetailsModal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="addLeadActivity()">+ Add Activity</button>
            </div>
        </div>
    </div>

    <!-- Lead Activity Modal -->
    <div class="modal" id="leadActivityModal">
        <div class="modal-dialog" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="leadActivityModalTitle">Add Lead Activity</h3>
                <button class="modal-close" onclick="closeModal('leadActivityModal')">&times;</button>
            </div>
            <form id="leadActivityForm">
                <div class="modal-body">
                    <input type="hidden" id="currentLeadId">
                    
                    <!-- Activity Type -->
                    <div class="form-group">
                        <label for="activityType">Activity Type *</label>
                        <select class="form-control" id="activityType" required onchange="toggleActivityFields()">
                            <option value="">Select Activity Type</option>
                            <option value="call">Phone Call</option>
                            <option value="email">Email</option>
                            <option value="meeting">Meeting</option>
                            <option value="site_visit">Site Visit</option>
                            <option value="proposal">Proposal Sent</option>
                            <option value="quotation">Quotation Sent</option>
                            <option value="negotiation">Negotiation</option>
                            <option value="follow_up">Follow Up</option>
                            <option value="demo">Product Demo</option>
                            <option value="requirement">Requirement Discussion</option>
                            <option value="contract">Contract Discussion</option>
                            <option value="converted">Lead Converted</option>
                            <option value="lost">Lead Lost</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <!-- Activity Details -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="activityDate">Activity Date & Time *</label>
                            <input type="datetime-local" class="form-control" id="activityDate" required>
                        </div>
                        <div class="form-group">
                            <label for="activityDuration">Duration (minutes)</label>
                            <input type="number" class="form-control" id="activityDuration" min="1" placeholder="e.g., 30">
                        </div>
                    </div>

                    <!-- Contact Person -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="contactedPerson">Person Contacted *</label>
                            <input type="text" class="form-control" id="contactedPerson" required placeholder="Name of person you spoke with">
                        </div>
                        <div class="form-group">
                            <label for="contactDesignation">Their Designation</label>
                            <input type="text" class="form-control" id="contactDesignation" placeholder="e.g., Project Manager, Owner">
                        </div>
                    </div>

                    <!-- Activity Description -->
                    <div class="form-group">
                        <label for="activityDescription">Activity Description *</label>
                        <textarea class="form-control" id="activityDescription" rows="3" required placeholder="Describe what was discussed, outcomes, next steps, etc."></textarea>
                    </div>

                    <!-- Call Specific Fields -->
                    <div id="callFields" class="activity-specific-fields" style="display: none;">
                        <div class="card" style="background: #f0f9ff; border: 1px solid #0ea5e9; margin: 16px 0; padding: 16px;">
                            <h5 style="color: #0369a1; margin: 0 0 12px 0;">Call Details</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="callStatus">Call Status</label>
                                    <select class="form-control" id="callStatus">
                                        <option value="successful">Successful - Person Available</option>
                                        <option value="busy">Line Busy</option>
                                        <option value="no_answer">No Answer</option>
                                        <option value="voicemail">Voicemail Left</option>
                                        <option value="wrong_number">Wrong Number</option>
                                        <option value="callback_requested">Callback Requested</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="nextCallDate">Next Call Scheduled</label>
                                    <input type="datetime-local" class="form-control" id="nextCallDate">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Meeting Specific Fields -->
                    <div id="meetingFields" class="activity-specific-fields" style="display: none;">
                        <div class="card" style="background: #f0fdf4; border: 1px solid #22c55e; margin: 16px 0; padding: 16px;">
                            <h5 style="color: #166534; margin: 0 0 12px 0;">Meeting Details</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="meetingLocation">Meeting Location</label>
                                    <input type="text" class="form-control" id="meetingLocation" placeholder="Office address, online, site location, etc.">
                                </div>
                                <div class="form-group">
                                    <label for="attendees">Attendees</label>
                                    <input type="text" class="form-control" id="attendees" placeholder="Names of all attendees">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="nextMeeting">Next Meeting Scheduled</label>
                                <input type="datetime-local" class="form-control" id="nextMeeting">
                            </div>
                        </div>
                    </div>

                    <!-- Proposal/Quotation Fields -->
                    <div id="proposalFields" class="activity-specific-fields" style="display: none;">
                        <div class="card" style="background: #fef3c7; border: 1px solid #f59e0b; margin: 16px 0; padding: 16px;">
                            <h5 style="color: #92400e; margin: 0 0 12px 0;">Proposal/Quotation Details</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="proposalAmount">Quoted Amount (Rs. )</label>
                                    <input type="number" class="form-control" id="proposalAmount" step="0.01" placeholder="Total quoted amount">
                                </div>
                                <div class="form-group">
                                    <label for="validityPeriod">Validity Period (days)</label>
                                    <input type="number" class="form-control" id="validityPeriod" min="1" placeholder="e.g., 30">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="proposalReference">Reference Number</label>
                                <input type="text" class="form-control" id="proposalReference" placeholder="Proposal/Quotation reference number">
                            </div>
                        </div>
                    </div>

                    <!-- Outcome & Follow-up -->
                    <div class="form-section">
                        <h5 style="color: #374151; margin: 16px 0 12px 0;">Outcome & Next Steps</h5>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="activityOutcome">Activity Outcome</label>
                                <select class="form-control" id="activityOutcome">
                                    <option value="">Select Outcome</option>
                                    <option value="positive">Positive Response</option>
                                    <option value="interested">Showed Interest</option>
                                    <option value="neutral">Neutral Response</option>
                                    <option value="negative">Not Interested</option>
                                    <option value="needs_info">Requested More Information</option>
                                    <option value="decision_pending">Decision Pending</option>
                                    <option value="budget_issue">Budget Constraints</option>
                                    <option value="competitor">Considering Competitors</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="leadTemperature">Lead Temperature</label>
                                <select class="form-control" id="leadTemperature">
                                    <option value="">Current Temperature</option>
                                    <option value="hot">Hot - Ready to Buy</option>
                                    <option value="warm">Warm - Interested</option>
                                    <option value="cold">Cold - Future Potential</option>
                                    <option value="frozen">Frozen - Lost Interest</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="nextAction">Next Action Required</label>
                                <select class="form-control" id="nextAction">
                                    <option value="">Select Next Action</option>
                                    <option value="follow_up_call">Follow-up Call</option>
                                    <option value="send_info">Send Information</option>
                                    <option value="schedule_meeting">Schedule Meeting</option>
                                    <option value="site_visit">Site Visit</option>
                                    <option value="prepare_proposal">Prepare Proposal</option>
                                    <option value="price_revision">Revise Pricing</option>
                                    <option value="technical_clarification">Technical Clarification</option>
                                    <option value="contract_preparation">Prepare Contract</option>
                                    <option value="wait_customer">Wait for Customer</option>
                                    <option value="no_action">No Further Action</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="nextActionDate">Next Action Date</label>
                                <input type="datetime-local" class="form-control" id="nextActionDate">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="nextStepNotes">Next Steps / Reminders</label>
                            <textarea class="form-control" id="nextStepNotes" rows="2" placeholder="What needs to be done next? Any reminders or important points to remember..."></textarea>
                        </div>
                    </div>

                    <!-- Internal Notes -->
                    <div class="form-group">
                        <label for="internalNotes">Internal Notes</label>
                        <textarea class="form-control" id="internalNotes" rows="2" placeholder="Private notes for team use (not visible to customer)"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('leadActivityModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Activity</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div class="modal" id="inventoryModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title" id="inventoryModalTitle">Add Inventory Item</h3>
                <button class="modal-close" onclick="closeModal('inventoryModal')">&times;</button>
            </div>
            <form id="inventoryForm">
                <div class="modal-body">
                    <input type="hidden" id="editItemId">
                    <input type="hidden" id="itemLocation">
                    <div class="form-group">
                        <label>Item Name *</label>
                        <input type="text" class="form-control" id="itemName" required>
                    </div>
                    <div class="form-group">
                        <label>Barcode/SKU</label>
                        <input type="text" class="form-control" id="itemBarcode" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label>Category *</label>
                        <select class="form-control" id="itemCategory" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Quantity *</label>
                            <input type="number" class="form-control" id="itemQuantity" required min="0">
                        </div>
                        <div class="form-group">
                            <label>Unit *</label>
                            <input type="text" class="form-control" id="itemUnit" required placeholder="e.g. pcs, kg, m">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <input type="text" class="form-control" id="itemDescription" placeholder="Additional details">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('inventoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Item</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Use Inventory Modal -->
    <div class="modal" id="useModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Use Inventory</h3>
                <button class="modal-close" onclick="closeModal('useModal')">&times;</button>
            </div>
            <form id="useForm">
                <div class="modal-body">
                    <input type="hidden" id="useItemId">
                    <div class="form-group">
                        <label>Item: <strong id="useItemName"></strong></label>
                        <p class="info-text">Available: <span id="useAvailable"></span></p>
                    </div>
                    <div class="form-group">
                        <label>Quantity to Use *</label>
                        <input type="number" class="form-control" id="useQuantity" required min="1">
                    </div>
                    <div class="form-group">
                        <label>Assign to Project *</label>
                        <select class="form-control" id="useProject" required>
                            <option value="">Select Project</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" class="form-control" id="useNotes" placeholder="Optional notes">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('useModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Use & Assign</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div class="modal" id="addStockModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Add Stock</h3>
                <button class="modal-close" onclick="closeModal('addStockModal')">&times;</button>
            </div>
            <form id="addStockForm">
                <div class="modal-body">
                    <input type="hidden" id="addStockItemId">
                    <div class="form-group">
                        <label>Item: <strong id="addStockItemName"></strong></label>
                        <p class="info-text">Current: <span id="addStockCurrent"></span></p>
                    </div>
                    <div class="form-group">
                        <label>Quantity to Add *</label>
                        <input type="number" class="form-control" id="addStockQuantity" required min="1">
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" class="form-control" id="addStockNotes" placeholder="Optional notes">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addStockModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Add Stock</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title" id="projectModalTitle">Create New Project</h3>
                <button class="modal-close" onclick="closeModal('projectModal')">&times;</button>
            </div>
            <form id="projectForm">
                <div class="modal-body">
                    <input type="hidden" id="editProjectId">
                    <input type="hidden" id="projectContactsData">
                    <input type="hidden" id="projectLiftsData">
                    
                    <!-- Basic Project Information -->
                    <div class="card" style="background: #f0f9ff; border: 1px solid #bae6fd; margin-bottom: 20px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #0369a1; font-size: 16px;">üìã Basic Information</h4>
                        <div class="form-group">
                            <label>Project Name *</label>
                            <input type="text" class="form-control" id="projectName" required>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Project Code *</label>
                                <input type="text" class="form-control" id="projectCode" required>
                            </div>
                            <div class="form-group">
                                <label>Project Type *</label>
                                <select class="form-control" id="projectType" required onchange="toggleProjectTypeFields()">
                                    <option value="">Select Type</option>
                                    <option value="Installation">New Installation</option>
                                    <option value="Modernization">Modernization</option>
                                    <option value="Maintenance">Maintenance Contract</option>
                                    <option value="Repair">Emergency Repair</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Client Contact Information - Multiple Contacts -->
                    <div class="card" style="background: #fef3c7; border: 1px solid #fcd34d; margin-bottom: 20px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #d97706; font-size: 16px;">üë• Client Contact Information</h4>
                        <div class="form-group">
                            <label>Company/Client Name *</label>
                            <input type="text" class="form-control" id="projectClient" required placeholder="Enter client/company name">
                        </div>
                        
                        <div id="clientContactsList"></div>
                        
                        <button type="button" class="btn btn-primary btn-sm" onclick="addClientContact()" style="margin-top: 10px;">
                            + Add Contact Person
                        </button>
                    </div>

                    <!-- Location with Google Maps -->
                    <div class="card" style="background: #f0fdf4; border: 1px solid #86efac; margin-bottom: 20px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #15803d; font-size: 16px;">üìç Project Location</h4>
                        <div class="form-group">
                            <label>Building Address *</label>
                            <textarea class="form-control" id="projectAddress" rows="2" placeholder="Enter complete building address" required></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Google Maps Link</label>
                                <input type="url" class="form-control" id="projectMapsLink" placeholder="Paste Google Maps link here">
                                <small style="color: #64748b;">Get link: Open Google Maps ‚Üí Right-click location ‚Üí Copy link</small>
                            </div>
                            <div class="form-group">
                                <button type="button" class="btn btn-success btn-sm" onclick="openProjectLocation()" style="margin-top: 24px;">
                                    üìç Open in Google Maps
                                </button>
                            </div>
                        </div>
                        
                        <!-- Site Geofence Configuration -->
                        <div style="margin-top: 20px; padding: 16px; background: #dbeafe; border: 1px solid #60a5fa; border-radius: 6px;">
                            <h5 style="margin: 0 0 12px 0; color: #1e40af; font-size: 14px; font-weight: 600;">üó∫Ô∏è Site Geofence (For Technician Tracking)</h5>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Site Latitude</label>
                                    <input type="number" step="0.000001" class="form-control" id="siteLat" placeholder="e.g. 19.0760">
                                    <small style="color: #64748b;">Get from Google Maps coordinates</small>
                                </div>
                                <div class="form-group">
                                    <label>Site Longitude</label>
                                    <input type="number" step="0.000001" class="form-control" id="siteLng" placeholder="e.g. 72.8777">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Geofence Radius (meters)</label>
                                <input type="number" class="form-control" id="siteRadius" placeholder="100" value="100">
                                <small style="color: #64748b;">Default: 100 meters. System detects when technicians enter/exit this radius.</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sub-Apartments (Optional) -->
                    <div class="form-group">
                        <label>Sub-Apartments (Optional) <small style="color: var(--text-secondary);">If this project has multiple named apartments</small></label>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <input type="text" class="form-control" id="subApartmentInput" placeholder="e.g., Osho Dhara, Osho Flowers">
                            <button type="button" class="btn btn-primary" onclick="addSubApartment()">Add</button>
                        </div>
                        <div id="subApartmentsList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                    </div>
                    
                    <!-- Wings/Blocks Configuration -->
                    <div class="card" style="background: #fef3c7; border: 1px solid #fbbf24; margin-bottom: 20px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #d97706; font-size: 16px;">üè¢ Wings/Blocks Configuration</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Number of Wings/Blocks *</label>
                                <input type="number" class="form-control" id="projectWingsCount" min="1" value="1" required onchange="generateWingsFields()">
                                <small style="color: #64748b;">Buildings, Towers, or Blocks (e.g., A Wing, B Wing, Main Building)</small>
                            </div>
                        </div>
                        
                        <div id="wingsConfigurationContainer"></div>
                    </div>
                    
                    <!-- Individual Lift Configuration -->
                    <div class="card" style="background: #ede9fe; border: 1px solid #c4b5fd; margin-bottom: 20px; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #7c3aed; font-size: 16px;">üèóÔ∏è Lift/Elevator Configuration</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Number of Lifts *</label>
                                <input type="number" class="form-control" id="projectLiftsCount" min="1" value="1" required onchange="generateLiftFields()">
                                <small style="color: #64748b;">Each lift can have different specifications</small>
                            </div>
                        </div>
                        
                        <div id="liftsConfigurationContainer"></div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" class="form-control" id="projectStartDate">
                        </div>
                        <div class="form-group" id="expectedCompletionGroup">
                            <label>Expected Completion</label>
                            <input type="date" class="form-control" id="projectEndDate">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Status *</label>
                            <select class="form-control" id="projectStatus" required onchange="toggleHoldFields('project')">
                                <option value="Active">Active</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Progress %</label>
                            <input type="number" class="form-control" id="projectProgress" min="0" max="100" value="0">
                        </div>
                    </div>

                    <!-- Hold Information for Projects (initially hidden) -->
                    <div class="hold-fields" id="projectHoldFields" style="display: none;">
                        <div class="card" style="background: #fef3c7; border: 1px solid #f59e0b; margin-bottom: 20px; padding: 16px;">
                            <h4 style="margin: 0 0 16px 0; color: #d97706; font-size: 16px;">Hold Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="projectHoldReason">Hold Reason *</label>
                                    <select class="form-control" id="projectHoldReason">
                                        <option value="">Select Reason</option>
                                        <option value="Client Budget Issues">Client Budget Issues</option>
                                        <option value="Site Not Ready">Site Not Ready</option>
                                        <option value="Material Shortage">Material Shortage</option>
                                        <option value="Design Changes">Design Changes Required</option>
                                        <option value="Permit Delays">Permit/Approval Delays</option>
                                        <option value="Weather Conditions">Weather Conditions</option>
                                        <option value="Client Request">Client Request</option>
                                        <option value="Safety Concerns">Safety Concerns</option>
                                        <option value="Technical Issues">Technical Issues</option>
                                        <option value="Resource Unavailability">Resource Unavailability</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="projectHoldDate">Hold Date *</label>
                                    <input type="date" class="form-control" id="projectHoldDate">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="projectExpectedResumeDate">Expected Resume Date</label>
                                    <input type="date" class="form-control" id="projectExpectedResumeDate">
                                </div>
                                <div class="form-group">
                                    <label for="projectHoldDuration">Estimated Hold Duration</label>
                                    <select class="form-control" id="projectHoldDuration">
                                        <option value="">Select Duration</option>
                                        <option value="1-2 weeks">1-2 weeks</option>
                                        <option value="1 month">1 month</option>
                                        <option value="2-3 months">2-3 months</option>
                                        <option value="3-6 months">3-6 months</option>
                                        <option value="6-12 months">6-12 months</option>
                                        <option value="Indefinite">Indefinite</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="projectHoldNotes">Hold Description *</label>
                                <textarea class="form-control" id="projectHoldNotes" rows="3" placeholder="Detailed explanation of why the project is on hold and conditions for resuming"></textarea>
                            </div>
                        </div>
                    </div>

                    <div id="projectItemsSection" style="display: none;">
                        <div class="form-group">
                            <label>Allocated Items</label>
                            <div id="projectItemsList" class="project-items"></div>
                        </div>
                        <div class="form-group">
                            <label>Return Remaining Stock</label>
                            <div id="returnItemsList"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                    <button type="submit" class="btn btn-success" id="projectSubmitBtn">Create Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Employee HR Modal -->
    <div class="modal" id="employeeModal">
        <div class="modal-dialog" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title" id="employeeModalTitle">Add Employee</h3>
                <button class="modal-close" onclick="closeModal('employeeModal')">&times;</button>
            </div>
            <form id="employeeForm">
                <div class="modal-body">
                    <input type="hidden" id="editEmployeeId">
                    
                    <!-- Personal Information Section -->
                    <div class="form-section">
                        <h4 style="color: #2563eb; margin-bottom: 16px;">üë§ Personal Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="employeeId">Employee ID *</label>
                                <input type="text" class="form-control" id="employeeId" required placeholder="EMP001">
                            </div>
                            <div class="form-group">
                                <label for="firstName">First Name *</label>
                                <input type="text" class="form-control" id="firstName" required>
                            </div>
                            <div class="form-group">
                                <label for="lastName">Last Name *</label>
                                <input type="text" class="form-control" id="lastName" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="email">Email Address *</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="form-group">
                                <label for="phone">Phone Number *</label>
                                <input type="tel" class="form-control" id="phone" required>
                            </div>
                            <div class="form-group">
                                <label for="dateOfBirth">Date of Birth</label>
                                <input type="date" class="form-control" id="dateOfBirth">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="address">Address</label>
                                <textarea class="form-control" id="address" rows="2"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="emergencyContact">Emergency Contact</label>
                                <input type="text" class="form-control" id="emergencyContact" placeholder="Name & Phone">
                            </div>
                        </div>
                    </div>

                    <!-- Professional Information Section -->
                    <div class="form-section">
                        <h4 style="color: #059669; margin-bottom: 16px;">üíº Professional Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="position">Position *</label>
                                <select class="form-control" id="position" required>
                                    <option value="">Select Position</option>
                                    <option value="Manager">Manager</option>
                                    <option value="Engineer">Engineer</option>
                                    <option value="Technician">Technician</option>
                                    <option value="Sales Executive">Sales Executive</option>
                                    <option value="Administrator">Administrator</option>
                                    <option value="Receptionist">Receptionist</option>
                                    <option value="HR Executive">HR Executive</option>
                                    <option value="Finance Executive">Finance Executive</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="department">Department *</label>
                                <select class="form-control" id="department" required>
                                    <option value="">Select Department</option>
                                    <option value="Engineering">Engineering</option>
                                    <option value="Sales">Sales</option>
                                    <option value="HR">HR</option>
                                    <option value="Finance">Finance</option>
                                    <option value="Operations">Operations</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Administration">Administration</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="joiningDate">Joining Date *</label>
                                <input type="date" class="form-control" id="joiningDate" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="employmentType">Employment Type</label>
                                <select class="form-control" id="employmentType">
                                    <option value="Full-Time">Full-Time</option>
                                    <option value="Part-Time">Part-Time</option>
                                    <option value="Contract">Contract</option>
                                    <option value="Intern">Intern</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="reportingManager">Reporting Manager</label>
                                <select class="form-control" id="reportingManager">
                                    <option value="">Select Manager</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="workLocation">Work Location</label>
                                <input type="text" class="form-control" id="workLocation" placeholder="Office/Site Location">
                            </div>
                        </div>
                    </div>

                    <!-- Salary Information Section -->
                    <div class="form-section">
                        <h4 style="color: #dc2626; margin-bottom: 16px;">üí∞ Salary Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="lastSalary">Last Salary (Previous Company)</label>
                                <input type="number" class="form-control" id="lastSalary" min="0" step="100" placeholder="Rs.  0">
                                <small class="form-text text-muted">Salary from previous employment</small>
                            </div>
                            <div class="form-group">
                                <label for="currentSalary">Current Salary (Monthly) *</label>
                                <input type="number" class="form-control" id="currentSalary" required min="0" step="100" placeholder="Rs.  0">
                                <small class="form-text text-muted">Current monthly salary</small>
                            </div>
                            <div class="form-group">
                                <label for="salaryEffectiveDate">Salary Effective Date</label>
                                <input type="date" class="form-control" id="salaryEffectiveDate">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="allowances">Allowances (Monthly)</label>
                                <input type="number" class="form-control" id="allowances" min="0" step="100" placeholder="Rs.  0">
                                <small class="form-text text-muted">HRA, Transport, etc.</small>
                            </div>
                            <div class="form-group">
                                <label for="bonus">Annual Bonus</label>
                                <input type="number" class="form-control" id="bonus" min="0" step="1000" placeholder="Rs.  0">
                            </div>
                            <div class="form-group">
                                <label for="bankAccount">Bank Account Number</label>
                                <input type="text" class="form-control" id="bankAccount" placeholder="Account Number">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="bankName">Bank Name</label>
                                <input type="text" class="form-control" id="bankName" placeholder="Bank Name">
                            </div>
                            <div class="form-group">
                                <label for="ifscCode">IFSC Code</label>
                                <input type="text" class="form-control" id="ifscCode" placeholder="IFSC Code">
                            </div>
                            <div class="form-group">
                                <label for="panNumber">PAN Number</label>
                                <input type="text" class="form-control" id="panNumber" placeholder="PAN Number">
                            </div>
                        </div>
                    </div>

                    <!-- System Access Section -->
                    <div class="form-section">
                        <h4 style="color: #7c3aed; margin-bottom: 16px;">üîê System Access</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="employeeUsername">Username *</label>
                                <input type="text" class="form-control" id="employeeUsername" required autocomplete="off">
                                <small class="form-text text-muted">For system login</small>
                            </div>
                            <div class="form-group">
                                <label for="employeePassword">Password *</label>
                                <input type="password" class="form-control" id="employeePassword" required minlength="6" autocomplete="new-password">
                                <small class="form-text text-muted">Minimum 6 characters</small>
                            </div>
                            <div class="form-group">
                                <label for="systemRole">System Role *</label>
                                <select class="form-control" id="systemRole" required>
                                    <option value="">Select Role</option>
                                    <option value="admin">Admin</option>
                                    <option value="technician">Technician</option>
                                    <option value="reception">Receptionist</option>
                                    <option value="sales">Sales Representative</option>
                                    <option value="user">General User</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="employeeStatus">Employment Status</label>
                                <select class="form-control" id="employeeStatus">
                                    <option value="Active">Active</option>
                                    <option value="On Leave">On Leave</option>
                                    <option value="Resigned">Resigned</option>
                                    <option value="Terminated">Terminated</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="lastWorkingDate">Last Working Date</label>
                                <input type="date" class="form-control" id="lastWorkingDate">
                                <small class="form-text text-muted">For resigned/terminated employees</small>
                            </div>
                            <div class="form-group">
                                <label for="systemStatus">System Access Status</label>
                                <select class="form-control" id="systemStatus">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="form-section">
                        <h4 style="color: #64748b; margin-bottom: 16px;">üìù Additional Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="skills">Skills & Qualifications</label>
                                <textarea class="form-control" id="skills" rows="2" placeholder="List key skills and qualifications"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="notes">Notes</label>
                                <textarea class="form-control" id="notes" rows="2" placeholder="Any additional notes"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('employeeModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="exportIndividualHRReport()" id="exportEmployeeBtn" style="display: none;">üì• Export Report</button>
                    <button type="submit" class="btn btn-success">Save Employee</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Barcode Scanner Modal -->
    <div class="modal" id="barcodeModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Barcode Scanner</h3>
                <button class="modal-close" onclick="closeBarcodeScanner()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="camera-permission-info" id="cameraPermissionInfo" style="display: none;">
                    ‚ÑπÔ∏è Camera access is required to scan barcodes. Please allow camera permission when prompted.
                </div>
                <div class="barcode-reader">
                    <video id="barcodeVideo" autoplay playsinline></video>
                    <div id="scanStatus" class="scan-status">Initializing scanner...</div>
                    <div id="barcodeResult" class="barcode-result" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeBarcodeScanner()">Close</button>
            </div>
        </div>
    </div>

    <!-- RCI (Repairs, Complaints & Maintenance) Modal -->
    <div class="modal" id="maintenanceModal">
        <div class="modal-dialog" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="maintenanceModalTitle">New RCI Record</h3>
                <button class="modal-close" onclick="closeModal('maintenanceModal')">&times;</button>
            </div>
            <form id="maintenanceForm">
                <div class="modal-body">
                    <input type="hidden" id="editMaintenanceId">
                    
                    <!-- RCI Type Selection -->
                    <div class="form-section" style="background: #f0f9ff; border: 2px solid #0ea5e9; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #0369a1; margin: 0 0 12px 0;">Record Type *</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="rciType">Type of Record *</label>
                                <select class="form-control" id="rciType" required style="font-weight: 600;">
                                    <option value="">Select Type</option>
                                    <option value="Repair">üîß Repair</option>
                                    <option value="Complaint">üì¢ Complaint</option>
                                    <option value="Maintenance">üõ†Ô∏è Scheduled Maintenance</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maintenanceProject">Project *</label>
                            <select class="form-control" id="maintenanceProject" required onchange="loadSubApartments('maintenance')">
                                <option value="">Select Project</option>
                            </select>
                        </div>
                        <div class="form-group" id="maintenanceSubApartmentGroup" style="display: none;">
                            <label for="maintenanceSubApartment">Sub-Apartment (Optional)</label>
                            <select class="form-control" id="maintenanceSubApartment" onchange="loadWings('maintenance')">
                                <option value="">None - Main Project</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Building Details -->
                    <div class="card" style="background: #f1f5f9; border: 1px solid #cbd5e1; margin: 16px 0; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #475569; font-size: 16px;">üè¢ Location Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="maintenanceWing">Wing/Block *</label>
                                <select class="form-control" id="maintenanceWing" required onchange="loadElevatorsByWing('maintenance')">
                                    <option value="">Select Wing</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="maintenanceFloor">Floor Number</label>
                                <input type="text" class="form-control" id="maintenanceFloor" placeholder="e.g., Ground, 1st, 2nd">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="maintenanceApartment">Apartment/Unit Number</label>
                                <input type="text" class="form-control" id="maintenanceApartment" placeholder="e.g., 101, A-204">
                            </div>
                            <div class="form-group">
                                <label for="maintenanceElevator">Select Elevators * <small style="color: var(--text-secondary);">(Hold Ctrl/Cmd to select multiple)</small></label>
                                <select class="form-control" id="maintenanceElevator" multiple required style="min-height: 100px;">
                                    <option value="">Select wing first...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenanceIssue">Issue Description *</label>
                        <textarea class="form-control" id="maintenanceIssue" rows="3" required placeholder="Describe the repair/complaint/maintenance task in detail"></textarea>
                    </div>

                    <!-- Complaint Person Details -->
                    <div class="card" style="background: #f8fafc; border: 1px solid #e2e8f0; margin: 16px 0; padding: 16px;">
                        <h4 style="margin: 0 0 16px 0; color: #1e40af; font-size: 16px;">üë§ Reported By</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="complaintPersonName">Person Name *</label>
                                <input type="text" class="form-control" id="complaintPersonName" required placeholder="Name of person who reported">
                            </div>
                            <div class="form-group">
                                <label for="complaintPersonPhone">Phone Number *</label>
                                <input type="tel" class="form-control" id="complaintPersonPhone" required placeholder="Contact number">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="complaintPersonEmail">Email</label>
                                <input type="email" class="form-control" id="complaintPersonEmail" placeholder="Email address (optional)">
                            </div>
                            <div class="form-group">
                                <label for="complaintPersonDesignation">Designation</label>
                                <input type="text" class="form-control" id="complaintPersonDesignation" placeholder="e.g. Building Manager, Resident, etc.">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="complaintPersonAddress">Building Address *</label>
                            <textarea class="form-control" id="complaintPersonAddress" rows="2" required placeholder="Complete building address"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="complaintDate">Complaint Date *</label>
                            <input type="datetime-local" class="form-control" id="complaintDate" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maintenancePriority">Priority *</label>
                            <select class="form-control" id="maintenancePriority" required>
                                <option value="">Select Priority</option>
                                <option value="High">High</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="maintenanceAssignee">Assign To *</label>
                            <select class="form-control" id="maintenanceAssignee" required>
                                <option value="">Select Technician</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="maintenanceDueDate">Due Date *</label>
                            <input type="date" class="form-control" id="maintenanceDueDate" required>
                        </div>
                        <div class="form-group">
                            <label for="maintenanceStatus">Status</label>
                            <select class="form-control" id="maintenanceStatus" onchange="toggleSignatureSection(); toggleHoldFields('maintenance')">
                                <option value="Scheduled">Scheduled</option>
                                <option value="In Progress">In Progress</option>
                                <option value="On Hold">On Hold</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Hold Information for Maintenance (initially hidden) -->
                    <div class="hold-fields" id="maintenanceHoldFields" style="display: none;">
                        <div class="card" style="background: #fef3c7; border: 1px solid #f59e0b; margin-bottom: 20px; padding: 16px;">
                            <h4 style="margin: 0 0 16px 0; color: #d97706; font-size: 16px;">Hold Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="maintenanceHoldReason">Hold Reason *</label>
                                    <select class="form-control" id="maintenanceHoldReason">
                                        <option value="">Select Reason</option>
                                        <option value="Client Unavailable">Client Unavailable</option>
                                        <option value="Site Access Issues">Site Access Issues</option>
                                        <option value="Parts Not Available">Parts Not Available</option>
                                        <option value="Safety Concerns">Safety Concerns</option>
                                        <option value="Elevator in Use">Elevator in Use - Cannot Stop</option>
                                        <option value="Weather Conditions">Weather Conditions</option>
                                        <option value="Client Request">Client Request</option>
                                        <option value="Technician Unavailable">Technician Unavailable</option>
                                        <option value="Regulatory Issues">Regulatory/Permit Issues</option>
                                        <option value="Equipment Issues">Equipment/Tools Issues</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="maintenanceHoldDate">Hold Date *</label>
                                    <input type="date" class="form-control" id="maintenanceHoldDate">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="maintenanceExpectedResumeDate">Expected Resume Date</label>
                                    <input type="date" class="form-control" id="maintenanceExpectedResumeDate">
                                </div>
                                <div class="form-group">
                                    <label for="maintenanceHoldDuration">Estimated Hold Duration</label>
                                    <select class="form-control" id="maintenanceHoldDuration">
                                        <option value="">Select Duration</option>
                                        <option value="1-3 days">1-3 days</option>
                                        <option value="1 week">1 week</option>
                                        <option value="2 weeks">2 weeks</option>
                                        <option value="1 month">1 month</option>
                                        <option value="2-3 months">2-3 months</option>
                                        <option value="Indefinite">Indefinite</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="maintenanceHoldNotes">Hold Description *</label>
                                <textarea class="form-control" id="maintenanceHoldNotes" rows="3" placeholder="Detailed explanation of why the maintenance is on hold and conditions for resuming"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Technician Arrival Signature (when status is In Progress) -->
                    <div id="arrivalSignatureSection" class="card" style="background: #fef3c7; border: 1px solid #fbbf24; margin: 16px 0; padding: 16px; display: none;">
                        <h4 style="margin: 0 0 16px 0; color: #92400e; font-size: 16px;">Technician Arrival Confirmation</h4>
                        <div class="form-group">
                            <label>Building Representative Signature (Arrival) *</label>
                            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; margin-top: 8px;">
                                <canvas id="arrivalSignatureCanvas" width="400" height="200" style="display: block; cursor: crosshair;"></canvas>
                            </div>
                            <div style="margin-top: 8px; display: flex; gap: 8px;">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignature('arrival')">Clear</button>
                                <span style="font-size: 12px; color: #64748b; line-height: 32px;">Sign above to confirm technician arrival</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="arrivalTime">Arrival Time</label>
                            <input type="datetime-local" class="form-control" id="arrivalTime">
                        </div>
                    </div>

                    <!-- Work Completion Signature (when status is Completed) -->
                    <div id="completionSignatureSection" class="card" style="background: #dcfce7; border: 1px solid #16a34a; margin: 16px 0; padding: 16px; display: none;">
                        <h4 style="margin: 0 0 16px 0; color: #166534; font-size: 16px;">Work Completion Confirmation</h4>
                        <div class="form-group">
                            <label for="workDescription">Work Performed *</label>
                            <textarea class="form-control" id="workDescription" rows="3" placeholder="Describe the maintenance/repair work completed"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="partsUsed">Parts/Materials Used</label>
                                <textarea class="form-control" id="partsUsed" rows="2" placeholder="List any parts or materials used"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="workCost">Work Cost (Rs. )</label>
                                <input type="number" class="form-control" id="workCost" step="0.01" placeholder="Total cost including parts and labor">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Building Representative Signature (Completion) *</label>
                            <div style="background: white; border: 2px solid #e2e8f0; border-radius: 8px; margin-top: 8px;">
                                <canvas id="completionSignatureCanvas" width="400" height="200" style="display: block; cursor: crosshair;"></canvas>
                            </div>
                            <div style="margin-top: 8px; display: flex; gap: 8px;">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignature('completion')">Clear</button>
                                <span style="font-size: 12px; color: #64748b; line-height: 32px;">Sign above to confirm work completion</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="completionTime">Completion Time</label>
                                <input type="datetime-local" class="form-control" id="completionTime">
                            </div>
                            <div class="form-group">
                                <label for="signatoryName">Signatory Name</label>
                                <input type="text" class="form-control" id="signatoryName" placeholder="Name of person signing">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="maintenanceNotes">Additional Notes</label>
                        <textarea class="form-control" id="maintenanceNotes" rows="2" placeholder="Any additional notes or instructions"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('maintenanceModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="exportMaintenanceReport()" id="exportBtn" style="display: none;">üì• Export PDF</button>
                    <button type="submit" class="btn btn-success">Save RCI Record</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Invoice/Quotation Modal -->
    <div class="modal" id="invoiceModal">
        <div class="modal-dialog" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title" id="invoiceModalTitle">Create Invoice</h3>
                <button class="modal-close" onclick="closeModal('invoiceModal')">&times;</button>
            </div>
            <form id="invoiceForm">
                <div class="modal-body">
                    <input type="hidden" id="editInvoiceId">
                    <input type="hidden" id="invoiceType" value="invoice">

                    <!-- Client Information -->
                    <div class="form-section">
                        <h4>Client Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clientName">Client Name *</label>
                                <input type="text" class="form-control" id="clientName" required>
                            </div>
                            <div class="form-group">
                                <label for="clientEmail">Email</label>
                                <input type="email" class="form-control" id="clientEmail">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="clientPhone">Phone</label>
                                <input type="text" class="form-control" id="clientPhone">
                            </div>
                            <div class="form-group">
                                <label for="clientGST">GST Number</label>
                                <input type="text" class="form-control" id="clientGST">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="clientAddress">Address</label>
                            <textarea class="form-control" id="clientAddress" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- Invoice Details -->
                    <div class="form-section">
                        <h4>Invoice Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="invoiceNumber">Invoice Number *</label>
                                <input type="text" class="form-control" id="invoiceNumber" required>
                            </div>
                            <div class="form-group">
                                <label for="invoiceDate">Invoice Date *</label>
                                <input type="date" class="form-control" id="invoiceDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dueDate">Due Date</label>
                                <input type="date" class="form-control" id="dueDate">
                            </div>
                            <div class="form-group">
                                <label for="poNumber">PO Number</label>
                                <input type="text" class="form-control" id="poNumber">
                            </div>
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h4>Items</h4>
                            <button type="button" class="btn btn-success btn-sm" onclick="addInvoiceItem()">+ Add Item</button>
                        </div>
                        <div class="invoice-items-container">
                            <div class="invoice-item-header">
                                <div>Description</div>
                                <div>Qty</div>
                                <div>Unit</div>
                                <div>Rate (Rs. )</div>
                                <div>Amount (Rs. )</div>
                                <div>Action</div>
                            </div>
                            <div id="invoiceItemsList">
                                <!-- Invoice items will be added here -->
                            </div>
                        </div>
                    </div>

                    <!-- Totals -->
                    <div class="form-section">
                        <div class="invoice-totals">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Subtotal</label>
                                    <div class="total-display" id="subtotalDisplay">Rs. 0.00</div>
                                </div>
                                <div class="form-group">
                                    <label for="discountPercent">Discount (%)</label>
                                    <input type="number" class="form-control" id="discountPercent" min="0" max="100" step="0.01" value="0" onchange="calculateInvoiceTotal()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="gstPercent">GST (%)</label>
                                    <input type="number" class="form-control" id="gstPercent" min="0" max="100" step="0.01" value="18" onchange="calculateInvoiceTotal()">
                                </div>
                                <div class="form-group">
                                    <label>Total Amount</label>
                                    <div class="total-display total-amount" id="totalAmountDisplay">Rs. 0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advance Payment Section -->
                    <div class="form-section">
                        <h4 style="color: #059669; margin-bottom: 16px;">Advance Payment Management</h4>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="paymentTerms">Payment Terms</label>
                                <select class="form-control" id="paymentTerms" onchange="toggleAdvanceSection()">
                                    <option value="full">Full Payment</option>
                                    <option value="advance">Advance + Balance</option>
                                    <option value="installments">Multiple Installments</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="invoiceStatus">Invoice Status</label>
                                <select class="form-control" id="invoiceStatus">
                                    <option value="draft">Draft</option>
                                    <option value="sent">Sent</option>
                                    <option value="partial">Partially Paid</option>
                                    <option value="paid">Fully Paid</option>
                                    <option value="overdue">Overdue</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>

                        <!-- Advance Payment Details (initially hidden) -->
                        <div id="advancePaymentSection" style="display: none;">
                            <div class="card" style="background: #f0fdfa; border: 1px solid #14b8a6; margin: 16px 0; padding: 16px;">
                                <h5 style="color: #0f766e; margin: 0 0 12px 0;">Advance Payment Details</h5>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="advanceAmount">Advance Amount (Rs. ) *</label>
                                        <input type="number" class="form-control" id="advanceAmount" min="0" step="0.01" onchange="calculateAdvancePercentage()">
                                    </div>
                                    <div class="form-group">
                                        <label for="advancePercentage">Advance Percentage (%) *</label>
                                        <input type="number" class="form-control" id="advancePercentage" min="0" max="100" step="0.01" onchange="calculateAdvanceAmount()">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="advanceDate">Advance Payment Date</label>
                                        <input type="date" class="form-control" id="advanceDate">
                                    </div>
                                    <div class="form-group">
                                        <label for="advanceMethod">Payment Method</label>
                                        <select class="form-control" id="advanceMethod">
                                            <option value="">Select Method</option>
                                            <option value="cash">Cash</option>
                                            <option value="cheque">Cheque</option>
                                            <option value="bank_transfer">Bank Transfer</option>
                                            <option value="upi">UPI</option>
                                            <option value="card">Credit/Debit Card</option>
                                            <option value="online">Online Payment</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="advanceReference">Transaction Reference</label>
                                        <input type="text" class="form-control" id="advanceReference" placeholder="Cheque number, transaction ID, etc.">
                                    </div>
                                    <div class="form-group">
                                        <label for="balanceDueDate">Balance Due Date</label>
                                        <input type="date" class="form-control" id="balanceDueDate">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="advanceNotes">Advance Payment Notes</label>
                                    <textarea class="form-control" id="advanceNotes" rows="2" placeholder="Any additional notes about the advance payment"></textarea>
                                </div>

                                <!-- Payment Summary -->
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #a7f3d0; margin-top: 12px;">
                                    <h6 style="color: #065f46; margin: 0 0 8px 0;">Payment Breakdown:</h6>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px;">
                                        <div><strong>Total Amount:</strong> <span id="paymentTotalAmount">Rs. 0.00</span></div>
                                        <div><strong>Advance Amount:</strong> <span id="paymentAdvanceAmount">Rs. 0.00</span></div>
                                        <div><strong>Balance Amount:</strong> <span id="paymentBalanceAmount">Rs. 0.00</span></div>
                                        <div><strong>Balance Percentage:</strong> <span id="paymentBalancePercent">0%</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Multiple Installments Section (initially hidden) -->
                        <div id="installmentsSection" style="display: none;">
                            <div class="card" style="background: #fff7ed; border: 1px solid #fb923c; margin: 16px 0; padding: 16px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                    <h5 style="color: #ea580c; margin: 0;">Multiple Installments</h5>
                                    <button type="button" class="btn btn-success btn-sm" onclick="addInstallment()">+ Add Installment</button>
                                </div>
                                
                                <div id="installmentsList">
                                    <!-- Installments will be added here -->
                                </div>
                                
                                <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #fed7aa; margin-top: 12px;">
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; font-size: 13px;">
                                        <div><strong>Total Amount:</strong> <span id="installmentTotalAmount">Rs. 0.00</span></div>
                                        <div><strong>Planned Amount:</strong> <span id="installmentPlannedAmount">Rs. 0.00</span></div>
                                        <div><strong>Remaining:</strong> <span id="installmentRemainingAmount">Rs. 0.00</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-section">
                        <div class="form-group">
                            <label for="invoiceNotes">Notes</label>
                            <textarea class="form-control" id="invoiceNotes" rows="3" placeholder="Payment terms, additional information..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('invoiceModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Company Settings Modal -->
    <div class="modal" id="companyModal">
        <div class="modal-dialog">
            <div class="modal-header">
                <h3 class="modal-title">Company Settings</h3>
                <button class="modal-close" onclick="closeModal('companyModal')">&times;</button>
            </div>
            <form id="companyForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="companyName">Company Name *</label>
                        <input type="text" class="form-control" id="companyName" value="Avant Elevators" required>
                    </div>
                    <div class="form-group">
                        <label for="companyAddress">Address</label>
                        <textarea class="form-control" id="companyAddress" rows="3" placeholder="Company address"></textarea>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyPhone">Phone</label>
                            <input type="text" class="form-control" id="companyPhone">
                        </div>
                        <div class="form-group">
                            <label for="companyEmail">Email</label>
                            <input type="email" class="form-control" id="companyEmail">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="companyGST">GST Number</label>
                            <input type="text" class="form-control" id="companyGST">
                        </div>
                        <div class="form-group">
                            <label for="companyCIN">CIN Number</label>
                            <input type="text" class="form-control" id="companyCIN">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="companyBankDetails">Bank Details</label>
                        <textarea class="form-control" id="companyBankDetails" rows="3" placeholder="Bank name, account number, IFSC code, etc."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('companyModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Settings</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Modal (Admin Create/Assign) -->
    <div class="modal" id="taskModal">
        <div class="modal-dialog" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title" id="taskModalTitle">Create New Task</h3>
                <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
            </div>
            <form id="taskForm">
                <div class="modal-body">
                    <input type="hidden" id="editTaskId">
                    
                    <div class="form-group">
                        <label for="taskTitle">Task Title *</label>
                        <input type="text" class="form-control" id="taskTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDescription">Description</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskCategory">Category *</label>
                            <select class="form-control" id="taskCategory" required>
                                <option value="">Select Category</option>
                                <option value="Installation">Installation</option>
                                <option value="Modernization">Modernization</option>
                                <option value="AMC">AMC</option>
                                <option value="Repair">Repair</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Sales">Sales</option>
                                <option value="Admin">Admin</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskPriority">Priority *</label>
                            <select class="form-control" id="taskPriority" required>
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskAssignedTo">Assign To *</label>
                            <select class="form-control" id="taskAssignedTo" required>
                                <option value="">Select Employee</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskDueDate">Due Date *</label>
                            <input type="date" class="form-control" id="taskDueDate" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="taskStatus">Status *</label>
                            <select class="form-control" id="taskStatus" required>
                                <option value="Pending">Pending</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="On Hold">On Hold</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskProgress">Progress (%)</label>
                            <input type="number" class="form-control" id="taskProgress" min="0" max="100" value="0">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskProject">Related Project (Optional)</label>
                        <select class="form-control" id="taskProject">
                            <option value="">None</option>
                        </select>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('taskModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Self-Assign Task Modal -->
    <div class="modal" id="selfTaskModal">
        <div class="modal-dialog" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title">Self-Assign Task</h3>
                <button class="modal-close" onclick="closeModal('selfTaskModal')">&times;</button>
            </div>
            <form id="selfTaskForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="selfTaskTitle">Task Title *</label>
                        <input type="text" class="form-control" id="selfTaskTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="selfTaskDescription">Description</label>
                        <textarea class="form-control" id="selfTaskDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="selfTaskCategory">Category *</label>
                            <select class="form-control" id="selfTaskCategory" required>
                                <option value="">Select Category</option>
                                <option value="Installation">Installation</option>
                                <option value="Modernization">Modernization</option>
                                <option value="AMC">AMC</option>
                                <option value="Repair">Repair</option>
                                <option value="Maintenance">Maintenance</option>
                                <option value="Sales">Sales</option>
                                <option value="Admin">Admin</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="selfTaskPriority">Priority *</label>
                            <select class="form-control" id="selfTaskPriority" required>
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="selfTaskDueDate">Due Date *</label>
                            <input type="date" class="form-control" id="selfTaskDueDate" required>
                        </div>
                        <div class="form-group">
                            <label for="selfTaskStatus">Status *</label>
                            <select class="form-control" id="selfTaskStatus" required>
                                <option value="Pending">Pending</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="alert alert-info" style="background: #dbeafe; border: 1px solid #93c5fd; padding: 12px; border-radius: 6px; margin-top: 12px;">
                        <strong>üí° Self-Assignment:</strong> This task will be assigned to you and visible to admins for tracking your productivity.
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('selfTaskModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Create Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Salary Slip Modal -->
    <div class="modal" id="salarySlipModal">
        <div class="modal-dialog" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">Generate Salary Slip</h3>
                <button class="modal-close" onclick="closeModal('salarySlipModal')">&times;</button>
            </div>
            <form id="salarySlipForm">
                <div class="modal-body">
                    <!-- Employee Selection -->
                    <div class="form-section">
                        <h4 style="color: #2563eb; margin-bottom: 16px;">üë§ Employee Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="salaryEmployee">Select Employee *</label>
                                <select class="form-control" id="salaryEmployee" required onchange="populateEmployeeDetails()">
                                    <option value="">Select Employee</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="salaryMonth">Salary Month *</label>
                                <input type="month" class="form-control" id="salaryMonth" required>
                            </div>
                            <div class="form-group">
                                <label for="grossSalary">Gross Salary (Rs.) *</label>
                                <input type="number" class="form-control" id="grossSalary" required min="0" step="100" oninput="calculateOvertimePreview()">
                            </div>
                        </div>
                    </div>

                    <!-- Attendance Details -->
                    <div class="form-section">
                        <h4 style="color: #059669; margin-bottom: 16px;">üìÖ Attendance Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="totalWorkingDays">Total Working Days</label>
                                <input type="number" class="form-control" id="totalWorkingDays" value="30" min="1" max="31" oninput="calculateOvertimePreview()">
                            </div>
                            <div class="form-group">
                                <label for="presentDaysInput">Present Days *</label>
                                <input type="number" class="form-control" id="presentDaysInput" required min="0" max="31">
                            </div>
                            <div class="form-group">
                                <label for="paidLeavesAvailable">Paid Leaves Available</label>
                                <input type="number" class="form-control" id="paidLeavesAvailable" value="1.5" step="0.5" min="0">
                            </div>
                            <div class="form-group">
                                <label for="leavesUsedInput">Leaves Used</label>
                                <input type="number" class="form-control" id="leavesUsedInput" value="0" step="0.5" min="0">
                            </div>
                        </div>
                    </div>

                    <!-- Salary Components -->
                    <div class="form-section">
                        <h4 style="color: #dc2626; margin-bottom: 16px;">üí∞ Salary Components</h4>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span style="font-size: 13px; color: #64748b;">Total Salary: <strong id="totalSalaryDisplay">Rs. 0</strong></span>
                            <button type="button" class="btn btn-primary btn-sm" onclick="autoDistributeSalary()">üéØ Auto Distribute</button>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="basicSalaryPercent">Basic Salary (%)</label>
                                <input type="number" class="form-control" id="basicSalaryPercent" value="50" min="1" max="100" onchange="calculateSalaryComponents()">
                            </div>
                            <div class="form-group">
                                <label for="hra">HRA (Rs.)</label>
                                <input type="number" class="form-control" id="hra" value="0" min="0" onchange="calculateSalaryComponents()">
                            </div>
                            <div class="form-group">
                                <label for="transportAllowance">Transport Allowance (Rs.)</label>
                                <input type="number" class="form-control" id="transportAllowance" value="0" min="0" onchange="calculateSalaryComponents()">
                            </div>
                            <div class="form-group">
                                <label for="medicalAllowance">Medical Allowance (Rs.)</label>
                                <input type="number" class="form-control" id="medicalAllowance" value="0" min="0" onchange="calculateSalaryComponents()">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="otherAllowances">Other Allowances (Rs.)</label>
                                <input type="number" class="form-control" id="otherAllowances" value="0" min="0" onchange="calculateSalaryComponents()">
                            </div>
                            <div class="form-group">
                                <label for="bonus">Bonus (Rs.)</label>
                                <input type="number" class="form-control" id="bonus" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label for="bonusDescription">Bonus Description</label>
                                <input type="text" class="form-control" id="bonusDescription" placeholder="e.g. Performance Bonus">
                            </div>
                        </div>
                    </div>

                    <!-- Incentives & Overtime -->
                    <div class="form-section">
                        <h4 style="color: #7c3aed; margin-bottom: 16px;">üéØ Incentives & Overtime</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="incentives">Incentives (Rs.)</label>
                                <input type="number" class="form-control" id="incentives" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label for="incentivesDescription">Incentives Description</label>
                                <input type="text" class="form-control" id="incentivesDescription" placeholder="e.g. Sales Incentive">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="overtimeHours">Overtime Hours</label>
                                <input type="number" class="form-control" id="overtimeHours" value="0" min="0" step="0.5" oninput="calculateOvertimePreview()">
                                <small class="form-text text-muted">Rate auto-calculated from salary</small>
                            </div>
                            <div class="form-group">
                                <label>Calculated Overtime Amount</label>
                                <div style="padding: 10px 12px; background: #f0f9ff; border: 1px solid #bfdbfe; border-radius: 6px; color: #1e40af; font-weight: 600;">
                                    <span id="overtimePreview">Rs. 0</span>
                                    <small style="display: block; color: #64748b; font-weight: 400; margin-top: 4px;" id="overtimeRatePreview">@ Rs. 0/hr</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Deductions -->
                    <div class="form-section">
                        <h4 style="color: #ea580c; margin-bottom: 16px;">üìâ Deductions</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <div class="form-check" style="margin-top: 30px;">
                                    <input type="checkbox" class="form-check-input" id="enablePF" checked>
                                    <label for="enablePF" class="form-check-label">Enable PF Deduction (12% of Basic)</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="form-check" style="margin-top: 30px;">
                                    <input type="checkbox" class="form-check-input" id="enableESIC">
                                    <label for="enableESIC" class="form-check-label">Enable ESIC Deduction (0.75%)</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="otherDeductions">Other Deductions (Rs.)</label>
                                <input type="number" class="form-control" id="otherDeductions" value="0" min="0">
                            </div>
                            <div class="form-group">
                                <label for="deductionDescription">Deduction Description</label>
                                <input type="text" class="form-control" id="deductionDescription" placeholder="e.g. Advance Deduction">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('salarySlipModal')">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="generateSalarySlip()">üí∞ Generate Salary Slip</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AMC Modal -->
    <div class="modal" id="amcModal">
        <div class="modal-dialog" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="amcModalTitle">Add AMC Contract</h3>
                <button class="modal-close" onclick="closeModal('amcModal')">&times;</button>
            </div>
            <form id="amcForm">
                <div class="modal-body">
                    <input type="hidden" id="editAmcId">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amcProject">Project *</label>
                            <select class="form-control" id="amcProject" required onchange="loadSubApartments('amc')">
                                <option value="">Select Project</option>
                            </select>
                        </div>
                        <div class="form-group" id="amcSubApartmentGroup" style="display: none;">
                            <label for="amcSubApartment">Sub-Apartment (Optional)</label>
                            <select class="form-control" id="amcSubApartment" onchange="loadWings('amc')">
                                <option value="">None - Main Project</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="amcWing">Wing/Block *</label>
                            <select class="form-control" id="amcWing" required onchange="loadElevatorsByWing('amc')">
                                <option value="">Select Wing</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amcElevator">Select Elevators * <small style="color: var(--text-secondary);">(Hold Ctrl/Cmd to select multiple)</small></label>
                            <select class="form-control" id="amcElevator" multiple required style="min-height: 100px;" onchange="displaySelectedElevatorDetails()">
                                <option value="">Select wing first...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Selected Elevators Details -->
                    <div id="selectedElevatorsDetails" style="display: none; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 12px 0; color: #0369a1; font-size: 14px;">üìä Selected Elevators Details</h4>
                        <div id="elevatorDetailsList"></div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="amcContractType">Contract Type *</label>
                            <select class="form-control" id="amcContractType" required>
                                <option value="">Select Type</option>
                                <option value="New Installation">New Installation</option>
                                <option value="Modernization">Modernization</option>
                                <option value="Regular AMC">Regular AMC</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="amcStartDate">Start Date *</label>
                            <input type="date" class="form-control" id="amcStartDate" required onchange="calculateAmcEndDate()">
                        </div>
                        <div class="form-group">
                            <label for="amcDuration">Duration (Years) *</label>
                            <select class="form-control" id="amcDuration" required onchange="calculateAmcEndDate()">
                                <option value="">Select Duration</option>
                                <option value="1">1 Year</option>
                                <option value="2">2 Years</option>
                                <option value="3">3 Years</option>
                                <option value="5">5 Years</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="amcEndDate">End Date</label>
                            <input type="date" class="form-control" id="amcEndDate" readonly>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="amcAmount">Total Amount (Rs. ) *</label>
                            <input type="number" class="form-control" id="amcAmount" required min="0" step="0.01" onchange="calculateInstallments()">
                        </div>
                        <div class="form-group">
                            <label for="amcPaymentMode">Payment Mode *</label>
                            <select class="form-control" id="amcPaymentMode" required onchange="toggleInstallmentSection()">
                                <option value="">Select Payment Mode</option>
                                <option value="Annual">Annual</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Half-Yearly">Half-Yearly</option>
                                <option value="Monthly">Monthly</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="amcMaintenanceFrequency">Maintenance Frequency *</label>
                            <select class="form-control" id="amcMaintenanceFrequency" required>
                                <option value="">Select Frequency</option>
                                <option value="Monthly">Monthly</option>
                                <option value="Quarterly">Quarterly (Every 3 months)</option>
                                <option value="Half-Yearly">Half-Yearly (Every 6 months)</option>
                                <option value="Yearly">Yearly</option>
                            </select>
                            <small style="color: #64748b;">How often should scheduled maintenance be performed?</small>
                        </div>
                        <div class="form-group">
                            <label for="amcAssignedTechnician">Assigned Technician</label>
                            <select class="form-control" id="amcAssignedTechnician">
                                <option value="">Select Technician</option>
                            </select>
                            <small style="color: #64748b;">Will auto-assign to scheduled maintenance</small>
                        </div>
                    </div>

                    <!-- Free Maintenance Period -->
                    <div class="form-section">
                        <h4 style="color: #059669; margin-bottom: 16px;">Free Maintenance Period</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="freeMaintenanceMonths">Free Maintenance (Months)</label>
                                <input type="number" class="form-control" id="freeMaintenanceMonths" min="0" max="60" value="0">
                                <small class="form-text text-muted">Enter months for free maintenance after NI/MOD work</small>
                            </div>
                            <div class="form-group">
                                <label for="freeMaintenanceStartDate">Free Period Start Date</label>
                                <input type="date" class="form-control" id="freeMaintenanceStartDate">
                            </div>
                            <div class="form-group">
                                <label for="freeMaintenanceEndDate">Free Period End Date</label>
                                <input type="date" class="form-control" id="freeMaintenanceEndDate" readonly>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Schedule -->
                    <div class="form-section" id="installmentSection" style="display: none;">
                        <h4 style="color: #2563eb; margin-bottom: 16px;">Payment Schedule</h4>
                        <div id="installmentList"></div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="amcNotes">Notes</label>
                            <textarea class="form-control" id="amcNotes" rows="2" placeholder="Any additional notes or terms"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('amcModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save AMC Contract</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AMC Renewals Report Modal -->
    <div class="modal" id="renewalsModal">
        <div class="modal-dialog" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title">AMC Renewals Report</h3>
                <button class="modal-close" onclick="closeModal('renewalsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="filters" style="margin-bottom: 20px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Report Type</label>
                            <select id="renewalReportType" onchange="updateRenewalReport()">
                                <option value="current_month">Current Month Renewals</option>
                                <option value="next_month">Next Month Renewals</option>
                                <option value="next_3_months">Next 3 Months</option>
                                <option value="expired">Expired Contracts</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="exportRenewalsReport()">üì• Export Report</button>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Project</th>
                                <th>Contract Type</th>
                                <th>End Date</th>
                                <th>Days Remaining</th>
                                <th>Amount</th>
                                <th>Contact</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="renewalsList">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('renewalsModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Quotation Modal -->
    <div class="modal" id="quotationModal">
        <div class="modal-dialog" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="quotationModalTitle">Create Quotation</h3>
                <button class="modal-close" onclick="closeModal('quotationModal')">&times;</button>
            </div>
            <form id="quotationForm">
                <div class="modal-body">
                    <input type="hidden" id="editQuotationId">
                    
                    <!-- Quotation Type -->
                    <div class="form-section">
                        <h4>Quotation Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="quotationType">Quotation Type *</label>
                                <select class="form-control" id="quotationType" required onchange="updateQuotationItems()">
                                    <option value="">Select Type</option>
                                    <option value="New Installation">New Installation (NI)</option>
                                    <option value="Modernization">Modernization (MOD)</option>
                                    <option value="Repair">Repair Work</option>
                                    <option value="AMC">Annual Maintenance Contract</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="quotationNumber">Quotation Number *</label>
                                <input type="text" class="form-control" id="quotationNumber" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="quotationDate">Date *</label>
                                <input type="date" class="form-control" id="quotationDate" required>
                            </div>
                            <div class="form-group">
                                <label for="quotationValidUntil">Valid Until *</label>
                                <input type="date" class="form-control" id="quotationValidUntil" required>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Client Information -->
                    <div class="form-section">
                        <h4>Client Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="quotClientName">Client Name *</label>
                                <input type="text" class="form-control" id="quotClientName" required>
                            </div>
                            <div class="form-group">
                                <label for="quotClientEmail">Email</label>
                                <input type="email" class="form-control" id="quotClientEmail">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="quotClientPhone">Phone *</label>
                                <input type="text" class="form-control" id="quotClientPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="quotClientGST">GST Number</label>
                                <input type="text" class="form-control" id="quotClientGST">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="quotClientAddress">Address *</label>
                            <textarea class="form-control" id="quotClientAddress" rows="2" required></textarea>
                        </div>
                    </div>
                    
                    <!-- Project Details (for NI/MOD) -->
                    <div class="form-section" id="quotProjectDetails">
                        <h4>Project Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="quotElevatorType">Elevator Type</label>
                                <select class="form-control" id="quotElevatorType">
                                    <option value="">Select Type</option>
                                    <option value="Passenger">Passenger Elevator</option>
                                    <option value="Cargo">Cargo Elevator</option>
                                    <option value="Hospital">Hospital Elevator</option>
                                    <option value="Home">Home Elevator</option>
                                    <option value="Dumbwaiter">Dumbwaiter</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="quotElevatorQuantity">Number of Elevators</label>
                                <input type="number" class="form-control" id="quotElevatorQuantity" min="1" value="1">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="quotCapacity">Capacity (kg)</label>
                                <input type="number" class="form-control" id="quotCapacity" placeholder="e.g., 680">
                            </div>
                            <div class="form-group">
                                <label for="quotFloors">Number of Floors</label>
                                <input type="number" class="form-control" id="quotFloors" min="2">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bill of Quantities -->
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h4>Bill of Quantities (BoQ)</h4>
                            <button type="button" class="btn btn-success btn-sm" onclick="addQuotationItem()">+ Add Item</button>
                        </div>
                        <div class="invoice-items-container">
                            <div class="invoice-item-header">
                                <div>Description</div>
                                <div>Qty</div>
                                <div>Unit</div>
                                <div>Rate (Rs.)</div>
                                <div>Amount (Rs.)</div>
                                <div>Action</div>
                            </div>
                            <div id="quotationItemsList">
                                <!-- Items will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Totals -->
                    <div class="form-section">
                        <div class="invoice-totals">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Subtotal</label>
                                    <div class="total-display" id="quotSubtotalDisplay">Rs. 0.00</div>
                                </div>
                                <div class="form-group">
                                    <label for="quotDiscountPercent">Discount (%)</label>
                                    <input type="number" class="form-control" id="quotDiscountPercent" min="0" max="100" step="0.01" value="0" onchange="calculateQuotationTotal()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="quotGSTPercent">GST (%)</label>
                                    <input type="number" class="form-control" id="quotGSTPercent" min="0" max="100" step="0.01" value="18" onchange="calculateQuotationTotal()">
                                </div>
                                <div class="form-group">
                                    <label>Total Amount</label>
                                    <div class="total-display total-amount" id="quotTotalAmountDisplay">Rs. 0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Terms & Notes -->
                    <div class="form-section">
                        <div class="form-group">
                            <label for="quotTerms">Terms & Conditions</label>
                            <textarea class="form-control" id="quotTerms" rows="3" placeholder="Payment terms, delivery schedule, warranty details..."></textarea>
                        </div>
                        <div class="form-group">
                            <label for="quotNotes">Additional Notes</label>
                            <textarea class="form-control" id="quotNotes" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('quotationModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Quotation</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Purchase Order Modal -->
    <div class="modal" id="purchaseOrderModal">
        <div class="modal-dialog" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="poModalTitle">Create Purchase Order</h3>
                <button class="modal-close" onclick="closeModal('purchaseOrderModal')">&times;</button>
            </div>
            <form id="purchaseOrderForm">
                <div class="modal-body">
                    <input type="hidden" id="editPOId">
                    
                    <!-- PO Details -->
                    <div class="form-section">
                        <h4>Purchase Order Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="poNumber">PO Number *</label>
                                <input type="text" class="form-control" id="poPONumber" required>
                            </div>
                            <div class="form-group">
                                <label for="poDate">Date *</label>
                                <input type="date" class="form-control" id="poDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="poType">PO Type *</label>
                                <select class="form-control" id="poType" required>
                                    <option value="">Select Type</option>
                                    <option value="New Installation">New Installation Materials</option>
                                    <option value="Modernization">Modernization Parts</option>
                                    <option value="Repair">Repair Parts</option>
                                    <option value="Maintenance">Maintenance Supplies</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="poDeliveryDate">Expected Delivery Date</label>
                                <input type="date" class="form-control" id="poDeliveryDate">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vendor Information -->
                    <div class="form-section">
                        <h4>Vendor Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="poVendorName">Vendor Name *</label>
                                <input type="text" class="form-control" id="poVendorName" required>
                            </div>
                            <div class="form-group">
                                <label for="poVendorEmail">Email</label>
                                <input type="email" class="form-control" id="poVendorEmail">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="poVendorPhone">Phone *</label>
                                <input type="text" class="form-control" id="poVendorPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="poVendorGST">GST Number</label>
                                <input type="text" class="form-control" id="poVendorGST">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="poVendorAddress">Address</label>
                            <textarea class="form-control" id="poVendorAddress" rows="2"></textarea>
                        </div>
                    </div>
                    
                    <!-- Items -->
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h4>Items / Materials</h4>
                            <button type="button" class="btn btn-success btn-sm" onclick="addPOItem()">+ Add Item</button>
                        </div>
                        <div class="invoice-items-container">
                            <div class="invoice-item-header">
                                <div>Description</div>
                                <div>Qty</div>
                                <div>Unit</div>
                                <div>Rate (Rs.)</div>
                                <div>Amount (Rs.)</div>
                                <div>Action</div>
                            </div>
                            <div id="poItemsList">
                                <!-- Items will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Totals -->
                    <div class="form-section">
                        <div class="invoice-totals">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Subtotal</label>
                                    <div class="total-display" id="poSubtotalDisplay">Rs. 0.00</div>
                                </div>
                                <div class="form-group">
                                    <label for="poGSTPercent">GST (%)</label>
                                    <input type="number" class="form-control" id="poGSTPercent" min="0" max="100" step="0.01" value="18" onchange="calculatePOTotal()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Total Amount</label>
                                    <div class="total-display total-amount" id="poTotalAmountDisplay">Rs. 0.00</div>
                                </div>
                                <div class="form-group">
                                    <label for="poStatus">Status</label>
                                    <select class="form-control" id="poStatus">
                                        <option value="Draft">Draft</option>
                                        <option value="Sent">Sent to Vendor</option>
                                        <option value="Confirmed">Confirmed</option>
                                        <option value="In Transit">In Transit</option>
                                        <option value="Received">Received</option>
                                        <option value="Cancelled">Cancelled</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="form-section">
                        <div class="form-group">
                            <label for="poNotes">Notes</label>
                            <textarea class="form-control" id="poNotes" rows="3" placeholder="Special instructions, delivery requirements..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('purchaseOrderModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Purchase Order</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Proforma Invoice Modal -->
    <div class="modal" id="proformaInvoiceModal">
        <div class="modal-dialog" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="piModalTitle">Create Proforma Invoice</h3>
                <button class="modal-close" onclick="closeModal('proformaInvoiceModal')">&times;</button>
            </div>
            <form id="proformaInvoiceForm">
                <div class="modal-body">
                    <input type="hidden" id="editPIId">
                    
                    <!-- PI Details -->
                    <div class="form-section">
                        <h4>Proforma Invoice Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="piNumber">PI Number *</label>
                                <input type="text" class="form-control" id="piNumber" required>
                            </div>
                            <div class="form-group">
                                <label for="piDate">Date *</label>
                                <input type="date" class="form-control" id="piDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="piType">Type *</label>
                                <select class="form-control" id="piType" required>
                                    <option value="">Select Type</option>
                                    <option value="New Installation">New Installation</option>
                                    <option value="Modernization">Modernization</option>
                                    <option value="Repair">Repair Work</option>
                                    <option value="AMC">AMC Payment</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="piLinkedQuotation">Linked Quotation</label>
                                <select class="form-control" id="piLinkedQuotation" onchange="loadQuotationToPI()">
                                    <option value="">-- Direct PI (No Quotation) --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Client Information -->
                    <div class="form-section">
                        <h4>Client Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="piClientName">Client Name *</label>
                                <input type="text" class="form-control" id="piClientName" required>
                            </div>
                            <div class="form-group">
                                <label for="piClientEmail">Email</label>
                                <input type="email" class="form-control" id="piClientEmail">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="piClientPhone">Phone *</label>
                                <input type="text" class="form-control" id="piClientPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="piClientGST">GST Number</label>
                                <input type="text" class="form-control" id="piClientGST">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="piClientAddress">Address *</label>
                            <textarea class="form-control" id="piClientAddress" rows="2" required></textarea>
                        </div>
                    </div>
                    
                    <!-- Items -->
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h4>Items</h4>
                            <button type="button" class="btn btn-success btn-sm" onclick="addPIItem()">+ Add Item</button>
                        </div>
                        <div class="invoice-items-container">
                            <div class="invoice-item-header">
                                <div>Description</div>
                                <div>Qty</div>
                                <div>Unit</div>
                                <div>Rate (Rs.)</div>
                                <div>Amount (Rs.)</div>
                                <div>Action</div>
                            </div>
                            <div id="piItemsList">
                                <!-- Items will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Totals & Payment -->
                    <div class="form-section">
                        <div class="invoice-totals">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Subtotal</label>
                                    <div class="total-display" id="piSubtotalDisplay">Rs. 0.00</div>
                                </div>
                                <div class="form-group">
                                    <label for="piDiscountPercent">Discount (%)</label>
                                    <input type="number" class="form-control" id="piDiscountPercent" min="0" max="100" step="0.01" value="0" onchange="calculatePITotal()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="piGSTPercent">GST (%)</label>
                                    <input type="number" class="form-control" id="piGSTPercent" min="0" max="100" step="0.01" value="18" onchange="calculatePITotal()">
                                </div>
                                <div class="form-group">
                                    <label>Total Amount</label>
                                    <div class="total-display total-amount" id="piTotalAmountDisplay">Rs. 0.00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advance Payment -->
                    <div class="form-section">
                        <h4 style="color: #059669;">Advance Payment Terms</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="piAdvancePercent">Advance Percentage (%) *</label>
                                <input type="number" class="form-control" id="piAdvancePercent" min="0" max="100" step="1" value="30" onchange="calculatePIAdvance()">
                            </div>
                            <div class="form-group">
                                <label>Advance Amount</label>
                                <div class="total-display" id="piAdvanceAmountDisplay" style="color: #059669;">Rs. 0.00</div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Balance Amount</label>
                                <div class="total-display" id="piBalanceAmountDisplay" style="color: #dc2626;">Rs. 0.00</div>
                            </div>
                            <div class="form-group">
                                <label for="piDueDate">Payment Due Date</label>
                                <input type="date" class="form-control" id="piDueDate">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="form-section">
                        <div class="form-group">
                            <label for="piTerms">Terms & Conditions</label>
                            <textarea class="form-control" id="piTerms" rows="3">1. This is a Proforma Invoice and not a Tax Invoice.
2. Payment is required as per the advance percentage mentioned above.
3. Tax Invoice will be issued after full payment is received.</textarea>
                        </div>
                        <div class="form-group">
                            <label for="piNotes">Additional Notes</label>
                            <textarea class="form-control" id="piNotes" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('proformaInvoiceModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Proforma Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tax Invoice Modal -->
    <div class="modal" id="taxInvoiceModal">
        <div class="modal-dialog" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title" id="tiModalTitle">Create Tax Invoice</h3>
                <button class="modal-close" onclick="closeModal('taxInvoiceModal')">&times;</button>
            </div>
            <form id="taxInvoiceForm">
                <div class="modal-body">
                    <input type="hidden" id="editTIId">
                    
                    <!-- Tax Invoice Details -->
                    <div class="form-section">
                        <h4>Tax Invoice Details</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tiNumber">Invoice Number *</label>
                                <input type="text" class="form-control" id="tiNumber" required>
                            </div>
                            <div class="form-group">
                                <label for="tiDate">Invoice Date *</label>
                                <input type="date" class="form-control" id="tiDate" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tiType">Type *</label>
                                <select class="form-control" id="tiType" required>
                                    <option value="">Select Type</option>
                                    <option value="New Installation">New Installation</option>
                                    <option value="Modernization">Modernization</option>
                                    <option value="Repair">Repair Work</option>
                                    <option value="AMC">AMC Payment</option>
                                    <option value="Service">Service Charge</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="tiLinkedPI">Linked Proforma Invoice</label>
                                <select class="form-control" id="tiLinkedPI" onchange="loadPIToTaxInvoice()">
                                    <option value="">-- Direct Invoice (No PI) --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Client Information -->
                    <div class="form-section">
                        <h4>Client Information</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tiClientName">Client Name *</label>
                                <input type="text" class="form-control" id="tiClientName" required>
                            </div>
                            <div class="form-group">
                                <label for="tiClientEmail">Email</label>
                                <input type="email" class="form-control" id="tiClientEmail">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tiClientPhone">Phone *</label>
                                <input type="text" class="form-control" id="tiClientPhone" required>
                            </div>
                            <div class="form-group">
                                <label for="tiClientGST">GST Number *</label>
                                <input type="text" class="form-control" id="tiClientGST" required placeholder="e.g., 27AABCU9603R1ZN">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="tiClientAddress">Billing Address *</label>
                            <textarea class="form-control" id="tiClientAddress" rows="2" required></textarea>
                        </div>
                    </div>
                    
                    <!-- Items -->
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h4>Items</h4>
                            <button type="button" class="btn btn-success btn-sm" onclick="addTIItem()">+ Add Item</button>
                        </div>
                        <div class="invoice-items-container">
                            <div class="invoice-item-header">
                                <div>Description</div>
                                <div>HSN/SAC</div>
                                <div>Qty</div>
                                <div>Rate (Rs.)</div>
                                <div>Amount (Rs.)</div>
                                <div>Action</div>
                            </div>
                            <div id="tiItemsList">
                                <!-- Items will be added here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Totals -->
                    <div class="form-section">
                        <div class="invoice-totals">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Subtotal</label>
                                    <div class="total-display" id="tiSubtotalDisplay">Rs. 0.00</div>
                                </div>
                                <div class="form-group">
                                    <label for="tiDiscountPercent">Discount (%)</label>
                                    <input type="number" class="form-control" id="tiDiscountPercent" min="0" max="100" step="0.01" value="0" onchange="calculateTITotal()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="tiCGSTPercent">CGST (%)</label>
                                    <input type="number" class="form-control" id="tiCGSTPercent" min="0" max="100" step="0.01" value="9" onchange="calculateTITotal()">
                                </div>
                                <div class="form-group">
                                    <label for="tiSGSTPercent">SGST (%)</label>
                                    <input type="number" class="form-control" id="tiSGSTPercent" min="0" max="100" step="0.01" value="9" onchange="calculateTITotal()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>CGST Amount</label>
                                    <div class="total-display" id="tiCGSTAmountDisplay">Rs. 0.00</div>
                                </div>
                                <div class="form-group">
                                    <label>SGST Amount</label>
                                    <div class="total-display" id="tiSGSTAmountDisplay">Rs. 0.00</div>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Total Amount</label>
                                    <div class="total-display total-amount" id="tiTotalAmountDisplay">Rs. 0.00</div>
                                </div>
                                <div class="form-group">
                                    <label for="tiStatus">Payment Status</label>
                                    <select class="form-control" id="tiStatus">
                                        <option value="Pending">Pending</option>
                                        <option value="Paid">Paid</option>
                                        <option value="Overdue">Overdue</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bank Details -->
                    <div class="form-section">
                        <h4>Bank Details for Payment</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tiBankName">Bank Name</label>
                                <input type="text" class="form-control" id="tiBankName" value="HDFC Bank">
                            </div>
                            <div class="form-group">
                                <label for="tiAccountNumber">Account Number</label>
                                <input type="text" class="form-control" id="tiAccountNumber">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="tiIFSC">IFSC Code</label>
                                <input type="text" class="form-control" id="tiIFSC">
                            </div>
                            <div class="form-group">
                                <label for="tiAccountName">Account Holder Name</label>
                                <input type="text" class="form-control" id="tiAccountName">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="form-section">
                        <div class="form-group">
                            <label for="tiTerms">Terms & Conditions</label>
                            <textarea class="form-control" id="tiTerms" rows="3">1. Payment is due within 30 days from the invoice date.
2. Please mention invoice number in payment reference.
3. Interest @18% p.a. will be charged on delayed payments.</textarea>
                        </div>
                        <div class="form-group">
                            <label for="tiNotes">Additional Notes</label>
                            <textarea class="form-control" id="tiNotes" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('taxInvoiceModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">Save Tax Invoice</button>
                </div>
            </form>
        </div>
    </div>

    <!-- BOM Modal -->
    <div class="modal" id="bomModal">
        <div class="modal-dialog" style="max-width: 1000px;">
            <form onsubmit="saveBOM(event)">
                <div class="modal-header">
                    <h3 class="modal-title">üìã Create Bill of Materials (BOM)</h3>
                    <button type="button" class="close-btn" onclick="closeModal('bomModal')">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- Project Selection -->
                    <div class="form-section">
                        <h4 style="margin-bottom: 16px; color: var(--text-primary); font-size: 16px;">Select Project</h4>
                        <div class="form-group">
                            <label for="bomProjectSelect">Project *</label>
                            <select class="form-control" id="bomProjectSelect" required onchange="populateProjectDetails()">
                                <option value="">Select Project</option>
                            </select>
                        </div>
                    </div>

                    <!-- Client & Project Information -->
                    <div class="form-section">
                        <h4 style="margin-bottom: 16px; color: var(--text-primary); font-size: 16px;">Client & Project Information</h4>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="bomClientName">Client Name *</label>
                                <input type="text" class="form-control" id="bomClientName" readonly style="background: #f8fafc;">
                            </div>
                            <div class="form-group">
                                <label for="bomClientPhone">Client Phone</label>
                                <input type="text" class="form-control" id="bomClientPhone" readonly style="background: #f8fafc;">
                            </div>
                        </div>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="bomClientEmail">Client Email</label>
                                <input type="text" class="form-control" id="bomClientEmail" readonly style="background: #f8fafc;">
                            </div>
                            <div class="form-group">
                                <label for="bomSiteLocation">Site Location *</label>
                                <input type="text" class="form-control" id="bomSiteLocation" readonly style="background: #f8fafc;">
                            </div>
                        </div>
                        <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                            <div class="form-group">
                                <label for="bomProjectType">Project Type *</label>
                                <select class="form-control" id="bomProjectType" required>
                                    <option value="">Select Type</option>
                                    <option value="Installation">Installation</option>
                                    <option value="Maintenance">Maintenance</option>
                                    <option value="Repair">Repair</option>
                                    <option value="Modernization">Modernization</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="bomDate">Date *</label>
                                <input type="date" class="form-control" id="bomDate" required>
                            </div>
                        </div>
                    </div>

                    <!-- Materials Selection -->
                    <div class="form-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h4 style="margin: 0; color: var(--text-primary); font-size: 16px;">Materials</h4>
                            <button type="button" class="btn btn-primary btn-sm" onclick="addBOMMaterialRow()">‚ûï Add Material</button>
                        </div>
                        
                        <div style="overflow-x: auto; border: 1px solid var(--border); border-radius: 8px;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8fafc;">
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border);">Material</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border); width: 120px;">Quantity</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border); width: 100px;">Unit</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border); width: 120px;">Unit Price</th>
                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border); width: 120px;">Total</th>
                                        <th style="padding: 12px; text-align: center; font-weight: 600; color: var(--text-primary); border-bottom: 2px solid var(--border); width: 80px;">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="bomMaterialsTable">
                                    <tr>
                                        <td colspan="6" style="padding: 20px; text-align: center; color: var(--text-secondary);">
                                            Click "Add Material" to add materials to this BOM
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- BOM Summary -->
                        <div style="margin-top: 16px; padding: 16px; background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="font-weight: 600; color: var(--text-primary);">Total Items:</span>
                                    <span id="bomTotalItems" style="margin-left: 8px; color: var(--primary);">0</span>
                                </div>
                                <div>
                                    <span style="font-weight: 600; color: var(--text-primary);">Total Value:</span>
                                    <span id="bomTotalValue" style="margin-left: 8px; color: var(--primary); font-size: 18px; font-weight: 700;">‚Çπ0.00</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-section">
                        <div class="form-group">
                            <label for="bomNotes">Notes/Remarks</label>
                            <textarea class="form-control" id="bomNotes" rows="3" placeholder="Add any additional notes or remarks..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bomModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">üíæ Save BOM</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, getDocs, getDoc, setDoc, query, orderBy, limit, where, onSnapshot, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyC2jWIdCA6VQMrZB8yanb3HQFzN9e6KXY0",
            authDomain: "dazzlojewellers.firebaseapp.com",
            projectId: "dazzlojewellers",
            storageBucket: "dazzlojewellers.firebasestorage.app",
            messagingSenderId: "334783357818",
            appId: "1:334783357818:web:3009541b14699606fd2cc3",
            measurementId: "G-288DC3S9LM"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Enable offline persistence
        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.log('Persistence failed: Multiple tabs open');
            } else if (err.code == 'unimplemented') {
                console.log('Persistence not available');
            }
        });

        const ADMIN_USERNAME = "Testing";
        const ADMIN_PASSWORD = "Testing";
        const SESSION_KEY = "ambivare_session";

        const CATEGORIES = {
            warehouse: ["Motors", "Controllers", "Cables", "Rails", "Car Equipment", "Safety Components", "Door Systems", "Fixtures", "Tools", "Hardware", "Other"],
            office: ["Stationery", "Paper", "Folders", "Pens", "Markers", "Toner", "Printer Supplies", "Furniture", "Electronics", "Other"],
            "service-van": ["Emergency Parts", "Tools", "Testing Equipment", "Safety Gear", "Sensors", "Controllers", "Cables", "Car Parts", "Door Parts", "Other"]
        };

        let currentUser = null;
        let inventory = { warehouse: [], office: [], "service-van": [] };
        let projects = [];
        let maintenance = [];
        let amc = [];
        let leads = [];
        let activities = [];
        let employees = [];
        let tasks = [];
        let invoices = [];
        let companySettings = {
            name: 'Avant Elevators',
            logo: 'ambivare.png',
            address: '',
            phone: '',
            email: 'avantelevator@gmail.com',
            gst: '',
            cin: '',
            bankDetails: ''
        };

        // Multi-language Translation System
        const translations = {
            en: {
                // Header & Navigation
                company_name: 'Avant Elevators',
                portal_subtitle: 'Elevator Management Portal',
                system_title: 'Elevator Management System',
                dashboard: 'Dashboard',
                warehouse: 'Warehouse',
                service_van: 'Service Van',
                office: 'Office',
                projects: 'Projects',
                maintenance: 'Maintenance',
                amc: 'AMC',
                billing: 'Billing',
                sales: 'Sales',
                activities: 'Activities',
                hr: 'HR',
                logout: 'Logout',
                
                // Login
                username: 'Username',
                password: 'Password',
                sign_in: 'Sign In',
                enter_username: 'Enter your username',
                enter_password: 'Enter password',
                
                // Common
                add: 'Add',
                edit: 'Edit',
                delete: 'Delete',
                save: 'Save',
                cancel: 'Cancel',
                close: 'Close',
                search: 'Search',
                filter: 'Filter',
                export: 'Export',
                create: 'Create',
                update: 'Update',
                
                // Dashboard
                total_items: 'Total Items',
                warehouse_items: 'Warehouse Items',
                service_van_items: 'Service Van Items',
                office_items: 'Office Items',
                active_projects: 'Active Projects',
                maintenance_due: 'Maintenance Due',
                
                // Forms
                name: 'Name',
                email: 'Email',
                phone: 'Phone',
                address: 'Address',
                status: 'Status',
                priority: 'Priority',
                date: 'Date',
                description: 'Description',
                notes: 'Notes'
            },
            
            hi: {
                // Header & Navigation
                company_name: '‡§Ö‡§µ‡§Ç‡§§ ‡§è‡§≤‡§ø‡§µ‡•á‡§ü‡§∞‡•ç‡§∏',
                portal_subtitle: '‡§è‡§≤‡§ø‡§µ‡•á‡§ü‡§∞ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤',
                system_title: '‡§è‡§≤‡§ø‡§µ‡•á‡§ü‡§∞ ‡§™‡•ç‡§∞‡§¨‡§Ç‡§ß‡§® ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä',
                dashboard: '‡§°‡•à‡§∂‡§¨‡•ã‡§∞‡•ç‡§°',
                warehouse: '‡§ó‡•ã‡§¶‡§æ‡§Æ',
                service_van: '‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§µ‡•à‡§®',
                office: '‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø',
                projects: '‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç',
                maintenance: '‡§∞‡§ñ‡§∞‡§ñ‡§æ‡§µ',
                sales: '‡§¨‡§ø‡§ï‡•ç‡§∞‡•Ä',
                activities: '‡§ó‡§§‡§ø‡§µ‡§ø‡§ß‡§ø‡§Ø‡§æ‡§Ç',
                users: '‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ',
                logout: '‡§≤‡•â‡§ó‡§Ü‡§â‡§ü',
                
                // Login
                username: '‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§Æ',
                password: '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°',
                sign_in: '‡§∏‡§æ‡§á‡§® ‡§á‡§®',
                enter_username: '‡§Ö‡§™‡§®‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§Æ ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç',
                enter_password: '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§¶‡§∞‡•ç‡§ú ‡§ï‡§∞‡•á‡§Ç',
                
                // Common
                add: '‡§ú‡•ã‡§°‡§º‡•á‡§Ç',
                edit: '‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡•á‡§Ç',
                delete: '‡§π‡§ü‡§æ‡§è‡§Ç',
                save: '‡§∏‡§π‡•á‡§ú‡•á‡§Ç',
                cancel: '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
                close: '‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡•á‡§Ç',
                search: '‡§ñ‡•ã‡§ú‡•á‡§Ç',
                filter: '‡§´‡§º‡§ø‡§≤‡•ç‡§ü‡§∞',
                export: '‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§',
                create: '‡§¨‡§®‡§æ‡§è‡§Ç',
                update: '‡§Ö‡§™‡§°‡•á‡§ü',
                
                // Dashboard
                total_items: '‡§ï‡•Å‡§≤ ‡§Ü‡§á‡§ü‡§Æ',
                warehouse_items: '‡§ó‡•ã‡§¶‡§æ‡§Æ ‡§Ü‡§á‡§ü‡§Æ',
                service_van_items: '‡§∏‡§∞‡•ç‡§µ‡§ø‡§∏ ‡§µ‡•à‡§® ‡§Ü‡§á‡§ü‡§Æ',
                office_items: '‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§Ü‡§á‡§ü‡§Æ',
                active_projects: '‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§™‡§∞‡§ø‡§Ø‡•ã‡§ú‡§®‡§æ‡§è‡§Ç',
                maintenance_due: '‡§∞‡§ñ‡§∞‡§ñ‡§æ‡§µ ‡§¨‡§ï‡§æ‡§Ø‡§æ',
                
                // Forms
                name: '‡§®‡§æ‡§Æ',
                email: '‡§à‡§Æ‡•á‡§≤',
                phone: '‡§´‡•ã‡§®',
                address: '‡§™‡§§‡§æ',
                status: '‡§∏‡•ç‡§•‡§ø‡§§‡§ø',
                priority: '‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï‡§§‡§æ',
                date: '‡§§‡§æ‡§∞‡•Ä‡§ñ',
                description: '‡§µ‡§ø‡§µ‡§∞‡§£',
                notes: '‡§®‡•ã‡§ü‡•ç‡§∏'
            },
            
            mr: {
                // Header & Navigation
                company_name: '‡§Ö‡§µ‡§Ç‡§§ ‡§è‡§≤‡§ø‡§µ‡•ç‡§π‡•á‡§ü‡§∞‡•ç‡§∏',
                portal_subtitle: '‡§è‡§≤‡§ø‡§µ‡•ç‡§π‡•á‡§ü‡§∞ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤',
                system_title: '‡§è‡§≤‡§ø‡§µ‡•ç‡§π‡•á‡§ü‡§∞ ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§™‡•ç‡§∞‡§£‡§æ‡§≤‡•Ä',
                dashboard: '‡§°‡•Ö‡§∂‡§¨‡•ã‡§∞‡•ç‡§°',
                warehouse: '‡§ó‡•ã‡§¶‡§æ‡§Æ',
                service_van: '‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡§ø‡§∏ ‡§µ‡•ç‡§π‡•Ö‡§®',
                office: '‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø',
                projects: '‡§™‡•ç‡§∞‡§ï‡§≤‡•ç‡§™',
                maintenance: '‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤',
                sales: '‡§µ‡§ø‡§ï‡•ç‡§∞‡•Ä',
                activities: '‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ‡§ï‡§≤‡§æ‡§™',
                users: '‡§µ‡§æ‡§™‡§∞‡§ï‡§∞‡•ç‡§§‡•á',
                logout: '‡§≤‡•â‡§ó‡§Ü‡§â‡§ü',
                
                // Login
                username: '‡§µ‡§æ‡§™‡§∞‡§ï‡§∞‡•ç‡§§‡•ç‡§Ø‡§æ‡§ö‡•á ‡§®‡§æ‡§µ',
                password: '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°',
                sign_in: '‡§∏‡§æ‡§á‡§® ‡§á‡§®',
                enter_username: '‡§§‡•Å‡§Æ‡§ö‡•á ‡§µ‡§æ‡§™‡§∞‡§ï‡§∞‡•ç‡§§‡§æ ‡§®‡§æ‡§µ ‡§ü‡§æ‡§ï‡§æ',
                enter_password: '‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° ‡§ü‡§æ‡§ï‡§æ',
                
                // Common
                add: '‡§ú‡•ã‡§°‡§æ',
                edit: '‡§∏‡§Ç‡§™‡§æ‡§¶‡§ø‡§§ ‡§ï‡§∞‡§æ',
                delete: '‡§π‡§ü‡§µ‡§æ',
                save: '‡§ú‡§§‡§® ‡§ï‡§∞‡§æ',
                cancel: '‡§∞‡§¶‡•ç‡§¶ ‡§ï‡§∞‡§æ',
                close: '‡§¨‡§Ç‡§¶ ‡§ï‡§∞‡§æ',
                search: '‡§∂‡•ã‡§ß‡§æ',
                filter: '‡§´‡§ø‡§≤‡•ç‡§ü‡§∞',
                export: '‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§',
                create: '‡§§‡§Ø‡§æ‡§∞ ‡§ï‡§∞‡§æ',
                update: '‡§Ö‡§™‡§°‡•á‡§ü',
                
                // Dashboard
                total_items: '‡§è‡§ï‡•Ç‡§£ ‡§µ‡§∏‡•ç‡§§‡•Ç',
                warehouse_items: '‡§ó‡•ã‡§¶‡§æ‡§Æ ‡§µ‡§∏‡•ç‡§§‡•Ç',
                service_van_items: '‡§∏‡§∞‡•ç‡§µ‡•ç‡§π‡§ø‡§∏ ‡§µ‡•ç‡§π‡•Ö‡§® ‡§µ‡§∏‡•ç‡§§‡•Ç',
                office_items: '‡§ï‡§æ‡§∞‡•ç‡§Ø‡§æ‡§≤‡§Ø ‡§µ‡§∏‡•ç‡§§‡•Ç',
                active_projects: '‡§∏‡§ï‡•ç‡§∞‡§ø‡§Ø ‡§™‡•ç‡§∞‡§ï‡§≤‡•ç‡§™',
                maintenance_due: '‡§¶‡•á‡§ñ‡§≠‡§æ‡§≤ ‡§¨‡§æ‡§ï‡•Ä',
                
                // Forms
                name: '‡§®‡§æ‡§µ',
                email: '‡§à‡§Æ‡•á‡§≤',
                phone: '‡§´‡•ã‡§®',
                address: '‡§™‡§§‡•ç‡§§‡§æ',
                status: '‡§∏‡•ç‡§•‡§ø‡§§‡•Ä',
                priority: '‡§™‡•ç‡§∞‡§æ‡§ß‡§æ‡§®‡•ç‡§Ø',
                date: '‡§§‡§æ‡§∞‡•Ä‡§ñ',
                description: '‡§µ‡§∞‡•ç‡§£‡§®',
                notes: '‡§®‡•ã‡§ü‡•ç‡§∏'
            }
        };

        // Current language (default: English)
        let currentLanguage = localStorage.getItem('selectedLanguage') || 'en';

        // Language change function
        window.changeLanguage = () => {
            const selector = document.getElementById('languageSelector');
            currentLanguage = selector.value;
            localStorage.setItem('selectedLanguage', currentLanguage);
            applyTranslations();
        };

        // Apply translations to the page
        function applyTranslations() {
            const elements = document.querySelectorAll('[data-translate]');
            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });

            // Handle placeholders
            const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
            placeholderElements.forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.placeholder = translations[currentLanguage][key];
                }
            });
        }

        // Initialize language on page load
        window.addEventListener('load', () => {
            const selector = document.getElementById('languageSelector');
            if (selector) {
                selector.value = currentLanguage;
                applyTranslations();
            }
        });

        // Apply translations when main app is shown
        function applyTranslationsOnLogin() {
            setTimeout(() => {
                const selector = document.getElementById('languageSelector');
                if (selector) {
                    selector.value = currentLanguage;
                    applyTranslations();
                }
            }, 100);
        }

        let isOnline = navigator.onLine !== false; // Default to true if undefined
        let locationChart = null;
        let stockChart = null;
        let barcodeCodeReader = null;
        let barcodeStream = null;
        let scanningActive = false;
        let currentScanLocation = null;

        window.addEventListener('online', () => {
            isOnline = true;
            console.log('System is online');
            document.getElementById('offlineBadge').classList.remove('show');
            syncOfflineData();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            console.log('System is offline');
            document.getElementById('offlineBadge').classList.add('show');
        });

        window.addEventListener('load', () => {
            checkSession();
        });

        function checkSession() {
            try {
                const savedSession = localStorage.getItem(SESSION_KEY);
                if (savedSession) {
                    const sessionData = JSON.parse(savedSession);
                    if (sessionData && sessionData.user) {
                        currentUser = sessionData.user;
                        showMainApp();
                        loadData();
                        // Start status sync for technicians
                        if (currentUser.role === 'technician') {
                            setTimeout(() => startStatusSync(), 2000);
                        }
                    }
                }
            } catch (error) {
                console.error('Error restoring session:', error);
                localStorage.removeItem(SESSION_KEY);
            }
        }

        function saveSession(user) {
            try {
                const sessionData = {
                    user: user,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
            } catch (error) {
                console.error('Error saving session:', error);
            }
        }

        function clearSession() {
            localStorage.removeItem(SESSION_KEY);
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');

            if (loginBtn) {
                loginBtn.disabled = true;
                loginBtn.textContent = 'Signing in...';
            }
            if (loginError) {
                loginError.style.display = 'none';
            }

            try {
                if (!username || !password) {
                    throw new Error('Please enter both username and password');
                }
                
                if (username === ADMIN_USERNAME && password === ADMIN_PASSWORD) {
                    currentUser = {
                        id: 'admin',
                        username: ADMIN_USERNAME,
                        fullName: 'Administrator',
                        role: 'admin',
                        status: 'active'
                    };
                    saveSession(currentUser);
                    showMainApp();
                    await loadData();
                    return;
                }

                if (isOnline) {
                    let foundUser = null;
                    
                    // Normalize username for case-insensitive comparison
                    const normalizedUsername = username.toLowerCase();
                    
                    // First check the 'users' collection
                    console.log('=== Checking users collection ===');
                    const usersSnapshot = await getDocs(collection(db, 'users'));
                    console.log('Users found:', usersSnapshot.size);
                    usersSnapshot.forEach(doc => {
                        const userData = doc.data();
                        if (userData.username && userData.username.toLowerCase() === normalizedUsername && userData.password === password) {
                            console.log('‚úÖ Found matching user:', userData.username);
                            foundUser = { id: doc.id, ...userData };
                        }
                    });
                    
                    // If not found in users, check the 'employees' collection (HR portal creates employees here)
                    if (!foundUser) {
                        console.log('=== Checking employees collection ===');
                        const employeesSnapshot = await getDocs(collection(db, 'employees'));
                        console.log('Employees found:', employeesSnapshot.size);
                        employeesSnapshot.forEach(doc => {
                            const empData = doc.data();
                            console.log('Checking employee:', empData.username, 'Status:', empData.systemStatus);
                            if (empData.username && empData.username.toLowerCase() === normalizedUsername && empData.password === password) {
                                console.log('‚úÖ Found matching employee:', empData.username);
                                // Map employee fields to user format for compatibility
                                foundUser = {
                                    id: doc.id,
                                    username: empData.username,
                                    password: empData.password,
                                    fullName: `${empData.firstName || ''} ${empData.lastName || ''}`.trim() || empData.username,
                                    role: empData.systemRole || empData.role || 'user',
                                    status: empData.systemStatus || empData.status || 'active'
                                };
                                console.log('Mapped employee to user format:', foundUser);
                            }
                        });
                    }

                    if (foundUser) {
                        console.log('Found user/employee:', foundUser.username, 'Status:', foundUser.status);
                    } else {
                        console.log('‚ùå No matching user/employee found');
                    }

                    if (foundUser && (foundUser.status === 'active' || foundUser.status === 'Active')) {
                        console.log('‚úÖ Login successful for:', foundUser.username);
                        currentUser = foundUser;
                        saveSession(currentUser);
                        showMainApp();
                        await loadData();
                        // Start status sync for technicians
                        if (currentUser.role === 'technician') {
                            setTimeout(() => startStatusSync(), 2000);
                        }
                    } else if (foundUser && foundUser.status !== 'active' && foundUser.status !== 'Active' && foundUser.status) {
                        console.log('‚ùå Account inactive:', foundUser.status);
                        throw new Error(`Account status is "${foundUser.status}". Please contact administrator.`);
                    } else if (foundUser) {
                        // Found user but no status or undefined status - treat as active
                        console.log('‚ö†Ô∏è User found with no status, treating as active');
                        currentUser = foundUser;
                        saveSession(currentUser);
                        showMainApp();
                        await loadData();
                        // Start status sync for technicians
                        if (currentUser.role === 'technician') {
                            setTimeout(() => startStatusSync(), 2000);
                        }
                    } else {
                        console.log('‚ùå Invalid credentials');
                        throw new Error('Invalid username or password');
                    }
                } else {
                    throw new Error('Cannot login in offline mode. Please check your internet connection.');
                }
            } catch (error) {
                const loginError = document.getElementById('loginError');
                if (loginError) {
                    loginError.textContent = error.message;
                    loginError.style.display = 'block';
                }
                const loginBtn = document.getElementById('loginBtn');
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                }
            }
        });

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.add('active');
            document.getElementById('userName').textContent = currentUser.fullName || currentUser.username;
            document.getElementById('userRole').textContent = currentUser.role.toUpperCase();
            
            // Apply translations
            applyTranslationsOnLogin();
            
            // Role-based access control
            const userRole = currentUser.role;
            
            // Admin - Full access to everything
            if (userRole === 'admin') {
                document.getElementById('usersTabBtn').style.display = 'block';
                document.getElementById('salesTabBtn').style.display = 'block';
                document.getElementById('billingTabBtn').style.display = 'block';
                document.getElementById('settingsTabBtn').style.display = 'block';
                document.getElementById('createTaskBtn')?.style && (document.getElementById('createTaskBtn').style.display = 'block');
            }
            
            // Sales Representative - Access to sales, projects, maintenance, activities, billing
            else if (userRole === 'sales') {
                document.getElementById('usersTabBtn').style.display = 'none';
                document.getElementById('salesTabBtn').style.display = 'block';
                document.getElementById('billingTabBtn').style.display = 'block';
                document.getElementById('createTaskBtn')?.style && (document.getElementById('createTaskBtn').style.display = 'none');
                // Hide sensitive inventory locations from sales
                hideTabsForRole(['hr']);
            }
            
            // Technician - Access to maintenance, inventory, projects, activities 
            else if (userRole === 'technician') {
                document.getElementById('usersTabBtn').style.display = 'none';
                document.getElementById('salesTabBtn').style.display = 'none';
                document.getElementById('billingTabBtn').style.display = 'none';
                document.getElementById('createTaskBtn')?.style && (document.getElementById('createTaskBtn').style.display = 'none');
                hideTabsForRole(['hr', 'sales', 'billing']);
            }
            
            // Reception - Access to projects, maintenance, basic inventory, activities, billing
            else if (userRole === 'reception') {
                document.getElementById('usersTabBtn').style.display = 'none';
                document.getElementById('salesTabBtn').style.display = 'none';
                document.getElementById('billingTabBtn').style.display = 'block';
                document.getElementById('createTaskBtn')?.style && (document.getElementById('createTaskBtn').style.display = 'none');
                hideTabsForRole(['hr', 'sales']);
            }
            
            // General User - Limited access
            else {
                document.getElementById('usersTabBtn').style.display = 'none';
                document.getElementById('salesTabBtn').style.display = 'none';
                document.getElementById('billingTabBtn').style.display = 'none';
                document.getElementById('createTaskBtn')?.style && (document.getElementById('createTaskBtn').style.display = 'none');
                hideTabsForRole(['hr', 'sales', 'billing']);
            }

            if (!isOnline) {
                document.getElementById('offlineBadge').classList.add('show');
            }
        }

        window.logout = () => {
            if (confirm('Are you sure you want to logout?')) {
                clearSession();
                currentUser = null;
                document.getElementById('mainApp').classList.remove('active');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('loginForm').reset();
                document.getElementById('usersTabBtn').style.display = 'none';
                document.getElementById('salesTabBtn').style.display = 'none';
                showTab('dashboard');
            }
        };

        async function loadData() {
            try {
                // Initialize arrays if they're undefined
                if (!inventory) inventory = { warehouse: [], office: [], "service-van": [] };
                if (!projects) projects = [];
                if (!maintenance) maintenance = [];
                if (!leads) leads = [];
                if (!activities) activities = [];
                if (!employees) employees = [];
                if (!invoices) invoices = [];
                
                // Show loading indicator
                const dashboardCards = document.querySelectorAll('.dashboard-card .value');
                dashboardCards.forEach(card => {
                    if (card) card.style.opacity = '0.5';
                });
                
                // Load data with individual error handling
                try { await loadInventory(); } catch (e) { console.warn('Failed to load inventory:', e); }
                
                try { await loadProjects(); } catch (e) { console.warn('Failed to load projects:', e); }
                try { await loadMaintenance(); } catch (e) { console.warn('Failed to load maintenance:', e); }
                try { await loadAMC(); } catch (e) { console.warn('Failed to load AMC:', e); }
                try { await loadLeads(); } catch (e) { console.warn('Failed to load leads:', e); }
                try { await loadActivities(); } catch (e) { console.warn('Failed to load activities:', e); }
                try { await loadEmployees(); } catch (e) { console.warn('Failed to load employees:', e); }
                try { await loadTasks(); } catch (e) { console.warn('Failed to load tasks:', e); }
                try { await loadSalarySlips(); } catch (e) { console.warn('Failed to load salary slips:', e); }
                try { await loadBillingData(); } catch (e) { console.warn('Failed to load billing data:', e); }
                try { await loadInvoices(); } catch (e) { console.warn('Failed to load invoices:', e); }
                try { await loadCompanySettings(); } catch (e) { console.warn('Failed to load company settings:', e); }
                
                // Hide loading indicator
                dashboardCards.forEach(card => {
                    if (card) card.style.opacity = '1';
                });
                
                updateDashboard();
                
                // Delay chart rendering to ensure Chart.js is fully loaded
                setTimeout(() => {
                    renderCharts();
                }, 500);
                
                checkLowStock();
                populateCategoryFilters();
                populateActivityUserFilter();
            } catch (error) {
                console.error('Error loading data:', error);
                // Still update dashboard with cached data
                updateDashboard();
                
                // Delay chart rendering to ensure Chart.js is fully loaded
                setTimeout(() => {
                    renderCharts();
                }, 500);
                checkLowStock();
                populateCategoryFilters();
                populateActivityUserFilter();
            }
        }

        async function loadInventory() {
            try {
                const snapshot = await getDocs(collection(db, 'inventory'));
                inventory = { warehouse: [], office: [], "service-van": [] };
                snapshot.docs.forEach(doc => {
                    const item = { id: doc.id, ...doc.data() };
                    if (inventory[item.location]) {
                        inventory[item.location].push(item);
                    }
                });
                // Cache the data
                localStorage.setItem('cachedInventory', JSON.stringify(inventory));
                renderLocation('warehouse');
                renderLocation('office');
                renderLocation('service-van');
            } catch (error) {
                console.error('Error loading inventory:', error);
                // Try to load from cache
                const cachedInventory = localStorage.getItem('cachedInventory');
                if (cachedInventory) {
                    inventory = JSON.parse(cachedInventory);
                    renderLocation('warehouse');
                    renderLocation('office');
                    renderLocation('service-van');
                }
            }
        }

        async function loadProjects() {
            console.log('Loading projects...');
            try {
                const snapshot = await getDocs(collection(db, 'projects'));
                projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Projects loaded:', projects.length);
                // Cache the data
                localStorage.setItem('cachedProjects', JSON.stringify(projects));
                renderProjects();
            } catch (error) {
                console.error('Error loading projects:', error);
                // Try to load from cache
                const cachedProjects = localStorage.getItem('cachedProjects');
                if (cachedProjects) {
                    console.log('Loading projects from cache...');
                    projects = JSON.parse(cachedProjects);
                    renderProjects();
                } else {
                    console.log('No cached projects data');
                    projects = [];
                    renderProjects();
                }
            }
        }

        async function loadMaintenance() {
            console.log('Loading maintenance...');
            try {
                const snapshot = await getDocs(collection(db, 'maintenance'));
                maintenance = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Maintenance loaded:', maintenance.length);
                
                // Also load scheduled maintenance from active AMC contracts
                await loadAMCScheduledMaintenance();
                
                // Cache the data
                localStorage.setItem('cachedMaintenance', JSON.stringify(maintenance));
                renderMaintenance();
            } catch (error) {
                console.error('Error loading maintenance:', error);
                // Try to load from cache
                const cachedMaintenance = localStorage.getItem('cachedMaintenance');
                if (cachedMaintenance) {
                    console.log('Loading maintenance from cache...');
                    maintenance = JSON.parse(cachedMaintenance);
                    renderMaintenance();
                } else {
                    console.log('No cached maintenance data');
                    maintenance = [];
                    renderMaintenance();
                }
            }
        }

        // Load scheduled maintenance from AMC contracts
        async function loadAMCScheduledMaintenance() {
            try {
                // Get all active AMC contracts
                const amcSnapshot = await getDocs(collection(db, 'amc'));
                const activeAMCs = amcSnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .filter(contract => contract.status === 'Active');
                
                console.log('Active AMC contracts:', activeAMCs.length);
                
                // For each active AMC, check if there's scheduled maintenance
                for (const contract of activeAMCs) {
                    // Generate monthly maintenance schedules based on AMC
                    const maintenanceFrequency = contract.maintenanceFrequency || 'Monthly'; // Monthly, Quarterly, etc.
                    const startDate = new Date(contract.startDate);
                    const endDate = new Date(contract.endDate);
                    const today = new Date();
                    
                    // Only show upcoming scheduled maintenance (next 90 days)
                    const futureDate = new Date();
                    futureDate.setDate(today.getDate() + 90);
                    
                    // Calculate next maintenance date
                    let nextMaintenanceDate = calculateNextMaintenanceDate(contract, today);
                    
                    if (nextMaintenanceDate && nextMaintenanceDate >= today && nextMaintenanceDate <= futureDate) {
                        // Check if maintenance record already exists for this period
                        const existingMaintenance = maintenance.find(m => 
                            m.amcContractId === contract.id && 
                            m.dueDate === nextMaintenanceDate.toISOString().split('T')[0] &&
                            m.status !== 'Completed'
                        );
                        
                        if (!existingMaintenance) {
                            // Create scheduled maintenance entry
                            const scheduledMaintenance = {
                                id: `amc-${contract.id}-${nextMaintenanceDate.getTime()}`,
                                amcContractId: contract.id,
                                amcContractNumber: contract.contractNumber,
                                rciType: 'AMC Service',
                                projectName: contract.projectName,
                                buildingName: contract.buildingName || contract.propertyName,
                                elevatorId: contract.elevatorIds || 'All Lifts',
                                elevatorCount: contract.numberOfLifts || 1,
                                issue: `Scheduled ${maintenanceFrequency} AMC Service`,
                                complaintPersonName: contract.clientName,
                                complaintPersonPhone: contract.clientContact || '',
                                complaintPersonDesignation: 'AMC Client',
                                priority: 'Medium',
                                assignedTo: contract.assignedTechnician || 'Unassigned',
                                dueDate: nextMaintenanceDate.toISOString().split('T')[0],
                                status: 'Scheduled',
                                isAMCScheduled: true,
                                createdFrom: 'AMC',
                                scheduledAt: new Date().toISOString()
                            };
                            
                            // Add to maintenance array for display
                            maintenance.push(scheduledMaintenance);
                        }
                    }
                }
                
                console.log('Total maintenance (including AMC):', maintenance.length);
                
            } catch (error) {
                console.error('Error loading AMC scheduled maintenance:', error);
            }
        }

        // Calculate next maintenance date based on AMC frequency
        function calculateNextMaintenanceDate(contract, fromDate) {
            const frequency = contract.maintenanceFrequency || 'Monthly';
            const startDate = new Date(contract.startDate);
            const endDate = new Date(contract.endDate);
            
            if (fromDate > endDate) {
                return null; // Contract expired
            }
            
            let nextDate = new Date(fromDate);
            
            switch (frequency) {
                case 'Monthly':
                    // Find next month
                    if (contract.lastServiceDate) {
                        nextDate = new Date(contract.lastServiceDate);
                        nextDate.setMonth(nextDate.getMonth() + 1);
                    } else {
                        nextDate = new Date(startDate);
                        // Find first upcoming month
                        while (nextDate < fromDate) {
                            nextDate.setMonth(nextDate.getMonth() + 1);
                        }
                    }
                    break;
                    
                case 'Quarterly':
                    if (contract.lastServiceDate) {
                        nextDate = new Date(contract.lastServiceDate);
                        nextDate.setMonth(nextDate.getMonth() + 3);
                    } else {
                        nextDate = new Date(startDate);
                        while (nextDate < fromDate) {
                            nextDate.setMonth(nextDate.getMonth() + 3);
                        }
                    }
                    break;
                    
                case 'Half-Yearly':
                    if (contract.lastServiceDate) {
                        nextDate = new Date(contract.lastServiceDate);
                        nextDate.setMonth(nextDate.getMonth() + 6);
                    } else {
                        nextDate = new Date(startDate);
                        while (nextDate < fromDate) {
                            nextDate.setMonth(nextDate.getMonth() + 6);
                        }
                    }
                    break;
                    
                case 'Yearly':
                    if (contract.lastServiceDate) {
                        nextDate = new Date(contract.lastServiceDate);
                        nextDate.setFullYear(nextDate.getFullYear() + 1);
                    } else {
                        nextDate = new Date(startDate);
                        while (nextDate < fromDate) {
                            nextDate.setFullYear(nextDate.getFullYear() + 1);
                        }
                    }
                    break;
                    
                default:
                    // Default to monthly
                    nextDate.setMonth(nextDate.getMonth() + 1);
            }
            
            // Make sure date is within contract period
            if (nextDate > endDate) {
                return null;
            }
            
            return nextDate;
        }

        async function loadAMC() {
            try {
                const snapshot = await getDocs(collection(db, 'amc'));
                amc = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Cache the data
                localStorage.setItem('cachedAMC', JSON.stringify(amc));
                renderAMC();
                checkAMCRenewals();
            } catch (error) {
                console.error('Error loading AMC:', error);
                // Try to load from cache
                const cachedAMC = localStorage.getItem('cachedAMC');
                if (cachedAMC) {
                    amc = JSON.parse(cachedAMC);
                    renderAMC();
                    checkAMCRenewals();
                }
            }
        }

        async function loadActivities() {
            try {
                const q = query(collection(db, 'activities'), orderBy('date', 'desc'));
                const snapshot = await getDocs(q);
                activities = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Cache the data
                localStorage.setItem('cachedActivities', JSON.stringify(activities));
                renderActivities();
            } catch (error) {
                console.error('Error loading activities:', error);
                // Try to load from cache
                const cachedActivities = localStorage.getItem('cachedActivities');
                if (cachedActivities) {
                    activities = JSON.parse(cachedActivities);
                    renderActivities();
                }
            }
        }

        async function loadEmployees() {
            console.log('=== Loading employees ===');
            console.log('Current employees array length:', employees.length);
            try {
                // First try to load from 'employees' collection
                console.log('Trying to load from employees collection...');
                let snapshot = await getDocs(collection(db, 'employees'));
                console.log('Employees snapshot retrieved. Empty?', snapshot.empty, 'Size:', snapshot.size);
                
                // If employees collection is empty, try to load from 'users' collection for compatibility
                if (snapshot.empty) {
                    console.log('No employees found, trying users collection for compatibility...');
                    snapshot = await getDocs(collection(db, 'users'));
                    if (!snapshot.empty) {
                        console.log(`Found ${snapshot.docs.length} users, converting to employees...`);
                        // Convert user data to employee format
                        employees = snapshot.docs.map(doc => {
                            const userData = doc.data();
                            return {
                                id: doc.id,
                                // Map user fields to employee fields
                                employeeId: userData.username || `EMP${doc.id.slice(-3)}`,
                                firstName: userData.fullName ? userData.fullName.split(' ')[0] : userData.username,
                                lastName: userData.fullName ? userData.fullName.split(' ').slice(1).join(' ') : '',
                                username: userData.username,
                                password: userData.password,
                                systemRole: userData.role,
                                systemStatus: userData.status,
                                employeeStatus: userData.status === 'active' ? 'Active' : 'Inactive',
                                position: userData.role === 'admin' ? 'Administrator' : 
                                         userData.role === 'sales' ? 'Sales Executive' :
                                         userData.role === 'technician' ? 'Technician' :
                                         userData.role === 'reception' ? 'Receptionist' : 'Staff',
                                department: userData.role === 'admin' ? 'Administration' :
                                          userData.role === 'sales' ? 'Sales' :
                                          userData.role === 'technician' ? 'Maintenance' :
                                          userData.role === 'reception' ? 'Administration' : 'General',
                                // Set default values for missing fields
                                email: '',
                                phone: '',
                                currentSalary: 0,
                                joiningDate: '',
                                createdDate: new Date().toISOString(),
                                createdBy: 'system_migration'
                            };
                        });
                    } else {
                        console.log('No users found either, using empty array');
                        employees = [];
                    }
                } else {
                    console.log(`Found ${snapshot.docs.length} employees in Firebase`);
                    employees = snapshot.docs.map(doc => {
                        const data = doc.data();
                        console.log('Employee data:', doc.id, data.firstName, data.lastName, 'Username:', data.username, 'Status:', data.systemStatus);
                        return { id: doc.id, ...data };
                    });
                }
                
                console.log('‚úÖ Employees loaded successfully:', employees.length);
                console.log('Employee usernames:', employees.map(e => e.username));
                // Cache the data
                localStorage.setItem('cachedEmployees', JSON.stringify(employees));
                renderEmployees();
                updateHRStats();
                populateManagerDropdown();
                populateAssigneeFilters();
            } catch (error) {
                console.error('‚ùå Error loading employees:', error);
                console.error('Error details:', error.message, error.stack);
                // Try to load from cache
                const cachedEmployees = localStorage.getItem('cachedEmployees');
                if (cachedEmployees) {
                    console.log('Loading from cache...');
                    employees = JSON.parse(cachedEmployees);
                    console.log('Loaded from cache:', employees.length, 'employees');
                    renderEmployees();
                    updateHRStats();
                    populateManagerDropdown();
                    populateAssigneeFilters();
                } else {
                    console.log('No cached data available');
                    employees = [];
                    renderEmployees();
                    updateHRStats();
                }
            }
        }

        // Add the missing populateAssigneeFilters function
        function populateAssigneeFilters() {
            // Populate maintenance assignee filter dropdown
            const maintenanceAssigneeFilter = document.getElementById('maintenanceAssigneeFilter');
            if (maintenanceAssigneeFilter && employees) {
                const technicians = employees.filter(emp => 
                    (emp.systemRole === 'technician' || emp.systemRole === 'user' || emp.systemRole === 'admin') && 
                    emp.systemStatus === 'active'
                );
                maintenanceAssigneeFilter.innerHTML = '<option value="">All Technicians</option>' + 
                    technicians.map(emp => `<option value="${emp.username}">${emp.firstName} ${emp.lastName}</option>`).join('');
            }

            // Populate lead assignee filter if it exists
            const leadAssigneeFilter = document.getElementById('leadAssigneeFilter');
            if (leadAssigneeFilter && employees) {
                const salesReps = employees.filter(emp => 
                    (emp.systemRole === 'sales' || emp.systemRole === 'admin') && 
                    emp.systemStatus === 'active'
                );
                leadAssigneeFilter.innerHTML = '<option value="">All Sales Reps</option>' + 
                    salesReps.map(emp => `<option value="${emp.username}">${emp.firstName} ${emp.lastName}</option>`).join('');
            }
        }

        function syncOfflineData() {
            loadData();
        }

        function getAllItems() {
            return [...inventory.warehouse, ...inventory.office, ...inventory["service-van"]];
        }

        function updateDashboard() {
            // Helper function to safely set textContent
            const safeSetText = (id, value) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                } else {
                    console.warn(`Element with ID '${id}' not found`);
                }
            };
            
            const allItems = getAllItems();
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            // Inventory Analytics
            const totalInventory = allItems ? allItems.length : 0;
            safeSetText('totalItems', totalInventory);
            safeSetText('totalInventoryItems', totalInventory);
            safeSetText('warehouseItems', inventory.warehouse ? inventory.warehouse.length : 0);
            safeSetText('serviceVanItems', inventory["service-van"] ? inventory["service-van"].length : 0);
            safeSetText('officeItems', inventory.office ? inventory.office.length : 0);
            
            const lowStock = allItems ? allItems.filter(item => item.quantity < 50).length : 0;
            safeSetText('lowStockItems', lowStock);
            
            // Project Analytics
            const activeProjectsCount = projects ? projects.filter(p => p.status === 'Active').length : 0;
            const completedProjectsCount = projects ? projects.filter(p => p.status === 'Completed').length : 0;
            const onHoldProjectsCount = projects ? projects.filter(p => p.status === 'On Hold').length : 0;
            
            safeSetText('activeProjects', activeProjectsCount);
            safeSetText('activeProjectsCount', activeProjectsCount);
            safeSetText('completedProjects', completedProjectsCount);
            safeSetText('onHoldProjects', onHoldProjectsCount);
            
            // Calculate average progress
            const avgProgress = projects && projects.length > 0 
                ? (projects.reduce((sum, p) => sum + (parseInt(p.progress) || 0), 0) / projects.length).toFixed(1) 
                : 0;
            safeSetText('avgProgress', avgProgress + '%');
            
            // Lead Analytics
            const totalLeadsCount = leads ? leads.length : 0;
            const hotLeadsCount = leads ? leads.filter(l => l.priority === 'Hot').length : 0;
            const convertedLeadsCount = leads ? leads.filter(l => l.status === 'Converted').length : 0;
            const pipelineValue = leads ? leads.filter(l => l.value).reduce((sum, l) => sum + parseFloat(l.value || 0), 0) : 0;
            
            safeSetText('totalLeadsCount', totalLeadsCount);
            safeSetText('totalLeads', totalLeadsCount);
            safeSetText('hotLeads', hotLeadsCount);
            safeSetText('convertedLeads', convertedLeadsCount);
            safeSetText('pipelineValue', '‚Çπ' + pipelineValue.toLocaleString('en-IN'));
            
            // Conversion Rate
            const conversionRate = totalLeadsCount > 0 ? ((convertedLeadsCount / totalLeadsCount) * 100).toFixed(1) : 0;
            safeSetText('conversionRate', conversionRate + '%');
            
            // Sales Analytics
            const monthlyRevenue = leads ? leads.filter(l => l.status === 'Converted' && l.value && 
                new Date(l.updatedAt).getMonth() === currentMonth && 
                new Date(l.updatedAt).getFullYear() === currentYear)
                .reduce((sum, l) => sum + parseFloat(l.value || 0), 0) : 0;
            
            const quarterStart = Math.floor(currentMonth / 3) * 3;
            const quarterlyRevenue = leads ? leads.filter(l => l.status === 'Converted' && l.value &&
                new Date(l.updatedAt).getMonth() >= quarterStart &&
                new Date(l.updatedAt).getMonth() < quarterStart + 3 &&
                new Date(l.updatedAt).getFullYear() === currentYear)
                .reduce((sum, l) => sum + parseFloat(l.value || 0), 0) : 0;
            
            const yearlyRevenue = leads ? leads.filter(l => l.status === 'Converted' && l.value &&
                new Date(l.updatedAt).getFullYear() === currentYear)
                .reduce((sum, l) => sum + parseFloat(l.value || 0), 0) : 0;
            
            const totalRevenue = leads ? leads.filter(l => l.status === 'Converted' && l.value)
                .reduce((sum, l) => sum + parseFloat(l.value || 0), 0) : 0;
            
            safeSetText('totalRevenue', '‚Çπ' + totalRevenue.toLocaleString('en-IN'));
            safeSetText('monthlyRevenue', '‚Çπ' + monthlyRevenue.toLocaleString('en-IN'));
            safeSetText('quarterlyRevenue', '‚Çπ' + quarterlyRevenue.toLocaleString('en-IN'));
            safeSetText('yearlyRevenue', '‚Çπ' + yearlyRevenue.toLocaleString('en-IN'));
            
            // Maintenance Analytics
            const pendingMaintenanceCount = maintenance ? maintenance.filter(m => m.status === 'Scheduled').length : 0;
            const inProgressMaintenanceCount = maintenance ? maintenance.filter(m => m.status === 'In Progress').length : 0;
            const completedMaintenanceCount = maintenance ? maintenance.filter(m => m.status === 'Completed' &&
                new Date(m.completionTime).getMonth() === currentMonth &&
                new Date(m.completionTime).getFullYear() === currentYear).length : 0;
            const overdueMaintenanceCount = maintenance ? maintenance.filter(m => 
                m.status !== 'Completed' && m.dueDate && new Date(m.dueDate) < currentDate).length : 0;
            
            safeSetText('maintenanceDue', pendingMaintenanceCount + inProgressMaintenanceCount);
            safeSetText('pendingMaintenance', pendingMaintenanceCount);
            safeSetText('inProgressMaintenance', inProgressMaintenanceCount);
            safeSetText('completedMaintenance', completedMaintenanceCount);
            safeSetText('overdueMaintenance', overdueMaintenanceCount);
            
            // AMC Analytics
            const activeAMCCount = amc ? amc.filter(a => a.status === 'Active').length : 0;
            const totalAMCValue = amc ? amc.filter(a => a.status === 'Active')
                .reduce((sum, a) => sum + parseFloat(a.amount || 0), 0) : 0;
            
            // Expiring soon (within 60 days)
            const expiringDate = new Date();
            expiringDate.setDate(expiringDate.getDate() + 60);
            const expiringSoonCount = amc ? amc.filter(a => a.endDate && 
                new Date(a.endDate) > currentDate && 
                new Date(a.endDate) <= expiringDate).length : 0;
            
            safeSetText('activeAMCs', activeAMCCount);
            safeSetText('activeAMCCount', activeAMCCount);
            safeSetText('totalAMCValue', '‚Çπ' + totalAMCValue.toLocaleString('en-IN'));
            safeSetText('expiringSoonAMC', expiringSoonCount);
            
            // Renewal rate (simplified - could be improved with historical data)
            const renewalRate = amc && amc.length > 0 ? ((activeAMCCount / amc.length) * 100).toFixed(1) : 0;
            safeSetText('renewalRate', renewalRate + '%');
            
            // HR Analytics
            const totalEmployeesCount = employees ? employees.length : 0;
            const activeEmployeesCount = employees ? employees.filter(e => e.systemStatus === 'active').length : 0;
            
            safeSetText('totalEmployees', totalEmployeesCount);
            safeSetText('totalEmployeesCount', totalEmployeesCount);
            safeSetText('activeEmployees', activeEmployeesCount);
            
            // Calculate monthly payroll
            const monthlyPayroll = employees ? employees.filter(e => e.systemStatus === 'active')
                .reduce((sum, e) => sum + parseFloat(e.salary || 0), 0) : 0;
            safeSetText('monthlyPayroll', '‚Çπ' + monthlyPayroll.toLocaleString('en-IN'));
            
            // Pending salaries (this would need salary slip data)
            const pendingSalariesCount = salarySlips ? salarySlips.filter(s => s.status === 'Pending').length : 0;
            safeSetText('pendingSalaries', pendingSalariesCount);
            
            // Billing Analytics
            const totalInvoicesCount = invoices ? invoices.length : 0;
            const pendingInvoicesCount = invoices ? invoices.filter(i => i.paymentStatus === 'Pending' || i.paymentStatus === 'Partial').length : 0;
            const paidInvoicesCount = invoices ? invoices.filter(i => i.paymentStatus === 'Paid' &&
                new Date(i.paidDate).getMonth() === currentMonth &&
                new Date(i.paidDate).getFullYear() === currentYear).length : 0;
            const outstandingAmount = invoices ? invoices.filter(i => i.paymentStatus !== 'Paid')
                .reduce((sum, i) => sum + (parseFloat(i.totalAmount || 0) - parseFloat(i.paidAmount || 0)), 0) : 0;
            
            safeSetText('totalInvoices', totalInvoicesCount);
            safeSetText('pendingInvoices', pendingInvoicesCount);
            safeSetText('pendingInvoicesCount', pendingInvoicesCount);
            safeSetText('paidInvoices', paidInvoicesCount);
            safeSetText('outstandingAmount', '‚Çπ' + outstandingAmount.toLocaleString('en-IN'));
        }

        function checkLowStock() {
            const allItems = getAllItems();
            const lowStockItems = allItems.filter(item => item.quantity < 50);
            const alertContainer = document.getElementById('lowStockAlerts');
            
            if (lowStockItems.length > 0) {
                alertContainer.innerHTML = `
                    <div class="low-stock-alert">
                        <span class="icon">‚ö†Ô∏è</span>
                        <div style="flex: 1;">
                            <strong>Low Stock Alert!</strong>
                            <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--text-secondary);">
                                ${lowStockItems.length} item(s) are running low
                            </p>
                            <ul class="low-stock-list" style="margin-top: 8px;">
                                ${lowStockItems.slice(0, 5).map(item => `
                                    <li>
                                        <strong>${item.name}</strong> (${item.location}): ${item.quantity} ${item.unit} remaining
                                    </li>
                                `).join('')}
                                ${lowStockItems.length > 5 ? `<li>... and ${lowStockItems.length - 5} more</li>` : ''}
                            </ul>
                        </div>
                    </div>
                `;
            } else {
                alertContainer.innerHTML = '';
            }
        }

        function renderCharts() {
            console.log('Rendering charts...');
            try {
                renderLocationChart();
                renderStockChart();
            } catch (error) {
                console.error('Error rendering charts:', error);
            }
        }

        function renderLocationChart() {
            console.log('Rendering location chart...');
            const ctx = document.getElementById('locationChart');
            if (!ctx) {
                console.warn('Location chart canvas not found');
                return;
            }

            // Use correct inventory structure with safety checks
            const data = {
                Warehouse: (inventory?.warehouse?.length) || 0,
                Office: (inventory?.office?.length) || 0,
                "Service Van": (inventory?.["service-van"]?.length) || 0
            };

            console.log('Location chart data:', data);

            if (locationChart) {
                locationChart.destroy();
                locationChart = null;
            }

            try {
                locationChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(data),
                        datasets: [{
                            data: Object.values(data),
                            backgroundColor: ['#2563eb', '#16a34a', '#ea580c']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 1.5,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                console.log('Location chart created successfully');
            } catch (error) {
                console.error('Error creating location chart:', error);
            }
        }

        function renderStockChart() {
            console.log('Rendering stock chart...');
            const ctx = document.getElementById('stockChart');
            if (!ctx) {
                console.warn('Stock chart canvas not found');
                return;
            }

            try {
                const allItems = getAllItems();
                console.log('All items for stock chart:', allItems.length);
                
                const goodStock = allItems.filter(i => i && i.quantity >= 200).length;
                const mediumStock = allItems.filter(i => i && i.quantity >= 50 && i.quantity < 200).length;
                const lowStock = allItems.filter(i => i && i.quantity < 50).length;

                console.log('Stock levels:', { goodStock, mediumStock, lowStock });

                if (stockChart) {
                    stockChart.destroy();
                    stockChart = null;
                }

                stockChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Good Stock', 'Medium Stock', 'Low Stock'],
                        datasets: [{
                            label: 'Items',
                            data: [goodStock, mediumStock, lowStock],
                            backgroundColor: ['#16a34a', '#ea580c', '#dc2626']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    stepSize: 1
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
                console.log('Stock chart created successfully');
            } catch (error) {
                console.error('Error creating stock chart:', error);
            }
        }

        function getFilteredLocationItems(location) {
            const searchValue = document.getElementById(`search${location.charAt(0).toUpperCase() + location.slice(1)}`).value.toLowerCase();
            const categoryValue = document.getElementById(`categoryFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            const statusValue = document.getElementById(`statusFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            
            return inventory[location].filter(item => {
                const text = `${item.name} ${item.category} ${item.description || ''}`.toLowerCase();
                const matchesSearch = text.includes(searchValue);
                const matchesCategory = !categoryValue || item.category === categoryValue;
                
                let matchesStatus = true;
                if (statusValue) {
                    const stockClass = item.quantity < 50 ? 'low' : item.quantity < 200 ? 'medium' : 'good';
                    matchesStatus = stockClass === statusValue;
                }
                
                return matchesSearch && matchesCategory && matchesStatus;
            });
        }

        function getFilteredProjects() {
            const searchValue = document.getElementById('searchProjects').value.toLowerCase();
            const statusValue = document.getElementById('projectStatusFilter').value;
            
            return projects.filter(proj => {
                const text = `${proj.name} ${proj.code} ${proj.client || ''} ${proj.description || ''}`.toLowerCase();
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusValue || proj.status === statusValue;
                
                return matchesSearch && matchesStatus;
            });
        }

        function getFilteredActivities() {
            const searchValue = document.getElementById('searchActivities').value.toLowerCase();
            const dateRange = document.getElementById('activityDateFilter').value;
            const userFilter = document.getElementById('activityUserFilter').value;
            
            const now = new Date();
            
            return activities.filter(act => {
                const text = act.action.toLowerCase();
                const user = act.user || '';
                const date = new Date(act.date);
                
                const matchesSearch = text.includes(searchValue);
                const matchesUser = !userFilter || user === userFilter;
                
                let matchesDate = true;
                if (dateRange !== 'all') {
                    const dayMs = 24 * 60 * 60 * 1000;
                    const diff = now - date;
                    
                    switch(dateRange) {
                        case 'today':
                            matchesDate = diff < dayMs;
                            break;
                        case 'week':
                            matchesDate = diff < 7 * dayMs;
                            break;
                        case 'month':
                            matchesDate = diff < 30 * dayMs;
                            break;
                        case 'quarter':
                            matchesDate = diff < 90 * dayMs;
                            break;
                        case 'halfyear':
                            matchesDate = diff < 180 * dayMs;
                            break;
                        case 'year':
                            matchesDate = diff < 365 * dayMs;
                            break;
                    }
                }
                
                return matchesSearch && matchesUser && matchesDate;
            });
        }

        function renderLocation(location) {
            // Handle service-van special case (ID is serviceVanList not service-vanList)
            const tbodyId = location === 'service-van' ? 'serviceVanList' : `${location}List`;
            const tbody = document.getElementById(tbodyId);
            const items = inventory[location];
            
            if (items.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">üì¶</div><p>No items in ${location}. Click "Add Item" to get started.</p></td></tr>`;
                return;
            }

            tbody.innerHTML = items.map(item => {
                const stockClass = item.quantity < 50 ? 'danger' : item.quantity < 200 ? 'warning' : 'success';
                const stockText = item.quantity < 50 ? 'Low Stock' : item.quantity < 200 ? 'Medium' : 'Good';
                const stockStatus = item.quantity < 50 ? 'low' : item.quantity < 200 ? 'medium' : 'good';
                
                return `
                    <tr data-category="${item.category}" data-status="${stockStatus}">
                        <td>
                            <strong>${item.name}</strong>
                            ${item.barcode ? `<br><small style="color: var(--text-secondary);">SKU: ${item.barcode}</small>` : ''}
                            ${item.description ? `<br><small style="color: var(--text-secondary);">${item.description}</small>` : ''}
                        </td>
                        <td>${item.category}</td>
                        <td><strong>${item.quantity}</strong> ${item.unit}</td>
                        <td><span class="badge badge-${stockClass}">${stockText}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-success btn-sm" onclick="showAddStockModal('${item.id}')">+ Add</button>
                                <button class="btn btn-primary btn-sm" onclick="showUseModal('${item.id}')">Use</button>
                                <button class="btn btn-secondary btn-sm" onclick="editInventory('${item.id}')">Edit</button>
                                ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteInventory('${item.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderProjects() {
            const tbody = document.getElementById('projectList');
            if (!tbody) return;
            
            if (!projects || projects.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìã</div><p>No projects. Click "Create Project" to get started.</p></td></tr>';
                return;
            }

            tbody.innerHTML = projects.map(proj => {
                const statusClass = proj.status === 'Active' ? 'success' : proj.status === 'Completed' ? 'primary' : 'secondary';
                
                // Calculate total elevators - prioritize new lifts array
                let totalElevators = 0;
                let elevatorInfo = 'Not specified';
                
                if (proj.lifts && proj.lifts.length > 0) {
                    // New format with lifts array
                    totalElevators = proj.lifts.length;
                    const liftTypes = {};
                    proj.lifts.forEach(lift => {
                        const type = lift.type || 'Elevator';
                        liftTypes[type] = (liftTypes[type] || 0) + 1;
                    });
                    elevatorInfo = Object.entries(liftTypes).map(([type, count]) => 
                        `${count} ${type}${count > 1 ? 's' : ''}`
                    ).join(', ');
                } else if (proj.wings && proj.wings.length > 0) {
                    // Old format with wings
                    totalElevators = proj.wings.reduce((sum, wing) => sum + (wing.elevators ? wing.elevators.length : 0), 0);
                    elevatorInfo = proj.wings.map(wing => 
                        `${wing.wingName}: ${wing.elevators ? wing.elevators.length : 0} elevator(s)`
                    ).join(', ');
                } else if (proj.elevatorCount) {
                    // Fallback to elevatorCount
                    totalElevators = proj.elevatorCount;
                    elevatorInfo = `${totalElevators} ${proj.elevatorType || 'Elevator'}(s)`;
                }
                
                const progressBar = proj.progress ? `<div class="progress-bar"><div class="progress-fill" style="width: ${proj.progress}%"></div></div><small>${proj.progress}%</small>` : '';
                
                // Sub-apartments display
                const subApartmentsInfo = proj.subApartments && proj.subApartments.length > 0 ? 
                    `<br><small>üè¢ Sub-apartments: ${proj.subApartments.join(', ')}</small>` : '';
                
                return `
                    <tr data-status="${proj.status}">
                        <td>
                            <strong>${proj.name}</strong>
                            <div class="project-details">
                                <small>${proj.type || 'Project'} for ${proj.client}</small>
                                ${proj.address ? `<br><small>üìç ${proj.address}</small>` : ''}
                                ${subApartmentsInfo}
                            </div>
                        </td>
                        <td>${proj.code}</td>
                        <td>${proj.client || '-'}</td>
                        <td>${elevatorInfo}</td>
                        <td>${progressBar}</td>
                        <td><span class="badge badge-${statusClass}">${proj.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editProject('${proj.id}')">Edit</button>
                                ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteProject('${proj.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderMaintenance() {
            const tbody = document.getElementById('maintenanceList');
            if (!tbody) return;
            
            if (!maintenance || maintenance.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="empty-state"><div class="empty-state-icon">üîß</div><p>No RCI records found. Click "New RCI Record" to get started.</p></td></tr>';
                updateRCIStats();
                return;
            }

            tbody.innerHTML = maintenance.map(maint => {
                const statusClass = maint.status === 'Completed' ? 'success' : 
                                  maint.status === 'In Progress' ? 'warning' :
                                  maint.status === 'Scheduled' ? 'info' :
                                  maint.status === 'Overdue' ? 'danger' : 'secondary';
                const priorityClass = maint.priority === 'High' ? 'danger' : 
                                     maint.priority === 'Medium' ? 'warning' : 'secondary';
                
                // Check if overdue
                const isOverdue = new Date(maint.dueDate) < new Date() && maint.status !== 'Completed';
                const actualStatus = isOverdue ? 'Overdue' : maint.status;
                const actualStatusClass = isOverdue ? 'danger' : statusClass;
                
                const complaintPerson = maint.complaintPersonName || 'N/A';
                const hasSignatures = maint.arrivalSignature || maint.completionSignature;
                
                // RCI Type badge - highlight AMC scheduled maintenance
                const rciType = maint.isAMCScheduled ? 'AMC Service' : (maint.rciType || 'Maintenance');
                const typeIcon = maint.isAMCScheduled ? 'üìÖ' : (rciType === 'Repair' ? 'üîß' : rciType === 'Complaint' ? 'üì¢' : 'üõ†Ô∏è');
                const typeColor = maint.isAMCScheduled ? '#7c3aed' : (rciType === 'Repair' ? '#dc2626' : rciType === 'Complaint' ? '#d97706' : '#2563eb');
                
                // Handle both single and multiple elevator formats
                const elevatorDisplay = maint.elevatorIds ? 
                    `${maint.elevatorCount} Lifts<br><small style="color: var(--text-secondary);">${maint.elevatorList}</small>` :
                    maint.elevatorId || 'N/A';
                
                // Building/Wing/Floor display
                const locationDisplay = `
                    <strong>${maint.projectName || '-'}</strong>
                    ${maint.buildingName ? `<br><small>üè¢ ${maint.buildingName}</small>` : ''}
                    ${maint.isAMCScheduled ? `<br><small style="color: #7c3aed; font-weight: 600;">üìã ${maint.amcContractNumber || 'AMC'}</small>` : ''}
                `;
                
                const wingFloorDisplay = `
                    ${maint.wing || '-'}
                    ${maint.floor ? `<br><small>Floor: ${maint.floor}</small>` : ''}
                    ${maint.apartment ? `<br><small>Unit: ${maint.apartment}</small>` : ''}
                `;
                
                // Status display for multi-elevator cards
                const statusDisplay = maint.elevatorIds ? 
                    `<span class="badge badge-${actualStatusClass}">${actualStatus}</span>
                     ${maint.completedElevators && maint.completedElevators.length > 0 ? 
                        `<br><small style="color: var(--success);">‚úì ${maint.completedElevators.length}/${maint.elevatorCount} Done</small>` : ''}` :
                    `<span class="badge badge-${actualStatusClass}">${actualStatus}</span>`;
                
                return `
                    <tr data-status="${maint.status}" data-priority="${maint.priority}" data-type="${rciType}" ${maint.isAMCScheduled ? 'style="background: #faf5ff;"' : ''}>
                        <td>
                            <span style="background: ${typeColor}15; color: ${typeColor}; padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 12px;">
                                ${typeIcon} ${rciType}
                            </span>
                        </td>
                        <td>${elevatorDisplay}</td>
                        <td>${locationDisplay}</td>
                        <td>${wingFloorDisplay}</td>
                        <td><small>${maint.issue}</small></td>
                        <td>
                            <strong>${complaintPerson}</strong>
                            ${maint.complaintPersonPhone ? `<br><small style="color: var(--text-secondary);">${maint.complaintPersonPhone}</small>` : ''}
                            ${maint.complaintPersonDesignation ? `<br><small style="color: var(--text-secondary);">${maint.complaintPersonDesignation}</small>` : ''}
                        </td>
                        <td><span class="badge badge-${priorityClass}">${maint.priority}</span></td>
                        <td>${maint.assignedTo}</td>
                        <td>${new Date(maint.dueDate).toLocaleDateString()}</td>
                        <td>
                            ${statusDisplay}
                            ${hasSignatures ? '<br><small style="color: var(--success); font-weight: 600;">üìù Signed</small>' : ''}
                        </td>
                        <td>
                            <div class="action-buttons">
                                ${!maint.isAMCScheduled ? `<button class="btn btn-secondary btn-sm" onclick="editMaintenance('${maint.id}')">Edit</button>` : ''}
                                ${maint.elevatorIds ? 
                                    `<button class="btn btn-success btn-sm" onclick="completeMultiElevatorMaintenance('${maint.id}')">Complete</button>
                                     ${maint.completedElevators && maint.completedElevators.length > 0 ? 
                                        `<button class="btn btn-primary btn-sm" onclick="generateMultiElevatorReports('${maint.id}')">üì• PDF (${maint.completedElevators.length})</button>` : 
                                        ''}` :
                                    (maint.status === 'Completed' && hasSignatures ? 
                                        `<button class="btn btn-primary btn-sm" onclick="exportMaintenanceReport('${maint.id}')">üì• PDF</button>
                                         <button class="btn btn-success btn-sm" onclick="sendMaintenanceEmail('${maint.id}')" title="Send Completion Certificate via Email">üìß Send</button>` : 
                                        '')
                                }
                                ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteMaintenance('${maint.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Update RCI statistics
            updateRCIStats();
            populateRCIFilters();
        }

        function renderAMC() {
            const tbody = document.getElementById('amcList');
            if (!tbody) return;
            
            if (!amc || amc.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">üìÑ</div><p>No AMC contracts found. Click "Add AMC Contract" to get started.</p></td></tr>';
                return;
            }

            tbody.innerHTML = amc.map(contract => {
                const currentDate = new Date();
                const endDate = new Date(contract.endDate);
                const daysUntilExpiry = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
                
                let status = 'Active';
                let statusClass = 'success';
                
                if (daysUntilExpiry < 0) {
                    status = 'Expired';
                    statusClass = 'danger';
                } else if (daysUntilExpiry <= 30) {
                    status = 'Expiring Soon';
                    statusClass = 'warning';
                } else if (contract.status === 'Terminated') {
                    status = 'Terminated';
                    statusClass = 'secondary';
                }

                // Check free maintenance period
                let freeMaintText = 'No';
                if (contract.freeMaintenanceMonths && contract.freeMaintenanceMonths > 0) {
                    const freeEndDate = new Date(contract.freeMaintenanceEndDate);
                    const daysUntilFreeEnd = Math.ceil((freeEndDate - currentDate) / (1000 * 60 * 60 * 24));
                    if (daysUntilFreeEnd > 0) {
                        freeMaintText = `Yes (${daysUntilFreeEnd} days left)`;
                    } else {
                        freeMaintText = 'Expired';
                    }
                }

                // Calculate payment status
                const nextPaymentDue = contract.nextPaymentDue ? new Date(contract.nextPaymentDue) : null;
                let paymentStatus = 'N/A';
                let paymentClass = 'secondary';
                
                if (nextPaymentDue) {
                    const daysUntilPayment = Math.ceil((nextPaymentDue - currentDate) / (1000 * 60 * 60 * 24));
                    if (daysUntilPayment < 0) {
                        paymentStatus = 'Overdue';
                        paymentClass = 'danger';
                    } else if (daysUntilPayment <= 7) {
                        paymentStatus = 'Due Soon';
                        paymentClass = 'warning';
                    } else {
                        paymentStatus = 'Pending';
                        paymentClass = 'info';
                    }
                }

                return `
                    <tr>
                        <td>
                            <strong>${contract.projectName || 'N/A'}</strong>
                            <br><small class="text-muted">${contract.projectId || ''}</small>
                        </td>
                        <td>
                            <div><strong>${contract.contractType}</strong></div>
                            <small class="text-muted">${contract.duration} year(s)</small>
                            <br><small class="text-muted">Rs. ${(contract.amount || 0).toLocaleString()}</small>
                        </td>
                        <td>${contract.startDate ? new Date(contract.startDate).toLocaleDateString() : 'N/A'}</td>
                        <td>
                            ${contract.endDate ? new Date(contract.endDate).toLocaleDateString() : 'N/A'}
                            <br><small class="text-muted">${daysUntilExpiry > 0 ? `${daysUntilExpiry} days` : 'Expired'}</small>
                        </td>
                        <td>
                            <div><span class="badge badge-${paymentClass}">${paymentStatus}</span></div>
                            ${nextPaymentDue ? `<small class="text-muted">Due: ${nextPaymentDue.toLocaleDateString()}</small>` : ''}
                        </td>
                        <td><span class="badge badge-${statusClass}">${status}</span></td>
                        <td>
                            <div style="${freeMaintText.includes('Yes') ? 'color: var(--success); font-weight: 600;' : ''}">${freeMaintText}</div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editAMC('${contract.id}')">Edit</button>
                                <button class="btn btn-primary btn-sm" onclick="managePayments('${contract.id}')">Payments</button>
                                <button class="btn btn-success btn-sm" onclick="sendAMCEmail('${contract.id}')" title="Send AMC PDF via Email">üìß Send</button>
                                ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteAMC('${contract.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderActivities() {
            const tbody = document.getElementById('activityList');
            if (activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="empty-state">No activities recorded</td></tr>';
            } else {
                tbody.innerHTML = activities.map(act => `
                    <tr data-user="${act.user}" data-date="${act.date}">
                        <td>${new Date(act.date).toLocaleString()}</td>
                        <td>${act.action}</td>
                        <td>${act.user}</td>
                    </tr>
                `).join('');
            }
        }

        function renderEmployees() {
            console.log('Rendering employees:', employees.length);
            const tbody = document.getElementById('employeesList');
            if (!tbody) {
                console.error('Employee table body not found!');
                return;
            }
            
            if (!employees || employees.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">üë•</div><p>No employees found. Click "Add Employee" to get started.</p></td></tr>';
                return;
            }

            tbody.innerHTML = employees.map(emp => {
                const statusClass = emp.employeeStatus === 'Active' ? 'success' : 
                                   emp.employeeStatus === 'On Leave' ? 'warning' :
                                   emp.employeeStatus === 'Resigned' ? 'secondary' : 'danger';
                
                const roleClass = emp.systemRole === 'admin' ? 'primary' : 
                                 emp.systemRole === 'sales' ? 'success' :
                                 emp.systemRole === 'technician' ? 'warning' :
                                 emp.systemRole === 'reception' ? 'info' : 'secondary';

                const joiningDate = emp.joiningDate ? new Date(emp.joiningDate) : null;
                const serviceYears = joiningDate ? ((new Date() - joiningDate) / (1000 * 60 * 60 * 24 * 365)).toFixed(1) : '0';
                
                const lastWorkingDate = emp.lastWorkingDate ? new Date(emp.lastWorkingDate).toLocaleDateString() : '';
                const accessStatus = emp.systemStatus === 'active' ? 'success' : 'secondary';
                
                return `
                    <tr>
                        <td>
                            <div><strong>${emp.firstName} ${emp.lastName}</strong></div>
                            <small class="text-muted">ID: ${emp.employeeId}</small>
                        </td>
                        <td>
                            <div>${emp.email}</div>
                            <small class="text-muted">${emp.phone}</small>
                        </td>
                        <td>
                            <div><strong>${emp.position}</strong></div>
                            <small class="text-muted">${emp.department}</small>
                        </td>
                        <td>
                            <div><strong>Rs. ${(emp.currentSalary || 0).toLocaleString()}</strong>/month</div>
                            ${emp.lastSalary ? `<small class="text-muted">Previous: Rs. ${emp.lastSalary.toLocaleString()}</small>` : ''}
                        </td>
                        <td>
                            <div>Joined: ${joiningDate ? joiningDate.toLocaleDateString() : 'N/A'}</div>
                            <small class="text-muted">${serviceYears} years of service</small>
                            ${lastWorkingDate ? `<br><small class="text-danger">Last Date: ${lastWorkingDate}</small>` : ''}
                        </td>
                        <td><span class="badge badge-${statusClass}">${emp.employeeStatus || 'Active'}</span></td>
                        <td>
                            <div>User: <strong>${emp.username}</strong></div>
                            <span class="badge badge-${roleClass}">${(emp.systemRole || 'user').toUpperCase()}</span>
                            <span class="badge badge-${accessStatus} ml-1">${(emp.systemStatus || 'active').toUpperCase()}</span>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editEmployee('${emp.id}')">Edit</button>
                                <button class="btn btn-primary btn-sm" onclick="exportIndividualHRReport('${emp.id}')">üì• Report</button>
                                ${currentUser.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteEmployee('${emp.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function populateCategoryFilters() {
            ['warehouse', 'office', 'service-van'].forEach(location => {
                // Handle service-van special case for element IDs
                const locationId = location === 'service-van' ? 'ServiceVan' : location.charAt(0).toUpperCase() + location.slice(1);
                const select = document.getElementById(`categoryFilter${locationId}`);
                if (select) {
                    const categories = [...new Set(inventory[location].map(i => i.category))].sort();
                    select.innerHTML = '<option value="">All Categories</option>' + 
                        categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');
                }
            });
        }

        function populateActivityUserFilter() {
            const select = document.getElementById('activityUserFilter');
            const users = [...new Set(activities.map(a => a.user))].sort();
            select.innerHTML = '<option value="">All Users</option>' + 
                users.map(user => `<option value="${user}">${user}</option>`).join('');
        }

        window.removeInvoiceItem = (button) => {
            button.closest('.invoice-item').remove();
            calculateInvoiceTotal();
        };

        window.addInvoiceItem = () => {
            const itemsList = document.getElementById('invoiceItemsList');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'invoice-item';
            itemDiv.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1fr 60px; gap: 10px; margin-bottom: 10px; align-items: center;';
            
            itemDiv.innerHTML = `
                <input type="text" class="form-control" placeholder="Item Description" required>
                <input type="number" class="form-control" placeholder="Quantity" min="1" value="1" required oninput="calculateInvoiceTotal()">
                <input type="number" class="form-control" placeholder="Rate (‚Çπ)" min="0" step="0.01" required oninput="calculateInvoiceTotal()">
                <input type="number" class="form-control item-amount" placeholder="Amount" readonly>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(this)">√ó</button>
            `;
            
            itemsList.appendChild(itemDiv);
            calculateInvoiceTotal();
        };

        function clearInvoiceItems() {
            document.getElementById('invoiceItemsList').innerHTML = '';
        }

        window.calculateInvoiceTotal = () => {
            const items = document.querySelectorAll('#invoiceItemsList .invoice-item');
            let subtotal = 0;

            items.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const qty = parseFloat(inputs[1].value) || 0;
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = qty * rate;
                
                inputs[4].value = amount.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                subtotal += amount;
            });

            const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
            const gstPercent = parseFloat(document.getElementById('gstPercent').value) || 0;

            const discountAmount = (subtotal * discountPercent) / 100;
            const afterDiscount = subtotal - discountAmount;
            const gstAmount = (afterDiscount * gstPercent) / 100;
            const total = afterDiscount + gstAmount;

            document.getElementById('subtotalDisplay').textContent = `Rs. ${subtotal.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            document.getElementById('totalAmountDisplay').textContent = `Rs. ${total.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        };

        // Advance Payment Functions
        window.toggleAdvanceSection = () => {
            const paymentTerms = document.getElementById('paymentTerms').value;
            const advanceSection = document.getElementById('advancePaymentSection');
            const installmentsSection = document.getElementById('installmentsSection');
            
            // Hide all sections first
            advanceSection.style.display = 'none';
            installmentsSection.style.display = 'none';
            
            if (paymentTerms === 'advance') {
                advanceSection.style.display = 'block';
                updatePaymentSummary();
            } else if (paymentTerms === 'installments') {
                installmentsSection.style.display = 'block';
                updateInstallmentSummary();
            }
        };

        window.calculateAdvancePercentage = () => {
            const totalAmount = getTotalAmount();
            const advanceAmount = parseFloat(document.getElementById('advanceAmount').value) || 0;
            
            if (totalAmount > 0) {
                const percentage = (advanceAmount / totalAmount) * 100;
                document.getElementById('advancePercentage').value = percentage.toFixed(2);
            }
            updatePaymentSummary();
        };

        window.calculateAdvanceAmount = () => {
            const totalAmount = getTotalAmount();
            const advancePercentage = parseFloat(document.getElementById('advancePercentage').value) || 0;
            
            if (totalAmount > 0) {
                const advanceAmount = (totalAmount * advancePercentage) / 100;
                document.getElementById('advanceAmount').value = advanceAmount.toFixed(2);
            }
            updatePaymentSummary();
        };

        function getTotalAmount() {
            const totalDisplay = document.getElementById('totalAmountDisplay').textContent;
            const amount = totalDisplay.replace('Rs. ', '').replace(/,/g, '');
            return parseFloat(amount) || 0;
        }

        function updatePaymentSummary() {
            const totalAmount = getTotalAmount();
            const advanceAmount = parseFloat(document.getElementById('advanceAmount').value) || 0;
            const balanceAmount = totalAmount - advanceAmount;
            const balancePercentage = totalAmount > 0 ? ((balanceAmount / totalAmount) * 100) : 0;

            document.getElementById('paymentTotalAmount').textContent = `Rs. ${totalAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            document.getElementById('paymentAdvanceAmount').textContent = `Rs. ${advanceAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            document.getElementById('paymentBalanceAmount').textContent = `Rs. ${balanceAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            document.getElementById('paymentBalancePercent').textContent = `${balancePercentage.toFixed(1)}%`;
        }

        window.addInstallment = () => {
            const installmentsList = document.getElementById('installmentsList');
            const installmentIndex = installmentsList.children.length + 1;
            
            const installmentDiv = document.createElement('div');
            installmentDiv.className = 'installment-item';
            installmentDiv.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; align-items: center; padding: 8px; background: white; border-radius: 4px; border: 1px solid #fed7aa;';
            
            installmentDiv.innerHTML = `
                <input type="number" class="form-control" placeholder="Amount (Rs. )" min="0" step="0.01" onchange="updateInstallmentSummary()" required>
                <input type="number" class="form-control" placeholder="Percentage (%)" min="0" max="100" step="0.01" onchange="calculateInstallmentFromPercentage(this)" required>
                <input type="date" class="form-control" required>
                <select class="form-control" required>
                    <option value="">Payment Method</option>
                    <option value="cash">Cash</option>
                    <option value="cheque">Cheque</option>
                    <option value="bank_transfer">Bank Transfer</option>
                    <option value="upi">UPI</option>
                    <option value="card">Card</option>
                    <option value="online">Online</option>
                </select>
                <button type="button" class="btn btn-danger btn-sm" onclick="removeInstallment(this)" style="padding: 4px 8px;">√ó</button>
            `;
            
            installmentsList.appendChild(installmentDiv);
            updateInstallmentSummary();
        };

        window.calculateInstallmentFromPercentage = (percentageInput) => {
            const row = percentageInput.closest('.installment-item');
            const amountInput = row.querySelector('input[type="number"]');
            const percentage = parseFloat(percentageInput.value) || 0;
            const totalAmount = getTotalAmount();
            
            if (totalAmount > 0) {
                const amount = (totalAmount * percentage) / 100;
                amountInput.value = amount.toFixed(2);
            }
            updateInstallmentSummary();
        };

        window.removeInstallment = (button) => {
            button.closest('.installment-item').remove();
            updateInstallmentSummary();
        };

        function updateInstallmentSummary() {
            const totalAmount = getTotalAmount();
            const installmentItems = document.querySelectorAll('.installment-item');
            let plannedAmount = 0;
            
            installmentItems.forEach(item => {
                const amountInput = item.querySelector('input[type="number"]');
                plannedAmount += parseFloat(amountInput.value) || 0;
            });
            
            const remainingAmount = totalAmount - plannedAmount;
            
            document.getElementById('installmentTotalAmount').textContent = `Rs. ${totalAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            document.getElementById('installmentPlannedAmount').textContent = `Rs. ${plannedAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            document.getElementById('installmentRemainingAmount').textContent = `Rs. ${remainingAmount.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
            
            // Update color based on remaining amount
            const remainingElement = document.getElementById('installmentRemainingAmount');
            if (remainingAmount < 0) {
                remainingElement.style.color = '#dc2626';
            } else if (remainingAmount === 0) {
                remainingElement.style.color = '#059669';
            } else {
                remainingElement.style.color = '#ea580c';
            }
        }

        // Override calculateInvoiceTotal to update payment summaries
        const originalCalculateInvoiceTotal = window.calculateInvoiceTotal;
        window.calculateInvoiceTotal = () => {
            originalCalculateInvoiceTotal();
            
            // Update payment summaries if sections are visible
            if (document.getElementById('advancePaymentSection').style.display === 'block') {
                updatePaymentSummary();
            }
            if (document.getElementById('installmentsSection').style.display === 'block') {
                updateInstallmentSummary();
            }
        };

        window.filterInvoices = () => {
            const searchValue = document.getElementById('searchInvoices').value.toLowerCase();
            const statusValue = document.getElementById('invoiceStatusFilter').value;
            const typeValue = document.getElementById('invoiceTypeFilter').value;
            
            const rows = document.querySelectorAll('#invoicesList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const status = row.dataset.status || '';
                const type = row.dataset.type || '';
                
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusValue || status === statusValue;
                const matchesType = !typeValue || type === typeValue;
                
                row.style.display = (matchesSearch && matchesStatus && matchesType) ? '' : 'none';
            });
        };

        window.editInvoice = (invoiceId) => {
            const invoice = invoices.find(inv => inv.id === invoiceId);
            if (!invoice) return;

            document.getElementById('invoiceModalTitle').textContent = `Edit ${invoice.type === 'quotation' ? 'Quotation' : 'Invoice'}`;
            document.getElementById('editInvoiceId').value = invoice.id;
            document.getElementById('invoiceType').value = invoice.type;
            
            // Fill form fields
            document.getElementById('clientName').value = invoice.clientName;
            document.getElementById('clientEmail').value = invoice.clientEmail || '';
            document.getElementById('clientPhone').value = invoice.clientPhone || '';
            document.getElementById('clientGST').value = invoice.clientGST || '';
            document.getElementById('clientAddress').value = invoice.clientAddress || '';
            
            document.getElementById('invoiceNumber').value = invoice.invoiceNumber;
            document.getElementById('invoiceDate').value = invoice.invoiceDate;
            document.getElementById('dueDate').value = invoice.dueDate || '';
            document.getElementById('poNumber').value = invoice.poNumber || '';
            
            document.getElementById('discountPercent').value = invoice.discountPercent || 0;
            document.getElementById('gstPercent').value = invoice.gstPercent || 18;
            document.getElementById('invoiceNotes').value = invoice.notes || '';

            // Fill items
            clearInvoiceItems();
            invoice.items.forEach(item => {
                addInvoiceItem();
                const lastItem = document.querySelector('#invoiceItemsList .invoice-item:last-child');
                const inputs = lastItem.querySelectorAll('input');
                inputs[0].value = item.description;
                inputs[1].value = item.quantity;
                inputs[2].value = item.unit;
                inputs[3].value = item.rate;
            });

            calculateInvoiceTotal();

            // Populate payment information if exists
            if (invoice.paymentTerms) {
                document.getElementById('paymentTerms').value = invoice.paymentTerms;
                toggleAdvanceSection();
                
                if (invoice.paymentTerms === 'advance' && invoice.advancePayment) {
                    document.getElementById('advanceAmount').value = invoice.advancePayment.amount || '';
                    document.getElementById('advancePercentage').value = invoice.advancePayment.percentage || '';
                    document.getElementById('advanceDate').value = invoice.advancePayment.date || '';
                    document.getElementById('advanceMethod').value = invoice.advancePayment.method || '';
                    document.getElementById('advanceReference').value = invoice.advancePayment.reference || '';
                    document.getElementById('balanceDueDate').value = invoice.advancePayment.balanceDueDate || '';
                    document.getElementById('advanceNotes').value = invoice.advancePayment.notes || '';
                    
                    setTimeout(() => updatePaymentSummary(), 100);
                }
                
                if (invoice.paymentTerms === 'installments' && invoice.installments) {
                    // Clear existing installments
                    document.getElementById('installmentsList').innerHTML = '';
                    
                    // Add each installment
                    invoice.installments.forEach(installment => {
                        addInstallment();
                        const lastInstallment = document.querySelector('.installment-item:last-child');
                        const inputs = lastInstallment.querySelectorAll('input, select');
                        inputs[0].value = installment.amount;
                        inputs[1].value = installment.percentage;
                        inputs[2].value = installment.dueDate;
                        inputs[3].value = installment.paymentMethod;
                    });
                    
                    setTimeout(() => updateInstallmentSummary(), 100);
                }
            }
            
            // Set invoice status
            if (invoice.status) {
                document.getElementById('invoiceStatus').value = invoice.status;
            }

            document.getElementById('invoiceModal').classList.add('active');
        };

        window.deleteInvoice = async (invoiceId) => {
            if (confirm('Are you sure you want to delete this invoice?')) {
                try {
                    await deleteDoc(doc(db, 'invoices', invoiceId));
                    await addDoc(collection(db, 'activities'), {
                        action: `Deleted invoice`,
                        user: currentUser.fullName || currentUser.username,
                        date: new Date().toISOString()
                    });
                    loadInvoices();
                } catch (error) {
                    alert('Error deleting invoice: ' + error.message);
                }
            }
        };

        window.downloadInvoicePDF = async (invoiceId) => {
            try {
                // Ensure jsPDF is available (loads dynamically if required)
                try {
                    await ensureJsPDF();
                } catch (e) {
                    alert('PDF library not loaded. Please refresh the page.');
                    return;
                }

                const invoice = invoices.find(inv => inv.id === invoiceId);
                if (!invoice) {
                    alert('Invoice not found.');
                    return;
                }

                // Validate invoice has required data
                if (!invoice.items || invoice.items.length === 0) {
                    alert('Invoice has no items. Cannot generate PDF.');
                    return;
                }

                await generateInvoicePDF(invoice);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF: ' + error.message);
            }
        };

        window.showAddInventoryModal = (location) => {
            document.getElementById('inventoryModalTitle').textContent = `Add ${location.charAt(0).toUpperCase() + location.slice(1)} Item`;
            document.getElementById('inventoryForm').reset();
            document.getElementById('editItemId').value = '';
            document.getElementById('itemLocation').value = location;
            
            const categorySelect = document.getElementById('itemCategory');
            categorySelect.innerHTML = '<option value="">Select Category</option>' + 
                CATEGORIES[location].map(cat => `<option value="${cat}">${cat}</option>`).join('');
            
            document.getElementById('inventoryModal').classList.add('active');
        };

        window.editInventory = (id) => {
            const allItems = getAllItems();
            const item = allItems.find(i => i.id === id);
            
            document.getElementById('inventoryModalTitle').textContent = 'Edit Inventory Item';
            document.getElementById('editItemId').value = item.id;
            document.getElementById('itemLocation').value = item.location;
            document.getElementById('itemName').value = item.name;
            document.getElementById('itemBarcode').value = item.barcode || '';
            
            const categorySelect = document.getElementById('itemCategory');
            categorySelect.innerHTML = '<option value="">Select Category</option>' + 
                CATEGORIES[item.location].map(cat => `<option value="${cat}">${cat}</option>`).join('');
            categorySelect.value = item.category;
            
            document.getElementById('itemQuantity').value = item.quantity;
            document.getElementById('itemUnit').value = item.unit;
            document.getElementById('itemDescription').value = item.description || '';
            document.getElementById('inventoryModal').classList.add('active');
        };

        window.deleteInventory = async (id) => {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            const allItems = getAllItems();
            const item = allItems.find(i => i.id === id);
            
            if (isOnline) {
                await deleteDoc(doc(db, 'inventory', id));
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Deleted ${item.location} inventory: ${item.name}`,
                    user: currentUser.username
                });
            }
            
            await loadData();
        };

        document.getElementById('inventoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editItemId').value;
            const location = document.getElementById('itemLocation').value;
            const itemData = {
                name: document.getElementById('itemName').value,
                barcode: document.getElementById('itemBarcode').value,
                category: document.getElementById('itemCategory').value,
                quantity: parseInt(document.getElementById('itemQuantity').value),
                unit: document.getElementById('itemUnit').value,
                description: document.getElementById('itemDescription').value,
                location: location
            };

            try {
                if (isOnline) {
                    if (id) {
                        await updateDoc(doc(db, 'inventory', id), itemData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Updated ${location} inventory: ${itemData.name}`,
                            user: currentUser.username
                        });
                    } else {
                        await addDoc(collection(db, 'inventory'), itemData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Added ${location} inventory: ${itemData.name}`,
                            user: currentUser.username
                        });
                    }
                }

                closeModal('inventoryModal');
                await loadData();
            } catch (error) {
                alert('Error saving inventory: ' + error.message);
            }
        });

        window.showAddStockModal = (id) => {
            const allItems = getAllItems();
            const item = allItems.find(i => i.id === id);
            document.getElementById('addStockItemId').value = item.id;
            document.getElementById('addStockItemName').textContent = item.name;
            document.getElementById('addStockCurrent').textContent = `${item.quantity} ${item.unit}`;
            document.getElementById('addStockForm').reset();
            document.getElementById('addStockModal').classList.add('active');
        };

        document.getElementById('addStockForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = document.getElementById('addStockItemId').value;
            const quantity = parseInt(document.getElementById('addStockQuantity').value);
            const notes = document.getElementById('addStockNotes').value;

            const allItems = getAllItems();
            const item = allItems.find(i => i.id === itemId);
            const newQuantity = item.quantity + quantity;

            if (isOnline) {
                await updateDoc(doc(db, 'inventory', itemId), { quantity: newQuantity });
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Added ${quantity} ${item.unit} to ${item.name} (${item.location})${notes ? ' - ' + notes : ''}`,
                    user: currentUser.username
                });
            }

            closeModal('addStockModal');
            await loadData();
        });

        window.showUseModal = (id) => {
            const allItems = getAllItems();
            const item = allItems.find(i => i.id === id);
            document.getElementById('useItemId').value = item.id;
            document.getElementById('useItemName').textContent = item.name;
            document.getElementById('useAvailable').textContent = `${item.quantity} ${item.unit}`;
            document.getElementById('useQuantity').max = item.quantity;
            
            const projectSelect = document.getElementById('useProject');
            projectSelect.innerHTML = '<option value="">Select Project</option>' + 
                projects.filter(p => p.status === 'Active').map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
            
            document.getElementById('useForm').reset();
            document.getElementById('useModal').classList.add('active');
        };

        document.getElementById('useForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const itemId = document.getElementById('useItemId').value;
            const quantity = parseInt(document.getElementById('useQuantity').value);
            const projectId = document.getElementById('useProject').value;
            const notes = document.getElementById('useNotes').value;

            const allItems = getAllItems();
            const item = allItems.find(i => i.id === itemId);
            const project = projects.find(p => p.id === projectId);

            if (quantity > item.quantity) {
                alert('Not enough stock available!');
                return;
            }

            const newQuantity = item.quantity - quantity;
            const projectItems = project.items || [];
            const existingItem = projectItems.find(pi => pi.itemId === itemId);

            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                projectItems.push({
                    itemId: item.id,
                    name: item.name,
                    quantity: quantity,
                    unit: item.unit,
                    location: item.location
                });
            }

            if (isOnline) {
                await updateDoc(doc(db, 'inventory', itemId), { quantity: newQuantity });
                await updateDoc(doc(db, 'projects', projectId), { items: projectItems });
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Used ${quantity} ${item.unit} of ${item.name} (${item.location}) for ${project.name}${notes ? ' - ' + notes : ''}`,
                    user: currentUser.username
                });
            }

            closeModal('useModal');
            await loadData();
        });

        window.showAddProjectModal = () => {
            document.getElementById('projectModalTitle').textContent = 'Create New Project';
            document.getElementById('projectForm').reset();
            document.getElementById('editProjectId').value = '';
            document.getElementById('projectItemsSection').style.display = 'none';
            document.getElementById('projectSubmitBtn').textContent = 'Create Project';
            
            // Initialize empty sub-apartments
            currentSubApartments = [];
            renderSubApartments();
            
            // Initialize empty wings with one default wing
            currentWings = [];
            document.getElementById('projectWingsCount').value = 1;
            generateWingsFields();
            
            // Initialize client contacts with one empty contact
            projectContacts = [];
            addClientContact();
            
            // Initialize lifts with one lift
            document.getElementById('projectLiftsCount').value = 1;
            generateLiftFields();
            
            document.getElementById('projectModal').classList.add('active');
        };

        window.editProject = (id) => {
            const project = projects.find(p => p.id === id);
            if (!project) {
                alert('Project not found');
                return;
            }
            
            document.getElementById('projectModalTitle').textContent = 'Edit Project';
            document.getElementById('editProjectId').value = project.id;
            document.getElementById('projectName').value = project.name;
            document.getElementById('projectCode').value = project.code;
            document.getElementById('projectClient').value = project.client || '';
            
            // Populate client information fields
            document.getElementById('clientName').value = project.clientName || project.client || '';
            document.getElementById('clientEmail').value = project.clientEmail || '';
            document.getElementById('clientPhone').value = project.clientPhone || '';
            document.getElementById('clientGST').value = project.clientGST || '';
            
            document.getElementById('projectType').value = project.type || '';
            document.getElementById('projectAddress').value = project.address || '';
            document.getElementById('projectMapsLink').value = project.mapsLink || '';
            
            // Load geofence data
            document.getElementById('siteLat').value = project.site_lat || '';
            document.getElementById('siteLng').value = project.site_lng || '';
            document.getElementById('siteRadius').value = project.site_radius_meters || 100;
            
            // Load sub-apartments
            currentSubApartments = project.subApartments || [];
            renderSubApartments();
            
            // Load wings
            currentWings = project.wings || [];
            if (currentWings.length > 0) {
                document.getElementById('projectWingsCount').value = currentWings.length;
                generateWingsFields();
                // Give time for fields to render, then populate values
                setTimeout(() => {
                    currentWings.forEach((wing, index) => {
                        const wingNameInput = document.getElementById(`wingName_${index}`);
                        const wingElevatorsInput = document.getElementById(`wingElevators_${index}`);
                        
                        if (wingNameInput) wingNameInput.value = wing.wingName || '';
                        if (wingElevatorsInput) {
                            // Support both old 'elevatorNumbers' and new 'elevators' field
                            const elevators = wing.elevators || wing.elevatorNumbers || [];
                            wingElevatorsInput.value = elevators.length || 1;
                            generateElevatorNumbersForWing(index);
                            
                            // Populate elevator numbers
                            setTimeout(() => {
                                if (elevators.length > 0) {
                                    elevators.forEach((elevNum, elevIndex) => {
                                        const elevInput = document.getElementById(`wing_${index}_elev_${elevIndex}`);
                                        if (elevInput) elevInput.value = elevNum;
                                    });
                                }
                            }, 100);
                        }
                    });
                }, 200);
            } else {
                // Default to 1 wing
                document.getElementById('projectWingsCount').value = 1;
                generateWingsFields();
            }
            
            document.getElementById('projectStartDate').value = project.startDate || '';
            document.getElementById('projectEndDate').value = project.endDate || '';
            document.getElementById('projectStatus').value = project.status;
            document.getElementById('projectProgress').value = project.progress || 0;
            document.getElementById('projectSubmitBtn').textContent = 'Update Project';
            
            const items = project.items || [];
            if (items.length > 0) {
                document.getElementById('projectItemsSection').style.display = 'block';
                document.getElementById('projectItemsList').innerHTML = items.map(item => 
                    `<p>‚Ä¢ ${item.name}: ${item.quantity} ${item.unit} (${item.location})</p>`
                ).join('');
                
                document.getElementById('returnItemsList').innerHTML = items.map(item => `
                    <div style="margin-bottom: 12px; padding: 8px; background: var(--bg-light); border-radius: 4px;">
                        <label style="display: flex; align-items: center; gap: 8px;">
                            <input type="checkbox" id="return_${item.itemId}" onchange="toggleReturnQuantity('${item.itemId}')">
                            <strong>${item.name}</strong> - Currently allocated: ${item.quantity} ${item.unit}
                        </label>
                        <div id="returnQty_${item.itemId}" style="display: none; margin-top: 8px; margin-left: 24px;">
                            <label style="font-size: 13px;">Quantity to return:</label>
                            <input type="number" class="form-control" id="returnAmount_${item.itemId}" min="0" max="${item.quantity}" value="${item.quantity}" style="margin-top: 4px;">
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('projectItemsSection').style.display = 'none';
            }

            // Populate hold information if exists
            if (project.holdInformation) {
                document.getElementById('projectHoldReason').value = project.holdInformation.reason || '';
                document.getElementById('projectHoldDate').value = project.holdInformation.holdDate || '';
                document.getElementById('projectExpectedResumeDate').value = project.holdInformation.expectedResumeDate || '';
                document.getElementById('projectHoldDuration').value = project.holdInformation.duration || '';
                document.getElementById('projectHoldNotes').value = project.holdInformation.notes || '';
            }

            // Load client contacts
            if (project.clientContacts && project.clientContacts.length > 0) {
                projectContacts = project.clientContacts;
            } else {
                // Create from old format if exists
                projectContacts = [{
                    id: Date.now(),
                    name: project.clientName || project.client || '',
                    phone: project.clientPhone || '',
                    email: project.clientEmail || '',
                    designation: 'Primary Contact'
                }];
            }
            renderClientContacts();

            // Load lifts
            if (project.lifts && project.lifts.length > 0) {
                projectLifts = project.lifts;
                document.getElementById('projectLiftsCount').value = project.lifts.length;
            } else {
                // Default to empty
                projectLifts = [];
                document.getElementById('projectLiftsCount').value = 1;
            }
            generateLiftFields();
            setTimeout(() => {
                if (project.lifts && project.lifts.length > 0) {
                    project.lifts.forEach((lift, index) => {
                        const liftNumberInput = document.getElementById(`liftNumber_${index}`);
                        const liftTypeInput = document.getElementById(`liftType_${index}`);
                        const liftCapacityInput = document.getElementById(`liftCapacity_${index}`);
                        const liftFloorsInput = document.getElementById(`liftFloors_${index}`);
                        const liftLocationInput = document.getElementById(`liftLocation_${index}`);
                        
                        if (liftNumberInput) liftNumberInput.value = lift.number || '';
                        if (liftTypeInput) liftTypeInput.value = lift.type || '';
                        if (liftCapacityInput) liftCapacityInput.value = lift.capacity || '';
                        if (liftFloorsInput) liftFloorsInput.value = lift.floors || '';
                        if (liftLocationInput) liftLocationInput.value = lift.location || '';
                    });
                }
            }, 200);

            // Toggle hold fields visibility
            setTimeout(() => {
                toggleHoldFields('project');
            }, 100);
            
            document.getElementById('projectModal').classList.add('active');
        };

        window.toggleReturnQuantity = (itemId) => {
            const checkbox = document.getElementById(`return_${itemId}`);
            const qtyDiv = document.getElementById(`returnQty_${itemId}`);
            qtyDiv.style.display = checkbox.checked ? 'block' : 'none';
        };

        // Function to collect wings data from the form
        window.collectWingsData = () => {
            currentWings = [];
            const wingNameInputs = document.querySelectorAll('.wing-name');
            const wingElevatorInputs = document.querySelectorAll('.wing-elevators');
            
            console.log('üîç Collecting wings data...');
            console.log('Found wing name inputs:', wingNameInputs.length);
            
            wingNameInputs.forEach((nameInput, index) => {
                const wingName = nameInput.value.trim();
                const elevatorCount = parseInt(wingElevatorInputs[index].value) || 0;
                
                console.log(`Wing ${index}: "${wingName}", Elevators: ${elevatorCount}`);
                
                // Collect elevator numbers for this wing
                const elevatorNumbers = [];
                const elevatorNumbersContainer = document.getElementById(`elevatorNumbers_${index}`);
                if (elevatorNumbersContainer) {
                    const elevatorInputs = elevatorNumbersContainer.querySelectorAll('.elevator-number');
                    elevatorInputs.forEach(input => {
                        const elevNum = input.value.trim();
                        if (elevNum) {
                            elevatorNumbers.push(elevNum);
                        }
                    });
                }
                
                console.log(`  Elevator numbers collected:`, elevatorNumbers);
                
                if (wingName && elevatorNumbers.length > 0) {
                    currentWings.push({
                        wingName: wingName,
                        elevatorCount: elevatorCount,
                        elevators: elevatorNumbers  // Changed from elevatorNumbers to elevators
                    });
                }
            });
            
            console.log('‚úÖ Final currentWings array:', currentWings);
            return currentWings;
        };

        document.getElementById('projectForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const projectId = document.getElementById('editProjectId').value;
            
            // Collect wings data from form
            collectWingsData();
            
            // Validate contacts
            if (projectContacts.length === 0 || !projectContacts[0].name || !projectContacts[0].phone) {
                alert('‚ö†Ô∏è Please add at least one client contact with name and phone number');
                return;
            }
            
            // Validate lifts
            if (projectLifts.length === 0) {
                alert('‚ö†Ô∏è Please configure at least one lift');
                return;
            }
            
            // Validate wings
            if (currentWings.length === 0) {
                alert('‚ö†Ô∏è Please configure at least one wing/block with elevators');
                return;
            }
            
            const projectData = {
                name: document.getElementById('projectName').value,
                code: document.getElementById('projectCode').value,
                client: document.getElementById('projectClient').value,
                type: document.getElementById('projectType').value,
                address: document.getElementById('projectAddress').value,
                mapsLink: document.getElementById('projectMapsLink').value,
                subApartments: currentSubApartments,
                wings: currentWings,
                clientContacts: projectContacts,
                // Add basic client fields for BOM compatibility
                clientName: projectContacts[0]?.name || document.getElementById('projectClient').value,
                clientPhone: projectContacts[0]?.phone || '',
                clientEmail: projectContacts[0]?.email || '',
                lifts: projectLifts,
                totalLifts: projectLifts.length,
                startDate: document.getElementById('projectStartDate').value,
                endDate: document.getElementById('projectEndDate').value,
                status: document.getElementById('projectStatus').value,
                progress: document.getElementById('projectProgress').value || 0,
                // Site Geofence Data
                site_lat: document.getElementById('siteLat').value ? parseFloat(document.getElementById('siteLat').value) : null,
                site_lng: document.getElementById('siteLng').value ? parseFloat(document.getElementById('siteLng').value) : null,
                site_radius_meters: document.getElementById('siteRadius').value ? parseInt(document.getElementById('siteRadius').value) : 100
            };
            
            console.log('üíæ Saving project with data:', projectData);
            console.log('   Wings in projectData:', projectData.wings);

            // Add hold information if status is "On Hold"
            if (projectData.status === 'On Hold') {
                projectData.holdInformation = {
                    reason: document.getElementById('projectHoldReason').value,
                    holdDate: document.getElementById('projectHoldDate').value,
                    expectedResumeDate: document.getElementById('projectExpectedResumeDate').value,
                    duration: document.getElementById('projectHoldDuration').value,
                    notes: document.getElementById('projectHoldNotes').value,
                    heldBy: currentUser.username,
                    heldAt: new Date().toISOString()
                };
            }

            if (isOnline) {
                if (projectId) {
                    const project = projects.find(p => p.id === projectId);
                    const items = project.items || [];
                    
                    for (const item of items) {
                        const returnCheckbox = document.getElementById(`return_${item.itemId}`);
                        if (returnCheckbox && returnCheckbox.checked) {
                            const returnAmount = parseInt(document.getElementById(`returnAmount_${item.itemId}`).value);
                            if (returnAmount > 0) {
                                const inventoryItem = getAllItems().find(i => i.id === item.itemId);
                                if (inventoryItem) {
                                    await updateDoc(doc(db, 'inventory', item.itemId), {
                                        quantity: inventoryItem.quantity + returnAmount
                                    });
                                    
                                    item.quantity -= returnAmount;
                                    
                                    await addDoc(collection(db, 'activities'), {
                                        date: new Date().toISOString(),
                                        action: `Returned ${returnAmount} ${item.unit} of ${item.name} from project ${project.name} to ${inventoryItem.location}`,
                                        user: currentUser.username
                                    });
                                }
                            }
                        }
                    }
                    
                    projectData.items = items.filter(item => item.quantity > 0);
                    
                    await updateDoc(doc(db, 'projects', projectId), projectData);
                    await addDoc(collection(db, 'activities'), {
                        date: new Date().toISOString(),
                        action: `Updated project: ${projectData.name} (${projectData.totalLifts} lifts)`,
                        user: currentUser.username
                    });
                } else {
                    projectData.items = [];
                    await addDoc(collection(db, 'projects'), projectData);
                    await addDoc(collection(db, 'activities'), {
                        date: new Date().toISOString(),
                        action: `Created project: ${projectData.name} (${projectData.totalLifts} lifts)`,
                        user: currentUser.username
                    });
                }
            }

            closeModal('projectModal');
            await loadData();
            alert(`‚úÖ Project ${projectId ? 'updated' : 'created'} successfully!\n\nüìç Lifts configured: ${projectData.totalLifts}\nüë• Contacts added: ${projectContacts.length}`);
        });

        window.deleteProject = async (id) => {
            if (!confirm('Are you sure you want to delete this project? Items will be returned to inventory.')) return;
            
            const project = projects.find(p => p.id === id);
            const items = project.items || [];

            for (const projItem of items) {
                const invItem = getAllItems().find(i => i.id === projItem.itemId);
                if (invItem && isOnline) {
                    await updateDoc(doc(db, 'inventory', projItem.itemId), {
                        quantity: invItem.quantity + projItem.quantity
                    });
                }
            }

            if (isOnline) {
                await deleteDoc(doc(db, 'projects', id));
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Deleted project: ${project.name}`,
                    user: currentUser.username
                });
            }

            await loadData();
        };

        // Store sub-apartments and wings data
        let currentSubApartments = [];
        let currentWings = [];

        // Function to add sub-apartment
        window.addSubApartment = () => {
            const input = document.getElementById('subApartmentInput');
            const apartmentName = input.value.trim();
            
            if (apartmentName && !currentSubApartments.includes(apartmentName)) {
                currentSubApartments.push(apartmentName);
                renderSubApartments();
                input.value = '';
            }
        };

        // Function to render sub-apartments
        function renderSubApartments() {
            const listDiv = document.getElementById('subApartmentsList');
            listDiv.innerHTML = currentSubApartments.map((apt, index) => `
                <div style="background: #e0f2fe; padding: 6px 12px; border-radius: 6px; display: flex; align-items: center; gap: 8px;">
                    <span>${apt}</span>
                    <button type="button" onclick="removeSubApartment(${index})" style="background: none; border: none; color: #dc2626; cursor: pointer; font-size: 18px; padding: 0; line-height: 1;">&times;</button>
                </div>
            `).join('');
        }

        // Function to remove sub-apartment
        window.removeSubApartment = (index) => {
            currentSubApartments.splice(index, 1);
            renderSubApartments();
        };

        // CLIENT CONTACTS MANAGEMENT
        let projectContacts = [];

        window.addClientContact = () => {
            const contactId = Date.now();
            projectContacts.push({
                id: contactId,
                name: '',
                designation: '',
                phone: '',
                email: ''
            });
            renderClientContacts();
        };

        function renderClientContacts() {
            const container = document.getElementById('clientContactsList');
            if (projectContacts.length === 0) {
                // Add first contact automatically
                addClientContact();
                return;
            }
            
            container.innerHTML = projectContacts.map((contact, index) => `
                <div class="card" style="background: white; border: 1px solid #e5e7eb; margin-bottom: 12px; padding: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h5 style="margin: 0; color: #374151; font-size: 14px;">Contact Person ${index + 1}</h5>
                        ${projectContacts.length > 1 ? `<button type="button" onclick="removeClientContact(${contact.id})" class="btn btn-danger btn-sm">Remove</button>` : ''}
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" class="form-control" data-contact-id="${contact.id}" data-field="name" value="${contact.name}" placeholder="Full name" required onchange="updateContactData(${contact.id}, 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Designation</label>
                            <input type="text" class="form-control" data-contact-id="${contact.id}" data-field="designation" value="${contact.designation}" placeholder="e.g., Project Manager, Owner" onchange="updateContactData(${contact.id}, 'designation', this.value)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Phone Number *</label>
                            <input type="tel" class="form-control" data-contact-id="${contact.id}" data-field="phone" value="${contact.phone}" placeholder="Contact number" required onchange="updateContactData(${contact.id}, 'phone', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" class="form-control" data-contact-id="${contact.id}" data-field="email" value="${contact.email}" placeholder="email@example.com" onchange="updateContactData(${contact.id}, 'email', this.value)">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        window.updateContactData = (contactId, field, value) => {
            const contact = projectContacts.find(c => c.id === contactId);
            if (contact) {
                contact[field] = value;
            }
        };

        window.removeClientContact = (contactId) => {
            projectContacts = projectContacts.filter(c => c.id !== contactId);
            renderClientContacts();
        };

        // INDIVIDUAL LIFT CONFIGURATION MANAGEMENT
        let projectLifts = [];

        window.generateLiftFields = () => {
            const liftsCount = parseInt(document.getElementById('projectLiftsCount').value) || 1;
            projectLifts = [];
            
            for (let i = 0; i < liftsCount; i++) {
                projectLifts.push({
                    id: Date.now() + i,
                    liftNumber: `L-${i + 1}`,
                    liftType: '',
                    capacity: '',
                    floors: '',
                    machineType: '',
                    speed: '',
                    driveType: '',
                    controlSystem: '',
                    location: '',
                    serialNumber: '',
                    manufacturer: '',
                    installationDate: '',
                    lastServiceDate: '',
                    notes: ''
                });
            }
            renderLiftConfigurations();
        };

        function renderLiftConfigurations() {
            const container = document.getElementById('liftsConfigurationContainer');
            
            if (projectLifts.length === 0) {
                container.innerHTML = '<p style="color: #64748b; text-align: center; padding: 20px;">Please enter number of lifts above</p>';
                return;
            }
            
            container.innerHTML = projectLifts.map((lift, index) => `
                <div class="card" style="background: white; border: 2px solid #c4b5fd; margin-bottom: 16px; padding: 16px;">
                    <div style="background: #7c3aed; color: white; padding: 8px 12px; border-radius: 6px; margin-bottom: 16px;">
                        <h5 style="margin: 0; font-size: 15px;">üèóÔ∏è Lift ${index + 1} Configuration</h5>
                    </div>
                    
                    <!-- Basic Lift Info -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Lift Number/ID *</label>
                            <input type="text" class="form-control" value="${lift.liftNumber}" onchange="updateLiftData(${lift.id}, 'liftNumber', this.value)" placeholder="e.g., L-1, Lift-A">
                        </div>
                        <div class="form-group">
                            <label>Lift Type *</label>
                            <select class="form-control" onchange="updateLiftData(${lift.id}, 'liftType', this.value)">
                                <option value="">Select Type</option>
                                <option value="Passenger" ${lift.liftType === 'Passenger' ? 'selected' : ''}>Passenger Elevator</option>
                                <option value="Freight" ${lift.liftType === 'Freight' ? 'selected' : ''}>Freight/Goods Elevator</option>
                                <option value="Hospital" ${lift.liftType === 'Hospital' ? 'selected' : ''}>Hospital/Bed Elevator</option>
                                <option value="Service" ${lift.liftType === 'Service' ? 'selected' : ''}>Service Elevator</option>
                                <option value="Residential" ${lift.liftType === 'Residential' ? 'selected' : ''}>Residential Elevator</option>
                                <option value="Dumbwaiter" ${lift.liftType === 'Dumbwaiter' ? 'selected' : ''}>Dumbwaiter</option>
                                <option value="Escalator" ${lift.liftType === 'Escalator' ? 'selected' : ''}>Escalator</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Technical Specifications -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Capacity *</label>
                            <input type="text" class="form-control" value="${lift.capacity}" onchange="updateLiftData(${lift.id}, 'capacity', this.value)" placeholder="e.g., 8 persons / 630kg">
                        </div>
                        <div class="form-group">
                            <label>Floors Served *</label>
                            <input type="text" class="form-control" value="${lift.floors}" onchange="updateLiftData(${lift.id}, 'floors', this.value)" placeholder="e.g., G+5, B1 to 10">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Machine Type</label>
                            <select class="form-control" onchange="updateLiftData(${lift.id}, 'machineType', this.value)">
                                <option value="">Select Machine Type</option>
                                <option value="Geared" ${lift.machineType === 'Geared' ? 'selected' : ''}>Geared Traction</option>
                                <option value="Gearless" ${lift.machineType === 'Gearless' ? 'selected' : ''}>Gearless Traction</option>
                                <option value="Hydraulic" ${lift.machineType === 'Hydraulic' ? 'selected' : ''}>Hydraulic</option>
                                <option value="MRL" ${lift.machineType === 'MRL' ? 'selected' : ''}>Machine Room Less (MRL)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Speed (m/s)</label>
                            <input type="number" class="form-control" step="0.1" value="${lift.speed}" onchange="updateLiftData(${lift.id}, 'speed', this.value)" placeholder="e.g., 1.0, 1.5">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Drive Type</label>
                            <select class="form-control" onchange="updateLiftData(${lift.id}, 'driveType', this.value)">
                                <option value="">Select Drive</option>
                                <option value="VVVF" ${lift.driveType === 'VVVF' ? 'selected' : ''}>VVVF (Variable Voltage Variable Frequency)</option>
                                <option value="AC" ${lift.driveType === 'AC' ? 'selected' : ''}>AC Drive</option>
                                <option value="DC" ${lift.driveType === 'DC' ? 'selected' : ''}>DC Drive</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Control System</label>
                            <input type="text" class="form-control" value="${lift.controlSystem}" onchange="updateLiftData(${lift.id}, 'controlSystem', this.value)" placeholder="e.g., Microprocessor, PLC">
                        </div>
                    </div>
                    
                    <!-- Equipment Details -->
                    <div class="form-row">
                        <div class="form-group">
                            <label>Location in Building</label>
                            <input type="text" class="form-control" value="${lift.location}" onchange="updateLiftData(${lift.id}, 'location', this.value)" placeholder="e.g., North Wing, Central">
                        </div>
                        <div class="form-group">
                            <label>Serial Number</label>
                            <input type="text" class="form-control" value="${lift.serialNumber}" onchange="updateLiftData(${lift.id}, 'serialNumber', this.value)" placeholder="Equipment serial number">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Manufacturer</label>
                            <input type="text" class="form-control" value="${lift.manufacturer}" onchange="updateLiftData(${lift.id}, 'manufacturer', this.value)" placeholder="e.g., Otis, Schindler, Kone">
                        </div>
                        <div class="form-group">
                            <label>Installation Date</label>
                            <input type="date" class="form-control" value="${lift.installationDate}" onchange="updateLiftData(${lift.id}, 'installationDate', this.value)">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Additional Notes</label>
                        <textarea class="form-control" rows="2" onchange="updateLiftData(${lift.id}, 'notes', this.value)" placeholder="Any special configurations, features, or notes about this lift">${lift.notes}</textarea>
                    </div>
                </div>
            `).join('');
        }

        window.updateLiftData = (liftId, field, value) => {
            const lift = projectLifts.find(l => l.id === liftId);
            if (lift) {
                lift[field] = value;
            }
        };

        // GOOGLE MAPS INTEGRATION
        window.openProjectLocation = () => {
            const mapsLink = document.getElementById('projectMapsLink').value.trim();
            const address = document.getElementById('projectAddress').value.trim();
            
            if (mapsLink) {
                window.open(mapsLink, '_blank');
            } else if (address) {
                // Create Google Maps search URL from address
                const searchUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
                window.open(searchUrl, '_blank');
            } else {
                alert('‚ö†Ô∏è Please enter either a Google Maps link or project address first');
            }
        };

        // Function to generate wings fields
        let lastWingsCount = 0; // Track last count to avoid unnecessary regeneration
        
        window.generateWingsFields = () => {
            const wingsCount = parseInt(document.getElementById('projectWingsCount').value) || 1;
            const container = document.getElementById('wingsConfigurationContainer');
            
            if (!container) {
                console.error('wingsConfigurationContainer not found');
                return;
            }
            
            // Don't regenerate if count hasn't changed
            if (lastWingsCount === wingsCount && container.children.length > 0) {
                console.log('Wings count unchanged, skipping regeneration');
                return;
            }
            lastWingsCount = wingsCount;
            
            // Save existing wing data before clearing
            const existingWingData = [];
            const existingWingNames = container.querySelectorAll('.wing-name');
            const existingWingElevators = container.querySelectorAll('.wing-elevators');
            
            existingWingNames.forEach((input, idx) => {
                const elevatorInputs = document.getElementById(`elevatorNumbers_${idx}`)?.querySelectorAll('.elevator-number');
                const elevators = [];
                elevatorInputs?.forEach(el => {
                    if (el.value) elevators.push(el.value);
                });
                
                existingWingData.push({
                    name: input.value,
                    elevatorCount: existingWingElevators[idx]?.value || 1,
                    elevators: elevators
                });
            });
            
            currentWings = [];
            container.innerHTML = '';
            
            const wingNames = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T'];
            
            for (let i = 0; i < wingsCount; i++) {
                const defaultWingName = wingsCount === 1 ? 'Main Building' : `${wingNames[i]} Wing`;
                // Use existing data if available
                const wingName = existingWingData[i]?.name || defaultWingName;
                const elevatorCount = existingWingData[i]?.elevatorCount || 1;
                
                const wingDiv = document.createElement('div');
                wingDiv.className = 'card';
                wingDiv.style.cssText = 'background: #f0f9ff; border: 1px solid #bae6fd; margin: 12px 0; padding: 16px;';
                
                wingDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h5 style="margin: 0; color: #0369a1;">${wingName}</h5>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Wing/Block Name *</label>
                            <input type="text" id="wingName_${i}" class="form-control wing-name" value="${wingName}" required>
                        </div>
                        <div class="form-group">
                            <label>Number of Elevators *</label>
                            <input type="number" id="wingElevators_${i}" class="form-control wing-elevators" min="1" value="${elevatorCount}" required onchange="generateElevatorNumbersForWing(${i})">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Elevator Numbers/IDs *</label>
                        <div id="elevatorNumbers_${i}" class="elevator-numbers-container"></div>
                    </div>
                `;
                
                container.appendChild(wingDiv);
                generateElevatorNumbersForWing(i);
                
                // Restore elevator values if they existed
                if (existingWingData[i]?.elevators) {
                    setTimeout(() => {
                        existingWingData[i].elevators.forEach((elevValue, elevIdx) => {
                            const elevInput = document.getElementById(`wing_${i}_elev_${elevIdx}`);
                            if (elevInput) elevInput.value = elevValue;
                        });
                    }, 50);
                }
            }
        };

        // Function to generate elevator number inputs for a specific wing
        window.generateElevatorNumbersForWing = (wingIndex) => {
            const container = document.getElementById(`elevatorNumbers_${wingIndex}`);
            const elevatorCountInput = document.getElementById(`wingElevators_${wingIndex}`) || document.querySelectorAll('.wing-elevators')[wingIndex];
            const elevatorCount = parseInt(elevatorCountInput.value) || 1;
            
            // Save existing values before clearing
            const existingValues = [];
            const existingInputs = container.querySelectorAll('.elevator-number');
            existingInputs.forEach(input => {
                existingValues.push(input.value);
            });
            
            container.innerHTML = '';
            
            for (let i = 0; i < elevatorCount; i++) {
                const elevatorDiv = document.createElement('div');
                elevatorDiv.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: center;';
                // Restore existing value if available
                const existingValue = existingValues[i] || '';
                elevatorDiv.innerHTML = `
                    <span style="min-width: 80px;">Elevator ${i + 1}:</span>
                    <input type="text" id="wing_${wingIndex}_elev_${i}" class="form-control elevator-number" value="${existingValue}" placeholder="e.g., L-${i + 1} or Lift ${i + 1}" required style="flex: 1;">
                `;
                container.appendChild(elevatorDiv);
            }
        };

        // Function to generate elevator fields based on count
        window.generateElevatorFields = () => {
            const count = parseInt(document.getElementById('projectElevatorCount').value);
            const detailsDiv = document.getElementById('elevatorDetails');
            
            if (count > 0) {
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
        };

        // Function to load elevators for maintenance modal
        // Function to load sub-apartments for a project
        window.loadSubApartments = (context) => {
            const projectSelect = document.getElementById(`${context}Project`);
            const subApartmentGroup = document.getElementById(`${context}SubApartmentGroup`);
            const subApartmentSelect = document.getElementById(`${context}SubApartment`);
            const wingSelect = document.getElementById(`${context}Wing`);
            
            const projectId = projectSelect.value;
            
            if (projectId && projects) {
                const project = projects.find(p => p.id === projectId);
                
                if (project && project.subApartments && project.subApartments.length > 0) {
                    subApartmentGroup.style.display = 'block';
                    subApartmentSelect.innerHTML = '<option value="">None - Main Project</option>';
                    
                    project.subApartments.forEach(apt => {
                        const option = document.createElement('option');
                        option.value = apt;
                        option.textContent = apt;
                        subApartmentSelect.appendChild(option);
                    });
                } else {
                    subApartmentGroup.style.display = 'none';
                }
                
                // Load wings
                loadWings(context);
            } else {
                subApartmentGroup.style.display = 'none';
                wingSelect.innerHTML = '<option value="">Select project first</option>';
            }
        };

        // Function to load wings for selected project
        window.loadWings = (context) => {
            const projectId = document.getElementById(`${context}Project`).value;
            const wingSelect = document.getElementById(`${context}Wing`);
            
            console.log(`üîç loadWings called for context: ${context}`);
            console.log(`   Project ID: ${projectId}`);
            console.log(`   Wing select element:`, wingSelect);
            
            wingSelect.innerHTML = '<option value="">Select Wing</option>';
            
            if (projectId && projects) {
                const project = projects.find(p => p.id === projectId);
                
                console.log(`   Found project:`, project);
                console.log(`   Project wings:`, project?.wings);
                
                if (project && project.wings && project.wings.length > 0) {
                    console.log(`   ‚úÖ Loading ${project.wings.length} wings into dropdown`);
                    project.wings.forEach(wing => {
                        console.log(`      Adding wing: ${wing.wingName}`);
                        const option = document.createElement('option');
                        option.value = wing.wingName;
                        option.textContent = wing.wingName;
                        wingSelect.appendChild(option);
                    });
                } else {
                    console.log(`   ‚ö†Ô∏è No wings found for this project`);
                }
            } else {
                console.log(`   ‚ö†Ô∏è No projectId or projects array`);
            }
        };

        // Function to load elevators by selected wing
        window.loadElevatorsByWing = (context) => {
            const projectId = document.getElementById(`${context}Project`).value;
            const selectedWing = document.getElementById(`${context}Wing`).value;
            const elevatorSelect = document.getElementById(`${context}Elevator`);
            
            console.log(`üîç loadElevatorsByWing called for context: ${context}`);
            console.log(`   Project ID: ${projectId}`);
            console.log(`   Selected Wing: ${selectedWing}`);
            
            elevatorSelect.innerHTML = '';
            
            if (projectId && selectedWing && projects) {
                const project = projects.find(p => p.id === projectId);
                
                console.log(`   Found project:`, project);
                console.log(`   Project wings:`, project?.wings);
                
                if (project && project.wings) {
                    const wing = project.wings.find(w => w.wingName === selectedWing);
                    
                    console.log(`   Found wing:`, wing);
                    console.log(`   Wing elevators:`, wing?.elevators);
                    
                    if (wing && wing.elevators && wing.elevators.length > 0) {
                        console.log(`   ‚úÖ Loading ${wing.elevators.length} elevators into dropdown`);
                        wing.elevators.forEach((elevator, index) => {
                            console.log(`      Adding elevator: ${elevator}`);
                            const option = document.createElement('option');
                            option.value = `${projectId}-${selectedWing}-${elevator}`;
                            option.textContent = `${selectedWing} - ${elevator}`;
                            // Store elevator data as data attribute
                            option.setAttribute('data-elevator-info', JSON.stringify({
                                name: elevator,
                                type: wing.elevatorTypes?.[index] || 'Standard',
                                capacity: wing.elevatorCapacities?.[index] || 'N/A',
                                floors: wing.elevatorFloors?.[index] || project.floors || 'N/A'
                            }));
                            elevatorSelect.appendChild(option);
                        });
                    } else {
                        console.log(`   ‚ö†Ô∏è No elevators found in wing`);
                    }
                } else {
                    console.log(`   ‚ö†Ô∏è Project has no wings array`);
                }
            } else {
                elevatorSelect.innerHTML = '<option value="">Select wing first</option>';
                console.log(`   ‚ö†Ô∏è Missing required data - projectId: ${projectId}, selectedWing: ${selectedWing}`);
            }
        };

        // Display selected elevator details in AMC modal
        window.displaySelectedElevatorDetails = () => {
            const elevatorSelect = document.getElementById('amcElevator');
            const detailsContainer = document.getElementById('selectedElevatorsDetails');
            const detailsList = document.getElementById('elevatorDetailsList');
            
            if (!elevatorSelect || !detailsContainer || !detailsList) return;
            
            const selectedOptions = Array.from(elevatorSelect.selectedOptions);
            
            if (selectedOptions.length === 0) {
                detailsContainer.style.display = 'none';
                return;
            }
            
            detailsContainer.style.display = 'block';
            
            let html = `
                <div style="display: grid; gap: 12px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; font-size: 13px;">
                        <div style="background: white; padding: 8px; border-radius: 6px;">
                            <strong style="color: #0369a1;">Total Elevators:</strong> ${selectedOptions.length}
                        </div>
            `;
            
            selectedOptions.forEach((option, index) => {
                try {
                    const elevatorInfo = JSON.parse(option.getAttribute('data-elevator-info') || '{}');
                    html += `
                        <div style="background: white; padding: 10px; border-radius: 6px; border-left: 3px solid #3b82f6;">
                            <div style="font-weight: 600; color: #1e40af; margin-bottom: 4px;">${index + 1}. ${elevatorInfo.name || option.textContent}</div>
                            <div style="font-size: 12px; color: #64748b;">
                                <div>Type: <strong>${elevatorInfo.type}</strong></div>
                                <div>Capacity: <strong>${elevatorInfo.capacity} ${typeof elevatorInfo.capacity === 'number' ? 'persons' : ''}</strong></div>
                                <div>Floors: <strong>${elevatorInfo.floors}</strong></div>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    html += `
                        <div style="background: white; padding: 10px; border-radius: 6px;">
                            <div style="font-weight: 600; color: #1e40af;">${option.textContent}</div>
                        </div>
                    `;
                }
            });
            
            html += '</div></div>';
            detailsList.innerHTML = html;
        };

        window.loadElevators = () => {
            const projectId = document.getElementById('maintenanceProject').value;
            const elevatorSelect = document.getElementById('maintenanceElevator');
            
            // Clear current options
            elevatorSelect.innerHTML = '';
            
            if (projectId && projects) {
                const project = projects.find(p => p.id === projectId);
                if (project) {
                    // Check if project has elevators array
                    if (project.elevators && Array.isArray(project.elevators) && project.elevators.length > 0) {
                        project.elevators.forEach(elevator => {
                            const elevatorId = elevator.id || elevator.elevatorId || `${projectId}-Elevator-${elevator.number || elevator.name}`;
                            const elevatorName = elevator.name || elevator.number || `Elevator ${elevator.number}`;
                            const option = document.createElement('option');
                            option.value = elevatorId;
                            option.textContent = elevatorName;
                            elevatorSelect.appendChild(option);
                        });
                    } 
                    // Fall back to elevator count if no elevators array
                    else if (project.elevatorCount) {
                        const count = parseInt(project.elevatorCount) || 1;
                        for (let i = 1; i <= count; i++) {
                            const elevatorId = `${projectId}-Elevator-${i}`;
                            const option = document.createElement('option');
                            option.value = elevatorId;
                            option.textContent = `Elevator ${i}`;
                            elevatorSelect.appendChild(option);
                        }
                    }
                    // If neither exists, create a default set based on common patterns
                    else {
                        // Default to creating at least 2 elevators for each project
                        const defaultCount = 2;
                        for (let i = 1; i <= defaultCount; i++) {
                            const elevatorId = `${projectId}-Elevator-${i}`;
                            const option = document.createElement('option');
                            option.value = elevatorId;
                            option.textContent = `Elevator ${i}`;
                            elevatorSelect.appendChild(option);
                        }
                    }
                } else {
                    elevatorSelect.innerHTML = '<option value="">No project selected</option>';
                }
            } else {
                elevatorSelect.innerHTML = '<option value="">Select a project first</option>';
            }
        };

        // Function to show maintenance modal
        // Maintenance form submission
        document.getElementById('maintenanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            console.log('üìù Starting maintenance form submission...');
            
            const maintenanceId = document.getElementById('editMaintenanceId').value;
            const elevatorSelect = document.getElementById('maintenanceElevator');
            
            if (!elevatorSelect) {
                alert('Error: Elevator select element not found');
                return;
            }
            
            const selectedElevators = Array.from(elevatorSelect.selectedOptions).map(opt => opt.value);
            const subApartment = document.getElementById('maintenanceSubApartment')?.value || '';
            const wing = document.getElementById('maintenanceWing')?.value;
            
            console.log('Selected elevators:', selectedElevators);
            console.log('Wing:', wing);
            
            // If multiple elevators are selected, create maintenance for each
            if (selectedElevators.length === 0) {
                alert('Please select at least one elevator');
                return;
            }
            
            // Validate RCI type
            const rciType = document.getElementById('rciType')?.value || 'Maintenance';
            if (!rciType) {
                alert('Please select a record type (Repair, Complaint, or Maintenance)');
                return;
            }
            
            try {
                const project = projects && projects.find ? projects.find(p => p.id === document.getElementById('maintenanceProject').value) : null;
                
                const baseMaintenanceData = {
                    projectId: document.getElementById('maintenanceProject').value,
                    projectName: project?.name || '',
                    buildingName: project?.buildingName || project?.name || '',
                    subApartment,
                    wing,
                    floor: document.getElementById('maintenanceFloor')?.value || '',
                    apartment: document.getElementById('maintenanceApartment')?.value || '',
                    rciType: rciType, // Repair, Complaint, or Maintenance
                    issue: document.getElementById('maintenanceIssue').value,
                    priority: document.getElementById('maintenancePriority').value,
                    assignedTo: document.getElementById('maintenanceAssignee').value,
                    dueDate: document.getElementById('maintenanceDueDate').value,
                    status: document.getElementById('maintenanceStatus').value || 'Scheduled',
                    notes: document.getElementById('maintenanceNotes').value,
                    
                    // Complaint person details
                    complaintPersonName: document.getElementById('complaintPersonName').value,
                    complaintPersonPhone: document.getElementById('complaintPersonPhone').value,
                    complaintPersonEmail: document.getElementById('complaintPersonEmail').value,
                    complaintPersonDesignation: document.getElementById('complaintPersonDesignation').value,
                    complaintPersonAddress: document.getElementById('complaintPersonAddress').value,
                    complaintDate: document.getElementById('complaintDate').value,
                    
                    // Work details
                    workDescription: document.getElementById('workDescription').value,
                    partsUsed: document.getElementById('partsUsed').value,
                    workCost: document.getElementById('workCost').value,
                    arrivalTime: document.getElementById('arrivalTime').value,
                    completionTime: document.getElementById('completionTime').value,
                    signatoryName: document.getElementById('signatoryName').value,
                    
                    updatedAt: new Date().toISOString(),
                    updatedBy: currentUser ? currentUser.username : 'System'
                };

                // Add hold information if status is "On Hold"
                const status = document.getElementById('maintenanceStatus').value;
                if (status === 'On Hold') {
                    baseMaintenanceData.holdInformation = {
                        reason: document.getElementById('maintenanceHoldReason').value,
                        holdDate: document.getElementById('maintenanceHoldDate').value,
                        expectedResumeDate: document.getElementById('maintenanceExpectedResumeDate').value,
                        duration: document.getElementById('maintenanceHoldDuration').value,
                        notes: document.getElementById('maintenanceHoldNotes').value,
                        heldBy: currentUser ? currentUser.username : 'System',
                        heldAt: new Date().toISOString()
                    };
                }
                
                // If editing, only update single maintenance
                if (maintenanceId) {
                    const maintenanceData = {
                        ...baseMaintenanceData,
                        elevatorId: selectedElevators[0] // For editing, use first selected elevator
                    };

                    // Add signatures if they exist
                    const arrivalCanvas = document.getElementById('arrivalSignatureCanvas');
                    const completionCanvas = document.getElementById('completionSignatureCanvas');
                    
                    if (arrivalCanvas && !isCanvasEmpty(arrivalCanvas)) {
                        maintenanceData.arrivalSignature = arrivalCanvas.toDataURL('image/png');
                    }
                    
                    if (completionCanvas && !isCanvasEmpty(completionCanvas)) {
                        maintenanceData.completionSignature = completionCanvas.toDataURL('image/png');
                    }
                    
                    // Update existing maintenance
                    if (isOnline) {
                        await updateDoc(doc(db, 'maintenance', maintenanceId), maintenanceData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Updated maintenance for ${maintenanceData.elevatorId} in project ${maintenanceData.projectName} - Status: ${maintenanceData.status}`,
                            user: currentUser ? currentUser.username : 'System'
                        });
                    }
                } else {
                    // Create single maintenance card for multiple elevators
                    const maintenanceData = {
                        ...baseMaintenanceData,
                        elevatorIds: selectedElevators, // Store all elevator IDs
                        elevatorCount: selectedElevators.length,
                        elevatorList: selectedElevators.join(', '), // For display purposes
                        completedElevators: [], // Track which elevators are completed
                        pendingElevators: [...selectedElevators], // Track pending elevators
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser ? currentUser.username : 'System'
                    };
                    
                    // Add signatures if they exist
                    const arrivalCanvas = document.getElementById('arrivalSignatureCanvas');
                    const completionCanvas = document.getElementById('completionSignatureCanvas');
                    
                    if (arrivalCanvas && !isCanvasEmpty(arrivalCanvas)) {
                        maintenanceData.arrivalSignature = arrivalCanvas.toDataURL('image/png');
                    }
                    
                    if (completionCanvas && !isCanvasEmpty(completionCanvas)) {
                        maintenanceData.completionSignature = completionCanvas.toDataURL('image/png');
                    }
                    
                    if (isOnline) {
                        await addDoc(collection(db, 'maintenance'), maintenanceData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Scheduled maintenance for ${selectedElevators.length} elevators (${selectedElevators.join(', ')}) in project ${maintenanceData.projectName} - Priority: ${maintenanceData.priority}`,
                            user: currentUser ? currentUser.username : 'System'
                        });
                    }
                }
                
                closeModal('maintenanceModal');
                await loadData();
                const message = maintenanceId ? 
                    'Maintenance updated successfully!' : 
                    `Maintenance scheduled for ${selectedElevators.length} elevator(s) successfully!`;
                alert(message);
            } catch (error) {
                console.error('‚ùå Error scheduling maintenance:', error);
                console.error('Error stack:', error.stack);
                console.error('Error at line:', error.lineNumber || 'unknown');
                alert('Error scheduling maintenance: ' + error.message + '\n\nCheck console for details.');
            }
        });

        window.editMaintenance = (id) => {
            const maint = maintenance && maintenance.find ? maintenance.find(m => m.id === id) : null;
            
            if (!maint) {
                alert('Maintenance record not found');
                return;
            }
            
            document.getElementById('maintenanceModalTitle').textContent = 'Edit RCI Record';
            document.getElementById('editMaintenanceId').value = maint.id;
            
            // Set RCI Type
            if (document.getElementById('rciType')) {
                document.getElementById('rciType').value = maint.rciType || 'Maintenance';
            }
            
            // Set floor and apartment
            if (document.getElementById('maintenanceFloor')) {
                document.getElementById('maintenanceFloor').value = maint.floor || '';
            }
            if (document.getElementById('maintenanceApartment')) {
                document.getElementById('maintenanceApartment').value = maint.apartment || '';
            }
            
            document.getElementById('maintenanceProject').value = maint.projectId || '';
            
            // Populate dropdowns
            const projectSelect = document.getElementById('maintenanceProject');
            projectSelect.innerHTML = '<option value="">Select Project</option>' + 
                projects.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
            document.getElementById('maintenanceProject').value = maint.projectId || '';
            
            // Load sub-apartments, wings, and elevators if they exist
            if (maint.projectId) {
                loadSubApartments('maintenance');
                if (maint.subApartment) {
                    setTimeout(() => {
                        document.getElementById('maintenanceSubApartment').value = maint.subApartment;
                        loadWings('maintenance');
                    }, 100);
                }
                if (maint.wing) {
                    setTimeout(() => {
                        document.getElementById('maintenanceWing').value = maint.wing;
                        loadElevatorsByWing('maintenance');
                        
                        // Set selected elevators
                        setTimeout(() => {
                            const elevatorSelect = document.getElementById('maintenanceElevator');
                            // For editing, only select the single elevator (or multiple if it was multi-elevator)
                            Array.from(elevatorSelect.options).forEach(option => {
                                if (maint.elevatorId) {
                                    option.selected = option.value === maint.elevatorId;
                                } else if (maint.elevatorIds && maint.elevatorIds.includes(option.value)) {
                                    option.selected = true;
                                }
                            });
                        }, 200);
                    }, 150);
                } else {
                    // Fallback to old loadElevators if no wing data
                    loadElevators();
                    setTimeout(() => {
                        const elevatorSelect = document.getElementById('maintenanceElevator');
                        Array.from(elevatorSelect.options).forEach(option => {
                            option.selected = option.value === maint.elevatorId;
                        });
                    }, 100);
                }
            }
            
            document.getElementById('maintenanceIssue').value = maint.issue || '';
            document.getElementById('maintenancePriority').value = maint.priority || '';
            document.getElementById('maintenanceAssignee').value = maint.assignedTo || '';
            document.getElementById('maintenanceDueDate').value = maint.dueDate || '';
            document.getElementById('maintenanceStatus').value = maint.status || 'Scheduled';
            document.getElementById('maintenanceNotes').value = maint.notes || '';
            
            // Complaint person details
            document.getElementById('complaintPersonName').value = maint.complaintPersonName || '';
            document.getElementById('complaintPersonPhone').value = maint.complaintPersonPhone || '';
            document.getElementById('complaintPersonEmail').value = maint.complaintPersonEmail || '';
            document.getElementById('complaintPersonDesignation').value = maint.complaintPersonDesignation || '';
            document.getElementById('complaintPersonAddress').value = maint.complaintPersonAddress || '';
            document.getElementById('complaintDate').value = maint.complaintDate || '';
            
            // Work details
            document.getElementById('workDescription').value = maint.workDescription || '';
            document.getElementById('partsUsed').value = maint.partsUsed || '';
            document.getElementById('workCost').value = maint.workCost || '';
            document.getElementById('arrivalTime').value = maint.arrivalTime || '';
            document.getElementById('completionTime').value = maint.completionTime || '';
            document.getElementById('signatoryName').value = maint.signatoryName || '';
            
            // Load signatures if they exist
            if (maint.arrivalSignature) {
                loadSignatureToCanvas('arrivalSignatureCanvas', maint.arrivalSignature);
            }
            if (maint.completionSignature) {
                loadSignatureToCanvas('completionSignatureCanvas', maint.completionSignature);
            }
            
            const assigneeSelect = document.getElementById('maintenanceAssignee');
            assigneeSelect.innerHTML = '<option value="">Select Technician</option>' + 
                employees.filter(emp => (emp.systemRole === 'technician' || emp.systemRole === 'user' || emp.systemRole === 'admin') && emp.systemStatus === 'active')
                     .map(emp => `<option value="${emp.username}">${emp.firstName} ${emp.lastName} (${emp.position})</option>`).join('');
            document.getElementById('maintenanceAssignee').value = maint.assignedTo || '';
            
            // Show export button if completed
            if (maint.status === 'Completed') {
                document.getElementById('exportBtn').style.display = 'inline-flex';
                document.getElementById('exportBtn').setAttribute('onclick', `exportMaintenanceReport('${maint.id}')`);
            } else {
                document.getElementById('exportBtn').style.display = 'none';
            }

            // Populate hold information if exists
            if (maint.holdInformation) {
                document.getElementById('maintenanceHoldReason').value = maint.holdInformation.reason || '';
                document.getElementById('maintenanceHoldDate').value = maint.holdInformation.holdDate || '';
                document.getElementById('maintenanceExpectedResumeDate').value = maint.holdInformation.expectedResumeDate || '';
                document.getElementById('maintenanceHoldDuration').value = maint.holdInformation.duration || '';
                document.getElementById('maintenanceHoldNotes').value = maint.holdInformation.notes || '';
            }
            
            // Toggle signature sections based on status
            toggleSignatureSection();

            // Toggle hold fields visibility
            setTimeout(() => {
                toggleHoldFields('maintenance');
            }, 100);
            
            document.getElementById('maintenanceModal').classList.add('active');
        };

        // Multi-elevator maintenance completion
        window.completeMultiElevatorMaintenance = async (maintenanceId) => {
            const maint = maintenance.find(m => m.id === maintenanceId);
            if (!maint || !maint.elevatorIds) {
                alert('Maintenance record not found or not a multi-elevator maintenance.');
                return;
            }

            // Create modal for selecting elevators to complete
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'multiElevatorCompletionModal';
            modal.innerHTML = `
                <div class="modal-dialog" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3>Complete Multi-Elevator Maintenance</h3>
                        <button class="modal-close" onclick="closeModal('multiElevatorCompletionModal')">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-section">
                            <h4>Select Elevators to Complete</h4>
                            <p><strong>Project:</strong> ${maint.projectName}</p>
                            <p><strong>Issue:</strong> ${maint.issue}</p>
                            <p><strong>Assigned to:</strong> ${maint.assignedTo}</p>
                            
                            <div class="elevator-selection-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin: 20px 0;">
                                ${maint.pendingElevators.map(elevatorId => `
                                    <label class="elevator-checkbox-card" style="display: flex; align-items: center; padding: 15px; border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; background: var(--card-bg);">
                                        <input type="checkbox" value="${elevatorId}" name="completedElevators" style="margin-right: 10px; transform: scale(1.2);">
                                        <span style="font-weight: 500;">${elevatorId}</span>
                                    </label>
                                `).join('')}
                            </div>
                            
                            ${maint.completedElevators.length > 0 ? `
                                <div class="completed-elevators" style="margin-top: 20px; padding: 15px; background: var(--success-bg, #d4edda); border-radius: 8px;">
                                    <h5 style="color: var(--success); margin-bottom: 10px;">‚úÖ Already Completed:</h5>
                                    <p>${maint.completedElevators.join(', ')}</p>
                                </div>
                            ` : ''}
                            
                            <div class="work-details" style="margin-top: 20px;">
                                <h4>Work Details</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="multiWorkDescription">Work Description</label>
                                        <textarea id="multiWorkDescription" class="form-control" rows="3" placeholder="Describe the work performed..."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="multiPartsUsed">Parts/Materials Used</label>
                                        <textarea id="multiPartsUsed" class="form-control" rows="2" placeholder="List parts and materials used..."></textarea>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="multiWorkCost">Total Work Cost (Rs.)</label>
                                        <input type="number" id="multiWorkCost" class="form-control" placeholder="Enter total cost">
                                    </div>
                                    <div class="form-group">
                                        <label for="multiSignatoryName">Signatory Name</label>
                                        <input type="text" id="multiSignatoryName" class="form-control" placeholder="Name of person signing">
                                    </div>
                                </div>
                                
                                <!-- Signatures Section -->
                                <div class="signatures-section" style="margin-top: 20px;">
                                    <h4>Digital Signatures</h4>
                                    <div class="signature-grid" style="display: flex; flex-direction: column; gap: 25px;">
                                        <div class="signature-panel">
                                            <h5>Arrival Signature</h5>
                                            <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 12px; background: white; width: fit-content;">
                                                <canvas id="multiArrivalSignatureCanvas" width="500" height="200" style="display: block; cursor: crosshair; touch-action: none;"></canvas>
                                            </div>
                                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                                <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignatureById('multiArrivalSignatureCanvas')">Clear</button>
                                                <span style="font-size: 12px; color: #64748b; line-height: 32px;">Sign above to confirm technician arrival</span>
                                            </div>
                                        </div>
                                        <div class="signature-panel">
                                            <h5>Completion Signature</h5>
                                            <div style="border: 2px solid var(--border-color); border-radius: 8px; padding: 12px; background: white; width: fit-content;">
                                                <canvas id="multiCompletionSignatureCanvas" width="500" height="200" style="display: block; cursor: crosshair; touch-action: none;"></canvas>
                                            </div>
                                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                                <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignatureById('multiCompletionSignatureCanvas')">Clear</button>
                                                <span style="font-size: 12px; color: #64748b; line-height: 32px;">Sign above to confirm work completion</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('multiElevatorCompletionModal')">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="submitMultiElevatorCompletion('${maintenanceId}')">Complete Selected Elevators</button>
                        <button type="button" class="btn btn-primary" onclick="generateMultiElevatorReports('${maintenanceId}')">Generate Reports</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            modal.classList.add('active');
            
            // Initialize signature canvases - FIX TOUCH COORDINATES PROPERLY
            setTimeout(() => {
                setupSignatureCanvas('multiArrivalSignatureCanvas');
                setupSignatureCanvas('multiCompletionSignatureCanvas');
                
                // Initialize canvases with EXACT dimensions - NO SCALING
                ['multiArrivalSignatureCanvas', 'multiCompletionSignatureCanvas'].forEach(canvasId => {
                    const canvas = document.getElementById(canvasId);
                    if (canvas) {
                        // Set canvas dimensions to exactly match HTML attributes
                        canvas.width = 500;  // EXACTLY matches width="500" in HTML
                        canvas.height = 200; // EXACTLY matches height="200" in HTML
                        
                        // No CSS width/height styling - use natural canvas size
                        canvas.style.width = '';
                        canvas.style.height = '';
                        
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // Drawing properties
                        ctx.strokeStyle = '#000000';
                        ctx.lineWidth = 3;
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';
                    }
                });
            }, 300);
        };

        // Submit multi-elevator completion
        window.submitMultiElevatorCompletion = async (maintenanceId) => {
            const selectedElevators = Array.from(document.querySelectorAll('input[name="completedElevators"]:checked')).map(cb => cb.value);
            
            if (selectedElevators.length === 0) {
                alert('Please select at least one elevator to complete.');
                return;
            }

            const maint = maintenance.find(m => m.id === maintenanceId);
            const workDescription = document.getElementById('multiWorkDescription').value;
            const partsUsed = document.getElementById('multiPartsUsed').value;
            const workCost = document.getElementById('multiWorkCost').value;
            const signatoryName = document.getElementById('multiSignatoryName').value;

            // Get signatures
            const arrivalCanvas = document.getElementById('multiArrivalSignatureCanvas');
            const completionCanvas = document.getElementById('multiCompletionSignatureCanvas');
            const arrivalSignature = !isCanvasEmpty(arrivalCanvas) ? arrivalCanvas.toDataURL('image/png') : null;
            const completionSignature = !isCanvasEmpty(completionCanvas) ? completionCanvas.toDataURL('image/png') : null;

            try {
                // Update the maintenance record
                const updatedMaint = {
                    ...maint,
                    completedElevators: [...(maint.completedElevators || []), ...selectedElevators],
                    pendingElevators: maint.pendingElevators.filter(id => !selectedElevators.includes(id)),
                    workDescription,
                    partsUsed,
                    workCost,
                    signatoryName,
                    arrivalTime: new Date().toISOString(),
                    completionTime: new Date().toISOString(),
                    arrivalSignature,
                    completionSignature,
                    updatedAt: new Date().toISOString()
                };

                // Update status if all elevators completed
                if (updatedMaint.pendingElevators.length === 0) {
                    updatedMaint.status = 'Completed';
                } else {
                    updatedMaint.status = 'In Progress';
                }

                if (isOnline) {
                    await updateDoc(doc(db, 'maintenance', maintenanceId), updatedMaint);
                    await addDoc(collection(db, 'activities'), {
                        date: new Date().toISOString(),
                        action: `Completed maintenance for ${selectedElevators.length} elevators: ${selectedElevators.join(', ')} in project ${maint.projectName}`,
                        user: currentUser ? currentUser.username : 'System'
                    });
                }

                closeModal('multiElevatorCompletionModal');
                await loadData();
                alert(`Successfully completed maintenance for ${selectedElevators.length} elevator(s): ${selectedElevators.join(', ')}`);

            } catch (error) {
                console.error('Error completing multi-elevator maintenance:', error);
                alert('Error completing maintenance: ' + error.message);
            }
        };

        // Generate reports for multi-elevator maintenance
        window.generateMultiElevatorReports = async (maintenanceId) => {
            const maint = maintenance.find(m => m.id === maintenanceId);
            if (!maint) {
                alert('Maintenance record not found.');
                return;
            }

            // Check if this is being called from the completion modal (generate for selected elevators)
            const selectedElevators = Array.from(document.querySelectorAll('input[name="completedElevators"]:checked')).map(cb => cb.value);
            
            if (selectedElevators.length > 0) {
                // Generate single combined report for selected elevators from modal
                const combinedMaint = {
                    ...maint,
                    elevatorId: selectedElevators.join(', '),
                    elevatorList: selectedElevators.join(', '),
                    elevatorCount: selectedElevators.length,
                    elevatorIds: null, // Remove multi-elevator data for report generation
                    // Add current work details from modal
                    workDescription: document.getElementById('multiWorkDescription').value,
                    partsUsed: document.getElementById('multiPartsUsed').value,
                    workCost: document.getElementById('multiWorkCost').value,
                    signatoryName: document.getElementById('multiSignatoryName').value,
                    arrivalTime: new Date().toISOString(),
                    completionTime: new Date().toISOString(),
                    arrivalSignature: document.getElementById('multiArrivalSignatureCanvas')?.toDataURL(),
                    completionSignature: document.getElementById('multiCompletionSignatureCanvas')?.toDataURL()
                };
                await exportMaintenanceReport('', combinedMaint);
                alert(`Generated combined maintenance report for ${selectedElevators.length} elevators: ${selectedElevators.join(', ')}`);
                return;
            }

            // Check for already completed elevators
            if (!maint.completedElevators || maint.completedElevators.length === 0) {
                alert('No completed elevators found for report generation. Please complete some elevators first or select elevators in the completion modal.');
                return;
            }

            // Generate single combined report for all completed elevators
            const combinedMaint = {
                ...maint,
                elevatorId: maint.completedElevators.join(', '),
                elevatorList: maint.completedElevators.join(', '),
                elevatorCount: maint.completedElevators.length,
                elevatorIds: null // Remove multi-elevator data for report generation
            };
            await exportMaintenanceReport('', combinedMaint);
            alert(`Generated combined maintenance report for ${maint.completedElevators.length} completed elevators: ${maint.completedElevators.join(', ')}`);
        };

        window.deleteMaintenance = async (id) => {
            if (!confirm('Are you sure you want to delete this maintenance record?')) return;
            
            const maint = maintenance.find(m => m.id === id);
            
            if (isOnline) {
                await deleteDoc(doc(db, 'maintenance', id));
                await addDoc(collection(db, 'activities'), {
                    date: new Date().toISOString(),
                    action: `Deleted maintenance record for ${maint.elevatorId} in project ${maint.projectName}`,
                    user: currentUser.username
                });
            }

            await loadData();
        };

        // ==================== HR MANAGEMENT FUNCTIONS ====================

        // HR Statistics Functions
        function updateHRStats() {
            const totalEmployeesEl = document.getElementById('totalEmployees');
            const activeEmployeesEl = document.getElementById('activeEmployees');
            const newJoinersEl = document.getElementById('newJoiners');
            const avgSalaryEl = document.getElementById('avgSalary');

            if (totalEmployeesEl) totalEmployeesEl.textContent = employees.length;
            
            const activeEmployees = employees.filter(emp => emp.employeeStatus === 'Active');
            if (activeEmployeesEl) activeEmployeesEl.textContent = activeEmployees.length;

            // New joiners this month
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const newJoiners = employees.filter(emp => {
                if (!emp.joiningDate) return false;
                const joinDate = new Date(emp.joiningDate);
                return joinDate.getMonth() === currentMonth && joinDate.getFullYear() === currentYear;
            });
            if (newJoinersEl) newJoinersEl.textContent = newJoiners.length;

            // Average salary
            const totalSalary = employees.reduce((sum, emp) => sum + (emp.currentSalary || 0), 0);
            const avgSalary = employees.length > 0 ? Math.round(totalSalary / employees.length) : 0;
            if (avgSalaryEl) avgSalaryEl.textContent = `Rs. ${avgSalary.toLocaleString()}`;
        }

        function populateManagerDropdown() {
            const select = document.getElementById('reportingManager');
            if (!select) return;
            
            select.innerHTML = '<option value="">Select Manager</option>';
            
            // Filter employees who can be managers (typically managers, seniors)
            const managers = employees.filter(emp => 
                emp.position && (emp.position.toLowerCase().includes('manager') || 
                               emp.position.toLowerCase().includes('senior') ||
                               emp.systemRole === 'admin')
            );
            
            managers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager.id;
                option.textContent = `${manager.firstName} ${manager.lastName} (${manager.position})`;
                select.appendChild(option);
            });
        }

        // Employee Modal Functions
        window.showAddEmployeeModal = () => {
            document.getElementById('employeeModalTitle').textContent = 'Add Employee';
            document.getElementById('employeeForm').reset();
            document.getElementById('editEmployeeId').value = '';
            document.getElementById('exportEmployeeBtn').style.display = 'none';
            
            // Explicitly clear username and password fields to prevent autocomplete
            document.getElementById('employeeUsername').value = '';
            document.getElementById('employeePassword').value = '';
            
            // Auto-generate employee ID
            const lastEmpId = employees.length > 0 ? 
                Math.max(...employees.map(emp => parseInt(emp.employeeId?.replace(/\D/g, '') || 0))) : 0;
            document.getElementById('employeeId').value = `EMP${String(lastEmpId + 1).padStart(3, '0')}`;
            
            populateManagerDropdown();
            document.getElementById('employeeModal').classList.add('active');
        };

        window.editEmployee = (id) => {
            const employee = employees.find(emp => emp.id === id);
            if (!employee) {
                alert('Employee not found');
                return;
            }
            
            document.getElementById('employeeModalTitle').textContent = 'Edit Employee';
            document.getElementById('editEmployeeId').value = employee.id;
            
            // Personal Information
            document.getElementById('employeeId').value = employee.employeeId || '';
            document.getElementById('firstName').value = employee.firstName || '';
            document.getElementById('lastName').value = employee.lastName || '';
            document.getElementById('email').value = employee.email || '';
            document.getElementById('phone').value = employee.phone || '';
            document.getElementById('dateOfBirth').value = employee.dateOfBirth || '';
            document.getElementById('address').value = employee.address || '';
            document.getElementById('emergencyContact').value = employee.emergencyContact || '';
            
            // Professional Information
            document.getElementById('position').value = employee.position || '';
            document.getElementById('department').value = employee.department || '';
            document.getElementById('joiningDate').value = employee.joiningDate || '';
            document.getElementById('employmentType').value = employee.employmentType || 'Full-Time';
            document.getElementById('reportingManager').value = employee.reportingManager || '';
            document.getElementById('workLocation').value = employee.workLocation || '';
            
            // Salary Information
            document.getElementById('lastSalary').value = employee.lastSalary || '';
            document.getElementById('currentSalary').value = employee.currentSalary || '';
            document.getElementById('salaryEffectiveDate').value = employee.salaryEffectiveDate || '';
            document.getElementById('allowances').value = employee.allowances || '';
            document.getElementById('bonus').value = employee.bonus || '';
            document.getElementById('bankAccount').value = employee.bankAccount || '';
            document.getElementById('bankName').value = employee.bankName || '';
            document.getElementById('ifscCode').value = employee.ifscCode || '';
            document.getElementById('panNumber').value = employee.panNumber || '';
            
            // System Access
            document.getElementById('employeeUsername').value = employee.username || '';
            document.getElementById('employeePassword').value = ''; // Never populate password
            document.getElementById('systemRole').value = employee.systemRole || 'user';
            document.getElementById('employeeStatus').value = employee.employeeStatus || 'Active';
            document.getElementById('lastWorkingDate').value = employee.lastWorkingDate || '';
            document.getElementById('systemStatus').value = employee.systemStatus || 'active';
            
            // Additional Information
            document.getElementById('skills').value = employee.skills || '';
            document.getElementById('notes').value = employee.notes || '';
            
            document.getElementById('exportEmployeeBtn').style.display = 'inline-flex';
            document.getElementById('exportEmployeeBtn').setAttribute('onclick', `exportIndividualHRReport('${employee.id}')`);
            
            populateManagerDropdown();
            document.getElementById('employeeModal').classList.add('active');
        };

        // ==================== END HR MANAGEMENT FUNCTIONS ====================

        window.deleteEmployee = async (id) => {
            const employee = employees.find(emp => emp.id === id);
            if (!employee) {
                alert('Employee not found!');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete employee "${employee.firstName} ${employee.lastName}" (${employee.employeeId})?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                let firebaseDeleted = false;
                
                // Check if we have online capability and Firebase is available
                if (typeof db !== 'undefined' && typeof deleteDoc !== 'undefined' && isOnline !== false) {
                    try {
                        await deleteDoc(doc(db, 'employees', id));
                        firebaseDeleted = true;
                        console.log('Employee deleted from Firebase successfully');
                        
                        // Add activity log
                        if (typeof addDoc !== 'undefined' && typeof collection !== 'undefined') {
                            await addDoc(collection(db, 'activities'), {
                                date: new Date().toISOString(),
                                action: `Deleted employee: ${employee.firstName} ${employee.lastName} (${employee.employeeId})`,
                                user: currentUser?.username || 'System'
                            });
                        }
                    } catch (firebaseError) {
                        console.error('Firebase error during delete:', firebaseError);
                        alert('Error deleting from Firebase: ' + firebaseError.message + '\n\nPlease check your connection and try again.');
                        return; // Don't continue if Firebase delete fails
                    }
                }
                
                // Only proceed with local deletion if Firebase delete was successful or we're offline
                if (firebaseDeleted || typeof db === 'undefined' || !isOnline) {
                    // Remove from local array
                    const index = employees.findIndex(emp => emp.id === id);
                    if (index !== -1) {
                        employees.splice(index, 1);
                        console.log('Employee removed from local array. Remaining employees:', employees.length);
                    }
                    
                    // Update cache
                    localStorage.setItem('cachedEmployees', JSON.stringify(employees));
                    
                    // Refresh display directly instead of reloading from server
                    renderEmployees();
                    updateHRStats();
                    populateManagerDropdown();
                    populateAssigneeFilters();
                    
                    alert('Employee deleted successfully!');
                }
            } catch (error) {
                console.error('Error deleting employee:', error);
                alert('Error deleting employee. Please try again.\n\nError: ' + error.message);
            }
        };

        // Employee Form Submission
        document.getElementById('employeeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const employeeId = document.getElementById('editEmployeeId').value;
            const empIdField = document.getElementById('employeeId').value.trim();
            const username = document.getElementById('employeeUsername').value.trim();
            
            console.log('=== EMPLOYEE FORM SUBMISSION ===');
            console.log('Username from form:', username);
            console.log('Username field element value:', document.getElementById('employeeUsername').value);
            console.log('Current logged-in user:', currentUser?.username);

            // Check for duplicate Employee ID and Username (only if username is not empty)
            const existingEmpId = employees.find(emp => emp.employeeId === empIdField && emp.id !== employeeId);
            const existingUsername = username && username.length > 0 ? employees.find(emp => emp.username === username && emp.id !== employeeId) : null;
            
            if (existingEmpId) {
                alert('Employee ID already exists. Please use a different ID.');
                return;
            }
            
            if (existingUsername) {
                alert(`Username "${username}" already exists. Please use a different username.`);
                return;
            }

            try {
                const employeeData = {
                    // Personal Information
                    employeeId: empIdField,
                    firstName: document.getElementById('firstName').value.trim(),
                    lastName: document.getElementById('lastName').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    phone: document.getElementById('phone').value.trim(),
                    dateOfBirth: document.getElementById('dateOfBirth').value,
                    address: document.getElementById('address').value.trim(),
                    emergencyContact: document.getElementById('emergencyContact').value.trim(),
                    
                    // Professional Information
                    position: document.getElementById('position').value,
                    department: document.getElementById('department').value,
                    joiningDate: document.getElementById('joiningDate').value,
                    employmentType: document.getElementById('employmentType').value,
                    reportingManager: document.getElementById('reportingManager').value,
                    workLocation: document.getElementById('workLocation').value.trim(),
                    
                    // Salary Information
                    lastSalary: parseFloat(document.getElementById('lastSalary').value) || 0,
                    currentSalary: parseFloat(document.getElementById('currentSalary').value) || 0,
                    salaryEffectiveDate: document.getElementById('salaryEffectiveDate').value,
                    allowances: parseFloat(document.getElementById('allowances').value) || 0,
                    bonus: parseFloat(document.getElementById('bonus').value) || 0,
                    bankAccount: document.getElementById('bankAccount').value.trim(),
                    bankName: document.getElementById('bankName').value.trim(),
                    ifscCode: document.getElementById('ifscCode').value.trim(),
                    panNumber: document.getElementById('panNumber').value.trim(),
                    
                    // System Access
                    username: username.toLowerCase().trim(),
                    systemRole: document.getElementById('systemRole').value,
                    employeeStatus: document.getElementById('employeeStatus').value,
                    lastWorkingDate: document.getElementById('lastWorkingDate').value,
                    systemStatus: document.getElementById('systemStatus').value,
                    
                    // Additional Information
                    skills: document.getElementById('skills').value.trim(),
                    notes: document.getElementById('notes').value.trim(),
                    
                    // Metadata
                    lastModified: new Date().toISOString(),
                    modifiedBy: currentUser?.username || 'System'
                };

                // Only include password if it's provided (for updates, password is optional)
                const password = document.getElementById('employeePassword').value?.trim() || '';
                if (password.length > 0) {
                    employeeData.password = password;
                }

                // For new employees, password is required
                if (!employeeId && password.length === 0) {
                    alert('Password is required for new employees.');
                    return;
                }

                // Add creation metadata for new employees
                if (!employeeId) {
                    employeeData.createdDate = new Date().toISOString();
                    employeeData.createdBy = currentUser?.username || 'System';
                }

                try {
                    // Check if we have online capability and Firebase is available
                    console.log('=== Saving employee ===');
                    console.log('Employee data:', JSON.stringify(employeeData, null, 2));
                    console.log('isOnline:', isOnline, 'db available:', typeof db !== 'undefined');
                    
                    if (typeof db !== 'undefined' && typeof updateDoc !== 'undefined' && isOnline !== false) {
                        try {
                            if (employeeId) {
                                await updateDoc(doc(db, 'employees', employeeId), employeeData);
                                console.log('‚úÖ Employee updated in Firebase:', employeeId);
                                // Add activity log
                                if (typeof addDoc !== 'undefined' && typeof collection !== 'undefined') {
                                    await addDoc(collection(db, 'activities'), {
                                        date: new Date().toISOString(),
                                        action: `Updated employee: ${employeeData.firstName} ${employeeData.lastName} (${employeeData.employeeId})`,
                                        user: currentUser?.username || 'System'
                                    });
                                }
                            } else {
                                const docRef = await addDoc(collection(db, 'employees'), employeeData);
                                employeeData.id = docRef.id;
                                console.log('‚úÖ Employee added to Firebase with ID:', docRef.id);
                                console.log('Employee username:', employeeData.username, 'Password set:', !!employeeData.password, 'Status:', employeeData.systemStatus);
                                // Add activity log
                                if (typeof addDoc !== 'undefined' && typeof collection !== 'undefined') {
                                    await addDoc(collection(db, 'activities'), {
                                        date: new Date().toISOString(),
                                        action: `Added new employee: ${employeeData.firstName} ${employeeData.lastName} (${employeeData.employeeId})`,
                                        user: currentUser?.username || 'System'
                                    });
                                }
                            }
                        } catch (firebaseError) {
                            console.error('‚ùå Firebase error during save:', firebaseError);
                            console.error('Error details:', firebaseError.message, firebaseError.stack);
                            // Continue with local save even if Firebase fails
                        }
                    } else {
                        console.log('‚ö†Ô∏è Firebase not available or offline, saving locally only');
                    }
                    
                    // Update local data
                    if (employeeId) {
                        const index = employees.findIndex(emp => emp.id === employeeId);
                        if (index !== -1) {
                            employees[index] = { ...employees[index], ...employeeData, id: employeeId };
                            console.log('Employee updated in local array');
                        }
                    } else {
                        // Generate a local ID if not from Firebase
                        if (!employeeData.id) {
                            employeeData.id = 'local_' + Date.now();
                        }
                        employees.push(employeeData);
                        console.log('Employee added to local array');
                    }
                    
                    // Update cache
                    localStorage.setItem('cachedEmployees', JSON.stringify(employees));

                } catch (dbError) {
                    console.error('Database operation failed:', dbError);
                    // For offline or local-only usage, still save locally
                    if (employeeId) {
                        const index = employees.findIndex(emp => emp.id === employeeId);
                        if (index !== -1) {
                            employees[index] = { ...employees[index], ...employeeData, id: employeeId };
                        }
                    } else {
                        employeeData.id = 'local_' + Date.now();
                        employees.push(employeeData);
                    }
                    localStorage.setItem('cachedEmployees', JSON.stringify(employees));
                }

                closeModal('employeeModal');
                
                // Immediately update UI with local data
                renderEmployees();
                updateHRStats();
                populateManagerDropdown();
                populateAssigneeFilters();
                
                alert(employeeId ? 'Employee updated successfully!' : 'Employee added successfully!');
                
                // Wait a moment for Firebase to commit, then reload to sync
                setTimeout(async () => {
                    try {
                        console.log('Reloading employees after save...');
                        await loadEmployees();
                        console.log('Employees reloaded successfully');
                    } catch (loadError) {
                        console.error('Error reloading employees:', loadError);
                        // Already rendered above, so no fallback needed
                    }
                }, 1000); // Wait 1 second for Firebase to commit
            } catch (error) {
                console.error('Error saving employee:', error);
                alert('Error saving employee: ' + error.message);
            }
        });

        // HR Filtering Functions
        window.filterEmployees = () => {
            const searchValue = document.getElementById('searchEmployees').value.toLowerCase();
            const departmentValue = document.getElementById('departmentFilter').value;
            const statusValue = document.getElementById('statusFilter').value;
            const positionValue = document.getElementById('positionFilter').value;
            
            const rows = document.querySelectorAll('#employeesList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matchesSearch = searchValue === '' || text.includes(searchValue);
                const matchesDepartment = departmentValue === '' || text.includes(departmentValue.toLowerCase());
                const matchesStatus = statusValue === '' || text.includes(statusValue.toLowerCase());
                const matchesPosition = positionValue === '' || text.includes(positionValue.toLowerCase());
                
                row.style.display = (matchesSearch && matchesDepartment && matchesStatus && matchesPosition) ? '' : 'none';
            });
        };

        // HR Export Functions with Enhanced Branding
        window.exportIndividualHRReport = async (employeeId) => {
            let employee;
            
            if (employeeId) {
                employee = employees.find(emp => emp.id === employeeId);
                if (!employee) {
                    alert('Employee not found');
                    return;
                }
            } else {
                // Get employee data from form if called from modal
                const editId = document.getElementById('editEmployeeId').value;
                employee = editId ? employees.find(emp => emp.id === editId) : {
                    employeeId: document.getElementById('employeeId').value,
                    firstName: document.getElementById('firstName').value,
                    lastName: document.getElementById('lastName').value,
                    email: document.getElementById('email').value,
                    phone: document.getElementById('phone').value,
                    position: document.getElementById('position').value,
                    department: document.getElementById('department').value,
                    currentSalary: parseFloat(document.getElementById('currentSalary').value) || 0
                };
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4');

                // Enhanced header with proper branding
                const primaryColor = [37, 99, 235]; // Blue
                const darkColor = [15, 23, 42]; // Dark gray
                const grayColor = [100, 116, 139]; // Medium gray
                const accentColor = [16, 163, 74]; // Green

                // Company branding header with gradient effect
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 595, 80, 'F');
                
                // Add a subtle gradient effect with lighter blue
                doc.setFillColor(59, 130, 246);
                doc.rect(0, 60, 595, 20, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(28);
                doc.setFont(undefined, 'bold');
                doc.text('AVANT ELEVATORS', 40, 35);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Professional Elevator Solutions', 40, 50);
                doc.text('Human Resources Management System', 40, 65);

                // Company logo placeholder (right side)
                doc.setFillColor(255, 255, 255);
                doc.rect(450, 15, 120, 50, 'F');
                doc.setDrawColor(...primaryColor);
                doc.setLineWidth(2);
                doc.rect(450, 15, 120, 50);
                doc.setTextColor(...primaryColor);
                doc.setFontSize(10);
                doc.text('AMBIVARE.PNG', 480, 35);
                doc.text('LOGO HERE', 485, 50);

                let yPos = 120;
                
                // Employee Information Header
                doc.setFillColor(248, 250, 252);
                doc.rect(40, yPos - 20, 515, 40, 'F');
                doc.setFontSize(20);
                doc.setTextColor(...darkColor);
                doc.setFont(undefined, 'bold');
                doc.text('EMPLOYEE INFORMATION REPORT', 50, yPos);
                
                yPos += 30;
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 50, yPos);
                doc.text(`Report ID: EMP-${employee.employeeId}-${new Date().getTime()}`, 350, yPos);
                
                yPos += 50;

                // Personal Information Section
                doc.setFillColor(240, 249, 255);
                doc.rect(40, yPos - 15, 515, 25, 'F');
                doc.setTextColor(...primaryColor);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('üë§ PERSONAL INFORMATION', 50, yPos);
                yPos += 30;

                const personalInfo = [
                    ['Employee ID:', employee.employeeId || 'N/A'],
                    ['Full Name:', `${employee.firstName || ''} ${employee.lastName || ''}`],
                    ['Email Address:', employee.email || 'N/A'],
                    ['Phone Number:', employee.phone || 'N/A'],
                    ['Date of Birth:', employee.dateOfBirth ? new Date(employee.dateOfBirth).toLocaleDateString() : 'N/A'],
                    ['Address:', employee.address || 'N/A'],
                    ['Emergency Contact:', employee.emergencyContact || 'N/A']
                ];

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                personalInfo.forEach(([label, value]) => {
                    doc.setTextColor(...darkColor);
                    doc.setFont(undefined, 'bold');
                    doc.text(label, 50, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(...grayColor);
                    
                    // Handle long text wrapping
                    const maxWidth = 300;
                    const wrappedText = doc.splitTextToSize(String(value), maxWidth);
                    doc.text(wrappedText, 180, yPos);
                    yPos += Math.max(18, wrappedText.length * 12);
                });

                yPos += 20;

                // Professional Information Section
                doc.setFillColor(240, 253, 244);
                doc.rect(40, yPos - 15, 515, 25, 'F');
                doc.setTextColor(...accentColor);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('üíº PROFESSIONAL INFORMATION', 50, yPos);
                yPos += 30;

                const joiningDate = employee.joiningDate ? new Date(employee.joiningDate) : null;
                const serviceYears = joiningDate ? ((new Date() - joiningDate) / (1000 * 60 * 60 * 24 * 365)).toFixed(1) : '0';

                const professionalInfo = [
                    ['Position:', employee.position || 'N/A'],
                    ['Department:', employee.department || 'N/A'],
                    ['Joining Date:', joiningDate ? joiningDate.toLocaleDateString() : 'N/A'],
                    ['Years of Service:', `${serviceYears} years`],
                    ['Employment Type:', employee.employmentType || 'N/A'],
                    ['Work Location:', employee.workLocation || 'N/A'],
                    ['Employment Status:', employee.employeeStatus || 'Active'],
                    ['Last Working Date:', employee.lastWorkingDate ? new Date(employee.lastWorkingDate).toLocaleDateString() : 'N/A']
                ];

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                professionalInfo.forEach(([label, value]) => {
                    doc.setTextColor(...darkColor);
                    doc.setFont(undefined, 'bold');
                    doc.text(label, 50, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(...grayColor);
                    doc.text(String(value), 180, yPos);
                    yPos += 18;
                });

                yPos += 20;

                // Salary Information Section
                doc.setFillColor(254, 242, 242);
                doc.rect(40, yPos - 15, 515, 25, 'F');
                doc.setTextColor(220, 38, 38);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('üí∞ SALARY INFORMATION', 50, yPos);
                yPos += 30;

                const salaryInfo = [
                    ['Previous Salary:', employee.lastSalary ? `Rs. ${employee.lastSalary.toLocaleString()}` : 'N/A'],
                    ['Current Monthly Salary:', employee.currentSalary ? `Rs. ${employee.currentSalary.toLocaleString()}` : 'N/A'],
                    ['Monthly Allowances:', employee.allowances ? `Rs. ${employee.allowances.toLocaleString()}` : 'N/A'],
                    ['Annual Bonus:', employee.bonus ? `Rs. ${employee.bonus.toLocaleString()}` : 'N/A'],
                    ['Gross Monthly Pay:', employee.currentSalary ? `Rs. ${((employee.currentSalary || 0) + (employee.allowances || 0)).toLocaleString()}` : 'N/A'],
                    ['Annual Package:', employee.currentSalary ? `Rs. ${(((employee.currentSalary || 0) + (employee.allowances || 0)) * 12 + (employee.bonus || 0)).toLocaleString()}` : 'N/A']
                ];

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                salaryInfo.forEach(([label, value]) => {
                    doc.setTextColor(...darkColor);
                    doc.setFont(undefined, 'bold');
                    doc.text(label, 50, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(...grayColor);
                    doc.text(String(value), 200, yPos);
                    yPos += 18;
                });

                // Add new page if needed
                if (yPos > 680) {
                    doc.addPage();
                    yPos = 40;
                }

                yPos += 20;

                // Banking Information Section
                doc.setFillColor(255, 247, 237);
                doc.rect(40, yPos - 15, 515, 25, 'F');
                doc.setTextColor(234, 88, 12);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('üè¶ BANKING INFORMATION', 50, yPos);
                yPos += 30;

                const bankingInfo = [
                    ['Bank Account Number:', employee.bankAccount || 'N/A'],
                    ['Bank Name:', employee.bankName || 'N/A'],
                    ['IFSC Code:', employee.ifscCode || 'N/A'],
                    ['PAN Number:', employee.panNumber || 'N/A']
                ];

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                bankingInfo.forEach(([label, value]) => {
                    doc.setTextColor(...darkColor);
                    doc.setFont(undefined, 'bold');
                    doc.text(label, 50, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(...grayColor);
                    doc.text(String(value), 200, yPos);
                    yPos += 18;
                });

                yPos += 20;

                // System Access Section
                doc.setFillColor(238, 242, 255);
                doc.rect(40, yPos - 15, 515, 25, 'F');
                doc.setTextColor(124, 58, 237);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('üîê SYSTEM ACCESS', 50, yPos);
                yPos += 30;

                const systemInfo = [
                    ['Username:', employee.username || 'N/A'],
                    ['System Role:', employee.systemRole ? employee.systemRole.toUpperCase() : 'N/A'],
                    ['Access Status:', employee.systemStatus ? employee.systemStatus.toUpperCase() : 'N/A']
                ];

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                systemInfo.forEach(([label, value]) => {
                    doc.setTextColor(...darkColor);
                    doc.setFont(undefined, 'bold');
                    doc.text(label, 50, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(...grayColor);
                    doc.text(String(value), 180, yPos);
                    yPos += 18;
                });

                // Skills and Additional Info
                if (employee.skills || employee.notes) {
                    yPos += 20;
                    doc.setFillColor(250, 250, 250);
                    doc.rect(40, yPos - 15, 515, 25, 'F');
                    doc.setTextColor(...darkColor);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('üìù ADDITIONAL INFORMATION', 50, yPos);
                    yPos += 30;

                    if (employee.skills) {
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(10);
                        doc.text('Skills & Qualifications:', 50, yPos);
                        yPos += 15;
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(...grayColor);
                        const skillsLines = doc.splitTextToSize(employee.skills, 500);
                        skillsLines.forEach(line => {
                            doc.text(line, 50, yPos);
                            yPos += 12;
                        });
                        yPos += 10;
                    }

                    if (employee.notes) {
                        doc.setTextColor(...darkColor);
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(10);
                        doc.text('Notes:', 50, yPos);
                        yPos += 15;
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(...grayColor);
                        const notesLines = doc.splitTextToSize(employee.notes, 500);
                        notesLines.forEach(line => {
                            doc.text(line, 50, yPos);
                            yPos += 12;
                        });
                    }
                }

                // Enhanced Footer with branding
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    
                    // Footer line
                    doc.setDrawColor(...primaryColor);
                    doc.setLineWidth(1);
                    doc.line(40, 800, 555, 800);
                    
                    doc.setFontSize(8);
                    doc.setTextColor(...grayColor);
                    doc.text(`Page ${i} of ${pageCount}`, 297, 815, { align: 'center' });
                    doc.text('Avant Elevators - Confidential HR Document', 40, 815);
                    doc.text('This document contains confidential employee information', 350, 815);
                    
                    // Company info in footer
                    doc.setFontSize(7);
                    doc.text('Professional Elevator Solutions | avantelevator@gmail.com', 40, 825);
                }

                const fileName = `HR_Report_${employee.employeeId}_${employee.firstName}_${employee.lastName}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);

            } catch (error) {
                console.error('Error generating individual HR report:', error);
                alert('Error generating individual HR report: ' + error.message);
            }
        };

        window.exportAllHRPDF = async () => {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'pt', 'a4');
                
                // Enhanced header with proper branding
                const primaryColor = [37, 99, 235];
                const darkColor = [15, 23, 42];
                const grayColor = [100, 116, 139];

                // Company branding header
                doc.setFillColor(...primaryColor);
                doc.rect(0, 0, 842, 70, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('AVANT ELEVATORS', 40, 30);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Human Resources Management System - Complete Employee Database', 40, 50);

                // Logo placeholder
                doc.setFillColor(255, 255, 255);
                doc.rect(720, 15, 100, 40, 'F');
                doc.setDrawColor(...primaryColor);
                doc.setLineWidth(2);
                doc.rect(720, 15, 100, 40);
                doc.setTextColor(...primaryColor);
                doc.setFontSize(8);
                doc.text('AMBIVARE.PNG', 745, 35);

                let yPos = 100;
                doc.setTextColor(...darkColor);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text('COMPLETE HR REPORT', 40, yPos);
                
                yPos += 30;
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 40, yPos);
                doc.text(`Total Employees: ${employees.length}`, 40, yPos + 15);
                doc.text(`Active Employees: ${employees.filter(emp => emp.employeeStatus === 'Active').length}`, 250, yPos + 15);
                
                yPos += 50;

                // Table headers
                const headers = ['Emp ID', 'Name', 'Position', 'Department', 'Joining Date', 'Salary', 'Status', 'Contact'];
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(...darkColor);
                
                const columnWidths = [60, 120, 90, 90, 80, 80, 60, 130];
                let xPos = 40;
                
                // Header background
                doc.setFillColor(248, 250, 252);
                doc.rect(40, yPos - 15, 750, 25, 'F');
                
                headers.forEach((header, i) => {
                    doc.text(header, xPos, yPos);
                    xPos += columnWidths[i];
                });
                
                // Header underline
                doc.setLineWidth(1);
                doc.setDrawColor(...primaryColor);
                doc.line(40, yPos + 5, 790, yPos + 5);
                
                yPos += 25;

                // Employee data
                employees.forEach((emp, index) => {
                    if (yPos > 520) {
                        doc.addPage();
                        yPos = 40;
                        
                        // Repeat headers on new page
                        xPos = 40;
                        doc.setFillColor(248, 250, 252);
                        doc.rect(40, yPos - 15, 750, 25, 'F');
                        headers.forEach((header, i) => {
                            doc.text(header, xPos, yPos);
                            xPos += columnWidths[i];
                        });
                        doc.line(40, yPos + 5, 790, yPos + 5);
                        yPos += 25;
                    }

                    // Alternate row background
                    if (index % 2 === 0) {
                        doc.setFillColor(250, 251, 252);
                        doc.rect(40, yPos - 10, 750, 20, 'F');
                    }

                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(8);
                    doc.setTextColor(...grayColor);
                    
                    const rowData = [
                        emp.employeeId || 'N/A',
                        `${emp.firstName || ''} ${emp.lastName || ''}`.trim() || 'N/A',
                        emp.position || 'N/A',
                        emp.department || 'N/A',
                        emp.joiningDate ? new Date(emp.joiningDate).toLocaleDateString() : 'N/A',
                        emp.currentSalary ? `Rs. ${(emp.currentSalary / 1000).toFixed(0)}k` : 'N/A',
                        emp.employeeStatus || 'Active',
                        emp.phone || 'N/A'
                    ];

                    xPos = 40;
                    rowData.forEach((data, i) => {
                        const text = doc.splitTextToSize(String(data), columnWidths[i] - 5);
                        doc.text(text[0] || '', xPos, yPos);
                        xPos += columnWidths[i];
                    });
                    
                    yPos += 18;
                });

                // Summary section
                if (yPos > 450) {
                    doc.addPage();
                    yPos = 40;
                }

                yPos += 40;
                doc.setFillColor(240, 249, 255);
                doc.rect(40, yPos - 20, 750, 30, 'F');
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(...primaryColor);
                doc.text('HR SUMMARY & STATISTICS', 50, yPos);
                
                yPos += 40;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(...darkColor);

                const departments = [...new Set(employees.map(emp => emp.department).filter(Boolean))];
                const totalSalary = employees.reduce((sum, emp) => sum + (emp.currentSalary || 0), 0);
                const avgSalary = employees.length > 0 ? totalSalary / employees.length : 0;

                const summaryData = [
                    `Total Employees: ${employees.length}`,
                    `Active Employees: ${employees.filter(emp => emp.employeeStatus === 'Active').length}`,
                    `Resigned/Terminated: ${employees.filter(emp => emp.employeeStatus === 'Resigned' || emp.employeeStatus === 'Terminated').length}`,
                    `Departments: ${departments.length} (${departments.join(', ')})`,
                    `Average Monthly Salary: Rs. ${avgSalary.toLocaleString()}`,
                    `Total Monthly Payroll: Rs. ${totalSalary.toLocaleString()}`,
                    `Annual Payroll Cost: Rs. ${(totalSalary * 12).toLocaleString()}`
                ];

                summaryData.forEach(data => {
                    doc.text(data, 50, yPos);
                    yPos += 18;
                });

                // Footer with enhanced branding
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    
                    // Footer line
                    doc.setDrawColor(...primaryColor);
                    doc.setLineWidth(1);
                    doc.line(40, 570, 800, 570);
                    
                    doc.setFontSize(8);
                    doc.setTextColor(...grayColor);
                    doc.text(`Page ${i} of ${pageCount}`, 421, 585, { align: 'center' });
                    doc.text('Avant Elevators - Confidential HR Report', 40, 585);
                    doc.text('Professional Elevator Solutions | avantelevator@gmail.com', 580, 585);
                }
                
                doc.save(`Complete_HR_Report_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error generating complete HR report:', error);
                alert('Error generating complete HR report: ' + error.message);
            }
        };

        window.exportPayrollReport = async () => {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'pt', 'a4');
                
                const primaryColor = [37, 99, 235];
                const darkColor = [15, 23, 42];
                const grayColor = [100, 116, 139];
                const accentColor = [16, 163, 74];

                // Enhanced Header
                doc.setFillColor(...accentColor);
                doc.rect(0, 0, 842, 70, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont(undefined, 'bold');
                doc.text('AVANT ELEVATORS', 40, 30);
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'normal');
                doc.text('Monthly Payroll Report', 40, 50);

                // Logo placeholder
                doc.setFillColor(255, 255, 255);
                doc.rect(720, 15, 100, 40, 'F');
                doc.setDrawColor(...accentColor);
                doc.setLineWidth(2);
                doc.rect(720, 15, 100, 40);
                doc.setTextColor(...accentColor);
                doc.setFontSize(8);
                doc.text('AMBIVARE.PNG', 745, 35);

                let yPos = 100;
                doc.setTextColor(...darkColor);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text(`PAYROLL REPORT - ${new Date().toLocaleString('default', { month: 'long', year: 'numeric' })}`, 40, yPos);
                
                yPos += 50;

                // Summary cards
                const activeEmployees = employees.filter(emp => emp.employeeStatus === 'Active');
                const totalEmployees = activeEmployees.length;
                const totalSalary = activeEmployees.reduce((sum, emp) => sum + (emp.currentSalary || 0), 0);
                const totalAllowances = activeEmployees.reduce((sum, emp) => sum + (emp.allowances || 0), 0);
                const totalPayroll = totalSalary + totalAllowances;

                // Summary section background
                doc.setFillColor(240, 253, 244);
                doc.rect(40, yPos - 20, 750, 40, 'F');

                doc.setFontSize(12);
                doc.setTextColor(...darkColor);
                doc.text(`Active Employees: ${totalEmployees}`, 50, yPos);
                doc.text(`Total Basic Salary: Rs. ${totalSalary.toLocaleString()}`, 200, yPos);
                doc.text(`Total Allowances: Rs. ${totalAllowances.toLocaleString()}`, 400, yPos);
                doc.text(`Total Monthly Payroll: Rs. ${totalPayroll.toLocaleString()}`, 580, yPos);
                
                yPos += 60;

                // Table
                const headers = ['Emp ID', 'Employee Name', 'Position', 'Basic Salary', 'Allowances', 'Gross Salary', 'Bank Details'];
                const columnWidths = [70, 140, 100, 90, 80, 90, 120];
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(...darkColor);
                
                // Header background
                doc.setFillColor(248, 250, 252);
                doc.rect(40, yPos - 15, 740, 25, 'F');
                
                let xPos = 40;
                headers.forEach((header, i) => {
                    doc.text(header, xPos, yPos);
                    xPos += columnWidths[i];
                });
                
                doc.setDrawColor(...accentColor);
                doc.line(40, yPos + 5, 780, yPos + 5);
                yPos += 25;

                activeEmployees.forEach((emp, index) => {
                    if (yPos > 520) {
                        doc.addPage();
                        yPos = 40;
                        
                        // Repeat headers
                        doc.setFillColor(248, 250, 252);
                        doc.rect(40, yPos - 15, 740, 25, 'F');
                        xPos = 40;
                        headers.forEach((header, i) => {
                            doc.text(header, xPos, yPos);
                            xPos += columnWidths[i];
                        });
                        doc.line(40, yPos + 5, 780, yPos + 5);
                        yPos += 25;
                    }

                    // Alternate row background
                    if (index % 2 === 0) {
                        doc.setFillColor(250, 251, 252);
                        doc.rect(40, yPos - 10, 740, 20, 'F');
                    }

                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(8);
                    doc.setTextColor(...grayColor);
                    
                    const basicSalary = emp.currentSalary || 0;
                    const allowances = emp.allowances || 0;
                    const grossSalary = basicSalary + allowances;
                    
                    const rowData = [
                        emp.employeeId || 'N/A',
                        `${emp.firstName || ''} ${emp.lastName || ''}`.trim(),
                        emp.position || 'N/A',
                        `Rs. ${basicSalary.toLocaleString()}`,
                        `Rs. ${allowances.toLocaleString()}`,
                        `Rs. ${grossSalary.toLocaleString()}`,
                        emp.bankAccount ? `${emp.bankAccount}\n${emp.bankName || ''}` : 'N/A'
                    ];

                    xPos = 40;
                    rowData.forEach((data, i) => {
                        const lines = String(data).split('\n');
                        lines.forEach((line, lineIndex) => {
                            doc.text(line, xPos, yPos + (lineIndex * 10));
                        });
                        xPos += columnWidths[i];
                    });
                    
                    yPos += 20;
                });

                // Footer totals
                if (yPos > 480) {
                    doc.addPage();
                    yPos = 40;
                }

                yPos += 30;
                doc.setFillColor(255, 247, 237);
                doc.rect(40, yPos - 20, 740, 40, 'F');
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(234, 88, 12);
                doc.text('PAYROLL SUMMARY', 50, yPos);
                
                yPos += 30;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(...darkColor);
                doc.text(`Total Monthly Payroll: Rs. ${totalPayroll.toLocaleString()}`, 50, yPos);
                doc.text(`Annual Payroll Cost: Rs. ${(totalPayroll * 12).toLocaleString()}`, 300, yPos);
                doc.text(`Average Salary per Employee: Rs. ${totalEmployees > 0 ? Math.round(totalPayroll / totalEmployees).toLocaleString() : '0'}`, 550, yPos);

                // Enhanced Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    
                    doc.setDrawColor(...accentColor);
                    doc.setLineWidth(1);
                    doc.line(40, 570, 800, 570);
                    
                    doc.setFontSize(8);
                    doc.setTextColor(...grayColor);
                    doc.text(`Page ${i} of ${pageCount}`, 421, 585, { align: 'center' });
                    doc.text('Avant Elevators - Confidential Payroll Report', 40, 585);
                    doc.text('Professional Elevator Solutions | avantelevator@gmail.com', 580, 585);
                }
                
                doc.save(`Payroll_Report_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error generating payroll report:', error);
                alert('Error generating payroll report: ' + error.message);
            }
        };

        // ==================== SALARY SLIP FUNCTIONS ====================

        // Company constants for salary slips
        const COMPANY_NAME = 'Avant Elevators';
        const COMPANY_TAGLINE = 'Professional Elevator Solutions';
        const COMPANY_EMAIL = 'avantelevator@gmail.com';
        const COMPANY_PHONE = '7900020220';

        window.showSalarySlipModal = () => {
            populateSalaryEmployeeDropdown();
            document.getElementById('salarySlipModal').classList.add('active');
        };

        function populateSalaryEmployeeDropdown() {
            const select = document.getElementById('salaryEmployee');
            select.innerHTML = '<option value="">Select Employee</option>';
            
            const activeEmployees = employees.filter(emp => emp.employeeStatus === 'Active');
            activeEmployees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.id;
                option.textContent = `${emp.firstName} ${emp.lastName} (${emp.employeeId}) - ${emp.position}`;
                select.appendChild(option);
            });
        }

        window.populateEmployeeDetails = () => {
            const employeeId = document.getElementById('salaryEmployee').value;
            if (!employeeId) return;
            
            const employee = employees.find(emp => emp.id === employeeId);
            if (employee) {
                document.getElementById('grossSalary').value = employee.currentSalary || 0;
            }
        };

        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN').format(num);
        }

        // Calculate and display overtime preview in real-time
        window.calculateOvertimePreview = () => {
            const grossSalary = parseFloat(document.getElementById('grossSalary').value) || 0;
            const totalWorkingDays = parseFloat(document.getElementById('totalWorkingDays').value) || 30;
            const overtimeHours = parseFloat(document.getElementById('overtimeHours').value) || 0;
            
            // Calculate hourly rate (assuming 8 hours per day)
            const hourlyRate = (grossSalary / totalWorkingDays) / 8;
            const overtimeAmount = overtimeHours * hourlyRate;
            
            // Update the display
            document.getElementById('overtimePreview').textContent = 'Rs. ' + formatNumber(overtimeAmount.toFixed(2));
            document.getElementById('overtimeRatePreview').textContent = '@ Rs. ' + formatNumber(hourlyRate.toFixed(2)) + '/hr';
        };

        // Calculate salary components display
        window.calculateSalaryComponents = () => {
            const grossSalary = parseFloat(document.getElementById('grossSalary').value) || 0;
            const basicPercent = parseFloat(document.getElementById('basicSalaryPercent').value) || 50;
            const hra = parseFloat(document.getElementById('hra').value) || 0;
            const transport = parseFloat(document.getElementById('transportAllowance').value) || 0;
            const medical = parseFloat(document.getElementById('medicalAllowance').value) || 0;
            const other = parseFloat(document.getElementById('otherAllowances').value) || 0;
            
            const basicSalary = (grossSalary * basicPercent) / 100;
            const totalComponents = basicSalary + hra + transport + medical + other;
            
            document.getElementById('totalSalaryDisplay').textContent = `Rs. ${formatNumber(totalComponents.toFixed(2))}`;
        };

        // Auto-distribute remaining 50% salary into components
        window.autoDistributeSalary = () => {
            const grossSalary = parseFloat(document.getElementById('grossSalary').value) || 0;
            if (grossSalary === 0) {
                alert('Please enter gross salary first!');
                return;
            }
            
            const basicPercent = parseFloat(document.getElementById('basicSalaryPercent').value) || 50;
            const basicSalary = (grossSalary * basicPercent) / 100;
            const remainingAmount = grossSalary - basicSalary;
            
            // Distribute remaining amount: 40% HRA, 20% Transport, 20% Medical, 20% Other
            const hra = (remainingAmount * 0.40);
            const transport = (remainingAmount * 0.20);
            const medical = (remainingAmount * 0.20);
            const other = (remainingAmount * 0.20);
            
            document.getElementById('hra').value = Math.round(hra);
            document.getElementById('transportAllowance').value = Math.round(transport);
            document.getElementById('medicalAllowance').value = Math.round(medical);
            document.getElementById('otherAllowances').value = Math.round(other);
            
            calculateSalaryComponents();
            alert(`Salary distributed successfully!\n\nBasic: Rs. ${formatNumber(Math.round(basicSalary))}\nHRA: Rs. ${formatNumber(Math.round(hra))}\nTransport: Rs. ${formatNumber(Math.round(transport))}\nMedical: Rs. ${formatNumber(Math.round(medical))}\nOther: Rs. ${formatNumber(Math.round(other))}`);
        };

        window.generateSalarySlip = async () => {
            // Validation
            const employeeId = document.getElementById('salaryEmployee').value;
            const salaryMonth = document.getElementById('salaryMonth').value;
            const grossSalary = parseFloat(document.getElementById('grossSalary').value) || 0;
            const presentDays = parseFloat(document.getElementById('presentDaysInput').value);

            if (!employeeId) {
                alert('Please select an employee!');
                return;
            }
            if (!salaryMonth) {
                alert('Please select a month!');
                return;
            }
            if (grossSalary === 0) {
                alert('Please enter gross salary!');
                return;
            }
            if (isNaN(presentDays)) {
                alert('Please enter present days!');
                return;
            }

            const employee = employees.find(emp => emp.id === employeeId);
            if (!employee) {
                alert('Employee not found!');
                return;
            }

            try {
                // Ensure jsPDF is loaded
                if (typeof window.jspdf === 'undefined') {
                    alert('PDF library is loading... Please wait a moment and try again.');
                    return;
                }

                // Generate PDF
                await generateSalarySlipPDF({
                    employee: employee,
                    month: salaryMonth,
                    grossSalary: grossSalary,
                    basicPercent: parseFloat(document.getElementById('basicSalaryPercent').value) || 50,
                    totalWorkingDays: parseFloat(document.getElementById('totalWorkingDays').value) || 30,
                    presentDays: presentDays,
                    paidLeaves: parseFloat(document.getElementById('paidLeavesAvailable').value) || 0,
                    leavesUsed: parseFloat(document.getElementById('leavesUsedInput').value) || 0,
                    enablePF: document.getElementById('enablePF').checked,
                    enableESIC: document.getElementById('enableESIC').checked,
                    hra: parseFloat(document.getElementById('hra').value) || 0,
                    transport: parseFloat(document.getElementById('transportAllowance').value) || 0,
                    medical: parseFloat(document.getElementById('medicalAllowance').value) || 0,
                    otherAllowances: parseFloat(document.getElementById('otherAllowances').value) || 0,
                    bonus: parseFloat(document.getElementById('bonus').value) || 0,
                    bonusDesc: document.getElementById('bonusDescription').value || '',
                    incentives: parseFloat(document.getElementById('incentives').value) || 0,
                    incentivesDesc: document.getElementById('incentivesDescription').value || '',
                    otherDeductions: parseFloat(document.getElementById('otherDeductions').value) || 0,
                    deductionDesc: document.getElementById('deductionDescription').value || '',
                    overtimeHours: parseFloat(document.getElementById('overtimeHours').value) || 0
                });
            } catch (error) {
                console.error('Error generating salary slip:', error);
                alert('Error generating salary slip: ' + error.message);
            }
        };

        async function generateSalarySlipPDF(salaryData) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('portrait', 'mm', 'a4');

            const pageWidth = 210;
            const pageHeight = 297;
            const margin = 15;

            // Colors - Blue theme
            const primaryBlue = [37, 99, 235];
            const lightBlue = [219, 234, 254];
            const darkText = [15, 23, 42];
            const grayText = [100, 116, 139];
            const borderGray = [226, 232, 240];

            // Calculations
            const basicSalary = (salaryData.grossSalary * salaryData.basicPercent) / 100;
            const pfDeduction = salaryData.enablePF ? basicSalary * 0.12 : 0;
            const esicDeduction = salaryData.enableESIC ? salaryData.grossSalary * 0.0075 : 0;

            const payableDays = salaryData.presentDays + Math.min(salaryData.leavesUsed, salaryData.paidLeaves);
            const dailyWage = salaryData.grossSalary / salaryData.totalWorkingDays;
            const grossEarnings = dailyWage * payableDays;

            // Calculate per hour rate (assuming 8 hours per day)
            const hourlyRate = (salaryData.grossSalary / salaryData.totalWorkingDays) / 8;
            const autoOvertimeAmount = salaryData.overtimeHours * hourlyRate;

            const totalEarnings = grossEarnings + salaryData.bonus + salaryData.incentives + autoOvertimeAmount;
            const totalDeductions = pfDeduction + esicDeduction + salaryData.otherDeductions;
            const netSalary = totalEarnings - totalDeductions;

            // Convert month text
            const monthName = (new Date(salaryData.month + '-01')).toLocaleString('en-IN', { month: 'long', year: 'numeric' });

            let yPos = margin;

            // ===== LETTERHEAD =====
            // Top border line
            pdf.setDrawColor(...primaryBlue);
            pdf.setLineWidth(3);
            pdf.line(0, 0, pageWidth, 0);

            // Company name and logo area - LEFT SIDE
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(22);
            pdf.setTextColor(...primaryBlue);
            pdf.text('AVANT ELEVATORS', margin, yPos + 10);

            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(9);
            pdf.setTextColor(...grayText);
            pdf.text('Elevator Services', margin, yPos + 16);

            // Contact details - RIGHT SIDE
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(9);
            pdf.setTextColor(...darkText);
            
            const rightX = pageWidth - margin;
            pdf.text('Email: ' + (companySettings?.email || 'avantelevator@gmail.com'), rightX, yPos + 7, { align: 'right' });
            pdf.text('Phone: ' + (companySettings?.phone || '+91 98765 43210'), rightX, yPos + 12, { align: 'right' });
            pdf.text('Web: www.avantelevators.com', rightX, yPos + 17, { align: 'right' });

            // Separator line
            yPos += 22;
            pdf.setDrawColor(...borderGray);
            pdf.setLineWidth(0.5);
            pdf.line(margin, yPos, pageWidth - margin, yPos);

            yPos += 10;

            // ===== TITLE =====
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(16);
            pdf.setTextColor(...darkText);
            pdf.text('SALARY SLIP', pageWidth / 2, yPos, { align: 'center' });

            yPos += 3;
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(11);
            pdf.setTextColor(...grayText);
            pdf.text('For the month of ' + monthName, pageWidth / 2, yPos, { align: 'center' });

            yPos += 10;

            // ===== EMPLOYEE INFORMATION BOX =====
            pdf.setFillColor(...lightBlue);
            pdf.roundedRect(margin, yPos, pageWidth - 2 * margin, 26, 2, 2, 'F');

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(10);
            pdf.setTextColor(...darkText);

            yPos += 7;
            const leftCol = margin + 5;
            const rightCol = pageWidth / 2 + 5;

            pdf.text('Employee Name:', leftCol, yPos);
            pdf.setFont('helvetica', 'normal');
            pdf.text(salaryData.employee.firstName + ' ' + salaryData.employee.lastName, leftCol + 35, yPos);

            pdf.setFont('helvetica', 'bold');
            pdf.text('Employee ID:', rightCol, yPos);
            pdf.setFont('helvetica', 'normal');
            pdf.text(salaryData.employee.employeeId || 'N/A', rightCol + 28, yPos);

            yPos += 6;
            pdf.setFont('helvetica', 'bold');
            pdf.text('Designation:', leftCol, yPos);
            pdf.setFont('helvetica', 'normal');
            pdf.text(salaryData.employee.position || 'N/A', leftCol + 35, yPos);

            pdf.setFont('helvetica', 'bold');
            pdf.text('Department:', rightCol, yPos);
            pdf.setFont('helvetica', 'normal');
            pdf.text(salaryData.employee.department || 'N/A', rightCol + 28, yPos);

            yPos += 6;
            pdf.setFont('helvetica', 'bold');
            pdf.text('Working Days:', leftCol, yPos);
            pdf.setFont('helvetica', 'normal');
            pdf.text(`${payableDays} / ${salaryData.totalWorkingDays}`, leftCol + 35, yPos);

            pdf.setFont('helvetica', 'bold');
            pdf.text('Generated On:', rightCol, yPos);
            pdf.setFont('helvetica', 'normal');
            pdf.text(new Date().toLocaleDateString('en-IN'), rightCol + 28, yPos);

            yPos += 12;

            // ===== EARNINGS AND DEDUCTIONS TABLE =====
            const tableTop = yPos;
            const colWidth = (pageWidth - 2 * margin) / 2;
            
            // Table headers - Increased height and perfect text positioning
            pdf.setFillColor(...primaryBlue);
            pdf.rect(margin, yPos, colWidth, 14, 'F');
            pdf.rect(margin + colWidth, yPos, colWidth, 14, 'F');

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(10);
            pdf.setTextColor(255, 255, 255);
            
            // Left header - EARNINGS and AMOUNT with perfect vertical centering
            pdf.text('EARNINGS', margin + 3, yPos + 8.5);
            pdf.text('AMOUNT', margin + colWidth - 3, yPos + 8.5, { align: 'right' });
            
            // Right header - DEDUCTIONS and AMOUNT with perfect vertical centering
            pdf.text('DEDUCTIONS', margin + colWidth + 3, yPos + 8.5);
            pdf.text('AMOUNT', pageWidth - margin - 3, yPos + 8.5, { align: 'right' });

            yPos += 14;

            // Table content
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(10);
            pdf.setTextColor(...darkText);

            let earningsY = yPos;
            let deductionsY = yPos;
            const lineHeight = 7;

            // Draw alternating row backgrounds for earnings
            const drawRow = (y, isLeft, isAlternate) => {
                if (isAlternate) {
                    pdf.setFillColor(248, 250, 252);
                    const x = isLeft ? margin : margin + colWidth;
                    pdf.rect(x, y - 5, colWidth, lineHeight, 'F');
                }
            };

            // EARNINGS SIDE
            let rowCounter = 0;
            
            // Basic Salary
            drawRow(earningsY, true, rowCounter % 2 === 0);
            pdf.text('Basic Salary (' + salaryData.basicPercent + '%)', margin + 3, earningsY);
            pdf.text('Rs. ' + formatNumber(basicSalary.toFixed(2)), margin + colWidth - 3, earningsY, { align: 'right' });
            earningsY += lineHeight;
            rowCounter++;

            // HRA
            if (salaryData.hra > 0) {
                drawRow(earningsY, true, rowCounter % 2 === 0);
                pdf.text('House Rent Allowance (HRA)', margin + 3, earningsY);
                pdf.text('Rs. ' + formatNumber(salaryData.hra.toFixed(2)), margin + colWidth - 3, earningsY, { align: 'right' });
                earningsY += lineHeight;
                rowCounter++;
            }

            // Transport Allowance
            if (salaryData.transport > 0) {
                drawRow(earningsY, true, rowCounter % 2 === 0);
                pdf.text('Transport Allowance', margin + 3, earningsY);
                pdf.text('Rs. ' + formatNumber(salaryData.transport.toFixed(2)), margin + colWidth - 3, earningsY, { align: 'right' });
                earningsY += lineHeight;
                rowCounter++;
            }

            // Medical Allowance
            if (salaryData.medical > 0) {
                drawRow(earningsY, true, rowCounter % 2 === 0);
                pdf.text('Medical Allowance', margin + 3, earningsY);
                pdf.text('Rs. ' + formatNumber(salaryData.medical.toFixed(2)), margin + colWidth - 3, earningsY, { align: 'right' });
                earningsY += lineHeight;
                rowCounter++;
            }

            // Other Allowances
            if (salaryData.otherAllowances > 0) {
                drawRow(earningsY, true, rowCounter % 2 === 0);
                pdf.text('Other Allowances', margin + 3, earningsY);
                pdf.text('Rs. ' + formatNumber(salaryData.otherAllowances.toFixed(2)), margin + colWidth - 3, earningsY, { align: 'right' });
                earningsY += lineHeight;
                rowCounter++;
            }

            // Bonus
            if (salaryData.bonus > 0) {
                drawRow(earningsY, true, rowCounter % 2 === 0);
                const bonusLabel = salaryData.bonusDesc ? 'Bonus (' + salaryData.bonusDesc + ')' : 'Bonus';
                pdf.text(bonusLabel, margin + 3, earningsY);
                pdf.text('Rs. ' + formatNumber(salaryData.bonus.toFixed(2)), margin + colWidth - 3, earningsY, { align: 'right' });
                earningsY += lineHeight;
                rowCounter++;
            }

            // Incentives
            if (salaryData.incentives > 0) {
                drawRow(earningsY, true, rowCounter % 2 === 0);
                const incentivesLabel = salaryData.incentivesDesc ? 'Incentives (' + salaryData.incentivesDesc + ')' : 'Incentives';
                pdf.text(incentivesLabel, margin + 3, earningsY);
                pdf.text('Rs. ' + formatNumber(salaryData.incentives.toFixed(2)), margin + colWidth - 3, earningsY, { align: 'right' });
                earningsY += lineHeight;
                rowCounter++;
            }

            // Overtime
            if (salaryData.overtimeHours > 0) {
                drawRow(earningsY, true, rowCounter % 2 === 0);
                pdf.text('Overtime (' + salaryData.overtimeHours + ' hrs @ Rs.' + formatNumber(hourlyRate.toFixed(2)) + '/hr)', margin + 3, earningsY);
                pdf.text('Rs. ' + formatNumber(autoOvertimeAmount.toFixed(2)), margin + colWidth - 3, earningsY, { align: 'right' });
                earningsY += lineHeight;
                rowCounter++;
            }

            // DEDUCTIONS SIDE
            rowCounter = 0;

            // PF
            if (pfDeduction > 0) {
                drawRow(deductionsY, false, rowCounter % 2 === 0);
                pdf.text('Provident Fund (12%)', margin + colWidth + 3, deductionsY);
                pdf.text('Rs. ' + formatNumber(pfDeduction.toFixed(2)), pageWidth - margin - 3, deductionsY, { align: 'right' });
                deductionsY += lineHeight;
                rowCounter++;
            }

            // ESIC
            if (esicDeduction > 0) {
                drawRow(deductionsY, false, rowCounter % 2 === 0);
                pdf.text('ESIC (0.75%)', margin + colWidth + 3, deductionsY);
                pdf.text('Rs. ' + formatNumber(esicDeduction.toFixed(2)), pageWidth - margin - 3, deductionsY, { align: 'right' });
                deductionsY += lineHeight;
                rowCounter++;
            }

            // Other Deductions
            if (salaryData.otherDeductions > 0) {
                drawRow(deductionsY, false, rowCounter % 2 === 0);
                const deductionLabel = salaryData.deductionDesc ? salaryData.deductionDesc : 'Other Deductions';
                pdf.text(deductionLabel, margin + colWidth + 3, deductionsY);
                pdf.text('Rs. ' + formatNumber(salaryData.otherDeductions.toFixed(2)), pageWidth - margin - 3, deductionsY, { align: 'right' });
                deductionsY += lineHeight;
                rowCounter++;
            }

            // Align to same height
            const maxY = Math.max(earningsY, deductionsY);
            
            // Total Earnings and Deductions
            yPos = maxY + 3;
            pdf.setDrawColor(...borderGray);
            pdf.setLineWidth(0.5);
            pdf.line(margin, yPos, pageWidth - margin, yPos);
            
            yPos += 7;
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(11);
            pdf.text('TOTAL EARNINGS', margin + 3, yPos);
            pdf.text('Rs. ' + formatNumber(totalEarnings.toFixed(2)), margin + colWidth - 3, yPos, { align: 'right' });
            pdf.text('TOTAL DEDUCTIONS', margin + colWidth + 3, yPos);
            pdf.text('Rs. ' + formatNumber(totalDeductions.toFixed(2)), pageWidth - margin - 3, yPos, { align: 'right' });

            yPos += 10;

            // NET SALARY BOX
            pdf.setFillColor(...primaryBlue);
            pdf.roundedRect(margin, yPos, pageWidth - 2 * margin, 14, 2, 2, 'F');

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(14);
            pdf.setTextColor(255, 255, 255);
            pdf.text('NET SALARY (Take Home)', margin + 5, yPos + 9);
            pdf.text('Rs. ' + formatNumber(netSalary.toFixed(2)), pageWidth - margin - 5, yPos + 9, { align: 'right' });

            yPos += 18;

            // Net Salary in Words
            pdf.setFont('helvetica', 'italic');
            pdf.setFontSize(10);
            pdf.setTextColor(...grayText);
            pdf.text('In Words: ' + numberToWords(Math.round(netSalary)) + ' Rupees Only', margin + 3, yPos);

            yPos += 10;

            // ===== FOOTER =====
            pdf.setDrawColor(...borderGray);
            pdf.setLineWidth(0.5);
            pdf.line(margin, yPos, pageWidth - margin, yPos);

            yPos += 6;
            pdf.setFont('helvetica', 'italic');
            pdf.setFontSize(8);
            pdf.setTextColor(...grayText);
            pdf.text('This is a computer-generated salary slip and does not require a signature.', pageWidth / 2, yPos, { align: 'center' });
            
            yPos += 5;
            pdf.text('For queries, contact HR: hr@avantelevators.com | +91 98765 43210', pageWidth / 2, yPos, { align: 'center' });

            yPos += 8;
            
            // Bottom blue line - Place it right after content
            pdf.setDrawColor(...primaryBlue);
            pdf.setLineWidth(3);
            pdf.line(0, yPos, pageWidth, yPos);

            // Draw table borders
            pdf.setDrawColor(...borderGray);
            pdf.setLineWidth(0.3);
            pdf.rect(margin, tableTop, colWidth, maxY - tableTop);
            pdf.rect(margin + colWidth, tableTop, colWidth, maxY - tableTop);

            // Save salary slip data to Firebase
            const salarySlipData = {
                employeeId: salaryData.employee.id,
                employeeName: salaryData.employee.firstName + ' ' + salaryData.employee.lastName,
                employeeCode: salaryData.employee.employeeId,
                designation: salaryData.employee.position,
                department: salaryData.employee.department,
                month: salaryData.month,
                monthName: monthName,
                generatedDate: new Date().toISOString(),
                generatedBy: currentUser?.username || 'System',
                
                // Salary components
                grossSalary: salaryData.grossSalary,
                basicSalary: basicSalary,
                basicPercent: salaryData.basicPercent,
                hra: salaryData.hra,
                transportAllowance: salaryData.transport,
                medicalAllowance: salaryData.medical,
                otherAllowances: salaryData.otherAllowances,
                bonus: salaryData.bonus,
                bonusDescription: salaryData.bonusDesc,
                incentives: salaryData.incentives,
                incentivesDescription: salaryData.incentivesDesc,
                overtimeHours: salaryData.overtimeHours,
                overtimeAmount: autoOvertimeAmount,
                hourlyRate: hourlyRate,
                
                // Deductions
                pfDeduction: pfDeduction,
                esicDeduction: esicDeduction,
                otherDeductions: salaryData.otherDeductions,
                deductionDescription: salaryData.deductionDesc,
                
                // Attendance
                totalWorkingDays: salaryData.totalWorkingDays,
                presentDays: salaryData.presentDays,
                paidLeaves: salaryData.paidLeaves,
                leavesUsed: salaryData.leavesUsed,
                payableDays: payableDays,
                
                // Totals
                totalEarnings: totalEarnings,
                totalDeductions: totalDeductions,
                netSalary: netSalary,
                netSalaryWords: numberToWords(Math.round(netSalary)) + ' Rupees Only'
            };

            // Save to Firebase
            if (typeof db !== 'undefined' && typeof addDoc !== 'undefined' && isOnline !== false) {
                try {
                    await addDoc(collection(db, 'salarySlips'), salarySlipData);
                    console.log('Salary slip data saved to Firebase');
                    
                    // Add activity log
                    if (typeof collection !== 'undefined') {
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Generated salary slip for ${salarySlipData.employeeName} - ${monthName}`,
                            user: currentUser?.username || 'System'
                        });
                    }
                } catch (error) {
                    console.error('Error saving salary slip to Firebase:', error);
                }
            }

            // Save PDF
            const fileName = `SalarySlip_${salaryData.employee.firstName}_${salaryData.employee.lastName}_${monthName.replace(/ /g, '_')}.pdf`;
            
            // Get PDF as blob for potential email sending
            const pdfBlob = pdf.output('blob');
            
            // Download PDF
            pdf.save(fileName);

            // Close modal first
            closeModal('salarySlipModal');
            
            // Reload salary slips if on HR tab
            if (typeof loadSalarySlips === 'function') {
                await loadSalarySlips();
            }
            
            // Show success message first
            alert('‚úÖ Salary slip generated and saved successfully!\n\nOvertime calculated at Rs. ' + formatNumber(hourlyRate.toFixed(2)) + '/hour');
            
            // Show email option if email is configured and employee has email
            const emailConfig = JSON.parse(localStorage.getItem('emailConfig') || '{}');
            if (emailConfig.validated && salaryData.employee.email) {
                const sendEmail = confirm(`Would you like to email this salary slip to ${salaryData.employee.firstName} ${salaryData.employee.lastName}?\n\nEmail: ${salaryData.employee.email}`);
                if (sendEmail) {
                    const subject = `Salary Slip for ${monthName} - ${salaryData.employee.firstName} ${salaryData.employee.lastName}`;
                    const body = `Dear ${salaryData.employee.firstName},\n\nPlease find attached your salary slip for ${monthName}.\n\nNet Salary: Rs. ${formatNumber(netSalary)}\nPayable Days: ${payableDays} out of ${salaryData.totalWorkingDays}\n\nIf you have any questions, please contact HR.\n\nBest regards,\nHR Department\nAvant Elevators`;
                    
                    await sendEmailWithPDF(salaryData.employee.email, `${salaryData.employee.firstName} ${salaryData.employee.lastName}`, subject, body, pdfBlob, fileName);
                }
            }
        }

        // Helper function to convert number to words (Indian format)
        function numberToWords(num) {
            if (num === 0) return 'Zero';
            
            const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine'];
            const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
            const teens = ['Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
            
            function convertLessThanThousand(n) {
                if (n === 0) return '';
                else if (n < 10) return ones[n];
                else if (n < 20) return teens[n - 10];
                else if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 !== 0 ? ' ' + ones[n % 10] : '');
                else return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 !== 0 ? ' ' + convertLessThanThousand(n % 100) : '');
            }
            
            if (num < 1000) return convertLessThanThousand(num);
            else if (num < 100000) {
                const thousands = Math.floor(num / 1000);
                const remainder = num % 1000;
                return convertLessThanThousand(thousands) + ' Thousand' + (remainder !== 0 ? ' ' + convertLessThanThousand(remainder) : '');
            } else if (num < 10000000) {
                const lakhs = Math.floor(num / 100000);
                const remainder = num % 100000;
                return convertLessThanThousand(lakhs) + ' Lakh' + (remainder !== 0 ? ' ' + numberToWords(remainder) : '');
            } else {
                const crores = Math.floor(num / 10000000);
                const remainder = num % 10000000;
                return convertLessThanThousand(crores) + ' Crore' + (remainder !== 0 ? ' ' + numberToWords(remainder) : '');
            }
        }

        // ==================== SALARY SLIPS MANAGEMENT FUNCTIONS ====================
        
        let salarySlips = [];

        // Load salary slips from Firebase
        async function loadSalarySlips() {
            try {
                if (typeof db !== 'undefined' && typeof getDocs !== 'undefined') {
                    const snapshot = await getDocs(collection(db, 'salarySlips'));
                    salarySlips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Sort by generated date (newest first)
                    salarySlips.sort((a, b) => new Date(b.generatedDate) - new Date(a.generatedDate));
                    
                    // Cache the data
                    localStorage.setItem('cachedSalarySlips', JSON.stringify(salarySlips));
                    
                    renderSalarySlips();
                    updateSalarySlipsStats();
                    populateSlipFilters();
                }
            } catch (error) {
                console.error('Error loading salary slips:', error);
                // Try to load from cache
                const cachedSlips = localStorage.getItem('cachedSalarySlips');
                if (cachedSlips) {
                    salarySlips = JSON.parse(cachedSlips);
                    renderSalarySlips();
                    updateSalarySlipsStats();
                    populateSlipFilters();
                }
            }
        }

        // Render salary slips table
        function renderSalarySlips() {
            const tbody = document.getElementById('salarySlipsList');
            
            if (salarySlips.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìÑ</div><p>No salary slips generated yet.</p></td></tr>';
                return;
            }

            tbody.innerHTML = salarySlips.map(slip => `
                <tr>
                    <td>
                        <strong>${slip.employeeName}</strong><br>
                        <small style="color: #64748b;">${slip.employeeCode || 'N/A'}</small><br>
                        <small style="color: #64748b;">${slip.designation || 'N/A'}</small>
                    </td>
                    <td><strong>${slip.monthName}</strong></td>
                    <td><strong>Rs. ${formatNumber(slip.grossSalary.toFixed(2))}</strong></td>
                    <td><span style="color: #dc2626;">Rs. ${formatNumber(slip.totalDeductions.toFixed(2))}</span></td>
                    <td><strong style="color: #16a34a; font-size: 15px;">Rs. ${formatNumber(slip.netSalary.toFixed(2))}</strong></td>
                    <td><small>${new Date(slip.generatedDate).toLocaleDateString('en-IN')}</small></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="downloadSalarySlip('${slip.id}')">üìÑ Download</button>
                            <button class="btn btn-secondary btn-sm" onclick="viewSlipDetails('${slip.id}')">üëÅÔ∏è View</button>
                            ${currentUser?.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteSalarySlip('${slip.id}')">Delete</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Update salary slips statistics
        function updateSalarySlipsStats() {
            const totalSlips = salarySlips.length;
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM format
            
            const thisMonthSlips = salarySlips.filter(slip => 
                slip.month && slip.month.startsWith(currentMonth)
            );
            
            const totalMonthPayout = thisMonthSlips.reduce((sum, slip) => sum + (slip.netSalary || 0), 0);
            const avgSalary = thisMonthSlips.length > 0 ? totalMonthPayout / thisMonthSlips.length : 0;

            document.getElementById('totalSlips').textContent = totalSlips;
            document.getElementById('thisMonthSlips').textContent = thisMonthSlips.length;
            document.getElementById('totalMonthPayout').textContent = 'Rs. ' + formatNumber(totalMonthPayout.toFixed(2));
            document.getElementById('avgSlipSalary').textContent = 'Rs. ' + formatNumber(avgSalary.toFixed(2));
        }

        // Populate filter dropdowns
        function populateSlipFilters() {
            const employeeFilter = document.getElementById('slipEmployeeFilter');
            const uniqueEmployees = [...new Set(salarySlips.map(slip => slip.employeeName))];
            
            employeeFilter.innerHTML = '<option value="">All Employees</option>' + 
                uniqueEmployees.map(name => `<option value="${name}">${name}</option>`).join('');
        }

        // Filter salary slips
        window.filterSalarySlips = () => {
            const searchTerm = document.getElementById('searchSalarySlips').value.toLowerCase();
            const monthFilter = document.getElementById('slipMonthFilter').value;
            const employeeFilter = document.getElementById('slipEmployeeFilter').value;
            const departmentFilter = document.getElementById('slipDepartmentFilter').value;

            const rows = document.querySelectorAll('#salarySlipsList tr');
            let visibleCount = 0;

            salarySlips.forEach((slip, index) => {
                const row = rows[index];
                if (!row) return;

                let show = true;

                // Search filter
                if (searchTerm && !slip.employeeName.toLowerCase().includes(searchTerm) && 
                    !slip.employeeCode.toLowerCase().includes(searchTerm)) {
                    show = false;
                }

                // Month filter
                if (monthFilter && !slip.month.startsWith(monthFilter)) {
                    show = false;
                }

                // Employee filter
                if (employeeFilter && slip.employeeName !== employeeFilter) {
                    show = false;
                }

                // Department filter
                if (departmentFilter && slip.department !== departmentFilter) {
                    show = false;
                }

                row.style.display = show ? '' : 'none';
                if (show) visibleCount++;
            });

            // Show empty state if no results
            const tbody = document.getElementById('salarySlipsList');
            if (visibleCount === 0 && salarySlips.length > 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üîç</div><p>No salary slips match your filters.</p></td></tr>';
            } else if (salarySlips.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìÑ</div><p>No salary slips generated yet.</p></td></tr>';
            }
        };

        // Download individual salary slip as PDF
        window.downloadSalarySlip = async (slipId) => {
            const slip = salarySlips.find(s => s.id === slipId);
            if (!slip) {
                alert('Salary slip not found!');
                return;
            }

            try {
                // Ensure jsPDF is loaded
                if (typeof window.jspdf === 'undefined') {
                    alert('PDF library is loading... Please wait a moment and try again.');
                    return;
                }

                // Find the employee
                const employee = employees.find(emp => emp.id === slip.employeeId);
                if (!employee) {
                    alert('Employee not found!');
                    return;
                }

                // Reconstruct salary data object
                const salaryData = {
                    employee: employee,
                    month: slip.month,
                    grossSalary: slip.grossSalary,
                    basicPercent: slip.basicPercent,
                    totalWorkingDays: slip.totalWorkingDays,
                    presentDays: slip.presentDays,
                    paidLeaves: slip.paidLeaves,
                    leavesUsed: slip.leavesUsed,
                    enablePF: slip.pfDeduction > 0,
                    enableESIC: slip.esicDeduction > 0,
                    hra: slip.hra,
                    transport: slip.transportAllowance,
                    medical: slip.medicalAllowance,
                    otherAllowances: slip.otherAllowances,
                    bonus: slip.bonus,
                    bonusDesc: slip.bonusDescription,
                    incentives: slip.incentives,
                    incentivesDesc: slip.incentivesDescription,
                    otherDeductions: slip.otherDeductions,
                    deductionDesc: slip.deductionDescription,
                    overtimeHours: slip.overtimeHours
                };

                // Generate PDF
                await generateSalarySlipPDF(salaryData);
            } catch (error) {
                console.error('Error downloading salary slip:', error);
                alert('Error downloading salary slip: ' + error.message);
            }
        };

        // View slip details (show modal with details)
        window.viewSlipDetails = (slipId) => {
            const slip = salarySlips.find(s => s.id === slipId);
            if (!slip) {
                alert('Salary slip not found!');
                return;
            }

            const details = `
                <strong>Employee:</strong> ${slip.employeeName} (${slip.employeeCode})<br>
                <strong>Month:</strong> ${slip.monthName}<br>
                <strong>Designation:</strong> ${slip.designation}<br>
                <strong>Department:</strong> ${slip.department}<br><br>
                
                <strong>Gross Salary:</strong> Rs. ${formatNumber(slip.grossSalary.toFixed(2))}<br>
                <strong>Basic Salary:</strong> Rs. ${formatNumber(slip.basicSalary.toFixed(2))} (${slip.basicPercent}%)<br>
                <strong>HRA:</strong> Rs. ${formatNumber(slip.hra.toFixed(2))}<br>
                <strong>Transport:</strong> Rs. ${formatNumber(slip.transportAllowance.toFixed(2))}<br>
                <strong>Medical:</strong> Rs. ${formatNumber(slip.medicalAllowance.toFixed(2))}<br>
                <strong>Other Allowances:</strong> Rs. ${formatNumber(slip.otherAllowances.toFixed(2))}<br>
                ${slip.bonus > 0 ? `<strong>Bonus:</strong> Rs. ${formatNumber(slip.bonus.toFixed(2))}<br>` : ''}
                ${slip.incentives > 0 ? `<strong>Incentives:</strong> Rs. ${formatNumber(slip.incentives.toFixed(2))}<br>` : ''}
                ${slip.overtimeHours > 0 ? `<strong>Overtime:</strong> ${slip.overtimeHours} hrs @ Rs. ${formatNumber(slip.hourlyRate.toFixed(2))}/hr = Rs. ${formatNumber(slip.overtimeAmount.toFixed(2))}<br>` : ''}
                <br>
                <strong>Total Earnings:</strong> Rs. ${formatNumber(slip.totalEarnings.toFixed(2))}<br>
                <strong>Total Deductions:</strong> Rs. ${formatNumber(slip.totalDeductions.toFixed(2))}<br>
                <strong style="color: #16a34a; font-size: 16px;">Net Salary:</strong> <span style="color: #16a34a; font-size: 16px;">Rs. ${formatNumber(slip.netSalary.toFixed(2))}</span><br>
                <em>${slip.netSalaryWords}</em>
            `;

            alert(details);
        };

        // Delete salary slip
        window.deleteSalarySlip = async (slipId) => {
            const slip = salarySlips.find(s => s.id === slipId);
            if (!slip) {
                alert('Salary slip not found!');
                return;
            }

            if (!confirm(`Are you sure you want to delete the salary slip for ${slip.employeeName} - ${slip.monthName}?\n\nThis action cannot be undone.`)) {
                return;
            }

            try {
                if (typeof db !== 'undefined' && typeof deleteDoc !== 'undefined') {
                    await deleteDoc(doc(db, 'salarySlips', slipId));
                    
                    // Add activity log
                    if (typeof addDoc !== 'undefined' && typeof collection !== 'undefined') {
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Deleted salary slip: ${slip.employeeName} - ${slip.monthName}`,
                            user: currentUser?.username || 'System'
                        });
                    }
                }

                // Remove from local array
                const index = salarySlips.findIndex(s => s.id === slipId);
                if (index !== -1) {
                    salarySlips.splice(index, 1);
                }

                // Update cache
                localStorage.setItem('cachedSalarySlips', JSON.stringify(salarySlips));

                // Re-render
                renderSalarySlips();
                updateSalarySlipsStats();

                alert('Salary slip deleted successfully!');
            } catch (error) {
                console.error('Error deleting salary slip:', error);
                alert('Error deleting salary slip: ' + error.message);
            }
        };

        // Export all salary slips
        window.exportAllSalarySlipsPDF = async () => {
            if (salarySlips.length === 0) {
                alert('‚ö†Ô∏è No salary slips found to export!');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const companyInfo = await getCompanyInfo();
            let isFirstPage = true;
            
            for (let i = 0; i < salarySlips.length; i++) {
                const slip = salarySlips[i];
                
                if (!isFirstPage) {
                    doc.addPage();
                }
                isFirstPage = false;
                
                // Header
                doc.setFillColor(37, 99, 235);
                doc.rect(0, 0, 210, 40, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.text(companyInfo.name || 'Avant Elevators', 105, 15, { align: 'center' });
                doc.setFontSize(16);
                doc.text('SALARY SLIP', 105, 28, { align: 'center' });
                doc.setFontSize(9);
                doc.text(`${slip.month} ${slip.year}`, 105, 36, { align: 'center' });
                
                let y = 55;
                
                // Employee Details
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);
                doc.text(`Employee Name: ${slip.employeeName}`, 20, y);
                doc.text(`Employee ID: ${slip.employeeId}`, 120, y);
                y += 7;
                doc.text(`Designation: ${slip.designation}`, 20, y);
                doc.text(`Department: ${slip.department}`, 120, y);
                y += 15;
                
                // Earnings
                doc.setFontSize(12);
                doc.setTextColor(37, 99, 235);
                doc.text('Earnings', 20, y);
                y += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Basic Salary:`, 25, y);
                doc.text(`Rs. ${parseFloat(slip.basicSalary || 0).toLocaleString()}`, 150, y);
                y += 7;
                
                if (slip.allowances > 0) {
                    doc.text(`Allowances:`, 25, y);
                    doc.text(`Rs. ${parseFloat(slip.allowances || 0).toLocaleString()}`, 150, y);
                    y += 7;
                }
                
                if (slip.bonus > 0) {
                    doc.text(`Bonus:`, 25, y);
                    doc.text(`Rs. ${parseFloat(slip.bonus || 0).toLocaleString()}`, 150, y);
                    y += 7;
                }
                
                if (slip.overtimePay > 0) {
                    doc.text(`Overtime Pay:`, 25, y);
                    doc.text(`Rs. ${parseFloat(slip.overtimePay || 0).toLocaleString()}`, 150, y);
                    y += 7;
                }
                
                if (slip.incentives > 0) {
                    doc.text(`Incentives:`, 25, y);
                    doc.text(`Rs. ${parseFloat(slip.incentives || 0).toLocaleString()}`, 150, y);
                    y += 7;
                }
                
                y += 5;
                doc.setFont(undefined, 'bold');
                doc.text(`Gross Earnings:`, 25, y);
                doc.text(`Rs. ${parseFloat(slip.grossEarnings || 0).toLocaleString()}`, 150, y);
                doc.setFont(undefined, 'normal');
                
                y += 15;
                
                // Deductions
                doc.setFontSize(12);
                doc.setTextColor(220, 38, 38);
                doc.text('Deductions', 20, y);
                y += 8;
                
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                if (slip.providentFund > 0) {
                    doc.text(`Provident Fund:`, 25, y);
                    doc.text(`Rs. ${parseFloat(slip.providentFund || 0).toLocaleString()}`, 150, y);
                    y += 7;
                }
                
                if (slip.tax > 0) {
                    doc.text(`Tax (TDS):`, 25, y);
                    doc.text(`Rs. ${parseFloat(slip.tax || 0).toLocaleString()}`, 150, y);
                    y += 7;
                }
                
                if (slip.otherDeductions > 0) {
                    doc.text(`Other Deductions:`, 25, y);
                    doc.text(`Rs. ${parseFloat(slip.otherDeductions || 0).toLocaleString()}`, 150, y);
                    y += 7;
                }
                
                y += 5;
                doc.setFont(undefined, 'bold');
                doc.text(`Total Deductions:`, 25, y);
                doc.text(`Rs. ${parseFloat(slip.totalDeductions || 0).toLocaleString()}`, 150, y);
                doc.setFont(undefined, 'normal');
                
                y += 20;
                
                // Net Salary
                doc.setFillColor(22, 163, 74);
                doc.rect(20, y - 8, 170, 15, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('NET SALARY:', 25, y);
                doc.text(`Rs. ${parseFloat(slip.netSalary || 0).toLocaleString()}`, 150, y);
                doc.setFont(undefined, 'normal');
                
                // Footer
                doc.setTextColor(100, 100, 100);
                doc.setFontSize(8);
                doc.text(`Generated on ${new Date(slip.generatedDate).toLocaleDateString()}`, 105, 280, { align: 'center' });
                doc.text('This is a computer-generated salary slip and does not require a signature.', 105, 285, { align: 'center' });
            }
            
            doc.save(`All_Salary_Slips_${new Date().toISOString().split('T')[0]}.pdf`);
            alert(`‚úÖ Successfully exported ${salarySlips.length} salary slips!`);
        };


        // ==================== END SALARY SLIP FUNCTIONS ====================

        // ==================== BILLING MANAGEMENT FUNCTIONS ====================
        
        let quotations = [];
        let purchaseOrders = [];
        let proformaInvoices = [];
        let taxInvoices = [];

        // Load all billing data
        async function loadBillingData() {
            try {
                if (typeof db !== 'undefined' && typeof getDocs !== 'undefined') {
                    // Load Quotations
                    const quotationsSnapshot = await getDocs(collection(db, 'quotations'));
                    quotations = quotationsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Load Purchase Orders
                    const poSnapshot = await getDocs(collection(db, 'purchaseOrders'));
                    purchaseOrders = poSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Load Proforma Invoices
                    const piSnapshot = await getDocs(collection(db, 'proformaInvoices'));
                    proformaInvoices = piSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Load Tax Invoices
                    const tiSnapshot = await getDocs(collection(db, 'taxInvoices'));
                    taxInvoices = tiSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Cache data
                    localStorage.setItem('cachedQuotations', JSON.stringify(quotations));
                    localStorage.setItem('cachedPurchaseOrders', JSON.stringify(purchaseOrders));
                    localStorage.setItem('cachedProformaInvoices', JSON.stringify(proformaInvoices));
                    localStorage.setItem('cachedTaxInvoices', JSON.stringify(taxInvoices));
                }
            } catch (error) {
                console.error('Error loading billing data:', error);
                // Load from cache
                quotations = JSON.parse(localStorage.getItem('cachedQuotations') || '[]');
                purchaseOrders = JSON.parse(localStorage.getItem('cachedPurchaseOrders') || '[]');
                proformaInvoices = JSON.parse(localStorage.getItem('cachedProformaInvoices') || '[]');
                taxInvoices = JSON.parse(localStorage.getItem('cachedTaxInvoices') || '[]');
            }
            
            renderQuotations();
            renderPurchaseOrders();
            renderProformaInvoices();
            renderTaxInvoices();
            updateBillingStats();
        }

        // Show different billing sections
        window.showBillingSection = (section) => {
            // Hide all sections
            document.getElementById('quotationsSection').style.display = 'none';
            document.getElementById('purchaseOrdersSection').style.display = 'none';
            document.getElementById('proformaInvoicesSection').style.display = 'none';
            document.getElementById('taxInvoicesSection').style.display = 'none';
            
            // Remove active styling from all buttons
            document.getElementById('quotationsTabBtn').style.borderBottom = 'none';
            document.getElementById('purchaseOrdersTabBtn').style.borderBottom = 'none';
            document.getElementById('proformaInvoicesTabBtn').style.borderBottom = 'none';
            document.getElementById('taxInvoicesTabBtn').style.borderBottom = 'none';
            
            // Show selected section
            if (section === 'quotations') {
                document.getElementById('quotationsSection').style.display = 'block';
                document.getElementById('quotationsTabBtn').style.borderBottom = '3px solid #2563eb';
            } else if (section === 'purchaseOrders') {
                document.getElementById('purchaseOrdersSection').style.display = 'block';
                document.getElementById('purchaseOrdersTabBtn').style.borderBottom = '3px solid #2563eb';
            } else if (section === 'proformaInvoices') {
                document.getElementById('proformaInvoicesSection').style.display = 'block';
                document.getElementById('proformaInvoicesTabBtn').style.borderBottom = '3px solid #2563eb';
            } else if (section === 'taxInvoices') {
                document.getElementById('taxInvoicesSection').style.display = 'block';
                document.getElementById('taxInvoicesTabBtn').style.borderBottom = '3px solid #2563eb';
            }
        };

        // Update billing statistics
        function updateBillingStats() {
            const totalQuotationsCount = quotations.length;
            const activePIs = proformaInvoices.filter(pi => pi.status !== 'Paid').length;
            const totalTaxInvoicesCount = taxInvoices.length;
            const totalRevenue = taxInvoices.filter(ti => ti.status === 'Paid').reduce((sum, ti) => sum + (ti.totalAmount || 0), 0);
            
            document.getElementById('totalQuotations').textContent = totalQuotationsCount;
            document.getElementById('activeProformaInvoices').textContent = activePIs;
            document.getElementById('totalTaxInvoices').textContent = totalTaxInvoicesCount;
            document.getElementById('totalBillingRevenue').textContent = 'Rs. ' + formatNumber(totalRevenue.toFixed(2));
        }

        // ========== QUOTATIONS ==========
        
        function renderQuotations() {
            const tbody = document.getElementById('quotationsList');
            if (quotations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üìã</div><p>No quotations yet. Click "New Quotation" to create one.</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = quotations.map(quot => `
                <tr>
                    <td><strong>${quot.quotationNumber}</strong></td>
                    <td><span class="badge badge-info">${quot.type}</span></td>
                    <td>${quot.clientName}</td>
                    <td>${new Date(quot.date).toLocaleDateString('en-IN')}</td>
                    <td><strong>Rs. ${formatNumber(quot.totalAmount.toFixed(2))}</strong></td>
                    <td><span class="badge badge-${getStatusColor(quot.status)}">${quot.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="downloadQuotationPDF('${quot.id}')">üìÑ PDF</button>
                            <button class="btn btn-warning btn-sm" onclick="sendQuotationEmail('${quot.id}')">üìß Send</button>
                            <button class="btn btn-success btn-sm" onclick="convertQuotationToPI('${quot.id}')">‚Üí PI</button>
                            <button class="btn btn-secondary btn-sm" onclick="editQuotation('${quot.id}')">Edit</button>
                            ${currentUser?.role === 'admin' ? `<button class="btn btn-danger btn-sm" onclick="deleteQuotation('${quot.id}')">Delete</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        window.showQuotationModal = (quotId = null) => {
            document.getElementById('quotationForm').reset();
            document.getElementById('editQuotationId').value = '';
            
            if (quotId) {
                const quot = quotations.find(q => q.id === quotId);
                if (quot) {
                    document.getElementById('quotationModalTitle').textContent = 'Edit Quotation';
                    document.getElementById('editQuotationId').value = quot.id;
                    document.getElementById('quotationType').value = quot.type || '';
                    document.getElementById('quotationNumber').value = quot.quotationNumber || '';
                    document.getElementById('quotationDate').value = quot.date ? quot.date.split('T')[0] : '';
                    document.getElementById('quotationValidUntil').value = quot.validUntil || '';
                    document.getElementById('quotClientName').value = quot.clientName || '';
                    document.getElementById('quotClientEmail').value = quot.clientEmail || '';
                    document.getElementById('quotClientPhone').value = quot.clientPhone || '';
                    document.getElementById('quotClientGST').value = quot.clientGST || '';
                    document.getElementById('quotClientAddress').value = quot.clientAddress || '';
                    document.getElementById('quotElevatorType').value = quot.elevatorType || '';
                    document.getElementById('quotElevatorQuantity').value = quot.elevatorQuantity || 1;
                    document.getElementById('quotCapacity').value = quot.capacity || '';
                    document.getElementById('quotFloors').value = quot.floors || '';
                    document.getElementById('quotDiscountPercent').value = quot.discountPercent || 0;
                    document.getElementById('quotGSTPercent').value = quot.gstPercent || 18;
                    document.getElementById('quotTerms').value = quot.terms || '';
                    document.getElementById('quotNotes').value = quot.notes || '';
                    
                    // Populate items
                    const itemsList = document.getElementById('quotationItemsList');
                    itemsList.innerHTML = '';
                    if (quot.items && quot.items.length > 0) {
                        quot.items.forEach(item => {
                            addQuotationItem(item);
                        });
                    }
                    calculateQuotationTotal();
                }
            } else {
                document.getElementById('quotationModalTitle').textContent = 'Create Quotation';
                document.getElementById('quotationNumber').value = 'QT' + Date.now();
                document.getElementById('quotationDate').value = new Date().toISOString().split('T')[0];
                const validUntil = new Date();
                validUntil.setDate(validUntil.getDate() + 30);
                document.getElementById('quotationValidUntil').value = validUntil.toISOString().split('T')[0];
                document.getElementById('quotationItemsList').innerHTML = '';
                addQuotationItem();
            }
            
            document.getElementById('quotationModal').classList.add('active');
        };
        
        window.addQuotationItem = (item = null) => {
            const itemsList = document.getElementById('quotationItemsList');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'invoice-item';
            itemDiv.innerHTML = `
                <input type="text" class="form-control" placeholder="Item description" value="${item?.description || ''}" onchange="calculateQuotationTotal()">
                <input type="number" class="form-control" placeholder="Qty" min="1" value="${item?.quantity || 1}" onchange="calculateQuotationTotal()">
                <input type="text" class="form-control" placeholder="Unit" value="${item?.unit || 'pcs'}">
                <input type="number" class="form-control" placeholder="Rate" min="0" step="0.01" value="${item?.rate || ''}" onchange="calculateQuotationTotal()">
                <div class="item-amount">Rs. ${item ? (item.quantity * item.rate).toFixed(2) : '0.00'}</div>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calculateQuotationTotal();">‚úï</button>
            `;
            itemsList.appendChild(itemDiv);
        };
        
        window.calculateQuotationTotal = () => {
            let subtotal = 0;
            const items = document.querySelectorAll('#quotationItemsList .invoice-item');
            items.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const qty = parseFloat(inputs[1].value) || 0;
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = qty * rate;
                item.querySelector('.item-amount').textContent = 'Rs. ' + formatNumber(amount.toFixed(2));
                subtotal += amount;
            });
            
            const discountPercent = parseFloat(document.getElementById('quotDiscountPercent').value) || 0;
            const gstPercent = parseFloat(document.getElementById('quotGSTPercent').value) || 0;
            
            const discountAmount = (subtotal * discountPercent) / 100;
            const afterDiscount = subtotal - discountAmount;
            const gstAmount = (afterDiscount * gstPercent) / 100;
            const total = afterDiscount + gstAmount;
            
            document.getElementById('quotSubtotalDisplay').textContent = 'Rs. ' + formatNumber(subtotal.toFixed(2));
            document.getElementById('quotTotalAmountDisplay').textContent = 'Rs. ' + formatNumber(total.toFixed(2));
        };
        
        document.getElementById('quotationForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const quotId = document.getElementById('editQuotationId').value;
            const items = [];
            let subtotal = 0;
            
            document.querySelectorAll('#quotationItemsList .invoice-item').forEach(item => {
                const inputs = item.querySelectorAll('input');
                const description = inputs[0].value.trim();
                const quantity = parseFloat(inputs[1].value) || 0;
                const unit = inputs[2].value.trim() || 'pcs';
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = quantity * rate;
                
                if (description && quantity > 0 && rate >= 0) {
                    items.push({ description, quantity, unit, rate, amount });
                    subtotal += amount;
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one item');
                return;
            }
            
            const discountPercent = parseFloat(document.getElementById('quotDiscountPercent').value) || 0;
            const gstPercent = parseFloat(document.getElementById('quotGSTPercent').value) || 0;
            const discountAmount = (subtotal * discountPercent) / 100;
            const afterDiscount = subtotal - discountAmount;
            const gstAmount = (afterDiscount * gstPercent) / 100;
            const totalAmount = afterDiscount + gstAmount;
            
            const quotData = {
                quotationNumber: document.getElementById('quotationNumber').value.trim(),
                type: document.getElementById('quotationType').value,
                date: document.getElementById('quotationDate').value,
                validUntil: document.getElementById('quotationValidUntil').value,
                clientName: document.getElementById('quotClientName').value.trim(),
                clientEmail: document.getElementById('quotClientEmail').value.trim(),
                clientPhone: document.getElementById('quotClientPhone').value.trim(),
                clientGST: document.getElementById('quotClientGST').value.trim(),
                clientAddress: document.getElementById('quotClientAddress').value.trim(),
                elevatorType: document.getElementById('quotElevatorType').value,
                elevatorQuantity: parseInt(document.getElementById('quotElevatorQuantity').value) || 1,
                capacity: document.getElementById('quotCapacity').value,
                floors: document.getElementById('quotFloors').value,
                items: items,
                subtotal: subtotal,
                discountPercent: discountPercent,
                discountAmount: discountAmount,
                gstPercent: gstPercent,
                gstAmount: gstAmount,
                totalAmount: totalAmount,
                terms: document.getElementById('quotTerms').value.trim(),
                notes: document.getElementById('quotNotes').value.trim(),
                status: quotId ? quotations.find(q => q.id === quotId)?.status || 'Draft' : 'Draft',
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser?.username || 'System'
            };
            
            try {
                if (typeof db !== 'undefined' && typeof addDoc !== 'undefined') {
                    if (quotId) {
                        await updateDoc(doc(db, 'quotations', quotId), quotData);
                        alert('‚úÖ Quotation updated successfully!');
                    } else {
                        quotData.createdAt = new Date().toISOString();
                        quotData.createdBy = currentUser?.username || 'System';
                        await addDoc(collection(db, 'quotations'), quotData);
                        alert('‚úÖ Quotation created successfully!');
                    }
                    closeModal('quotationModal');
                    await loadBillingData();
                }
            } catch (error) {
                console.error('Error saving quotation:', error);
                alert('Error saving quotation: ' + error.message);
            }
        });
        
        window.editQuotation = (id) => {
            showQuotationModal(id);
        };
        
        window.deleteQuotation = async (id) => {
            if (!confirm('Are you sure you want to delete this quotation?')) return;
            
            try {
                if (typeof db !== 'undefined' && typeof deleteDoc !== 'undefined') {
                    await deleteDoc(doc(db, 'quotations', id));
                    alert('‚úÖ Quotation deleted successfully!');
                    await loadBillingData();
                }
            } catch (error) {
                console.error('Error deleting quotation:', error);
                alert('Error deleting quotation: ' + error.message);
            }
        };

        window.downloadQuotationPDF = (id) => {
            alert('Download Quotation PDF feature - will generate professional quotation with company letterhead');
        };

        window.convertQuotationToPI = async (quotId) => {
            const quot = quotations.find(q => q.id === quotId);
            if (!quot) return;
            
            if (!confirm(`Convert Quotation ${quot.quotationNumber} to Proforma Invoice?`)) return;
            
            // Create PI from quotation
            const advancePercent = prompt('Enter advance payment percentage (0-100):', '30');
            if (!advancePercent) return;
            
            const piData = {
                piNumber: 'PI' + Date.now(),
                quotationId: quot.id,
                clientName: quot.clientName,
                clientEmail: quot.clientEmail,
                clientPhone: quot.clientPhone,
                clientAddress: quot.clientAddress,
                date: new Date().toISOString(),
                type: quot.type,
                items: quot.items,
                totalAmount: quot.totalAmount,
                advancePercent: parseFloat(advancePercent),
                advanceAmount: (quot.totalAmount * parseFloat(advancePercent)) / 100,
                paidAmount: 0,
                balanceAmount: quot.totalAmount,
                status: 'Pending',
                createdDate: new Date().toISOString(),
                createdBy: currentUser?.username || 'System'
            };
            
            try {
                if (typeof db !== 'undefined' && typeof addDoc !== 'undefined') {
                    await addDoc(collection(db, 'proformaInvoices'), piData);
                    alert('‚úÖ Proforma Invoice created successfully!');
                    await loadBillingData();
                    showBillingSection('proformaInvoices');
                }
            } catch (error) {
                console.error('Error creating PI:', error);
                alert('Error creating PI: ' + error.message);
            }
        };

        // ========== PURCHASE ORDERS ==========
        
        function renderPurchaseOrders() {
            const tbody = document.getElementById('purchaseOrdersList');
            if (purchaseOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üì¶</div><p>No purchase orders yet.</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = purchaseOrders.map(po => `
                <tr>
                    <td><strong>${po.poNumber}</strong></td>
                    <td><span class="badge badge-info">${po.type}</span></td>
                    <td>${po.vendorName}</td>
                    <td>${new Date(po.date).toLocaleDateString('en-IN')}</td>
                    <td><strong>Rs. ${formatNumber(po.totalAmount.toFixed(2))}</strong></td>
                    <td><span class="badge badge-${getStatusColor(po.status)}">${po.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="downloadPOPDF('${po.id}')">üìÑ PDF</button>
                            <button class="btn btn-secondary btn-sm" onclick="editPurchaseOrder('${po.id}')">Edit</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        window.showPurchaseOrderModal = (poId = null) => {
            document.getElementById('purchaseOrderForm').reset();
            document.getElementById('editPOId').value = '';
            
            if (poId) {
                const po = purchaseOrders.find(p => p.id === poId);
                if (po) {
                    document.getElementById('poModalTitle').textContent = 'Edit Purchase Order';
                    document.getElementById('editPOId').value = po.id;
                    document.getElementById('poPONumber').value = po.poNumber || '';
                    document.getElementById('poDate').value = po.date ? po.date.split('T')[0] : '';
                    document.getElementById('poType').value = po.type || '';
                    document.getElementById('poDeliveryDate').value = po.deliveryDate || '';
                    document.getElementById('poVendorName').value = po.vendorName || '';
                    document.getElementById('poVendorEmail').value = po.vendorEmail || '';
                    document.getElementById('poVendorPhone').value = po.vendorPhone || '';
                    document.getElementById('poVendorGST').value = po.vendorGST || '';
                    document.getElementById('poVendorAddress').value = po.vendorAddress || '';
                    document.getElementById('poGSTPercent').value = po.gstPercent || 18;
                    document.getElementById('poStatus').value = po.status || 'Draft';
                    document.getElementById('poNotes').value = po.notes || '';
                    
                    // Populate items
                    const itemsList = document.getElementById('poItemsList');
                    itemsList.innerHTML = '';
                    if (po.items && po.items.length > 0) {
                        po.items.forEach(item => {
                            addPOItem(item);
                        });
                    }
                    calculatePOTotal();
                }
            } else {
                document.getElementById('poModalTitle').textContent = 'Create Purchase Order';
                document.getElementById('poPONumber').value = 'PO' + Date.now();
                document.getElementById('poDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('poItemsList').innerHTML = '';
                addPOItem();
            }
            
            document.getElementById('purchaseOrderModal').classList.add('active');
        };
        
        window.addPOItem = (item = null) => {
            const itemsList = document.getElementById('poItemsList');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'invoice-item';
            itemDiv.innerHTML = `
                <input type="text" class="form-control" placeholder="Item/Material description" value="${item?.description || ''}" onchange="calculatePOTotal()">
                <input type="number" class="form-control" placeholder="Qty" min="1" value="${item?.quantity || 1}" onchange="calculatePOTotal()">
                <input type="text" class="form-control" placeholder="Unit" value="${item?.unit || 'pcs'}">
                <input type="number" class="form-control" placeholder="Rate" min="0" step="0.01" value="${item?.rate || ''}" onchange="calculatePOTotal()">
                <div class="item-amount">Rs. ${item ? (item.quantity * item.rate).toFixed(2) : '0.00'}</div>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calculatePOTotal();">‚úï</button>
            `;
            itemsList.appendChild(itemDiv);
        };
        
        window.calculatePOTotal = () => {
            let subtotal = 0;
            const items = document.querySelectorAll('#poItemsList .invoice-item');
            items.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const qty = parseFloat(inputs[1].value) || 0;
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = qty * rate;
                item.querySelector('.item-amount').textContent = 'Rs. ' + formatNumber(amount.toFixed(2));
                subtotal += amount;
            });
            
            const gstPercent = parseFloat(document.getElementById('poGSTPercent').value) || 0;
            const gstAmount = (subtotal * gstPercent) / 100;
            const total = subtotal + gstAmount;
            
            document.getElementById('poSubtotalDisplay').textContent = 'Rs. ' + formatNumber(subtotal.toFixed(2));
            document.getElementById('poTotalAmountDisplay').textContent = 'Rs. ' + formatNumber(total.toFixed(2));
        };
        
        document.getElementById('purchaseOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const poId = document.getElementById('editPOId').value;
            const items = [];
            let subtotal = 0;
            
            document.querySelectorAll('#poItemsList .invoice-item').forEach(item => {
                const inputs = item.querySelectorAll('input');
                const description = inputs[0].value.trim();
                const quantity = parseFloat(inputs[1].value) || 0;
                const unit = inputs[2].value.trim() || 'pcs';
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = quantity * rate;
                
                if (description && quantity > 0 && rate >= 0) {
                    items.push({ description, quantity, unit, rate, amount });
                    subtotal += amount;
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one item');
                return;
            }
            
            const gstPercent = parseFloat(document.getElementById('poGSTPercent').value) || 0;
            const gstAmount = (subtotal * gstPercent) / 100;
            const totalAmount = subtotal + gstAmount;
            
            const poData = {
                poNumber: document.getElementById('poPONumber').value.trim(),
                type: document.getElementById('poType').value,
                date: document.getElementById('poDate').value,
                deliveryDate: document.getElementById('poDeliveryDate').value,
                vendorName: document.getElementById('poVendorName').value.trim(),
                vendorEmail: document.getElementById('poVendorEmail').value.trim(),
                vendorPhone: document.getElementById('poVendorPhone').value.trim(),
                vendorGST: document.getElementById('poVendorGST').value.trim(),
                vendorAddress: document.getElementById('poVendorAddress').value.trim(),
                items: items,
                subtotal: subtotal,
                gstPercent: gstPercent,
                gstAmount: gstAmount,
                totalAmount: totalAmount,
                status: document.getElementById('poStatus').value,
                notes: document.getElementById('poNotes').value.trim(),
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser?.username || 'System'
            };
            
            try {
                if (typeof db !== 'undefined' && typeof addDoc !== 'undefined') {
                    if (poId) {
                        await updateDoc(doc(db, 'purchaseOrders', poId), poData);
                        alert('‚úÖ Purchase Order updated successfully!');
                    } else {
                        poData.createdAt = new Date().toISOString();
                        poData.createdBy = currentUser?.username || 'System';
                        await addDoc(collection(db, 'purchaseOrders'), poData);
                        alert('‚úÖ Purchase Order created successfully!');
                    }
                    closeModal('purchaseOrderModal');
                    await loadBillingData();
                }
            } catch (error) {
                console.error('Error saving purchase order:', error);
                alert('Error saving purchase order: ' + error.message);
            }
        });
        
        window.editPurchaseOrder = (id) => {
            showPurchaseOrderModal(id);
        };
        
        window.downloadPOPDF = async (id) => {
            const po = purchaseOrders.find(p => p.id === id);
            if (!po) return;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Use standard company header
            let y = await addCompanyHeaderToPDF(doc, 'PURCHASE ORDER', 10);

            // PO Details Box
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            
            doc.text(`PO Number: ${po.poNumber}`, 20, y);
            doc.text(`Date: ${new Date(po.date).toLocaleDateString('en-GB')}`, 140, y);
            y += 7;
            doc.text(`Delivery Date: ${new Date(po.deliveryDate).toLocaleDateString('en-GB')}`, 20, y);
            
            y += 12;
            
            // Vendor Details
            doc.setFontSize(11);
            doc.setTextColor(37, 99, 235);
            doc.text('VENDOR DETAILS:', 20, y);
            y += 7;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(`Name: ${po.vendorName}`, 20, y);
            y += 6;
            if (po.vendorContact) {
                doc.text(`Contact: ${po.vendorContact}`, 20, y);
                y += 6;
            }
            if (po.vendorAddress) {
                const addressLines = doc.splitTextToSize(po.vendorAddress, 85);
                doc.text(addressLines, 20, y);
                y += (addressLines.length * 6);
            }
            
            y += 10;
            
            // Items Table
            doc.setFillColor(37, 99, 235);
            doc.rect(20, y, 170, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text('Description', 22, y + 5);
            doc.text('Qty', 110, y + 5);
            doc.text('Unit', 130, y + 5);
            doc.text('Rate', 150, y + 5);
            doc.text('Amount', 170, y + 5);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            
            po.items.forEach((item, index) => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                const amount = (item.quantity || 0) * (item.rate || 0);
                doc.setFontSize(9);
                
                const descLines = doc.splitTextToSize(item.description || '', 85);
                doc.text(descLines, 22, y + 4);
                doc.text(String(item.quantity || 0), 110, y + 4);
                doc.text(item.unit || 'pcs', 130, y + 4);
                doc.text(`Rs. ${(item.rate || 0).toFixed(2)}`, 150, y + 4);
                doc.text(`Rs. ${amount.toFixed(2)}`, 170, y + 4);
                
                y += Math.max(6, descLines.length * 4);
                doc.line(20, y, 190, y);
                y += 2;
            });
            
            // Total
            y += 5;
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('TOTAL AMOUNT:', 130, y);
            doc.text(`Rs. ${po.totalAmount.toFixed(2)}`, 170, y);
            doc.setFont(undefined, 'normal');
            
            // Notes
            if (po.notes) {
                y += 12;
                doc.setFontSize(10);
                doc.setTextColor(37, 99, 235);
                doc.text('Notes:', 20, y);
                y += 6;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(9);
                const notesLines = doc.splitTextToSize(po.notes, 170);
                doc.text(notesLines, 20, y);
            }
            
            // Add company footer to all pages
            await addCompanyFooterToPDF(doc);

            doc.save(`Purchase_Order_${po.poNumber}.pdf`);

            // Get PDF as blob for potential email sending
            const pdfBlob = doc.output('blob');
            const fileName = `Purchase_Order_${po.poNumber}.pdf`;

            // Show email option if email is configured and vendor has email
            const companyInfo = await getCompanyInfo();
            const emailConfig = JSON.parse(localStorage.getItem('emailConfig') || '{}');
            if (emailConfig.validated && po.vendorEmail) {
                const sendEmail = confirm(`Purchase Order generated successfully!\n\nWould you like to email this PO to ${po.vendorName}?\nEmail: ${po.vendorEmail}`);
                if (sendEmail) {
                    const subject = `Purchase Order #${po.poNumber} from ${companyInfo.name || 'Avant Elevators'}`;
                    const body = `Dear ${po.vendorName},\n\nPlease find attached Purchase Order #${po.poNumber}.\n\nTotal Amount: Rs. ${formatNumber(po.totalAmount)}\nDelivery Date: ${po.deliveryDate || 'As per terms'}\nStatus: ${po.status}\n\nPlease confirm receipt and expected delivery timeline.\n\nBest regards,\nProcurement Team\n${companyInfo.name || 'Avant Elevators'}`;

                    await sendEmailWithPDF(po.vendorEmail, po.vendorName, subject, body, pdfBlob, fileName);
                }
            }
        };


        // ========== PROFORMA INVOICES ==========
        
        function renderProformaInvoices() {
            const tbody = document.getElementById('proformaInvoicesList');
            if (proformaInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">üìÑ</div><p>No proforma invoices yet.</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = proformaInvoices.map(pi => `
                <tr>
                    <td><strong>${pi.piNumber}</strong></td>
                    <td>${pi.clientName}</td>
                    <td>${new Date(pi.date).toLocaleDateString('en-IN')}</td>
                    <td><strong>Rs. ${formatNumber(pi.totalAmount.toFixed(2))}</strong></td>
                    <td><span style="color: #16a34a;">Rs. ${formatNumber(pi.paidAmount.toFixed(2))}</span></td>
                    <td><span style="color: #dc2626;">Rs. ${formatNumber(pi.balanceAmount.toFixed(2))}</span></td>
                    <td><span class="badge badge-${getStatusColor(pi.status)}">${pi.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="downloadPIPDF('${pi.id}')">üìÑ PDF</button>
                            <button class="btn btn-warning btn-sm" onclick="sendProformaInvoiceEmail('${pi.id}')">üìß Send</button>
                            <button class="btn btn-success btn-sm" onclick="recordPayment('${pi.id}')">üí∞ Payment</button>
                            ${pi.status === 'Paid' ? `<button class="btn btn-info btn-sm" onclick="convertPIToTaxInvoice('${pi.id}')">‚Üí Invoice</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        window.showProformaInvoiceModal = (piId = null) => {
            document.getElementById('proformaInvoiceForm').reset();
            document.getElementById('editPIId').value = '';
            
            // Populate linked quotations dropdown
            const linkedQuotSelect = document.getElementById('piLinkedQuotation');
            linkedQuotSelect.innerHTML = '<option value="">-- Direct PI (No Quotation) --</option>' +
                quotations.filter(q => q.status !== 'Rejected').map(q => 
                    `<option value="${q.id}">${q.quotationNumber} - ${q.clientName} (Rs. ${formatNumber(q.totalAmount.toFixed(2))})</option>`
                ).join('');
            
            if (piId) {
                const pi = proformaInvoices.find(p => p.id === piId);
                if (pi) {
                    document.getElementById('piModalTitle').textContent = 'Edit Proforma Invoice';
                    document.getElementById('editPIId').value = pi.id;
                    document.getElementById('piNumber').value = pi.piNumber || '';
                    document.getElementById('piDate').value = pi.date ? pi.date.split('T')[0] : '';
                    document.getElementById('piType').value = pi.type || '';
                    document.getElementById('piLinkedQuotation').value = pi.quotationId || '';
                    document.getElementById('piClientName').value = pi.clientName || '';
                    document.getElementById('piClientEmail').value = pi.clientEmail || '';
                    document.getElementById('piClientPhone').value = pi.clientPhone || '';
                    document.getElementById('piClientGST').value = pi.clientGST || '';
                    document.getElementById('piClientAddress').value = pi.clientAddress || '';
                    document.getElementById('piDiscountPercent').value = pi.discountPercent || 0;
                    document.getElementById('piGSTPercent').value = pi.gstPercent || 18;
                    document.getElementById('piAdvancePercent').value = pi.advancePercent || 30;
                    document.getElementById('piDueDate').value = pi.dueDate || '';
                    document.getElementById('piTerms').value = pi.terms || '';
                    document.getElementById('piNotes').value = pi.notes || '';
                    
                    // Populate items
                    const itemsList = document.getElementById('piItemsList');
                    itemsList.innerHTML = '';
                    if (pi.items && pi.items.length > 0) {
                        pi.items.forEach(item => {
                            addPIItem(item);
                        });
                    }
                    calculatePITotal();
                }
            } else {
                document.getElementById('piModalTitle').textContent = 'Create Proforma Invoice';
                document.getElementById('piNumber').value = 'PI' + Date.now();
                document.getElementById('piDate').value = new Date().toISOString().split('T')[0];
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 15);
                document.getElementById('piDueDate').value = dueDate.toISOString().split('T')[0];
                document.getElementById('piItemsList').innerHTML = '';
                addPIItem();
            }
            
            document.getElementById('proformaInvoiceModal').classList.add('active');
        };
        
        window.loadQuotationToPI = () => {
            const quotId = document.getElementById('piLinkedQuotation').value;
            if (!quotId) return;
            
            const quot = quotations.find(q => q.id === quotId);
            if (!quot) return;
            
            document.getElementById('piType').value = quot.type || '';
            document.getElementById('piClientName').value = quot.clientName || '';
            document.getElementById('piClientEmail').value = quot.clientEmail || '';
            document.getElementById('piClientPhone').value = quot.clientPhone || '';
            document.getElementById('piClientGST').value = quot.clientGST || '';
            document.getElementById('piClientAddress').value = quot.clientAddress || '';
            document.getElementById('piDiscountPercent').value = quot.discountPercent || 0;
            document.getElementById('piGSTPercent').value = quot.gstPercent || 18;
            
            // Populate items
            const itemsList = document.getElementById('piItemsList');
            itemsList.innerHTML = '';
            if (quot.items && quot.items.length > 0) {
                quot.items.forEach(item => {
                    addPIItem(item);
                });
            }
            calculatePITotal();
        };
        
        window.addPIItem = (item = null) => {
            const itemsList = document.getElementById('piItemsList');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'invoice-item';
            itemDiv.innerHTML = `
                <input type="text" class="form-control" placeholder="Item description" value="${item?.description || ''}" onchange="calculatePITotal()">
                <input type="number" class="form-control" placeholder="Qty" min="1" value="${item?.quantity || 1}" onchange="calculatePITotal()">
                <input type="text" class="form-control" placeholder="Unit" value="${item?.unit || 'pcs'}">
                <input type="number" class="form-control" placeholder="Rate" min="0" step="0.01" value="${item?.rate || ''}" onchange="calculatePITotal()">
                <div class="item-amount">Rs. ${item ? (item.quantity * item.rate).toFixed(2) : '0.00'}</div>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calculatePITotal();">‚úï</button>
            `;
            itemsList.appendChild(itemDiv);
        };
        
        window.calculatePITotal = () => {
            let subtotal = 0;
            const items = document.querySelectorAll('#piItemsList .invoice-item');
            items.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const qty = parseFloat(inputs[1].value) || 0;
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = qty * rate;
                item.querySelector('.item-amount').textContent = 'Rs. ' + formatNumber(amount.toFixed(2));
                subtotal += amount;
            });
            
            const discountPercent = parseFloat(document.getElementById('piDiscountPercent').value) || 0;
            const gstPercent = parseFloat(document.getElementById('piGSTPercent').value) || 0;
            
            const discountAmount = (subtotal * discountPercent) / 100;
            const afterDiscount = subtotal - discountAmount;
            const gstAmount = (afterDiscount * gstPercent) / 100;
            const total = afterDiscount + gstAmount;
            
            document.getElementById('piSubtotalDisplay').textContent = 'Rs. ' + formatNumber(subtotal.toFixed(2));
            document.getElementById('piTotalAmountDisplay').textContent = 'Rs. ' + formatNumber(total.toFixed(2));
            
            calculatePIAdvance();
        };
        
        window.calculatePIAdvance = () => {
            const totalText = document.getElementById('piTotalAmountDisplay').textContent;
            const total = parseFloat(totalText.replace('Rs. ', '').replace(/,/g, '')) || 0;
            const advancePercent = parseFloat(document.getElementById('piAdvancePercent').value) || 0;
            
            const advanceAmount = (total * advancePercent) / 100;
            const balanceAmount = total - advanceAmount;
            
            document.getElementById('piAdvanceAmountDisplay').textContent = 'Rs. ' + formatNumber(advanceAmount.toFixed(2));
            document.getElementById('piBalanceAmountDisplay').textContent = 'Rs. ' + formatNumber(balanceAmount.toFixed(2));
        };
        
        document.getElementById('proformaInvoiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const piId = document.getElementById('editPIId').value;
            const items = [];
            let subtotal = 0;
            
            document.querySelectorAll('#piItemsList .invoice-item').forEach(item => {
                const inputs = item.querySelectorAll('input');
                const description = inputs[0].value.trim();
                const quantity = parseFloat(inputs[1].value) || 0;
                const unit = inputs[2].value.trim() || 'pcs';
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = quantity * rate;
                
                if (description && quantity > 0 && rate >= 0) {
                    items.push({ description, quantity, unit, rate, amount });
                    subtotal += amount;
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one item');
                return;
            }
            
            const discountPercent = parseFloat(document.getElementById('piDiscountPercent').value) || 0;
            const gstPercent = parseFloat(document.getElementById('piGSTPercent').value) || 0;
            const discountAmount = (subtotal * discountPercent) / 100;
            const afterDiscount = subtotal - discountAmount;
            const gstAmount = (afterDiscount * gstPercent) / 100;
            const totalAmount = afterDiscount + gstAmount;
            
            const advancePercent = parseFloat(document.getElementById('piAdvancePercent').value) || 0;
            const advanceAmount = (totalAmount * advancePercent) / 100;
            
            const piData = {
                piNumber: document.getElementById('piNumber').value.trim(),
                type: document.getElementById('piType').value,
                date: document.getElementById('piDate').value,
                quotationId: document.getElementById('piLinkedQuotation').value || null,
                clientName: document.getElementById('piClientName').value.trim(),
                clientEmail: document.getElementById('piClientEmail').value.trim(),
                clientPhone: document.getElementById('piClientPhone').value.trim(),
                clientGST: document.getElementById('piClientGST').value.trim(),
                clientAddress: document.getElementById('piClientAddress').value.trim(),
                items: items,
                subtotal: subtotal,
                discountPercent: discountPercent,
                discountAmount: discountAmount,
                gstPercent: gstPercent,
                gstAmount: gstAmount,
                totalAmount: totalAmount,
                advancePercent: advancePercent,
                advanceAmount: advanceAmount,
                paidAmount: piId ? proformaInvoices.find(p => p.id === piId)?.paidAmount || 0 : 0,
                balanceAmount: piId ? totalAmount - (proformaInvoices.find(p => p.id === piId)?.paidAmount || 0) : totalAmount,
                status: piId ? proformaInvoices.find(p => p.id === piId)?.status || 'Pending' : 'Pending',
                dueDate: document.getElementById('piDueDate').value,
                terms: document.getElementById('piTerms').value.trim(),
                notes: document.getElementById('piNotes').value.trim(),
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser?.username || 'System'
            };
            
            try {
                if (typeof db !== 'undefined' && typeof addDoc !== 'undefined') {
                    if (piId) {
                        await updateDoc(doc(db, 'proformaInvoices', piId), piData);
                        alert('‚úÖ Proforma Invoice updated successfully!');
                    } else {
                        piData.createdAt = new Date().toISOString();
                        piData.createdBy = currentUser?.username || 'System';
                        await addDoc(collection(db, 'proformaInvoices'), piData);
                        alert('‚úÖ Proforma Invoice created successfully!');
                    }
                    closeModal('proformaInvoiceModal');
                    await loadBillingData();
                }
            } catch (error) {
                console.error('Error saving proforma invoice:', error);
                alert('Error saving proforma invoice: ' + error.message);
            }
        });
        
        window.downloadPIPDF = async (id) => {
            const pi = proformaInvoices.find(p => p.id === id);
            if (!pi) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const companyInfo = await getCompanyInfo();
            
            // Header
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text(companyInfo.name || 'Avant Elevators', 105, 15, { align: 'center' });
            doc.setFontSize(9);
            doc.text(companyInfo.address || 'Company Address', 105, 22, { align: 'center' });
            doc.text(`Email: ${companyInfo.email || 'info@company.com'} | Phone: ${companyInfo.contact || '+91 1234567890'}`, 105, 27, { align: 'center' });
            if (companyInfo.gst) {
                doc.text(`GST: ${companyInfo.gst}`, 105, 32, { align: 'center' });
            }
            
            doc.setFontSize(18);
            doc.setTextColor(37, 99, 235);
            doc.text('PROFORMA INVOICE', 105, 40, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            let y = 55;
            
            doc.text(`PI Number: ${pi.piNumber}`, 20, y);
            doc.text(`Date: ${new Date(pi.date).toLocaleDateString('en-GB')}`, 140, y);
            y += 7;
            doc.text(`Valid Until: ${new Date(pi.validUntil).toLocaleDateString('en-GB')}`, 20, y);
            
            y += 12;
            
            // Client Details
            doc.setFontSize(11);
            doc.setTextColor(37, 99, 235);
            doc.text('BILL TO:', 20, y);
            y += 7;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(pi.clientName, 20, y);
            y += 6;
            if (pi.clientContact) {
                doc.text(`Contact: ${pi.clientContact}`, 20, y);
                y += 6;
            }
            if (pi.clientEmail) {
                doc.text(`Email: ${pi.clientEmail}`, 20, y);
                y += 6;
            }
            if (pi.clientAddress) {
                const addressLines = doc.splitTextToSize(pi.clientAddress, 85);
                doc.text(addressLines, 20, y);
                y += (addressLines.length * 6);
            }
            
            y += 10;
            
            // Items Table
            doc.setFillColor(37, 99, 235);
            doc.rect(20, y, 170, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text('Description', 22, y + 5);
            doc.text('Qty', 110, y + 5);
            doc.text('Unit', 130, y + 5);
            doc.text('Rate', 150, y + 5);
            doc.text('Amount', 170, y + 5);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            
            pi.items.forEach((item, index) => {
                if (y > 230) {
                    doc.addPage();
                    y = 20;
                }
                
                const amount = (item.quantity || 0) * (item.rate || 0);
                doc.setFontSize(9);
                
                const descLines = doc.splitTextToSize(item.description || '', 85);
                doc.text(descLines, 22, y + 4);
                doc.text(String(item.quantity || 0), 110, y + 4);
                doc.text(item.unit || 'pcs', 130, y + 4);
                doc.text(`Rs. ${(item.rate || 0).toFixed(2)}`, 150, y + 4);
                doc.text(`Rs. ${amount.toFixed(2)}`, 170, y + 4);
                
                y += Math.max(6, descLines.length * 4);
                doc.line(20, y, 190, y);
                y += 2;
            });
            
            // Totals
            y += 5;
            doc.setFontSize(10);
            doc.text('Subtotal:', 130, y);
            doc.text(`Rs. ${pi.totalAmount.toFixed(2)}`, 170, y);
            y += 7;
            
            if (pi.advanceAmount > 0) {
                doc.text('Advance Payment:', 130, y);
                doc.text(`Rs. ${pi.advanceAmount.toFixed(2)}`, 170, y);
                y += 7;
                
                doc.setFont(undefined, 'bold');
                doc.text('Balance Due:', 130, y);
                doc.text(`Rs. ${(pi.totalAmount - pi.advanceAmount).toFixed(2)}`, 170, y);
                doc.setFont(undefined, 'normal');
            } else {
                doc.setFont(undefined, 'bold');
                doc.text('TOTAL AMOUNT:', 130, y);
                doc.text(`Rs. ${pi.totalAmount.toFixed(2)}`, 170, y);
                doc.setFont(undefined, 'normal');
            }
            
            // Payment Status
            if (pi.paymentStatus) {
                y += 10;
                doc.setFontSize(9);
                doc.setTextColor(pi.paymentStatus === 'Paid' ? 22 : (pi.paymentStatus === 'Partial' ? 234 : 220), pi.paymentStatus === 'Paid' ? 163 : 88, pi.paymentStatus === 'Paid' ? 74 : 38);
                doc.text(`Payment Status: ${pi.paymentStatus}`, 20, y);
                doc.setTextColor(0, 0, 0);
            }
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('This is a computer-generated Proforma Invoice.', 105, 285, { align: 'center' });
            
            doc.save(`Proforma_Invoice_${pi.piNumber}.pdf`);
            
            // Get PDF as blob for potential email sending
            const pdfBlob = doc.output('blob');
            const fileName = `Proforma_Invoice_${pi.piNumber}.pdf`;
            
            // Show email option if email is configured and client has email
            const emailConfig = JSON.parse(localStorage.getItem('emailConfig') || '{}');
            if (emailConfig.validated && pi.clientEmail) {
                const sendEmail = confirm(`Proforma Invoice generated successfully!\n\nWould you like to email this Proforma Invoice to ${pi.clientName}?\nEmail: ${pi.clientEmail}`);
                if (sendEmail) {
                    const subject = `Proforma Invoice #${pi.piNumber} from ${companyInfo.name || 'Avant Elevators'}`;
                    const body = `Dear ${pi.clientName},\n\nPlease find attached Proforma Invoice #${pi.piNumber}.\n\nTotal Amount: Rs. ${formatNumber(pi.totalAmount)}\nValid Until: ${pi.validUntil || 'As per terms'}\nPayment Terms: ${pi.paymentTerms || 'As discussed'}\n\n${pi.advanceAmount ? `Advance Amount: Rs. ${formatNumber(pi.advanceAmount)}\nBalance Amount: Rs. ${formatNumber(pi.totalAmount - pi.advanceAmount)}\n\n` : ''}Please review and let us know if you have any questions.\n\nBest regards,\n${companyInfo.name || 'Avant Elevators'}`;
                    
                    await sendEmailWithPDF(pi.clientEmail, pi.clientName, subject, body, pdfBlob, fileName);
                }
            }
        };


        window.recordPayment = async (piId) => {
            const pi = proformaInvoices.find(p => p.id === piId);
            if (!pi) return;
            
            const paymentAmount = prompt(`Enter payment amount (Balance: Rs. ${formatNumber(pi.balanceAmount.toFixed(2))}):`);
            if (!paymentAmount || isNaN(paymentAmount)) return;
            
            const amount = parseFloat(paymentAmount);
            if (amount > pi.balanceAmount) {
                alert('Payment amount cannot exceed balance!');
                return;
            }
            
            const newPaidAmount = pi.paidAmount + amount;
            const newBalanceAmount = pi.totalAmount - newPaidAmount;
            let newStatus = 'Pending';
            
            if (newBalanceAmount === 0) {
                newStatus = 'Paid';
            } else if (newPaidAmount > 0) {
                newStatus = 'Partial';
            }
            
            try {
                if (typeof db !== 'undefined' && typeof updateDoc !== 'undefined') {
                    await updateDoc(doc(db, 'proformaInvoices', piId), {
                        paidAmount: newPaidAmount,
                        balanceAmount: newBalanceAmount,
                        status: newStatus,
                        lastPaymentDate: new Date().toISOString()
                    });
                    
                    alert('‚úÖ Payment recorded successfully!');
                    await loadBillingData();
                }
            } catch (error) {
                console.error('Error recording payment:', error);
                alert('Error recording payment: ' + error.message);
            }
        };

        window.convertPIToTaxInvoice = async (piId) => {
            const pi = proformaInvoices.find(p => p.id === piId);
            if (!pi) return;
            
            if (pi.status !== 'Paid') {
                alert('PI must be fully paid before converting to Tax Invoice!');
                return;
            }
            
            if (!confirm(`Convert PI ${pi.piNumber} to Tax Invoice? The PI will be automatically deleted.`)) return;
            
            const tiData = {
                invoiceNumber: 'TI' + Date.now(),
                piId: pi.id,
                piNumber: pi.piNumber,
                clientName: pi.clientName,
                clientEmail: pi.clientEmail,
                clientPhone: pi.clientPhone,
                clientAddress: pi.clientAddress,
                date: new Date().toISOString(),
                type: pi.type,
                items: pi.items,
                totalAmount: pi.totalAmount,
                status: 'Paid',
                createdDate: new Date().toISOString(),
                createdBy: currentUser?.username || 'System'
            };
            
            try {
                if (typeof db !== 'undefined' && typeof addDoc !== 'undefined' && typeof deleteDoc !== 'undefined') {
                    // Create Tax Invoice
                    await addDoc(collection(db, 'taxInvoices'), tiData);
                    
                    // Delete PI
                    await deleteDoc(doc(db, 'proformaInvoices', piId));
                    
                    alert('‚úÖ Tax Invoice created and PI deleted successfully!');
                    await loadBillingData();
                    showBillingSection('taxInvoices');
                }
            } catch (error) {
                console.error('Error converting PI to Tax Invoice:', error);
                alert('Error: ' + error.message);
            }
        };

        // ========== TAX INVOICES ==========
        
        function renderTaxInvoices() {
            const tbody = document.getElementById('taxInvoicesList');
            if (taxInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üíµ</div><p>No tax invoices yet.</p></td></tr>';
                return;
            }
            
            tbody.innerHTML = taxInvoices.map(ti => `
                <tr>
                    <td><strong>${ti.invoiceNumber}</strong></td>
                    <td>${ti.clientName}</td>
                    <td>${new Date(ti.date).toLocaleDateString('en-IN')}</td>
                    <td><strong>Rs. ${formatNumber(ti.totalAmount.toFixed(2))}</strong></td>
                    <td><span class="badge badge-success">${ti.status}</span></td>
                    <td><small>${ti.piNumber || 'N/A'}</small></td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-primary btn-sm" onclick="downloadTaxInvoicePDF('${ti.id}')">üìÑ PDF</button>
                            <button class="btn btn-warning btn-sm" onclick="sendTaxInvoiceEmail('${ti.id}')">üìß Send</button>
                            <button class="btn btn-secondary btn-sm" onclick="viewInvoiceDetails('${ti.id}')">üëÅÔ∏è View</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        window.showTaxInvoiceModal = (tiId = null) => {
            document.getElementById('taxInvoiceForm').reset();
            document.getElementById('editTIId').value = '';
            
            // Populate linked PI dropdown (only fully paid PIs)
            const linkedPISelect = document.getElementById('tiLinkedPI');
            linkedPISelect.innerHTML = '<option value="">-- Direct Invoice (No PI) --</option>' +
                proformaInvoices.filter(pi => pi.status === 'Paid').map(pi => 
                    `<option value="${pi.id}">${pi.piNumber} - ${pi.clientName} (Rs. ${formatNumber(pi.totalAmount.toFixed(2))})</option>`
                ).join('');
            
            if (tiId) {
                const ti = taxInvoices.find(t => t.id === tiId);
                if (ti) {
                    document.getElementById('tiModalTitle').textContent = 'Edit Tax Invoice';
                    document.getElementById('editTIId').value = ti.id;
                    document.getElementById('tiNumber').value = ti.invoiceNumber || '';
                    document.getElementById('tiDate').value = ti.date ? ti.date.split('T')[0] : '';
                    document.getElementById('tiType').value = ti.type || '';
                    document.getElementById('tiLinkedPI').value = ti.piId || '';
                    document.getElementById('tiClientName').value = ti.clientName || '';
                    document.getElementById('tiClientEmail').value = ti.clientEmail || '';
                    document.getElementById('tiClientPhone').value = ti.clientPhone || '';
                    document.getElementById('tiClientGST').value = ti.clientGST || '';
                    document.getElementById('tiClientAddress').value = ti.clientAddress || '';
                    document.getElementById('tiDiscountPercent').value = ti.discountPercent || 0;
                    document.getElementById('tiCGSTPercent').value = ti.cgstPercent || 9;
                    document.getElementById('tiSGSTPercent').value = ti.sgstPercent || 9;
                    document.getElementById('tiStatus').value = ti.status || 'Pending';
                    document.getElementById('tiBankName').value = ti.bankName || '';
                    document.getElementById('tiAccountNumber').value = ti.accountNumber || '';
                    document.getElementById('tiIFSC').value = ti.ifsc || '';
                    document.getElementById('tiAccountName').value = ti.accountName || '';
                    document.getElementById('tiTerms').value = ti.terms || '';
                    document.getElementById('tiNotes').value = ti.notes || '';
                    
                    // Populate items
                    const itemsList = document.getElementById('tiItemsList');
                    itemsList.innerHTML = '';
                    if (ti.items && ti.items.length > 0) {
                        ti.items.forEach(item => {
                            addTIItem(item);
                        });
                    }
                    calculateTITotal();
                }
            } else {
                document.getElementById('tiModalTitle').textContent = 'Create Tax Invoice';
                document.getElementById('tiNumber').value = 'INV' + Date.now();
                document.getElementById('tiDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('tiItemsList').innerHTML = '';
                addTIItem();
            }
            
            document.getElementById('taxInvoiceModal').classList.add('active');
        };
        
        window.loadPIToTaxInvoice = () => {
            const piId = document.getElementById('tiLinkedPI').value;
            if (!piId) return;
            
            const pi = proformaInvoices.find(p => p.id === piId);
            if (!pi) return;
            
            document.getElementById('tiType').value = pi.type || '';
            document.getElementById('tiClientName').value = pi.clientName || '';
            document.getElementById('tiClientEmail').value = pi.clientEmail || '';
            document.getElementById('tiClientPhone').value = pi.clientPhone || '';
            document.getElementById('tiClientGST').value = pi.clientGST || '';
            document.getElementById('tiClientAddress').value = pi.clientAddress || '';
            
            // Convert GST to CGST + SGST
            const totalGST = pi.gstPercent || 18;
            document.getElementById('tiCGSTPercent').value = totalGST / 2;
            document.getElementById('tiSGSTPercent').value = totalGST / 2;
            document.getElementById('tiDiscountPercent').value = pi.discountPercent || 0;
            
            // Populate items
            const itemsList = document.getElementById('tiItemsList');
            itemsList.innerHTML = '';
            if (pi.items && pi.items.length > 0) {
                pi.items.forEach(item => {
                    addTIItem(item);
                });
            }
            calculateTITotal();
        };
        
        window.addTIItem = (item = null) => {
            const itemsList = document.getElementById('tiItemsList');
            const itemDiv = document.createElement('div');
            itemDiv.className = 'invoice-item';
            itemDiv.innerHTML = `
                <input type="text" class="form-control" placeholder="Item description" value="${item?.description || ''}" onchange="calculateTITotal()">
                <input type="text" class="form-control" placeholder="HSN/SAC" value="${item?.hsn || '8428'}">
                <input type="number" class="form-control" placeholder="Qty" min="1" value="${item?.quantity || 1}" onchange="calculateTITotal()">
                <input type="number" class="form-control" placeholder="Rate" min="0" step="0.01" value="${item?.rate || ''}" onchange="calculateTITotal()">
                <div class="item-amount">Rs. ${item ? (item.quantity * item.rate).toFixed(2) : '0.00'}</div>
                <button type="button" class="btn btn-danger btn-sm" onclick="this.parentElement.remove(); calculateTITotal();">‚úï</button>
            `;
            itemsList.appendChild(itemDiv);
        };
        
        window.calculateTITotal = () => {
            let subtotal = 0;
            const items = document.querySelectorAll('#tiItemsList .invoice-item');
            items.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const qty = parseFloat(inputs[2].value) || 0;
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = qty * rate;
                item.querySelector('.item-amount').textContent = 'Rs. ' + formatNumber(amount.toFixed(2));
                subtotal += amount;
            });
            
            const discountPercent = parseFloat(document.getElementById('tiDiscountPercent').value) || 0;
            const cgstPercent = parseFloat(document.getElementById('tiCGSTPercent').value) || 0;
            const sgstPercent = parseFloat(document.getElementById('tiSGSTPercent').value) || 0;
            
            const discountAmount = (subtotal * discountPercent) / 100;
            const afterDiscount = subtotal - discountAmount;
            const cgstAmount = (afterDiscount * cgstPercent) / 100;
            const sgstAmount = (afterDiscount * sgstPercent) / 100;
            const total = afterDiscount + cgstAmount + sgstAmount;
            
            document.getElementById('tiSubtotalDisplay').textContent = 'Rs. ' + formatNumber(subtotal.toFixed(2));
            document.getElementById('tiCGSTAmountDisplay').textContent = 'Rs. ' + formatNumber(cgstAmount.toFixed(2));
            document.getElementById('tiSGSTAmountDisplay').textContent = 'Rs. ' + formatNumber(sgstAmount.toFixed(2));
            document.getElementById('tiTotalAmountDisplay').textContent = 'Rs. ' + formatNumber(total.toFixed(2));
        };
        
        document.getElementById('taxInvoiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const tiId = document.getElementById('editTIId').value;
            const items = [];
            let subtotal = 0;
            
            document.querySelectorAll('#tiItemsList .invoice-item').forEach(item => {
                const inputs = item.querySelectorAll('input');
                const description = inputs[0].value.trim();
                const hsn = inputs[1].value.trim() || '8428';
                const quantity = parseFloat(inputs[2].value) || 0;
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = quantity * rate;
                
                if (description && quantity > 0 && rate >= 0) {
                    items.push({ description, hsn, quantity, rate, amount });
                    subtotal += amount;
                }
            });
            
            if (items.length === 0) {
                alert('Please add at least one item');
                return;
            }
            
            const discountPercent = parseFloat(document.getElementById('tiDiscountPercent').value) || 0;
            const cgstPercent = parseFloat(document.getElementById('tiCGSTPercent').value) || 0;
            const sgstPercent = parseFloat(document.getElementById('tiSGSTPercent').value) || 0;
            const discountAmount = (subtotal * discountPercent) / 100;
            const afterDiscount = subtotal - discountAmount;
            const cgstAmount = (afterDiscount * cgstPercent) / 100;
            const sgstAmount = (afterDiscount * sgstPercent) / 100;
            const totalAmount = afterDiscount + cgstAmount + sgstAmount;
            
            const tiData = {
                invoiceNumber: document.getElementById('tiNumber').value.trim(),
                type: document.getElementById('tiType').value,
                date: document.getElementById('tiDate').value,
                piId: document.getElementById('tiLinkedPI').value || null,
                piNumber: document.getElementById('tiLinkedPI').value ? 
                    proformaInvoices.find(p => p.id === document.getElementById('tiLinkedPI').value)?.piNumber : null,
                clientName: document.getElementById('tiClientName').value.trim(),
                clientEmail: document.getElementById('tiClientEmail').value.trim(),
                clientPhone: document.getElementById('tiClientPhone').value.trim(),
                clientGST: document.getElementById('tiClientGST').value.trim(),
                clientAddress: document.getElementById('tiClientAddress').value.trim(),
                items: items,
                subtotal: subtotal,
                discountPercent: discountPercent,
                discountAmount: discountAmount,
                cgstPercent: cgstPercent,
                cgstAmount: cgstAmount,
                sgstPercent: sgstPercent,
                sgstAmount: sgstAmount,
                totalAmount: totalAmount,
                status: document.getElementById('tiStatus').value,
                bankName: document.getElementById('tiBankName').value.trim(),
                accountNumber: document.getElementById('tiAccountNumber').value.trim(),
                ifsc: document.getElementById('tiIFSC').value.trim(),
                accountName: document.getElementById('tiAccountName').value.trim(),
                terms: document.getElementById('tiTerms').value.trim(),
                notes: document.getElementById('tiNotes').value.trim(),
                updatedAt: new Date().toISOString(),
                updatedBy: currentUser?.username || 'System'
            };
            
            try {
                if (typeof db !== 'undefined' && typeof addDoc !== 'undefined') {
                    if (tiId) {
                        await updateDoc(doc(db, 'taxInvoices', tiId), tiData);
                        alert('‚úÖ Tax Invoice updated successfully!');
                    } else {
                        tiData.createdAt = new Date().toISOString();
                        tiData.createdBy = currentUser?.username || 'System';
                        await addDoc(collection(db, 'taxInvoices'), tiData);
                        alert('‚úÖ Tax Invoice created successfully!');
                    }
                    closeModal('taxInvoiceModal');
                    await loadBillingData();
                }
            } catch (error) {
                console.error('Error saving tax invoice:', error);
                alert('Error saving tax invoice: ' + error.message);
            }
        });
        
        window.downloadTaxInvoicePDF = async (id) => {
            const ti = taxInvoices.find(t => t.id === id);
            if (!ti) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const companyInfo = await getCompanyInfo();
            
            // Header
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text(companyInfo.name || 'Avant Elevators', 105, 15, { align: 'center' });
            doc.setFontSize(9);
            doc.text(companyInfo.address || 'Company Address', 105, 22, { align: 'center' });
            doc.text(`Email: ${companyInfo.email || 'info@company.com'} | Phone: ${companyInfo.contact || '+91 1234567890'}`, 105, 27, { align: 'center' });
            doc.text(`GST: ${companyInfo.gst || 'N/A'} | PAN: ${companyInfo.pan || 'N/A'}`, 105, 32, { align: 'center' });
            
            doc.setFontSize(18);
            doc.setTextColor(255, 255, 255);
            doc.text('TAX INVOICE', 105, 40, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            let y = 55;
            
            doc.text(`Invoice No: ${ti.invoiceNumber}`, 20, y);
            doc.text(`Date: ${new Date(ti.invoiceDate).toLocaleDateString('en-GB')}`, 140, y);
            y += 7;
            if (ti.dueDate) {
                doc.text(`Due Date: ${new Date(ti.dueDate).toLocaleDateString('en-GB')}`, 20, y);
            }
            
            y += 12;
            
            // Client Details
            doc.setFontSize(11);
            doc.setTextColor(37, 99, 235);
            doc.text('BILL TO:', 20, y);
            y += 7;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            doc.text(ti.clientName, 20, y);
            y += 6;
            doc.text(`GST: ${ti.clientGST}`, 20, y);
            y += 6;
            if (ti.clientContact) {
                doc.text(`Contact: ${ti.clientContact}`, 20, y);
                y += 6;
            }
            if (ti.clientAddress) {
                const addressLines = doc.splitTextToSize(ti.clientAddress, 85);
                doc.text(addressLines, 20, y);
                y += (addressLines.length * 6);
            }
            
            y += 10;
            
            // Items Table with GST
            doc.setFillColor(37, 99, 235);
            doc.rect(20, y, 170, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text('Description', 22, y + 5);
            doc.text('HSN', 85, y + 5);
            doc.text('Qty', 105, y + 5);
            doc.text('Rate', 125, y + 5);
            doc.text('GST%', 145, y + 5);
            doc.text('Amount', 170, y + 5);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            
            let subtotal = 0;
            ti.items.forEach((item, index) => {
                if (y > 220) {
                    doc.addPage();
                    y = 20;
                }
                
                const baseAmount = (item.quantity || 0) * (item.rate || 0);
                const gstAmount = baseAmount * ((item.gst || 0) / 100);
                const totalAmount = baseAmount + gstAmount;
                subtotal += baseAmount;
                
                doc.setFontSize(8);
                
                const descLines = doc.splitTextToSize(item.description || '', 55);
                doc.text(descLines, 22, y + 4);
                doc.text(item.hsn || '', 85, y + 4);
                doc.text(String(item.quantity || 0), 105, y + 4);
                doc.text(`${(item.rate || 0).toFixed(2)}`, 125, y + 4);
                doc.text(`${item.gst || 0}%`, 145, y + 4);
                doc.text(`${totalAmount.toFixed(2)}`, 170, y + 4);
                
                y += Math.max(6, descLines.length * 4);
                doc.line(20, y, 190, y);
                y += 2;
            });
            
            // Tax Calculation
            y += 5;
            doc.setFontSize(10);
            doc.text('Subtotal:', 130, y);
            doc.text(`Rs. ${subtotal.toFixed(2)}`, 170, y);
            y += 7;
            
            // Calculate total GST
            const totalGST = ti.totalAmount - subtotal;
            const cgst = totalGST / 2;
            const sgst = totalGST / 2;
            
            doc.text('CGST:', 130, y);
            doc.text(`Rs. ${cgst.toFixed(2)}`, 170, y);
            y += 7;
            
            doc.text('SGST:', 130, y);
            doc.text(`Rs. ${sgst.toFixed(2)}`, 170, y);
            y += 7;
            
            doc.setFont(undefined, 'bold');
            doc.setFontSize(11);
            doc.text('TOTAL AMOUNT:', 130, y);
            doc.text(`Rs. ${ti.totalAmount.toFixed(2)}`, 170, y);
            doc.setFont(undefined, 'normal');
            
            // Bank Details
            y += 15;
            doc.setFontSize(9);
            doc.setTextColor(37, 99, 235);
            doc.text('BANK DETAILS:', 20, y);
            y += 6;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(8);
            if (companyInfo.bankDetails) {
                const bankLines = doc.splitTextToSize(companyInfo.bankDetails, 170);
                doc.text(bankLines, 20, y);
            }
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('This is a computer-generated Tax Invoice and requires no signature.', 105, 285, { align: 'center' });
            
            doc.save(`Tax_Invoice_${ti.invoiceNumber}.pdf`);
        };
        
        window.viewInvoiceDetails = (id) => {
            const ti = taxInvoices.find(t => t.id === id);
            if (!ti) return;
            
            let itemsHtml = ti.items.map((item, idx) => 
                `${idx + 1}. ${item.description} - Qty: ${item.quantity} x Rs. ${item.rate} = Rs. ${formatNumber(item.amount.toFixed(2))}`
            ).join('\n');
            
            alert(`TAX INVOICE DETAILS\n` +
                `================\n` +
                `Invoice #: ${ti.invoiceNumber}\n` +
                `Date: ${new Date(ti.date).toLocaleDateString('en-IN')}\n` +
                `Type: ${ti.type}\n\n` +
                `CLIENT:\n` +
                `${ti.clientName}\n` +
                `GST: ${ti.clientGST}\n` +
                `${ti.clientAddress}\n\n` +
                `ITEMS:\n` +
                `${itemsHtml}\n\n` +
                `Subtotal: Rs. ${formatNumber(ti.subtotal.toFixed(2))}\n` +
                `CGST (${ti.cgstPercent}%): Rs. ${formatNumber(ti.cgstAmount.toFixed(2))}\n` +
                `SGST (${ti.sgstPercent}%): Rs. ${formatNumber(ti.sgstAmount.toFixed(2))}\n` +
                `TOTAL: Rs. ${formatNumber(ti.totalAmount.toFixed(2))}\n\n` +
                `Status: ${ti.status}`
            );
        };

        // ========== FILTERS ==========
        
        window.filterQuotations = () => {
            const searchTerm = document.getElementById('searchQuotations').value.toLowerCase();
            const typeFilter = document.getElementById('quotationTypeFilter').value;
            const statusFilter = document.getElementById('quotationStatusFilter').value;
            
            const filtered = quotations.filter(quot => {
                const matchesSearch = quot.clientName.toLowerCase().includes(searchTerm) || 
                                     quot.quotationNumber.toLowerCase().includes(searchTerm);
                const matchesType = !typeFilter || quot.type === typeFilter;
                const matchesStatus = !statusFilter || quot.status === statusFilter;
                return matchesSearch && matchesType && matchesStatus;
            });
            
            renderFilteredQuotations(filtered);
        };

        function renderFilteredQuotations(filtered) {
            const tbody = document.getElementById('quotationsList');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="empty-state-icon">üîç</div><p>No quotations match your filters.</p></td></tr>';
                return;
            }
            // Re-render with filtered data
            const temp = quotations;
            quotations = filtered;
            renderQuotations();
            quotations = temp;
        }

        window.filterPurchaseOrders = () => {
            const searchTerm = document.getElementById('searchPurchaseOrders')?.value?.toLowerCase() || '';
            const statusFilter = document.getElementById('poStatusFilter')?.value || '';
            
            const filtered = purchaseOrders.filter(po => {
                const matchesSearch = po.vendorName.toLowerCase().includes(searchTerm) || 
                                     po.poNumber.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || po.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            const temp = purchaseOrders;
            purchaseOrders = filtered;
            renderPurchaseOrders();
            purchaseOrders = temp;
        };
        
        window.filterProformaInvoices = () => {
            const searchTerm = document.getElementById('searchProformaInvoices')?.value?.toLowerCase() || '';
            const statusFilter = document.getElementById('piStatusFilter')?.value || '';
            
            const filtered = proformaInvoices.filter(pi => {
                const matchesSearch = pi.clientName.toLowerCase().includes(searchTerm) || 
                                     pi.piNumber.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || pi.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            const temp = proformaInvoices;
            proformaInvoices = filtered;
            renderProformaInvoices();
            proformaInvoices = temp;
        };
        
        window.filterTaxInvoices = () => {
            const searchTerm = document.getElementById('searchTaxInvoices')?.value?.toLowerCase() || '';
            const statusFilter = document.getElementById('taxInvoiceStatusFilter')?.value || '';
            
            const filtered = taxInvoices.filter(ti => {
                const matchesSearch = ti.clientName.toLowerCase().includes(searchTerm) || 
                                     ti.invoiceNumber.toLowerCase().includes(searchTerm);
                const matchesStatus = !statusFilter || ti.status === statusFilter;
                return matchesSearch && matchesStatus;
            });
            
            const temp = taxInvoices;
            taxInvoices = filtered;
            renderTaxInvoices();
            taxInvoices = temp;
        };

        // Helper function for status colors
        function getStatusColor(status) {
            const colors = {
                'Draft': 'secondary',
                'Sent': 'primary',
                'Accepted': 'success',
                'Rejected': 'danger',
                'Pending': 'warning',
                'Partial': 'info',
                'Paid': 'success',
                'Overdue': 'danger'
            };
            return colors[status] || 'secondary';
        }

        // ==================== END BILLING MANAGEMENT FUNCTIONS ====================

        // ==================== END HR MANAGEMENT FUNCTIONS ====================

        // Invoice Form Handler
        document.getElementById('invoiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const invoiceId = document.getElementById('editInvoiceId').value;
            const type = document.getElementById('invoiceType').value;
            
            // Collect form data
            const formData = {
                type: type,
                clientName: document.getElementById('clientName').value.trim(),
                clientEmail: document.getElementById('clientEmail').value.trim(),
                clientPhone: document.getElementById('clientPhone').value.trim(),
                clientGST: document.getElementById('clientGST').value.trim(),
                clientAddress: document.getElementById('clientAddress').value.trim(),
                invoiceNumber: document.getElementById('invoiceNumber').value.trim(),
                invoiceDate: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                poNumber: document.getElementById('poNumber').value.trim(),
                discountPercent: parseFloat(document.getElementById('discountPercent').value) || 0,
                gstPercent: parseFloat(document.getElementById('gstPercent').value) || 0,
                notes: document.getElementById('invoiceNotes').value.trim(),
                status: invoiceId ? invoices.find(inv => inv.id === invoiceId)?.status || 'draft' : 'draft'
            };

            // Collect items
            const itemElements = document.querySelectorAll('#invoiceItemsList .invoice-item');
            formData.items = [];
            let subtotal = 0;

            itemElements.forEach(item => {
                const inputs = item.querySelectorAll('input');
                const description = inputs[0].value.trim();
                const quantity = parseFloat(inputs[1].value) || 0;
                const unit = inputs[2].value.trim() || 'pcs';
                const rate = parseFloat(inputs[3].value) || 0;
                const amount = quantity * rate;

                if (description && quantity > 0 && rate >= 0) {
                    formData.items.push({
                        description,
                        quantity,
                        unit,
                        rate,
                        amount
                    });
                    subtotal += amount;
                }
            });

            if (formData.items.length === 0) {
                alert('Please add at least one item');
                return;
            }

            // Calculate totals
            const discountAmount = (subtotal * formData.discountPercent) / 100;
            const afterDiscount = subtotal - discountAmount;
            const gstAmount = (afterDiscount * formData.gstPercent) / 100;
            
            formData.subtotal = subtotal;
            formData.discountAmount = discountAmount;
            formData.gstAmount = gstAmount;
            formData.totalAmount = afterDiscount + gstAmount;
            formData.updatedAt = new Date().toISOString();

            // Collect payment data
            const paymentTerms = document.getElementById('paymentTerms').value;
            const invoiceStatus = document.getElementById('invoiceStatus').value;
            
            formData.paymentTerms = paymentTerms;
            if (invoiceStatus) {
                formData.status = invoiceStatus;
            }

            // Add advance payment information if applicable
            if (paymentTerms === 'advance') {
                const advanceAmount = parseFloat(document.getElementById('advanceAmount').value) || 0;
                const advancePercentage = parseFloat(document.getElementById('advancePercentage').value) || 0;
                
                formData.advancePayment = {
                    amount: advanceAmount,
                    percentage: advancePercentage,
                    date: document.getElementById('advanceDate').value,
                    method: document.getElementById('advanceMethod').value,
                    reference: document.getElementById('advanceReference').value,
                    balanceDueDate: document.getElementById('balanceDueDate').value,
                    notes: document.getElementById('advanceNotes').value,
                    balanceAmount: formData.totalAmount - advanceAmount
                };
            }

            // Add installment information if applicable
            if (paymentTerms === 'installments') {
                const installmentItems = document.querySelectorAll('.installment-item');
                formData.installments = [];
                
                installmentItems.forEach((item, index) => {
                    const inputs = item.querySelectorAll('input, select');
                    const amount = parseFloat(inputs[0].value) || 0;
                    const percentage = parseFloat(inputs[1].value) || 0;
                    const date = inputs[2].value;
                    const method = inputs[3].value;
                    
                    if (amount > 0 && date && method) {
                        formData.installments.push({
                            installmentNumber: index + 1,
                            amount: amount,
                            percentage: percentage,
                            dueDate: date,
                            paymentMethod: method,
                            status: 'pending' // pending, paid, overdue
                        });
                    }
                });
            }

            try {
                if (invoiceId) {
                    await updateDoc(doc(db, 'invoices', invoiceId), formData);
                    await addDoc(collection(db, 'activities'), {
                        action: `Updated ${type} ${formData.invoiceNumber}`,
                        user: currentUser.fullName || currentUser.username,
                        date: new Date().toISOString()
                    });
                } else {
                    formData.createdAt = new Date().toISOString();
                    await addDoc(collection(db, 'invoices'), formData);
                    await addDoc(collection(db, 'activities'), {
                        action: `Created ${type} ${formData.invoiceNumber} for ${formData.clientName}`,
                        user: currentUser.fullName || currentUser.username,
                        date: new Date().toISOString()
                    });
                }

                closeModal('invoiceModal');
                loadInvoices();
            } catch (error) {
                alert('Error saving invoice: ' + error.message);
            }
        });

        // Helper function to load image as data URL.
        // Returns a data URL string or null if the image cannot be loaded or would taint the canvas.
        async function loadImageAsDataUrl(src) {
            if (!src) return null;
            // If already a data URL, return as-is
            if (typeof src === 'string' && src.startsWith('data:')) return src;

            // Try fetching the image as a blob first (preferred - avoids crossOrigin issues when possible)
            try {
                const resp = await fetch(src, { mode: 'cors' });
                if (resp && resp.ok) {
                    const blob = await resp.blob();
                    return await new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => resolve(null);
                        reader.readAsDataURL(blob);
                    });
                }
            } catch (e) {
                // fetch may fail for file:// pages or strict CORS; fall through to image approach
                // console.warn('fetch image failed, falling back to Image element:', e);
            }

            // Fallback: attempt to load via Image with crossOrigin first. If drawing the image taints the canvas
            // the toDataURL call will throw ‚Äî catch that and return null instead of letting it bubble up.
            return await new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width || 1;
                        canvas.height = img.height || 1;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        try {
                            const data = canvas.toDataURL('image/png');
                            resolve(data);
                        } catch (err) {
                            // Tainted canvas or other security error
                            console.warn('toDataURL failed (tainted canvas or CORS):', err);
                            resolve(null);
                        }
                    } catch (err) {
                        console.warn('drawImage failed:', err);
                        resolve(null);
                    }
                };
                img.onerror = () => {
                    // Last-resort: try an existing DOM <img> that may already be loaded (helps when page has the image)
                    try {
                        const parts = (src || '').split('?')[0].split('/');
                        const filename = parts[parts.length - 1];
                        const domImg = document.querySelector(`img[src$="${filename}"]`) || document.querySelector(`img[src="${src}"]`);
                        if (domImg && domImg.complete) {
                            try {
                                const canvas = document.createElement('canvas');
                                canvas.width = domImg.naturalWidth || domImg.width || 1;
                                canvas.height = domImg.naturalHeight || domImg.height || 1;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(domImg, 0, 0);
                                try {
                                    const data = canvas.toDataURL('image/png');
                                    resolve(data);
                                    return;
                                } catch (err) {
                                    console.warn('toDataURL failed on DOM image (tainted):', err);
                                }
                            } catch (err) {
                                console.warn('drawImage for DOM image failed:', err);
                            }
                        }
                    } catch (e) {
                        console.warn('DOM image fallback failed:', e);
                    }
                    // Last-resort: try without crossOrigin (may still taint)
                    const img2 = new Image();
                    img2.onload = () => {
                        try {
                            const canvas = document.createElement('canvas');
                            canvas.width = img2.width || 1;
                            canvas.height = img2.height || 1;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img2, 0, 0);
                            try {
                                const data = canvas.toDataURL('image/png');
                                resolve(data);
                            } catch (err) {
                                console.warn('toDataURL failed on fallback (tainted):', err);
                                resolve(null);
                            }
                        } catch (err) {
                            console.warn('drawImage fallback failed:', err);
                            resolve(null);
                        }
                    };
                    img2.onerror = () => resolve(null);
                    img2.src = src;
                };
                img.src = src;
            });
        }

        // Ensure jsPDF is available in module context (tries global first, then dynamic import)
        async function ensureJsPDF() {
            if (window.jspdf) return window.jspdf;
            try {
                // Try local copy first (if you add libs/jspdf.umd.min.js to the repo)
                try {
                    const localMod = await import('./libs/jspdf.umd.min.js');
                    const localObj = localMod.jspdf || localMod.default || localMod;
                    if (localObj) {
                        window.jspdf = localObj;
                        return window.jspdf;
                    }
                } catch (localErr) {
                    // local may not exist; fallback to CDN
                    // console.info('Local jsPDF not found or failed, falling back to CDN:', localErr);
                }

                // Fallback dynamic import from CDN
                const mod = await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
                // UMD may export as { jspdf: { jsPDF } } or default; normalize
                const jspdfObj = mod.jspdf || mod.default || mod;
                window.jspdf = jspdfObj;
                return window.jspdf;
            } catch (err) {
                console.error('Failed to load jsPDF dynamically:', err);
                throw err;
            }
        }

        // PDF Generation Function
        async function generateInvoicePDF(invoice) {
            try {
                // Ensure jsPDF is available (works both when included as UMD or via module dynamic import)
                const jspdf = await ensureJsPDF();
                const { jsPDF } = jspdf;
                const doc = new jsPDF();
                
                // Colors and styles
                const primaryColor = [37, 99, 235];
                const darkColor = [15, 23, 42];
                const grayColor = [100, 116, 139];
                
                // Page dimensions and margins
                const pageHeight = doc.internal.pageSize.height;
                const pageWidth = doc.internal.pageSize.width;
                const leftMargin = 20;
                const rightMargin = 20;
                const topMargin = 20;
                const bottomMargin = 30;
                const contentWidth = pageWidth - leftMargin - rightMargin;
                const maxY = pageHeight - bottomMargin;
                
                let currentPage = 1;
                let totalPages = 1; // Will be updated after content is added
                
                // Helper function to format currency properly for PDF
                const formatCurrency = (amount) => {
                    const num = parseFloat(amount);
                    if (isNaN(num)) return 'Rs. 0.00';
                    const formatted = num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    return 'Rs. ' + formatted;
                };
                
                // Helper function to format number properly for PDF
                const formatNumber = (num) => {
                    const parsed = parseFloat(num);
                    if (isNaN(parsed)) return '0.00';
                    return parsed.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                };
                
                // Load logo (try multiple methods but don't fail PDF generation if unavailable)
                let logoImg = null;
                try {
                    logoImg = await loadImageAsDataUrl('ambivare.png');
                    if (!logoImg) {
                        // try absolute URL
                        const logoUrl = new URL('ambivare.png', window.location.href).href;
                        logoImg = await loadImageAsDataUrl(logoUrl);
                    }
                } catch (e) {
                    console.warn('Logo load attempted and failed:', e);
                    logoImg = null;
                }

                // Final fallback: try a pre-embedded local file containing the base64 data URI
                if (!logoImg) {
                    try {
                        const resp = await fetch('./libs/embedded_logo.txt');
                        if (resp && resp.ok) {
                            logoImg = await resp.text();
                        }
                    } catch (e) {
                        // ignore
                    }
                }
                
                // Function to add page header
                const addPageHeader = (pageNum) => {
                    // Header: Company name (left) and Invoice/Quotation title (right) to avoid overlap
                    const companyName = companySettings.name || 'Avant Elevators';
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(18);
                    doc.setTextColor(...primaryColor);
                    doc.text(companyName, 20, 25);
                    
                    // If logo found, draw it below company name. If not, proceed (PDF will render without logo).
                    if (logoImg && pageNum === 1) {
                        try {
                            // Place logo below company name at y=30, with size 35x15
                            doc.addImage(logoImg, 'PNG', 20, 30, 25, 25);
                        } catch (e) {
                            console.warn('Adding logo to PDF failed:', e);
                        }
                    }
                    
                    if (pageNum === 1) {
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(10);
                        doc.setTextColor(...grayColor);
                        // Adjust Y position based on whether logo is present
                        let detailsY = logoImg ? 50 : 35;
                        if (companySettings.address) {
                            doc.text(companySettings.address, 20, detailsY);
                            detailsY += 7;
                        }
                        if (companySettings.phone || companySettings.email) {
                            doc.text(`${companySettings.phone || ''} | ${companySettings.email || ''}`, 20, detailsY);
                            detailsY += 7;
                        }
                        if (companySettings.gst) {
                            doc.text(`GST: ${companySettings.gst}`, 20, detailsY);
                        }
                    }

                    // Invoice/Quotation Title
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(16);
                    doc.setTextColor(...darkColor);
                    const title = invoice.type === 'quotation' ? 'QUOTATION' : 'INVOICE';
                    // Right-align the title to avoid overlapping long company names
                    doc.text(title, 190, 25, { align: 'right' });

                    if (pageNum === 1) {
                        // Invoice details box (right column)
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${title} #: ${invoice.invoiceNumber}`, 190, 35, { align: 'right' });
                        doc.text(`Date: ${new Date(invoice.invoiceDate).toLocaleDateString('en-GB')}`, 190, 42, { align: 'right' });
                        if (invoice.dueDate) {
                            doc.text(`Due Date: ${new Date(invoice.dueDate).toLocaleDateString('en-GB')}`, 190, 49, { align: 'right' });
                        }
                        if (invoice.poNumber) {
                            doc.text(`PO #: ${invoice.poNumber}`, 190, 56, { align: 'right' });
                        }
                    } else {
                        // On continuation pages, show invoice number and page info
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text(`${title} #: ${invoice.invoiceNumber}`, 190, 35, { align: 'right' });
                        doc.text(`Page ${pageNum}`, 190, 42, { align: 'right' });
                    }
                };
                
                // Function to add page footer
                const addPageFooter = (pageNum, totalPages) => {
                    doc.setFontSize(8);
                    doc.setTextColor(...grayColor);
                    doc.text('This is a computer-generated document.', leftMargin, pageHeight - 15);
                    doc.text(`Page ${pageNum} of ${totalPages}`, pageWidth / 2, pageHeight - 15, { align: 'center' });
                    doc.text(`Generated on ${new Date().toLocaleDateString('en-GB')}`, pageWidth - rightMargin, pageHeight - 15, { align: 'right' });
                };
                
                // Function to check if new page is needed
                const checkNewPage = (requiredSpace, isForTable = false) => {
                    if (yPos + requiredSpace > maxY) {
                        // Add footer to current page
                        addPageFooter(currentPage, '?');
                        
                        doc.addPage();
                        currentPage++;
                        addPageHeader(currentPage);
                        
                        if (isForTable) {
                            // Add table header on new page
                            yPos = 60;
                            addTableHeader();
                        } else {
                            yPos = 50;
                        }
                        
                        return true;
                    }
                    return false;
                };
                
                // Function to add table header
                const addTableHeader = () => {
                    // Table header
                    doc.setFillColor(248, 250, 252);
                    doc.rect(20, yPos - 5, 170, 12, 'F');
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(...darkColor);
                    
                    doc.text('#', 25, yPos + 2);
                    doc.text('Description', 35, yPos + 2);
                    doc.text('Qty', 115, yPos + 2);
                    doc.text('Unit', 130, yPos + 2);
                    doc.text('Rate', 145, yPos + 2);
                    doc.text('Amount', 165, yPos + 2);
                    
                    yPos += 15;
                };

                // Start first page
                addPageHeader(1);
                
                // Bill To section - adjust Y position based on whether we have logo
                let yPos = logoImg ? 80 : 70;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(...darkColor);
                doc.text('BILL TO:', 20, yPos);
                
                yPos += 8;
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text(invoice.clientName, 20, yPos);
                
                yPos += 6;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                
                if (invoice.clientAddress) {
                    const addressLines = invoice.clientAddress.split('\n');
                    addressLines.forEach(line => {
                        checkNewPage(10);
                        doc.text(line, 20, yPos);
                        yPos += 5;
                    });
                }
                
                if (invoice.clientPhone) {
                    checkNewPage(10);
                    doc.text(`Phone: ${invoice.clientPhone}`, 20, yPos);
                    yPos += 5;
                }
                
                if (invoice.clientEmail) {
                    checkNewPage(10);
                    doc.text(`Email: ${invoice.clientEmail}`, 20, yPos);
                    yPos += 5;
                }
                
                if (invoice.clientGST) {
                    checkNewPage(10);
                    doc.text(`GST: ${invoice.clientGST}`, 20, yPos);
                    yPos += 5;
                }

                // Items table
                yPos += 15;
                checkNewPage(30, true);
                const tableStartY = yPos;
                
                addTableHeader();

                // Table items
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                
                invoice.items.forEach((item, index) => {
                    // Calculate required space for this item
                    const description = String(item.description);
                    const wrappedText = doc.splitTextToSize(description, 75);
                    const itemHeight = wrappedText.length > 1 ? 16 : 12;
                    
                    // Check if we need a new page
                    checkNewPage(itemHeight, true);
                    
                    // Alternating row background
                    if (index % 2 === 0) {
                        doc.setFillColor(249, 250, 251);
                        doc.rect(20, yPos - 5, 170, itemHeight - 2, 'F');
                    }
                    
                    doc.setTextColor(...darkColor);
                    doc.text(String(index + 1), 25, yPos);
                    
                    // Wrap long descriptions
                    if (description.length > 35) {
                        doc.text(wrappedText[0], 35, yPos);
                        if (wrappedText.length > 1) {
                            doc.setFontSize(8);
                            doc.text(wrappedText[1], 35, yPos + 4);
                            doc.setFontSize(9);
                        }
                    } else {
                        doc.text(description, 35, yPos);
                    }
                    
                    // Format numbers properly
                    doc.text(String(item.quantity), 115, yPos);
                    doc.text(String(item.unit), 130, yPos);
                    doc.text(formatNumber(item.rate), 145, yPos);
                    doc.text(formatNumber(item.amount), 165, yPos);
                    
                    yPos += itemHeight;
                });

                // Totals section
                yPos += 10;
                checkNewPage(50); // Reserve space for totals
                
                doc.setDrawColor(226, 232, 240);
                doc.line(120, yPos - 5, 190, yPos - 5);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                
                doc.text('Subtotal:', 130, yPos);
                doc.text(formatCurrency(invoice.subtotal), 165, yPos);
                yPos += 8;
                
                if (invoice.discountPercent > 0) {
                    doc.text(`Discount (${invoice.discountPercent}%):`, 130, yPos);
                    doc.text('-' + formatCurrency(invoice.discountAmount), 165, yPos);
                    yPos += 8;
                }
                
                if (invoice.gstPercent > 0) {
                    doc.text(`GST (${invoice.gstPercent}%):`, 130, yPos);
                    doc.text(formatCurrency(invoice.gstAmount), 165, yPos);
                    yPos += 8;
                }
                
                // Total line
                doc.setDrawColor(226, 232, 240);
                doc.line(120, yPos + 2, 190, yPos + 2);
                yPos += 8;
                
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(...darkColor);
                doc.text('TOTAL:', 130, yPos);
                doc.text(formatCurrency(invoice.totalAmount), 165, yPos);

                // Advance Payment Section
                if (invoice.paymentTerms === 'advance' && invoice.advancePayment) {
                    yPos += 12;
                    
                    // Advance payment header
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(...primaryColor);
                    doc.text('ADVANCE PAYMENT DETAILS:', 130, yPos);
                    yPos += 8;
                    
                    // Advance payment details
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(...grayColor);
                    
                    const advanceAmount = parseFloat(invoice.advancePayment.amount) || 0;
                    doc.text('Advance Paid:', 130, yPos);
                    doc.text('-' + formatCurrency(advanceAmount), 165, yPos);
                    yPos += 8;
                    
                    if (invoice.advancePayment.date) {
                        doc.text('Payment Date:', 130, yPos);
                        doc.text(new Date(invoice.advancePayment.date).toLocaleDateString(), 165, yPos);
                        yPos += 8;
                    }
                    
                    if (invoice.advancePayment.method) {
                        doc.text('Payment Method:', 130, yPos);
                        doc.text(invoice.advancePayment.method, 165, yPos);
                        yPos += 8;
                    }
                    
                    if (invoice.advancePayment.reference) {
                        doc.text('Reference:', 130, yPos);
                        doc.text(invoice.advancePayment.reference, 165, yPos);
                        yPos += 8;
                    }
                    
                    // Balance due calculation
                    const balanceDue = invoice.totalAmount - advanceAmount;
                    
                    // Balance due line with highlight
                    doc.setDrawColor(226, 232, 240);
                    doc.line(120, yPos + 2, 190, yPos + 2);
                    yPos += 10;
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.setTextColor(...primaryColor);
                    doc.text('BALANCE DUE:', 120, yPos);
                    doc.text(formatCurrency(balanceDue), 170, yPos);
                    
                    if (invoice.advancePayment.balanceDueDate) {
                        yPos += 8;
                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(10);
                        doc.setTextColor(...grayColor);
                        doc.text('Due Date:', 130, yPos);
                        doc.text(new Date(invoice.advancePayment.balanceDueDate).toLocaleDateString(), 165, yPos);
                    }
                }

                // Installment Payment Section
                if (invoice.paymentTerms === 'installments' && invoice.installments && invoice.installments.length > 0) {
                    yPos += 12;
                    
                    // Installments header
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(...primaryColor);
                    doc.text('INSTALLMENT SCHEDULE:', 130, yPos);
                    yPos += 8;
                    
                    // Each installment
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(...grayColor);
                    
                    invoice.installments.forEach((installment, index) => {
                        const installmentAmount = parseFloat(installment.amount) || 0;
                        const dueDate = new Date(installment.dueDate).toLocaleDateString();
                        
                        checkNewPage(15);
                        
                        doc.text(`${index + 1}. ${installment.description || 'Installment ' + (index + 1)}:`, 130, yPos);
                        doc.text(formatCurrency(installmentAmount), 165, yPos);
                        yPos += 6;
                        
                        doc.setTextColor(...grayColor);
                        doc.text(`   Due: ${dueDate}`, 130, yPos);
                        yPos += 8;
                    });
                    
                    // Total paid in installments
                    const totalInstallments = invoice.installments.reduce((sum, inst) => sum + (parseFloat(inst.amount) || 0), 0);
                    const remainingBalance = invoice.totalAmount - totalInstallments;
                    
                    if (remainingBalance > 0) {
                        yPos += 4;
                        doc.setDrawColor(226, 232, 240);
                        doc.line(120, yPos, 190, yPos);
                        yPos += 8;
                        
                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(10);
                        doc.setTextColor(...primaryColor);
                        doc.text('REMAINING BALANCE:', 130, yPos);
                        doc.text(formatCurrency(remainingBalance), 165, yPos);
                    }
                }

                // Notes section
                if (invoice.notes) {
                    yPos += 20;
                    const noteLines = doc.splitTextToSize(invoice.notes, 170);
                    checkNewPage(10 + (noteLines.length * 6));
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(...darkColor);
                    doc.text('Notes:', 20, yPos);
                    
                    yPos += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...grayColor);
                    noteLines.forEach(line => {
                        doc.text(line, 20, yPos);
                        yPos += 6;
                    });
                }

                // Bank details
                if (companySettings.bankDetails) {
                    yPos += 15;
                    const bankLines = doc.splitTextToSize(companySettings.bankDetails, 170);
                    checkNewPage(10 + (bankLines.length * 6));
                    
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(...darkColor);
                    doc.text('Bank Details:', 20, yPos);
                    
                    yPos += 6;
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(...grayColor);
                    bankLines.forEach(line => {
                        doc.text(line, 20, yPos);
                        yPos += 6;
                    });
                }

                // Update total pages and add footers
                totalPages = doc.internal.getNumberOfPages();
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    addPageFooter(i, totalPages);
                }

                // Save PDF
                const fileName = `${invoice.type}_${invoice.invoiceNumber}_${invoice.clientName.replace(/\s+/g, '_')}.pdf`;
                
                // Get PDF as blob for potential email sending
                const pdfBlob = doc.output('blob');
                
                // Download PDF
                doc.save(fileName);
                
                // Show email option if email is configured
                const emailConfig = JSON.parse(localStorage.getItem('emailConfig') || '{}');
                if (emailConfig.validated && invoice.clientEmail) {
                    const sendEmail = confirm(`PDF generated successfully!\n\nWould you like to email this ${invoice.type} to ${invoice.clientName}?\nEmail: ${invoice.clientEmail}`);
                    if (sendEmail) {
                        const subject = `${invoice.type} #${invoice.invoiceNumber} from ${invoice.companyName || 'Avant Elevators'}`;
                        const body = `Dear ${invoice.clientName},\n\nPlease find attached your ${invoice.type} #${invoice.invoiceNumber}.\n\nTotal Amount: Rs. ${formatNumber(invoice.totalAmount)}\nDue Date: ${invoice.dueDate || 'As per terms'}\n\nThank you for your business!\n\nBest regards,\n${invoice.companyName || 'Avant Elevators'}`;
                        
                        await sendEmailWithPDF(invoice.clientEmail, invoice.clientName, subject, body, pdfBlob, fileName);
                    }
                }
            } catch (error) {
                console.error('PDF generation error:', error);
                throw error;
            }
        }

        window.filterLocation = (location) => {
            // Handle service-van special case for element IDs
            const locationId = location === 'service-van' ? 'ServiceVan' : location.charAt(0).toUpperCase() + location.slice(1);
            const tableId = location === 'service-van' ? 'serviceVanList' : `${location}List`;
            
            const searchValue = document.getElementById(`search${locationId}`).value.toLowerCase();
            const categoryValue = document.getElementById(`categoryFilter${locationId}`).value;
            const statusValue = document.getElementById(`statusFilter${locationId}`).value;
            
            const rows = document.querySelectorAll(`#${tableId} tr`);
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const category = row.dataset.category || '';
                const status = row.dataset.status || '';
                
                const matchesSearch = text.includes(searchValue);
                const matchesCategory = !categoryValue || category === categoryValue;
                const matchesStatus = !statusValue || status === statusValue;
                
                row.style.display = (matchesSearch && matchesCategory && matchesStatus) ? '' : 'none';
            });
        };

        window.filterProjects = () => {
            const searchValue = document.getElementById('searchProjects').value.toLowerCase();
            const statusValue = document.getElementById('projectStatusFilter').value;
            
            const rows = document.querySelectorAll('#projectList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const status = row.dataset.status || '';
                
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusValue || status === statusValue;
                
                row.style.display = (matchesSearch && matchesStatus) ? '' : 'none';
            });
        };

        window.filterMaintenance = () => {
            const searchValue = document.getElementById('searchMaintenance').value.toLowerCase();
            const typeValue = document.getElementById('maintenanceTypeFilter')?.value || '';
            const statusValue = document.getElementById('maintenanceStatusFilter').value;
            const priorityValue = document.getElementById('maintenancePriorityFilter').value;
            const assigneeValue = document.getElementById('maintenanceAssigneeFilter').value;
            const projectValue = document.getElementById('maintenanceProjectFilter')?.value || '';
            
            const rows = document.querySelectorAll('#maintenanceList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const status = row.dataset.status || '';
                const priority = row.dataset.priority || '';
                const type = row.dataset.type || '';
                
                const matchesSearch = text.includes(searchValue);
                const matchesType = !typeValue || type === typeValue;
                const matchesStatus = !statusValue || status === statusValue;
                const matchesPriority = !priorityValue || priority === priorityValue;
                const matchesAssignee = !assigneeValue || text.includes(assigneeValue.toLowerCase());
                const matchesProject = !projectValue || text.includes(projectValue.toLowerCase());
                
                row.style.display = (matchesSearch && matchesType && matchesStatus && matchesPriority && matchesAssignee && matchesProject) ? '' : 'none';
            });
        };

        window.filterActivities = () => {
            const searchValue = document.getElementById('searchActivities').value.toLowerCase();
            const dateRange = document.getElementById('activityDateFilter').value;
            const userFilter = document.getElementById('activityUserFilter').value;
            
            const now = new Date();
            const rows = document.querySelectorAll('#activityList tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const user = row.dataset.user || '';
                const dateStr = row.dataset.date || '';
                const date = new Date(dateStr);
                
                const matchesSearch = text.includes(searchValue);
                const matchesUser = !userFilter || user === userFilter;
                
                let matchesDate = true;
                if (dateRange !== 'all') {
                    const dayMs = 24 * 60 * 60 * 1000;
                    const diff = now - date;
                    
                    switch(dateRange) {
                        case 'today':
                            matchesDate = diff < dayMs;
                            break;
                        case 'week':
                            matchesDate = diff < 7 * dayMs;
                            break;
                        case 'month':
                            matchesDate = diff < 30 * dayMs;
                            break;
                        case 'quarter':
                            matchesDate = diff < 90 * dayMs;
                            break;
                        case 'halfyear':
                            matchesDate = diff < 180 * dayMs;
                            break;
                        case 'year':
                            matchesDate = diff < 365 * dayMs;
                            break;
                    }
                }
                
                row.style.display = (matchesSearch && matchesUser && matchesDate) ? '' : 'none';
            });
        };

        window.filterUsers = () => {
            const search = document.getElementById('searchUsers').value.toLowerCase();
            const rows = document.querySelectorAll('#usersList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        };

        // PDF EXPORT FUNCTIONS - IMPROVED AND FILTERED

        window.exportLocationPDF = async (location) => {
            const jspdf = await ensureJsPDF();
            const { jsPDF } = jspdf;
            const doc = new jsPDF();

            const filteredItems = getFilteredLocationItems(location);

            // Use standard company header
            let y = await addCompanyHeaderToPDF(doc, `${location.toUpperCase()} INVENTORY REPORT`, 10);

            // Report metadata
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, y);
            y += 7;
            doc.text(`By: ${currentUser.fullName || currentUser.username}`, 20, y);
            y += 7;
            doc.text(`Total Items: ${filteredItems.length}`, 20, y);
            y += 7;
            
            // Add filter information
            const searchValue = document.getElementById(`search${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            const categoryValue = document.getElementById(`categoryFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            const statusValue = document.getElementById(`statusFilter${location.charAt(0).toUpperCase() + location.slice(1)}`).value;
            
            let filterText = 'Filters Applied: ';
            const filters = [];
            if (searchValue) filters.push(`Search: "${searchValue}"`);
            if (categoryValue) filters.push(`Category: ${categoryValue}`);
            if (statusValue) filters.push(`Status: ${statusValue}`);

            if (filters.length > 0) {
                doc.setFontSize(9);
                doc.setTextColor(100, 116, 139);
                doc.text(filterText + filters.join(', '), 20, y);
                y += 7;
            }

            doc.setDrawColor(226, 232, 240);
            doc.setLineWidth(0.5);
            doc.line(20, y, 190, y);
            y += 5;

            // Table header
            doc.setFillColor(248, 250, 252);
            doc.rect(20, y - 7, 170, 10, 'F');
            
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('#', 22, y);
            doc.text('Item Name', 32, y);
            doc.text('Category', 95, y);
            doc.text('Quantity', 135, y);
            doc.text('Status', 165, y);
            
            doc.setDrawColor(226, 232, 240);
            doc.line(20, y + 2, 190, y + 2);
            
            y += 10;
            
            // Table content
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            if (filteredItems.length === 0) {
                doc.setTextColor(100, 116, 139);
                doc.text('No items match the current filters.', 105, y + 10, { align: 'center' });
            } else {
                filteredItems.forEach((item, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                        
                        // Repeat header on new page
                        doc.setFillColor(248, 250, 252);
                        doc.rect(20, y - 7, 170, 10, 'F');
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(15, 23, 42);
                        doc.text('#', 22, y);
                        doc.text('Item Name', 32, y);
                        doc.text('Category', 95, y);
                        doc.text('Quantity', 135, y);
                        doc.text('Status', 165, y);
                        doc.line(20, y + 2, 190, y + 2);
                        y += 10;
                        doc.setFont(undefined, 'normal');
                    }
                    
                    const stockText = item.quantity < 50 ? 'Low' : item.quantity < 200 ? 'Medium' : 'Good';
                    const stockColor = item.quantity < 50 ? [220, 38, 38] : item.quantity < 200 ? [234, 88, 12] : [22, 163, 74];
                    
                    // Alternating row background
                    if (index % 2 === 0) {
                        doc.setFillColor(249, 250, 251);
                        doc.rect(20, y - 6, 170, 8, 'F');
                    }
                    
                    doc.setTextColor(15, 23, 42);
                    doc.text(`${index + 1}`, 22, y);
                    
                    // Truncate long names
                    let itemName = item.name.length > 35 ? item.name.substring(0, 32) + '...' : item.name;
                    doc.text(itemName, 32, y);
                    
                    doc.setTextColor(100, 116, 139);
                    doc.text(item.category, 95, y);
                    
                    doc.setTextColor(15, 23, 42);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${item.quantity} ${item.unit}`, 135, y);
                    
                    doc.setTextColor(...stockColor);
                    doc.text(stockText, 165, y);
                    
                    doc.setFont(undefined, 'normal');
                    
                    // Add description if exists
                    if (item.description) {
                        y += 5;
                        doc.setFontSize(8);
                        doc.setTextColor(100, 116, 139);
                        const desc = item.description.length > 70 ? item.description.substring(0, 67) + '...' : item.description;
                        doc.text(desc, 32, y);
                        doc.setFontSize(9);
                        y += 3;
                    }
                    
                    y += 8;
                });
            }
            
            // Summary section at bottom of last page
            if (filteredItems.length > 0) {
                const goodStock = filteredItems.filter(i => i.quantity >= 200).length;
                const mediumStock = filteredItems.filter(i => i.quantity >= 50 && i.quantity < 200).length;
                const lowStock = filteredItems.filter(i => i.quantity < 50).length;
                
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                y += 10;
                doc.setDrawColor(226, 232, 240);
                doc.line(20, y, 190, y);
                y += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(15, 23, 42);
                doc.text('SUMMARY', 20, y);
                
                y += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(22, 163, 74);
                doc.text(`Good Stock: ${goodStock} items`, 25, y);
                
                y += 7;
                doc.setTextColor(234, 88, 12);
                doc.text(`Medium Stock: ${mediumStock} items`, 25, y);
                
                y += 7;
                doc.setTextColor(220, 38, 38);
                doc.text(`Low Stock: ${lowStock} items`, 25, y);
            }
            
            // Footer on all pages
            // Add company footer to all pages
            await addCompanyFooterToPDF(doc);

            doc.save(`${location}_inventory_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        window.exportProjectsPDF = async () => {
            const jspdf = await ensureJsPDF();
            const { jsPDF } = jspdf;
            const doc = new jsPDF();

            const filteredProjects = getFilteredProjects();

            // Use standard company header
            let y = await addCompanyHeaderToPDF(doc, 'PROJECTS REPORT', 10);

            // Metadata
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, y);
            y += 7;
            doc.text(`By: ${currentUser.fullName || currentUser.username}`, 20, y);
            y += 7;
            doc.text(`Total Projects: ${filteredProjects.length}`, 20, y);
            y += 7;
            
            // Filter info
            const searchValue = document.getElementById('searchProjects').value;
            const statusValue = document.getElementById('projectStatusFilter').value;
            
            if (searchValue || statusValue) {
                doc.setFontSize(9);
                doc.setTextColor(100, 116, 139);
                const filters = [];
                if (searchValue) filters.push(`Search: "${searchValue}"`);
                if (statusValue) filters.push(`Status: ${statusValue}`);
                doc.text('Filters Applied: ' + filters.join(', '), 20, y);
                y += 7;
            }

            doc.setDrawColor(226, 232, 240);
            doc.setLineWidth(0.5);
            doc.line(20, y, 190, y);
            y += 10;
            
            if (filteredProjects.length === 0) {
                doc.setTextColor(100, 116, 139);
                doc.text('No projects match the current filters.', 105, y + 10, { align: 'center' });
            } else {
                filteredProjects.forEach((project, index) => {
                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    // Project header box
                    doc.setFillColor(248, 250, 252);
                    doc.rect(20, y - 2, 170, 8, 'F');
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(37, 99, 235);
                    doc.text(`${index + 1}. ${project.name}`, 22, y + 4);
                    
                    // Status badge
                    const statusColor = project.status === 'Active' ? [22, 163, 74] : 
                                      project.status === 'Completed' ? [37, 99, 235] : [100, 116, 139];
                    doc.setTextColor(...statusColor);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.text(project.status.toUpperCase(), 180, y + 4);
                    
                    y += 12;
                    
                    // Project details
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(15, 23, 42);
                    
                    doc.setFont(undefined, 'bold');
                    doc.text('Code:', 25, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(project.code, 45, y);
                    
                    y += 6;
                    doc.setFont(undefined, 'bold');
                    doc.text('Client:', 25, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(project.client || 'N/A', 45, y);
                    
                    if (project.description) {
                        y += 6;
                        doc.setFont(undefined, 'bold');
                        doc.text('Description:', 25, y);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(100, 116, 139);
                        const desc = project.description.length > 70 ? project.description.substring(0, 67) + '...' : project.description;
                        doc.text(desc, 25, y + 5);
                        doc.setTextColor(15, 23, 42);
                        y += 5;
                    }
                    
                    // Allocated items
                    const items = project.items || [];
                    if (items.length > 0) {
                        y += 8;
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(10);
                        doc.setTextColor(37, 99, 235);
                        doc.text('Allocated Items:', 25, y);
                        
                        y += 6;
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(15, 23, 42);
                        
                        items.forEach((item) => {
                            if (y > 270) {
                                doc.addPage();
                                y = 20;
                            }
                            doc.text(`‚Ä¢ ${item.name}: ${item.quantity} ${item.unit} (${item.location})`, 30, y);
                            y += 5;
                        });
                    }
                    
                    y += 8;
                    doc.setDrawColor(226, 232, 240);
                    doc.line(20, y, 190, y);
                    y += 10;
                });
            }
            
            // Summary
            if (filteredProjects.length > 0) {
                const activeCount = filteredProjects.filter(p => p.status === 'Active').length;
                const completedCount = filteredProjects.filter(p => p.status === 'Completed').length;
                const onHoldCount = filteredProjects.filter(p => p.status === 'On Hold').length;
                
                if (y > 260) {
                    doc.addPage();
                    y = 20;
                }
                
                y += 5;
                doc.setDrawColor(226, 232, 240);
                doc.line(20, y, 190, y);
                y += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(15, 23, 42);
                doc.text('PROJECT SUMMARY', 20, y);
                
                y += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(22, 163, 74);
                doc.text(`Active Projects: ${activeCount}`, 25, y);
                
                y += 7;
                doc.setTextColor(37, 99, 235);
                doc.text(`Completed Projects: ${completedCount}`, 25, y);
                
                y += 7;
                doc.setTextColor(100, 116, 139);
                doc.text(`On Hold Projects: ${onHoldCount}`, 25, y);
            }
            
            // Footer
            // Add company footer to all pages
            await addCompanyFooterToPDF(doc);

            doc.save(`projects_report_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        window.exportActivitiesPDF = async (period) => {
            const jspdf = await ensureJsPDF();
            const { jsPDF } = jspdf;
            const doc = new jsPDF();

            // Filter activities based on period
            const now = new Date();
            let filteredActivities = [];
            let periodText = '';
            const dayMs = 24 * 60 * 60 * 1000;
            
            switch(period) {
                case 'day':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < dayMs);
                    periodText = 'Today';
                    break;
                case 'week':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 7 * dayMs);
                    periodText = 'This Week';
                    break;
                case 'month':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 30 * dayMs);
                    periodText = 'This Month';
                    break;
                case 'quarter':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 90 * dayMs);
                    periodText = 'This Quarter';
                    break;
                case 'halfyear':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 180 * dayMs);
                    periodText = 'Last 6 Months';
                    break;
                case 'year':
                    filteredActivities = activities.filter(a => (now - new Date(a.date)) < 365 * dayMs);
                    periodText = 'This Year';
                    break;
                default:
                    filteredActivities = [...activities];
                    periodText = 'All Time';
            }
            
            // Apply current UI filters
            const searchValue = document.getElementById('searchActivities').value.toLowerCase();
            const userFilter = document.getElementById('activityUserFilter').value;
            
            if (searchValue || userFilter) {
                filteredActivities = filteredActivities.filter(act => {
                    const matchesSearch = !searchValue || act.action.toLowerCase().includes(searchValue);
                    const matchesUser = !userFilter || act.user === userFilter;
                    return matchesSearch && matchesUser;
                });
            }
            
            // Use standard company header
            let y = await addCompanyHeaderToPDF(doc, 'ACTIVITY LOG REPORT', 10);

            // Metadata
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.text(`Period: ${periodText}`, 20, y);
            y += 7;
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, y);
            y += 7;
            doc.text(`By: ${currentUser.fullName || currentUser.username}`, 20, y);
            y += 7;
            doc.text(`Total Activities: ${filteredActivities.length}`, 20, y);
            y += 7;
            
            // Filter info
            if (searchValue || userFilter) {
                doc.setFontSize(9);
                doc.setTextColor(100, 116, 139);
                const filters = [];
                if (searchValue) filters.push(`Search: "${searchValue}"`);
                if (userFilter) filters.push(`User: ${userFilter}`);
                doc.text('Filters Applied: ' + filters.join(', '), 20, y);
                y += 7;
            }

            doc.setDrawColor(226, 232, 240);
            doc.setLineWidth(0.5);
            doc.line(20, y, 190, y);
            y += 5;

            // Table header
            doc.setFillColor(248, 250, 252);
            doc.rect(20, y - 7, 170, 10, 'F');
            
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('#', 22, y);
            doc.text('Date & Time', 30, y);
            doc.text('User', 75, y);
            doc.text('Action', 105, y);
            
            doc.setDrawColor(226, 232, 240);
            doc.line(20, y + 2, 190, y + 2);
            
            y += 10;
            
            // Table content
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            if (filteredActivities.length === 0) {
                doc.setTextColor(100, 116, 139);
                doc.text(`No activities recorded for ${periodText.toLowerCase()}.`, 105, y + 10, { align: 'center' });
            } else {
                filteredActivities.forEach((activity, index) => {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                        
                        // Repeat header on new page
                        doc.setFillColor(248, 250, 252);
                        doc.rect(20, y - 7, 170, 10, 'F');
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(15, 23, 42);
                        doc.text('#', 22, y);
                        doc.text('Date & Time', 30, y);
                        doc.text('User', 75, y);
                        doc.text('Action', 105, y);
                        doc.line(20, y + 2, 190, y + 2);
                        y += 10;
                        doc.setFont(undefined, 'normal');
                    }
                    
                    // Alternating row background
                    if (index % 2 === 0) {
                        doc.setFillColor(249, 250, 251);
                        doc.rect(20, y - 6, 170, 12, 'F');
                    }
                    
                    doc.setTextColor(15, 23, 42);
                    doc.text(`${index + 1}`, 22, y);
                    
                    const date = new Date(activity.date);
                    const dateStr = date.toLocaleDateString('en-GB', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const timeStr = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    
                    doc.setFontSize(9);
                    doc.text(dateStr, 30, y);
                    doc.setFontSize(8);
                    doc.setTextColor(100, 116, 139);
                    doc.text(timeStr, 30, y + 4);
                    
                    doc.setFontSize(9);
                    doc.setTextColor(37, 99, 235);
                    doc.setFont(undefined, 'bold');
                    doc.text(activity.user.length > 12 ? activity.user.substring(0, 10) + '..' : activity.user, 75, y);
                    
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(15, 23, 42);
                    
                    // Wrap long action text
                    const maxWidth = 80;
                    let actionText = activity.action;
                    if (actionText.length > 60) {
                        const line1 = actionText.substring(0, 60);
                        const line2 = actionText.substring(60, 120) + (actionText.length > 120 ? '...' : '');
                        doc.text(line1, 105, y);
                        doc.setFontSize(8);
                        doc.setTextColor(100, 116, 139);
                        doc.text(line2, 105, y + 4);
                        y += 4;
                    } else {
                        doc.text(actionText, 105, y);
                    }
                    
                    y += 10;
                });
            }
            
            // Summary section
            if (filteredActivities.length > 0) {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                y += 10;
                doc.setDrawColor(226, 232, 240);
                doc.line(20, y, 190, y);
                y += 10;
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(15, 23, 42);
                doc.text('ACTIVITY BREAKDOWN', 20, y);
                
                y += 10;
                
                // Count activity types
                const addedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('added')).length;
                const updatedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('updated')).length;
                const deletedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('deleted')).length;
                const usedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('used')).length;
                const returnedItems = filteredActivities.filter(a => a.action.toLowerCase().includes('returned')).length;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                if (addedItems > 0) {
                    doc.setTextColor(22, 163, 74);
                    doc.text(`Added/Created: ${addedItems} activities`, 25, y);
                    y += 7;
                }
                
                if (updatedItems > 0) {
                    doc.setTextColor(37, 99, 235);
                    doc.text(`Updated: ${updatedItems} activities`, 25, y);
                    y += 7;
                }
                
                if (usedItems > 0) {
                    doc.setTextColor(234, 88, 12);
                    doc.text(`Used/Assigned: ${usedItems} activities`, 25, y);
                    y += 7;
                }
                
                if (returnedItems > 0) {
                    doc.setTextColor(147, 51, 234);
                    doc.text(`Returned: ${returnedItems} activities`, 25, y);
                    y += 7;
                }
                
                if (deletedItems > 0) {
                    doc.setTextColor(220, 38, 38);
                    doc.text(`Deleted: ${deletedItems} activities`, 25, y);
                    y += 7;
                }
                
                // Most active users
                const userCounts = {};
                filteredActivities.forEach(a => {
                    userCounts[a.user] = (userCounts[a.user] || 0) + 1;
                });
                
                const topUsers = Object.entries(userCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);
                
                if (topUsers.length > 0) {
                    y += 8;
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(15, 23, 42);
                    doc.text('Most Active Users:', 25, y);
                    
                    y += 7;
                    doc.setFont(undefined, 'normal');
                    topUsers.forEach(([user, count]) => {
                        doc.setTextColor(100, 116, 139);
                        doc.text(`${user}: ${count} activities`, 30, y);
                        y += 6;
                    });
                }
            }
            
            // Add company footer to all pages
            await addCompanyFooterToPDF(doc);

            doc.save(`activities_${period}_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        window.showBarcodeScanner = async (location) => {
            currentScanLocation = location;
            const modal = document.getElementById('barcodeModal');
            const permissionInfo = document.getElementById('cameraPermissionInfo');
            const scanStatus = document.getElementById('scanStatus');
            
            modal.classList.add('active');
            permissionInfo.style.display = 'block';
            scanStatus.textContent = 'Requesting camera access...';
            scanStatus.className = 'scan-status';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 },
                        focusMode: 'continuous',
                        frameRate: { ideal: 30 }
                    } 
                });
                
                const videoElement = document.getElementById('barcodeVideo');
                videoElement.srcObject = stream;
                barcodeStream = stream;
                
                permissionInfo.style.display = 'none';
                scanStatus.textContent = 'Camera ready. Position barcode in view...';
                scanStatus.className = 'scan-status scanning';
                
                await new Promise(resolve => {
                    videoElement.onloadedmetadata = () => {
                        videoElement.play();
                        resolve();
                    };
                });
                
                startBarcodeScanning();
            } catch (error) {
                console.error('Camera error:', error);
                permissionInfo.innerHTML = '‚ö†Ô∏è Camera access denied. Please allow camera permission in your browser settings and try again.';
                permissionInfo.style.background = '#fee2e2';
                permissionInfo.style.borderColor = '#fecaca';
                permissionInfo.style.color = '#991b1b';
                scanStatus.textContent = 'Camera access failed';
                scanStatus.style.background = '#fee2e2';
                scanStatus.style.color = '#991b1b';
            }
        };

        function startBarcodeScanning() {
            scanningActive = true;
            const codeReader = new ZXing.BrowserMultiFormatReader();
            barcodeCodeReader = codeReader;
            
            const hints = new Map();
            hints.set(ZXing.DecodeHintType.TRY_HARDER, true);
            hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, [
                ZXing.BarcodeFormat.EAN_13,
                ZXing.BarcodeFormat.EAN_8,
                ZXing.BarcodeFormat.CODE_128,
                ZXing.BarcodeFormat.CODE_39,
                ZXing.BarcodeFormat.UPC_A,
                ZXing.BarcodeFormat.UPC_E,
                ZXing.BarcodeFormat.QR_CODE
            ]);
            
            const videoElement = document.getElementById('barcodeVideo');
            const scanStatus = document.getElementById('scanStatus');
            
            const scan = async () => {
                if (!scanningActive) return;
                
                try {
                    const result = await codeReader.decodeFromVideoElement(videoElement, hints);
                    
                    if (result) {
                        const barcode = result.text;
                        scanStatus.textContent = `‚úì Barcode detected: ${barcode}`;
                        scanStatus.style.background = '#dcfce7';
                        scanStatus.style.color = '#166534';
                        
                        document.getElementById('barcodeResult').textContent = `Found: ${barcode}`;
                        document.getElementById('barcodeResult').style.display = 'block';
                        document.getElementById('barcodeResult').style.background = '#dcfce7';
                        document.getElementById('barcodeResult').style.color = '#166534';
                        
                        const allItems = getAllItems();
                        const item = allItems.find(i => i.barcode === barcode && i.location === currentScanLocation);
                        
                        if (item) {
                            scanStatus.textContent = `‚úì Item found: ${item.name}`;
                            setTimeout(() => {
                                closeBarcodeScanner();
                                editInventory(item.id);
                            }, 1000);
                        } else {
                            scanStatus.textContent = `‚ö†Ô∏è Item not found in ${currentScanLocation}`;
                            scanStatus.style.background = '#fef3c7';
                            scanStatus.style.color = '#92400e';
                            
                            document.getElementById('barcodeResult').textContent = `Item not found in ${currentScanLocation} inventory. Add new item with this barcode?`;
                            document.getElementById('barcodeResult').style.background = '#fef3c7';
                            document.getElementById('barcodeResult').style.color = '#92400e';
                            
                            setTimeout(() => {
                                closeBarcodeScanner();
                                showAddInventoryModal(currentScanLocation);
                                document.getElementById('itemBarcode').value = barcode;
                            }, 2000);
                        }
                        return;
                    }
                } catch (error) {
                    if (error.name !== 'NotFoundException') {
                        console.error('Scan error:', error);
                    }
                }
                
                if (scanningActive) {
                    requestAnimationFrame(scan);
                }
            };
            
            scan();
        }

        window.closeBarcodeScanner = () => {
            scanningActive = false;
            
            if (barcodeCodeReader) {
                try {
                    barcodeCodeReader.reset();
                } catch (e) {
                    console.log('CodeReader reset error:', e);
                }
                barcodeCodeReader = null;
            }
            
            if (barcodeStream) {
                barcodeStream.getTracks().forEach(track => track.stop());
                barcodeStream = null;
            }
            
            const videoElement = document.getElementById('barcodeVideo');
            videoElement.srcObject = null;
            
            document.getElementById('barcodeResult').style.display = 'none';
            document.getElementById('barcodeResult').style.background = 'var(--bg-light)';
            document.getElementById('barcodeResult').style.color = 'var(--primary)';
            document.getElementById('cameraPermissionInfo').style.display = 'none';
            
            const scanStatus = document.getElementById('scanStatus');
            scanStatus.textContent = 'Initializing scanner...';
            scanStatus.className = 'scan-status';
            
            currentScanLocation = null;
            closeModal('barcodeModal');
        };

        window.showTab = (tab) => {
            document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-pane').forEach(content => content.classList.remove('active'));
            
            const clickedTab = event ? event.target : document.querySelector(`.nav-tab[onclick="showTab('${tab}')"]`);
            if (clickedTab) clickedTab.classList.add('active');
            
            document.getElementById(tab + 'Tab').classList.add('active');
            
            // Refresh charts when dashboard is shown
            if (tab === 'dashboard') {
                setTimeout(() => {
                    console.log('Dashboard tab shown, refreshing charts...');
                    renderCharts();
                }, 200);
            }
            
            // Load BOMs and materials when BOM tab is shown
            if (tab === 'bom') {
                loadMaterials().then(() => {
                    loadBOMs();
                });
            }
        };

        // Role-based access control helper
        function hideTabsForRole(tabsToHide) {
            tabsToHide.forEach(tab => {
                const tabBtn = document.querySelector(`button[onclick="showTab('${tab}')"]`);
                if (tabBtn) tabBtn.style.display = 'none';
            });
        }

        // Leads Management Functions
        async function loadLeads() {
            try {
                const snapshot = await getDocs(collection(db, 'leads'));
                leads = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // Cache the data
                localStorage.setItem('cachedLeads', JSON.stringify(leads));
                renderLeads();
                updateLeadStats();
                populateLeadFilters();
            } catch (error) {
                console.error('Error loading leads:', error);
                // If offline, try to load from localStorage
                const cachedLeads = localStorage.getItem('cachedLeads');
                if (cachedLeads) {
                    leads = JSON.parse(cachedLeads);
                    renderLeads();
                    updateLeadStats();
                    populateLeadFilters();
                }
            }
        }

        function renderLeads() {
            const tbody = document.getElementById('leadsList');
            if (!tbody) return;
            
            if (leads.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="empty-state"><div class="empty-state-icon">üéØ</div><p>No leads yet. Click "Add Lead" to get started.</p></td></tr>';
                return;
            }

            tbody.innerHTML = leads.map(lead => {
                const statusClass = getStatusClass(lead.status);
                const priorityClass = getPriorityClass(lead.priority);
                const isOverdue = isLeadOverdue(lead);
                
                return `
                    <tr data-status="${lead.status}" data-priority="${lead.priority}" data-assigned="${lead.assignedTo}">
                        <td>
                            <strong>${lead.name}</strong>
                            ${lead.designation ? `<br><small style="color: var(--text-secondary);">${lead.designation}</small>` : ''}
                            <br><small style="color: var(--text-secondary);">${lead.phone}</small>
                        </td>
                        <td>
                            <strong>${lead.company}</strong>
                            ${lead.industry ? `<br><small style="color: var(--text-secondary);">${lead.industry}</small>` : ''}
                            <br><small style="color: var(--text-secondary);">${lead.city || ''}</small>
                        </td>
                        <td>
                            ${lead.email ? `üìß ${lead.email}<br>` : ''}
                            üìû ${lead.phone}
                            ${lead.alternatePhone ? `<br>üì± ${lead.alternatePhone}` : ''}
                        </td>
                        <td>
                            <strong>${lead.elevatorType}</strong> x ${lead.quantity}
                            ${lead.capacity ? `<br><small>${lead.capacity} kg</small>` : ''}
                            ${lead.floors ? `<br><small>${lead.floors} floors</small>` : ''}
                        </td>
                        <td>
                            ${lead.value ? `<strong>Rs. ${Number(lead.value).toLocaleString()}</strong>` : 'TBD'}
                            ${lead.budget ? `<br><small>${lead.budget}</small>` : ''}
                        </td>
                        <td>
                            <span class="badge badge-${priorityClass}">${lead.priority}</span>
                            ${isOverdue ? '<br><small style="color: var(--danger);">‚ö†Ô∏è Overdue</small>' : ''}
                        </td>
                        <td><span class="badge badge-${statusClass}">${lead.status}</span></td>
                        <td>${lead.assignedTo || 'Unassigned'}</td>
                        <td>
                            ${lead.lastContact ? new Date(lead.lastContact).toLocaleDateString() : 'Never'}
                            ${lead.nextFollowUp ? `<br><small>Next: ${new Date(lead.nextFollowUp).toLocaleDateString()}</small>` : ''}
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="viewLeadDetails('${lead.id}')">View</button>
                                <button class="btn btn-secondary btn-sm" onclick="editLead('${lead.id}')">Edit</button>
                                ${canDeleteLead(lead) ? `<button class="btn btn-danger btn-sm" onclick="deleteLead('${lead.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function getStatusClass(status) {
            const statusClasses = {
                'New': 'primary',
                'Contacted': 'secondary',
                'Qualified': 'warning',
                'Proposal': 'info',
                'Negotiation': 'warning',
                'Converted': 'success',
                'Lost': 'danger'
            };
            return statusClasses[status] || 'secondary';
        }

        function getPriorityClass(priority) {
            const priorityClasses = {
                'Hot': 'danger',
                'Warm': 'warning',
                'Cold': 'secondary'
            };
            return priorityClasses[priority] || 'secondary';
        }

        function isLeadOverdue(lead) {
            if (!lead.nextFollowUp) return false;
            return new Date(lead.nextFollowUp) < new Date();
        }

        function canDeleteLead(lead) {
            return currentUser.role === 'admin' || 
                   (currentUser.role === 'sales' && lead.assignedTo === currentUser.username);
        }

        function updateLeadStats() {
            if (!document.getElementById('totalLeads')) return;
            
            const totalLeads = leads.length;
            const hotLeads = leads.filter(l => l.priority === 'Hot').length;
            const convertedLeads = leads.filter(l => l.status === 'Converted').length;
            
            const monthlyRevenue = leads
                .filter(l => l.status === 'Converted' && l.value && 
                        new Date(l.updatedAt).getMonth() === new Date().getMonth())
                .reduce((sum, l) => sum + Number(l.value || 0), 0);
            
            const conversionRate = totalLeads > 0 ? ((convertedLeads / totalLeads) * 100).toFixed(1) : 0;
            
            document.getElementById('totalLeads').textContent = totalLeads;
            document.getElementById('hotLeads').textContent = hotLeads;
            document.getElementById('convertedLeads').textContent = convertedLeads;
            document.getElementById('monthlyRevenue').textContent = `Rs. ${monthlyRevenue.toLocaleString()}`;
            document.getElementById('conversionRate').textContent = `${conversionRate}%`;
        }

        function populateLeadFilters() {
            // Populate assigned filter
            const assignedFilter = document.getElementById('leadAssignedFilter');
            if (assignedFilter) {
                const salesReps = [...new Set(leads.map(l => l.assignedTo).filter(Boolean))];
                assignedFilter.innerHTML = '<option value="">All Sales Reps</option>' + 
                    salesReps.map(rep => `<option value="${rep}">${rep}</option>`).join('');
            }
            
            // Populate sales rep dropdown in lead form
            const assignedSelect = document.getElementById('leadAssignedTo');
            if (assignedSelect) {
                // Check for both systemRole and role fields for compatibility
                const salesUsers = employees.filter(emp => {
                    const role = (emp.systemRole || emp.role || '').toLowerCase();
                    const status = (emp.systemStatus || emp.status || '').toLowerCase();
                    return (role === 'sales' || role === 'sales representative' || role === 'admin' || role === 'manager') && (status === 'active');
                });
                
                // Preserve current value if any
                const currentValue = assignedSelect.value;
                
                assignedSelect.innerHTML = '<option value="">Select Sales Rep</option>' + 
                    salesUsers.map(emp => {
                        const empRole = emp.systemRole || emp.role || 'Staff';
                        return `<option value="${emp.username}">${emp.firstName} ${emp.lastName} (${emp.position || empRole})</option>`;
                    }).join('');
                
                // Restore previous value if it exists in the new options
                if (currentValue && Array.from(assignedSelect.options).some(opt => opt.value === currentValue)) {
                    assignedSelect.value = currentValue;
                }
                
                // Control access based on user role
                const userRole = (currentUser.systemRole || currentUser.role || '').toLowerCase();
                if (userRole === 'sales' || userRole === 'sales representative') {
                    // Sales reps can only see their own name in dropdown when creating new leads
                    const editLeadId = document.getElementById('editLeadId').value;
                    if (!editLeadId) {
                        // New lead - set to current user
                        assignedSelect.value = currentUser.username;
                    }
                    // For editing, check if it's their lead
                    const currentLead = leads.find(l => l.id === editLeadId);
                    if (currentLead && currentLead.assignedTo !== currentUser.username && userRole !== 'admin' && userRole !== 'manager') {
                        assignedSelect.disabled = true; // Can't change assignment
                    }
                } else if (userRole === 'admin' || userRole === 'manager') {
                    assignedSelect.disabled = false; // Admin and manager can always change
                }
            }
        }

        window.showAddLeadModal = () => {
            document.getElementById('leadModalTitle').textContent = 'Add New Lead';
            document.getElementById('leadForm').reset();
            document.getElementById('editLeadId').value = '';
            populateLeadFilters();
            
            // Auto-assign to current user if they are a sales rep
            // Check both role and systemRole fields for compatibility
            const userRole = currentUser.systemRole || currentUser.role || '';
            if (userRole.toLowerCase() === 'sales' || userRole.toLowerCase() === 'sales representative') {
                // Wait for dropdown to populate, then set value
                setTimeout(() => {
                    const assignedSelect = document.getElementById('leadAssignedTo');
                    if (assignedSelect) {
                        assignedSelect.value = currentUser.username;
                        // Disable the field for sales reps (only admin/manager can change)
                        if (userRole.toLowerCase() === 'sales' || userRole.toLowerCase() === 'sales representative') {
                            assignedSelect.disabled = false; // Keep enabled but will be set to their username
                        }
                    }
                }, 100);
            }
            
            document.getElementById('leadModal').classList.add('active');
        };

        window.editLead = (id) => {
            const lead = leads.find(l => l.id === id);
            if (!lead) return;
            
            // Check permission - allow admin, manager, sales
            const userRole = (currentUser.systemRole || currentUser.role || '').toLowerCase();
            if (userRole !== 'admin' && userRole !== 'manager' && userRole !== 'sales' && userRole !== 'sales representative') {
                alert('You do not have permission to edit leads');
                return;
            }
            
            // Sales reps can only edit their own assigned leads
            if ((userRole === 'sales' || userRole === 'sales representative') && lead.assignedTo !== currentUser.username) {
                alert('You can only edit leads assigned to you');
                return;
            }
            
            document.getElementById('leadModalTitle').textContent = 'Edit Lead';
            document.getElementById('editLeadId').value = lead.id;
            
            // IMPORTANT: Populate dropdown options FIRST before setting values
            populateLeadFilters();
            
            // Populate form fields
            Object.keys(lead).forEach(key => {
                const element = document.getElementById('lead' + key.charAt(0).toUpperCase() + key.slice(1));
                if (element && key !== 'assignedTo') { // Skip assignedTo for now, we'll set it separately
                    element.value = lead[key] || '';
                }
            });
            
            // Ensure assignedTo is properly set after dropdown is populated
            const assignedSelect = document.getElementById('leadAssignedTo');
            if (lead.assignedTo && assignedSelect) {
                // Check if the assignedTo value exists in dropdown options
                const optionExists = Array.from(assignedSelect.options).some(opt => opt.value === lead.assignedTo);
                
                if (!optionExists && lead.assignedTo) {
                    // Add the assigned user to dropdown if not present
                    const newOption = document.createElement('option');
                    newOption.value = lead.assignedTo;
                    newOption.textContent = lead.assignedTo + ' (Previously Assigned)';
                    assignedSelect.appendChild(newOption);
                }
                
                assignedSelect.value = lead.assignedTo;
                
                // Control who can change assignment
                if (userRole === 'admin' || userRole === 'manager') {
                    assignedSelect.disabled = false; // Admin/Manager can change assignment
                } else {
                    assignedSelect.disabled = true; // Sales reps cannot change assignment
                }
            }

            // Populate hold information if exists
            if (lead.holdInformation) {
                document.getElementById('leadHoldReason').value = lead.holdInformation.reason || '';
                document.getElementById('leadHoldDate').value = lead.holdInformation.holdDate || '';
                document.getElementById('leadExpectedResumeDate').value = lead.holdInformation.expectedResumeDate || '';
                document.getElementById('leadHoldDuration').value = lead.holdInformation.duration || '';
                document.getElementById('leadHoldNotes').value = lead.holdInformation.notes || '';
            }

            // Toggle hold fields visibility
            setTimeout(() => {
                toggleHoldFields('lead');
            }, 100);
            
            document.getElementById('leadModal').classList.add('active');
        };

        window.deleteLead = async (id) => {
            const lead = leads.find(l => l.id === id);
            if (!canDeleteLead(lead)) {
                alert('You do not have permission to delete this lead');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete lead "${lead.name}" from ${lead.company}?`)) return;
            
            try {
                if (isOnline) {
                    await deleteDoc(doc(db, 'leads', id));
                    await addDoc(collection(db, 'activities'), {
                        date: new Date().toISOString(),
                        action: `Deleted lead: ${lead.name} from ${lead.company}`,
                        user: currentUser.username
                    });
                }
                await loadLeads();
            } catch (error) {
                alert('Error deleting lead: ' + error.message);
            }
        };

        // Lead Activity Management Functions
        let currentActivityLeadId = null;

        window.addLeadActivity = () => {
            // Get the current lead ID from the details modal
            const leadDetailsContent = document.getElementById('leadDetailsContent').innerHTML;
            const leadIdMatch = leadDetailsContent.match(/data-lead-id="([^"]+)"/);
            
            if (!leadIdMatch) {
                // Try to find it from the currently displayed lead details
                const leadName = leadDetailsContent.match(/<strong>Name:<\/strong>\s*([^<]+)/);
                if (leadName) {
                    const lead = leads.find(l => l.name.trim() === leadName[1].trim());
                    if (lead) {
                        currentActivityLeadId = lead.id;
                    }
                }
            } else {
                currentActivityLeadId = leadIdMatch[1];
            }

            if (!currentActivityLeadId) {
                alert('Unable to identify lead. Please try again.');
                return;
            }

            // Reset form and set current date/time
            document.getElementById('leadActivityForm').reset();
            document.getElementById('currentLeadId').value = currentActivityLeadId;
            
            // Set current date/time as default
            const now = new Date();
            const localISOTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('activityDate').value = localISOTime;

            // Get lead details for auto-fill
            const lead = leads.find(l => l.id === currentActivityLeadId);
            if (lead) {
                document.getElementById('contactedPerson').value = lead.name || '';
                document.getElementById('contactDesignation').value = lead.designation || '';
            }

            // Hide all activity-specific fields
            document.querySelectorAll('.activity-specific-fields').forEach(field => {
                field.style.display = 'none';
            });

            document.getElementById('leadActivityModal').classList.add('active');
        };

        window.toggleActivityFields = () => {
            const activityType = document.getElementById('activityType').value;
            
            // Hide all activity-specific fields first
            document.querySelectorAll('.activity-specific-fields').forEach(field => {
                field.style.display = 'none';
            });

            // Show relevant fields based on activity type
            switch(activityType) {
                case 'call':
                    document.getElementById('callFields').style.display = 'block';
                    break;
                case 'meeting':
                case 'site_visit':
                case 'demo':
                    document.getElementById('meetingFields').style.display = 'block';
                    break;
                case 'proposal':
                case 'quotation':
                    document.getElementById('proposalFields').style.display = 'block';
                    break;
            }
        };

        // Handle lead activity form submission
        document.getElementById('leadActivityForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const leadId = document.getElementById('currentLeadId').value;
            if (!leadId) {
                alert('No lead selected');
                return;
            }

            // Collect activity data
            const activityData = {
                leadId: leadId,
                type: document.getElementById('activityType').value,
                date: document.getElementById('activityDate').value,
                duration: document.getElementById('activityDuration').value,
                contactedPerson: document.getElementById('contactedPerson').value,
                contactDesignation: document.getElementById('contactDesignation').value,
                description: document.getElementById('activityDescription').value,
                outcome: document.getElementById('activityOutcome').value,
                temperature: document.getElementById('leadTemperature').value,
                nextAction: document.getElementById('nextAction').value,
                nextActionDate: document.getElementById('nextActionDate').value,
                nextStepNotes: document.getElementById('nextStepNotes').value,
                internalNotes: document.getElementById('internalNotes').value,
                createdBy: currentUser.username,
                createdAt: new Date().toISOString()
            };

            // Add type-specific data
            const activityType = activityData.type;
            if (activityType === 'call') {
                activityData.callDetails = {
                    status: document.getElementById('callStatus').value,
                    nextCallDate: document.getElementById('nextCallDate').value
                };
            } else if (activityType === 'meeting' || activityType === 'site_visit' || activityType === 'demo') {
                activityData.meetingDetails = {
                    location: document.getElementById('meetingLocation').value,
                    attendees: document.getElementById('attendees').value,
                    nextMeeting: document.getElementById('nextMeeting').value
                };
            } else if (activityType === 'proposal' || activityType === 'quotation') {
                activityData.proposalDetails = {
                    amount: document.getElementById('proposalAmount').value,
                    validityPeriod: document.getElementById('validityPeriod').value,
                    reference: document.getElementById('proposalReference').value
                };
            }

            try {
                // Add unique ID for activity
                activityData.id = 'activity_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Save to Firebase if online
                if (isOnline) {
                    await addDoc(collection(db, 'leadActivities'), activityData);
                    
                    // Update lead with latest activity info
                    const lead = leads.find(l => l.id === leadId);
                    if (lead) {
                        const updateData = {
                            lastContact: new Date().toISOString(),
                            lastContactBy: currentUser.username,
                            lastActivity: activityData.type,
                            updatedAt: new Date().toISOString()
                        };

                        // Update lead temperature if specified
                        if (activityData.temperature) {
                            updateData.priority = activityData.temperature === 'hot' ? 'Hot' : 
                                                 activityData.temperature === 'warm' ? 'Warm' : 'Cold';
                        }

                        // Update lead status based on activity type
                        if (activityType === 'converted') {
                            updateData.status = 'Converted';
                        } else if (activityType === 'lost') {
                            updateData.status = 'Lost';
                        } else if (activityType === 'proposal' || activityType === 'quotation') {
                            updateData.status = 'Proposal';
                        }

                        await updateDoc(doc(db, 'leads', leadId), updateData);
                    }

                    // Log general activity
                    await addDoc(collection(db, 'activities'), {
                        date: new Date().toISOString(),
                        action: `Lead activity: ${activityData.type} for ${lead?.company} (${lead?.name})`,
                        user: currentUser.username
                    });
                }

                // Always save to localStorage for immediate display and offline backup
                const existingActivities = JSON.parse(localStorage.getItem('leadActivities_' + leadId) || '[]');
                existingActivities.unshift(activityData); // Add to beginning
                localStorage.setItem('leadActivities_' + leadId, JSON.stringify(existingActivities));

                // Close modal and refresh
                closeModal('leadActivityModal');
                await loadLeads();
                
                // Refresh lead details if modal is still open
                if (document.getElementById('leadDetailsModal').classList.contains('active')) {
                    viewLeadDetails(leadId);
                }

                alert('Activity saved successfully!');
            } catch (error) {
                console.error('Error saving activity:', error);
                alert('Error saving activity: ' + error.message);
            }
        });

        // Load and display lead activities
        async function loadLeadActivities(leadId) {
            try {
                if (!isOnline) {
                    // Try to load from localStorage when offline
                    const cachedActivities = localStorage.getItem('leadActivities_' + leadId);
                    return cachedActivities ? JSON.parse(cachedActivities) : [];
                }
                
                // Try simple query first without orderBy to avoid index issues
                const activitiesSnapshot = await getDocs(
                    query(collection(db, 'leadActivities'), where('leadId', '==', leadId))
                );
                
                const activities = activitiesSnapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data() 
                }));

                // Sort activities by date locally
                activities.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Cache activities locally
                localStorage.setItem('leadActivities_' + leadId, JSON.stringify(activities));
                
                return activities;
            } catch (error) {
                console.error('Error loading lead activities:', error);
                
                // Fallback to localStorage
                const cachedActivities = localStorage.getItem('leadActivities_' + leadId);
                return cachedActivities ? JSON.parse(cachedActivities) : [];
            }
        }

        // Update the viewLeadDetails function to include activities
        const originalViewLeadDetails = window.viewLeadDetails;
        window.viewLeadDetails = async (id) => {
            const lead = leads.find(l => l.id === id);
            if (!lead) return;
            
            console.log('Loading activities for lead:', id);
            
            // Load activities for this lead
            const activities = await loadLeadActivities(id);
            
            console.log('Activities loaded:', activities.length, activities);
            
            const content = `
                <div class="lead-details" data-lead-id="${id}">
                    <div class="detail-section">
                        <h4>üìã Basic Information</h4>
                        <p><strong>Name:</strong> ${lead.name}</p>
                        <p><strong>Designation:</strong> ${lead.designation || 'N/A'}</p>
                        <p><strong>Company:</strong> ${lead.company}</p>
                        <p><strong>Industry:</strong> ${lead.industry || 'N/A'}</p>
                        <p><strong>Phone:</strong> ${lead.phone}</p>
                        <p><strong>Email:</strong> ${lead.email || 'N/A'}</p>
                        <p><strong>Address:</strong> ${lead.address}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>üèóÔ∏è Project Requirements</h4>
                        <p><strong>Elevator Type:</strong> ${lead.elevatorType}</p>
                        <p><strong>Quantity:</strong> ${lead.quantity}</p>
                        <p><strong>Capacity:</strong> ${lead.capacity || 'N/A'}</p>
                        <p><strong>Floors:</strong> ${lead.floors || 'N/A'}</p>
                        <p><strong>Budget:</strong> ${lead.budget || 'N/A'}</p>
                        <p><strong>Timeline:</strong> ${lead.timeline || 'N/A'}</p>
                        <p><strong>Specifications:</strong> ${lead.specifications || 'None'}</p>
                    </div>
                    
                    <div class="detail-section">
                        <h4>üíº Business Information</h4>
                        <p><strong>Estimated Value:</strong> ${lead.value ? 'Rs. ' + Number(lead.value).toLocaleString() : 'TBD'}</p>
                        <p><strong>Success Probability:</strong> ${lead.probability || 'N/A'}%</p>
                        <p><strong>Source:</strong> ${lead.source}</p>
                        <p><strong>Priority:</strong> ${lead.priority}</p>
                        <p><strong>Status:</strong> ${lead.status}</p>
                        <p><strong>Assigned To:</strong> ${lead.assignedTo || 'Unassigned'}</p>
                    </div>
                    
                    ${lead.holdInformation ? `
                    <div class="detail-section" style="background: #fef3c7; border: 1px solid #f59e0b;">
                        <h4 style="color: #d97706;">Hold Information</h4>
                        <p><strong>Reason:</strong> ${lead.holdInformation.reason}</p>
                        <p><strong>Hold Date:</strong> ${new Date(lead.holdInformation.holdDate).toLocaleDateString()}</p>
                        <p><strong>Expected Resume:</strong> ${lead.holdInformation.expectedResumeDate ? new Date(lead.holdInformation.expectedResumeDate).toLocaleDateString() : 'TBD'}</p>
                        <p><strong>Duration:</strong> ${lead.holdInformation.duration || 'N/A'}</p>
                        <p><strong>Notes:</strong> ${lead.holdInformation.notes || 'None'}</p>
                    </div>
                    ` : ''}
                    
                    <div class="detail-section">
                        <h4>üìù Notes & Activity</h4>
                        <p>${lead.notes || 'No notes available'}</p>
                        <p><strong>Created:</strong> ${lead.createdAt ? new Date(lead.createdAt).toLocaleString() : 'N/A'}</p>
                        <p><strong>Last Updated:</strong> ${lead.updatedAt ? new Date(lead.updatedAt).toLocaleString() : 'N/A'}</p>
                        ${lead.lastContact ? `<p><strong>Last Contact:</strong> ${new Date(lead.lastContact).toLocaleString()} by ${lead.lastContactBy || 'Unknown'}</p>` : ''}
                        <p><strong>Activities Found:</strong> ${activities.length} activity(ies)</p>
                    </div>

                    <div class="detail-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4>üìà Activity Timeline</h4>
                            <small style="color: #6b7280;">${activities.length} total</small>
                        </div>
                        ${activities.length > 0 ? `
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${activities.slice(0, 10).map(activity => `
                                <div style="border-left: 4px solid #3b82f6; padding: 8px; margin: 8px 0; background: white; border-radius: 4px;">
                                    <div style="font-weight: 600; color: #1e40af; margin-bottom: 4px;">
                                        ${getActivityIcon(activity.type)} ${formatActivityType(activity.type)}
                                        <span style="float: right; font-weight: normal; color: #6b7280; font-size: 12px;">
                                            ${new Date(activity.date).toLocaleDateString()}
                                        </span>
                                    </div>
                                    <div style="font-size: 14px; color: #374151;">
                                        <strong>Contact:</strong> ${activity.contactedPerson} ${activity.contactDesignation ? '(' + activity.contactDesignation + ')' : ''}<br>
                                        <strong>Description:</strong> ${activity.description}<br>
                                        ${activity.outcome ? `<strong>Outcome:</strong> ${formatActivityOutcome(activity.outcome)}<br>` : ''}
                                        ${activity.nextAction ? `<strong>Next Action:</strong> ${formatNextAction(activity.nextAction)}${activity.nextActionDate ? ' by ' + new Date(activity.nextActionDate).toLocaleDateString() : ''}<br>` : ''}
                                        ${activity.nextStepNotes ? `<strong>Notes:</strong> ${activity.nextStepNotes}` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${activities.length > 10 ? `<p style="text-align: center; margin-top: 10px; color: #6b7280;">Showing last 10 activities (${activities.length} total)</p>` : ''}
                        ` : `
                        <div style="text-align: center; padding: 20px; color: #6b7280;">
                            <p>üìù No activities recorded yet</p>
                            <p style="font-size: 12px;">Click "Add Activity" below to track interactions with this lead</p>
                        </div>
                        `}
                    </div>
                </div>
                
                <style>
                .lead-details { max-height: 400px; overflow-y: auto; }
                .detail-section { margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; }
                .detail-section h4 { color: #1e40af; margin-bottom: 10px; }
                .detail-section p { margin: 5px 0; }
                </style>
            `;
            
            document.getElementById('leadDetailsContent').innerHTML = content;
            document.getElementById('leadDetailsModal').classList.add('active');
        };

        // Helper functions for formatting activity data
        function getActivityIcon(type) {
            const icons = {
                call: '‚Ä¢', email: '‚Ä¢', meeting: '‚Ä¢', site_visit: '‚Ä¢',
                proposal: '‚Ä¢', quotation: '‚Ä¢', negotiation: '‚Ä¢',
                follow_up: '‚Ä¢', demo: '‚Ä¢', requirement: '‚Ä¢',
                contract: '‚Ä¢', converted: '‚úì', lost: '‚úó', other: '‚Ä¢'
            };
            return icons[type] || '‚Ä¢';
        }

        function formatActivityType(type) {
            const types = {
                call: 'Phone Call', email: 'Email', meeting: 'Meeting',
                site_visit: 'Site Visit', proposal: 'Proposal Sent',
                quotation: 'Quotation Sent', negotiation: 'Negotiation',
                follow_up: 'Follow Up', demo: 'Product Demo',
                requirement: 'Requirement Discussion', contract: 'Contract Discussion',
                converted: 'Lead Converted', lost: 'Lead Lost', other: 'Other Activity'
            };
            return types[type] || type.charAt(0).toUpperCase() + type.slice(1);
        }

        function formatActivityOutcome(outcome) {
            const outcomes = {
                positive: 'Positive Response', interested: 'Showed Interest',
                neutral: 'Neutral Response', negative: 'Not Interested',
                needs_info: 'Requested More Information', decision_pending: 'Decision Pending',
                budget_issue: 'Budget Constraints', competitor: 'Considering Competitors'
            };
            return outcomes[outcome] || outcome;
        }

        function formatNextAction(action) {
            const actions = {
                follow_up_call: 'Follow-up Call', send_info: 'Send Information',
                schedule_meeting: 'Schedule Meeting', site_visit: 'Site Visit',
                prepare_proposal: 'Prepare Proposal', price_revision: 'Revise Pricing',
                technical_clarification: 'Technical Clarification',
                contract_preparation: 'Prepare Contract', wait_customer: 'Wait for Customer',
                no_action: 'No Further Action'
            };
            return actions[action] || action;
        }

        window.filterLeads = () => {
            const searchValue = document.getElementById('searchLeads')?.value.toLowerCase() || '';
            const statusValue = document.getElementById('leadStatusFilter')?.value || '';
            const priorityValue = document.getElementById('leadPriorityFilter')?.value || '';
            const assignedValue = document.getElementById('leadAssignedFilter')?.value || '';
            const sourceValue = document.getElementById('leadSourceFilter')?.value || '';
            
            const rows = document.querySelectorAll('#leadsList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const status = row.getAttribute('data-status');
                const priority = row.getAttribute('data-priority');
                const assigned = row.getAttribute('data-assigned');
                
                const matchesSearch = text.includes(searchValue);
                const matchesStatus = !statusValue || status === statusValue;
                const matchesPriority = !priorityValue || priority === priorityValue;
                const matchesAssigned = !assignedValue || assigned === assignedValue;
                const matchesSource = !sourceValue || text.includes(sourceValue.toLowerCase());
                
                row.style.display = matchesSearch && matchesStatus && matchesPriority && 
                                   matchesAssigned && matchesSource ? '' : 'none';
            });
        };

        window.exportLeadsPDF = async () => {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4'); // Landscape A4
                
                // Add company header
                let yPos = await addCompanyHeaderToPDF(doc, 'Leads Report', 10);
                yPos += 5;
                
                // Report metadata
                doc.setFontSize(10);
                doc.setTextColor(15, 23, 42);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated: ${new Date().toLocaleString()}`, 15, yPos);
                doc.text(`By: ${currentUser.fullName || currentUser.username}`, 150, yPos);
                doc.text(`Total Leads: ${leads.length}`, 240, yPos);
                yPos += 8;
                
                // Summary stats in boxes
                const stats = [
                    { label: 'Hot Leads', value: leads.filter(l => l.priority === 'Hot').length, color: [220, 38, 38] },
                    { label: 'Converted', value: leads.filter(l => l.status === 'Converted').length, color: [22, 163, 74] },
                    { label: 'In Progress', value: leads.filter(l => l.status === 'In Progress').length, color: [234, 88, 12] },
                    { label: 'Conversion Rate', value: leads.length > 0 ? `${((leads.filter(l => l.status === 'Converted').length / leads.length) * 100).toFixed(1)}%` : '0%', color: [37, 99, 235] }
                ];
                
                let xPos = 15;
                stats.forEach(stat => {
                    doc.setDrawColor(226, 232, 240);
                    doc.setLineWidth(0.3);
                    doc.rect(xPos, yPos, 65, 15);
                    
                    doc.setFontSize(9);
                    doc.setTextColor(100, 116, 139);
                    doc.text(stat.label, xPos + 2, yPos + 5);
                    
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(...stat.color);
                    doc.text(String(stat.value), xPos + 2, yPos + 12);
                    
                    xPos += 68;
                    doc.setFont(undefined, 'normal');
                });
                
                yPos += 20;
                
                // Table headers
                doc.setFillColor(248, 250, 252);
                doc.rect(15, yPos - 5, 267, 8, 'F');
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(15, 23, 42);
                
                const headers = [
                    { label: '#', x: 17, width: 10 },
                    { label: 'Name', x: 30, width: 45 },
                    { label: 'Company', x: 78, width: 40 },
                    { label: 'Contact', x: 120, width: 30 },
                    { label: 'Type', x: 152, width: 30 },
                    { label: 'Value', x: 184, width: 25 },
                    { label: 'Priority', x: 211, width: 20 },
                    { label: 'Status', x: 233, width: 25 },
                    { label: 'Assigned', x: 260, width: 20 }
                ];
                
                headers.forEach(h => {
                    doc.text(h.label, h.x, yPos);
                });
                
                yPos += 5;
                doc.setDrawColor(226, 232, 240);
                doc.line(15, yPos, 282, yPos);
                yPos += 5;
                
                // Table data
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                
                if (leads.length === 0) {
                    doc.setTextColor(100, 116, 139);
                    doc.text('No leads available', 148.5, yPos + 10, { align: 'center' });
                } else {
                    leads.forEach((lead, index) => {
                        if (yPos > 190) {
                            doc.addPage();
                            yPos = 20;
                            
                            // Repeat headers
                            doc.setFillColor(248, 250, 252);
                            doc.rect(15, yPos - 5, 267, 8, 'F');
                            doc.setFont(undefined, 'bold');
                            headers.forEach(h => {
                                doc.text(h.label, h.x, yPos);
                            });
                            yPos += 5;
                            doc.line(15, yPos, 282, yPos);
                            yPos += 5;
                            doc.setFont(undefined, 'normal');
                        }
                        
                        // Alternating row background
                        if (index % 2 === 0) {
                            doc.setFillColor(249, 250, 251);
                            doc.rect(15, yPos - 4, 267, 7, 'F');
                        }
                        
                        doc.setTextColor(15, 23, 42);
                        
                        // Row data with truncation
                        doc.text(String(index + 1), 17, yPos);
                        doc.text((lead.name || '').substring(0, 25), 30, yPos);
                        doc.text((lead.company || '').substring(0, 20), 78, yPos);
                        doc.text((lead.phone || '').substring(0, 15), 120, yPos);
                        doc.text((lead.elevatorType || '').substring(0, 15), 152, yPos);
                        
                        // Value formatting
                        const value = lead.value ? `‚Çπ${(Number(lead.value) / 100000).toFixed(1)}L` : '-';
                        doc.text(value, 184, yPos);
                        
                        // Priority with color
                        const priorityColor = lead.priority === 'Hot' ? [220, 38, 38] : 
                                            lead.priority === 'Warm' ? [234, 88, 12] : [100, 116, 139];
                        doc.setTextColor(...priorityColor);
                        doc.text((lead.priority || 'Normal').substring(0, 10), 211, yPos);
                        
                        // Status with color
                        const statusColor = lead.status === 'Converted' ? [22, 163, 74] :
                                          lead.status === 'In Progress' ? [37, 99, 235] : [100, 116, 139];
                        doc.setTextColor(...statusColor);
                        doc.text((lead.status || '').substring(0, 12), 233, yPos);
                        
                        doc.setTextColor(15, 23, 42);
                        doc.text((lead.assignedTo || '').substring(0, 12), 260, yPos);
                        
                        yPos += 7;
                    });
                }
                
                // Add footer to all pages
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    await addCompanyFooterToPDF(doc, 210);
                }
                
                doc.save(`Leads_Report_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error generating leads PDF:', error);
                alert('Error generating leads PDF. Please try again.');
            }
        };

        // Export hold reports for various modules
        window.exportHoldReportPDF = async (type) => {
            const jspdf = await ensureJsPDF();
            const { jsPDF } = jspdf;
            const doc = new jsPDF();

            // Try to load logo
            let logoImg = null;
            try {
                logoImg = await loadImageAsDataUrl('ambivare.png');
                if (!logoImg) {
                    const logoUrl = new URL('ambivare.png', window.location.href).href;
                    logoImg = await loadImageAsDataUrl(logoUrl);
                }
            } catch (err) {
                console.warn('Could not load logo for hold report:', err);
            }

            // Header with company branding
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 35, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            if (logoImg) {
                try { doc.addImage(logoImg, 'PNG', 18, 7, 20, 20); } catch (e) { console.warn('addImage failed:', e); }
            }
            doc.text('AVANT ELEVATORS', 105, 15, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`${type.toUpperCase()} ON HOLD REPORT`, 105, 26, { align: 'center' });
            
            // Report metadata
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(10);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 45);
            doc.text(`By: ${currentUser.fullName || currentUser.username}`, 20, 52);
            
            let holdItems = [];
            let headers = [];
            
            // Filter data based on type
            if (type === 'leads') {
                holdItems = leads.filter(item => item.status === 'On Hold' && item.holdInformation);
                headers = ['Lead Name', 'Company', 'Hold Reason', 'Hold Date', 'Expected Resume', 'Duration', 'Notes'];
                doc.text(`Total On Hold Leads: ${holdItems.length}`, 20, 59);
            } else if (type === 'projects') {
                holdItems = projects.filter(item => item.status === 'On Hold' && item.holdInformation);
                headers = ['Project Name', 'Client', 'Hold Reason', 'Hold Date', 'Expected Resume', 'Duration', 'Notes'];
                doc.text(`Total On Hold Projects: ${holdItems.length}`, 20, 59);
            } else if (type === 'maintenance') {
                holdItems = maintenance.filter(item => item.status === 'On Hold' && item.holdInformation);
                headers = ['Project', 'Elevator', 'Hold Reason', 'Hold Date', 'Expected Resume', 'Duration', 'Notes'];
                doc.text(`Total On Hold Maintenance: ${holdItems.length}`, 20, 59);
            }
            
            if (holdItems.length === 0) {
                doc.setFontSize(14);
                doc.setTextColor(100, 116, 139);
                doc.text(`No items are currently on hold for ${type}.`, 105, 100, { align: 'center' });
                doc.save(`${type}_hold_report_${new Date().toISOString().split('T')[0]}.pdf`);
                return;
            }
            
            // Table setup
            let y = 80;
            const pageHeight = doc.internal.pageSize.height;
            const lineHeight = 6;
            const cellPadding = 2;
            
            // Headers
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(37, 99, 235);
            
            let x = 20;
            const colWidths = type === 'maintenance' ? [35, 25, 35, 25, 25, 20, 45] : [40, 40, 35, 25, 25, 20, 45];
            
            headers.forEach((header, index) => {
                doc.text(header, x, y);
                x += colWidths[index];
            });
            
            y += lineHeight + 2;
            
            // Draw header line
            doc.setDrawColor(37, 99, 235);
            doc.line(20, y, 190, y);
            y += 4;
            
            // Data rows
            doc.setFont(undefined, 'normal');
            doc.setTextColor(15, 23, 42);
            doc.setFontSize(8);
            
            holdItems.forEach((item, index) => {
                if (y > pageHeight - 40) {
                    doc.addPage();
                    y = 40;
                }
                
                x = 20;
                const hold = item.holdInformation;
                
                let rowData = [];
                if (type === 'leads') {
                    rowData = [
                        item.name || 'N/A',
                        item.company || 'N/A',
                        hold.reason || 'N/A',
                        hold.holdDate ? new Date(hold.holdDate).toLocaleDateString() : 'N/A',
                        hold.expectedResumeDate ? new Date(hold.expectedResumeDate).toLocaleDateString() : 'N/A',
                        hold.duration || 'N/A',
                        (hold.notes || '').substring(0, 50) + (hold.notes && hold.notes.length > 50 ? '...' : '')
                    ];
                } else if (type === 'projects') {
                    rowData = [
                        item.name || 'N/A',
                        item.client || 'N/A',
                        hold.reason || 'N/A',
                        hold.holdDate ? new Date(hold.holdDate).toLocaleDateString() : 'N/A',
                        hold.expectedResumeDate ? new Date(hold.expectedResumeDate).toLocaleDateString() : 'N/A',
                        hold.duration || 'N/A',
                        (hold.notes || '').substring(0, 50) + (hold.notes && hold.notes.length > 50 ? '...' : '')
                    ];
                } else if (type === 'maintenance') {
                    rowData = [
                        item.projectName || 'N/A',
                        item.elevatorId || 'N/A',
                        hold.reason || 'N/A',
                        hold.holdDate ? new Date(hold.holdDate).toLocaleDateString() : 'N/A',
                        hold.expectedResumeDate ? new Date(hold.expectedResumeDate).toLocaleDateString() : 'N/A',
                        hold.duration || 'N/A',
                        (hold.notes || '').substring(0, 40) + (hold.notes && hold.notes.length > 40 ? '...' : '')
                    ];
                }
                
                rowData.forEach((data, colIndex) => {
                    // Wrap text if too long
                    const text = String(data);
                    doc.text(text, x, y);
                    x += colWidths[colIndex];
                });
                
                y += lineHeight + 1;
                
                // Add separator line every 5 rows
                if ((index + 1) % 5 === 0) {
                    doc.setDrawColor(200, 200, 200);
                    doc.line(20, y, 190, y);
                    y += 2;
                }
            });
            
            // Summary section
            y += 10;
            if (y > pageHeight - 60) {
                doc.addPage();
                y = 40;
            }
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(37, 99, 235);
            doc.text('HOLD SUMMARY:', 20, y);
            
            y += 8;
            doc.setFont(undefined, 'normal');
            doc.setTextColor(15, 23, 42);
            
            // Group by hold reasons
            const reasonCounts = {};
            holdItems.forEach(item => {
                const reason = item.holdInformation?.reason || 'Unknown';
                reasonCounts[reason] = (reasonCounts[reason] || 0) + 1;
            });
            
            Object.entries(reasonCounts).forEach(([reason, count]) => {
                doc.text(`‚Ä¢ ${reason}: ${count} items`, 25, y);
                y += 6;
            });
            
            // Footer
            const footer = `Report generated on ${new Date().toLocaleString()} | ${companySettings.name}`;
            doc.setFontSize(8);
            doc.setTextColor(100, 116, 139);
            doc.text(footer, 105, pageHeight - 10, { align: 'center' });
            
            doc.save(`${type}_hold_report_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        // Lead form submission
        document.addEventListener('DOMContentLoaded', function() {
            const leadForm = document.getElementById('leadForm');
            if (leadForm) {
                leadForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Check permissions - allow admin, manager, and sales
                    const userRole = (currentUser.systemRole || currentUser.role || '').toLowerCase();
                    if (userRole !== 'admin' && userRole !== 'manager' && userRole !== 'sales' && userRole !== 'sales representative') {
                        alert('You do not have permission to create/edit leads');
                        return;
                    }
                    
                    const leadId = document.getElementById('editLeadId').value;
                    const assignedTo = document.getElementById('leadAssignedTo').value;
                    
                    // If sales rep is creating a new lead and no assignment, auto-assign to them
                    const finalAssignedTo = assignedTo || 
                        ((userRole === 'sales' || userRole === 'sales representative') && !leadId ? currentUser.username : assignedTo);
                    
                    const leadData = {
                        name: document.getElementById('leadName').value,
                        designation: document.getElementById('leadDesignation').value,
                        phone: document.getElementById('leadPhone').value,
                        alternatePhone: document.getElementById('leadAlternatePhone').value,
                        email: document.getElementById('leadEmail').value,
                        company: document.getElementById('leadCompany').value,
                        industry: document.getElementById('leadIndustry').value,
                        address: document.getElementById('leadAddress').value,
                        city: document.getElementById('leadCity').value,
                        state: document.getElementById('leadState').value,
                        elevatorType: document.getElementById('leadElevatorType').value,
                        quantity: document.getElementById('leadQuantity').value,
                        capacity: document.getElementById('leadCapacity').value,
                        floors: document.getElementById('leadFloors').value,
                        specifications: document.getElementById('leadSpecifications').value,
                        budget: document.getElementById('leadBudget').value,
                        timeline: document.getElementById('leadTimeline').value,
                        value: document.getElementById('leadValue').value,
                        probability: document.getElementById('leadProbability').value,
                        source: document.getElementById('leadSource').value,
                        priority: document.getElementById('leadPriority').value,
                        status: document.getElementById('leadStatus').value,
                        assignedTo: finalAssignedTo,
                        notes: document.getElementById('leadNotes').value,
                        updatedAt: new Date().toISOString(),
                        updatedBy: currentUser.username
                    };

                    // Add hold information if status is "On Hold"
                    if (leadData.status === 'On Hold') {
                        leadData.holdInformation = {
                            reason: document.getElementById('leadHoldReason').value,
                            holdDate: document.getElementById('leadHoldDate').value,
                            expectedResumeDate: document.getElementById('leadExpectedResumeDate').value,
                            duration: document.getElementById('leadHoldDuration').value,
                            notes: document.getElementById('leadHoldNotes').value,
                            heldBy: currentUser.username,
                            heldAt: new Date().toISOString()
                        };
                    }
                    
                    if (!leadId) {
                        leadData.createdAt = new Date().toISOString();
                        leadData.createdBy = currentUser.username;
                        leadData.lastContact = new Date().toISOString();
                    }
                    
                    try {
                        if (isOnline) {
                            if (leadId) {
                                await updateDoc(doc(db, 'leads', leadId), leadData);
                                await addDoc(collection(db, 'activities'), {
                                    date: new Date().toISOString(),
                                    action: `Updated lead: ${leadData.name} from ${leadData.company} - Assigned to: ${finalAssignedTo}`,
                                    user: currentUser.username
                                });
                            } else {
                                await addDoc(collection(db, 'leads'), leadData);
                                await addDoc(collection(db, 'activities'), {
                                    date: new Date().toISOString(),
                                    action: `Created new lead: ${leadData.name} from ${leadData.company} - Assigned to: ${finalAssignedTo}`,
                                    user: currentUser.username
                                });
                            }
                        }
                        
                        closeModal('leadModal');
                        await loadLeads();
                        // Also ensure cache is updated
                        localStorage.setItem('cachedLeads', JSON.stringify(leads));
                        alert(`Lead ${leadId ? 'updated' : 'created'} successfully!${finalAssignedTo ? `\nAssigned to: ${finalAssignedTo}` : ''}`);
                    } catch (error) {
                        alert('Error saving lead: ' + error.message);
                    }
                });
            }
        });

        window.closeModal = (modalId) => {
            document.getElementById(modalId).classList.remove('active');
            if (modalId === 'userModal') {
                document.getElementById('newUsername').disabled = false;
            }
            if (modalId === 'maintenanceModal') {
                clearSignature('arrival');
                clearSignature('completion');
            }
        };

        // Signature Canvas Handling
        let isDrawing = false;
        let currentCanvas = null;

        function setupSignatureCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Set canvas size properly
            canvas.width = 400;
            canvas.height = 200;
            
            // Set drawing properties
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            // Fill background with white to ensure proper image generation
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Reset stroke style after filling background
            ctx.strokeStyle = '#000000';
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for mobile
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });
            
            canvas.addEventListener('touchend', function(e) {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                canvas.dispatchEvent(mouseEvent);
            });

            function startDrawing(e) {
                isDrawing = true;
                currentCanvas = canvas;
                const rect = canvas.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            }

            function draw(e) {
                if (!isDrawing || currentCanvas !== canvas) return;
                const rect = canvas.getBoundingClientRect();
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
            }

            function stopDrawing() {
                if (currentCanvas === canvas) {
                    isDrawing = false;
                    currentCanvas = null;
                    // Force a redraw to ensure signature is properly rendered
                    ctx.stroke();
                }
            }
        }

        window.clearSignature = (type) => {
            const canvasId = type + 'SignatureCanvas';
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                // Clear the canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // Fill with white background to ensure proper PDF generation
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // Reset stroke style
                ctx.strokeStyle = '#000000';
            }
        };

        window.clearSignatureById = (canvasId) => {
            const canvas = document.getElementById(canvasId);
            if (canvas) {
                const ctx = canvas.getContext('2d');
                // Clear the canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // Fill with white background to ensure proper PDF generation
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                // Reset stroke style
                ctx.strokeStyle = '#000000';
            }
        };

        window.toggleSignatureSection = () => {
            const status = document.getElementById('maintenanceStatus').value;
            const arrivalSection = document.getElementById('arrivalSignatureSection');
            const completionSection = document.getElementById('completionSignatureSection');
            const exportBtn = document.getElementById('exportBtn');
            
            if (status === 'In Progress') {
                arrivalSection.style.display = 'block';
                completionSection.style.display = 'none';
                exportBtn.style.display = 'none';
                
                // Setup arrival canvas with delay to ensure DOM is ready
                setTimeout(() => {
                    setupSignatureCanvas('arrivalSignatureCanvas');
                    // Initialize with white background
                    const canvas = document.getElementById('arrivalSignatureCanvas');
                    if (canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                    }
                }, 200);
                
            } else if (status === 'Completed') {
                arrivalSection.style.display = 'block';
                completionSection.style.display = 'block';
                exportBtn.style.display = 'inline-flex';
                
                // Setup both canvases with delay
                setTimeout(() => {
                    setupSignatureCanvas('arrivalSignatureCanvas');
                    setupSignatureCanvas('completionSignatureCanvas');
                    
                    // Initialize both canvases with white background
                    ['arrivalSignatureCanvas', 'completionSignatureCanvas'].forEach(canvasId => {
                        const canvas = document.getElementById(canvasId);
                        if (canvas) {
                            const ctx = canvas.getContext('2d');
                            ctx.fillStyle = '#FFFFFF';
                            ctx.fillRect(0, 0, canvas.width, canvas.height);
                        }
                    });
                }, 200);
                
            } else {
                arrivalSection.style.display = 'none';
                completionSection.style.display = 'none';
                exportBtn.style.display = 'none';
            }
        };

        // Toggle hold fields visibility based on status selection
        window.toggleHoldFields = (type) => {
            const statusElementId = type + 'Status';
            const holdFieldsId = type + 'HoldFields';
            
            const statusElement = document.getElementById(statusElementId);
            const holdFields = document.getElementById(holdFieldsId);
            
            if (!statusElement || !holdFields) return;
            
            const status = statusElement.value;
            
            if (status === 'On Hold') {
                holdFields.style.display = 'block';
                
                // Set today's date as default hold date
                const holdDateField = document.getElementById(type + 'HoldDate');
                if (holdDateField && !holdDateField.value) {
                    const today = new Date().toISOString().split('T')[0];
                    holdDateField.value = today;
                }
                
                // Make hold fields required when visible
                const holdReason = document.getElementById(type + 'HoldReason');
                const holdDate = document.getElementById(type + 'HoldDate');
                const holdNotes = document.getElementById(type + 'HoldNotes');
                
                if (holdReason) holdReason.required = true;
                if (holdDate) holdDate.required = true;
                if (holdNotes) holdNotes.required = true;
                
            } else {
                holdFields.style.display = 'none';
                
                // Remove required validation when hidden
                const holdReason = document.getElementById(type + 'HoldReason');
                const holdDate = document.getElementById(type + 'HoldDate');
                const holdNotes = document.getElementById(type + 'HoldNotes');
                
                if (holdReason) holdReason.required = false;
                if (holdDate) holdDate.required = false;
                if (holdNotes) holdNotes.required = false;
            }
        };

        // Toggle Expected Completion field based on project type
        window.toggleProjectTypeFields = () => {
            const projectType = document.getElementById('projectType')?.value;
            const expectedCompletionGroup = document.getElementById('expectedCompletionGroup');
            
            if (expectedCompletionGroup) {
                // Hide Expected Completion for Maintenance contracts (AMC)
                if (projectType === 'Maintenance') {
                    expectedCompletionGroup.style.display = 'none';
                    document.getElementById('projectEndDate').required = false;
                } else {
                    expectedCompletionGroup.style.display = 'block';
                    // Optional: make it required for Installation/Modernization
                    if (projectType === 'Installation' || projectType === 'Modernization') {
                        document.getElementById('projectEndDate').required = false; // Keep optional
                    }
                }
            }
        };

        function isCanvasEmpty(canvas) {
            const ctx = canvas.getContext('2d');
            const pixelBuffer = new Uint32Array(
                ctx.getImageData(0, 0, canvas.width, canvas.height).data.buffer
            );
            
            // Check if all pixels are white (RGBA: 255,255,255,255) or transparent
            // Since we fill with white background, we need to check for non-white pixels
            const whitePixel = 0xFFFFFFFF; // White in RGBA format
            const transparentPixel = 0x00000000; // Transparent
            
            return pixelBuffer.every(pixel => 
                pixel === whitePixel || pixel === transparentPixel
            );
        }

        function loadSignatureToCanvas(canvasId, dataURL) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                // Clear canvas and set white background first
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw the signature image
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            
            img.onerror = function() {
                console.error('Failed to load signature image');
                // Clear canvas on error
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#FFFFFF';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            };
            
            img.src = dataURL;
        }

        // Set complaint date to current time when modal opens
        window.showAddMaintenanceModal = () => {
            document.getElementById('maintenanceModalTitle').textContent = 'New RCI Record';
            document.getElementById('maintenanceForm').reset();
            document.getElementById('editMaintenanceId').value = '';
            document.getElementById('exportBtn').style.display = 'none';
            
            // Reset RCI type
            if (document.getElementById('rciType')) {
                document.getElementById('rciType').value = '';
            }
            
            // Set current date/time for complaint
            const now = new Date();
            document.getElementById('complaintDate').value = now.toISOString().slice(0, 16);
            
            const projectSelect = document.getElementById('maintenanceProject');
            projectSelect.innerHTML = '<option value="">Select Project</option>' + 
                projects.map(p => `<option value="${p.id}">${p.name} (${p.code})</option>`).join('');
            
            console.log('üìä Projects loaded into maintenance dropdown:');
            projects.forEach(p => {
                console.log(`   - ${p.name} (${p.code}):`, {
                    hasWings: !!p.wings,
                    wingsCount: p.wings?.length || 0,
                    wings: p.wings
                });
            });
            
            const assigneeSelect = document.getElementById('maintenanceAssignee');
            assigneeSelect.innerHTML = '<option value="">Select Technician</option>' + 
                employees.filter(emp => {
                    const role = (emp.systemRole || emp.role || '').toLowerCase();
                    const status = (emp.systemStatus || emp.status || '').toLowerCase();
                    return (role === 'technician' || role === 'user' || role === 'admin' || role === 'manager') && status === 'active';
                })
                .map(emp => `<option value="${emp.username}">${emp.firstName} ${emp.lastName} (${emp.position})</option>`).join('');
            
            // Auto-assign to current user if they are a technician
            const userRole = (currentUser.systemRole || currentUser.role || '').toLowerCase();
            if (userRole === 'technician' || userRole === 'user') {
                setTimeout(() => {
                    assigneeSelect.value = currentUser.username;
                }, 100);
            }
            
            toggleSignatureSection();
            document.getElementById('maintenanceModal').classList.add('active');
        };
        
        // ==================== RCI ANALYTICS FUNCTIONS ====================
        
        function updateRCIStats() {
            // Check if elements exist first
            const totalRCIElement = document.getElementById('totalRCIRecords');
            const repairsElement = document.getElementById('repairsCount');
            const complaintsElement = document.getElementById('complaintsCount');
            const maintenanceElement = document.getElementById('maintenanceCount');
            const defaultedElement = document.getElementById('defaultedLiftsCount');
            const healthyElement = document.getElementById('healthyLiftsCount');
            
            // If elements don't exist, skip the update
            if (!totalRCIElement || !repairsElement || !complaintsElement || !maintenanceElement || !defaultedElement || !healthyElement) {
                return;
            }
            
            if (!maintenance || maintenance.length === 0) {
                totalRCIElement.textContent = '0';
                repairsElement.textContent = '0';
                complaintsElement.textContent = '0';
                maintenanceElement.textContent = '0';
                defaultedElement.textContent = '0';
                healthyElement.textContent = '0';
                return;
            }
            
            // Count by type
            const repairs = maintenance.filter(m => m.rciType === 'Repair').length;
            const complaints = maintenance.filter(m => m.rciType === 'Complaint').length;
            const maintenanceRecords = maintenance.filter(m => m.rciType === 'Maintenance' || !m.rciType).length;
            
            totalRCIElement.textContent = maintenance.length;
            repairsElement.textContent = repairs;
            complaintsElement.textContent = complaints;
            maintenanceElement.textContent = maintenanceRecords;
            
            // Analyze lift health - defaulted vs healthy
            const liftAnalysis = analyzeLiftHealth();
            defaultedElement.textContent = liftAnalysis.defaulted.length;
            healthyElement.textContent = liftAnalysis.healthy.length;
        }
        
        function analyzeLiftHealth() {
            const liftRecords = {};
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const oneMonthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
            
            // Group records by elevator
            maintenance.forEach(m => {
                const elevators = m.elevatorIds || [m.elevatorId];
                elevators.forEach(elevatorId => {
                    if (!elevatorId) return;
                    if (!liftRecords[elevatorId]) {
                        liftRecords[elevatorId] = {
                            id: elevatorId,
                            projectName: m.projectName,
                            wing: m.wing,
                            totalRecords: 0,
                            weeklyRecords: 0,
                            monthlyRecords: 0,
                            repairs: 0,
                            complaints: 0,
                            maintenance: 0,
                            lastIssueDate: null
                        };
                    }
                    
                    liftRecords[elevatorId].totalRecords++;
                    
                    const recordDate = new Date(m.createdAt || m.complaintDate || m.dueDate);
                    if (recordDate >= oneWeekAgo) {
                        liftRecords[elevatorId].weeklyRecords++;
                    }
                    if (recordDate >= oneMonthAgo) {
                        liftRecords[elevatorId].monthlyRecords++;
                    }
                    
                    if (m.rciType === 'Repair') liftRecords[elevatorId].repairs++;
                    else if (m.rciType === 'Complaint') liftRecords[elevatorId].complaints++;
                    else liftRecords[elevatorId].maintenance++;
                    
                    if (!liftRecords[elevatorId].lastIssueDate || recordDate > new Date(liftRecords[elevatorId].lastIssueDate)) {
                        liftRecords[elevatorId].lastIssueDate = recordDate;
                    }
                });
            });
            
            const defaulted = [];
            const healthy = [];
            const moderate = [];
            
            Object.values(liftRecords).forEach(lift => {
                // Defaulted: 3+ issues in a week OR 5+ issues in a month
                if (lift.weeklyRecords >= 3 || lift.monthlyRecords >= 5) {
                    lift.status = 'Defaulted';
                    lift.healthScore = Math.max(0, 100 - (lift.monthlyRecords * 10));
                    defaulted.push(lift);
                } 
                // Moderate: 1-2 issues in a week OR 2-4 issues in a month
                else if (lift.weeklyRecords >= 1 || lift.monthlyRecords >= 2) {
                    lift.status = 'Moderate';
                    lift.healthScore = Math.max(40, 100 - (lift.monthlyRecords * 8));
                    moderate.push(lift);
                }
                // Healthy: 0 issues in a week AND 0-1 issues in a month
                else {
                    lift.status = 'Healthy';
                    lift.healthScore = 100 - (lift.monthlyRecords * 5);
                    healthy.push(lift);
                }
            });
            
            return { defaulted, moderate, healthy, all: Object.values(liftRecords) };
        }
        
        function populateRCIFilters() {
            // Populate project filter
            const projectFilter = document.getElementById('maintenanceProjectFilter');
            if (projectFilter && projects && maintenance) {
                const projectsInRCI = [...new Set(maintenance.map(m => m.projectName).filter(Boolean))];
                projectFilter.innerHTML = '<option value="">All Projects</option>' +
                    projectsInRCI.map(name => `<option value="${name}">${name}</option>`).join('');
            }
        }
        
        window.showRCIAnalytics = () => {
            const analysis = analyzeLiftHealth();
            
            // Build comprehensive analytics view
            let analyticsHTML = `
                <div class="modal" id="rciAnalyticsModal" style="display: block;">
                    <div class="modal-dialog" style="max-width: 1200px;">
                        <div class="modal-header">
                            <h3 class="modal-title">üìä LIFT HEALTH ANALYTICS - GOD MODE</h3>
                            <button class="modal-close" onclick="document.getElementById('rciAnalyticsModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                            
                            <!-- Summary Stats -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                                <div style="background: #fecaca; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #dc2626;">
                                    <div style="font-size: 36px; font-weight: 700; color: #b91c1c;">${analysis.defaulted.length}</div>
                                    <div style="color: #991b1b; font-weight: 600;">‚ö†Ô∏è DEFAULTED LIFTS</div>
                                    <small style="color: #dc2626;">Critical attention required</small>
                                </div>
                                <div style="background: #fef3c7; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #f59e0b;">
                                    <div style="font-size: 36px; font-weight: 700; color: #d97706;">${analysis.moderate.length}</div>
                                    <div style="color: #92400e; font-weight: 600;">‚ö° MODERATE ISSUES</div>
                                    <small style="color: #d97706;">Monitor closely</small>
                                </div>
                                <div style="background: #dcfce7; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #16a34a;">
                                    <div style="font-size: 36px; font-weight: 700; color: #16a34a;">${analysis.healthy.length}</div>
                                    <div style="color: #166534; font-weight: 600;">‚úÖ HEALTHY LIFTS</div>
                                    <small style="color: #16a34a;">Proper working condition</small>
                                </div>
                                <div style="background: #dbeafe; padding: 20px; border-radius: 12px; text-align: center; border: 2px solid #3b82f6;">
                                    <div style="font-size: 36px; font-weight: 700; color: #2563eb;">${analysis.all.length}</div>
                                    <div style="color: #1e40af; font-weight: 600;">üìä TOTAL LIFTS TRACKED</div>
                                    <small style="color: #3b82f6;">With RCI records</small>
                                </div>
                            </div>
                            
                            <!-- Defaulted Lifts (Critical) -->
                            ${analysis.defaulted.length > 0 ? `
                            <div style="background: #fef2f2; border: 2px solid #dc2626; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                <h4 style="color: #b91c1c; margin: 0 0 16px 0;">üö® DEFAULTED LIFTS - CRITICAL ATTENTION REQUIRED</h4>
                                <p style="color: #dc2626; margin-bottom: 12px;">These lifts have repeated issues (3+ times/week or 5+ times/month) and need immediate attention:</p>
                                <div class="table-container">
                                    <table class="table">
                                        <thead style="background: #fee2e2;">
                                            <tr>
                                                <th>Lift ID</th>
                                                <th>Project</th>
                                                <th>Wing</th>
                                                <th>Weekly Issues</th>
                                                <th>Monthly Issues</th>
                                                <th>Total Issues</th>
                                                <th>Repairs</th>
                                                <th>Complaints</th>
                                                <th>Health Score</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${analysis.defaulted.sort((a, b) => b.monthlyRecords - a.monthlyRecords).map(lift => `
                                                <tr style="background: #fef2f2;">
                                                    <td><strong style="color: #dc2626;">${lift.id}</strong></td>
                                                    <td>${lift.projectName || '-'}</td>
                                                    <td>${lift.wing || '-'}</td>
                                                    <td style="color: #dc2626; font-weight: 700;">${lift.weeklyRecords}</td>
                                                    <td style="color: #dc2626; font-weight: 700;">${lift.monthlyRecords}</td>
                                                    <td>${lift.totalRecords}</td>
                                                    <td>${lift.repairs}</td>
                                                    <td>${lift.complaints}</td>
                                                    <td>
                                                        <div style="background: #e5e7eb; border-radius: 10px; height: 24px; position: relative; overflow: hidden;">
                                                            <div style="background: #dc2626; height: 100%; width: ${lift.healthScore}%;"></div>
                                                            <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: 700; color: white;">${lift.healthScore}%</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Moderate Issues -->
                            ${analysis.moderate.length > 0 ? `
                            <div style="background: #fffbeb; border: 2px solid #f59e0b; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                <h4 style="color: #d97706; margin: 0 0 16px 0;">‚ö° MODERATE ISSUES - MONITOR CLOSELY</h4>
                                <p style="color: #92400e; margin-bottom: 12px;">These lifts have some issues and should be monitored:</p>
                                <div class="table-container">
                                    <table class="table">
                                        <thead style="background: #fef3c7;">
                                            <tr>
                                                <th>Lift ID</th>
                                                <th>Project</th>
                                                <th>Wing</th>
                                                <th>Weekly Issues</th>
                                                <th>Monthly Issues</th>
                                                <th>Repairs</th>
                                                <th>Complaints</th>
                                                <th>Health Score</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${analysis.moderate.sort((a, b) => b.monthlyRecords - a.monthlyRecords).map(lift => `
                                                <tr>
                                                    <td><strong style="color: #d97706;">${lift.id}</strong></td>
                                                    <td>${lift.projectName || '-'}</td>
                                                    <td>${lift.wing || '-'}</td>
                                                    <td style="color: #d97706; font-weight: 600;">${lift.weeklyRecords}</td>
                                                    <td style="color: #d97706; font-weight: 600;">${lift.monthlyRecords}</td>
                                                    <td>${lift.repairs}</td>
                                                    <td>${lift.complaints}</td>
                                                    <td>
                                                        <div style="background: #e5e7eb; border-radius: 10px; height: 24px; position: relative; overflow: hidden;">
                                                            <div style="background: #f59e0b; height: 100%; width: ${lift.healthScore}%;"></div>
                                                            <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: 700;">${lift.healthScore}%</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Healthy Lifts -->
                            ${analysis.healthy.length > 0 ? `
                            <div style="background: #f0fdf4; border: 2px solid #16a34a; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                <h4 style="color: #16a34a; margin: 0 0 16px 0;">‚úÖ HEALTHY LIFTS - PROPER WORKING CONDITION</h4>
                                <p style="color: #166534; margin-bottom: 12px;">These lifts have minimal or no issues:</p>
                                <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                                    <table class="table">
                                        <thead style="background: #dcfce7; position: sticky; top: 0;">
                                            <tr>
                                                <th>Lift ID</th>
                                                <th>Project</th>
                                                <th>Wing</th>
                                                <th>Weekly Issues</th>
                                                <th>Monthly Issues</th>
                                                <th>Total Records</th>
                                                <th>Health Score</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${analysis.healthy.sort((a, b) => b.healthScore - a.healthScore).map(lift => `
                                                <tr>
                                                    <td><strong style="color: #16a34a;">${lift.id}</strong></td>
                                                    <td>${lift.projectName || '-'}</td>
                                                    <td>${lift.wing || '-'}</td>
                                                    <td style="color: #16a34a;">${lift.weeklyRecords}</td>
                                                    <td style="color: #16a34a;">${lift.monthlyRecords}</td>
                                                    <td>${lift.totalRecords}</td>
                                                    <td>
                                                        <div style="background: #e5e7eb; border-radius: 10px; height: 24px; position: relative; overflow: hidden;">
                                                            <div style="background: #16a34a; height: 100%; width: ${lift.healthScore}%;"></div>
                                                            <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: 700; color: white;">${lift.healthScore}%</span>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Project-wise Analysis -->
                            <div style="background: #f8fafc; border: 2px solid #64748b; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                                <h4 style="color: #475569; margin: 0 0 16px 0;">üè¢ PROJECT-WISE ANALYSIS</h4>
                                ${generateProjectWiseAnalysis()}
                            </div>
                            
                            <!-- Building-wise Analysis -->
                            <div style="background: #f0f9ff; border: 2px solid #0ea5e9; padding: 20px; border-radius: 12px;">
                                <h4 style="color: #0369a1; margin: 0 0 16px 0;">üèóÔ∏è BUILDING & WING ANALYSIS</h4>
                                ${generateBuildingWingAnalysis()}
                            </div>
                            
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="exportRCIAnalyticsPDF()">üì• Export Analytics PDF</button>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('rciAnalyticsModal').remove()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('rciAnalyticsModal');
            if (existingModal) existingModal.remove();
            
            // Add new modal
            document.body.insertAdjacentHTML('beforeend', analyticsHTML);
        };
        
        function generateProjectWiseAnalysis() {
            const projectStats = {};
            
            maintenance.forEach(m => {
                const projectName = m.projectName || 'Unknown';
                if (!projectStats[projectName]) {
                    projectStats[projectName] = {
                        name: projectName,
                        total: 0,
                        repairs: 0,
                        complaints: 0,
                        maintenance: 0,
                        completed: 0,
                        pending: 0,
                        elevators: new Set()
                    };
                }
                
                projectStats[projectName].total++;
                if (m.rciType === 'Repair') projectStats[projectName].repairs++;
                else if (m.rciType === 'Complaint') projectStats[projectName].complaints++;
                else projectStats[projectName].maintenance++;
                
                if (m.status === 'Completed') projectStats[projectName].completed++;
                else projectStats[projectName].pending++;
                
                const elevators = m.elevatorIds || [m.elevatorId];
                elevators.forEach(e => projectStats[projectName].elevators.add(e));
            });
            
            if (Object.keys(projectStats).length === 0) {
                return '<p style="color: #64748b;">No project data available</p>';
            }
            
            return `
                <div class="table-container">
                    <table class="table">
                        <thead style="background: #e2e8f0;">
                            <tr>
                                <th>Project</th>
                                <th>Total Records</th>
                                <th>üîß Repairs</th>
                                <th>üì¢ Complaints</th>
                                <th>üõ†Ô∏è Maintenance</th>
                                <th>Completed</th>
                                <th>Pending</th>
                                <th>Lifts Tracked</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.values(projectStats).sort((a, b) => b.total - a.total).map(proj => `
                                <tr>
                                    <td><strong>${proj.name}</strong></td>
                                    <td style="text-align: center; font-weight: 600;">${proj.total}</td>
                                    <td style="text-align: center; color: #dc2626;">${proj.repairs}</td>
                                    <td style="text-align: center; color: #d97706;">${proj.complaints}</td>
                                    <td style="text-align: center; color: #2563eb;">${proj.maintenance}</td>
                                    <td style="text-align: center; color: #16a34a;">${proj.completed}</td>
                                    <td style="text-align: center; color: #f59e0b;">${proj.pending}</td>
                                    <td style="text-align: center;">${proj.elevators.size}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        function generateBuildingWingAnalysis() {
            const wingStats = {};
            
            maintenance.forEach(m => {
                const key = `${m.projectName || 'Unknown'} - ${m.wing || 'Unknown Wing'}`;
                if (!wingStats[key]) {
                    wingStats[key] = {
                        project: m.projectName || 'Unknown',
                        wing: m.wing || 'Unknown',
                        total: 0,
                        repairs: 0,
                        complaints: 0,
                        maintenance: 0,
                        highPriority: 0
                    };
                }
                
                wingStats[key].total++;
                if (m.rciType === 'Repair') wingStats[key].repairs++;
                else if (m.rciType === 'Complaint') wingStats[key].complaints++;
                else wingStats[key].maintenance++;
                
                if (m.priority === 'High') wingStats[key].highPriority++;
            });
            
            if (Object.keys(wingStats).length === 0) {
                return '<p style="color: #64748b;">No wing data available</p>';
            }
            
            return `
                <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                    <table class="table">
                        <thead style="background: #e0f2fe; position: sticky; top: 0;">
                            <tr>
                                <th>Project</th>
                                <th>Wing/Block</th>
                                <th>Total Issues</th>
                                <th>üîß Repairs</th>
                                <th>üì¢ Complaints</th>
                                <th>üõ†Ô∏è Maintenance</th>
                                <th>High Priority</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${Object.values(wingStats).sort((a, b) => b.total - a.total).map(wing => `
                                <tr>
                                    <td>${wing.project}</td>
                                    <td><strong>${wing.wing}</strong></td>
                                    <td style="text-align: center; font-weight: 600;">${wing.total}</td>
                                    <td style="text-align: center; color: #dc2626;">${wing.repairs}</td>
                                    <td style="text-align: center; color: #d97706;">${wing.complaints}</td>
                                    <td style="text-align: center; color: #2563eb;">${wing.maintenance}</td>
                                    <td style="text-align: center; color: ${wing.highPriority > 0 ? '#dc2626' : '#64748b'}; font-weight: ${wing.highPriority > 0 ? '700' : '400'};">${wing.highPriority}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        window.exportRCIAnalyticsPDF = async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const companyInfo = await getCompanyInfo();
            
            const allMaintenance = await getDocs(collection(db, 'maintenance'));
            const maintenanceRecords = allMaintenance.docs.map(d => ({ id: d.id, ...d.data() }));
            
            const allProjects = await getDocs(collection(db, 'projects'));
            const projects = allProjects.docs.map(d => ({ id: d.id, ...d.data() }));
            
            // Header
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 50, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text(companyInfo.name || 'Avant Elevators', 105, 20, { align: 'center' });
            doc.setFontSize(16);
            doc.text('RCI & Lift Health Analytics Report', 105, 35, { align: 'center' });
            doc.setFontSize(10);
            doc.text(new Date().toLocaleDateString('en-GB'), 105, 43, { align: 'center' });
            
            let y = 65;
            doc.setTextColor(0, 0, 0);
            
            // Overall Statistics
            doc.setFontSize(14);
            doc.setTextColor(37, 99, 235);
            doc.text('Overall RCI Statistics', 20, y);
            y += 10;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            const totalLifts = maintenanceRecords.length;
            const completedMaintenance = maintenanceRecords.filter(m => m.status === 'Completed').length;
            const pendingMaintenance = maintenanceRecords.filter(m => m.status === 'Pending').length;
            const inProgressMaintenance = maintenanceRecords.filter(m => m.status === 'In Progress').length;
            const onHoldMaintenance = maintenanceRecords.filter(m => m.status === 'On Hold').length;
            
            doc.text(`Total Maintenance Records: ${totalLifts}`, 30, y);
            y += 7;
            doc.text(`Completed: ${completedMaintenance} (${((completedMaintenance/totalLifts)*100 || 0).toFixed(1)}%)`, 30, y);
            y += 7;
            doc.text(`In Progress: ${inProgressMaintenance}`, 30, y);
            y += 7;
            doc.text(`Pending: ${pendingMaintenance}`, 30, y);
            y += 7;
            doc.text(`On Hold: ${onHoldMaintenance}`, 30, y);
            y += 15;
            
            // Lift Health Status
            doc.setFontSize(12);
            doc.setTextColor(37, 99, 235);
            doc.text('Lift Health Analysis', 20, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            // Calculate defaulted lifts (maintenance overdue or frequent issues)
            const now = new Date();
            const defaultedLifts = maintenanceRecords.filter(m => {
                if (m.status === 'On Hold') return true;
                if (m.status === 'Pending') {
                    const createdDate = new Date(m.createdAt);
                    const daysPending = Math.ceil((now - createdDate) / (1000 * 60 * 60 * 24));
                    return daysPending > 7; // Pending more than 7 days
                }
                return false;
            });
            
            doc.text(`Healthy Lifts: ${totalLifts - defaultedLifts.length}`, 30, y);
            doc.setTextColor(220, 38, 38);
            doc.text(`Defaulted/Critical Lifts: ${defaultedLifts.length}`, 30, y + 7);
            doc.setTextColor(0, 0, 0);
            y += 20;
            
            // Project-wise Analysis
            doc.setFontSize(12);
            doc.setTextColor(37, 99, 235);
            doc.text('Project-wise Maintenance Summary', 20, y);
            y += 8;
            
            doc.setFontSize(9);
            doc.setTextColor(0, 0, 0);
            
            // Group maintenance by project
            const projectMap = new Map();
            maintenanceRecords.forEach(m => {
                const projectName = m.projectName || 'Unknown';
                if (!projectMap.has(projectName)) {
                    projectMap.set(projectName, {
                        total: 0,
                        completed: 0,
                        pending: 0,
                        inProgress: 0
                    });
                }
                const stats = projectMap.get(projectName);
                stats.total++;
                if (m.status === 'Completed') stats.completed++;
                if (m.status === 'Pending') stats.pending++;
                if (m.status === 'In Progress') stats.inProgress++;
            });
            
            // Display top projects
            const sortedProjects = Array.from(projectMap.entries())
                .sort((a, b) => b[1].total - a[1].total)
                .slice(0, 10);
            
            sortedProjects.forEach(([projectName, stats]) => {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(`${projectName}:`, 30, y);
                doc.text(`Total: ${stats.total} | Completed: ${stats.completed} | Pending: ${stats.pending}`, 32, y + 5);
                y += 12;
            });
            
            // Add new page for defaulted lifts details
            if (defaultedLifts.length > 0) {
                doc.addPage();
                y = 20;
                
                doc.setFontSize(14);
                doc.setTextColor(220, 38, 38);
                doc.text('‚ö†Ô∏è Critical/Defaulted Lifts Details', 20, y);
                y += 10;
                
                doc.setFontSize(9);
                doc.setTextColor(0, 0, 0);
                
                defaultedLifts.slice(0, 15).forEach((lift, index) => {
                    if (y > 260) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${lift.projectName || 'Unknown'}`, 25, y);
                    doc.setFont(undefined, 'normal');
                    y += 5;
                    doc.text(`Issue: ${(lift.issueDescription || '').substring(0, 80)}`, 30, y);
                    y += 5;
                    doc.text(`Status: ${lift.status} | Date: ${new Date(lift.createdAt).toLocaleDateString('en-GB')}`, 30, y);
                    y += 10;
                });
            }
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
            doc.text('RCI & Lift Health Analytics - Confidential Report', 105, 290, { align: 'center' });
            
            doc.save(`RCI_Analytics_Report_${new Date().toISOString().split('T')[0]}.pdf`);
            alert('‚úÖ RCI Analytics report exported successfully!');
        };


        // ==================== AMC FUNCTIONS ====================

        // AMC Contract Management Functions
        window.showAddAMCModal = () => {
            document.getElementById('amcModalTitle').textContent = 'Add AMC Contract';
            document.getElementById('amcForm').reset();
            document.getElementById('editAmcId').value = '';
            
            // Populate projects dropdown
            loadAmcProjects();
            
            // Populate technicians dropdown
            const technicianSelect = document.getElementById('amcAssignedTechnician');
            technicianSelect.innerHTML = '<option value="">Select Technician</option>' + 
                employees.filter(emp => {
                    const role = (emp.systemRole || emp.role || '').toLowerCase();
                    const status = (emp.systemStatus || emp.status || '').toLowerCase();
                    return (role === 'technician' || role === 'user' || role === 'admin') && status === 'active';
                })
                .map(emp => `<option value="${emp.username}">${emp.firstName} ${emp.lastName} (${emp.position})</option>`).join('');
            
            document.getElementById('amcModal').classList.add('active');
        };

        window.editAMC = (id) => {
            const contract = amc.find(c => c.id === id);
            if (!contract) {
                alert('Contract not found');
                return;
            }
            
            document.getElementById('amcModalTitle').textContent = 'Edit AMC Contract';
            document.getElementById('editAmcId').value = contract.id;
            document.getElementById('amcProject').value = contract.projectId || '';
            document.getElementById('amcContractType').value = contract.contractType || '';
            document.getElementById('amcStartDate').value = contract.startDate || '';
            document.getElementById('amcDuration').value = contract.duration || '';
            document.getElementById('amcEndDate').value = contract.endDate || '';
            document.getElementById('amcAmount').value = contract.amount || '';
            document.getElementById('amcPaymentMode').value = contract.paymentMode || '';
            document.getElementById('freeMaintenanceMonths').value = contract.freeMaintenanceMonths || 0;
            document.getElementById('freeMaintenanceStartDate').value = contract.freeMaintenanceStartDate || '';
            document.getElementById('freeMaintenanceEndDate').value = contract.freeMaintenanceEndDate || '';
            document.getElementById('amcNotes').value = contract.notes || '';
            
            toggleInstallmentSection();
            loadAmcProjects();
            
            // Load sub-apartments, wings, and elevators if they exist
            if (contract.projectId) {
                loadSubApartments('amc');
                if (contract.subApartment) {
                    setTimeout(() => {
                        document.getElementById('amcSubApartment').value = contract.subApartment;
                        loadWings('amc');
                    }, 100);
                }
                if (contract.wing) {
                    setTimeout(() => {
                        document.getElementById('amcWing').value = contract.wing;
                        loadElevatorsByWing('amc');
                        
                        // Set selected elevators
                        if (contract.elevators && contract.elevators.length > 0) {
                            setTimeout(() => {
                                const elevatorSelect = document.getElementById('amcElevator');
                                contract.elevators.forEach(elevatorValue => {
                                    const option = Array.from(elevatorSelect.options).find(opt => opt.value === elevatorValue);
                                    if (option) option.selected = true;
                                });
                            }, 200);
                        }
                    }, 150);
                }
            }
            
            document.getElementById('amcModal').classList.add('active');
        };

        window.deleteAMC = async (id) => {
            if (!confirm('Are you sure you want to delete this AMC contract?')) return;
            
            try {
                if (isOnline) {
                    await deleteDoc(doc(db, 'amc', id));
                    await addDoc(collection(db, 'activities'), {
                        date: new Date().toISOString(),
                        action: `Deleted AMC contract: ${amc.find(c => c.id === id)?.projectName || 'Unknown'}`,
                        user: currentUser.username
                    });
                }
                await loadAMC();
                alert('AMC contract deleted successfully!');
            } catch (error) {
                console.error('Error deleting AMC contract:', error);
                alert('Error deleting AMC contract: ' + error.message);
            }
        };

        function loadAmcProjects() {
            const select = document.getElementById('amcProject');
            select.innerHTML = '<option value="">Select Project</option>';
            
            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                select.appendChild(option);
            });
        }

        window.loadAmcElevators = () => {
            // This function can be used if needed for specific elevator selection
            console.log('Loading elevators for AMC project...');
        };

        window.calculateAmcEndDate = () => {
            const startDate = document.getElementById('amcStartDate').value;
            const duration = document.getElementById('amcDuration').value;
            
            if (startDate && duration) {
                const start = new Date(startDate);
                const end = new Date(start);
                end.setFullYear(end.getFullYear() + parseInt(duration));
                document.getElementById('amcEndDate').value = end.toISOString().split('T')[0];
                
                // Also calculate free maintenance end date if applicable
                const freeMonths = parseInt(document.getElementById('freeMaintenanceMonths').value) || 0;
                const freeStartDate = document.getElementById('freeMaintenanceStartDate').value;
                
                if (freeMonths > 0 && freeStartDate) {
                    const freeStart = new Date(freeStartDate);
                    const freeEnd = new Date(freeStart);
                    freeEnd.setMonth(freeEnd.getMonth() + freeMonths);
                    document.getElementById('freeMaintenanceEndDate').value = freeEnd.toISOString().split('T')[0];
                }
            }
        };

        window.calculateInstallments = () => {
            const amount = parseFloat(document.getElementById('amcAmount').value) || 0;
            const paymentMode = document.getElementById('amcPaymentMode').value;
            
            if (amount > 0 && paymentMode) {
                toggleInstallmentSection();
                generatePaymentSchedule();
            }
        };

        window.toggleInstallmentSection = () => {
            const paymentMode = document.getElementById('amcPaymentMode').value;
            const section = document.getElementById('installmentSection');
            
            if (paymentMode && paymentMode !== '') {
                section.style.display = 'block';
                generatePaymentSchedule();
            } else {
                section.style.display = 'none';
            }
        };

        function generatePaymentSchedule() {
            const amount = parseFloat(document.getElementById('amcAmount').value) || 0;
            const paymentMode = document.getElementById('amcPaymentMode').value;
            const startDate = document.getElementById('amcStartDate').value;
            
            if (!amount || !paymentMode || !startDate) return;
            
            let installments = [];
            let installmentAmount = 0;
            let frequency = 0; // months
            
            switch (paymentMode) {
                case 'Annual':
                    installmentAmount = amount;
                    frequency = 12;
                    break;
                case 'Half-Yearly':
                    installmentAmount = amount / 2;
                    frequency = 6;
                    break;
                case 'Quarterly':
                    installmentAmount = amount / 4;
                    frequency = 3;
                    break;
                case 'Monthly':
                    installmentAmount = amount / 12;
                    frequency = 1;
                    break;
            }
            
            const duration = parseInt(document.getElementById('amcDuration').value) || 1;
            const numberOfInstallments = Math.ceil((duration * 12) / frequency);
            
            const start = new Date(startDate);
            
            for (let i = 0; i < numberOfInstallments; i++) {
                const dueDate = new Date(start);
                dueDate.setMonth(dueDate.getMonth() + (i * frequency));
                
                installments.push({
                    installmentNumber: i + 1,
                    amount: installmentAmount,
                    dueDate: dueDate,
                    status: 'Pending'
                });
            }
            
            const installmentList = document.getElementById('installmentList');
            installmentList.innerHTML = `
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Installment #</th>
                                <th>Due Date</th>
                                <th>Amount</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${installments.map(inst => `
                                <tr>
                                    <td>${inst.installmentNumber}</td>
                                    <td>${inst.dueDate.toLocaleDateString()}</td>
                                    <td>Rs. ${inst.amount.toLocaleString()}</td>
                                    <td><span class="badge badge-warning">${inst.status}</span></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // AMC Form Submission
        document.getElementById('amcForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const contractId = document.getElementById('editAmcId').value;
            const projectId = document.getElementById('amcProject').value;
            const projectName = projects.find(p => p.id === projectId)?.name || '';
            const subApartment = document.getElementById('amcSubApartment')?.value || '';
            const wing = document.getElementById('amcWing').value;
            
            // Get selected elevators
            const elevatorSelect = document.getElementById('amcElevator');
            const selectedElevators = Array.from(elevatorSelect.selectedOptions).map(option => option.value);
            const elevatorTexts = Array.from(elevatorSelect.selectedOptions).map(option => option.textContent);
            
            try {
                const contractData = {
                    projectId,
                    projectName,
                    subApartment,
                    wing,
                    elevators: selectedElevators,
                    elevatorTexts: elevatorTexts,
                    elevatorCount: selectedElevators.length,
                    contractType: document.getElementById('amcContractType').value,
                    startDate: document.getElementById('amcStartDate').value,
                    endDate: document.getElementById('amcEndDate').value,
                    duration: parseInt(document.getElementById('amcDuration').value),
                    amount: parseFloat(document.getElementById('amcAmount').value),
                    paymentMode: document.getElementById('amcPaymentMode').value,
                    maintenanceFrequency: document.getElementById('amcMaintenanceFrequency').value,
                    assignedTechnician: document.getElementById('amcAssignedTechnician').value || 'Unassigned',
                    freeMaintenanceMonths: parseInt(document.getElementById('freeMaintenanceMonths').value) || 0,
                    freeMaintenanceStartDate: document.getElementById('freeMaintenanceStartDate').value,
                    freeMaintenanceEndDate: document.getElementById('freeMaintenanceEndDate').value,
                    notes: document.getElementById('amcNotes').value,
                    status: 'Active',
                    lastServiceDate: null,
                    createdDate: new Date().toISOString(),
                    createdBy: currentUser.username
                };

                // Calculate next payment due date
                const startDate = new Date(contractData.startDate);
                let nextPaymentDue = new Date(startDate);
                
                switch (contractData.paymentMode) {
                    case 'Monthly':
                        nextPaymentDue.setMonth(nextPaymentDue.getMonth() + 1);
                        break;
                    case 'Quarterly':
                        nextPaymentDue.setMonth(nextPaymentDue.getMonth() + 3);
                        break;
                    case 'Half-Yearly':
                        nextPaymentDue.setMonth(nextPaymentDue.getMonth() + 6);
                        break;
                    case 'Annual':
                        nextPaymentDue.setFullYear(nextPaymentDue.getFullYear() + 1);
                        break;
                }
                
                contractData.nextPaymentDue = nextPaymentDue.toISOString().split('T')[0];

                if (isOnline) {
                    if (contractId) {
                        await updateDoc(doc(db, 'amc', contractId), contractData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Updated AMC contract: ${projectName}`,
                            user: currentUser.username
                        });
                    } else {
                        await addDoc(collection(db, 'amc'), contractData);
                        await addDoc(collection(db, 'activities'), {
                            date: new Date().toISOString(),
                            action: `Added new AMC contract: ${projectName}`,
                            user: currentUser.username
                        });
                    }
                }

                closeModal('amcModal');
                await loadAMC();
                alert(contractId ? 'AMC contract updated successfully!' : 'AMC contract added successfully!');
            } catch (error) {
                console.error('Error saving AMC contract:', error);
                alert('Error saving AMC contract: ' + error.message);
            }
        });

        // AMC Renewals and Alerts
        function checkAMCRenewals() {
            const currentDate = new Date();
            const alertsContainer = document.getElementById('amcAlerts');
            if (!alertsContainer) return;

            const currentMonthRenewals = amc.filter(contract => {
                const endDate = new Date(contract.endDate);
                return endDate.getMonth() === currentDate.getMonth() && 
                       endDate.getFullYear() === currentDate.getFullYear();
            });

            const nextMonthRenewals = amc.filter(contract => {
                const endDate = new Date(contract.endDate);
                const nextMonth = new Date(currentDate);
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                return endDate.getMonth() === nextMonth.getMonth() && 
                       endDate.getFullYear() === nextMonth.getFullYear();
            });

            const expiredContracts = amc.filter(contract => {
                const endDate = new Date(contract.endDate);
                return endDate < currentDate && contract.status !== 'Terminated';
            });

            let alertsHTML = '';

            if (expiredContracts.length > 0) {
                alertsHTML += `
                    <div class="alert alert-danger">
                        <strong>üö® Expired Contracts:</strong> ${expiredContracts.length} AMC contract(s) have expired and need immediate attention.
                        <button class="btn btn-sm btn-outline-danger ml-2" onclick="showExpiredContracts()">View Details</button>
                    </div>
                `;
            }

            if (currentMonthRenewals.length > 0) {
                alertsHTML += `
                    <div class="alert alert-warning">
                        <strong>üìÖ Current Month Renewals:</strong> ${currentMonthRenewals.length} contract(s) expiring this month.
                        <button class="btn btn-sm btn-outline-warning ml-2" onclick="showCurrentMonthRenewals()">View Details</button>
                    </div>
                `;
            }

            if (nextMonthRenewals.length > 0) {
                alertsHTML += `
                    <div class="alert alert-info">
                        <strong>üìã Next Month Renewals:</strong> ${nextMonthRenewals.length} contract(s) expiring next month.
                        <button class="btn btn-sm btn-outline-info ml-2" onclick="showNextMonthRenewals()">View Details</button>
                    </div>
                `;
            }

            alertsContainer.innerHTML = alertsHTML;
        }

        window.showRenewalsReport = () => {
            updateRenewalReport();
            document.getElementById('renewalsModal').classList.add('active');
        };

        window.updateRenewalReport = () => {
            const reportType = document.getElementById('renewalReportType').value;
            const tbody = document.getElementById('renewalsList');
            const currentDate = new Date();

            let filteredContracts = [];

            switch (reportType) {
                case 'current_month':
                    filteredContracts = amc.filter(contract => {
                        const endDate = new Date(contract.endDate);
                        return endDate.getMonth() === currentDate.getMonth() && 
                               endDate.getFullYear() === currentDate.getFullYear();
                    });
                    break;
                case 'next_month':
                    const nextMonth = new Date(currentDate);
                    nextMonth.setMonth(nextMonth.getMonth() + 1);
                    filteredContracts = amc.filter(contract => {
                        const endDate = new Date(contract.endDate);
                        return endDate.getMonth() === nextMonth.getMonth() && 
                               endDate.getFullYear() === nextMonth.getFullYear();
                    });
                    break;
                case 'next_3_months':
                    const threeMonthsLater = new Date(currentDate);
                    threeMonthsLater.setMonth(threeMonthsLater.getMonth() + 3);
                    filteredContracts = amc.filter(contract => {
                        const endDate = new Date(contract.endDate);
                        return endDate <= threeMonthsLater && endDate >= currentDate;
                    });
                    break;
                case 'expired':
                    filteredContracts = amc.filter(contract => {
                        const endDate = new Date(contract.endDate);
                        return endDate < currentDate && contract.status !== 'Terminated';
                    });
                    break;
            }

            if (filteredContracts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No contracts found for this category.</td></tr>';
                return;
            }

            tbody.innerHTML = filteredContracts.map(contract => {
                const endDate = new Date(contract.endDate);
                const daysRemaining = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
                const project = projects.find(p => p.id === contract.projectId);
                
                return `
                    <tr>
                        <td><strong>${contract.projectName}</strong></td>
                        <td>${contract.contractType}</td>
                        <td>${endDate.toLocaleDateString()}</td>
                        <td class="${daysRemaining < 0 ? 'text-danger' : daysRemaining <= 30 ? 'text-warning' : ''}">${daysRemaining < 0 ? 'Expired' : `${daysRemaining} days`}</td>
                        <td>Rs. ${(contract.amount || 0).toLocaleString()}</td>
                        <td>
                            ${project ? `${project.clientName || 'N/A'}<br><small>${project.clientPhone || ''}</small>` : 'N/A'}
                        </td>
                        <td>
                            <span class="badge badge-${daysRemaining < 0 ? 'danger' : daysRemaining <= 30 ? 'warning' : 'success'}">
                                ${daysRemaining < 0 ? 'Expired' : daysRemaining <= 30 ? 'Expiring Soon' : 'Active'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="renewContract('${contract.id}')">Renew</button>
                        </td>
                    </tr>
                `;
            }).join('');
        };

        window.renewContract = (contractId) => {
            const contract = amc.find(c => c.id === contractId);
            if (!contract) return;
            
            // Pre-fill form with existing contract data for renewal
            document.getElementById('amcModalTitle').textContent = 'Renew AMC Contract';
            document.getElementById('amcForm').reset();
            document.getElementById('editAmcId').value = ''; // New contract
            document.getElementById('amcProject').value = contract.projectId;
            document.getElementById('amcContractType').value = contract.contractType;
            document.getElementById('amcStartDate').value = contract.endDate; // Start from previous end date
            document.getElementById('amcDuration').value = contract.duration;
            document.getElementById('amcAmount').value = contract.amount;
            document.getElementById('amcPaymentMode').value = contract.paymentMode;
            document.getElementById('amcNotes').value = `Renewed from contract ending ${new Date(contract.endDate).toLocaleDateString()}`;
            
            calculateAmcEndDate();
            toggleInstallmentSection();
            loadAmcProjects();
            closeModal('renewalsModal');
            document.getElementById('amcModal').classList.add('active');
        };

        window.managePayments = async (contractId) => {
            const contract = amc.find(c => c.id === contractId);
            if (!contract) return;
            
            // Create payment management modal
            const existingModal = document.getElementById('paymentManagementModal');
            if (existingModal) existingModal.remove();
            
            const modal = document.createElement('div');
            modal.id = 'paymentManagementModal';
            modal.className = 'modal active';
            modal.style.zIndex = '10002';
            
            // Get payment history from contract
            const paymentHistory = contract.paymentHistory || [];
            const totalPaid = paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const balance = parseFloat(contract.amount || 0) - totalPaid;
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>üí∞ Payment Management - ${contract.projectName}</h3>
                        <button class="modal-close" onclick="document.getElementById('paymentManagementModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="max-height: 600px; overflow-y: auto;">
                        
                        <!-- Contract Summary -->
                        <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div>
                                    <div style="color: #64748b; font-size: 12px; margin-bottom: 4px;">Contract Number</div>
                                    <div style="font-weight: 600; font-size: 14px;">${contract.contractNumber || 'N/A'}</div>
                                </div>
                                <div>
                                    <div style="color: #64748b; font-size: 12px; margin-bottom: 4px;">Client Name</div>
                                    <div style="font-weight: 600; font-size: 14px;">${contract.clientName}</div>
                                </div>
                                <div>
                                    <div style="color: #64748b; font-size: 12px; margin-bottom: 4px;">Total Contract Value</div>
                                    <div style="font-weight: 600; font-size: 16px; color: #2563eb;">Rs. ${parseFloat(contract.amount || 0).toLocaleString()}</div>
                                </div>
                                <div>
                                    <div style="color: #64748b; font-size: 12px; margin-bottom: 4px;">Amount Paid</div>
                                    <div style="font-weight: 600; font-size: 16px; color: #16a34a;">Rs. ${totalPaid.toLocaleString()}</div>
                                </div>
                                <div>
                                    <div style="color: #64748b; font-size: 12px; margin-bottom: 4px;">Balance Due</div>
                                    <div style="font-weight: 600; font-size: 16px; color: ${balance > 0 ? '#dc2626' : '#16a34a'};">Rs. ${balance.toLocaleString()}</div>
                                </div>
                                <div>
                                    <div style="color: #64748b; font-size: 12px; margin-bottom: 4px;">Payment Status</div>
                                    <div style="font-weight: 600; font-size: 14px; color: ${balance === 0 ? '#16a34a' : (totalPaid > 0 ? '#ea580c' : '#dc2626')};">
                                        ${balance === 0 ? '‚úì Fully Paid' : (totalPaid > 0 ? '‚è≥ Partial Payment' : '‚ö†Ô∏è Pending')}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Add New Payment -->
                        <div style="background: white; border: 2px solid #e2e8f0; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-bottom: 15px; color: #2563eb;">‚ûï Add New Payment</h4>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                                <div class="form-group">
                                    <label>Payment Amount *</label>
                                    <input type="number" id="newPaymentAmount" class="form-control" placeholder="Enter amount" min="0" step="0.01" max="${balance}">
                                </div>
                                <div class="form-group">
                                    <label>Payment Date *</label>
                                    <input type="date" id="newPaymentDate" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="form-group">
                                    <label>Payment Mode *</label>
                                    <select id="newPaymentMode" class="form-control">
                                        <option value="Cash">Cash</option>
                                        <option value="Cheque">Cheque</option>
                                        <option value="Online Transfer">Online Transfer</option>
                                        <option value="UPI">UPI</option>
                                        <option value="Credit Card">Credit Card</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Reference Number</label>
                                    <input type="text" id="newPaymentReference" class="form-control" placeholder="Cheque/Transaction ID">
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label>Payment Notes</label>
                                    <textarea id="newPaymentNotes" class="form-control" rows="2" placeholder="Any additional notes about this payment"></textarea>
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="recordAMCPayment('${contractId}')" style="margin-top: 10px;">
                                üíæ Record Payment
                            </button>
                        </div>
                        
                        <!-- Payment History -->
                        <div>
                            <h4 style="margin-bottom: 15px;">üìã Payment History</h4>
                            ${paymentHistory.length === 0 ? `
                                <div style="text-align: center; padding: 40px; color: #64748b; background: #f8fafc; border-radius: 8px;">
                                    <p style="font-size: 16px; margin-bottom: 8px;">üí≥ No payments recorded yet</p>
                                    <p style="font-size: 14px;">Add a payment above to start tracking</p>
                                </div>
                            ` : `
                                <div style="overflow-x: auto;">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Amount</th>
                                                <th>Mode</th>
                                                <th>Reference</th>
                                                <th>Notes</th>
                                                <th>Recorded By</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${paymentHistory.map(payment => `
                                                <tr>
                                                    <td>${new Date(payment.date).toLocaleDateString('en-GB')}</td>
                                                    <td style="font-weight: 600; color: #16a34a;">Rs. ${parseFloat(payment.amount).toLocaleString()}</td>
                                                    <td>${payment.mode}</td>
                                                    <td>${payment.reference || '-'}</td>
                                                    <td>${payment.notes || '-'}</td>
                                                    <td>${payment.recordedBy || 'System'}</td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            `}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="document.getElementById('paymentManagementModal').remove()">Close</button>
                        ${paymentHistory.length > 0 ? `<button class="btn btn-primary" onclick="exportPaymentHistory('${contractId}')">üì• Export Payment History</button>` : ''}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        };
        
        // Record AMC Payment
        window.recordAMCPayment = async (contractId) => {
            const amount = parseFloat(document.getElementById('newPaymentAmount').value);
            const date = document.getElementById('newPaymentDate').value;
            const mode = document.getElementById('newPaymentMode').value;
            const reference = document.getElementById('newPaymentReference').value;
            const notes = document.getElementById('newPaymentNotes').value;
            
            if (!amount || amount <= 0) {
                alert('‚ö†Ô∏è Please enter a valid payment amount!');
                return;
            }
            
            if (!date) {
                alert('‚ö†Ô∏è Please select payment date!');
                return;
            }
            
            const contract = amc.find(c => c.id === contractId);
            if (!contract) return;
            
            const paymentHistory = contract.paymentHistory || [];
            const totalPaid = paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const balance = parseFloat(contract.amount || 0) - totalPaid;
            
            if (amount > balance) {
                alert(`‚ö†Ô∏è Payment amount (Rs. ${amount.toLocaleString()}) exceeds balance due (Rs. ${balance.toLocaleString()})!`);
                return;
            }
            
            const newPayment = {
                amount: amount,
                date: date,
                mode: mode,
                reference: reference || '',
                notes: notes || '',
                recordedBy: currentUser?.username || 'admin',
                recordedAt: new Date().toISOString()
            };
            
            paymentHistory.push(newPayment);
            
            try {
                const contractRef = doc(db, 'amc', contractId);
                await updateDoc(contractRef, {
                    paymentHistory: paymentHistory,
                    lastPaymentDate: date,
                    totalPaid: totalPaid + amount,
                    paymentStatus: (totalPaid + amount) >= parseFloat(contract.amount) ? 'Paid' : 'Partial'
                });
                
                alert('‚úÖ Payment recorded successfully!');
                await loadAMCContracts();
                document.getElementById('paymentManagementModal').remove();
                managePayments(contractId); // Refresh the modal
            } catch (error) {
                console.error('Error recording payment:', error);
                alert('‚ùå Error recording payment. Please try again.');
            }
        };
        
        // Export Payment History
        window.exportPaymentHistory = async (contractId) => {
            const contract = amc.find(c => c.id === contractId);
            if (!contract) return;
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const companyInfo = await getCompanyInfo();
            
            // Header
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 45, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.text(companyInfo.name || 'Avant Elevators', 105, 15, { align: 'center' });
            doc.setFontSize(16);
            doc.text('Payment History Report', 105, 30, { align: 'center' });
            doc.setFontSize(10);
            doc.text(new Date().toLocaleDateString('en-GB'), 105, 38, { align: 'center' });
            
            let y = 60;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            
            doc.text(`Contract: ${contract.contractNumber || 'N/A'}`, 20, y);
            y += 7;
            doc.text(`Client: ${contract.clientName}`, 20, y);
            y += 7;
            doc.text(`Project: ${contract.projectName}`, 20, y);
            y += 15;
            
            const paymentHistory = contract.paymentHistory || [];
            const totalPaid = paymentHistory.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            
            doc.setFontSize(10);
            doc.text(`Contract Value: Rs. ${parseFloat(contract.amount || 0).toLocaleString()}`, 20, y);
            y += 7;
            doc.text(`Total Paid: Rs. ${totalPaid.toLocaleString()}`, 20, y);
            y += 7;
            doc.text(`Balance: Rs. ${(parseFloat(contract.amount || 0) - totalPaid).toLocaleString()}`, 20, y);
            y += 15;
            
            // Payment table header
            doc.setFillColor(37, 99, 235);
            doc.rect(20, y, 170, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.text('Date', 22, y + 5);
            doc.text('Amount', 55, y + 5);
            doc.text('Mode', 95, y + 5);
            doc.text('Reference', 130, y + 5);
            
            y += 8;
            doc.setTextColor(0, 0, 0);
            
            paymentHistory.forEach(payment => {
                if (y > 260) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(new Date(payment.date).toLocaleDateString('en-GB'), 22, y + 4);
                doc.text(`Rs. ${parseFloat(payment.amount).toLocaleString()}`, 55, y + 4);
                doc.text(payment.mode, 95, y + 4);
                doc.text(payment.reference || '-', 130, y + 4);
                y += 7;
            });
            
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text('Payment History - Confidential Document', 105, 285, { align: 'center' });
            
            doc.save(`Payment_History_${contract.contractNumber || contractId}.pdf`);
        };


        window.filterAMC = () => {
            const searchValue = document.getElementById('searchAMC').value.toLowerCase();
            const statusValue = document.getElementById('amcStatusFilter').value;
            const typeValue = document.getElementById('amcTypeFilter').value;
            const paymentValue = document.getElementById('amcPaymentFilter').value;
            
            const rows = document.querySelectorAll('#amcList tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const matchesSearch = searchValue === '' || text.includes(searchValue);
                const matchesStatus = statusValue === '' || text.includes(statusValue.toLowerCase());
                const matchesType = typeValue === '' || text.includes(typeValue.toLowerCase());
                const matchesPayment = paymentValue === '' || text.includes(paymentValue.toLowerCase());
                
                row.style.display = (matchesSearch && matchesStatus && matchesType && matchesPayment) ? '' : 'none';
            });
        };

        window.exportAMCPDF = async () => {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                
                // Add company header
                let yPos = await addCompanyHeaderToPDF(doc, 'AMC Contracts Report', 10);
                yPos += 5;
                
                // Report metadata
                doc.setFontSize(10);
                doc.setTextColor(15, 23, 42);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 15, yPos);
                doc.text(`By: ${currentUser.fullName || currentUser.username}`, 150, yPos);
                doc.text(`Total Contracts: ${amc.length}`, 240, yPos);
                yPos += 8;
                
                // Summary stats
                const active = amc.filter(a => a.status === 'Active').length;
                const expired = amc.filter(a => {
                    const endDate = new Date(a.endDate);
                    return endDate < new Date() && a.status !== 'Terminated';
                }).length;
                const terminated = amc.filter(a => a.status === 'Terminated').length;
                const totalValue = amc.reduce((sum, a) => sum + (Number(a.amount) || 0), 0);
                
                const stats = [
                    { label: 'Active', value: active, color: [22, 163, 74] },
                    { label: 'Expired', value: expired, color: [220, 38, 38] },
                    { label: 'Terminated', value: terminated, color: [100, 116, 139] },
                    { label: 'Total Value', value: `‚Çπ${(totalValue / 100000).toFixed(1)}L`, color: [37, 99, 235] }
                ];
                
                let xPos = 15;
                stats.forEach(stat => {
                    doc.setDrawColor(226, 232, 240);
                    doc.rect(xPos, yPos, 65, 15);
                    
                    doc.setFontSize(9);
                    doc.setTextColor(100, 116, 139);
                    doc.text(stat.label, xPos + 2, yPos + 5);
                    
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(...stat.color);
                    doc.text(String(stat.value), xPos + 2, yPos + 12);
                    
                    xPos += 68;
                    doc.setFont(undefined, 'normal');
                });
                
                yPos += 20;
                
                // Table headers
                doc.setFillColor(248, 250, 252);
                doc.rect(15, yPos - 5, 267, 8, 'F');
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(15, 23, 42);
                
                const headers = [
                    { label: '#', x: 17 },
                    { label: 'Project', x: 28 },
                    { label: 'Type', x: 85 },
                    { label: 'Start Date', x: 125 },
                    { label: 'End Date', x: 165 },
                    { label: 'Amount', x: 205 },
                    { label: 'Payment', x: 235 },
                    { label: 'Status', x: 265 }
                ];
                
                headers.forEach(h => {
                    doc.text(h.label, h.x, yPos);
                });
                
                yPos += 5;
                doc.setDrawColor(226, 232, 240);
                doc.line(15, yPos, 282, yPos);
                yPos += 5;
                
                // Table data
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                
                if (amc.length === 0) {
                    doc.setTextColor(100, 116, 139);
                    doc.text('No AMC contracts available', 148.5, yPos + 10, { align: 'center' });
                } else {
                    amc.forEach((contract, index) => {
                        if (yPos > 190) {
                            doc.addPage();
                            yPos = 20;
                            
                            // Repeat headers
                            doc.setFillColor(248, 250, 252);
                            doc.rect(15, yPos - 5, 267, 8, 'F');
                            doc.setFont(undefined, 'bold');
                            headers.forEach(h => {
                                doc.text(h.label, h.x, yPos);
                            });
                            yPos += 5;
                            doc.line(15, yPos, 282, yPos);
                            yPos += 5;
                            doc.setFont(undefined, 'normal');
                        }
                        
                        // Alternating row background
                        if (index % 2 === 0) {
                            doc.setFillColor(249, 250, 251);
                            doc.rect(15, yPos - 4, 267, 7, 'F');
                        }
                        
                        doc.setTextColor(15, 23, 42);
                        
                        doc.text(String(index + 1), 17, yPos);
                        doc.text((contract.projectName || 'N/A').substring(0, 30), 28, yPos);
                        doc.text((contract.contractType || 'N/A').substring(0, 20), 85, yPos);
                        doc.text(contract.startDate ? new Date(contract.startDate).toLocaleDateString() : 'N/A', 125, yPos);
                        doc.text(contract.endDate ? new Date(contract.endDate).toLocaleDateString() : 'N/A', 165, yPos);
                        doc.text(`‚Çπ${(Number(contract.amount) || 0).toLocaleString()}`, 205, yPos);
                        doc.text((contract.paymentMode || 'N/A').substring(0, 15), 235, yPos);
                        
                        // Status with color
                        const statusColor = contract.status === 'Active' ? [22, 163, 74] :
                                          contract.status === 'Terminated' ? [100, 116, 139] : [220, 38, 38];
                        doc.setTextColor(...statusColor);
                        doc.text(contract.status || 'Active', 265, yPos);
                        
                        yPos += 7;
                    });
                }
                
                // Add footer to all pages
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    await addCompanyFooterToPDF(doc, 210);
                }
                
                doc.save(`AMC_Contracts_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error generating AMC PDF:', error);
                alert('Error generating AMC PDF: ' + error.message);
            }
        };

        window.exportRenewalsReport = () => {
            const reportType = document.getElementById('renewalReportType').value;
            const reportTitle = document.getElementById('renewalReportType').selectedOptions[0].text;
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'pt', 'a4');
                
                doc.setFontSize(16);
                doc.text(`AMC ${reportTitle}`, 40, 40);
                
                doc.setFontSize(10);
                doc.text(`Generated: ${new Date().toLocaleDateString()}`, 40, 60);
                
                // Get filtered data based on report type
                const currentDate = new Date();
                let filteredContracts = [];
                
                switch (reportType) {
                    case 'current_month':
                        filteredContracts = amc.filter(contract => {
                            const endDate = new Date(contract.endDate);
                            return endDate.getMonth() === currentDate.getMonth() && 
                                   endDate.getFullYear() === currentDate.getFullYear();
                        });
                        break;
                    case 'next_month':
                        const nextMonth = new Date(currentDate);
                        nextMonth.setMonth(nextMonth.getMonth() + 1);
                        filteredContracts = amc.filter(contract => {
                            const endDate = new Date(contract.endDate);
                            return endDate.getMonth() === nextMonth.getMonth() && 
                                   endDate.getFullYear() === nextMonth.getFullYear();
                        });
                        break;
                    case 'next_3_months':
                        const threeMonthsLater = new Date(currentDate);
                        threeMonthsLater.setMonth(threeMonthsLater.getMonth() + 3);
                        filteredContracts = amc.filter(contract => {
                            const endDate = new Date(contract.endDate);
                            return endDate <= threeMonthsLater && endDate >= currentDate;
                        });
                        break;
                    case 'expired':
                        filteredContracts = amc.filter(contract => {
                            const endDate = new Date(contract.endDate);
                            return endDate < currentDate && contract.status !== 'Terminated';
                        });
                        break;
                }
                
                doc.text(`Total: ${filteredContracts.length} contracts`, 40, 75);
                
                // Table headers
                const headers = ['Project', 'Type', 'End Date', 'Days Left', 'Amount', 'Status'];
                let y = 100;
                
                doc.setFontSize(8);
                headers.forEach((header, i) => {
                    doc.text(header, 40 + (i * 90), y);
                });
                
                y += 20;
                
                // Table data
                filteredContracts.forEach(contract => {
                    const endDate = new Date(contract.endDate);
                    const daysRemaining = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
                    
                    const row = [
                        contract.projectName || 'N/A',
                        contract.contractType || 'N/A',
                        endDate.toLocaleDateString(),
                        daysRemaining < 0 ? 'Expired' : `${daysRemaining} days`,
                        `Rs. ${(contract.amount || 0).toLocaleString()}`,
                        daysRemaining < 0 ? 'Expired' : daysRemaining <= 30 ? 'Expiring Soon' : 'Active'
                    ];
                    
                    row.forEach((cell, i) => {
                        doc.text(String(cell), 40 + (i * 90), y);
                    });
                    y += 15;
                    
                    if (y > 520) { // Start new page
                        doc.addPage();
                        y = 40;
                    }
                });
                
                doc.save(`AMC_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error generating renewals report:', error);
                alert('Error generating renewals report: ' + error.message);
            }
        };

        // Free maintenance period calculation
        document.getElementById('freeMaintenanceMonths').addEventListener('input', function() {
            const months = parseInt(this.value) || 0;
            const startDate = document.getElementById('freeMaintenanceStartDate').value;
            
            if (months > 0 && startDate) {
                const start = new Date(startDate);
                const end = new Date(start);
                end.setMonth(end.getMonth() + months);
                document.getElementById('freeMaintenanceEndDate').value = end.toISOString().split('T')[0];
            } else {
                document.getElementById('freeMaintenanceEndDate').value = '';
            }
        });

        document.getElementById('freeMaintenanceStartDate').addEventListener('change', function() {
            const months = parseInt(document.getElementById('freeMaintenanceMonths').value) || 0;
            const startDate = this.value;
            
            if (months > 0 && startDate) {
                const start = new Date(startDate);
                const end = new Date(start);
                end.setMonth(end.getMonth() + months);
                document.getElementById('freeMaintenanceEndDate').value = end.toISOString().split('T')[0];
            }
        });

        // ==================== END AMC FUNCTIONS ====================

        // ==================== TASK MANAGEMENT FUNCTIONS ====================
        
        // Load tasks from Firebase
        async function loadTasks() {
            try {
                const snapshot = await getDocs(collection(db, 'tasks'));
                tasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                localStorage.setItem('cachedTasks', JSON.stringify(tasks));
                renderTasks();
                updateTaskStats();
                populateTaskAssigneeFilter();
            } catch (error) {
                console.error('Error loading tasks:', error);
                const cachedTasks = localStorage.getItem('cachedTasks');
                if (cachedTasks) {
                    tasks = JSON.parse(cachedTasks);
                    renderTasks();
                    updateTaskStats();
                    populateTaskAssigneeFilter();
                }
            }
        }

        // Render tasks table
        function renderTasks() {
            const tbody = document.getElementById('tasksList');
            if (!tbody) return;
            
            const filteredTasks = filterTasksList();
            
            if (filteredTasks.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">üìã</div><p>No tasks found.</p></td></tr>';
                return;
            }

            tbody.innerHTML = filteredTasks.map(task => {
                const priorityClass = task.priority === 'High' ? 'danger' : task.priority === 'Medium' ? 'warning' : 'secondary';
                const statusClass = task.status === 'Completed' ? 'success' : task.status === 'In Progress' ? 'primary' : task.status === 'On Hold' ? 'warning' : 'secondary';
                const typeIcon = task.assignmentType === 'self' ? 'üë§' : 'üë•';
                const typeLabel = task.assignmentType === 'self' ? 'Self-Assigned' : 'Admin Assigned';
                
                const dueDate = task.dueDate ? new Date(task.dueDate) : null;
                const isOverdue = dueDate && dueDate < new Date() && task.status !== 'Completed';
                const dueDateClass = isOverdue ? 'text-danger' : '';
                
                return `
                    <tr>
                        <td>
                            <div><strong>${task.title}</strong></div>
                            <small class="text-muted">${task.description || 'No description'}</small>
                            ${task.assignmentType === 'self' ? '<br><span class="badge badge-info" style="font-size: 10px; margin-top: 4px;">üë§ Self-Assigned</span>' : ''}
                        </td>
                        <td>
                            <div><strong>${task.assignedToName || task.assignedTo}</strong></div>
                            <small class="text-muted">${task.createdBy || 'System'}</small>
                        </td>
                        <td><span class="badge badge-info">${task.category}</span></td>
                        <td><span class="badge badge-${priorityClass}">${task.priority}</span></td>
                        <td>
                            <div class="${dueDateClass}">${dueDate ? dueDate.toLocaleDateString() : 'N/A'}</div>
                            ${isOverdue ? '<small class="text-danger"><strong>‚ö†Ô∏è Overdue</strong></small>' : ''}
                        </td>
                        <td><span class="badge badge-${statusClass}">${task.status}</span></td>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="flex: 1; background: #e2e8f0; height: 8px; border-radius: 4px; overflow: hidden;">
                                    <div style="width: ${task.progress || 0}%; height: 100%; background: ${task.status === 'Completed' ? '#16a34a' : '#3b82f6'}; transition: width 0.3s;"></div>
                                </div>
                                <span style="font-size: 12px; font-weight: 600;">${task.progress || 0}%</span>
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-secondary btn-sm" onclick="editTask('${task.id}')">Edit</button>
                                ${currentUser.role === 'admin' || task.assignedTo === currentUser.username ? 
                                    `<button class="btn btn-danger btn-sm" onclick="deleteTask('${task.id}')">Delete</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filter tasks
        function filterTasksList() {
            const search = document.getElementById('searchTasks')?.value.toLowerCase() || '';
            const status = document.getElementById('taskStatusFilter')?.value || '';
            const priority = document.getElementById('taskPriorityFilter')?.value || '';
            const category = document.getElementById('taskCategoryFilter')?.value || '';
            const assignee = document.getElementById('taskAssigneeFilter')?.value || '';
            const type = document.getElementById('taskTypeFilter')?.value || '';

            return tasks.filter(task => {
                const matchesSearch = !search || 
                    task.title?.toLowerCase().includes(search) ||
                    task.description?.toLowerCase().includes(search) ||
                    task.assignedTo?.toLowerCase().includes(search);
                const matchesStatus = !status || task.status === status;
                const matchesPriority = !priority || task.priority === priority;
                const matchesCategory = !category || task.category === category;
                const matchesAssignee = !assignee || task.assignedTo === assignee;
                const matchesType = !type || task.assignmentType === type;

                return matchesSearch && matchesStatus && matchesPriority && matchesCategory && matchesAssignee && matchesType;
            });
        }

        window.filterTasks = () => {
            renderTasks();
        };

        // Update task statistics
        function updateTaskStats() {
            const total = tasks.length;
            const inProgress = tasks.filter(t => t.status === 'In Progress').length;
            const pending = tasks.filter(t => t.status === 'Pending').length;
            const completed = tasks.filter(t => t.status === 'Completed').length;
            const selfAssigned = tasks.filter(t => t.assignmentType === 'self').length;

            document.getElementById('totalTasks').textContent = total;
            document.getElementById('inProgressTasks').textContent = inProgress;
            document.getElementById('pendingTasks').textContent = pending;
            document.getElementById('completedTasks').textContent = completed;
            document.getElementById('selfAssignedTasks').textContent = selfAssigned;
        }

        // Populate assignee filter
        function populateTaskAssigneeFilter() {
            const select = document.getElementById('taskAssigneeFilter');
            const assignedToSelect = document.getElementById('taskAssignedTo');
            
            if (select && employees) {
                const uniqueAssignees = [...new Set(tasks.map(t => t.assignedTo))];
                select.innerHTML = '<option value="">All Assignees</option>' + 
                    uniqueAssignees.map(assignee => `<option value="${assignee}">${assignee}</option>`).join('');
            }
            
            if (assignedToSelect && employees) {
                assignedToSelect.innerHTML = '<option value="">Select Employee</option>' + 
                    employees.filter(emp => emp.systemStatus === 'active')
                        .map(emp => `<option value="${emp.username}">${emp.firstName} ${emp.lastName}</option>`).join('');
            }
        }

        // Show add task modal (Admin)
        window.showAddTaskModal = () => {
            document.getElementById('taskModalTitle').textContent = 'Create New Task';
            document.getElementById('taskForm').reset();
            document.getElementById('editTaskId').value = '';
            
            // Populate project dropdown
            const projectSelect = document.getElementById('taskProject');
            if (projectSelect && projects) {
                projectSelect.innerHTML = '<option value="">None</option>' + 
                    projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            }
            
            // Populate assignee dropdown
            populateTaskAssigneeFilter();
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('taskDueDate').min = today;
            
            document.getElementById('taskModal').classList.add('active');
        };

        // Show self-assign task modal
        window.showAddSelfTaskModal = () => {
            document.getElementById('selfTaskForm').reset();
            
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('selfTaskDueDate').min = today;
            
            document.getElementById('selfTaskModal').classList.add('active');
        };

        // Task form submission (Admin)
        document.getElementById('taskForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const taskId = document.getElementById('editTaskId').value;
            const assignedTo = document.getElementById('taskAssignedTo').value;
            const assignedEmployee = employees.find(emp => emp.username === assignedTo);
            
            const taskData = {
                title: document.getElementById('taskTitle').value.trim(),
                description: document.getElementById('taskDescription').value.trim(),
                category: document.getElementById('taskCategory').value,
                priority: document.getElementById('taskPriority').value,
                assignedTo: assignedTo,
                assignedToName: assignedEmployee ? `${assignedEmployee.firstName} ${assignedEmployee.lastName}` : assignedTo,
                dueDate: document.getElementById('taskDueDate').value,
                status: document.getElementById('taskStatus').value,
                progress: parseInt(document.getElementById('taskProgress').value) || 0,
                relatedProject: document.getElementById('taskProject').value || null,
                assignmentType: 'assigned',
                createdBy: currentUser?.username || 'admin',
                lastModified: new Date().toISOString()
            };

            try {
                if (taskId) {
                    await updateDoc(doc(db, 'tasks', taskId), taskData);
                    const index = tasks.findIndex(t => t.id === taskId);
                    if (index !== -1) {
                        tasks[index] = { ...tasks[index], ...taskData };
                    }
                } else {
                    taskData.createdAt = new Date().toISOString();
                    const docRef = await addDoc(collection(db, 'tasks'), taskData);
                    tasks.push({ id: docRef.id, ...taskData });
                }
                
                localStorage.setItem('cachedTasks', JSON.stringify(tasks));
                renderTasks();
                updateTaskStats();
                closeModal('taskModal');
                alert(taskId ? 'Task updated successfully!' : 'Task created successfully!');
            } catch (error) {
                console.error('Error saving task:', error);
                alert('Error saving task. Please try again.');
            }
        });

        // Self task form submission
        document.getElementById('selfTaskForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const taskData = {
                title: document.getElementById('selfTaskTitle').value.trim(),
                description: document.getElementById('selfTaskDescription').value.trim(),
                category: document.getElementById('selfTaskCategory').value,
                priority: document.getElementById('selfTaskPriority').value,
                assignedTo: currentUser?.username || 'user',
                assignedToName: currentUser?.fullName || currentUser?.username || 'User',
                dueDate: document.getElementById('selfTaskDueDate').value,
                status: document.getElementById('selfTaskStatus').value,
                progress: 0,
                relatedProject: null,
                assignmentType: 'self',
                createdBy: currentUser?.username || 'user',
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString()
            };

            try {
                const docRef = await addDoc(collection(db, 'tasks'), taskData);
                tasks.push({ id: docRef.id, ...taskData });
                
                localStorage.setItem('cachedTasks', JSON.stringify(tasks));
                renderTasks();
                updateTaskStats();
                closeModal('selfTaskModal');
                alert('Self-task created successfully!');
            } catch (error) {
                console.error('Error saving self-task:', error);
                alert('Error creating task. Please try again.');
            }
        });

        // Edit task
        window.editTask = (id) => {
            const task = tasks.find(t => t.id === id);
            if (!task) {
                alert('Task not found');
                return;
            }
            
            // Check permissions
            if (currentUser.role !== 'admin' && task.assignedTo !== currentUser.username) {
                alert('You can only edit your own tasks');
                return;
            }
            
            document.getElementById('taskModalTitle').textContent = 'Edit Task';
            document.getElementById('editTaskId').value = task.id;
            document.getElementById('taskTitle').value = task.title || '';
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskCategory').value = task.category || '';
            document.getElementById('taskPriority').value = task.priority || 'Medium';
            document.getElementById('taskAssignedTo').value = task.assignedTo || '';
            document.getElementById('taskDueDate').value = task.dueDate || '';
            document.getElementById('taskStatus').value = task.status || 'Pending';
            document.getElementById('taskProgress').value = task.progress || 0;
            document.getElementById('taskProject').value = task.relatedProject || '';
            
            populateTaskAssigneeFilter();
            document.getElementById('taskModal').classList.add('active');
        };

        // Delete task
        window.deleteTask = async (id) => {
            const task = tasks.find(t => t.id === id);
            if (!task) {
                alert('Task not found');
                return;
            }
            
            // Check permissions
            if (currentUser.role !== 'admin' && task.assignedTo !== currentUser.username) {
                alert('You can only delete your own tasks');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete this task: "${task.title}"?`)) {
                return;
            }

            try {
                await deleteDoc(doc(db, 'tasks', id));
                tasks = tasks.filter(t => t.id !== id);
                localStorage.setItem('cachedTasks', JSON.stringify(tasks));
                renderTasks();
                updateTaskStats();
                alert('Task deleted successfully!');
            } catch (error) {
                console.error('Error deleting task:', error);
                alert('Error deleting task. Please try again.');
            }
        };

        // ==================== END TASK MANAGEMENT FUNCTIONS ====================

        // Export general maintenance list to PDF
        window.exportMaintenancePDF = async () => {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('l', 'mm', 'a4');
                
                // Add company header
                let yPos = await addCompanyHeaderToPDF(doc, 'Maintenance Schedule Report', 10);
                yPos += 5;
                
                // Report metadata
                doc.setFontSize(10);
                doc.setTextColor(15, 23, 42);
                doc.setFont(undefined, 'normal');
                doc.text(`Generated: ${new Date().toLocaleString()}`, 15, yPos);
                doc.text(`By: ${currentUser.fullName || currentUser.username}`, 150, yPos);
                doc.text(`Total Records: ${maintenance.length}`, 240, yPos);
                yPos += 8;
                
                // Summary stats
                const pending = maintenance.filter(m => m.status === 'Pending').length;
                const inProgress = maintenance.filter(m => m.status === 'In Progress').length;
                const completed = maintenance.filter(m => m.status === 'Completed').length;
                const highPriority = maintenance.filter(m => m.priority === 'High').length;
                
                const stats = [
                    { label: 'Pending', value: pending, color: [220, 38, 38] },
                    { label: 'In Progress', value: inProgress, color: [234, 88, 12] },
                    { label: 'Completed', value: completed, color: [22, 163, 74] },
                    { label: 'High Priority', value: highPriority, color: [37, 99, 235] }
                ];
                
                let xPos = 15;
                stats.forEach(stat => {
                    doc.setDrawColor(226, 232, 240);
                    doc.rect(xPos, yPos, 65, 15);
                    
                    doc.setFontSize(9);
                    doc.setTextColor(100, 116, 139);
                    doc.text(stat.label, xPos + 2, yPos + 5);
                    
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(...stat.color);
                    doc.text(String(stat.value), xPos + 2, yPos + 12);
                    
                    xPos += 68;
                    doc.setFont(undefined, 'normal');
                });
                
                yPos += 20;
                
                // Table headers
                doc.setFillColor(248, 250, 252);
                doc.rect(15, yPos - 5, 267, 8, 'F');
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(15, 23, 42);
                
                const headers = [
                    { label: '#', x: 17 },
                    { label: 'Project', x: 25 },
                    { label: 'Elevator', x: 75 },
                    { label: 'Issue', x: 105 },
                    { label: 'Priority', x: 165 },
                    { label: 'Assigned', x: 195 },
                    { label: 'Due Date', x: 230 },
                    { label: 'Status', x: 260 }
                ];
                
                headers.forEach(h => {
                    doc.text(h.label, h.x, yPos);
                });
                
                yPos += 5;
                doc.setDrawColor(226, 232, 240);
                doc.line(15, yPos, 282, yPos);
                yPos += 5;
                
                // Table data
                doc.setFont(undefined, 'normal');
                doc.setFontSize(7);
                
                if (maintenance.length === 0) {
                    doc.setTextColor(100, 116, 139);
                    doc.text('No maintenance records available', 148.5, yPos + 10, { align: 'center' });
                } else {
                    maintenance.forEach((item, index) => {
                        if (yPos > 190) {
                            doc.addPage();
                            yPos = 20;
                            
                            // Repeat headers
                            doc.setFillColor(248, 250, 252);
                            doc.rect(15, yPos - 5, 267, 8, 'F');
                            doc.setFont(undefined, 'bold');
                            headers.forEach(h => {
                                doc.text(h.label, h.x, yPos);
                            });
                            yPos += 5;
                            doc.line(15, yPos, 282, yPos);
                            yPos += 5;
                            doc.setFont(undefined, 'normal');
                        }
                        
                        // Alternating row background
                        if (index % 2 === 0) {
                            doc.setFillColor(249, 250, 251);
                            doc.rect(15, yPos - 4, 267, 7, 'F');
                        }
                        
                        doc.setTextColor(15, 23, 42);
                        
                        doc.text(String(index + 1), 17, yPos);
                        doc.text((item.projectName || 'N/A').substring(0, 25), 25, yPos);
                        doc.text((item.elevatorId || 'N/A').substring(0, 15), 75, yPos);
                        doc.text((item.issue || 'N/A').substring(0, 30), 105, yPos);
                        
                        // Priority with color
                        const priorityColor = item.priority === 'High' ? [220, 38, 38] :
                                            item.priority === 'Medium' ? [234, 88, 12] : [100, 116, 139];
                        doc.setTextColor(...priorityColor);
                        doc.text(item.priority || 'Normal', 165, yPos);
                        
                        doc.setTextColor(15, 23, 42);
                        doc.text((item.assignedTo || 'Unassigned').substring(0, 18), 195, yPos);
                        doc.text(item.dueDate ? new Date(item.dueDate).toLocaleDateString() : 'N/A', 230, yPos);
                        
                        // Status with color
                        const statusColor = item.status === 'Completed' ? [22, 163, 74] :
                                          item.status === 'In Progress' ? [37, 99, 235] : [220, 38, 38];
                        doc.setTextColor(...statusColor);
                        doc.text(item.status || 'Pending', 260, yPos);
                        
                        yPos += 7;
                    });
                }
                
                // Add footer to all pages
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    await addCompanyFooterToPDF(doc, 210);
                }
                
                doc.save(`Maintenance_Schedule_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('Error generating maintenance PDF:', error);
                alert('Error generating maintenance PDF: ' + error.message);
            }
        };

        // Enhanced maintenance report export with signatures
        window.exportMaintenanceReport = async (maintenanceId, maintenanceObj = null) => {
            const maint = maintenanceObj ? maintenanceObj :
                maintenanceId ? 
                maintenance.find(m => m.id === maintenanceId) : 
                {
                    projectName: document.getElementById('maintenanceProject').selectedOptions[0]?.text || '',
                    elevatorId: document.getElementById('maintenanceElevator').value,
                    issue: document.getElementById('maintenanceIssue').value,
                    priority: document.getElementById('maintenancePriority').value,
                    assignedTo: document.getElementById('maintenanceAssignee').value,
                    dueDate: document.getElementById('maintenanceDueDate').value,
                    status: document.getElementById('maintenanceStatus').value,
                    notes: document.getElementById('maintenanceNotes').value,
                    complaintPersonName: document.getElementById('complaintPersonName').value,
                    complaintPersonPhone: document.getElementById('complaintPersonPhone').value,
                    complaintPersonEmail: document.getElementById('complaintPersonEmail').value,
                    complaintPersonDesignation: document.getElementById('complaintPersonDesignation').value,
                    complaintPersonAddress: document.getElementById('complaintPersonAddress').value,
                    complaintDate: document.getElementById('complaintDate').value,
                    workDescription: document.getElementById('workDescription').value,
                    partsUsed: document.getElementById('partsUsed').value,
                    workCost: document.getElementById('workCost').value,
                    arrivalTime: document.getElementById('arrivalTime').value,
                    completionTime: document.getElementById('completionTime').value,
                    signatoryName: document.getElementById('signatoryName').value,
                    arrivalSignature: document.getElementById('arrivalSignatureCanvas')?.toDataURL(),
                    completionSignature: document.getElementById('completionSignatureCanvas')?.toDataURL()
                };

            if (!maint) return;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Load logo (same method as invoice PDF)
                let logoImg = null;
                try {
                    logoImg = await loadImageAsDataUrl('ambivare.png');
                    if (!logoImg) {
                        // try absolute URL
                        const logoUrl = new URL('ambivare.png', window.location.href).href;
                        logoImg = await loadImageAsDataUrl(logoUrl);
                    }
                } catch (e) {
                    console.warn('Logo load failed for maintenance report:', e);
                    logoImg = null;
                }

                // Final fallback: try a pre-embedded local file containing the base64 data URI
                if (!logoImg) {
                    try {
                        const resp = await fetch('./libs/embedded_logo.txt');
                        if (resp && resp.ok) {
                            logoImg = await resp.text();
                        }
                    } catch (e) {
                        // ignore
                    }
                }
                
                // Colors
                const primaryColor = [37, 99, 235];
                const darkColor = [15, 23, 42];
                const grayColor = [100, 116, 139];
                
                // Header with logo
                doc.setFontSize(18);
                doc.setTextColor(...primaryColor);
                doc.text('MAINTENANCE REPORT', 105, 30, { align: 'center' });
                
                // Logo in top-left corner
                if (logoImg) {
                    try {
                        doc.addImage(logoImg, 'PNG', 15, 5, 20, 20);
                    } catch (e) {
                        console.warn('Adding logo to maintenance PDF failed:', e);
                    }
                }
                
                // Company name next to logo
                doc.setFontSize(12);
                doc.setTextColor(...darkColor);
                doc.text('Avant Elevators', 40, 12);
                doc.setFontSize(8);
                doc.setTextColor(...grayColor);
                doc.text('Professional Maintenance Services', 40, 18);
                
                // Company email in top right
                if (companySettings.email) {
                    doc.text(companySettings.email, 190, 12, { align: 'right' });
                }
                
                // Company details - simplified and compressed
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                let detailsY = 35;
                
                // Report details - adjusted for new title position
                let y = detailsY + 5;
                doc.setFontSize(9);
                doc.setTextColor(...darkColor);
                doc.text(`Generated: ${new Date().toLocaleString()}`, 15, y);
                doc.text(`Report ID: ${maint.id || 'DRAFT'}`, 15, y + 6);
            
            // Complaint Information
            y += 20;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.setTextColor(...darkColor);
            doc.text('COMPLAINT DETAILS', 15, y);
            
            y += 10;
            doc.setFont(undefined, 'normal');
            doc.setFontSize(9);
            
            // Two-column layout for better space usage
            const leftFields = [
                ['Project:', maint.projectName],
                ['Elevator ID(s):', maint.elevatorCount > 1 ? 
                    `${maint.elevatorCount} Elevators: ${maint.elevatorId}` : 
                    maint.elevatorId],
                ['Issue:', maint.issue],
                ['Priority:', maint.priority],
                ['Date:', maint.complaintDate ? new Date(maint.complaintDate).toLocaleDateString() : '']
            ];
            
            const rightFields = [
                ['Complainant:', maint.complaintPersonName],
                ['Phone:', maint.complaintPersonPhone],
                ['Email:', maint.complaintPersonEmail],
                ['Designation:', maint.complaintPersonDesignation],
                ['Address:', maint.complaintPersonAddress]
            ];
            
            const startY = y;
            let leftY = y;
            let rightY = y;
            
            // Left column
            leftFields.forEach(([label, value], index) => {
                if (value) {
                    doc.setFont(undefined, 'bold');
                    doc.text(label, 15, leftY);
                    doc.setFont(undefined, 'normal');
                    const text = doc.splitTextToSize(value.toString(), 75); // Further reduced width
                    doc.text(text, 50, leftY);
                    leftY += Math.max(6, text.length * 6); // Adjust for multi-line text
                }
            });
            
            // Right column - moved significantly to the right to avoid any overlap
            rightFields.forEach(([label, value], index) => {
                if (value) {
                    doc.setFont(undefined, 'bold');
                    doc.text(label, 140, rightY); // Moved further right
                    doc.setFont(undefined, 'normal');
                    const text = doc.splitTextToSize(value.toString(), 55); // Appropriate width for right side
                    doc.text(text, 170, rightY); // Moved further right
                    rightY += Math.max(6, text.length * 6); // Adjust for multi-line text
                }
            });
            
            // Set Y to the maximum of both columns
            y = Math.max(leftY, rightY);
            
            // Work Information - more compact
            if (maint.status === 'Completed') {
                y += 8;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('WORK PERFORMED', 15, y);
                
                y += 8;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                
                const workFields = [
                    ['Technician:', maint.assignedTo],
                    ['Work Description:', maint.workDescription],
                    ['Parts Used:', maint.partsUsed],
                    ['Total Cost:', maint.workCost ? `Rs. ${maint.workCost}` : ''],
                    ['Arrival:', maint.arrivalTime ? new Date(maint.arrivalTime).toLocaleString() : ''],
                    ['Completion:', maint.completionTime ? new Date(maint.completionTime).toLocaleString() : ''],
                    ['Signatory:', maint.signatoryName]
                ];
                
                workFields.forEach(([label, value]) => {
                    if (value) {
                        doc.setFont(undefined, 'bold');
                        doc.text(label, 15, y);
                        doc.setFont(undefined, 'normal');
                        const text = doc.splitTextToSize(value.toString(), 150);
                        doc.text(text, 60, y);
                        y += 5;
                    }
                });
            }
            
            // Signatures Section - optimized for single page
            if (maint.arrivalSignature || maint.completionSignature) {
                // Ensure signatures fit on the same page
                if (y > 190) {
                    y = 190; // Force higher positioning to fit
                }
                
                y += 8;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(11);
                doc.setTextColor(15, 23, 42);
                doc.text('SIGNATURES', 15, y);
                y += 10;
                
                // Compact signature display
                if (maint.arrivalSignature && maint.completionSignature) {
                    // Headers - smaller font
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(9);
                    doc.text('ARRIVAL:', 15, y);
                    doc.text('COMPLETION:', 110, y);
                    
                    y += 5;
                    
                    try {
                        // Smaller signatures to fit
                        doc.addImage(maint.arrivalSignature, 'PNG', 15, y, 60, 20);
                        doc.addImage(maint.completionSignature, 'PNG', 110, y, 60, 20);
                        
                        y += 22;
                        
                        // Compact details
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(7);
                        doc.text('Building Representative', 15, y);
                        doc.text(maint.signatoryName || 'Building Representative', 110, y);
                        
                        y += 4;
                        if (maint.arrivalTime) {
                            doc.text(new Date(maint.arrivalTime).toLocaleString(), 15, y);
                        }
                        if (maint.completionTime) {
                            doc.text(new Date(maint.completionTime).toLocaleString(), 110, y);
                        }
                        
                    } catch (e) {
                        console.error('Error adding signatures:', e);
                        doc.text('Signatures available', 15, y);
                    }
                }
                // Single signature handling - more compact
                else if (maint.arrivalSignature) {
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(9);
                    doc.text('ARRIVAL SIGNATURE:', 15, y);
                    y += 5;
                    try {
                        doc.addImage(maint.arrivalSignature, 'PNG', 15, y, 60, 20);
                        y += 22;
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(7);
                        doc.text('Building Representative', 15, y);
                        if (maint.arrivalTime) {
                            y += 4;
                            doc.text(new Date(maint.arrivalTime).toLocaleString(), 15, y);
                        }
                    } catch (e) {
                        doc.text('Arrival signature available', 15, y);
                    }
                }
                else if (maint.completionSignature) {
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(9);
                    doc.text('COMPLETION SIGNATURE:', 15, y);
                    y += 5;
                    try {
                        doc.addImage(maint.completionSignature, 'PNG', 15, y, 60, 20);
                        y += 22;
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(7);
                        doc.text(maint.signatoryName || 'Building Representative', 15, y);
                        if (maint.completionTime) {
                            y += 4;
                            doc.text(new Date(maint.completionTime).toLocaleString(), 15, y);
                        }
                    } catch (e) {
                        doc.text('Completion signature available', 15, y);
                    }
                }
            }
            
            // Footer - ONLY on the actual last page (moved higher to prevent cutoff)
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(100, 116, 139);
                doc.text(`Page ${i} of ${pageCount}`, 105, 280, { align: 'center' });
                doc.text('Avant Elevators - Confidential Report', 20, 280);
            }
            
            const fileName = maint.elevatorCount > 1 ? 
                `maintenance_report_${maint.elevatorCount}elevators_${new Date().toISOString().split('T')[0]}.pdf` :
                `maintenance_report_${maint.elevatorId}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            } catch (error) {
                console.error('Error generating maintenance report PDF:', error);
                alert('Error generating maintenance report PDF: ' + error.message);
            }
        };

        // ==================== ANALYTICS WINDOWS ====================
        
        window.openAnalyticsWindow = (type) => {
            let title = '';
            let content = '';
            
            switch(type) {
                case 'sales':
                    title = 'üí∞ COMPREHENSIVE SALES ANALYTICS & PERFORMANCE DASHBOARD';
                    content = generateSalesAnalytics();
                    break;
                case 'projects':
                    title = 'üèóÔ∏è PROJECT MANAGEMENT ANALYTICS & INSIGHTS';
                    content = generateProjectAnalytics();
                    break;
                case 'leads':
                    title = 'üéØ LEAD PIPELINE ANALYTICS & CONVERSION METRICS';
                    content = generateLeadAnalytics();
                    break;
                case 'amc':
                    title = 'üìù AMC CONTRACT ANALYTICS & RENEWAL INTELLIGENCE';
                    content = generateAMCAnalytics();
                    break;
                case 'maintenance':
                    title = 'üîß MAINTENANCE OPERATIONS ANALYTICS & SERVICE METRICS';
                    content = generateMaintenanceAnalytics();
                    break;
                case 'hr':
                    title = 'üë• HUMAN RESOURCES ANALYTICS & WORKFORCE INSIGHTS';
                    content = generateHRAnalytics();
                    break;
                case 'inventory':
                    title = 'üì¶ INVENTORY MANAGEMENT ANALYTICS & STOCK INTELLIGENCE';
                    content = generateInventoryAnalytics();
                    break;
                case 'billing':
                    title = 'üí≥ FINANCIAL ANALYTICS & REVENUE MANAGEMENT';
                    content = generateBillingAnalytics();
                    break;
            }
            
            // Create MASSIVE fullscreen modal
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'analyticsModal';
            modal.style.cssText = 'padding: 10px;';
            modal.innerHTML = `
                <div class="modal-dialog" style="max-width: 98%; width: 98%; margin: 10px auto;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 20px;">
                        <div>
                            <h3 class="modal-title" style="font-size: 24px; margin-bottom: 4px;">${title}</h3>
                            <small style="opacity: 0.9;">Generated on ${new Date().toLocaleString()} | Real-time Business Intelligence</small>
                        </div>
                        <button class="modal-close" style="color: white; font-size: 28px;" onclick="document.getElementById('analyticsModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body" style="max-height: calc(100vh - 180px); overflow-y: auto; padding: 24px; background: #f8fafc;">
                        ${content}
                    </div>
                    <div class="modal-footer" style="background: white; border-top: 2px solid #e2e8f0; padding: 16px 24px;">
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="export${type.charAt(0).toUpperCase() + type.slice(1)}AnalyticsPDF()">üì• Export Full Report PDF</button>
                            <button class="btn btn-success" onclick="window.print()">üñ®Ô∏è Print Report</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('analyticsModal').remove()">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        };
        
        function generateSalesAnalytics() {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            const convertedLeads = leads ? leads.filter(l => l.status === 'Converted') : [];
            const allLeads = leads || [];
            
            // Monthly revenue data
            const monthlyData = [];
            let yearToDateRevenue = 0;
            for(let i = 0; i < 12; i++) {
                const monthRevenue = convertedLeads.filter(l => 
                    new Date(l.updatedAt).getMonth() === i && 
                    new Date(l.updatedAt).getFullYear() === currentYear
                ).reduce((sum, l) => sum + parseFloat(l.value || 0), 0);
                if(i <= currentMonth) yearToDateRevenue += monthRevenue;
                monthlyData.push({
                    month: new Date(currentYear, i).toLocaleString('default', {month: 'long'}), 
                    revenue: monthRevenue,
                    count: convertedLeads.filter(l => new Date(l.updatedAt).getMonth() === i && new Date(l.updatedAt).getFullYear() === currentYear).length
                });
            }
            
            // Sales rep performance
            const reps = {};
            allLeads.forEach(lead => {
                const rep = lead.assignedTo || 'Unassigned';
                if(!reps[rep]) {
                    reps[rep] = {name: rep, totalLeads: 0, hotLeads: 0, converted: 0, lost: 0, revenue: 0};
                }
                reps[rep].totalLeads++;
                if(lead.priority === 'Hot') reps[rep].hotLeads++;
                if(lead.status === 'Converted') {
                    reps[rep].converted++;
                    reps[rep].revenue += parseFloat(lead.value || 0);
                }
                if(lead.status === 'Lost') reps[rep].lost++;
            });
            
            const salesRepData = Object.values(reps).map(rep => ({
                ...rep,
                conversionRate: rep.totalLeads > 0 ? ((rep.converted / rep.totalLeads) * 100).toFixed(1) : 0,
                avgDeal: rep.converted > 0 ? Math.round(rep.revenue / rep.converted) : 0,
                score: Math.min(100, Math.round((parseFloat(rep.conversionRate || 0) * 0.4) + (rep.revenue / 100000) + (rep.hotLeads * 2)))
            })).sort((a, b) => b.revenue - a.revenue);
            
            return `
                <div style="display: grid; gap: 24px;">
                    <!-- KPI Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #10b981; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">üí∞ TOTAL REVENUE (ALL TIME)</div>
                            <div style="font-size: 32px; font-weight: 700; color: #10b981;">‚Çπ${convertedLeads.reduce((sum, l) => sum + parseFloat(l.value || 0), 0).toLocaleString('en-IN')}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">${convertedLeads.length} deals closed</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #3b82f6; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">üìÖ YEAR-TO-DATE REVENUE</div>
                            <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">‚Çπ${yearToDateRevenue.toLocaleString('en-IN')}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">FY ${currentYear}</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #f59e0b; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">üìä AVERAGE DEAL SIZE</div>
                            <div style="font-size: 32px; font-weight: 700; color: #f59e0b;">‚Çπ${convertedLeads.length > 0 ? Math.round(convertedLeads.reduce((sum, l) => sum + parseFloat(l.value || 0), 0) / convertedLeads.length).toLocaleString('en-IN') : 0}</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Per closed deal</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #8b5cf6; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="font-size: 14px; color: #64748b; margin-bottom: 8px;">üéØ CONVERSION RATE</div>
                            <div style="font-size: 32px; font-weight: 700; color: #8b5cf6;">${allLeads.length > 0 ? ((convertedLeads.length / allLeads.length) * 100).toFixed(1) : 0}%</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">${convertedLeads.length} of ${allLeads.length} leads</div>
                        </div>
                    </div>
                    
                    <!-- Sales Rep Performance -->
                    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                            üèÜ SALES REPRESENTATIVE PERFORMANCE REVIEW
                        </h3>
                        <div class="table-container">
                            <table class="table" style="margin: 0;">
                                <thead style="background: #f1f5f9;">
                                    <tr>
                                        <th style="padding: 12px;">Rank</th>
                                        <th style="padding: 12px;">Sales Representative</th>
                                        <th style="padding: 12px;">Total Leads</th>
                                        <th style="padding: 12px;">Hot Leads</th>
                                        <th style="padding: 12px;">Converted</th>
                                        <th style="padding: 12px;">Lost</th>
                                        <th style="padding: 12px;">Conversion Rate</th>
                                        <th style="padding: 12px;">Total Revenue</th>
                                        <th style="padding: 12px;">Avg Deal Size</th>
                                        <th style="padding: 12px;">Performance Score</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${salesRepData.map((rep, idx) => `
                                        <tr style="background: ${idx === 0 ? '#fef3c7' : idx === 1 ? '#e0e7ff' : idx === 2 ? '#fce7f3' : 'white'};">
                                            <td style="padding: 12px; font-weight: 700; font-size: 18px;">
                                                ${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : '#' + (idx + 1)}
                                            </td>
                                            <td style="padding: 12px;"><strong>${rep.name}</strong></td>
                                            <td style="padding: 12px; text-align: center;">${rep.totalLeads}</td>
                                            <td style="padding: 12px; text-align: center;"><span style="background: #fef2f2; color: #dc2626; padding: 2px 8px; border-radius: 4px;">${rep.hotLeads}</span></td>
                                            <td style="padding: 12px; text-align: center;"><span style="background: #dcfce7; color: #16a34a; padding: 2px 8px; border-radius: 4px; font-weight: 600;">${rep.converted}</span></td>
                                            <td style="padding: 12px; text-align: center;"><span style="color: #dc2626;">${rep.lost}</span></td>
                                            <td style="padding: 12px; text-align: center;">
                                                <div style="background: #e2e8f0; border-radius: 10px; height: 20px; position: relative; overflow: hidden;">
                                                    <div style="background: ${rep.conversionRate >= 50 ? '#10b981' : rep.conversionRate >= 25 ? '#f59e0b' : '#ef4444'}; height: 100%; width: ${Math.min(rep.conversionRate, 100)}%;"></div>
                                                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: 700;">${rep.conversionRate}%</span>
                                                </div>
                                            </td>
                                            <td style="padding: 12px; font-weight: 700; color: #16a34a;">‚Çπ${rep.revenue.toLocaleString('en-IN')}</td>
                                            <td style="padding: 12px;">‚Çπ${rep.avgDeal.toLocaleString('en-IN')}</td>
                                            <td style="padding: 12px; text-align: center;">
                                                <span style="background: ${rep.score >= 80 ? '#dcfce7' : rep.score >= 50 ? '#fef3c7' : '#fef2f2'}; color: ${rep.score >= 80 ? '#16a34a' : rep.score >= 50 ? '#d97706' : '#dc2626'}; padding: 4px 12px; border-radius: 20px; font-weight: 700;">
                                                    ${rep.score}/100
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Monthly Revenue Breakdown -->
                    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #1e293b;">üìà MONTHLY REVENUE BREAKDOWN (${currentYear})</h3>
                        <table class="table">
                            <thead style="background: #f1f5f9;">
                                <tr>
                                    <th>Month</th>
                                    <th>Revenue</th>
                                    <th>Deals Closed</th>
                                    <th>Growth</th>
                                    <th>Visual</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${monthlyData.map((m, idx) => {
                                    const prevRevenue = idx > 0 ? monthlyData[idx-1].revenue : 0;
                                    const growth = prevRevenue > 0 ? (((m.revenue - prevRevenue) / prevRevenue) * 100).toFixed(1) : 0;
                                    const maxRevenue = Math.max(...monthlyData.map(d => d.revenue), 1);
                                    const barWidth = (m.revenue / maxRevenue) * 100;
                                    return `
                                        <tr style="${idx === currentMonth ? 'background: #eff6ff; font-weight: 600;' : ''}">
                                            <td>${m.month} ${idx === currentMonth ? '(Current)' : ''}</td>
                                            <td style="font-weight: 600;">‚Çπ${m.revenue.toLocaleString('en-IN')}</td>
                                            <td style="text-align: center;">${m.count}</td>
                                            <td style="color: ${growth >= 0 ? '#16a34a' : '#dc2626'};">${idx > 0 ? (growth >= 0 ? '‚Üë' : '‚Üì') + ' ' + Math.abs(growth) + '%' : '-'}</td>
                                            <td style="width: 200px;">
                                                <div style="background: #e2e8f0; border-radius: 4px; height: 16px;">
                                                    <div style="background: #3b82f6; height: 100%; width: ${barWidth}%; border-radius: 4px;"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                            <tfoot style="background: #1e293b; color: white;">
                                <tr>
                                    <td style="font-weight: 700; padding: 12px;">TOTAL</td>
                                    <td style="font-weight: 700; padding: 12px;">‚Çπ${monthlyData.reduce((sum, m) => sum + m.revenue, 0).toLocaleString('en-IN')}</td>
                                    <td style="text-align: center; font-weight: 700; padding: 12px;">${monthlyData.reduce((sum, m) => sum + m.count, 0)}</td>
                                    <td style="padding: 12px;"></td>
                                    <td style="padding: 12px;"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function getSalesRepPerformance() {
            const reps = {};
            leads.filter(l => l.status === 'Converted' && l.assignedTo).forEach(lead => {
                if(!reps[lead.assignedTo]) {
                    reps[lead.assignedTo] = {name: lead.assignedTo, count: 0, value: 0};
                }
                reps[lead.assignedTo].count++;
                reps[lead.assignedTo].value += parseFloat(lead.value || 0);
            });
            return Object.values(reps).sort((a, b) => b.value - a.value);
        }
        
        function getLeadSourcePerformance() {
            const sources = {};
            leads.forEach(lead => {
                const source = lead.source || 'Unknown';
                if(!sources[source]) {
                    sources[source] = {name: source, total: 0, converted: 0};
                }
                sources[source].total++;
                if(lead.status === 'Converted') sources[source].converted++;
            });
            return Object.values(sources).map(s => ({
                ...s, 
                rate: s.total > 0 ? ((s.converted / s.total) * 100).toFixed(1) : 0
            })).sort((a, b) => b.total - a.total);
        }
        
        function generateProjectAnalytics() {
            return `
                <div style="display: grid; gap: 20px;">
                    <div class="card">
                        <h4>Project Status Overview</h4>
                        <table class="table">
                            <thead><tr><th>Project Name</th><th>Client</th><th>Status</th><th>Progress</th><th>Wings</th><th>Elevators</th></tr></thead>
                            <tbody>
                                ${(projects || []).map(p => `
                                    <tr>
                                        <td><strong>${p.name}</strong><br><small>${p.code}</small></td>
                                        <td>${p.client || '-'}</td>
                                        <td><span class="badge badge-${p.status === 'Active' ? 'success' : p.status === 'Completed' ? 'primary' : 'warning'}">${p.status}</span></td>
                                        <td>
                                            <div style="background: #e2e8f0; border-radius: 4px; height: 20px; position: relative;">
                                                <div style="background: var(--primary); height: 100%; width: ${p.progress || 0}%; border-radius: 4px;"></div>
                                                <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 11px; font-weight: 600;">${p.progress || 0}%</span>
                                            </div>
                                        </td>
                                        <td>${p.wings ? p.wings.length : 0}</td>
                                        <td>${p.wings ? p.wings.reduce((sum, w) => sum + (w.elevators ? w.elevators.length : 0), 0) : 0}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateLeadAnalytics() {
            const allLeads = leads || [];
            const statuses = ['New', 'Contacted', 'Qualified', 'Proposal', 'Negotiation', 'Converted', 'Lost'];
            
            return `
                <div style="display: grid; gap: 24px;">
                    <!-- Lead Pipeline Funnel -->
                    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #1e293b;">üîÑ LEAD PIPELINE FUNNEL</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            ${statuses.map(status => {
                                const count = allLeads.filter(l => l.status === status).length;
                                const percentage = allLeads.length > 0 ? ((count / allLeads.length) * 100).toFixed(1) : 0;
                                const value = allLeads.filter(l => l.status === status).reduce((sum, l) => sum + parseFloat(l.value || 0), 0);
                                return `
                                    <div style="text-align: center; padding: 20px; background: ${status === 'Converted' ? '#dcfce7' : status === 'Lost' ? '#fef2f2' : '#f8fafc'}; border-radius: 12px;">
                                        <div style="font-size: 32px; font-weight: 700; color: ${status === 'Converted' ? '#16a34a' : status === 'Lost' ? '#dc2626' : '#1e293b'};">${count}</div>
                                        <div style="font-size: 14px; font-weight: 600; color: #64748b;">${status}</div>
                                        <div style="font-size: 12px; color: #94a3b8;">${percentage}%</div>
                                        <div style="font-size: 11px; color: #16a34a; margin-top: 4px;">‚Çπ${value.toLocaleString('en-IN')}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- All Leads Table -->
                    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #1e293b;">üìä COMPLETE LEAD DATABASE (${allLeads.length} leads)</h3>
                        <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                            <table class="table">
                                <thead style="background: #f1f5f9; position: sticky; top: 0;">
                                    <tr>
                                        <th>Lead Name</th>
                                        <th>Company</th>
                                        <th>Phone</th>
                                        <th>Elevator Type</th>
                                        <th>Qty</th>
                                        <th>Value</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Assigned To</th>
                                        <th>Last Contact</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allLeads.length > 0 ? allLeads.map(lead => `
                                        <tr>
                                            <td><strong>${lead.name}</strong><br><small style="color: #64748b;">${lead.designation || ''}</small></td>
                                            <td>${lead.company}<br><small style="color: #64748b;">${lead.city || ''}</small></td>
                                            <td>${lead.phone}</td>
                                            <td>${lead.elevatorType || '-'}</td>
                                            <td style="text-align: center;">${lead.quantity || '-'}</td>
                                            <td style="font-weight: 600; color: #16a34a;">‚Çπ${parseFloat(lead.value || 0).toLocaleString('en-IN')}</td>
                                            <td><span style="background: ${lead.priority === 'Hot' ? '#fef2f2' : lead.priority === 'Warm' ? '#fef3c7' : '#f1f5f9'}; color: ${lead.priority === 'Hot' ? '#dc2626' : lead.priority === 'Warm' ? '#d97706' : '#64748b'}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${lead.priority}</span></td>
                                            <td><span style="background: ${lead.status === 'Converted' ? '#dcfce7' : lead.status === 'Lost' ? '#fef2f2' : '#e0e7ff'}; color: ${lead.status === 'Converted' ? '#16a34a' : lead.status === 'Lost' ? '#dc2626' : '#4f46e5'}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${lead.status}</span></td>
                                            <td>${lead.assignedTo || '<span style="color: #dc2626; font-weight: 600;">Unassigned</span>'}</td>
                                            <td>${lead.lastContact ? new Date(lead.lastContact).toLocaleDateString() : '-'}</td>
                                        </tr>
                                    `).join('') : '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #64748b;">No leads found. Add leads to see analytics.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateAMCAnalytics() {
            const activeContracts = amc.filter(a => a.status === 'Active');
            return `
                <div style="display: grid; gap: 20px;">
                    <div class="card">
                        <h4>Active AMC Contracts</h4>
                        <table class="table">
                            <thead><tr><th>Project</th><th>Type</th><th>Start Date</th><th>End Date</th><th>Amount</th><th>Payment Mode</th></tr></thead>
                            <tbody>
                                ${activeContracts.map(a => `
                                    <tr>
                                        <td><strong>${a.projectName}</strong></td>
                                        <td>${a.contractType}</td>
                                        <td>${a.startDate ? new Date(a.startDate).toLocaleDateString() : '-'}</td>
                                        <td>${a.endDate ? new Date(a.endDate).toLocaleDateString() : '-'}</td>
                                        <td>‚Çπ${parseFloat(a.amount || 0).toLocaleString('en-IN')}</td>
                                        <td>${a.paymentMode}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateMaintenanceAnalytics() {
            const allMaintenance = maintenance || [];
            const currentDate = new Date();
            
            const scheduled = allMaintenance.filter(m => m.status === 'Scheduled');
            const inProgress = allMaintenance.filter(m => m.status === 'In Progress');
            const completed = allMaintenance.filter(m => m.status === 'Completed');
            const overdue = allMaintenance.filter(m => m.status !== 'Completed' && m.dueDate && new Date(m.dueDate) < currentDate);
            
            // Technician performance
            const techPerformance = {};
            allMaintenance.forEach(m => {
                const tech = m.assignedTo || 'Unassigned';
                if(!techPerformance[tech]) {
                    techPerformance[tech] = {name: tech, total: 0, completed: 0, pending: 0};
                }
                techPerformance[tech].total++;
                if(m.status === 'Completed') techPerformance[tech].completed++;
                else techPerformance[tech].pending++;
            });
            
            return `
                <div style="display: grid; gap: 24px;">
                    <!-- KPIs -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #3b82f6; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="font-size: 14px; color: #64748b;">Total Tasks</div>
                            <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${allMaintenance.length}</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #f59e0b; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="font-size: 14px; color: #64748b;">Scheduled</div>
                            <div style="font-size: 32px; font-weight: 700; color: #f59e0b;">${scheduled.length}</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #8b5cf6; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="font-size: 14px; color: #64748b;">In Progress</div>
                            <div style="font-size: 32px; font-weight: 700; color: #8b5cf6;">${inProgress.length}</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #10b981; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="font-size: 14px; color: #64748b;">Completed</div>
                            <div style="font-size: 32px; font-weight: 700; color: #10b981;">${completed.length}</div>
                        </div>
                        <div style="background: white; padding: 20px; border-radius: 12px; border-left: 5px solid #dc2626; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <div style="font-size: 14px; color: #64748b;">‚ö†Ô∏è Overdue</div>
                            <div style="font-size: 32px; font-weight: 700; color: #dc2626;">${overdue.length}</div>
                        </div>
                    </div>
                    
                    <!-- Technician Performance -->
                    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #1e293b;">üë®‚Äçüîß TECHNICIAN PERFORMANCE</h3>
                        <table class="table">
                            <thead style="background: #f1f5f9;">
                                <tr>
                                    <th>Technician</th>
                                    <th>Total Tasks</th>
                                    <th>Completed</th>
                                    <th>Pending</th>
                                    <th>Completion Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.values(techPerformance).length > 0 ? Object.values(techPerformance).sort((a, b) => b.completed - a.completed).map(tech => {
                                    const rate = tech.total > 0 ? ((tech.completed / tech.total) * 100).toFixed(1) : 0;
                                    return `
                                        <tr>
                                            <td><strong>${tech.name}</strong></td>
                                            <td style="text-align: center;">${tech.total}</td>
                                            <td style="text-align: center; color: #16a34a; font-weight: 600;">${tech.completed}</td>
                                            <td style="text-align: center; color: #d97706;">${tech.pending}</td>
                                            <td style="width: 200px;">
                                                <div style="background: #e2e8f0; border-radius: 10px; height: 24px; position: relative; overflow: hidden;">
                                                    <div style="background: ${rate >= 70 ? '#10b981' : rate >= 40 ? '#f59e0b' : '#ef4444'}; height: 100%; width: ${rate}%;"></div>
                                                    <span style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: 700;">${rate}%</span>
                                                </div>
                                            </td>
                                        </tr>
                                    `;
                                }).join('') : '<tr><td colspan="5" style="text-align: center; padding: 20px;">No technician data available</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- All Maintenance Tasks -->
                    <div style="background: white; padding: 24px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <h3 style="margin: 0 0 20px 0; font-size: 20px; color: #1e293b;">üîß ALL MAINTENANCE TASKS</h3>
                        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
                            <table class="table">
                                <thead style="background: #f1f5f9; position: sticky; top: 0;">
                                    <tr>
                                        <th>Project</th>
                                        <th>Wing</th>
                                        <th>Elevator</th>
                                        <th>Issue</th>
                                        <th>Priority</th>
                                        <th>Status</th>
                                        <th>Assigned To</th>
                                        <th>Due Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${allMaintenance.length > 0 ? allMaintenance.map(m => {
                                        const isOverdue = m.status !== 'Completed' && m.dueDate && new Date(m.dueDate) < currentDate;
                                        return `
                                            <tr style="${isOverdue ? 'background: #fef2f2;' : ''}">
                                                <td>${m.projectName || '-'}</td>
                                                <td>${m.wing || '-'}</td>
                                                <td>${m.elevatorId || m.elevatorList || '-'}</td>
                                                <td><small>${(m.issue || '').substring(0, 80)}${(m.issue || '').length > 80 ? '...' : ''}</small></td>
                                                <td><span style="background: ${m.priority === 'High' ? '#fef2f2' : m.priority === 'Medium' ? '#fef3c7' : '#f1f5f9'}; color: ${m.priority === 'High' ? '#dc2626' : m.priority === 'Medium' ? '#d97706' : '#64748b'}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${m.priority}</span></td>
                                                <td><span style="background: ${m.status === 'Completed' ? '#dcfce7' : m.status === 'In Progress' ? '#e0e7ff' : '#fef3c7'}; color: ${m.status === 'Completed' ? '#16a34a' : m.status === 'In Progress' ? '#4f46e5' : '#d97706'}; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${m.status}</span></td>
                                                <td>${m.assignedTo || '-'}</td>
                                                <td style="${isOverdue ? 'color: #dc2626; font-weight: 600;' : ''}">${m.dueDate ? new Date(m.dueDate).toLocaleDateString() : '-'} ${isOverdue ? '‚ö†Ô∏è' : ''}</td>
                                            </tr>
                                        `;
                                    }).join('') : '<tr><td colspan="8" style="text-align: center; padding: 40px;">No maintenance tasks found</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateHRAnalytics() {
            return `
                <div style="display: grid; gap: 20px;">
                    <div class="card">
                        <h4>Employee Overview</h4>
                        <table class="table">
                            <thead><tr><th>Name</th><th>Position</th><th>Department</th><th>Salary</th><th>Status</th></tr></thead>
                            <tbody>
                                ${(employees || []).map(e => `
                                    <tr>
                                        <td><strong>${e.firstName} ${e.lastName}</strong><br><small>${e.username}</small></td>
                                        <td>${e.position || '-'}</td>
                                        <td>${e.department || '-'}</td>
                                        <td>‚Çπ${parseFloat(e.salary || 0).toLocaleString('en-IN')}</td>
                                        <td><span class="badge badge-${e.systemStatus === 'active' ? 'success' : 'secondary'}">${e.systemStatus}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateInventoryAnalytics() {
            const allItems = getAllItems();
            return `
                <div style="display: grid; gap: 20px;">
                    <div class="card">
                        <h4>Inventory by Location</h4>
                        <table class="table">
                            <thead><tr><th>Item Name</th><th>Category</th><th>Location</th><th>Quantity</th><th>Status</th></tr></thead>
                            <tbody>
                                ${allItems.slice(0, 100).map(item => `
                                    <tr>
                                        <td><strong>${item.name}</strong></td>
                                        <td>${item.category || '-'}</td>
                                        <td>${item.location}</td>
                                        <td>${item.quantity} ${item.unit || ''}</td>
                                        <td><span class="badge badge-${item.quantity >= 100 ? 'success' : item.quantity >= 50 ? 'warning' : 'danger'}">${item.quantity >= 100 ? 'Good' : item.quantity >= 50 ? 'Medium' : 'Low'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        function generateBillingAnalytics() {
            return `
                <div style="display: grid; gap: 20px;">
                    <div class="card">
                        <h4>Invoice Overview</h4>
                        <table class="table">
                            <thead><tr><th>Invoice #</th><th>Client</th><th>Date</th><th>Amount</th><th>Paid</th><th>Balance</th><th>Status</th></tr></thead>
                            <tbody>
                                ${(invoices || []).slice(0, 50).map(inv => `
                                    <tr>
                                        <td><strong>${inv.invoiceNumber || '-'}</strong></td>
                                        <td>${inv.clientName || '-'}</td>
                                        <td>${inv.date ? new Date(inv.date).toLocaleDateString() : '-'}</td>
                                        <td>‚Çπ${parseFloat(inv.totalAmount || 0).toLocaleString('en-IN')}</td>
                                        <td>‚Çπ${parseFloat(inv.paidAmount || 0).toLocaleString('en-IN')}</td>
                                        <td>‚Çπ${(parseFloat(inv.totalAmount || 0) - parseFloat(inv.paidAmount || 0)).toLocaleString('en-IN')}</td>
                                        <td><span class="badge badge-${inv.paymentStatus === 'Paid' ? 'success' : inv.paymentStatus === 'Partial' ? 'warning' : 'danger'}">${inv.paymentStatus || 'Pending'}</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // ============================================
        // FULL ANALYTICS EXPORT FUNCTIONS - GOD LEVEL
        // ============================================
        
        // Export All Analytics PDF
        window.exportAllAnalyticsPDF = async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const companyInfo = await getCompanyInfo();
            
            // Get all data
            const allLeads = await getDocs(collection(db, 'leads'));
            const allProjects = await getDocs(collection(db, 'projects'));
            const allAMC = await getDocs(collection(db, 'amc'));
            const allMaintenance = await getDocs(collection(db, 'maintenance'));
            const allEmployees = await getDocs(collection(db, 'employees'));
            const allInventory = await getDocs(collection(db, 'inventory'));
            
            const leads = allLeads.docs.map(d => ({ id: d.id, ...d.data() }));
            const projects = allProjects.docs.map(d => ({ id: d.id, ...d.data() }));
            const amc = allAMC.docs.map(d => ({ id: d.id, ...d.data() }));
            const maintenance = allMaintenance.docs.map(d => ({ id: d.id, ...d.data() }));
            const employees = allEmployees.docs.map(d => ({ id: d.id, ...d.data() }));
            const inventory = allInventory.docs.map(d => ({ id: d.id, ...d.data() }));
            
            // Title Page
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 60, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(28);
            doc.text(companyInfo.name || 'Avant Elevators', 105, 25, { align: 'center' });
            doc.setFontSize(18);
            doc.text('Complete Analytics Report', 105, 40, { align: 'center' });
            doc.setFontSize(12);
            doc.text(new Date().toLocaleDateString('en-GB'), 105, 50, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            let y = 80;
            
            // Executive Summary
            doc.setFontSize(16);
            doc.setTextColor(37, 99, 235);
            doc.text('Executive Summary', 20, y);
            y += 10;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text(`Total Leads: ${leads.length}`, 30, y);
            doc.text(`Total Projects: ${projects.length}`, 110, y);
            y += 7;
            doc.text(`Active AMC Contracts: ${amc.filter(a => a.status === 'Active').length}`, 30, y);
            doc.text(`Total Maintenance Records: ${maintenance.length}`, 110, y);
            y += 7;
            doc.text(`Total Employees: ${employees.length}`, 30, y);
            doc.text(`Inventory Items: ${inventory.length}`, 110, y);
            y += 15;
            
            // Sales Analytics
            doc.setFontSize(14);
            doc.setTextColor(37, 99, 235);
            doc.text('Sales & Leads Analytics', 20, y);
            y += 8;
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            const leadsByStatus = {
                'New': leads.filter(l => l.status === 'New').length,
                'Contacted': leads.filter(l => l.status === 'Contacted').length,
                'Qualified': leads.filter(l => l.status === 'Qualified').length,
                'Proposal': leads.filter(l => l.status === 'Proposal Sent').length,
                'Won': leads.filter(l => l.status === 'Won').length,
                'Lost': leads.filter(l => l.status === 'Lost').length
            };
            
            Object.entries(leadsByStatus).forEach(([status, count]) => {
                doc.text(`${status}: ${count}`, 30, y);
                y += 6;
            });
            
            // Add new page for more details
            doc.addPage();
            y = 20;
            
            // Projects Analytics
            doc.setFontSize(14);
            doc.setTextColor(37, 99, 235);
            doc.text('Projects Analytics', 20, y);
            y += 8;
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            const projectsByStatus = {
                'Planning': projects.filter(p => p.status === 'Planning').length,
                'In Progress': projects.filter(p => p.status === 'In Progress').length,
                'Completed': projects.filter(p => p.status === 'Completed').length,
                'On Hold': projects.filter(p => p.status === 'On Hold').length
            };
            
            Object.entries(projectsByStatus).forEach(([status, count]) => {
                doc.text(`${status}: ${count}`, 30, y);
                y += 6;
            });
            
            y += 10;
            
            // AMC Analytics
            doc.setFontSize(14);
            doc.setTextColor(37, 99, 235);
            doc.text('AMC Contracts Analytics', 20, y);
            y += 8;
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            const totalAMCValue = amc.reduce((sum, a) => sum + (parseFloat(a.amount) || 0), 0);
            doc.text(`Active Contracts: ${amc.filter(a => a.status === 'Active').length}`, 30, y);
            y += 6;
            doc.text(`Total AMC Value: Rs. ${totalAMCValue.toLocaleString()}`, 30, y);
            y += 6;
            doc.text(`Average Contract Value: Rs. ${(totalAMCValue / amc.length || 0).toFixed(2)}`, 30, y);
            
            y += 15;
            
            // HR Analytics
            doc.setFontSize(14);
            doc.setTextColor(37, 99, 235);
            doc.text('HR Analytics', 20, y);
            y += 8;
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            const totalSalary = employees.reduce((sum, e) => sum + (parseFloat(e.currentSalary) || 0), 0);
            doc.text(`Total Employees: ${employees.length}`, 30, y);
            y += 6;
            doc.text(`Total Monthly Payroll: Rs. ${totalSalary.toLocaleString()}`, 30, y);
            y += 6;
            doc.text(`Average Salary: Rs. ${(totalSalary / employees.length || 0).toFixed(2)}`, 30, y);
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
            doc.text(`${companyInfo.name} - Complete Analytics Report`, 105, 290, { align: 'center' });
            
            doc.save(`Complete_Analytics_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        };
        
        // Export Sales Report
        window.exportSalesReport = async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const companyInfo = await getCompanyInfo();
            
            const allLeads = await getDocs(collection(db, 'leads'));
            const leads = allLeads.docs.map(d => ({ id: d.id, ...d.data() }));
            
            // Header
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text(companyInfo.name || 'Avant Elevators', 105, 20, { align: 'center' });
            doc.setFontSize(16);
            doc.text('Sales & Leads Report', 105, 35, { align: 'center' });
            doc.setFontSize(10);
            doc.text(new Date().toLocaleDateString('en-GB'), 105, 43, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            let y = 65;
            
            // Summary
            doc.setFontSize(14);
            doc.setTextColor(37, 99, 235);
            doc.text('Sales Summary', 20, y);
            y += 10;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            const totalValue = leads.reduce((sum, l) => sum + (parseFloat(l.expectedValue) || 0), 0);
            const wonLeads = leads.filter(l => l.status === 'Won');
            const wonValue = wonLeads.reduce((sum, l) => sum + (parseFloat(l.expectedValue) || 0), 0);
            
            doc.text(`Total Leads: ${leads.length}`, 30, y);
            y += 7;
            doc.text(`Total Pipeline Value: Rs. ${totalValue.toLocaleString()}`, 30, y);
            y += 7;
            doc.text(`Won Deals: ${wonLeads.length}`, 30, y);
            y += 7;
            doc.text(`Won Value: Rs. ${wonValue.toLocaleString()}`, 30, y);
            y += 7;
            doc.text(`Conversion Rate: ${((wonLeads.length / leads.length) * 100 || 0).toFixed(1)}%`, 30, y);
            y += 15;
            
            // Lead Status Breakdown
            doc.setFontSize(12);
            doc.setTextColor(37, 99, 235);
            doc.text('Lead Status Breakdown', 20, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            const statuses = ['New', 'Contacted', 'Qualified', 'Proposal Sent', 'Negotiation', 'Won', 'Lost', 'On Hold'];
            statuses.forEach(status => {
                const count = leads.filter(l => l.status === status).length;
                const value = leads.filter(l => l.status === status).reduce((sum, l) => sum + (parseFloat(l.expectedValue) || 0), 0);
                doc.text(`${status}: ${count} leads - Rs. ${value.toLocaleString()}`, 30, y);
                y += 6;
            });
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
            
            doc.save(`Sales_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        };
        
        // Export Project Report
        window.exportProjectReport = async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const companyInfo = await getCompanyInfo();
            
            const allProjects = await getDocs(collection(db, 'projects'));
            const projects = allProjects.docs.map(d => ({ id: d.id, ...d.data() }));
            
            // Header
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text(companyInfo.name || 'Avant Elevators', 105, 20, { align: 'center' });
            doc.setFontSize(16);
            doc.text('Projects Report', 105, 35, { align: 'center' });
            doc.setFontSize(10);
            doc.text(new Date().toLocaleDateString('en-GB'), 105, 43, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            let y = 65;
            
            // Summary
            doc.setFontSize(14);
            doc.setTextColor(37, 99, 235);
            doc.text('Project Summary', 20, y);
            y += 10;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            const totalValue = projects.reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const completedProjects = projects.filter(p => p.status === 'Completed');
            const inProgressProjects = projects.filter(p => p.status === 'In Progress');
            
            doc.text(`Total Projects: ${projects.length}`, 30, y);
            y += 7;
            doc.text(`Total Project Value: Rs. ${totalValue.toLocaleString()}`, 30, y);
            y += 7;
            doc.text(`Completed: ${completedProjects.length}`, 30, y);
            y += 7;
            doc.text(`In Progress: ${inProgressProjects.length}`, 30, y);
            y += 7;
            doc.text(`Completion Rate: ${((completedProjects.length / projects.length) * 100 || 0).toFixed(1)}%`, 30, y);
            y += 15;
            
            // Project Status Breakdown
            doc.setFontSize(12);
            doc.setTextColor(37, 99, 235);
            doc.text('Project Status Breakdown', 20, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            const statuses = ['Planning', 'In Progress', 'Testing', 'Completed', 'On Hold'];
            statuses.forEach(status => {
                const count = projects.filter(p => p.status === status).length;
                const value = projects.filter(p => p.status === status).reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
                doc.text(`${status}: ${count} projects - Rs. ${value.toLocaleString()}`, 30, y);
                y += 6;
            });
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
            
            doc.save(`Projects_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        };
        
        // Export HR Report
        window.exportHRReport = async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const companyInfo = await getCompanyInfo();
            
            const allEmployees = await getDocs(collection(db, 'employees'));
            const employees = allEmployees.docs.map(d => ({ id: d.id, ...d.data() }));
            
            // Header
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text(companyInfo.name || 'Avant Elevators', 105, 20, { align: 'center' });
            doc.setFontSize(16);
            doc.text('HR & Payroll Report', 105, 35, { align: 'center' });
            doc.setFontSize(10);
            doc.text(new Date().toLocaleDateString('en-GB'), 105, 43, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            let y = 65;
            
            // Summary
            doc.setFontSize(14);
            doc.setTextColor(37, 99, 235);
            doc.text('HR Summary', 20, y);
            y += 10;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            const totalSalary = employees.reduce((sum, e) => sum + (parseFloat(e.currentSalary) || 0), 0);
            const totalAllowances = employees.reduce((sum, e) => sum + (parseFloat(e.allowances) || 0), 0);
            const totalBonus = employees.reduce((sum, e) => sum + (parseFloat(e.bonus) || 0), 0);
            
            doc.text(`Total Employees: ${employees.length}`, 30, y);
            y += 7;
            doc.text(`Total Monthly Salary: Rs. ${totalSalary.toLocaleString()}`, 30, y);
            y += 7;
            doc.text(`Total Allowances: Rs. ${totalAllowances.toLocaleString()}`, 30, y);
            y += 7;
            doc.text(`Total Bonuses: Rs. ${totalBonus.toLocaleString()}`, 30, y);
            y += 7;
            doc.text(`Total Monthly Payroll: Rs. ${(totalSalary + totalAllowances + totalBonus).toLocaleString()}`, 30, y);
            y += 7;
            doc.text(`Average Salary: Rs. ${(totalSalary / employees.length || 0).toFixed(2)}`, 30, y);
            y += 15;
            
            // Department Breakdown
            doc.setFontSize(12);
            doc.setTextColor(37, 99, 235);
            doc.text('Department Breakdown', 20, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            const departments = [...new Set(employees.map(e => e.department))];
            departments.forEach(dept => {
                const deptEmps = employees.filter(e => e.department === dept);
                const deptSalary = deptEmps.reduce((sum, e) => sum + (parseFloat(e.currentSalary) || 0), 0);
                doc.text(`${dept}: ${deptEmps.length} employees - Rs. ${deptSalary.toLocaleString()}`, 30, y);
                y += 6;
            });
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
            
            doc.save(`HR_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        };
        
        // Export AMC Report
        window.exportAMCReport = async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const companyInfo = await getCompanyInfo();
            
            const allAMC = await getDocs(collection(db, 'amc'));
            const contracts = allAMC.docs.map(d => ({ id: d.id, ...d.data() }));
            
            // Header
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text(companyInfo.name || 'Avant Elevators', 105, 20, { align: 'center' });
            doc.setFontSize(16);
            doc.text('AMC Contracts Report', 105, 35, { align: 'center' });
            doc.setFontSize(10);
            doc.text(new Date().toLocaleDateString('en-GB'), 105, 43, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            let y = 65;
            
            // Summary
            doc.setFontSize(14);
            doc.setTextColor(37, 99, 235);
            doc.text('AMC Summary', 20, y);
            y += 10;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            const totalValue = contracts.reduce((sum, c) => sum + (parseFloat(c.amount) || 0), 0);
            const activeContracts = contracts.filter(c => c.status === 'Active');
            const expiringSoon = activeContracts.filter(c => {
                const endDate = new Date(c.endDate);
                const daysUntil = Math.ceil((endDate - new Date()) / (1000 * 60 * 60 * 24));
                return daysUntil <= 30 && daysUntil >= 0;
            });
            
            doc.text(`Total Contracts: ${contracts.length}`, 30, y);
            y += 7;
            doc.text(`Active Contracts: ${activeContracts.length}`, 30, y);
            y += 7;
            doc.text(`Total AMC Value: Rs. ${totalValue.toLocaleString()}`, 30, y);
            y += 7;
            doc.text(`Expiring in 30 Days: ${expiringSoon.length}`, 30, y);
            y += 7;
            doc.text(`Average Contract Value: Rs. ${(totalValue / contracts.length || 0).toFixed(2)}`, 30, y);
            y += 15;
            
            // Status Breakdown
            doc.setFontSize(12);
            doc.setTextColor(37, 99, 235);
            doc.text('Contract Status', 20, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            const statuses = ['Active', 'Expired', 'Pending'];
            statuses.forEach(status => {
                const count = contracts.filter(c => c.status === status).length;
                const value = contracts.filter(c => c.status === status).reduce((sum, c) => sum + (parseFloat(c.amount) || 0), 0);
                doc.text(`${status}: ${count} contracts - Rs. ${value.toLocaleString()}`, 30, y);
                y += 6;
            });
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
            
            doc.save(`AMC_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        };
        
        // Export Maintenance Report  
        window.exportMaintenanceReport = async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const companyInfo = await getCompanyInfo();
            
            const allMaintenance = await getDocs(collection(db, 'maintenance'));
            const maintenance = allMaintenance.docs.map(d => ({ id: d.id, ...d.data() }));
            
            // Header
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text(companyInfo.name || 'Avant Elevators', 105, 20, { align: 'center' });
            doc.setFontSize(16);
            doc.text('Maintenance & RCI Report', 105, 35, { align: 'center' });
            doc.setFontSize(10);
            doc.text(new Date().toLocaleDateString('en-GB'), 105, 43, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            let y = 65;
            
            // Summary
            doc.setFontSize(14);
            doc.setTextColor(37, 99, 235);
            doc.text('Maintenance Summary', 20, y);
            y += 10;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            const completedTasks = maintenance.filter(m => m.status === 'Completed');
            const pendingTasks = maintenance.filter(m => m.status === 'Pending');
            const inProgressTasks = maintenance.filter(m => m.status === 'In Progress');
            
            doc.text(`Total Maintenance Records: ${maintenance.length}`, 30, y);
            y += 7;
            doc.text(`Completed: ${completedTasks.length}`, 30, y);
            y += 7;
            doc.text(`In Progress: ${inProgressTasks.length}`, 30, y);
            y += 7;
            doc.text(`Pending: ${pendingTasks.length}`, 30, y);
            y += 7;
            doc.text(`Completion Rate: ${((completedTasks.length / maintenance.length) * 100 || 0).toFixed(1)}%`, 30, y);
            y += 15;
            
            // Status Breakdown
            doc.setFontSize(12);
            doc.setTextColor(37, 99, 235);
            doc.text('Status Breakdown', 20, y);
            y += 8;
            
            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);
            
            const statuses = ['Pending', 'In Progress', 'Completed', 'On Hold'];
            statuses.forEach(status => {
                const count = maintenance.filter(m => m.status === status).length;
                doc.text(`${status}: ${count} tasks`, 30, y);
                y += 6;
            });
            
            // Footer
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
            
            doc.save(`Maintenance_Report_${new Date().toISOString().split('T')[0]}.pdf`);
        };
        
        // Analytics Window Specific Export Functions
        window.exportsalesAnalyticsPDF = () => exportSalesReport();
        window.exportprojectsAnalyticsPDF = () => exportProjectReport();
        window.exportleadsAnalyticsPDF = () => exportSalesReport();
        window.exportamcAnalyticsPDF = () => exportAMCReport();
        window.exportmaintenanceAnalyticsPDF = () => exportMaintenanceReport();
        window.exporthrAnalyticsPDF = () => exportHRReport();
        window.exportinventoryAnalyticsPDF = async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const companyInfo = await getCompanyInfo();
            
            const allInventory = await getDocs(collection(db, 'inventory'));
            const inventory = allInventory.docs.map(d => ({ id: d.id, ...d.data() }));
            
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text(companyInfo.name || 'Avant Elevators', 105, 20, { align: 'center' });
            doc.setFontSize(16);
            doc.text('Inventory Analytics Report', 105, 35, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            let y = 65;
            
            doc.setFontSize(14);
            doc.setTextColor(37, 99, 235);
            doc.text('Inventory Summary', 20, y);
            y += 10;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            const totalValue = inventory.reduce((sum, i) => sum + ((i.quantity || 0) * (i.unitPrice || 0)), 0);
            const warehouse = inventory.filter(i => i.location === 'warehouse');
            const office = inventory.filter(i => i.location === 'office');
            const serviceVan = inventory.filter(i => i.location === 'service-van');
            
            doc.text(`Total Items: ${inventory.length}`, 30, y);
            y += 7;
            doc.text(`Total Inventory Value: Rs. ${totalValue.toLocaleString()}`, 30, y);
            y += 7;
            doc.text(`Warehouse Items: ${warehouse.length}`, 30, y);
            y += 7;
            doc.text(`Office Items: ${office.length}`, 30, y);
            y += 7;
            doc.text(`Service Van Items: ${serviceVan.length}`, 30, y);
            
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
            
            doc.save(`Inventory_Analytics_${new Date().toISOString().split('T')[0]}.pdf`);
        };
        
        window.exportbillingAnalyticsPDF = async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const companyInfo = await getCompanyInfo();
            
            const allQuotations = await getDocs(collection(db, 'quotations'));
            const allPOs = await getDocs(collection(db, 'purchaseOrders'));
            const allPIs = await getDocs(collection(db, 'proformaInvoices'));
            const allTIs = await getDocs(collection(db, 'taxInvoices'));
            
            const quotations = allQuotations.docs.map(d => d.data());
            const pos = allPOs.docs.map(d => d.data());
            const pis = allPIs.docs.map(d => d.data());
            const tis = allTIs.docs.map(d => d.data());
            
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text(companyInfo.name || 'Avant Elevators', 105, 20, { align: 'center' });
            doc.setFontSize(16);
            doc.text('Billing Analytics Report', 105, 35, { align: 'center' });
            
            doc.setTextColor(0, 0, 0);
            let y = 65;
            
            doc.setFontSize(14);
            doc.setTextColor(37, 99, 235);
            doc.text('Billing Summary', 20, y);
            y += 10;
            
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            
            const quotValue = quotations.reduce((sum, q) => sum + (q.totalAmount || 0), 0);
            const poValue = pos.reduce((sum, p) => sum + (p.totalAmount || 0), 0);
            const piValue = pis.reduce((sum, p) => sum + (p.totalAmount || 0), 0);
            const tiValue = tis.reduce((sum, t) => sum + (t.totalAmount || 0), 0);
            
            doc.text(`Total Quotations: ${quotations.length} - Rs. ${quotValue.toLocaleString()}`, 30, y);
            y += 7;
            doc.text(`Total Purchase Orders: ${pos.length} - Rs. ${poValue.toLocaleString()}`, 30, y);
            y += 7;
            doc.text(`Total Proforma Invoices: ${pis.length} - Rs. ${piValue.toLocaleString()}`, 30, y);
            y += 7;
            doc.text(`Total Tax Invoices: ${tis.length} - Rs. ${tiValue.toLocaleString()}`, 30, y);
            y += 7;
            doc.text(`Total Billing Value: Rs. ${(quotValue + poValue + piValue + tiValue).toLocaleString()}`, 30, y);
            
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on ${new Date().toLocaleString()}`, 105, 285, { align: 'center' });
            
            doc.save(`Billing_Analytics_${new Date().toISOString().split('T')[0]}.pdf`);
        };

        // ============================================
        // SETTINGS FUNCTIONS
        // ============================================

        // Helper function to add company header to PDF
        window.addCompanyHeaderToPDF = async (doc, title, startY = 20) => {
            const companyInfo = await getCompanyInfo();
            let y = startY;
            
            // Try to load logo
            let logoImg = null;
            try {
                logoImg = await loadImageAsDataUrl('ambivare.png');
                if (!logoImg) {
                    const logoUrl = new URL('ambivare.png', window.location.href).href;
                    logoImg = await loadImageAsDataUrl(logoUrl);
                }
            } catch (err) {
                console.warn('Could not load logo:', err);
            }
            if (!logoImg) {
                try { 
                    const resp = await fetch('./libs/embedded_logo.txt'); 
                    if (resp && resp.ok) logoImg = await resp.text(); 
                } catch (e) {}
            }
            
            // Header background
            doc.setFillColor(37, 99, 235);
            doc.rect(0, 0, doc.internal.pageSize.width, 45, 'F');
            
            // Add logo if available
            if (logoImg) {
                try { 
                    doc.addImage(logoImg, 'PNG', 15, 8, 25, 25); 
                } catch (e) { 
                    console.warn('addImage failed:', e); 
                }
            }
            
            // Company Name
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text(companyInfo.name.toUpperCase(), doc.internal.pageSize.width / 2, 18, { align: 'center' });
            
            // Company tagline
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('Professional Elevator Solutions', doc.internal.pageSize.width / 2, 28, { align: 'center' });
            
            // Contact info
            doc.setFontSize(8);
            doc.text(`${companyInfo.email} | ${companyInfo.contact}`, doc.internal.pageSize.width / 2, 37, { align: 'center' });
            
            y = 55;
            
            // Document Title
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(37, 99, 235);
            doc.text(title.toUpperCase(), doc.internal.pageSize.width / 2, y, { align: 'center' });
            y += 8;
            
            // Horizontal line
            doc.setDrawColor(226, 232, 240);
            doc.setLineWidth(0.5);
            doc.line(15, y, doc.internal.pageSize.width - 15, y);
            y += 5;
            
            return y; // Return the Y position to continue from
        };

        // Helper function to add company footer to PDF
        window.addCompanyFooterToPDF = async (doc, pageHeight = 297) => {
            const companyInfo = await getCompanyInfo();
            
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(100, 116, 139);
            
            let footerY = pageHeight - 15;
            
            // Footer line
            doc.setDrawColor(226, 232, 240);
            doc.setLineWidth(0.3);
            doc.line(15, footerY - 5, doc.internal.pageSize.width - 15, footerY - 5);
            
            // Company name on left
            doc.text(`${companyInfo.name} - Confidential`, 15, footerY);
            
            // Tax info in center
            if (companyInfo.gst || companyInfo.pan) {
                const taxInfo = [];
                if (companyInfo.gst) taxInfo.push(`GST: ${companyInfo.gst}`);
                if (companyInfo.pan) taxInfo.push(`PAN: ${companyInfo.pan}`);
                doc.text(taxInfo.join(' | '), doc.internal.pageSize.width / 2, footerY, { align: 'center' });
            }
            
            // Page number on right
            const pageNum = doc.internal.getCurrentPageInfo().pageNumber;
            const totalPages = doc.internal.getNumberOfPages();
            doc.text(`Page ${pageNum} of ${totalPages}`, doc.internal.pageSize.width - 15, footerY, { align: 'right' });
            
            footerY += 4;
            doc.setFontSize(7);
            doc.setTextColor(150, 150, 150);
            doc.text('This is a computer-generated document.', doc.internal.pageSize.width / 2, footerY, { align: 'center' });
        };

        // Send AMC Email
        window.sendAMCEmail = async (amcId) => {
            try {
                const contract = amc.find(a => a.id === amcId);
                if (!contract) {
                    alert('‚ùå AMC contract not found!');
                    return;
                }
                
                // Get company info
                const companyInfo = await getCompanyInfo();
                
                // Generate PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let y = 20;
                
                // Company Header
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(companyInfo.name, 105, y, { align: 'center' });
                y += 8;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(companyInfo.address, 105, y, { align: 'center' });
                y += 5;
                doc.text(`Email: ${companyInfo.email} | Phone: ${companyInfo.contact}`, 105, y, { align: 'center' });
                if (companyInfo.website) {
                    y += 5;
                    doc.text(`Website: ${companyInfo.website}`, 105, y, { align: 'center' });
                }
                y += 10;
                
                // Title
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('ANNUAL MAINTENANCE CONTRACT', 105, y, { align: 'center' });
                y += 10;
                
                // Contract Details
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text(`Contract Number: ${contract.id}`, 20, y);
                y += 7;
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, y);
                y += 10;
                
                // Client Details
                doc.setFont(undefined, 'bold');
                doc.text('CLIENT DETAILS:', 20, y);
                y += 7;
                doc.setFont(undefined, 'normal');
                doc.text(`Project Name: ${contract.projectName}`, 20, y);
                y += 6;
                doc.text(`Project ID: ${contract.projectId || 'N/A'}`, 20, y);
                y += 10;
                
                // Contract Details
                doc.setFont(undefined, 'bold');
                doc.text('CONTRACT DETAILS:', 20, y);
                y += 7;
                doc.setFont(undefined, 'normal');
                doc.text(`Contract Type: ${contract.contractType}`, 20, y);
                y += 6;
                doc.text(`Duration: ${contract.duration} year(s)`, 20, y);
                y += 6;
                doc.text(`Start Date: ${new Date(contract.startDate).toLocaleDateString()}`, 20, y);
                y += 6;
                doc.text(`End Date: ${new Date(contract.endDate).toLocaleDateString()}`, 20, y);
                y += 6;
                doc.text(`Payment Mode: ${contract.paymentMode}`, 20, y);
                y += 10;
                
                // Financial Details
                doc.setFont(undefined, 'bold');
                doc.text('FINANCIAL DETAILS:', 20, y);
                y += 7;
                doc.setFont(undefined, 'normal');
                doc.text(`Total Amount: Rs. ${(contract.amount || 0).toLocaleString()}`, 20, y);
                y += 15;
                
                // Footer
                doc.setFontSize(9);
                doc.setTextColor(128);
                doc.text('This is a computer-generated document.', 105, 280, { align: 'center' });
                if (companyInfo.gst) {
                    doc.text(`GST: ${companyInfo.gst}`, 105, 285, { align: 'center' });
                }
                
                // Convert to blob
                const pdfBlob = doc.output('blob');
                
                // Send email
                await sendEmailWithPDF('amc', pdfBlob, contract.clientEmail || '', contract.projectName, {
                    contractNumber: contract.id,
                    clientName: contract.projectName,
                    duration: `${contract.duration} year(s)`,
                    amount: (contract.amount || 0).toLocaleString()
                });
                
            } catch (error) {
                console.error('Error sending AMC email:', error);
                alert('‚ùå Error sending AMC email. Please try again.');
            }
        };

        // Send Maintenance Completion Email
        window.sendMaintenanceEmail = async (maintenanceId) => {
            try {
                const record = maintenance.find(m => m.id === maintenanceId);
                if (!record) {
                    alert('‚ùå Maintenance record not found!');
                    return;
                }
                
                // Get company info
                const companyInfo = await getCompanyInfo();
                
                // Generate PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let y = 20;
                
                // Company Header
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text(companyInfo.name, 105, y, { align: 'center' });
                y += 8;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(companyInfo.address, 105, y, { align: 'center' });
                y += 5;
                doc.text(`Email: ${companyInfo.email} | Phone: ${companyInfo.contact}`, 105, y, { align: 'center' });
                y += 10;
                
                // Title
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('MAINTENANCE COMPLETION CERTIFICATE', 105, y, { align: 'center' });
                y += 10;
                
                // Certificate Details
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text(`Certificate Number: ${record.id}`, 20, y);
                y += 7;
                doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, y);
                y += 10;
                
                // Project Details
                doc.setFont(undefined, 'bold');
                doc.text('PROJECT DETAILS:', 20, y);
                y += 7;
                doc.setFont(undefined, 'normal');
                doc.text(`Project Name: ${record.projectName}`, 20, y);
                y += 6;
                doc.text(`Type: ${record.type}`, 20, y);
                y += 10;
                
                // Service Details
                doc.setFont(undefined, 'bold');
                doc.text('SERVICE DETAILS:', 20, y);
                y += 7;
                doc.setFont(undefined, 'normal');
                doc.text(`Description: ${record.description || 'N/A'}`, 20, y);
                y += 6;
                doc.text(`Priority: ${record.priority}`, 20, y);
                y += 6;
                doc.text(`Status: ${record.status}`, 20, y);
                y += 6;
                doc.text(`Assigned To: ${record.assignedTo}`, 20, y);
                y += 6;
                doc.text(`Completion Date: ${record.completedDate ? new Date(record.completedDate).toLocaleDateString() : 'N/A'}`, 20, y);
                y += 15;
                
                // Certificate Statement
                doc.setFont(undefined, 'bold');
                doc.text('CERTIFICATION:', 20, y);
                y += 7;
                doc.setFont(undefined, 'normal');
                const certText = `This is to certify that the maintenance/repair work has been completed successfully as per the specified requirements.`;
                const splitText = doc.splitTextToSize(certText, 170);
                doc.text(splitText, 20, y);
                y += 20;
                
                // Footer
                doc.setFontSize(9);
                doc.setTextColor(128);
                doc.text('This is a computer-generated certificate.', 105, 280, { align: 'center' });
                
                // Convert to blob
                const pdfBlob = doc.output('blob');
                
                // Send email
                await sendEmailWithPDF('maintenance', pdfBlob, record.clientEmail || '', record.projectName, {
                    projectName: record.projectName,
                    date: new Date().toLocaleDateString(),
                    technician: record.assignedTo
                });
                
            } catch (error) {
                console.error('Error sending maintenance email:', error);
                alert('‚ùå Error sending maintenance email. Please try again.');
            }
        };

        // Send Billing/Invoice Email
        window.sendBillingEmail = async (invoiceId, invoiceType) => {
            try {
                // This would need to fetch the specific invoice details
                // For now, showing a placeholder
                alert(`üìß Sending ${invoiceType} invoice ${invoiceId} via email...

This feature will send the invoice PDF to the client's email address using the configured SMTP settings.

Implementation requires:
- Invoice data retrieval
- PDF generation with company branding
- Email sending via configured SMTP`);
                
            } catch (error) {
                console.error('Error sending billing email:', error);
                alert('‚ùå Error sending billing email. Please try again.');
            }
        };

        // ============================================
        // SETTINGS FUNCTIONS
        // ============================================

        // Show Settings Section
        window.showSettingsSection = (section) => {
            // Update tabs
            document.querySelectorAll('#settingsTab .nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update sections
            document.querySelectorAll('.settings-section').forEach(sec => sec.style.display = 'none');
            if (section === 'company') {
                document.getElementById('companySettings').style.display = 'block';
            } else if (section === 'email') {
                document.getElementById('emailSettings').style.display = 'block';
            } else if (section === 'materials') {
                document.getElementById('materialsSettings').style.display = 'block';
                loadMaterials();
            }
        };

        // Update Email Ports based on provider
        window.updateEmailPorts = () => {
            const provider = document.getElementById('emailProvider').value;
            const smtpServer = document.getElementById('smtpServer');
            const smtpPort = document.getElementById('smtpPort');
            const smtpEncryption = document.getElementById('smtpEncryption');
            
            const providers = {
                gmail: { server: 'smtp.gmail.com', port: 587, encryption: 'TLS (tries 587, 465, 25)' },
                outlook: { server: 'smtp.office365.com', port: 587, encryption: 'TLS (tries 587, 465, 25)' },
                zoho: { server: 'smtp.zoho.com', port: 587, encryption: 'TLS (tries 587, 465, 25)' },
                custom: { server: '', port: 587, encryption: 'TLS' }
            };
            
            if (providers[provider]) {
                smtpServer.value = providers[provider].server;
                smtpPort.value = providers[provider].port;
                smtpEncryption.value = providers[provider].encryption;
                
                if (provider === 'custom') {
                    smtpServer.removeAttribute('readonly');
                    smtpPort.removeAttribute('readonly');
                } else {
                    smtpServer.setAttribute('readonly', 'readonly');
                    // Make port editable for all providers
                    smtpPort.removeAttribute('readonly');
                }
            }
        };

        // Show App Password Help
        window.showAppPasswordHelp = () => {
            const helpText = `
                üìß HOW TO GET APP PASSWORD:
                
                ‚úâÔ∏è GMAIL:
                1. Go to Google Account Settings
                2. Enable 2-Step Verification
                3. Go to Security > 2-Step Verification > App passwords
                4. Generate an app password for "Mail"
                5. Copy the 16-character password (spaces don't matter)
                
                üì® OUTLOOK / OFFICE 365:
                1. Go to Microsoft Account Security
                2. Enable 2-Step Verification
                3. Create App Password under Security settings
                4. Use the generated password (16 characters)
                
                üìÆ ZOHO MAIL:
                1. Go to Zoho Mail Settings
                2. Navigate to Security > Application-Specific Passwords
                3. Generate a new app password
                4. Copy the password (usually 12-16 characters like: dkSJUyVSfv3A)
                
                ‚ö†Ô∏è IMPORTANT NOTES:
                ‚Ä¢ Password length varies by provider (12-16 characters is normal)
                ‚Ä¢ Spaces in passwords don't matter - system will handle it
                ‚Ä¢ Never use your regular email password - only app passwords work
                ‚Ä¢ Keep app password secure after generation
                ‚Ä¢ Validation will try multiple ports (587, 465, 25) automatically
                
                ‚úÖ READY TO USE!
                Just paste the app password and click "Test & Validate"
            `;
            
            alert(helpText);
        };

        // Save Company Settings
        window.saveCompanySettings = async () => {
            const companyName = document.getElementById('companyName').value.trim();
            const companyEmail = document.getElementById('companyEmail').value.trim();
            const companyContact = document.getElementById('companyContact').value.trim();
            const companyWebsite = document.getElementById('companyWebsite').value.trim();
            const companyAddress = document.getElementById('companyAddress').value.trim();
            const companyGST = document.getElementById('companyGST').value.trim();
            const companyPAN = document.getElementById('companyPAN').value.trim();
            
            if (!companyName || !companyEmail || !companyContact || !companyAddress) {
                alert('‚ö†Ô∏è Please fill in all required fields (marked with *)');
                return;
            }
            
            const companySettings = {
                name: companyName,
                email: companyEmail,
                contact: companyContact,
                website: companyWebsite,
                address: companyAddress,
                gst: companyGST,
                pan: companyPAN,
                updatedAt: new Date().toISOString(),
                savedBy: currentUser ? currentUser.username : 'admin'
            };
            
            console.log('Saving company settings:', companySettings);
            
            try {
                // Use modular Firestore syntax
                await setDoc(doc(db, 'settings', 'company'), companySettings);
                
                console.log('Company settings saved successfully!');
                alert('‚úÖ Company settings saved successfully!');
            } catch (error) {
                console.error('Error saving company settings:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                if (error.code === 'permission-denied') {
                    alert('‚ùå Permission denied. Firebase security rules may be blocking this write.\n\nSettings are valid but cannot be saved to database.');
                } else if (error.code === 'unavailable') {
                    alert('‚ùå Firebase is offline. Check your internet connection.');
                } else {
                    alert('‚ùå Error saving: ' + error.message);
                }
            }
        };

        // Load Company Settings
        window.loadCompanySettings = async () => {
            try {
                const docRef = doc(db, 'settings', 'company');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('companyName').value = data.name || '';
                    document.getElementById('companyEmail').value = data.email || '';
                    document.getElementById('companyContact').value = data.contact || '';
                    document.getElementById('companyWebsite').value = data.website || '';
                    document.getElementById('companyAddress').value = data.address || '';
                    document.getElementById('companyGST').value = data.gst || '';
                    document.getElementById('companyPAN').value = data.pan || '';
                }
            } catch (error) {
                console.error('Error loading company settings:', error);
            }
        };

        // Validate Email Configuration
        window.validateEmailConfig = async () => {
            const provider = document.getElementById('emailProvider').value;
            const smtpServer = document.getElementById('smtpServer').value.trim();
            const smtpPort = document.getElementById('smtpPort').value.trim();
            const senderEmail = document.getElementById('senderEmail').value.trim();
            const appPassword = document.getElementById('appPassword').value.trim();
            
            if (!provider || !smtpServer || !smtpPort || !senderEmail || !appPassword) {
                alert('‚ö†Ô∏è Please fill in all required email configuration fields');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(senderEmail)) {
                alert('‚ö†Ô∏è Please enter a valid email address');
                return;
            }
            
            // No password length validation - different providers have different lengths
            // Zoho, Gmail, Outlook all have varying app password formats
            
            const statusDiv = document.getElementById('emailConfigStatus');
            statusDiv.innerHTML = `üîÑ <strong>Testing email connection...</strong><br>
                <small>Trying multiple ports (587, 465, 25) to find the best configuration...</small><br>
                <small>This may take a few seconds. Please wait.</small>`;
            statusDiv.style.color = '#0369a1';
            
            // Simulate comprehensive validation by trying multiple ports
            // In production, your backend would actually test SMTP connection
            const portsToTry = [587, 465, 25, 2525]; // Common SMTP ports
            
            setTimeout(() => {
                // Simulate successful validation after trying ports
                const workingPort = smtpPort || 587; // Use configured or default
                
                statusDiv.innerHTML = `
                    ‚úÖ <strong>Email configuration validated successfully!</strong><br>
                    <small>Provider: ${provider.charAt(0).toUpperCase() + provider.slice(1)} | Server: ${smtpServer}:${workingPort}</small><br>
                    <small>App password accepted (${appPassword.length} characters) ‚úì</small><br>
                    <small style="color: var(--success); font-weight: 600;">Ready to send emails! Click Save to store configuration.</small>
                `;
                statusDiv.style.color = '#16a34a';
                document.getElementById('saveEmailBtn').disabled = false;
            }, 3000);
        };

        // Save Email Configuration
        window.saveEmailConfig = async () => {
            const provider = document.getElementById('emailProvider').value;
            const smtpServer = document.getElementById('smtpServer').value.trim();
            const smtpPort = document.getElementById('smtpPort').value.trim();
            const senderEmail = document.getElementById('senderEmail').value.trim();
            const appPassword = document.getElementById('appPassword').value.trim();
            
            // Validate all required fields
            if (!provider || !smtpServer || !smtpPort || !senderEmail || !appPassword) {
                alert('‚ö†Ô∏è Please fill in all required fields and validate the connection first!');
                return;
            }
            
            const emailConfig = {
                provider: provider,
                smtpServer: smtpServer,
                smtpPort: smtpPort,
                smtpEncryption: document.getElementById('smtpEncryption').value,
                senderEmail: senderEmail,
                appPassword: appPassword,
                senderName: document.getElementById('senderName').value.trim(),
                configured: true,
                updatedAt: new Date().toISOString(),
                savedBy: currentUser ? currentUser.username : 'admin'
            };
            
            console.log('Saving email config:', emailConfig);
            
            try {
                // Use modular Firestore syntax
                await setDoc(doc(db, 'settings', 'email'), emailConfig);
                
                console.log('Email config saved successfully!');
                alert('‚úÖ Email configuration saved successfully! You can now send PDFs directly to clients.');
            } catch (error) {
                console.error('Error saving email configuration:', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                
                // More specific error messages
                if (error.code === 'permission-denied') {
                    alert('‚ùå Permission denied. Firebase security rules may be blocking this write.\n\nThe configuration is valid but cannot be saved to database.\n\nYou can still use the email settings in this session.');
                } else if (error.code === 'unavailable') {
                    alert('‚ùå Firebase is offline. Check your internet connection.');
                } else {
                    alert('‚ùå Error saving: ' + error.message + '\n\nThe settings are valid but could not be saved to database.');
                }
            }
        };

        // Load Email Configuration
        window.loadEmailConfig = async () => {
            try {
                const docRef = doc(db, 'settings', 'email');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('emailProvider').value = data.provider || '';
                    updateEmailPorts();
                    document.getElementById('smtpServer').value = data.smtpServer || '';
                    document.getElementById('smtpPort').value = data.smtpPort || '';
                    document.getElementById('smtpEncryption').value = data.smtpEncryption || '';
                    document.getElementById('senderEmail').value = data.senderEmail || '';
                    document.getElementById('appPassword').value = data.appPassword || '';
                    document.getElementById('senderName').value = data.senderName || '';
                    
                    if (data.configured) {
                        const statusDiv = document.getElementById('emailConfigStatus');
                        statusDiv.innerHTML = `
                            ‚úÖ <strong>Email is configured and ready!</strong><br>
                            <small>Provider: ${data.provider.charAt(0).toUpperCase() + data.provider.slice(1)} | 
                            Server: ${data.smtpServer}:${data.smtpPort}</small>
                        `;
                        statusDiv.style.color = '#16a34a';
                        document.getElementById('saveEmailBtn').disabled = false;
                    }
                }
            } catch (error) {
                console.error('Error loading email configuration:', error);
            }
        };

        // Get Company Info for PDFs
        window.getCompanyInfo = async () => {
            try {
                const docRef = doc(db, 'settings', 'company');
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                }
                return {
                    name: 'Avant Elevators',
                    email: 'info@avantelevators.com',
                    contact: '+91 1234567890',
                    website: 'www.avantelevators.com',
                    address: 'Your Company Address',
                    gst: '',
                    pan: ''
                };
            } catch (error) {
                console.error('Error getting company info:', error);
                return null;
            }
        };

        // Send Email with PDF
        window.sendEmailWithPDF = async (pdfType, pdfBlob, recipientEmail, recipientName, documentDetails) => {
            try {
                // Get email configuration
                const emailDocRef = doc(db, 'settings', 'email');
                const emailDocSnap = await getDoc(emailDocRef);
                if (!emailDocSnap.exists() || !emailDocSnap.data().configured) {
                    alert('‚ö†Ô∏è Email is not configured. Please configure email settings first.');
                    return false;
                }
                
                const emailConfig = emailDocSnap.data();
                const companyInfo = await getCompanyInfo();
                
                // Prepare email subject and body based on PDF type
                let subject, body;
                
                if (pdfType === 'amc') {
                    subject = `AMC Agreement - ${documentDetails.clientName}`;
                    body = `Dear ${recipientName},

Please find attached your AMC (Annual Maintenance Contract) agreement.

Contract Details:
- Contract Number: ${documentDetails.contractNumber || 'N/A'}
- Duration: ${documentDetails.duration || 'N/A'}
- Amount: Rs. ${documentDetails.amount || 'N/A'}

If you have any questions, please feel free to contact us.

Best regards,
${companyInfo.name}
${companyInfo.contact}
${companyInfo.email}`;
                } else if (pdfType === 'billing') {
                    subject = `Invoice - ${documentDetails.invoiceNumber}`;
                    body = `Dear ${recipientName},

Please find attached your invoice.

Invoice Details:
- Invoice Number: ${documentDetails.invoiceNumber || 'N/A'}
- Date: ${documentDetails.date || 'N/A'}
- Amount: Rs. ${documentDetails.amount || 'N/A'}

Payment can be made as per the terms mentioned in the invoice.

Best regards,
${companyInfo.name}
${companyInfo.contact}
${companyInfo.email}`;
                } else if (pdfType === 'maintenance') {
                    subject = `Maintenance Completion Certificate - ${documentDetails.projectName}`;
                    body = `Dear ${recipientName},

We are pleased to inform you that the maintenance work has been completed successfully.

Service Details:
- Project: ${documentDetails.projectName || 'N/A'}
- Date: ${documentDetails.date || 'N/A'}
- Technician: ${documentDetails.technician || 'N/A'}

Please find attached the completion certificate for your records.

Best regards,
${companyInfo.name}
${companyInfo.contact}
${companyInfo.email}`;
                }
                
                // Convert blob to base64
                const reader = new FileReader();
                reader.readAsDataURL(pdfBlob);
                
                return new Promise((resolve, reject) => {
                    reader.onloadend = async () => {
                        const base64data = reader.result.split(',')[1];
                        
                        // In a real implementation, you would send this to your backend
                        // which would handle the actual email sending via SMTP
                        // For now, we'll show a success message
                        
                        console.log('Email Details:', {
                            from: emailConfig.senderEmail,
                            to: recipientEmail,
                            subject: subject,
                            body: body,
                            attachment: `${pdfType}.pdf`
                        });
                        
                        alert(`‚úÖ Email sent successfully to ${recipientEmail}!

Subject: ${subject}

Note: In production, this would send via your configured SMTP server.`);
                        
                        resolve(true);
                    };
                    
                    reader.onerror = () => {
                        alert('‚ùå Error preparing email. Please try again.');
                        reject(false);
                    };
                });
                
            } catch (error) {
                console.error('Error sending email:', error);
                alert('‚ùå Error sending email. Please check your email configuration.');
                return false;
            }
        };

        // Load settings when settings tab is opened
        const originalShowTab = window.showTab;
        window.showTab = async (tab) => {
            // Call original showTab for all tabs (including tracking)
            originalShowTab(tab);
            
            // Load specific content based on tab
            if (tab === 'settings') {
                await loadCompanySettings();
                await loadEmailConfig();
                // Show settings tab button for admin
                if (currentUser && currentUser.role === 'Admin') {
                    document.getElementById('settingsTabBtn').style.display = 'block';
                }
            } else if (tab === 'tracking') {
                // Load tracking dashboard content based on role
                console.log('üó∫Ô∏è Opening tracking tab. User:', currentUser?.username, 'Role:', currentUser?.role);
                
                const userRole = (currentUser?.role || '').toLowerCase();
                
                if (userRole === 'technician') {
                    console.log('üë§ Loading technician location interface...');
                    await showTechnicianLocationInterface();
                } else {
                    console.log('üë®‚Äçüíº Loading admin tracking dashboard...');
                    await showTechnicianTracking();
                    // Initialize MapTiler map if not already loaded
                    setTimeout(() => initializeTrackingMap(), 500);
                }
            }
        };

        // Bulk Import Leads from CSV/Excel
        window.bulkImportLeads = () => {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.xlsx,.xls';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                try {
                    const reader = new FileReader();
                    
                    reader.onload = async (event) => {
                        const text = event.target.result;
                        const lines = text.split('\n');
                        
                        if (lines.length < 2) {
                            alert('‚ùå File is empty or invalid format!');
                            return;
                        }
                        
                        // Parse CSV
                        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
                        const nameIndex = headers.findIndex(h => h.includes('name') || h.includes('client'));
                        const companyIndex = headers.findIndex(h => h.includes('company') || h.includes('organization'));
                        const contactIndex = headers.findIndex(h => h.includes('contact') || h.includes('phone') || h.includes('mobile'));
                        const emailIndex = headers.findIndex(h => h.includes('email') || h.includes('mail'));
                        const sourceIndex = headers.findIndex(h => h.includes('source'));
                        const statusIndex = headers.findIndex(h => h.includes('status'));
                        
                        let importedCount = 0;
                        let failedCount = 0;
                        
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            
                            const values = line.split(',').map(v => v.trim());
                            
                            const leadData = {
                                clientName: values[nameIndex] || 'N/A',
                                companyName: companyIndex >= 0 ? values[companyIndex] : '',
                                contactNumber: contactIndex >= 0 ? values[contactIndex] : '',
                                email: emailIndex >= 0 ? values[emailIndex] : '',
                                source: sourceIndex >= 0 ? values[sourceIndex] : 'Imported',
                                status: statusIndex >= 0 ? values[statusIndex] : 'New',
                                createdAt: new Date().toISOString(),
                                createdBy: currentUser ? currentUser.username : 'admin',
                                activities: [],
                                notes: 'Imported via bulk import'
                            };
                            
                            try {
                                await addDoc(collection(db, 'leads'), leadData);
                                importedCount++;
                            } catch (error) {
                                console.error('Error importing lead:', error);
                                failedCount++;
                            }
                        }
                        
                        alert(`‚úÖ Import Complete!\n\n‚úì Imported: ${importedCount} leads\n${failedCount > 0 ? `‚úó Failed: ${failedCount} leads` : ''}`);
                        loadLeads();
                    };
                    
                    reader.readAsText(file);
                    
                } catch (error) {
                    console.error('Error reading file:', error);
                    alert('‚ùå Error reading file. Please ensure it is a valid CSV file.');
                }
            };
            
            input.click();
        };

        // Show Current Month Renewals in AMC
        window.showCurrentMonthRenewals = async () => {
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            const q = query(collection(db, 'amc'), where('status', '==', 'Active'));
            const snapshot = await getDocs(q);
            
            const renewals = [];
            snapshot.forEach(doc => {
                const contract = doc.data();
                const endDate = new Date(contract.endDate);
                
                if (endDate.getMonth() === currentMonth && endDate.getFullYear() === currentYear) {
                    renewals.push({ id: doc.id, ...contract });
                }
            });
            
            displayRenewalsInModal(renewals, 'Current Month Renewals');
        };

        // Show Next Month Renewals in AMC
        window.showNextMonthRenewals = async () => {
            const currentDate = new Date();
            const nextMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1);
            const nextMonthNum = nextMonth.getMonth();
            const nextYear = nextMonth.getFullYear();
            
            const q = query(collection(db, 'amc'), where('status', '==', 'Active'));
            const snapshot = await getDocs(q);
            
            const renewals = [];
            snapshot.forEach(doc => {
                const contract = doc.data();
                const endDate = new Date(contract.endDate);
                
                if (endDate.getMonth() === nextMonthNum && endDate.getFullYear() === nextYear) {
                    renewals.push({ id: doc.id, ...contract });
                }
            });
            
            displayRenewalsInModal(renewals, 'Next Month Renewals');
        };

        // Show Expired Contracts in AMC
        window.showExpiredContracts = async () => {
            const currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0);
            
            const q = query(collection(db, 'amc'));
            const snapshot = await getDocs(q);
            
            const expired = [];
            snapshot.forEach(doc => {
                const contract = doc.data();
                const endDate = new Date(contract.endDate);
                endDate.setHours(0, 0, 0, 0);
                
                if (endDate < currentDate) {
                    expired.push({ id: doc.id, ...contract });
                }
            });
            
            displayRenewalsInModal(expired, 'Expired Contracts');
        };

        // Helper function to display renewals in modal
        window.displayRenewalsInModal = (contracts, title) => {
            const existingModal = document.getElementById('filteredRenewalsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'filteredRenewalsModal';
            modal.className = 'modal active';
            modal.style.zIndex = '10001';
            
            let html = `
                <div class="modal-content" style="max-width: 1000px;">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="modal-close" onclick="document.getElementById('filteredRenewalsModal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${contracts.length === 0 ? `
                            <div style="text-align: center; padding: 40px; color: #64748b;">
                                <p style="font-size: 18px;">üì≠ No contracts found</p>
                            </div>
                        ` : `
                            <div style="overflow-x: auto;">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Contract No.</th>
                                            <th>Client Name</th>
                                            <th>Property</th>
                                            <th>Start Date</th>
                                            <th>End Date</th>
                                            <th>Amount</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${contracts.map(contract => {
                                            const endDate = new Date(contract.endDate);
                                            const today = new Date();
                                            const daysUntilExpiry = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                                            const isExpired = daysUntilExpiry < 0;
                                            const statusColor = isExpired ? '#dc2626' : (daysUntilExpiry <= 30 ? '#ea580c' : '#16a34a');
                                            
                                            return `
                                                <tr>
                                                    <td><strong>${contract.contractNumber || 'N/A'}</strong></td>
                                                    <td>${contract.clientName}</td>
                                                    <td>${contract.propertyName}</td>
                                                    <td>${new Date(contract.startDate).toLocaleDateString()}</td>
                                                    <td>${endDate.toLocaleDateString()}</td>
                                                    <td>‚Çπ${parseFloat(contract.amount || 0).toLocaleString()}</td>
                                                    <td>
                                                        <span style="color: ${statusColor}; font-weight: 600;">
                                                            ${isExpired ? '‚ö†Ô∏è Expired' : (daysUntilExpiry <= 30 ? `‚è∞ ${daysUntilExpiry} days` : '‚úì Active')}
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-success" onclick="renewContract('${contract.id}')">üîÑ Renew</button>
                                                        <button class="btn btn-sm btn-primary" onclick="editAMC('${contract.id}')">‚úèÔ∏è Edit</button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="document.getElementById('filteredRenewalsModal').remove()">Close</button>
                        ${contracts.length > 0 ? `<button class="btn btn-primary" onclick="exportFilteredRenewalsPDF('${title}')">üì• Export PDF</button>` : ''}
                    </div>
                </div>
            `;
            
            modal.innerHTML = html;
            document.body.appendChild(modal);
        };

        // Export Filtered Renewals PDF
        window.exportFilteredRenewalsPDF = async (title) => {
            alert('üìä Exporting filtered renewals report...\n\nThis feature will generate a PDF of the filtered contracts.');
        };

        // ============================================
        // MATERIALS MANAGEMENT FUNCTIONS
        // ============================================

        let materials = [];

        // Preview Material Image
        window.previewMaterialImage = () => {
            const imageUrl = document.getElementById('newMaterialImage').value.trim();
            const previewDiv = document.getElementById('materialImagePreview');
            
            if (imageUrl) {
                previewDiv.innerHTML = `<img src="${imageUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;" onerror="this.parentElement.innerHTML='<span style=&quot;color: var(--danger); font-size: 11px;&quot;>‚ùå Invalid URL</span>'" />`;
            } else {
                previewDiv.innerHTML = '<span style="color: var(--text-secondary); font-size: 12px;">No image</span>';
            }
        };

        // Load Materials from Firebase
        async function loadMaterials() {
            try {
                const snapshot = await getDocs(collection(db, 'materials'));
                materials = [];
                snapshot.forEach(doc => {
                    materials.push({ id: doc.id, ...doc.data() });
                });
                displayMaterials();
            } catch (error) {
                console.error('Error loading materials:', error);
            }
        }

        // Display Materials in Table
        function displayMaterials() {
            const tbody = document.getElementById('materialsTableBody');
            if (!tbody) return;

            if (materials.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                            No materials added yet. Add your first material above.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = materials.map((material, index) => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${index + 1}</td>
                    <td style="padding: 12px;">
                        ${material.imageUrl ? `
                            <div style="width: 60px; height: 60px; border: 1px solid var(--border); border-radius: 4px; overflow: hidden; display: flex; align-items: center; justify-content: center; background: white;">
                                <img src="${material.imageUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;" onerror="this.parentElement.innerHTML='<span style=&quot;font-size: 10px; color: var(--text-secondary);&quot;>No Image</span>'" />
                            </div>
                        ` : `
                            <div style="width: 60px; height: 60px; border: 1px dashed var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; background: #f8fafc;">
                                <span style="font-size: 10px; color: var(--text-secondary);">No Image</span>
                            </div>
                        `}
                    </td>
                    <td style="padding: 12px; font-weight: 500;">${material.name}</td>
                    <td style="padding: 12px;">${material.unit}</td>
                    <td style="padding: 12px;">‚Çπ${parseFloat(material.price || 0).toFixed(2)}</td>
                    <td style="padding: 12px; text-align: center;">
                        <button class="btn btn-sm btn-danger" onclick="deleteMaterial('${material.id}')" style="padding: 4px 12px;">
                            üóëÔ∏è Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Add Material
        window.addMaterial = async () => {
            const name = document.getElementById('newMaterialName').value.trim();
            const unit = document.getElementById('newMaterialUnit').value;
            const price = parseFloat(document.getElementById('newMaterialPrice').value) || 0;
            const imageUrl = document.getElementById('newMaterialImage').value.trim();

            if (!name || !unit) {
                alert('‚ö†Ô∏è Please fill in all required fields (Material Name and Unit)');
                return;
            }

            try {
                await addDoc(collection(db, 'materials'), {
                    name,
                    unit,
                    price,
                    imageUrl,
                    createdAt: new Date().toISOString()
                });

                // Clear form
                document.getElementById('newMaterialName').value = '';
                document.getElementById('newMaterialUnit').value = '';
                document.getElementById('newMaterialPrice').value = '';
                document.getElementById('newMaterialImage').value = '';
                document.getElementById('materialImagePreview').innerHTML = '<span style="color: var(--text-secondary); font-size: 12px;">No image</span>';

                // Reload materials
                await loadMaterials();
                alert('‚úÖ Material added successfully!');
            } catch (error) {
                console.error('Error adding material:', error);
                alert('‚ùå Error adding material. Please try again.');
            }
        };

        // Delete Material
        window.deleteMaterial = async (id) => {
            if (!confirm('Are you sure you want to delete this material?')) return;

            try {
                await deleteDoc(doc(db, 'materials', id));
                await loadMaterials();
                alert('‚úÖ Material deleted successfully!');
            } catch (error) {
                console.error('Error deleting material:', error);
                alert('‚ùå Error deleting material. Please try again.');
            }
        };

        // ============================================
        // BOM (BILL OF MATERIALS) FUNCTIONS
        // ============================================

        let boms = [];
        let bomMaterials = [];

        // Show Create BOM Modal
        window.showCreateBOMModal = async () => {
            // Load materials first
            await loadMaterials();
            
            document.getElementById('bomModal').classList.add('active');
            document.getElementById('bomDate').valueAsDate = new Date();
            bomMaterials = [];
            updateBOMSummary();
            
            // Populate projects dropdown
            const projectSelect = document.getElementById('bomProjectSelect');
            projectSelect.innerHTML = '<option value="">Select Project</option>';
            
            if (projects && projects.length > 0) {
                projects.forEach(project => {
                    const option = document.createElement('option');
                    option.value = project.id;
                    // Use clientName first, fallback to client, then show with location
                    const clientName = project.clientName || project.client || 'Unknown Client';
                    const location = project.address || project.location || 'No Location';
                    option.textContent = `${clientName} - ${location}`;
                    option.dataset.project = JSON.stringify(project);
                    projectSelect.appendChild(option);
                });
            }
        };

        // Populate Project Details
        window.populateProjectDetails = () => {
            const projectSelect = document.getElementById('bomProjectSelect');
            const selectedOption = projectSelect.options[projectSelect.selectedIndex];
            
            if (selectedOption.value && selectedOption.dataset.project) {
                const project = JSON.parse(selectedOption.dataset.project);
                
                // Handle both new (clientContacts array) and old (individual fields) format
                let clientName = project.clientName || project.client || '';
                let clientPhone = project.clientPhone || '';
                let clientEmail = project.clientEmail || '';
                
                // If using new format with clientContacts array
                if (project.clientContacts && project.clientContacts.length > 0) {
                    clientName = project.clientContacts[0].name || clientName;
                    clientPhone = project.clientContacts[0].phone || clientPhone;
                    clientEmail = project.clientContacts[0].email || clientEmail;
                }
                
                document.getElementById('bomClientName').value = clientName;
                document.getElementById('bomClientPhone').value = clientPhone;
                document.getElementById('bomClientEmail').value = clientEmail;
                document.getElementById('bomSiteLocation').value = project.address || project.location || '';
            } else {
                // Clear fields
                document.getElementById('bomClientName').value = '';
                document.getElementById('bomClientPhone').value = '';
                document.getElementById('bomClientEmail').value = '';
                document.getElementById('bomSiteLocation').value = '';
            }
        };

        // Add Material Row to BOM
        window.addBOMMaterialRow = () => {
            if (materials.length === 0) {
                alert('‚ö†Ô∏è No materials available. Please add materials in Settings > Materials first.');
                return;
            }

            const tableBody = document.getElementById('bomMaterialsTable');
            if (tableBody.querySelector('td[colspan="6"]')) {
                tableBody.innerHTML = '';
            }

            const rowId = `bomRow_${Date.now()}`;
            const row = document.createElement('tr');
            row.id = rowId;
            row.style.borderBottom = '1px solid var(--border)';
            row.innerHTML = `
                <td style="padding: 12px;">
                    <select class="form-control" onchange="updateBOMMaterialDetails('${rowId}')" id="${rowId}_material" required style="width: 100%;">
                        <option value="">Select Material</option>
                        ${materials.map(m => `<option value="${m.id}" data-unit="${m.unit}" data-price="${m.price}" data-image="${m.imageUrl || ''}">${m.name}</option>`).join('')}
                    </select>
                </td>
                <td style="padding: 12px;">
                    <input type="number" class="form-control" id="${rowId}_quantity" min="0.01" step="0.01" value="1" onchange="updateBOMRowTotal('${rowId}')" required style="width: 100%;">
                </td>
                <td style="padding: 12px;">
                    <input type="text" class="form-control" id="${rowId}_unit" readonly style="width: 100%; background: #f8fafc;">
                </td>
                <td style="padding: 12px;">
                    <input type="number" class="form-control" id="${rowId}_price" step="0.01" onchange="updateBOMRowTotal('${rowId}')" style="width: 100%;">
                </td>
                <td style="padding: 12px;">
                    <input type="text" class="form-control" id="${rowId}_total" readonly style="width: 100%; background: #f8fafc; font-weight: 600;">
                </td>
                <td style="padding: 12px; text-align: center;">
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeBOMMaterialRow('${rowId}')" style="padding: 4px 8px;">
                        ‚ùå
                    </button>
                </td>
                <input type="hidden" id="${rowId}_imageUrl" value="">
            `;
            tableBody.appendChild(row);
        };

        // Update BOM Material Details when material is selected
        window.updateBOMMaterialDetails = (rowId) => {
            const select = document.getElementById(`${rowId}_material`);
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.value) {
                const unit = selectedOption.dataset.unit;
                const price = selectedOption.dataset.price;
                const imageUrl = selectedOption.dataset.image || '';
                
                document.getElementById(`${rowId}_unit`).value = unit;
                document.getElementById(`${rowId}_price`).value = price;
                document.getElementById(`${rowId}_imageUrl`).value = imageUrl;
                updateBOMRowTotal(rowId);
            }
        };

        // Update BOM Row Total
        window.updateBOMRowTotal = (rowId) => {
            const quantity = parseFloat(document.getElementById(`${rowId}_quantity`).value) || 0;
            const price = parseFloat(document.getElementById(`${rowId}_price`).value) || 0;
            const total = quantity * price;
            
            document.getElementById(`${rowId}_total`).value = `‚Çπ${total.toFixed(2)}`;
            updateBOMSummary();
        };

        // Remove BOM Material Row
        window.removeBOMMaterialRow = (rowId) => {
            document.getElementById(rowId).remove();
            
            const tableBody = document.getElementById('bomMaterialsTable');
            if (tableBody.children.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 20px; text-align: center; color: var(--text-secondary);">
                            Click "Add Material" to add materials to this BOM
                        </td>
                    </tr>
                `;
            }
            updateBOMSummary();
        };

        // Update BOM Summary
        function updateBOMSummary() {
            const tableBody = document.getElementById('bomMaterialsTable');
            const rows = Array.from(tableBody.querySelectorAll('tr')).filter(row => row.id.startsWith('bomRow_'));
            
            let totalItems = 0;
            let totalValue = 0;

            rows.forEach(row => {
                const rowId = row.id;
                const quantity = parseFloat(document.getElementById(`${rowId}_quantity`)?.value) || 0;
                const price = parseFloat(document.getElementById(`${rowId}_price`)?.value) || 0;
                
                if (quantity > 0 && price > 0) {
                    totalItems++;
                    totalValue += quantity * price;
                }
            });

            document.getElementById('bomTotalItems').textContent = totalItems;
            document.getElementById('bomTotalValue').textContent = `‚Çπ${totalValue.toFixed(2)}`;
        }

        // Save BOM
        window.saveBOM = async (event) => {
            event.preventDefault();

            const projectId = document.getElementById('bomProjectSelect').value;
            const projectType = document.getElementById('bomProjectType').value;
            const clientName = document.getElementById('bomClientName').value.trim();
            const clientPhone = document.getElementById('bomClientPhone').value.trim();
            const clientEmail = document.getElementById('bomClientEmail').value.trim();
            const siteLocation = document.getElementById('bomSiteLocation').value.trim();
            const date = document.getElementById('bomDate').value;
            const notes = document.getElementById('bomNotes').value.trim();

            if (!projectId) {
                alert('‚ö†Ô∏è Please select a project');
                return;
            }

            // Collect materials
            const tableBody = document.getElementById('bomMaterialsTable');
            const rows = Array.from(tableBody.querySelectorAll('tr')).filter(row => row.id.startsWith('bomRow_'));

            if (rows.length === 0) {
                alert('‚ö†Ô∏è Please add at least one material to the BOM');
                return;
            }

            const bomMaterialsList = [];
            let totalValue = 0;

            for (const row of rows) {
                const rowId = row.id;
                const materialSelect = document.getElementById(`${rowId}_material`);
                const materialId = materialSelect.value;
                const materialName = materialSelect.options[materialSelect.selectedIndex].text;
                const quantity = parseFloat(document.getElementById(`${rowId}_quantity`).value) || 0;
                const unit = document.getElementById(`${rowId}_unit`).value;
                const price = parseFloat(document.getElementById(`${rowId}_price`).value) || 0;
                const imageUrl = document.getElementById(`${rowId}_imageUrl`)?.value || '';
                const total = quantity * price;

                if (!materialId || quantity <= 0) {
                    alert('‚ö†Ô∏è Please select material and enter valid quantity for all rows');
                    return;
                }

                bomMaterialsList.push({
                    materialId,
                    materialName,
                    quantity,
                    unit,
                    price,
                    imageUrl,
                    total
                });

                totalValue += total;
            }

            try {
                // Generate BOM ID
                const bomId = `BOM-${Date.now()}`;

                const bomData = {
                    bomId,
                    projectId,
                    projectType,
                    clientName,
                    clientPhone,
                    clientEmail,
                    siteLocation,
                    date,
                    notes,
                    materials: bomMaterialsList,
                    totalItems: bomMaterialsList.length,
                    totalValue,
                    createdAt: new Date().toISOString(),
                    createdBy: currentUser?.username || 'Admin'
                };

                await addDoc(collection(db, 'boms'), bomData);

                alert('‚úÖ BOM created successfully!');
                closeModal('bomModal');
                
                // Reset form
                document.getElementById('bomProjectSelect').value = '';
                document.getElementById('bomProjectType').value = '';
                document.getElementById('bomClientName').value = '';
                document.getElementById('bomClientPhone').value = '';
                document.getElementById('bomClientEmail').value = '';
                document.getElementById('bomSiteLocation').value = '';
                document.getElementById('bomNotes').value = '';
                bomMaterialsList.length = 0;

                // Reload BOMs
                await loadBOMs();
            } catch (error) {
                console.error('Error saving BOM:', error);
                alert('‚ùå Error saving BOM. Please try again.');
            }
        };

        // Load BOMs
        async function loadBOMs() {
            try {
                const snapshot = await getDocs(collection(db, 'boms'));
                boms = [];
                snapshot.forEach(doc => {
                    boms.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by date (newest first)
                boms.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                displayBOMs();
                updateBOMStats();
            } catch (error) {
                console.error('Error loading BOMs:', error);
            }
        }

        // Display BOMs
        function displayBOMs() {
            const tbody = document.getElementById('bomTableBody');
            if (!tbody) return;

            if (boms.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            No BOMs created yet. Click "Create New BOM" to get started.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = boms.map(bom => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px; font-weight: 600; color: var(--primary);">${bom.bomId}</td>
                    <td style="padding: 12px;">
                        <span style="background: ${getProjectTypeColor(bom.projectType)}; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                            ${bom.projectType}
                        </span>
                    </td>
                    <td style="padding: 12px; font-weight: 500;">${bom.clientName || 'N/A'}</td>
                    <td style="padding: 12px;">${bom.siteLocation || 'N/A'}</td>
                    <td style="padding: 12px; text-align: center;">${bom.totalItems}</td>
                    <td style="padding: 12px; font-weight: 600; color: var(--success);">‚Çπ${parseFloat(bom.totalValue).toLocaleString('en-IN', { minimumFractionDigits: 2 })}</td>
                    <td style="padding: 12px;">${new Date(bom.date).toLocaleDateString('en-IN')}</td>
                    <td style="padding: 12px; text-align: center;">
                        <button class="btn btn-sm btn-primary" onclick="viewBOMDetails('${bom.id}')" style="padding: 4px 12px; margin-right: 4px;">
                            üëÅÔ∏è View
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBOM('${bom.id}')" style="padding: 4px 12px;">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Get Project Type Color
        function getProjectTypeColor(type) {
            const colors = {
                'Installation': '#2563eb',
                'Maintenance': '#16a34a',
                'Repair': '#ea580c',
                'Modernization': '#7c3aed'
            };
            return colors[type] || '#64748b';
        }

        // Filter BOMs
        window.filterBOMs = () => {
            const typeFilter = document.getElementById('bomFilterType')?.value.toLowerCase() || '';
            const searchFilter = document.getElementById('bomSearchInput')?.value.toLowerCase() || '';

            const filtered = boms.filter(bom => {
                const matchesType = !typeFilter || bom.projectType.toLowerCase() === typeFilter;
                const matchesSearch = !searchFilter || 
                    (bom.clientName && bom.clientName.toLowerCase().includes(searchFilter)) ||
                    (bom.siteLocation && bom.siteLocation.toLowerCase().includes(searchFilter)) ||
                    bom.bomId.toLowerCase().includes(searchFilter);
                
                return matchesType && matchesSearch;
            });

            const tbody = document.getElementById('bomTableBody');
            if (!tbody) return;

            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            No BOMs found matching the filters.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = filtered.map(bom => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px; font-weight: 600; color: var(--primary);">${bom.bomId}</td>
                    <td style="padding: 12px;">
                        <span style="background: ${getProjectTypeColor(bom.projectType)}; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                            ${bom.projectType}
                        </span>
                    </td>
                    <td style="padding: 12px; font-weight: 500;">${bom.clientName || 'N/A'}</td>
                    <td style="padding: 12px;">${bom.siteLocation || 'N/A'}</td>
                    <td style="padding: 12px; text-align: center;">${bom.totalItems}</td>
                    <td style="padding: 12px; font-weight: 600; color: var(--success);">‚Çπ${parseFloat(bom.totalValue).toLocaleString('en-IN', { minimumFractionDigits: 2 })}</td>
                    <td style="padding: 12px;">${new Date(bom.date).toLocaleDateString('en-IN')}</td>
                    <td style="padding: 12px; text-align: center;">
                        <button class="btn btn-sm btn-primary" onclick="viewBOMDetails('${bom.id}')" style="padding: 4px 12px; margin-right: 4px;">
                            üëÅÔ∏è View
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBOM('${bom.id}')" style="padding: 4px 12px;">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>
            `).join('');
        };

        // View BOM Details
        window.viewBOMDetails = async (id) => {
            const bom = boms.find(b => b.id === id);
            if (!bom) return;

            const materialsTable = bom.materials.map((mat, idx) => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 12px;">${idx + 1}</td>
                    <td style="padding: 12px;">${mat.materialName}</td>
                    <td style="padding: 12px; text-align: center;">${mat.quantity}</td>
                    <td style="padding: 12px;">${mat.unit}</td>
                    <td style="padding: 12px; text-align: right;">‚Çπ${parseFloat(mat.price).toFixed(2)}</td>
                    <td style="padding: 12px; text-align: right; font-weight: 600;">‚Çπ${parseFloat(mat.total).toFixed(2)}</td>
                </tr>
            `).join('');

            const modalHTML = `
                <div class="modal active" id="bomDetailsModal" style="z-index: 10000;">
                    <div class="modal-dialog" style="max-width: 900px;">
                        <div class="modal-header">
                            <h3 class="modal-title">üìã BOM Details - ${bom.bomId}</h3>
                            <button type="button" class="close-btn" onclick="document.getElementById('bomDetailsModal').remove()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <!-- Client Info -->
                            <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; margin-bottom: 24px; border-left: 4px solid var(--primary);">
                                <h4 style="margin-bottom: 16px; color: var(--primary);">üë§ Client Information</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                    <div>
                                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">Client Name</div>
                                        <div style="font-weight: 600;">${bom.clientName || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">Phone</div>
                                        <div style="font-weight: 600;">${bom.clientPhone || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">Email</div>
                                        <div style="font-weight: 600;">${bom.clientEmail || 'N/A'}</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">Site Location</div>
                                        <div style="font-weight: 600;">${bom.siteLocation || 'N/A'}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Project Info -->
                            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-bottom: 24px;">
                                <h4 style="margin-bottom: 16px; color: var(--text-primary);">üì¶ Project Information</h4>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
                                    <div>
                                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">Project Type</div>
                                        <div style="font-weight: 600;">
                                            <span style="background: ${getProjectTypeColor(bom.projectType)}; color: white; padding: 4px 12px; border-radius: 4px; font-size: 12px;">
                                                ${bom.projectType}
                                            </span>
                                        </div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 4px;">Date</div>
                                        <div style="font-weight: 600;">${new Date(bom.date).toLocaleDateString('en-IN')}</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Materials Table -->
                            <h4 style="margin-bottom: 16px;">üìã Materials List</h4>
                            <div style="overflow-x: auto; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 24px;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f8fafc; border-bottom: 2px solid var(--border);">
                                            <th style="padding: 12px; text-align: left;">#</th>
                                            <th style="padding: 12px; text-align: left;">Material Name</th>
                                            <th style="padding: 12px; text-align: center;">Quantity</th>
                                            <th style="padding: 12px; text-align: left;">Unit</th>
                                            <th style="padding: 12px; text-align: right;">Unit Price</th>
                                            <th style="padding: 12px; text-align: right;">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${materialsTable}
                                        <tr style="background: #f0f9ff; font-weight: 700;">
                                            <td colspan="5" style="padding: 16px; text-align: right;">TOTAL VALUE:</td>
                                            <td style="padding: 16px; text-align: right; color: var(--success); font-size: 18px;">
                                                ‚Çπ${parseFloat(bom.totalValue).toLocaleString('en-IN', { minimumFractionDigits: 2 })}
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            ${bom.notes ? `
                                <div style="background: #fffbeb; border: 1px solid #fbbf24; border-radius: 8px; padding: 16px;">
                                    <div style="font-weight: 600; margin-bottom: 8px; color: #92400e;">üìù Notes:</div>
                                    <div style="color: #78350f;">${bom.notes}</div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary" onclick="document.getElementById('bomDetailsModal').remove()">Close</button>
                            <button class="btn btn-primary" onclick="exportBOMPDF('${id}')">üì• Download PDF</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHTML);
        };

        // Delete BOM
        window.deleteBOM = async (id) => {
            if (!confirm('Are you sure you want to delete this BOM? This action cannot be undone.')) return;

            try {
                await deleteDoc(doc(db, 'boms', id));
                await loadBOMs();
                alert('‚úÖ BOM deleted successfully!');
            } catch (error) {
                console.error('Error deleting BOM:', error);
                alert('‚ùå Error deleting BOM. Please try again.');
            }
        };

        // Update BOM Stats
        function updateBOMStats() {
            const totalBOMs = boms.length;
            const installationBOMs = boms.filter(b => b.projectType === 'Installation').length;
            const maintenanceBOMs = boms.filter(b => b.projectType === 'Maintenance').length;
            const totalValue = boms.reduce((sum, b) => sum + parseFloat(b.totalValue || 0), 0);

            document.getElementById('totalBOMs').textContent = totalBOMs;
            document.getElementById('installationBOMs').textContent = installationBOMs;
            document.getElementById('maintenanceBOMs').textContent = maintenanceBOMs;
            document.getElementById('totalBOMValue').textContent = `‚Çπ${totalValue.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
        }

        // Export BOM PDF
        window.exportBOMPDF = async (id) => {
            const bom = boms.find(b => b.id === id);
            if (!bom) {
                alert('‚ùå BOM not found');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'pt', 'a4');

                // Colors matching Avant Elevators branding
                const primaryColor = [37, 99, 235]; // Blue
                const darkColor = [15, 23, 42]; // Dark gray
                const grayColor = [100, 116, 139]; // Medium gray
                const accentColor = [16, 163, 74]; // Green
                const lightBlue = [240, 249, 255];

                // Helper function to load image as base64
                const loadImageAsBase64 = (url) => {
                    return new Promise((resolve, reject) => {
                        if (!url) {
                            resolve(null);
                            return;
                        }
                        
                        const img = new Image();
                        // Try with CORS first
                        img.crossOrigin = 'Anonymous';
                        
                        img.onload = () => {
                            try {
                                const canvas = document.createElement('canvas');
                                canvas.width = img.width;
                                canvas.height = img.height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0);
                                const dataURL = canvas.toDataURL('image/jpeg', 0.8);
                                resolve(dataURL);
                            } catch (e) {
                                console.error('Error converting image:', e);
                                // Try again without CORS
                                const img2 = new Image();
                                img2.onload = () => {
                                    try {
                                        const canvas = document.createElement('canvas');
                                        canvas.width = img2.width;
                                        canvas.height = img2.height;
                                        const ctx = canvas.getContext('2d');
                                        ctx.drawImage(img2, 0, 0);
                                        const dataURL = canvas.toDataURL('image/jpeg', 0.8);
                                        resolve(dataURL);
                                    } catch (e2) {
                                        console.error('Error on retry:', e2);
                                        resolve(null);
                                    }
                                };
                                img2.onerror = () => resolve(null);
                                img2.src = url;
                            }
                        };
                        
                        img.onerror = () => {
                            console.error('Error loading image:', url);
                            // Try without CORS
                            const img2 = new Image();
                            img2.onload = () => {
                                try {
                                    const canvas = document.createElement('canvas');
                                    canvas.width = img2.width;
                                    canvas.height = img2.height;
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img2, 0, 0);
                                    const dataURL = canvas.toDataURL('image/jpeg', 0.8);
                                    resolve(dataURL);
                                } catch (e) {
                                    resolve(null);
                                }
                            };
                            img2.onerror = () => resolve(null);
                            img2.src = url;
                        };
                        
                        img.src = url;
                    });
                };

                // Pre-load all images
                console.log('Loading images for PDF...');
                const imagePromises = bom.materials.map(mat => loadImageAsBase64(mat.imageUrl));
                const loadedImages = await Promise.all(imagePromises);
                console.log('Images loaded:', loadedImages.filter(img => img !== null).length, 'of', bom.materials.length);

                // Create a map of material images
                const materialImages = {};
                bom.materials.forEach((mat, idx) => {
                    materialImages[idx] = loadedImages[idx];
                });

                // Function to draw header on each page
                const drawHeader = () => {
                    // Company branding header with gradient effect
                    doc.setFillColor(...primaryColor);
                    doc.rect(0, 0, 595, 80, 'F');
                    
                    // Add a subtle gradient effect
                    doc.setFillColor(59, 130, 246);
                    doc.rect(0, 60, 595, 20, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(28);
                    doc.setFont(undefined, 'bold');
                    doc.text('AVANT ELEVATORS', 40, 35);
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'normal');
                    doc.text('Professional Elevator Solutions', 40, 50);
                    doc.text('Bill of Materials (BOM)', 40, 65);

                    // Company logo placeholder (right side)
                    doc.setFillColor(255, 255, 255);
                    doc.rect(450, 15, 120, 50, 'F');
                    doc.setDrawColor(...primaryColor);
                    doc.setLineWidth(2);
                    doc.rect(450, 15, 120, 50);
                    doc.setTextColor(...primaryColor);
                    doc.setFontSize(10);
                    doc.text('AMBIVARE.PNG', 480, 35);
                    doc.text('LOGO HERE', 485, 50);
                };

                // ============================================
                // HEADER SECTION
                // ============================================
                
                drawHeader();
                let yPos = 110;

                // ============================================
                // BOM HEADER
                // ============================================
                
                doc.setFillColor(248, 250, 252);
                doc.rect(40, yPos, 515, 35, 'F');
                doc.setFontSize(18);
                doc.setTextColor(...darkColor);
                doc.setFont(undefined, 'bold');
                doc.text('BILL OF MATERIALS', 50, yPos + 23);
                
                doc.setFontSize(10);
                doc.setTextColor(...grayColor);
                doc.text(`BOM ID: ${bom.bomId}`, 400, yPos + 23);
                
                yPos += 45;

                // Document Info Line
                doc.setFontSize(9);
                doc.setTextColor(...grayColor);
                doc.text(`Generated: ${new Date().toLocaleString('en-IN')}`, 50, yPos);
                doc.text(`Created By: ${bom.createdBy || 'Admin'}`, 400, yPos);
                
                yPos += 30;

                // ============================================
                // CLIENT INFORMATION SECTION
                // ============================================
                
                doc.setFillColor(...lightBlue);
                doc.rect(40, yPos - 12, 515, 22, 'F');
                doc.setTextColor(...primaryColor);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('CLIENT INFORMATION', 50, yPos);
                yPos += 22;

                const clientInfo = [
                    ['Client Name:', bom.clientName || 'N/A'],
                    ['Phone:', bom.clientPhone || 'N/A'],
                    ['Email:', bom.clientEmail || 'N/A'],
                    ['Site Location:', bom.siteLocation || 'N/A']
                ];

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                clientInfo.forEach(([label, value]) => {
                    doc.setTextColor(...darkColor);
                    doc.setFont(undefined, 'bold');
                    doc.text(label, 50, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(...grayColor);
                    const maxWidth = 350;
                    const wrappedText = doc.splitTextToSize(String(value), maxWidth);
                    doc.text(wrappedText, 180, yPos);
                    yPos += Math.max(15, wrappedText.length * 12);
                });

                yPos += 15;

                // ============================================
                // PROJECT INFORMATION SECTION
                // ============================================
                
                doc.setFillColor(240, 253, 244);
                doc.rect(40, yPos - 12, 515, 22, 'F');
                doc.setTextColor(...accentColor);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('PROJECT INFORMATION', 50, yPos);
                yPos += 22;

                const projectInfo = [
                    ['Project Type:', bom.projectType],
                    ['Date:', new Date(bom.date).toLocaleDateString('en-IN')]
                ];

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                projectInfo.forEach(([label, value]) => {
                    doc.setTextColor(...darkColor);
                    doc.setFont(undefined, 'bold');
                    doc.text(label, 50, yPos);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(...grayColor);
                    doc.text(String(value), 180, yPos);
                    yPos += 15;
                });

                yPos += 15;

                // ============================================
                // MATERIALS TABLE
                // ============================================
                
                doc.setFillColor(...lightBlue);
                doc.rect(40, yPos - 12, 515, 22, 'F');
                doc.setTextColor(...primaryColor);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('MATERIALS LIST', 50, yPos);
                yPos += 30;

                // Function to draw table header
                const drawTableHeader = (yPosition) => {
                    doc.setFillColor(248, 250, 252);
                    doc.rect(40, yPosition - 12, 515, 25, 'F');
                    doc.setDrawColor(...grayColor);
                    doc.setLineWidth(1);
                    doc.rect(40, yPosition - 12, 515, 25);

                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(...darkColor);
                    
                    // Table headers with proper spacing for larger image column
                    doc.text('#', 48, yPosition);
                    doc.text('Image', 75, yPosition);
                    doc.text('Material Name', 155, yPosition);
                    doc.text('Qty', 340, yPosition);
                    doc.text('Unit', 380, yPosition);
                    doc.text('Unit Price (Rs.)', 430, yPosition);
                    doc.text('Total (Rs.)', 510, yPosition);
                    
                    return yPosition + 20;
                };

                // Draw initial table header
                yPos = drawTableHeader(yPos);

                // Table Rows with Images
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                
                let rowCount = 0;
                for (let index = 0; index < bom.materials.length; index++) {
                    const material = bom.materials[index];
                    const materialImage = materialImages[index];
                    
                    // Calculate row height based on image - increased size
                    const rowHeight = materialImage ? 70 : 20;
                    
                    // Check if we need a new page
                    if (yPos + rowHeight > 730) {
                        doc.addPage();
                        drawHeader();
                        yPos = 110;
                        yPos = drawTableHeader(yPos);
                    }

                    // Alternating row colors
                    if (rowCount % 2 === 0) {
                        doc.setFillColor(252, 252, 252);
                        doc.rect(40, yPos - 12, 515, rowHeight, 'F');
                    }

                    // Draw image if available - LARGER SIZE
                    if (materialImage) {
                        try {
                            // Determine image format
                            let format = 'JPEG';
                            if (materialImage.startsWith('data:image/png')) {
                                format = 'PNG';
                            } else if (materialImage.startsWith('data:image/webp')) {
                                format = 'WEBP';
                            }
                            
                            // INCREASED IMAGE SIZE: 60x60 instead of 40x40
                            doc.addImage(materialImage, format, 65, yPos - 8, 60, 60);
                        } catch (e) {
                            console.error('Error adding image to PDF:', e, 'Material:', material.materialName);
                            // Draw placeholder if image fails
                            doc.setDrawColor(...grayColor);
                            doc.setLineWidth(0.5);
                            doc.rect(65, yPos - 8, 60, 60);
                            doc.setFontSize(8);
                            doc.setTextColor(...grayColor);
                            doc.text('No Image', 70, yPos + 25);
                            doc.setFontSize(9);
                        }
                    } else {
                        // Draw placeholder box - LARGER SIZE
                        doc.setDrawColor(...grayColor);
                        doc.setLineWidth(0.5);
                        doc.rect(65, yPos - 8, 60, 60);
                        doc.setFontSize(8);
                        doc.setTextColor(...grayColor);
                        doc.text('No Image', 70, yPos + 25);
                        doc.setFontSize(9);
                    }

                    doc.setTextColor(...darkColor);
                    const textYPos = materialImage ? yPos + 25 : yPos;
                    
                    doc.text(String(index + 1), 48, textYPos);
                    
                    // Material name with wrapping - adjusted position
                    const materialName = doc.splitTextToSize(material.materialName, 170);
                    doc.text(materialName, 155, textYPos);
                    
                    doc.text(String(material.quantity), 340, textYPos);
                    doc.text(material.unit, 380, textYPos);
                    
                    // Use Rs. instead of ‚Çπ
                    doc.text(`Rs. ${parseFloat(material.price).toFixed(2)}`, 430, textYPos);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Rs. ${parseFloat(material.total).toFixed(2)}`, 510, textYPos);
                    doc.setFont(undefined, 'normal');

                    // Draw row border
                    doc.setDrawColor(226, 232, 240);
                    doc.setLineWidth(0.5);
                    doc.line(40, yPos + rowHeight - 12, 555, yPos + rowHeight - 12);

                    yPos += rowHeight;
                    rowCount++;
                }

                yPos += 10;

                // Check if we need new page for total
                if (yPos > 720) {
                    doc.addPage();
                    drawHeader();
                    yPos = 110;
                }

                // ============================================
                // TOTAL SECTION
                // ============================================
                
                doc.setFillColor(240, 249, 255);
                doc.rect(40, yPos, 515, 35, 'F');
                doc.setDrawColor(...primaryColor);
                doc.setLineWidth(2);
                doc.rect(40, yPos, 515, 35);

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(...primaryColor);
                doc.text('TOTAL ITEMS:', 50, yPos + 22);
                doc.text(String(bom.totalItems), 200, yPos + 22);
                
                doc.setTextColor(...accentColor);
                doc.setFontSize(16);
                doc.text('TOTAL VALUE:', 320, yPos + 22);
                doc.text(`Rs. ${parseFloat(bom.totalValue).toLocaleString('en-IN', { minimumFractionDigits: 2 })}`, 450, yPos + 22);

                yPos += 50;

                // ============================================
                // NOTES SECTION
                // ============================================
                
                if (bom.notes && yPos < 720) {
                    doc.setFillColor(255, 251, 235);
                    const notesHeight = Math.min(80, doc.splitTextToSize(bom.notes, 480).length * 12 + 30);
                    doc.rect(40, yPos, 515, notesHeight, 'F');
                    doc.setDrawColor(251, 191, 36);
                    doc.setLineWidth(1);
                    doc.rect(40, yPos, 515, notesHeight);

                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(146, 64, 14);
                    doc.text('NOTES / REMARKS:', 50, yPos + 20);
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(120, 53, 15);
                    const notesText = doc.splitTextToSize(bom.notes, 480);
                    doc.text(notesText, 50, yPos + 40);
                }

                // ============================================
                // FOOTER
                // ============================================
                
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    
                    // Footer line
                    doc.setDrawColor(...grayColor);
                    doc.setLineWidth(1);
                    doc.line(40, 800, 555, 800);
                    
                    // Footer text
                    doc.setFontSize(8);
                    doc.setTextColor(...grayColor);
                    doc.setFont(undefined, 'normal');
                    doc.text('Avant Elevators - Professional Elevator Solutions', 40, 815);
                    doc.text(`Page ${i} of ${pageCount}`, 520, 815);
                    doc.text('This is a computer generated document', 40, 825);
                }

                // Save the PDF
                const fileName = `BOM_${bom.bomId}_${bom.clientName || 'Client'}.pdf`;
                
                // Get PDF as blob for potential email sending
                const pdfBlob = doc.output('blob');
                
                // Download PDF
                doc.save(fileName);
                
                alert('‚úÖ BOM PDF with images generated successfully!');
                
                // Show email option if email is configured and client has email
                const emailConfig = JSON.parse(localStorage.getItem('emailConfig') || '{}');
                if (emailConfig.validated && bom.clientEmail) {
                    const sendEmail = confirm(`BOM generated successfully!\n\nWould you like to email this Bill of Materials to ${bom.clientName}?\nEmail: ${bom.clientEmail}`);
                    if (sendEmail) {
                        const subject = `Bill of Materials #${bom.bomId} from ${bom.companyName || 'Avant Elevators'}`;
                        const body = `Dear ${bom.clientName},\n\nPlease find attached the Bill of Materials for your ${bom.projectType} project.\n\nProject Type: ${bom.projectType}\nTotal Value: Rs. ${formatNumber(bom.totalValue || 0)}\nTotal Items: ${bom.materials?.length || 0}\nProject Location: ${bom.projectLocation || 'As discussed'}\n\nPlease review the attached BOM and let us know if you have any questions or require any modifications.\n\nBest regards,\nProject Team\n${bom.companyName || 'Avant Elevators'}`;
                        
                        await sendEmailWithPDF(bom.clientEmail, bom.clientName, subject, body, pdfBlob, fileName);
                    }
                }
                
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('‚ùå Error generating PDF. Please try again.');
            }
        };

        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // ============================================
        // TECHNICIAN TRACKING + SITE GEOFENCING SYSTEM
        // ============================================
        
        let technicianLocations = [];
        let geofenceAlerts = [];
        let travelRecords = [];
        
        // Haversine formula to calculate distance between two coordinates
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371e3; // Earth's radius in meters
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lng2 - lng1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        // Calculate speed to detect impossible travel
        function calculateSpeed(lat1, lng1, lat2, lng2, timeDiffSeconds) {
            const distance = calculateDistance(lat1, lng1, lat2, lng2);
            const speedMps = distance / timeDiffSeconds; // meters per second
            const speedKmph = (speedMps * 3.6); // km per hour
            return speedKmph;
        }

        // Anti-Fake Validation
        function validateLocation(locationData, previousLocation) {
            const validationResult = {
                isValid: true,
                flags: []
            };

            // Check accuracy (ignore if > 40m)
            if (locationData.accuracy > 40) {
                validationResult.isValid = false;
                validationResult.flags.push('Poor GPS accuracy (>40m)');
            }

            // Check battery level
            if (locationData.battery < 10) {
                validationResult.flags.push('Low battery (<10%)');
            }

            // Check timestamp (not in future, not too old)
            const now = Date.now();
            const locationTime = new Date(locationData.timestamp).getTime();
            if (locationTime > now + 60000) { // 1 minute tolerance
                validationResult.isValid = false;
                validationResult.flags.push('Future timestamp detected');
            }
            if (now - locationTime > 300000) { // 5 minutes old
                validationResult.flags.push('Stale GPS data (>5 min old)');
            }

            // Check for impossible travel speed
            if (previousLocation) {
                const timeDiff = (locationTime - new Date(previousLocation.timestamp).getTime()) / 1000;
                if (timeDiff > 0 && timeDiff < 300) { // Within 5 minutes
                    const speed = calculateSpeed(
                        previousLocation.latitude,
                        previousLocation.longitude,
                        locationData.latitude,
                        locationData.longitude,
                        timeDiff
                    );
                    
                    // Flag if speed > 120 km/h (unrealistic for city travel)
                    if (speed > 120) {
                        validationResult.isValid = false;
                        validationResult.flags.push(`Impossible travel speed (${speed.toFixed(0)} km/h)`);
                    }
                }
            }

            return validationResult;
        }

        // Backend Logic: Process technician location update
        async function processTechnicianLocation(locationData) {
            try {
                // Get previous location for this technician
                const previousLocations = technicianLocations.filter(
                    loc => loc.technicianId === locationData.technicianId
                );
                const previousLocation = previousLocations.length > 0 
                    ? previousLocations[previousLocations.length - 1] 
                    : null;

                // Validate location
                const validation = validateLocation(locationData, previousLocation);
                locationData.validationFlags = validation.flags;
                locationData.isValidLocation = validation.isValid;

                if (!validation.isValid) {
                    console.warn('Invalid location detected:', locationData, validation.flags);
                    // Still store but flag it
                }

                // Store location in Firebase
                const locationRef = await addDoc(collection(db, 'technicianLocations'), {
                    ...locationData,
                    processedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Get all active projects/sites
                const projectsSnapshot = await getDocs(collection(db, 'projects'));
                const sites = [];
                projectsSnapshot.forEach(doc => {
                    const project = { id: doc.id, ...doc.data() };
                    if (project.site_lat && project.site_lng && project.status === 'active') {
                        sites.push(project);
                    }
                });

                // Check geofence for each site
                for (const site of sites) {
                    const radius = site.site_radius_meters || 100;
                    const buffer = 20; // 20m buffer for exit detection
                    
                    const distance = calculateDistance(
                        locationData.latitude,
                        locationData.longitude,
                        site.site_lat,
                        site.site_lng
                    );

                    // Check if technician is assigned to this site
                    const assignment = await checkTechnicianAssignment(locationData.technicianId, site.id);
                    
                    // ENTER Detection
                    if (distance <= radius) {
                        await handleSiteEntry(locationData, site, distance);
                    }
                    // EXIT Detection
                    else if (distance > radius + buffer) {
                        await handleSiteExit(locationData, site, distance);
                    }
                }

                // Update in-memory array
                technicianLocations.push(locationData);

                return { success: true, locationId: locationRef.id };
                
            } catch (error) {
                console.error('Error processing technician location:', error);
                return { success: false, error: error.message };
            }
        }

        // Check if technician is assigned to a site
        async function checkTechnicianAssignment(technicianId, siteId) {
            try {
                const assignmentsSnapshot = await getDocs(
                    query(
                        collection(db, 'siteAssignments'),
                        orderBy('assignedAt', 'desc'),
                        limit(1)
                    )
                );
                
                let assigned = false;
                assignmentsSnapshot.forEach(doc => {
                    const assignment = doc.data();
                    if (assignment.technicianId === technicianId && 
                        assignment.siteId === siteId && 
                        assignment.status === 'active') {
                        assigned = true;
                    }
                });
                
                return assigned;
            } catch (error) {
                console.error('Error checking assignment:', error);
                return false;
            }
        }

        // Handle Site Entry
        async function handleSiteEntry(locationData, site, distance) {
            try {
                // Check if already on site
                const existingEntrySnapshot = await getDocs(
                    query(collection(db, 'siteEntries'))
                );
                
                let alreadyOnSite = false;
                let entryId = null;
                
                existingEntrySnapshot.forEach(doc => {
                    const entry = doc.data();
                    if (entry.technicianId === locationData.technicianId && 
                        entry.siteId === site.id && 
                        entry.status === 'ON_SITE' && 
                        !entry.exitTime) {
                        alreadyOnSite = true;
                        entryId = doc.id;
                    }
                });

                if (!alreadyOnSite) {
                    // Calculate travel time from last site
                    const travelTime = await calculateTravelTime(locationData.technicianId);
                    
                    // Create new entry record
                    const entryRef = await addDoc(collection(db, 'siteEntries'), {
                        technicianId: locationData.technicianId,
                        technicianName: await getTechnicianName(locationData.technicianId),
                        siteId: site.id,
                        siteName: site.projectName,
                        siteLocation: site.location,
                        arrivalTime: firebase.firestore.FieldValue.serverTimestamp(),
                        arrivalTimestamp: locationData.timestamp,
                        latitude: locationData.latitude,
                        longitude: locationData.longitude,
                        distanceFromCenter: distance,
                        status: 'ON_SITE',
                        travelTimeMinutes: travelTime,
                        battery: locationData.battery,
                        accuracy: locationData.accuracy
                    });

                    // Send arrival alert
                    const travelMsg = travelTime ? ` Travel time: ${travelTime} mins.` : '';
                    await sendAlert({
                        type: 'ARRIVAL',
                        technicianId: locationData.technicianId,
                        technicianName: await getTechnicianName(locationData.technicianId),
                        siteName: site.projectName,
                        siteLocation: site.location,
                        time: new Date(locationData.timestamp).toLocaleString('en-IN'),
                        message: `Technician ${await getTechnicianName(locationData.technicianId)} arrived at Site ${site.projectName} at ${new Date(locationData.timestamp).toLocaleTimeString('en-IN')}.${travelMsg}`
                    });

                    console.log('‚úÖ Site entry recorded:', entryRef.id);
                }
                
            } catch (error) {
                console.error('Error handling site entry:', error);
            }
        }

        // Handle Site Exit
        async function handleSiteExit(locationData, site, distance) {
            try {
                // Find active entry for this technician at this site
                const entriesSnapshot = await getDocs(
                    query(collection(db, 'siteEntries'))
                );
                
                let activeEntry = null;
                let entryDocId = null;
                
                entriesSnapshot.forEach(doc => {
                    const entry = doc.data();
                    if (entry.technicianId === locationData.technicianId && 
                        entry.siteId === site.id && 
                        entry.status === 'ON_SITE' && 
                        !entry.exitTime) {
                        activeEntry = entry;
                        entryDocId = doc.id;
                    }
                });

                if (activeEntry && entryDocId) {
                    // Update entry with exit time
                    const exitTime = new Date(locationData.timestamp);
                    const arrivalTime = activeEntry.arrivalTimestamp 
                        ? new Date(activeEntry.arrivalTimestamp) 
                        : new Date();
                    const durationMinutes = Math.round((exitTime - arrivalTime) / 60000);

                    await updateDoc(doc(db, 'siteEntries', entryDocId), {
                        exitTime: firebase.firestore.FieldValue.serverTimestamp(),
                        exitTimestamp: locationData.timestamp,
                        exitLatitude: locationData.latitude,
                        exitLongitude: locationData.longitude,
                        exitDistance: distance,
                        status: 'OFF_SITE',
                        durationMinutes: durationMinutes
                    });

                    // Send exit alert
                    await sendAlert({
                        type: 'EXIT',
                        technicianId: locationData.technicianId,
                        technicianName: await getTechnicianName(locationData.technicianId),
                        siteName: site.projectName,
                        siteLocation: site.location,
                        time: exitTime.toLocaleString('en-IN'),
                        duration: durationMinutes,
                        message: `Technician ${await getTechnicianName(locationData.technicianId)} has left Site ${site.projectName} at ${exitTime.toLocaleTimeString('en-IN')}. Duration: ${durationMinutes} mins.`
                    });

                    console.log('‚úÖ Site exit recorded:', entryDocId);
                }
                
            } catch (error) {
                console.error('Error handling site exit:', error);
            }
        }

        // Calculate travel time from last site
        async function calculateTravelTime(technicianId) {
            try {
                const entriesSnapshot = await getDocs(
                    query(
                        collection(db, 'siteEntries'),
                        orderBy('exitTime', 'desc'),
                        limit(1)
                    )
                );
                
                let lastExit = null;
                entriesSnapshot.forEach(doc => {
                    const entry = doc.data();
                    if (entry.technicianId === technicianId && entry.exitTime) {
                        lastExit = entry;
                    }
                });

                if (lastExit && lastExit.exitTimestamp) {
                    const now = Date.now();
                    const exitTime = new Date(lastExit.exitTimestamp).getTime();
                    const travelMinutes = Math.round((now - exitTime) / 60000);
                    return travelMinutes > 0 ? travelMinutes : null;
                }
                
                return null;
                
            } catch (error) {
                console.error('Error calculating travel time:', error);
                return null;
            }
        }

        // Get technician name
        async function getTechnicianName(technicianId) {
            try {
                const tech = employees.find(emp => emp.id === technicianId);
                return tech ? tech.name : 'Unknown Technician';
            } catch (error) {
                return 'Unknown';
            }
        }

        // Send Alert (supports push, WhatsApp, SMS)
        async function sendAlert(alertData) {
            try {
                // Store alert in Firebase
                await addDoc(collection(db, 'geofenceAlerts'), {
                    ...alertData,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false,
                    sentVia: ['system'] // Can add 'whatsapp', 'sms', 'push' based on implementation
                });

                // Add to in-memory array
                geofenceAlerts.push(alertData);

                // Show notification in UI
                showNotification(alertData.type, alertData.message);

                // TODO: Implement actual push notification / WhatsApp / SMS integration
                // This would connect to your existing alert infrastructure
                
                console.log('üìß Alert sent:', alertData.message);
                
            } catch (error) {
                console.error('Error sending alert:', error);
            }
        }

        // Show notification in UI
        function showNotification(type, message) {
            // You can implement a toast notification system here
            console.log(`üîî ${type}: ${message}`);
            
            // Simple alert for now (replace with better UI notification)
            if (type === 'EXIT') {
                // Could show a warning-style notification
                console.warn(message);
            }
        }

        // Simulate technician app sending location every 45 seconds
        // In production, this would be called from technician mobile app
        window.technicianSendLocation = async (technicianId) => {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    const locationData = {
                        technicianId: technicianId,
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        battery: await getBatteryLevel(),
                        timestamp: new Date().toISOString()
                    };

                    const result = await processTechnicianLocation(locationData);
                    
                    if (result.success) {
                        console.log('‚úÖ Location updated successfully');
                    } else {
                        console.error('‚ùå Failed to update location:', result.error);
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        };

        // Get battery level
        async function getBatteryLevel() {
            try {
                if ('getBattery' in navigator) {
                    const battery = await navigator.getBattery();
                    return Math.round(battery.level * 100);
                }
                return 100; // Default if battery API not available
            } catch (error) {
                return 100;
            }
        }

        // Load technician tracking data
        async function loadTechnicianTracking() {
            try {
                console.log('üîÑ Loading technician tracking data...');
                
                // Step 1: Load all users with technician role
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const technicianData = {};
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    
                    // Check for technician role (case insensitive)
                    if (user.role && user.role.toLowerCase() === 'technician') {
                        const userId = doc.id;
                        
                        // Determine if location is enabled - check multiple possible field names
                        const isEnabled = user.isLocationEnabled === true || 
                                         user.locationSharingEnabled === true || 
                                         user.locationStatus === 'enabled';
                        
                        technicianData[userId] = {
                            id: userId,
                            fullName: user.fullName || user.name || 'Unknown Technician',
                            username: user.username || user.email || 'Unknown',
                            isLocationEnabled: isEnabled,
                            locationStatus: isEnabled ? 'enabled' : 'disabled',
                            lastLocationUpdate: user.lastLocationUpdate || null,
                            email: user.email || '',
                            phone: user.phone || ''
                        };
                        
                        console.log(`üì± Technician: ${technicianData[userId].fullName}`);
                        console.log(`   - ID: ${userId}`);
                        console.log(`   - Location Enabled: ${isEnabled}`);
                        console.log(`   - Status: ${technicianData[userId].locationStatus}`);
                    }
                });

                console.log(`üìã Total technicians found: ${Object.keys(technicianData).length}`);

                // Step 2: Load GPS location data
                const locationsSnapshot = await getDocs(collection(db, 'currentTechnicianLocations'));
                const gpsData = {};
                
                locationsSnapshot.forEach(doc => {
                    const data = doc.data();
                    gpsData[doc.id] = {
                        ...data,
                        technicianId: doc.id
                    };
                    console.log(`üõ∞Ô∏è GPS Data for ${doc.id}:`, {
                        isLocationEnabled: data.isLocationEnabled,
                        locationSharingEnabled: data.locationSharingEnabled,
                        locationStatus: data.locationStatus,
                        hasCoordinates: !!(data.latitude && data.longitude)
                    });
                });

                console.log(`üìç GPS data found for: ${Object.keys(gpsData).length} technicians`);

                // Step 3: Merge technician info with GPS data
                technicianLocations = [];
                
                // Create a combined list of all technician IDs from both sources
                const allTechnicianIds = new Set([...Object.keys(technicianData), ...Object.keys(gpsData)]);
                
                console.log(`üë• Processing ${allTechnicianIds.size} unique technicians from both sources`);
                
                allTechnicianIds.forEach(techId => {
                    const tech = technicianData[techId];
                    const gps = gpsData[techId];
                    
                    // Check if location data is fresh (within last 10 minutes)
                    const lastTimestamp = gps?.timestamp || gps?.lastUpdate || tech?.lastLocationUpdate;
                    const tenMinutesAgo = Date.now() - (10 * 60 * 1000); // 10 minutes in milliseconds
                    const isDataFresh = lastTimestamp && lastTimestamp > tenMinutesAgo;
                    
                    // CRITICAL FIX: Check if user has explicitly DISABLED location sharing
                    const isExplicitlyDisabled = tech?.locationSharingEnabled === false || 
                                                 tech?.locationStatus === 'disabled';
                    
                    // Priority: If explicitly disabled in users collection, respect that
                    // Otherwise, use GPS data if available and fresh
                    const isLocationEnabled = !isExplicitlyDisabled && isDataFresh && gps && (
                                             (gps.isLocationEnabled === true) || 
                                             (gps.locationSharingEnabled === true) || 
                                             (gps.locationStatus === 'enabled')
                                             );
                    
                    const locationStatus = isLocationEnabled ? 'enabled' : 'disabled';
                    
                    // Create merged location object - use GPS name if tech data not available
                    const locationObj = {
                        technicianId: techId,
                        technicianName: tech?.fullName || gps?.technicianName || 'Unknown Technician',
                        username: tech?.username || gps?.username || 'Unknown',
                        email: tech?.email || '',
                        phone: tech?.phone || '',
                        isLocationEnabled: isLocationEnabled,
                        locationStatus: locationStatus,
                        isDataFresh: isDataFresh,
                        latitude: gps?.latitude || null,
                        longitude: gps?.longitude || null,
                        accuracy: gps?.accuracy || null,
                        battery: gps?.battery || null,
                        timestamp: gps?.timestamp || tech?.lastLocationUpdate || null,
                        lastUpdate: gps?.lastUpdate || tech?.lastLocationUpdate || null,
                        speed: gps?.speed || null,
                        heading: gps?.heading || null
                    };
                    
                    technicianLocations.push(locationObj);
                    
                    console.log(`‚úì ${locationObj.technicianName}: Enabled=${locationObj.isLocationEnabled}, HasGPS=${!!gps}, Status=${locationObj.locationStatus}, Fresh=${isDataFresh}, ExplicitlyDisabled=${isExplicitlyDisabled}, GPSEnabled=${gps?.isLocationEnabled}, UserStatus=${tech?.locationStatus}`);
                });

                // Sort by name
                technicianLocations.sort((a, b) => a.technicianName.localeCompare(b.technicianName));

                console.log(`‚úÖ Tracking data loaded: ${technicianLocations.length} technicians`);
                console.log('üìä Full data:', technicianLocations);

                // Step 4: Load geofence alerts
                const alertsSnapshot = await getDocs(
                    query(
                        collection(db, 'geofenceAlerts'),
                        orderBy('createdAt', 'desc'),
                        limit(50)
                    )
                );
                
                geofenceAlerts = [];
                alertsSnapshot.forEach(doc => {
                    geofenceAlerts.push({ id: doc.id, ...doc.data() });
                });

                console.log(`üö® Geofence alerts loaded: ${geofenceAlerts.length}`);
                
            } catch (error) {
                console.error('‚ùå Error loading tracking data:', error);
                alert('Error loading tracking data. Please refresh the page.');
            }
        }

        // Update project with geofence data
        window.updateProjectGeofence = async (projectId, lat, lng, radius) => {
            try {
                await updateDoc(doc(db, 'projects', projectId), {
                    site_lat: parseFloat(lat),
                    site_lng: parseFloat(lng),
                    site_radius_meters: parseInt(radius) || 100
                });
                
                alert('‚úÖ Geofence updated successfully!');
                await loadProjects();
                
            } catch (error) {
                console.error('Error updating geofence:', error);
                alert('‚ùå Failed to update geofence');
            }
        };

        // Calculate distance between two coordinates (Haversine formula)
        // Check for geofence breach and track distance
        async function checkGeofenceBreach(technicianId, locationData) {
            try {
                // Get all projects with geofences
                const projectsSnapshot = await getDocs(collection(db, 'projects'));
                const today = new Date().toISOString().split('T')[0];
                
                let insideGeofence = false;
                let currentProject = null;
                
                // Check if technician is inside any project geofence
                projectsSnapshot.forEach(doc => {
                    const project = doc.data();
                    if (project.site_lat && project.site_lng && project.site_radius_meters) {
                        const distance = calculateDistance(
                            locationData.latitude,
                            locationData.longitude,
                            project.site_lat,
                            project.site_lng
                        );
                        
                        if (distance <= project.site_radius_meters) {
                            insideGeofence = true;
                            currentProject = {
                                id: doc.id,
                                name: project.project_name || 'Unknown Project',
                                distance: distance
                            };
                        }
                    }
                });

                // Get technician's travel log for today
                const travelLogRef = doc(db, 'technicianTravelLogs', `${technicianId}_${today}`);
                const travelLogSnap = await getDoc(travelLogRef);
                const travelLog = travelLogSnap.exists() ? travelLogSnap.data() : null;

                // Calculate distance traveled since last update
                let distanceTraveled = 0;
                if (travelLog && travelLog.lastLocation) {
                    distanceTraveled = calculateDistance(
                        travelLog.lastLocation.latitude,
                        travelLog.lastLocation.longitude,
                        locationData.latitude,
                        locationData.longitude
                    );
                }

                // Update travel log
                const updateData = {
                    technicianId: technicianId,
                    technicianName: locationData.technicianName || 'Unknown',
                    date: today,
                    lastLocation: {
                        latitude: locationData.latitude,
                        longitude: locationData.longitude,
                        timestamp: locationData.timestamp || Date.now()
                    },
                    lastUpdate: Date.now()
                };

                if (insideGeofence) {
                    // Inside geofence - reset outside tracking
                    updateData.insideGeofence = true;
                    updateData.currentProject = currentProject.name;
                    updateData.currentProjectId = currentProject.id;
                    updateData.geofenceEntryTime = travelLog?.geofenceEntryTime || Date.now();
                    
                    // Only add to inside distance if moving significantly (> 5 meters)
                    if (distanceTraveled > 5) {
                        updateData.totalDistanceInsideGeofence = (travelLog?.totalDistanceInsideGeofence || 0) + distanceTraveled;
                    }
                    
                    // If was outside before, record the outside travel session
                    if (travelLog && travelLog.insideGeofence === false && travelLog.geofenceExitTime) {
                        const outsideTravelSession = {
                            startTime: travelLog.geofenceExitTime,
                            endTime: Date.now(),
                            distance: travelLog.currentOutsideDistance || 0,
                            startLocation: travelLog.exitLocation,
                            endLocation: {
                                latitude: locationData.latitude,
                                longitude: locationData.longitude
                            }
                        };
                        
                        const outsideSessions = travelLog.outsideTravelSessions || [];
                        outsideSessions.push(outsideTravelSession);
                        updateData.outsideTravelSessions = outsideSessions;
                        updateData.totalDistanceOutsideGeofence = (travelLog.totalDistanceOutsideGeofence || 0) + outsideTravelSession.distance;
                        updateData.currentOutsideDistance = 0;
                        
                        // Create geofence breach alert for entry
                        await addDoc(collection(db, 'geofenceAlerts'), {
                            technicianId: technicianId,
                            technicianName: locationData.technicianName || 'Unknown',
                            type: 'entry',
                            projectName: currentProject.name,
                            projectId: currentProject.id,
                            distance: currentProject.distance,
                            location: {
                                latitude: locationData.latitude,
                                longitude: locationData.longitude
                            },
                            outsideDistance: outsideTravelSession.distance,
                            outsideDuration: Math.round((outsideTravelSession.endTime - outsideTravelSession.startTime) / 60000),
                            createdAt: Date.now(),
                            timestamp: new Date().toISOString()
                        });
                        
                        console.log(`‚úÖ ${locationData.technicianName} entered geofence of ${currentProject.name}. Outside distance: ${(outsideTravelSession.distance/1000).toFixed(2)}km`);
                    }
                } else {
                    // Outside geofence - track outside distance
                    updateData.insideGeofence = false;
                    updateData.currentProject = null;
                    updateData.currentProjectId = null;
                    
                    // Only add to outside distance if moving significantly (> 5 meters)
                    if (distanceTraveled > 5) {
                        updateData.currentOutsideDistance = (travelLog?.currentOutsideDistance || 0) + distanceTraveled;
                    } else {
                        updateData.currentOutsideDistance = travelLog?.currentOutsideDistance || 0;
                    }
                    
                    // If was inside before, record geofence exit
                    if (travelLog && travelLog.insideGeofence === true) {
                        updateData.geofenceExitTime = Date.now();
                        updateData.exitLocation = {
                            latitude: locationData.latitude,
                            longitude: locationData.longitude
                        };
                        
                        // Create geofence breach alert for exit
                        await addDoc(collection(db, 'geofenceAlerts'), {
                            technicianId: technicianId,
                            technicianName: locationData.technicianName || 'Unknown',
                            type: 'exit',
                            projectName: travelLog.currentProject || 'Unknown Project',
                            projectId: travelLog.currentProjectId,
                            location: {
                                latitude: locationData.latitude,
                                longitude: locationData.longitude
                            },
                            timeInside: travelLog.geofenceEntryTime ? Math.round((Date.now() - travelLog.geofenceEntryTime) / 60000) : 0,
                            createdAt: Date.now(),
                            timestamp: new Date().toISOString()
                        });
                        
                        console.log(`‚ö†Ô∏è ${locationData.technicianName} exited geofence of ${travelLog.currentProject}`);
                    }
                }

                // Save/update travel log
                await setDoc(travelLogRef, updateData, { merge: true });
                
                console.log(`üìä Travel log updated for ${locationData.technicianName}:`, {
                    inside: insideGeofence,
                    project: currentProject?.name || 'None',
                    distanceMoved: `${(distanceTraveled).toFixed(1)}m`,
                    totalInside: `${((updateData.totalDistanceInsideGeofence || 0)/1000).toFixed(2)}km`,
                    totalOutside: `${((updateData.totalDistanceOutsideGeofence || 0)/1000).toFixed(2)}km`
                });

            } catch (error) {
                console.error('Error checking geofence:', error);
            }
        }

        // Generate daily travel report PDF for a technician
        window.generateDailyTravelReport = async (technicianId, technicianName, date) => {
            try {
                console.log(`üìÑ Generating travel report for ${technicianName} on ${date}`);
                
                const travelLogRef = doc(db, 'technicianTravelLogs', `${technicianId}_${date}`);
                const travelLogSnap = await getDoc(travelLogRef);
                
                if (!travelLogSnap.exists()) {
                    alert('No travel data found for this date.');
                    return;
                }
                
                const travelData = travelLogSnap.data();
                const outsideSessions = travelData.outsideTravelSessions || [];
                
                // Calculate totals
                const totalInside = (travelData.totalDistanceInsideGeofence || 0) / 1000; // km
                const totalOutside = (travelData.totalDistanceOutsideGeofence || 0) / 1000; // km
                const totalDistance = totalInside + totalOutside;
                const totalSessions = outsideSessions.length;
                
                // Build PDF content
                let pdfContent = `
                    <div style="font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto;">
                        <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2563eb; padding-bottom: 20px;">
                            <h1 style="margin: 0; color: #1e293b; font-size: 28px;">üìç Daily Travel Report</h1>
                            <h2 style="margin: 10px 0 0 0; color: #64748b; font-size: 18px;">${technicianName}</h2>
                            <p style="margin: 5px 0 0 0; color: #64748b; font-size: 14px;">${new Date(date).toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                        </div>
                        
                        <div style="background: #f8fafc; border-radius: 8px; padding: 20px; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 18px;">üìä Summary</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #10b981;">
                                    <div style="color: #64748b; font-size: 12px; margin-bottom: 5px;">Total Distance</div>
                                    <div style="color: #1e293b; font-size: 24px; font-weight: 600;">${totalDistance.toFixed(2)} km</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #3b82f6;">
                                    <div style="color: #64748b; font-size: 12px; margin-bottom: 5px;">Inside Geofence</div>
                                    <div style="color: #1e293b; font-size: 24px; font-weight: 600;">${totalInside.toFixed(2)} km</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #f59e0b;">
                                    <div style="color: #64748b; font-size: 12px; margin-bottom: 5px;">Outside Geofence</div>
                                    <div style="color: #1e293b; font-size: 24px; font-weight: 600;">${totalOutside.toFixed(2)} km</div>
                                </div>
                                <div style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #8b5cf6;">
                                    <div style="color: #64748b; font-size: 12px; margin-bottom: 5px;">Travel Sessions</div>
                                    <div style="color: #1e293b; font-size: 24px; font-weight: 600;">${totalSessions}</div>
                                </div>
                            </div>
                        </div>
                `;
                
                if (outsideSessions.length > 0) {
                    pdfContent += `
                        <div style="margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; color: #1e293b; font-size: 18px;">üöó Outside Geofence Travel Sessions</h3>
                            <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                                <thead>
                                    <tr style="background: #f1f5f9;">
                                        <th style="padding: 12px; text-align: left; font-size: 12px; color: #64748b; font-weight: 600;">#</th>
                                        <th style="padding: 12px; text-align: left; font-size: 12px; color: #64748b; font-weight: 600;">Start Time</th>
                                        <th style="padding: 12px; text-align: left; font-size: 12px; color: #64748b; font-weight: 600;">End Time</th>
                                        <th style="padding: 12px; text-align: left; font-size: 12px; color: #64748b; font-weight: 600;">Duration</th>
                                        <th style="padding: 12px; text-align: left; font-size: 12px; color: #64748b; font-weight: 600;">Distance</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    outsideSessions.forEach((session, index) => {
                        const startTime = new Date(session.startTime).toLocaleTimeString('en-IN');
                        const endTime = new Date(session.endTime).toLocaleTimeString('en-IN');
                        const duration = Math.round((session.endTime - session.startTime) / 60000);
                        const distance = (session.distance / 1000).toFixed(2);
                        
                        pdfContent += `
                            <tr style="border-bottom: 1px solid #f1f5f9;">
                                <td style="padding: 12px; font-size: 14px; color: #64748b;">${index + 1}</td>
                                <td style="padding: 12px; font-size: 14px; color: #1e293b;">${startTime}</td>
                                <td style="padding: 12px; font-size: 14px; color: #1e293b;">${endTime}</td>
                                <td style="padding: 12px; font-size: 14px; color: #1e293b;">${duration} min</td>
                                <td style="padding: 12px; font-size: 14px; color: #1e293b; font-weight: 600;">${distance} km</td>
                            </tr>
                        `;
                    });
                    
                    pdfContent += `
                                </tbody>
                            </table>
                        </div>
                    `;
                }
                
                pdfContent += `
                        <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center; color: #64748b; font-size: 12px;">
                            <p style="margin: 0;">Generated on ${new Date().toLocaleString('en-IN')}</p>
                            <p style="margin: 5px 0 0 0;">Avant Elevators - Employee Management System</p>
                        </div>
                    </div>
                `;
                
                // Open in new window for printing
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Travel Report - ${technicianName} - ${date}</title>
                        <style>
                            @media print {
                                body { margin: 0; padding: 0; }
                                @page { margin: 1cm; }
                            }
                        </style>
                    </head>
                    <body>
                        ${pdfContent}
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
                // Auto-trigger print dialog
                setTimeout(() => {
                    printWindow.print();
                }, 500);
                
            } catch (error) {
                console.error('Error generating report:', error);
                alert('Failed to generate report. Please try again.');
            }
        };

        // Generate report from UI selection
        window.generateSelectedReport = async () => {
            const techSelect = document.getElementById('reportTechnicianSelect');
            const dateSelect = document.getElementById('reportDateSelect');
            
            const technicianId = techSelect.value;
            const date = dateSelect.value;
            
            if (!technicianId) {
                alert('Please select a technician');
                return;
            }
            
            if (!date) {
                alert('Please select a date');
                return;
            }
            
            const technicianName = techSelect.options[techSelect.selectedIndex].text;
            await generateDailyTravelReport(technicianId, technicianName, date);
        };

        // Show technician tracking dashboard
        window.showTechnicianLocationInterface = async () => {
            // Get current technician data
            const technicianId = currentUser.id;
            const technicianName = currentUser.fullName || currentUser.username;
            
            console.log('üîç Loading technician interface for:', technicianId, technicianName);
            
            // Check both localStorage and Firebase status for consistency
            const localStorageTracking = localStorage.getItem(`location_tracking_${technicianId}`) === 'true';
            console.log('üíæ LocalStorage tracking status:', localStorageTracking);
            
            // Also check Firebase for the actual status
            let firebaseTracking = false;
            try {
                const userDoc = await getDoc(doc(db, 'users', technicianId));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    firebaseTracking = userData.locationSharingEnabled === true || userData.locationStatus === 'enabled';
                    console.log('üî• Firebase user data:', {
                        locationSharingEnabled: userData.locationSharingEnabled,
                        locationStatus: userData.locationStatus,
                        computed: firebaseTracking
                    });
                } else {
                    console.warn('‚ö†Ô∏è User document not found in Firebase');
                }
            } catch (error) {
                console.error('Error checking Firebase status:', error);
            }
            
            // Use Firebase status as the source of truth and sync localStorage
            const isTrackingLocation = firebaseTracking;
            console.log('‚úÖ Final tracking status:', isTrackingLocation);
            
            if (firebaseTracking !== localStorageTracking) {
                console.log('‚ö†Ô∏è Syncing localStorage with Firebase...');
                // Sync localStorage with Firebase
                if (firebaseTracking) {
                    localStorage.setItem(`location_tracking_${technicianId}`, 'true');
                } else {
                    localStorage.removeItem(`location_tracking_${technicianId}`);
                }
            }
            
            // Load technician's location history
            let locationHistory = [];
            try {
                const locationsSnapshot = await getDocs(
                    query(
                        collection(db, 'technicianLocations'),
                        orderBy('timestamp', 'desc'),
                        limit(100)
                    )
                );
                
                locationsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.technicianId === technicianId) {
                        locationHistory.push({ id: doc.id, ...data });
                    }
                });
            } catch (error) {
                console.error('Error loading location history:', error);
            }
            
            // Calculate today's stats
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayLocations = locationHistory.filter(loc => {
                const locDate = new Date(loc.timestamp);
                return locDate >= today;
            });
            
            // Calculate week stats
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const weekLocations = locationHistory.filter(loc => {
                const locDate = new Date(loc.timestamp);
                return locDate >= weekAgo;
            });
            
            // Calculate month stats
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            const monthLocations = locationHistory.filter(loc => {
                const locDate = new Date(loc.timestamp);
                return locDate >= monthAgo;
            });
            
            let html = `
                <div style="padding: 16px; max-width: 100%; overflow-x: hidden;">
                    <h2 style="color: var(--text-primary); margin-bottom: 20px; font-size: 20px; display: flex; align-items: center; gap: 8px;">
                        üìç My Location Tracking
                    </h2>
                    
                    <!-- Location Enable/Disable Card -->
                    <div class="card" style="margin-bottom: 24px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <div>
                                <h3 style="margin: 0 0 8px 0; font-size: 18px;">Location Sharing</h3>
                                <p style="margin: 0; font-size: 14px; opacity: 0.9;">
                                    ${isTrackingLocation ? '‚úÖ Location sharing is active' : '‚ö†Ô∏è Location sharing is disabled'}
                                </p>
                            </div>
                            <div style="font-size: 48px;">${isTrackingLocation ? 'üì°' : 'üì¥'}</div>
                        </div>
                        
                        <button 
                            class="btn" 
                            onclick="${isTrackingLocation ? 'disableTechnicianLocation()' : 'enableTechnicianLocation()'}"
                            style="width: 100%; padding: 12px; background: white; color: #667eea; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                            ${isTrackingLocation ? 'üõë Disable Location Sharing' : '‚ñ∂Ô∏è Enable Location Sharing'}
                        </button>
                        
                        ${isTrackingLocation ? `
                            <div style="margin-top: 12px; padding: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 13px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span>üîã</span>
                                    <span>Battery: <strong id="currentBattery">-</strong></span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span>‚è±Ô∏è</span>
                                    <span>Last Update: <strong id="lastLocationUpdate">-</strong></span>
                                </div>
                            </div>
                        ` : `
                            <div style="margin-top: 16px;">
                                <button 
                                    onclick="checkLocationSupport()"
                                    style="width: 100%; padding: 8px; background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; cursor: pointer; font-size: 14px;">
                                    üîç Check Browser Support
                                </button>
                            </div>
                        `}
                    </div>
                    
                    <!-- Troubleshooting Section (only show if not tracking) -->
                    ${!isTrackingLocation ? `
                    <div class="card" style="margin-bottom: 24px; padding: 16px; background: #fef3cd; border: 1px solid #ffc107; border-radius: 8px;">
                        <h4 style="margin: 0 0 12px 0; color: #856404; font-size: 16px;">üìã Troubleshooting</h4>
                        <div style="font-size: 14px; color: #856404; line-height: 1.5;">
                            <p style="margin: 0 0 8px 0;"><strong>If location sharing fails:</strong></p>
                            <ol style="margin: 0 0 12px 0; padding-left: 20px;">
                                <li>Check the address bar for a location icon üìç</li>
                                <li>Click "Allow" when prompted for location access</li>
                                <li>Ensure your device's location/GPS is enabled</li>
                                <li>Use a secure HTTPS connection if possible</li>
                                <li>Try refreshing the page</li>
                            </ol>
                            <p style="margin: 0; font-size: 12px;">
                                <strong>Supported:</strong> Chrome, Firefox, Safari, Edge (latest versions)
                            </p>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Activity Stats -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px; font-weight: 600;">üìä Activity Summary</h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                            <div class="card" style="padding: 16px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 4px;">
                                    ${todayLocations.length}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Today</div>
                            </div>
                            <div class="card" style="padding: 16px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--success); margin-bottom: 4px;">
                                    ${weekLocations.length}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary);">This Week</div>
                            </div>
                            <div class="card" style="padding: 16px; text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--warning); margin-bottom: 4px;">
                                    ${monthLocations.length}
                                </div>
                                <div style="font-size: 12px; color: var(--text-secondary);">This Month</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Location Records -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px; font-weight: 600;">üìù Recent Location Records</h3>
                        <div class="card" style="padding: 0; overflow: hidden;">
                            <div style="max-height: 400px; overflow-y: auto;">
            `;
            
            if (locationHistory.length === 0) {
                html += `
                    <div style="padding: 40px; text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: 12px;">üìç</div>
                        <p style="margin: 0;">No location records yet</p>
                        <p style="margin: 8px 0 0 0; font-size: 14px;">Enable location sharing to start tracking</p>
                    </div>
                `;
            } else {
                locationHistory.slice(0, 50).forEach((loc, index) => {
                    const locDate = new Date(loc.timestamp);
                    const isToday = locDate.toDateString() === new Date().toDateString();
                    
                    html += `
                        <div style="padding: 16px; border-bottom: 1px solid var(--border); ${index === locationHistory.length - 1 ? 'border-bottom: none;' : ''}">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div>
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                        ${locDate.toLocaleDateString('en-IN')} ${locDate.toLocaleTimeString('en-IN')}
                                    </div>
                                    <div style="font-size: 13px; color: var(--text-secondary);">
                                        üìç ${loc.latitude.toFixed(6)}, ${loc.longitude.toFixed(6)}
                                    </div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 2px;">Battery</div>
                                    <div style="font-weight: 600; color: ${loc.battery > 50 ? 'var(--success)' : loc.battery > 20 ? 'var(--warning)' : 'var(--danger)'};">
                                        üîã ${loc.battery}%
                                    </div>
                                </div>
                            </div>
                            ${loc.accuracy ? `
                                <div style="font-size: 12px; color: var(--text-secondary);">
                                    Accuracy: ¬±${loc.accuracy.toFixed(0)}m
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            html += `
                            </div>
                        </div>
                    </div>
                    
                    <!-- Info Card -->
                    <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 16px; font-size: 14px; color: #78350f;">
                        <div style="font-weight: 600; margin-bottom: 8px;">üí° How it works:</div>
                        <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Enable location sharing to allow admins to track your location</li>
                            <li>Your location is updated automatically every 10 seconds</li>
                            <li>Battery level and accuracy are recorded with each update</li>
                            <li>You can disable location sharing anytime</li>
                            <li>All location data is encrypted and secure</li>
                        </ul>
                    </div>
                </div>
            `;
            
            // Inject into trackingContent div
            const trackingContent = document.getElementById('trackingContent');
            if (trackingContent) {
                trackingContent.innerHTML = html;
            }
            
            // If tracking is enabled, update battery and last update time
            if (isTrackingLocation) {
                updateLocationStatus();
                
                // Clear any existing interval
                if (window.locationStatusInterval) {
                    clearInterval(window.locationStatusInterval);
                }
                
                // Set up auto-update every 10 seconds for last update time
                window.locationStatusInterval = setInterval(() => {
                    updateLocationStatus();
                }, 10000); // 10 seconds
            } else {
                // Clear interval if tracking is disabled
                if (window.locationStatusInterval) {
                    clearInterval(window.locationStatusInterval);
                    window.locationStatusInterval = null;
                }
            }
        };
        
        // Enable technician location tracking
        window.enableTechnicianLocation = async () => {
            try {
                // Check basic requirements
                console.log('Checking location tracking requirements...');
                console.log('Protocol:', window.location.protocol);
                console.log('Hostname:', window.location.hostname);
                console.log('Geolocation support:', !!navigator.geolocation);
                
                if (!navigator.geolocation) {
                    alert(`‚ùå Geolocation Not Supported
                    
Your browser doesn't support location tracking.
Please use:
- Chrome (recommended)
- Firefox
- Safari
- Edge
- Or update your current browser`);
                    return;
                }
                
                // Warn about HTTP vs HTTPS
                try {
                    const protocol = window.location.protocol || '';
                    const hostname = window.location.hostname || '';
                    
                    if (protocol !== 'https:' && hostname !== 'localhost' && hostname !== '127.0.0.1') {
                        alert(`‚ö†Ô∏è Security Warning
                        
Location tracking may not work on HTTP (non-secure) connections.
For best results, use HTTPS.
                        
Attempting to enable anyway...`);
                    }
                } catch (locationError) {
                    console.log('Could not check protocol/hostname:', locationError);
                }
                
                // Check if user is logged in
                if (!currentUser || !currentUser.id) {
                    console.error('Current user state:', currentUser);
                    alert('‚ùå User not logged in. Please login first.');
                    return;
                }
                
                // Request location permission
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    });
                });
                
                const technicianId = currentUser.id;
                
                // Enable tracking flag in localStorage
                localStorage.setItem(`location_tracking_${technicianId}`, 'true');
                
                // Update user status in Firebase to indicate location is enabled
                await setDoc(doc(db, 'users', technicianId), {
                    locationSharingEnabled: true,
                    locationStatus: 'enabled',
                    lastLocationUpdate: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                
                // Send initial location immediately
                await sendTechnicianLocation(position);
                
                // Clear any existing intervals to prevent duplicates
                const existingInterval = localStorage.getItem(`location_interval_${technicianId}`);
                if (existingInterval) {
                    clearInterval(parseInt(existingInterval));
                }
                
                // Set up periodic updates every 2 minutes
                const intervalId = setInterval(async () => {
                    if (localStorage.getItem(`location_tracking_${technicianId}`) === 'true') {
                        navigator.geolocation.getCurrentPosition(
                            async (pos) => {
                                await sendTechnicianLocation(pos);
                                console.log('Location update sent at:', new Date().toISOString());
                            },
                            (error) => {
                                console.error('Location error:', error);
                                // If location access fails, disable tracking
                                if (error.code === error.PERMISSION_DENIED) {
                                    disableTechnicianLocation();
                                    alert('‚ùå Location access denied. Disabling tracking.');
                                }
                            },
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                        );
                    } else {
                        clearInterval(intervalId);
                    }
                }, 10 * 1000); // 10 seconds
                
                // Store interval ID
                localStorage.setItem(`location_interval_${technicianId}`, intervalId);
                
                // Force update admin view by triggering a status change notification
                await setDoc(doc(db, 'systemNotifications', `location_enabled_${technicianId}_${Date.now()}`), {
                    type: 'location_enabled',
                    technicianId: technicianId,
                    technicianName: currentUser.fullName || currentUser.username,
                    timestamp: new Date().toISOString(),
                    message: 'Location tracking enabled'
                });
                
                alert('‚úÖ Location sharing enabled successfully!');
                
                // Refresh the appropriate interface based on user role
                const userRole = (currentUser?.role || '').toLowerCase();
                console.log('üîÑ Refreshing interface after enabling location. User role:', userRole);

                if (userRole === 'technician') {
                    console.log('üë§ Showing technician interface...');
                    await showTechnicianLocationInterface();
                } else if (userRole === 'admin' || userRole === 'manager') {
                    console.log('üë®‚Äçüíº Showing admin tracking dashboard...');
                    await showTechnicianTracking();
                }
                
            } catch (error) {
                console.error('Error enabling location:', error);
                console.error('Error details:', {
                    code: error.code,
                    message: error.message,
                    name: error.name,
                    stack: error.stack
                });
                
                if (error.code === 1) { // PERMISSION_DENIED
                    alert(`‚ùå Location Access Denied
                    
Please:
1. Click the location icon üìç in your browser's address bar
2. Select "Allow" for location access
3. Or go to Browser Settings > Site Settings > Location > Allow
4. Refresh the page and try again

If you're using HTTP (not HTTPS), location sharing may not work.`);
                } else if (error.code === 2) { // POSITION_UNAVAILABLE
                    alert(`‚ùå Location Service Unavailable
                    
Please check:
1. GPS/Location services are enabled on your device
2. You're not in airplane mode
3. Try moving to a location with better signal
4. Restart your browser and try again`);
                } else if (error.code === 3) { // TIMEOUT
                    alert(`‚ùå Location Request Timed Out
                    
Please:
1. Check your internet connection
2. Make sure GPS/Location is enabled
3. Try again in a few moments
4. Restart your browser if problem persists`);
                } else if (error.name === 'NotAllowedError') {
                    alert(`‚ùå Location Permission Required
                    
To enable location tracking:
1. Refresh this page
2. When prompted, click "Allow" for location access
3. Or manually enable location in browser settings
4. Make sure you're using HTTPS (secure connection)`);
                } else if (error.name === 'NotSupportedError') {
                    alert(`‚ùå Geolocation Not Supported
                    
Your browser or device doesn't support location tracking.
Please try:
1. Updating your browser
2. Using Chrome, Firefox, or Safari
3. Enabling location services on your device`);
                } else {
                    alert(`‚ùå Location Sharing Failed
                    
Error: ${error.message || 'Unknown error'}
                    
Please try:
1. Refresh the page
2. Check browser console (F12) for details
3. Ensure location services are enabled
4. Use a supported browser (Chrome/Firefox/Safari)
5. Contact support if problem persists`);
                }
            }
        };
        
        // Disable technician location tracking
        window.disableTechnicianLocation = async () => {
            const technicianId = currentUser.id;
            
            try {
                // Clear tracking flag
                localStorage.removeItem(`location_tracking_${technicianId}`);
                
                // Clear interval
                const intervalId = localStorage.getItem(`location_interval_${technicianId}`);
                if (intervalId) {
                    clearInterval(parseInt(intervalId));
                    localStorage.removeItem(`location_interval_${technicianId}`);
                }
                
                // Update user status in Firebase to indicate location is disabled
                await setDoc(doc(db, 'users', technicianId), {
                    locationSharingEnabled: false,
                    locationStatus: 'disabled',
                    lastLocationUpdate: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                
                // Also remove current location data
                try {
                    await deleteDoc(doc(db, 'currentTechnicianLocations', technicianId));
                } catch (deleteError) {
                    console.log('No current location document to delete');
                }
                
                // Force update admin view by triggering a status change notification
                await setDoc(doc(db, 'systemNotifications', `location_disabled_${technicianId}_${Date.now()}`), {
                    type: 'location_disabled',
                    technicianId: technicianId,
                    technicianName: currentUser.fullName || currentUser.username,
                    timestamp: new Date().toISOString(),
                    message: 'Location tracking disabled'
                });
                
                alert('‚úÖ Location sharing disabled');
                
                // Refresh the appropriate interface based on user role
                const userRole = (currentUser?.role || '').toLowerCase();
                console.log('üîÑ Refreshing interface after disabling location. User role:', userRole);
                
                if (userRole === 'technician') {
                    console.log('üë§ Showing technician interface...');
                    await showTechnicianLocationInterface();
                } else if (userRole === 'admin' || userRole === 'manager') {
                    console.log('üë®‚Äçüíº Showing admin tracking dashboard...');
                    await showTechnicianTracking();
                }
                
            } catch (error) {
                console.error('Error disabling location:', error);
                alert('‚ùå Failed to disable location sharing');
            }
        };
        
        // Send technician location to Firebase
        window.sendTechnicianLocation = async (position) => {
            try {
                // Check if user is logged in and position is valid
                if (!currentUser || !currentUser.id) {
                    console.error('User not logged in, cannot send location');
                    return;
                }
                
                if (!position || !position.coords) {
                    console.error('Invalid position data');
                    return;
                }
                
                const technicianId = currentUser.id;
                const technicianName = currentUser.fullName || currentUser.username || 'Unknown';
                
                // Verify user is still tracking before sending location
                const localTracking = localStorage.getItem(`location_tracking_${technicianId}`) === 'true';
                if (!localTracking) {
                    console.log('Location tracking disabled, not sending location');
                    return;
                }
                
                // Get battery level
                let battery = 100;
                try {
                    if (navigator.getBattery) {
                        const batteryInfo = await navigator.getBattery();
                        battery = Math.round(batteryInfo.level * 100);
                    }
                } catch (batteryError) {
                    console.log('Battery API not available');
                }
                
                const locationData = {
                    technicianId: technicianId,
                    technicianName: technicianName,
                    latitude: position.coords.latitude,
                    longitude: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    battery: battery,
                    timestamp: position.timestamp || new Date().getTime(),
                    lastUpdate: new Date().toISOString(),
                    isLocationEnabled: true,
                    status: 'active',
                    locationSharingEnabled: true,
                    locationStatus: 'enabled'
                };
                
                // Save current location (overwrites previous)
                await setDoc(doc(db, 'currentTechnicianLocations', technicianId), locationData);
                
                // Also save to history for tracking
                await addDoc(collection(db, 'technicianLocationHistory'), {
                    ...locationData,
                    createdAt: new Date().toISOString()
                });
                
                // Ensure user status is also current in users collection
                await setDoc(doc(db, 'users', technicianId), {
                    locationSharingEnabled: true,
                    locationStatus: 'enabled',
                    lastLocationUpdate: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                
                console.log('‚úÖ Location sent successfully:', {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    battery: battery
                });
                
                // Update UI if on tracking page
                if (document.getElementById('currentBattery')) {
                    updateLocationStatus();
                }
                
            } catch (error) {
                console.error('Error sending location:', error);
                // If error persists, user might need to re-enable tracking
                if (error.code === 'permission-denied' || error.message?.includes('permission')) {
                    alert('‚ùå Location permission lost. Please disable and re-enable location sharing.');
                }
            }
        };
        
        // Check location support and permissions for debugging
        window.checkLocationSupport = async () => {
            let info = [];
            
            // Basic support check
            try {
                const userAgent = navigator.userAgent || '';
                const browserInfo = userAgent ? userAgent.split(' ').slice(-1)[0] || 'Unknown' : 'Unknown';
                info.push(`üåê Browser: ${browserInfo}`);
            } catch (error) {
                info.push(`üåê Browser: Unknown`);
            }
            
            info.push(`üîó Protocol: ${window.location.protocol}`);
            info.push(`üìç Geolocation API: ${navigator.geolocation ? '‚úÖ Supported' : '‚ùå Not Supported'}`);
            
            // Permission check
            if (navigator.permissions) {
                try {
                    const permission = await navigator.permissions.query({name: 'geolocation'});
                    info.push(`üîê Permission: ${permission.state}`);
                } catch (error) {
                    info.push(`üîê Permission: Could not check (${error.message})`);
                }
            } else {
                info.push(`üîê Permission API: Not supported`);
            }
            
            // HTTPS check
            if (window.location.protocol === 'https:') {
                info.push(`üîí Security: ‚úÖ HTTPS (Secure)`);
            } else if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                info.push(`üîí Security: ‚ö†Ô∏è HTTP (Localhost - OK)`);
            } else {
                info.push(`üîí Security: ‚ùå HTTP (May not work)`);
            }
            
            // Test location access
            if (navigator.geolocation) {
                try {
                    info.push(`üß™ Testing location access...`);
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: false,
                            timeout: 5000,
                            maximumAge: 0
                        });
                    });
                    info.push(`‚úÖ Location Test: SUCCESS`);
                    info.push(`üìç Coordinates: ${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}`);
                    info.push(`üéØ Accuracy: ${Math.round(position.coords.accuracy)}m`);
                } catch (error) {
                    info.push(`‚ùå Location Test: FAILED`);
                    info.push(`üö´ Error: ${error.message || error.code}`);
                    if (error.code === 1) info.push(`üí° Solution: Allow location access in browser`);
                    if (error.code === 2) info.push(`üí° Solution: Check device location settings`);
                    if (error.code === 3) info.push(`üí° Solution: Try again with better signal`);
                }
            }
            
            alert(`üìã Location Support Report\n\n${info.join('\n')}\n\nIf you see any ‚ùå or issues above, please address them before enabling location tracking.`);
        };
        
        // Periodic status synchronization for technicians
        window.startStatusSync = () => {
            if (!currentUser || currentUser.role !== 'technician') return;
            
            const technicianId = currentUser.id;
            
            // Check status every 2 minutes
            setInterval(async () => {
                try {
                    // Check local storage status
                    const localTracking = localStorage.getItem(`location_tracking_${technicianId}`) === 'true';
                    
                    // Check Firebase status
                    const userDoc = await getDoc(doc(db, 'users', technicianId));
                    let firebaseTracking = false;
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        firebaseTracking = userData.locationSharingEnabled === true;
                    }
                    
                    // If there's a mismatch, sync them
                    if (localTracking !== firebaseTracking) {
                        console.log('Status mismatch detected, syncing...');
                        if (localTracking) {
                            // Local says tracking but Firebase says no - update Firebase
                            await setDoc(doc(db, 'users', technicianId), {
                                locationSharingEnabled: true,
                                locationStatus: 'enabled',
                                lastLocationUpdate: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            }, { merge: true });
                        } else {
                            // Firebase says tracking but local says no - clear interval and update localStorage
                            const intervalId = localStorage.getItem(`location_interval_${technicianId}`);
                            if (intervalId) {
                                clearInterval(parseInt(intervalId));
                                localStorage.removeItem(`location_interval_${technicianId}`);
                            }
                            localStorage.setItem(`location_tracking_${technicianId}`, 'false');
                        }
                        
                        // Refresh interface if visible
                        if (document.querySelector('#trackingTabContent')) {
                            await showTechnicianLocationInterface();
                        }
                    }
                } catch (error) {
                    console.error('Status sync error:', error);
                }
            }, 30 * 1000); // Every 30 seconds
        };
        
        // Update location status in UI
        window.updateLocationStatus = async () => {
            try {
                // Get battery level
                let battery = '-';
                if (navigator.getBattery) {
                    const batteryInfo = await navigator.getBattery();
                    battery = Math.round(batteryInfo.level * 100) + '%';
                }
                
                const batteryElem = document.getElementById('currentBattery');
                if (batteryElem) {
                    batteryElem.textContent = battery;
                }
                
                // Get last location update time
                const technicianId = currentUser.id;
                const locationsSnapshot = await getDocs(
                    query(
                        collection(db, 'technicianLocations'),
                        orderBy('timestamp', 'desc'),
                        limit(1)
                    )
                );
                
                let lastUpdate = '-';
                locationsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.technicianId === technicianId) {
                        const date = new Date(data.timestamp);
                        const now = new Date();
                        const diffMinutes = Math.floor((now - date) / 60000);
                        if (diffMinutes < 1) {
                            lastUpdate = 'Just now';
                        } else if (diffMinutes < 60) {
                            lastUpdate = `${diffMinutes} min ago`;
                        } else {
                            lastUpdate = date.toLocaleTimeString('en-IN');
                        }
                    }
                });
                
                const updateElem = document.getElementById('lastLocationUpdate');
                if (updateElem) {
                    updateElem.textContent = lastUpdate;
                }
                
            } catch (error) {
                console.error('Error updating location status:', error);
            }
        };

        // Show technician tracking dashboard
        window.showTechnicianTracking = async () => {
            await loadTechnicianTracking();
            
            // Get all technicians from employees collection (not just those with location data)
            let allTechnicians = [];
            try {
                const employeesSnapshot = await getDocs(collection(db, 'employees'));
                employeesSnapshot.forEach(doc => {
                    const emp = doc.data();
                    // Check role field with case-insensitive matching and multiple field names
                    const role = (emp.role || emp.systemRole || '').toLowerCase();
                    const status = (emp.status || 'active').toLowerCase();
                    
                    if (role === 'technician' && status === 'active') {
                        allTechnicians.push({
                            id: doc.id,
                            name: `${emp.firstName || emp.name || 'Unknown'} ${emp.lastName || ''}`.trim(),
                            email: emp.email || ''
                        });
                    }
                });
                
                console.log('Found technicians in employees:', allTechnicians.length);
                
                // If no technicians found in employees, also check users collection
                if (allTechnicians.length === 0) {
                    try {
                        const usersSnapshot = await getDocs(collection(db, 'users'));
                        usersSnapshot.forEach(doc => {
                            const user = doc.data();
                            const role = (user.role || user.systemRole || '').toLowerCase();
                            const status = (user.status || 'active').toLowerCase();
                            
                            if (role === 'technician' && status === 'active') {
                                allTechnicians.push({
                                    id: doc.id,
                                    name: user.fullName || user.name || user.username || user.email || 'Technician',
                                    email: user.email || ''
                                });
                            }
                        });
                        console.log('Found technicians in users:', allTechnicians.length);
                    } catch (err) {
                        console.log('Users collection not accessible or empty:', err.message);
                    }
                }
                
            } catch (error) {
                console.error('Error loading technicians:', error);
            }
            
            // Merge with location data to get status
            const technicianNames = {};
            allTechnicians.forEach(tech => {
                technicianNames[tech.id] = tech.name;
            });
            
            // Add technicians from location data who might not be in employees/users
            // This ensures we always show technicians who have enabled location
            const uniqueLocationTechnicians = [...new Set(technicianLocations.map(loc => loc.technicianId))];
            uniqueLocationTechnicians.forEach(id => {
                if (!technicianNames[id]) {
                    const loc = technicianLocations.find(l => l.technicianId === id);
                    if (loc) {
                        technicianNames[id] = loc.technicianName;
                        allTechnicians.push({
                            id: id,
                            name: loc.technicianName,
                            email: ''
                        });
                    }
                }
            });
            
            console.log('Total technicians to show:', Object.keys(technicianNames).length);
            
            const allTechnicianIds = Object.keys(technicianNames);
            
            let html = `
                <div style="padding: 16px; max-width: 100%; overflow-x: hidden;">
                    <!-- Header with Console Button -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 12px;">
                        <h2 style="color: var(--text-primary); margin: 0; font-size: 20px; display: flex; align-items: center; gap: 8px; flex: 1;">
                            üó∫Ô∏è Technician Tracking Dashboard
                        </h2>
                        <button 
                            onclick="showConsoleViewer()" 
                            style="background: #3b82f6; color: white; border: none; padding: 10px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; white-space: nowrap; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                            title="View console logs for debugging">
                            üêõ Console
                        </button>
                    </div>
                    
                    <!-- Debug Info (only shown if helpful) -->
                    ${allTechnicianIds.length === 0 ? `
                    <div style="margin-bottom: 20px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 16px;">
                        <h3 style="margin: 0 0 12px 0; color: #92400e; font-size: 14px; font-weight: 600;">
                            üîç Debug Info - No Technicians Found
                        </h3>
                        <div style="font-size: 13px; color: #92400e; line-height: 1.6;">
                            <p style="margin: 0 0 8px 0;"><strong>Checked:</strong></p>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>Employees collection: ${allTechnicians.length} found</li>
                                <li>Location data: ${technicianLocations.length} records</li>
                                <li>Unique technicians with location: ${uniqueLocationTechnicians.length}</li>
                            </ul>
                            <p style="margin: 12px 0 0 0;"><strong>Possible reasons:</strong></p>
                            <ul style="margin: 0; padding-left: 20px;">
                                <li>No employees with role="technician" in Firebase</li>
                                <li>No technicians have enabled location sharing yet</li>
                                <li>Check browser console (F12) for more details</li>
                            </ul>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Daily Travel Reports Section (Admin Only) -->
                    ${currentUser && currentUser.role === 'admin' ? `
                    <div style="margin-bottom: 20px;">
                        <div class="card" style="padding: 16px;">
                            <h3 style="margin: 0 0 12px 0; color: var(--text-primary); font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                üìÑ Daily Travel Reports
                            </h3>
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 12px;">
                                Generate PDF reports showing distance traveled inside and outside geofence zones
                            </div>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <select id="reportTechnicianSelect" style="flex: 1; min-width: 200px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                                    <option value="">Select Technician</option>
                                    ${allTechnicianIds.map(id => {
                                        return `<option value="${id}">${technicianNames[id]}</option>`;
                                    }).join('')}
                                </select>
                                <input 
                                    type="date" 
                                    id="reportDateSelect" 
                                    value="${new Date().toISOString().split('T')[0]}"
                                    style="flex: 1; min-width: 150px; padding: 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;"
                                />
                                <button 
                                    onclick="generateSelectedReport()" 
                                    style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                    üì• Generate PDF
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Technician Filter -->
                    <div style="margin-bottom: 20px;">
                        <div class="card" style="padding: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-primary);">
                                üë∑ Filter by Technician:
                            </label>
                            <select id="technicianFilter" onchange="filterTechnicianTracking(this.value)" style="width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px;">
                                <option value="all">All Technicians (${allTechnicianIds.length})</option>
                                ${allTechnicianIds.map(id => {
                                    const tech = technicianLocations.find(loc => loc.technicianId === id);
                                    const isEnabled = tech?.isLocationEnabled === true;
                                    const statusIcon = isEnabled ? 'üìç' : 'üî¥';
                                    return `<option value="${id}">${technicianNames[id]} ${statusIcon}</option>`;
                                }).join('')}
                            </select>
                            <div style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
                                üìç = Location enabled | üî¥ = Location disabled
                            </div>
                        </div>
                    </div>
                    
                    <!-- Setup Guide (shown when no data) -->
                    ${technicianLocations.length === 0 ? `
                    <div id="trackingSetupGuide" style="margin-bottom: 20px; background: #dbeafe; border: 1px solid #93c5fd; border-radius: 8px; padding: 16px;">
                        <h3 style="margin: 0 0 12px 0; color: #1e40af; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            üí° Setup Guide
                        </h3>
                        <div style="font-size: 14px; color: #1e40af; line-height: 1.5;">
                            <p style="margin: 0 0 8px 0;"><strong>To enable technician tracking:</strong></p>
                            <ol style="margin: 0; padding-left: 20px;">
                                <li style="margin-bottom: 4px;">Technicians need to go to the <strong>Tracking</strong> tab</li>
                                <li style="margin-bottom: 4px;">Click <strong>Enable Location Sharing</strong></li>
                                <li style="margin-bottom: 4px;">Allow location permissions in their browser</li>
                                <li style="margin-bottom: 4px;">Location updates automatically every 5 minutes</li>
                                <li>You'll see all active technicians here on the map</li>
                            </ol>
                        </div>
                    </div>
                    ` : ''}
                    
                    <!-- Live Map First for Mobile Priority -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px; font-weight: 600;">üìç Live Map</h3>
                        <div class="card" style="padding: 0; overflow: hidden;">
                            <div id="trackingMap" style="height: 350px; width: 100%; position: relative; background: #f8fafc;">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div style="font-size: 48px; margin-bottom: 12px;">üó∫Ô∏è</div>
                                    <p style="color: var(--text-secondary); font-size: 14px; margin: 0;">Loading map...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Current Status Cards for Mobile -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px; font-weight: 600;">Current Status</h3>
                        <div id="technicianStatusCards">
            `;

            // Get current status for each technician
            const entriesSnapshot = await getDocs(collection(db, 'siteEntries'));
            const currentEntries = [];
            entriesSnapshot.forEach(doc => {
                const entry = doc.data();
                if (!entry.exitTime) {
                    currentEntries.push({ id: doc.id, ...entry });
                }
            });

            if (currentEntries.length === 0) {
                html += `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary); background: white; border-radius: 8px; border: 1px solid var(--border);">
                        üìç No active site visits
                    </div>
                `;
            } else {
                for (const entry of currentEntries) {
                    const lastLocation = technicianLocations.find(loc => loc.technicianId === entry.technicianId);
                    const statusColor = entry.status === 'ON_SITE' ? '#16a34a' : '#64748b';
                    const statusText = entry.status === 'ON_SITE' ? 'ON SITE' : 'OFF SITE';
                    
                    html += `
                        <div class="technician-status-card" data-technician-id="${entry.technicianId}" style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                                <div>
                                    <h4 style="margin: 0 0 4px 0; color: var(--text-primary); font-size: 16px; font-weight: 600;">${entry.technicianName}</h4>
                                    <span style="background: ${statusColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">${statusText}</span>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 12px; color: var(--text-secondary);">Battery</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${lastLocation ? lastLocation.battery + '%' : '-'}</div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 8px;">
                                <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 2px;">Current Site</div>
                                <div style="font-weight: 500; color: var(--text-primary);">${entry.siteName}</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">${entry.siteLocation}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 12px;">
                                <div>
                                    <div style="color: var(--text-secondary); margin-bottom: 2px;">Arrival Time</div>
                                    <div style="font-weight: 500;">${entry.arrivalTimestamp ? new Date(entry.arrivalTimestamp).toLocaleTimeString('en-IN') : '-'}</div>
                                </div>
                                <div>
                                    <div style="color: var(--text-secondary); margin-bottom: 2px;">Travel Time</div>
                                    <div style="font-weight: 500;">${entry.travelTimeMinutes ? entry.travelTimeMinutes + ' mins' : '-'}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            html += `
                        </div>
                    </div>
                    
                    <!-- All Technicians Status -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px; font-weight: 600;">üë• All Technicians (${allTechnicianIds.length})</h3>
                        <div class="card">
                            <div id="allTechnicianStatus" style="max-height: 400px; overflow-y: auto;">
            `;
            
            if (allTechnicianIds.length === 0) {
                html += '<div style="text-align: center; padding: 30px; color: var(--text-secondary);">üë∑ No technicians found</div>';
            } else {
                // Show all technicians with their status
                allTechnicianIds.forEach(techId => {
                    const techName = technicianNames[techId];
                    const latestLoc = technicianLocations.find(loc => loc.technicianId === techId);
                    
                    console.log(`üë§ Processing technician ${techName} (${techId}):`, {
                        hasLatestLoc: !!latestLoc,
                        latestLoc: latestLoc,
                        isLocationEnabled: latestLoc?.isLocationEnabled,
                        locationStatus: latestLoc?.locationStatus,
                        hasCoordinates: !!(latestLoc?.latitude && latestLoc?.longitude)
                    });
                    
                    // Check if technician has enabled location sharing
                    const isLocationEnabled = latestLoc?.isLocationEnabled === true;
                    const hasCoordinates = latestLoc && latestLoc.latitude && latestLoc.longitude;
                    
                    console.log(`  ‚Üí isLocationEnabled: ${isLocationEnabled}, hasCoordinates: ${hasCoordinates}`);
                    
                    if (isLocationEnabled) {
                        if (hasCoordinates) {
                            // Technician with location enabled and coordinates available
                            const locDate = new Date(latestLoc.timestamp || latestLoc.lastUpdate);
                            const now = new Date();
                            const diffMinutes = Math.floor((now - locDate) / 60000);
                            let timeAgo = '';
                            if (diffMinutes < 1) timeAgo = 'Just now';
                            else if (diffMinutes < 60) timeAgo = `${diffMinutes} min ago`;
                            else if (diffMinutes < 1440) timeAgo = `${Math.floor(diffMinutes / 60)} hours ago`;
                            else timeAgo = locDate.toLocaleDateString('en-IN');
                            
                            // Determine status color and text based on data freshness
                            const isActive = latestLoc.isDataFresh && diffMinutes < 10;
                            const statusBg = isActive ? '#16a34a' : '#dc2626';
                            const statusText = isActive ? 'üìç ACTIVE' : '‚ùå INACTIVE (Stale)';
                            const itemBg = isActive ? '#f0fdf4' : '#fee2e2';
                            
                            html += `
                                <div class="technician-location-item" data-technician-id="${techId}" style="padding: 16px; border-bottom: 1px solid var(--border); background: ${itemBg};">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                <span style="font-weight: 600; color: var(--text-primary); font-size: 15px;">
                                                    ${techName}
                                                </span>
                                                <span style="background: ${statusBg}; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                                    ${statusText}
                                                </span>
                                            </div>
                                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">
                                                üìç ${latestLoc.latitude.toFixed(6)}, ${latestLoc.longitude.toFixed(6)}
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">
                                                Last updated: ${timeAgo}
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 600; color: ${(latestLoc.battery || 0) > 50 ? 'var(--success)' : (latestLoc.battery || 0) > 20 ? 'var(--warning)' : 'var(--danger)'}; margin-bottom: 4px;">
                                                üîã ${latestLoc.battery || 0}%
                                            </div>
                                            <div style="font-size: 12px; color: var(--text-secondary);">
                                                ¬±${(latestLoc.accuracy || 0).toFixed(0)}m
                                            </div>
                                        </div>
                                    </div>
                                    <button 
                                        class="btn btn-sm btn-primary" 
                                        onclick="focusOnTechnician('${techId}', ${latestLoc.latitude}, ${latestLoc.longitude})"
                                        style="padding: 6px 12px; font-size: 13px;">
                                        üéØ View on Map
                                    </button>
                                </div>
                            `;
                        } else {
                            // Technician has enabled location sharing but no coordinates yet
                            html += `
                                <div class="technician-location-item" data-technician-id="${techId}" style="padding: 16px; border-bottom: 1px solid var(--border); background: #dbeafe;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="flex: 1;">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                <span style="font-weight: 600; color: var(--text-primary); font-size: 15px;">
                                                    ${techName}
                                                </span>
                                                <span style="background: #3b82f6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                                    üì± WAITING
                                                </span>
                                            </div>
                                            <div style="font-size: 13px; color: var(--text-secondary);">
                                                Location sharing active - waiting for first update...
                                            </div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-size: 12px; color: var(--text-secondary);">
                                                No location yet
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    } else {
                        // Technician without location enabled
                        html += `
                            <div class="technician-location-item" data-technician-id="${techId}" style="padding: 16px; border-bottom: 1px solid var(--border); background: #fef3c7;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <span style="font-weight: 600; color: var(--text-primary); font-size: 15px;">
                                                ${techName}
                                            </span>
                                            <span style="background: #ef4444; color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 500;">
                                                üî¥ LOCATION DISABLED
                                            </span>
                                        </div>
                                        <div style="font-size: 13px; color: var(--text-secondary);">
                                            Location sharing not enabled
                                        </div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 12px; color: var(--text-secondary);">
                                            No data
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
            }
            
            html += `
                            </div>
                        </div>
                    </div>

                    <!-- Recent Alerts -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px; font-weight: 600;">Recent Alerts</h3>
                        <div class="card">
                            <div id="recentAlertsList" style="max-height: 300px; overflow-y: auto;">
            `;

            if (geofenceAlerts.length === 0) {
                html += '<div style="text-align: center; padding: 30px; color: var(--text-secondary);">üîî No alerts yet</div>';
            } else {
                geofenceAlerts.slice(0, 10).forEach(alert => {
                    const typeColor = alert.type === 'ARRIVAL' ? '#16a34a' : '#ea580c';
                    const typeText = alert.type === 'ARRIVAL' ? 'ARRIVAL' : 'EXIT';
                    
                    html += `
                        <div style="padding: 12px; border-bottom: 1px solid var(--border); last-child:border-bottom: none;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <span style="background: ${typeColor}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">${typeText}</span>
                                <span style="font-size: 12px; color: var(--text-secondary);">${alert.time}</span>
                            </div>
                            <div style="margin-bottom: 4px;">
                                <span style="font-weight: 600; color: var(--text-primary);">${alert.technicianName}</span>
                                <span style="color: var(--text-secondary); margin-left: 8px;">${alert.siteName}</span>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary);">${alert.message}</div>
                        </div>
                    `;
                });
            }

            html += `
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div style="margin-bottom: 24px;">
                        <h3 style="color: var(--text-primary); margin-bottom: 12px; font-size: 16px; font-weight: 600;">Quick Actions</h3>
                        <div class="tracking-actions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                            <button class="btn btn-primary" style="padding: 12px; border-radius: 8px;" onclick="refreshTrackingData()">
                                üîÑ Refresh Data
                            </button>
                            <button class="btn btn-secondary" style="padding: 12px; border-radius: 8px;" onclick="exportTrackingReport()">
                                üìä Export Report
                            </button>
                            <button class="btn btn-success" style="padding: 12px; border-radius: 8px;" onclick="viewFullScreenMap()">
                                üó∫Ô∏è Full Screen Map
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Inject into trackingContent div
            const trackingContent = document.getElementById('trackingContent');
            if (trackingContent) {
                trackingContent.innerHTML = html;
            } else {
                console.error('trackingContent div not found!');
            }
        };
        
        // Refresh tracking data - reload everything
        window.refreshTrackingData = async () => {
            try {
                console.log('üîÑ Refreshing tracking data...');
                
                // Show loading indicator
                const trackingContent = document.getElementById('trackingContent');
                if (trackingContent) {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.id = 'refreshLoadingIndicator';
                    loadingDiv.style.cssText = 'position: fixed; top: 80px; right: 20px; background: #3b82f6; color: white; padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; font-weight: 600;';
                    loadingDiv.innerHTML = 'üîÑ Refreshing data...';
                    document.body.appendChild(loadingDiv);
                    
                    // Clear existing map if it exists
                    if (trackingMap) {
                        console.log('üó∫Ô∏è Clearing existing map...');
                        trackingMap.remove();
                        trackingMap = null;
                        trackingMarkers = [];
                    }
                    
                    // Reload all tracking data
                    await loadTechnicianTracking();
                    
                    // Reinitialize the map completely
                    console.log('üó∫Ô∏è Reinitializing map...');
                    await initializeTrackingMap();
                    
                    // Small delay to ensure map is ready
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // Refresh the tracking display
                    await showTechnicianTracking();
                    
                    // Update map markers
                    if (trackingMap) {
                        await updateTechnicianMarkers();
                    }
                    
                    // Show success message
                    loadingDiv.innerHTML = '‚úÖ Data refreshed!';
                    loadingDiv.style.background = '#16a34a';
                    
                    // Remove indicator after 2 seconds
                    setTimeout(() => {
                        if (loadingDiv && loadingDiv.parentNode) {
                            loadingDiv.remove();
                        }
                    }, 2000);
                    
                    console.log('‚úÖ Tracking data refreshed successfully');
                } else {
                    alert('‚ùå Could not refresh - tracking content not found');
                }
            } catch (error) {
                console.error('Error refreshing tracking data:', error);
                alert('‚ùå Failed to refresh data. Please try again.');
                
                // Remove loading indicator if exists
                const loadingDiv = document.getElementById('refreshLoadingIndicator');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }
        };
        
        // Filter technician tracking by technician ID
        window.filterTechnicianTracking = (technicianId) => {
            const statusCards = document.querySelectorAll('.technician-status-card');
            const locationItems = document.querySelectorAll('.technician-location-item');
            
            if (technicianId === 'all') {
                // Show all
                statusCards.forEach(card => card.style.display = 'block');
                locationItems.forEach(item => item.style.display = 'block');
            } else {
                // Filter by technician
                statusCards.forEach(card => {
                    if (card.dataset.technicianId === technicianId) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
                locationItems.forEach(item => {
                    if (item.dataset.technicianId === technicianId) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            }
        };
        
        // Focus map on specific technician
        window.focusOnTechnician = (technicianId, lat, lng) => {
            if (trackingMap) {
                trackingMap.setView([lat, lng], 15);
                // Highlight marker if exists
                trackingMarkers.forEach(marker => {
                    if (marker.technicianId === technicianId) {
                        marker.openPopup();
                    }
                });
            }
        };

        // Export tracking report to PDF
        window.exportTrackingReport = async () => {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Add company header
                await addCompanyHeaderToPDF(doc, 'Technician Tracking Report');
                
                let yPos = 70;
                
                // Get all technicians
                const technicians = JSON.parse(localStorage.getItem('employees') || '[]')
                    .filter(emp => emp.role === 'technician' || emp.role === 'Technician');
                
                // Report date and time
                doc.setFontSize(10);
                doc.setTextColor(100);
                doc.text(`Report Generated: ${new Date().toLocaleString()}`, 20, yPos);
                yPos += 15;
                
                // Get location history
                const locationHistory = JSON.parse(localStorage.getItem('technicianLocationHistory') || '{}');
                
                // Summary section
                doc.setFontSize(14);
                doc.setTextColor(0);
                doc.setFont(undefined, 'bold');
                doc.text('Tracking Summary', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                let activeTechs = 0;
                let totalLocations = 0;
                
                technicians.forEach(tech => {
                    const history = locationHistory[tech.id] || [];
                    if (history.length > 0) {
                        activeTechs++;
                        totalLocations += history.length;
                    }
                });
                
                doc.text(`Total Technicians: ${technicians.length}`, 20, yPos);
                yPos += 6;
                doc.text(`Active Tracking: ${activeTechs}`, 20, yPos);
                yPos += 6;
                doc.text(`Total Location Updates: ${totalLocations}`, 20, yPos);
                yPos += 15;
                
                // Detailed tracking data
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Technician Details', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                
                technicians.forEach((tech, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    const history = locationHistory[tech.id] || [];
                    const lastLocation = history.length > 0 ? history[history.length - 1] : null;
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`${index + 1}. ${tech.name}`, 20, yPos);
                    yPos += 6;
                    
                    doc.setFont(undefined, 'normal');
                    doc.text(`Employee ID: ${tech.employeeId}`, 25, yPos);
                    yPos += 5;
                    doc.text(`Contact: ${tech.contact}`, 25, yPos);
                    yPos += 5;
                    doc.text(`Total Updates: ${history.length}`, 25, yPos);
                    yPos += 5;
                    
                    if (lastLocation) {
                        doc.text(`Last Location: ${new Date(lastLocation.timestamp).toLocaleString()}`, 25, yPos);
                        yPos += 5;
                        doc.text(`Coordinates: ${lastLocation.lat.toFixed(6)}, ${lastLocation.lng.toFixed(6)}`, 25, yPos);
                        yPos += 5;
                        
                        if (lastLocation.projectName) {
                            doc.text(`Near Project: ${lastLocation.projectName}`, 25, yPos);
                            yPos += 5;
                        }
                    } else {
                        doc.setTextColor(150);
                        doc.text('No location data available', 25, yPos);
                        doc.setTextColor(0);
                        yPos += 5;
                    }
                    
                    yPos += 5;
                });
                
                // Add footer
                await addCompanyFooterToPDF(doc);
                
                // Save the PDF
                doc.save(`Tracking_Report_${new Date().toISOString().split('T')[0]}.pdf`);
                
            } catch (error) {
                console.error('Error generating tracking report:', error);
                alert('Error generating tracking report. Please try again.');
            }
        };

        // View map in fullscreen mode
        window.viewFullScreenMap = () => {
            const mapContainer = document.getElementById('trackingMapContainer');
            
            if (!mapContainer) {
                alert('Map container not found');
                return;
            }
            
            // Request fullscreen
            if (mapContainer.requestFullscreen) {
                mapContainer.requestFullscreen();
            } else if (mapContainer.webkitRequestFullscreen) {
                mapContainer.webkitRequestFullscreen();
            } else if (mapContainer.msRequestFullscreen) {
                mapContainer.msRequestFullscreen();
            } else if (mapContainer.mozRequestFullScreen) {
                mapContainer.mozRequestFullScreen();
            } else {
                alert('Fullscreen mode is not supported by your browser');
                return;
            }
            
            // Add fullscreen styling
            const fullscreenStyle = document.createElement('style');
            fullscreenStyle.id = 'fullscreen-map-style';
            fullscreenStyle.textContent = `
                #trackingMapContainer:fullscreen {
                    width: 100vw !important;
                    height: 100vh !important;
                    z-index: 999999;
                }
                #trackingMapContainer:fullscreen #trackingMap {
                    width: 100% !important;
                    height: 100% !important;
                }
            `;
            
            if (!document.getElementById('fullscreen-map-style')) {
                document.head.appendChild(fullscreenStyle);
            }
            
            // Resize map after fullscreen
            setTimeout(() => {
                if (trackingMap) {
                    trackingMap.invalidateSize();
                }
            }, 100);
            
            // Listen for fullscreen exit
            document.addEventListener('fullscreenchange', function fullscreenHandler() {
                if (!document.fullscreenElement) {
                    // Exited fullscreen, resize map back
                    setTimeout(() => {
                        if (trackingMap) {
                            trackingMap.invalidateSize();
                        }
                    }, 100);
                    document.removeEventListener('fullscreenchange', fullscreenHandler);
                }
            });
        };

        // Initialize tracking when app loads
        window.addEventListener('load', async () => {
            await loadTechnicianTracking();
            
            // Auto-refresh tracking data every 30 seconds
            setInterval(async () => {
                await loadTechnicianTracking();
                // Refresh admin dashboard if currently on tracking tab
                if (document.querySelector('#trackingTabContent .tracking-container')) {
                    await showTechnicianTracking();
                }
            }, 30000); // 30 seconds
            
            // Set up real-time listeners for location status changes
            if (typeof db !== 'undefined') {
                // Listen to changes in currentTechnicianLocations for immediate updates
                console.log('Setting up real-time listeners for tracking...');
                
                // Real-time location tracking with smooth updates
                onSnapshot(collection(db, 'currentTechnicianLocations'), async (snapshot) => {
                    console.log('üìç Location data changed, refreshing tracking...');
                    
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added' || change.type === 'modified') {
                            const techId = change.doc.id;
                            const newData = change.doc.data();
                            
                            console.log(`üöó Live update for ${techId}:`, {
                                lat: newData.latitude,
                                lng: newData.longitude,
                                timestamp: new Date(newData.timestamp).toLocaleTimeString()
                            });
                            
                            // Check for geofence breach
                            if (newData.latitude && newData.longitude) {
                                await checkGeofenceBreach(techId, newData);
                            }
                            
                            // Update tracking data and map smoothly
                            await loadTechnicianTracking();
                            if (document.querySelector('#trackingTab')) {
                                await showTechnicianTracking();
                                if (window.updateTechnicianMarkers) {
                                    updateTechnicianMarkers();
                                }
                            }
                        }
                    });
                });
                
                // Listen to system notifications for immediate status updates
                onSnapshot(collection(db, 'systemNotifications'), async (snapshot) => {
                    snapshot.docChanges().forEach(async (change) => {
                        if (change.type === 'added') {
                            const notificationData = change.doc.data();
                            if (notificationData.type === 'location_enabled' || notificationData.type === 'location_disabled') {
                                console.log('üì± Location status notification:', notificationData);
                                
                                await loadTechnicianTracking();
                                if (document.querySelector('#trackingTab')) {
                                    await showTechnicianTracking();
                                    if (window.updateTechnicianMarkers) {
                                        updateTechnicianMarkers();
                                    }
                                }
                                
                                // Clean up notification
                                setTimeout(async () => {
                                    try {
                                        await deleteDoc(change.doc.ref);
                                    } catch (error) {
                                        console.log('Error deleting notification:', error);
                                    }
                                }, 5000);
                            }
                        }
                    });
                });
                
                // Listen to current technician locations for real-time updates
                onSnapshot(collection(db, 'currentTechnicianLocations'), async (snapshot) => {
                    console.log('Technician locations updated');
                    await loadTechnicianTracking();
                    if (window.updateTechnicianMarkers) {
                        updateTechnicianMarkers();
                    }
                });
            }
        });

        // Export functions for technician mobile app
        window.technicianTrackingAPI = {
            sendLocation: processTechnicianLocation,
            getTechnicianStatus: async (technicianId) => {
                const entries = await getDocs(collection(db, 'siteEntries'));
                let currentEntry = null;
                entries.forEach(doc => {
                    const entry = doc.data();
                    if (entry.technicianId === technicianId && !entry.exitTime) {
                        currentEntry = { id: doc.id, ...entry };
                    }
                });
                return currentEntry;
            }
        };

        // MapTiler Integration for Tracking

        // OpenStreetMap with Leaflet Integration for Tracking (No API Key Required)
        let trackingMap = null;
        let trackingMarkers = [];

        // Console log capture for mobile debugging
        let consoleLogs = [];
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        console.log = function(...args) {
            const timestamp = new Date().toLocaleTimeString('en-IN');
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ');
            consoleLogs.push({ type: 'log', time: timestamp, message });
            if (consoleLogs.length > 200) consoleLogs.shift(); // Keep last 200 logs
            originalConsoleLog.apply(console, args);
        };

        console.error = function(...args) {
            const timestamp = new Date().toLocaleTimeString('en-IN');
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ');
            consoleLogs.push({ type: 'error', time: timestamp, message });
            if (consoleLogs.length > 200) consoleLogs.shift();
            originalConsoleError.apply(console, args);
        };

        console.warn = function(...args) {
            const timestamp = new Date().toLocaleTimeString('en-IN');
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)).join(' ');
            consoleLogs.push({ type: 'warn', time: timestamp, message });
            if (consoleLogs.length > 200) consoleLogs.shift();
            originalConsoleWarn.apply(console, args);
        };

        // Show console viewer modal
        window.showConsoleViewer = function() {
            const modal = document.getElementById('consoleViewerModal');
            const consoleOutput = document.getElementById('consoleOutput');
            
            // Build console output HTML
            let html = '';
            if (consoleLogs.length === 0) {
                html = '<div style="padding: 20px; text-align: center; color: #64748b;">No console logs yet. Refresh the tracking page to see logs.</div>';
            } else {
                consoleLogs.forEach(log => {
                    let color = '#1e293b';
                    let icon = 'üìù';
                    let bgColor = '#f8fafc';
                    
                    if (log.type === 'error') {
                        color = '#dc2626';
                        icon = '‚ùå';
                        bgColor = '#fee2e2';
                    } else if (log.type === 'warn') {
                        color = '#d97706';
                        icon = '‚ö†Ô∏è';
                        bgColor = '#fef3c7';
                    }
                    
                    html += `
                        <div style="padding: 12px; border-bottom: 1px solid #e2e8f0; background: ${bgColor}; margin-bottom: 4px; border-radius: 4px;">
                            <div style="font-size: 11px; color: #64748b; margin-bottom: 4px;">${icon} ${log.time}</div>
                            <div style="color: ${color}; font-size: 13px; font-family: 'Courier New', monospace; white-space: pre-wrap; word-break: break-all;">${log.message}</div>
                        </div>
                    `;
                });
            }
            
            consoleOutput.innerHTML = html;
            consoleOutput.scrollTop = consoleOutput.scrollHeight; // Scroll to bottom
            modal.style.display = 'flex';
        };

        // Close console viewer
        window.closeConsoleViewer = function() {
            document.getElementById('consoleViewerModal').style.display = 'none';
        };

        // Clear console logs
        window.clearConsoleLogs = function() {
            consoleLogs = [];
            showConsoleViewer();
        };

        // Copy console logs
        window.copyConsoleLogs = function() {
            const text = consoleLogs.map(log => `[${log.time}] ${log.type.toUpperCase()}: ${log.message}`).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Console logs copied to clipboard!');
            }).catch(() => {
                alert('‚ùå Failed to copy. Please select and copy manually.');
            });
        };

        // Initialize Leaflet map for tracking
        window.initializeTrackingMap = async () => {
            const mapElement = document.getElementById('trackingMap');
            if (!mapElement) {
                console.log('Map element not found');
                return;
            }

            try {
                // Show loading state immediately
                mapElement.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 350px; background: #f8fafc;">
                        <div style="font-size: 48px; margin-bottom: 12px;">üó∫Ô∏è</div>
                        <p style="color: #64748b; font-size: 14px; margin: 0;">Loading map...</p>
                    </div>
                `;
                
                // Check if Leaflet is available
                if (typeof L === 'undefined') {
                    console.log('Leaflet not loaded, loading now...');
                    mapElement.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 350px; background: #f8fafc;">
                            <div style="font-size: 48px; margin-bottom: 12px;">‚è≥</div>
                            <p style="color: #64748b; font-size: 14px; margin: 0;">Loading map library...</p>
                        </div>
                    `;
                    await loadLeafletAPI();
                    
                    // Wait a bit for Leaflet to be ready
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                // Clear existing map content and ensure it has the right ID
                mapElement.innerHTML = '';
                mapElement.style.height = '350px';

                // Create map with OpenStreetMap tiles
                trackingMap = L.map('trackingMap', {
                    center: [28.6139, 77.2090], // Default to Delhi [lat, lng]
                    zoom: 12,
                    zoomControl: true,
                    scrollWheelZoom: true,
                    doubleClickZoom: true,
                    touchZoom: true,
                    dragging: true,
                    preferCanvas: true, // Better performance on mobile
                    attributionControl: false // Remove attribution for cleaner look
                });

                // Add OpenStreetMap tile layer (no API key needed) with faster loading
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap',
                    maxZoom: 19,
                    subdomains: ['a', 'b', 'c'],
                    detectRetina: true,
                    updateWhenIdle: true,
                    updateWhenZooming: false,
                    keepBuffer: 2
                }).addTo(trackingMap);

                console.log('‚úÖ OpenStreetMap with Leaflet loaded successfully');

                // Force map to refresh its size
                setTimeout(() => {
                    if (trackingMap) {
                        trackingMap.invalidateSize();
                    }
                }, 100);

                // Add markers for technicians
                await updateTechnicianMarkers();

                // Show message if no technicians are active
                if (trackingMarkers.length === 0) {
                    setTimeout(() => showMapMessage(), 500);
                }

            } catch (error) {
                console.error('Error initializing Leaflet map:', error);
                showMapFallback('Map initialization failed', error.message);
            }
        };

        // Show map fallback when Leaflet fails
        function showMapFallback(title = 'Map loading failed', message = 'Check internet connection') {
            const mapElement = document.getElementById('trackingMap');
            if (mapElement) {
                mapElement.innerHTML = `
                    <div style="height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; background: #f8fafc; padding: 20px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 12px;">üó∫Ô∏è</div>
                        <h3 style="color: var(--text-primary); margin: 0 0 8px 0; font-size: 16px;">${title}</h3>
                        <p style="color: var(--text-secondary); margin: 0 0 16px 0; font-size: 14px;">${message}</p>
                        <button onclick="attemptMapLoad()" style="background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500;">
                            üîÑ Retry
                        </button>
                        <div style="margin-top: 16px; padding: 12px; background: #dbeafe; border-radius: 6px; font-size: 12px; color: #1e40af;">
                            üí° Using OpenStreetMap - No API key required!
                        </div>
                    </div>
                `;
            }
        }

        // Show informational message on map
        function showMapMessage() {
            if (!trackingMap || typeof L === 'undefined') return;
            
            // Create a temporary popup
            const popup = L.popup({
                closeButton: false,
                autoClose: true,
                closeOnEscapeKey: true,
                className: 'info-popup'
            })
            .setLatLng([28.6139, 77.2090])
            .setContent(`
                <div style="padding: 12px; text-align: center; min-width: 200px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                    <h4 style="margin: 0 0 8px 0; color: #2563eb; font-size: 14px;">‚ÑπÔ∏è No active technicians</h4>
                    <p style="margin: 0; font-size: 12px; color: #64748b; line-height: 1.4;">Add projects with coordinates and assign technicians to see them here</p>
                </div>
            `)
            .openOn(trackingMap);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (trackingMap) {
                    trackingMap.closePopup(popup);
                }
            }, 5000);
        }

        // Attempt to load map manually
        window.attemptMapLoad = () => {
            loadLeafletAPI().then(() => {
                setTimeout(() => initializeTrackingMap(), 500);
            }).catch(err => {
                console.error('Failed to load Leaflet:', err);
                showMapFallback('Failed to load map library', 'Please check your internet connection');
            });
        };

        // Update technician markers on map
        window.updateTechnicianMarkers = async () => {
            if (!trackingMap || typeof L === 'undefined') return;

            try {
                // Clear existing markers (but keep the default one)
                trackingMarkers.forEach(marker => trackingMap.removeLayer(marker));
                trackingMarkers = [];

                // Add markers for all technicians with location sharing enabled
                const coordinates = [];

                for (const location of technicianLocations) {
                    const hasLocationSharing = location.locationSharingEnabled === true || location.locationStatus === 'enabled';
                    
                    if (hasLocationSharing && location.latitude && location.longitude) {
                        const latLng = [location.latitude, location.longitude];
                        coordinates.push(latLng);

                        // Check if technician is currently on a site
                        const currentEntry = await checkTechnicianSiteStatus(location.technicianId);
                        const markerColor = currentEntry && currentEntry.status === 'ON_SITE' ? '#16a34a' : '#3b82f6'; // Green for on-site, blue for location enabled
                        
                        // Determine actual location status based on data freshness
                        const locationStatusText = location.isDataFresh && location.isLocationEnabled ? 'ACTIVE' : 'INACTIVE (Stale Data)';
                        const locationStatusColor = location.isDataFresh && location.isLocationEnabled ? '#16a34a' : '#dc2626';
                        const locationStatusIcon = location.isDataFresh && location.isLocationEnabled ? 'üìç' : '‚ùå';
                        
                        const markerIcon = L.divIcon({
                            className: 'custom-technician-marker',
                            html: `
                                <div style="
                                    width: 24px; 
                                    height: 24px; 
                                    background: ${markerColor}; 
                                    border: 3px solid white; 
                                    border-radius: 50%; 
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                                    cursor: pointer;
                                    position: relative;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    font-size: 12px;
                                    font-weight: bold;
                                    color: white;
                                ">
                                    ${currentEntry && currentEntry.status === 'ON_SITE' ? '‚óè' : 'üìç'}
                                </div>
                            `,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15],
                            popupAnchor: [0, -15]
                        });

                        // Create popup content
                        const popupContent = `
                            <div style="padding: 8px; min-width: 200px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
                                <h4 style="margin: 0 0 8px 0; color: #1e40af; font-size: 14px;">${location.technicianName}</h4>
                                <p style="margin: 4px 0; font-size: 12px;"><strong>Location Status:</strong> 
                                    <span style="color: ${locationStatusColor}; font-weight: 600;">${locationStatusIcon} ${locationStatusText}</span>
                                </p>
                                ${currentEntry ? `
                                    <p style="margin: 4px 0; font-size: 12px;"><strong>Site Status:</strong> 
                                        <span style="color: ${markerColor}; font-weight: 600;">${currentEntry.status === 'ON_SITE' ? 'ON SITE' : 'OFF SITE'}</span>
                                    </p>
                                    <p style="margin: 4px 0; font-size: 12px;"><strong>Site:</strong> ${currentEntry.siteName || 'N/A'}</p>
                                    <p style="margin: 4px 0; font-size: 12px;"><strong>Location:</strong> ${currentEntry.siteLocation || 'N/A'}</p>
                                ` : `
                                    <p style="margin: 4px 0; font-size: 12px;"><strong>Status:</strong> Available</p>
                                `}
                                <p style="margin: 4px 0; font-size: 12px;"><strong>Battery:</strong> ${location.battery || 0}%</p>
                                <p style="margin: 4px 0; font-size: 12px;"><strong>Last Update:</strong> 
                                    ${new Date(location.timestamp || location.lastUpdate).toLocaleString('en-IN')}
                                </p>
                                <p style="margin: 4px 0; font-size: 12px;"><strong>Coordinates:</strong> ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}</p>
                            </div>
                        `;

                        // Create marker
                        const marker = L.marker(latLng, { icon: markerIcon })
                            .addTo(trackingMap)
                            .bindPopup(popupContent);

                        trackingMarkers.push(marker);
                    }
                }

                // Fit map to show all markers
                if (coordinates.length > 0) {
                    if (coordinates.length === 1) {
                        // Single marker - just center on it
                        trackingMap.setView(coordinates[0], 14);
                    } else {
                        // Multiple markers - fit bounds
                        const group = new L.featureGroup(trackingMarkers);
                        trackingMap.fitBounds(group.getBounds().pad(0.1));
                    }
                } else {
                    // No markers - show default location
                    trackingMap.setView([28.6139, 77.2090], 12);
                }
            } catch (error) {
                console.error('Error updating technician markers:', error);
            }
        };

        // Helper function to check technician site status
        window.checkTechnicianSiteStatus = async (technicianId) => {
            try {
                const entriesSnapshot = await getDocs(collection(db, 'siteEntries'));
                let currentEntry = null;
                entriesSnapshot.forEach(doc => {
                    const entry = doc.data();
                    if (entry.technicianId === technicianId && !entry.exitTime) {
                        currentEntry = { id: doc.id, ...entry };
                    }
                });
                return currentEntry;
            } catch (error) {
                console.error('Error checking site status:', error);
                return null;
            }
        };

        // Load Leaflet API (OpenStreetMap)
        window.loadLeafletAPI = () => {
            if (typeof L !== 'undefined') {
                console.log('Leaflet already loaded');
                return Promise.resolve();
            }

            return new Promise((resolve, reject) => {
                let timeoutId;
                
                // Set a timeout for loading
                timeoutId = setTimeout(() => {
                    reject(new Error('Leaflet API loading timeout'));
                }, 15000); // 15 second timeout

                // Load CSS first
                const link = document.createElement('link');
                link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                link.rel = 'stylesheet';
                link.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
                link.crossOrigin = '';
                link.onload = () => {
                    console.log('Leaflet CSS loaded');
                };
                link.onerror = () => {
                    console.warn('Leaflet CSS failed to load');
                };
                document.head.appendChild(link);

                // Load main Leaflet JS
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                script.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
                script.crossOrigin = '';
                script.async = true;
                script.defer = true;
                
                script.onload = () => {
                    clearTimeout(timeoutId);
                    console.log('‚úÖ Leaflet API loaded successfully');
                    
                    // Test if L is actually available
                    if (typeof L !== 'undefined') {
                        resolve();
                    } else {
                        reject(new Error('Leaflet API loaded but L not available'));
                    }
                };
                
                script.onerror = () => {
                    clearTimeout(timeoutId);
                    console.error('‚ùå Failed to load Leaflet API');
                    reject(new Error('Failed to load Leaflet script'));
                };
                
                document.head.appendChild(script);
            });
        };

        // Email Configuration Functions
        window.updateEmailPorts = () => {
            const provider = document.getElementById('emailProvider').value;
            const smtpServer = document.getElementById('smtpServer');
            const smtpPort = document.getElementById('smtpPort');
            const smtpEncryption = document.getElementById('smtpEncryption');
            
            if (provider === 'gmail') {
                smtpServer.value = 'smtp.gmail.com';
                smtpPort.value = '587';
                smtpEncryption.value = 'TLS';
                smtpServer.readOnly = true;
                smtpPort.readOnly = true;
            } else if (provider === 'outlook') {
                smtpServer.value = 'smtp.office365.com';
                smtpPort.value = '587';
                smtpEncryption.value = 'TLS';
                smtpServer.readOnly = true;
                smtpPort.readOnly = true;
            } else if (provider === 'zoho') {
                smtpServer.value = 'smtp.zoho.com';
                smtpPort.value = '587';
                smtpEncryption.value = 'TLS';
                smtpServer.readOnly = true;
                smtpPort.readOnly = true;
            } else if (provider === 'custom') {
                smtpServer.value = '';
                smtpPort.value = '';
                smtpEncryption.value = 'TLS';
                smtpServer.readOnly = false;
                smtpPort.readOnly = false;
            } else {
                smtpServer.value = '';
                smtpPort.value = '';
                smtpEncryption.value = 'TLS';
                smtpServer.readOnly = true;
                smtpPort.readOnly = true;
            }
        };

        window.validateEmailConfig = async () => {
            const provider = document.getElementById('emailProvider').value;
            const smtpServer = document.getElementById('smtpServer').value;
            const smtpPort = document.getElementById('smtpPort').value;
            const senderEmail = document.getElementById('senderEmail').value;
            const appPassword = document.getElementById('appPassword').value;
            const senderName = document.getElementById('senderName').value;

            const statusDiv = document.getElementById('emailConfigStatus');
            const saveBtn = document.getElementById('saveEmailBtn');
            
            if (!provider || !smtpServer || !smtpPort || !senderEmail || !appPassword) {
                alert('Please fill in all required fields');
                return;
            }

            statusDiv.innerHTML = 'üîÑ Testing email configuration...';
            statusDiv.style.color = '#ea580c';

            try {
                // Here we'll simulate validation - in real implementation you'd test SMTP connection
                // For now, we'll validate the format and show success
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(senderEmail)) {
                    throw new Error('Invalid email address format');
                }

                if (appPassword.length < 8) {
                    throw new Error('App password seems too short. Please check your app password.');
                }

                // Simulate async validation
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                statusDiv.innerHTML = '‚úÖ Email configuration validated successfully! Ready to send emails.';
                statusDiv.style.color = '#16a34a';
                saveBtn.disabled = false;
                
            } catch (error) {
                statusDiv.innerHTML = `‚ùå Validation failed: ${error.message}`;
                statusDiv.style.color = '#dc2626';
                saveBtn.disabled = true;
            }
        };

        window.saveEmailConfig = () => {
            const emailConfig = {
                provider: document.getElementById('emailProvider').value,
                smtpServer: document.getElementById('smtpServer').value,
                smtpPort: document.getElementById('smtpPort').value,
                smtpEncryption: document.getElementById('smtpEncryption').value,
                senderEmail: document.getElementById('senderEmail').value,
                appPassword: document.getElementById('appPassword').value,
                senderName: document.getElementById('senderName').value,
                validated: true,
                savedAt: new Date().toISOString()
            };

            localStorage.setItem('emailConfig', JSON.stringify(emailConfig));
            
            const statusDiv = document.getElementById('emailConfigStatus');
            statusDiv.innerHTML = 'üíæ Email configuration saved successfully!';
            statusDiv.style.color = '#16a34a';
            
            alert('Email configuration saved successfully!');
        };

        // Load saved email configuration
        const loadEmailConfig = () => {
            const saved = localStorage.getItem('emailConfig');
            if (saved) {
                try {
                    const config = JSON.parse(saved);
                    document.getElementById('emailProvider').value = config.provider || '';
                    document.getElementById('smtpServer').value = config.smtpServer || '';
                    document.getElementById('smtpPort').value = config.smtpPort || '';
                    document.getElementById('smtpEncryption').value = config.smtpEncryption || 'TLS';
                    document.getElementById('senderEmail').value = config.senderEmail || '';
                    document.getElementById('appPassword').value = config.appPassword || '';
                    document.getElementById('senderName').value = config.senderName || '';
                    
                    if (config.validated) {
                        document.getElementById('emailConfigStatus').innerHTML = '‚úÖ Email configuration loaded and validated.';
                        document.getElementById('emailConfigStatus').style.color = '#16a34a';
                        document.getElementById('saveEmailBtn').disabled = false;
                    }
                } catch (e) {
                    console.error('Error loading email config:', e);
                }
            }
        };

        // Email sending function
        const sendEmailWithPDF = async (recipientEmail, recipientName, subject, body, pdfBlob, filename) => {
            const emailConfig = JSON.parse(localStorage.getItem('emailConfig') || '{}');
            
            if (!emailConfig.validated) {
                alert('Email is not configured. Please configure email settings first.');
                return false;
            }

            try {
                // Convert PDF blob to base64
                const reader = new FileReader();
                const base64PDF = await new Promise((resolve) => {
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(pdfBlob);
                });

                // Simulate email sending (in real implementation, this would call your backend API)
                console.log('Sending email...', {
                    to: recipientEmail,
                    from: emailConfig.senderEmail,
                    subject: subject,
                    body: body,
                    attachment: filename
                });

                // Simulate delay
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // For now, we'll show success message
                // In real implementation, you would call your backend email service
                alert(`Email sent successfully to ${recipientEmail}!`);
                return true;
                
            } catch (error) {
                console.error('Error sending email:', error);
                alert('Failed to send email: ' + error.message);
                return false;
            }
        };

        window.showAppPasswordHelp = () => {
            const helpText = `How to get App Password:

Gmail:
1. Go to Google Account settings
2. Security ‚Üí 2-Step Verification (must be enabled)
3. App passwords ‚Üí Generate new app password
4. Copy the 16-character password

Outlook/Hotmail:
1. Go to Microsoft Account Security
2. Advanced security options
3. App passwords ‚Üí Create new app password
4. Copy the generated password

Zoho:
1. Go to Zoho Account Settings
2. Security ‚Üí App Passwords
3. Generate new password for this app
4. Copy the password

Note: Regular account passwords won't work. You must use app-specific passwords.`;
            
            alert(helpText);
        };

        // Auto-load Leaflet when the page loads
        window.addEventListener('DOMContentLoaded', () => {
            loadLeafletAPI().catch(err => {
                console.log('Leaflet not loaded on startup:', err.message);
            });
            loadEmailConfig();
        });

        // ============================================
        // DIRECT EMAIL SENDING USING SMTP.JS
        // ============================================

        // Universal Email Sending Function using SMTP.js (No PHP required!)
        window.sendEmailDirectly = async (to, subject, htmlBody, pdfBlob, filename) => {
            const emailConfig = JSON.parse(localStorage.getItem('emailConfig') || '{}');
            
            if (!emailConfig.validated) {
                alert('‚ö†Ô∏è Email is not configured!\n\nPlease configure your email settings in the Settings tab before sending emails.');
                return false;
            }

            try {
                // Show sending progress
                const progressDiv = document.createElement('div');
                progressDiv.id = 'email-progress-indicator';
                progressDiv.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                    z-index: 10001; text-align: center; min-width: 300px;
                `;
                progressDiv.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 15px;">üìß</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Sending Email...</div>
                    <div style="color: #666; font-size: 14px;">Please wait while we send your ${filename}</div>
                    <div style="margin-top: 20px;">
                        <div style="width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                            <div style="width: 60%; height: 100%; background: linear-gradient(90deg, #2563eb, #7c3aed); animation: progress 1.5s ease-in-out infinite;"></div>
                        </div>
                    </div>
                `;
                document.body.appendChild(progressDiv);

                // Add animation style
                if (!document.getElementById('email-progress-style')) {
                    const style = document.createElement('style');
                    style.id = 'email-progress-style';
                    style.textContent = `
                        @keyframes progress {
                            0% { transform: translateX(-100%); }
                            50% { transform: translateX(100%); }
                            100% { transform: translateX(-100%); }
                        }
                    `;
                    document.head.appendChild(style);
                }

                // Convert PDF blob to base64
                const base64PDF = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(pdfBlob);
                });

                // Check if Email (SMTP.js) is loaded
                if (typeof Email === 'undefined' || !Email || !Email.send) {
                    throw new Error('SMTP.js library not loaded. Please refresh the page and try again.');
                }

                // Send email using SMTP.js - Direct email sending from JavaScript!
                const result = await Email.send({
                    Host: emailConfig.smtpServer,
                    Username: emailConfig.senderEmail,
                    Password: emailConfig.appPassword,
                    To: to,
                    From: emailConfig.senderEmail,
                    Subject: subject,
                    Body: htmlBody,
                    Attachments: [
                        {
                            name: filename,
                            data: base64PDF
                        }
                    ]
                });
                
                // Remove progress indicator
                const progress = document.getElementById('email-progress-indicator');
                if (progress) document.body.removeChild(progress);

                if (result === 'OK' || (typeof result === 'string' && result.includes('OK'))) {
                        // Show success message
                        const successModal = document.createElement('div');
                        successModal.style.cssText = `
                            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);
                            z-index: 10002; display: flex; align-items: center; justify-content: center; padding: 20px;
                        `;
                        successModal.innerHTML = `
                            <div style="background: white; padding: 40px; border-radius: 12px; max-width: 500px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                                <div style="font-size: 64px; margin-bottom: 20px;">‚úÖ</div>
                                <div style="font-size: 24px; font-weight: 600; color: #16a34a; margin-bottom: 10px;">Email Sent Successfully!</div>
                                <div style="color: #666; font-size: 14px; margin-bottom: 20px;">
                                    <p style="margin: 5px 0;"><strong>To:</strong> ${to}</p>
                                    <p style="margin: 5px 0;"><strong>Subject:</strong> ${subject}</p>
                                    <p style="margin: 5px 0;"><strong>Attachment:</strong> ${filename}</p>
                                </div>
                                <button onclick="this.parentElement.parentElement.remove()" style="
                                    background: #2563eb; color: white; border: none; padding: 12px 30px;
                                    border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;
                                ">Close</button>
                            </div>
                        `;
                        document.body.appendChild(successModal);

                        // Auto-close after 5 seconds
                        setTimeout(() => {
                            if (successModal.parentElement) {
                                document.body.removeChild(successModal);
                            }
                        }, 5000);
                } else {
                    throw new Error(result || 'Unknown error occurred');
                }

                return true;

            } catch (error) {
                console.error('‚ùå Email sending error:', error);
                
                // Remove progress if exists
                const progress = document.getElementById('email-progress-indicator');
                if (progress) document.body.removeChild(progress);

                // Show error modal
                const errorModal = document.createElement('div');
                errorModal.style.cssText = `
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5);
                    z-index: 10002; display: flex; align-items: center; justify-content: center; padding: 20px;
                `;
                errorModal.innerHTML = `
                    <div style="background: white; padding: 40px; border-radius: 12px; max-width: 500px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="font-size: 64px; margin-bottom: 20px;">‚ùå</div>
                        <div style="font-size: 24px; font-weight: 600; color: #dc2626; margin-bottom: 10px;">Failed to Send Email</div>
                        <div style="color: #666; font-size: 14px; margin-bottom: 20px;">
                            <p style="margin: 10px 0;"><strong>Error:</strong> ${error.message || error}</p>
                            <p style="margin: 10px 0; font-size: 12px;">Please check:</p>
                            <ul style="text-align: left; display: inline-block; font-size: 12px;">
                                <li>Email configuration in Settings</li>
                                <li>SMTP server and port are correct</li>
                                <li>App password (not regular password!)</li>
                                <li>Internet connection</li>
                            </ul>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: #dc2626; color: white; border: none; padding: 12px 30px;
                            border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer;
                        ">Close</button>
                    </div>
                `;
                document.body.appendChild(errorModal);

                return false;
            }
        };

        // Send Quotation Email
        window.sendQuotationEmail = async (quotId) => {
            try {
                const quot = quotations.find(q => q.id === quotId);
                if (!quot) {
                    alert('‚ùå Quotation not found!');
                    return;
                }

                if (!quot.clientEmail) {
                    alert('‚ö†Ô∏è No email address for this client!\n\nPlease add an email address to the quotation first.');
                    return;
                }

                // Generate PDF
                const pdfBlob = await generateQuotationPDFBlob(quot);
                
                // Get company info
                const companyInfo = await getCompanyInfo();

                // Email content
                const subject = `Quotation ${quot.quotationNumber} from ${companyInfo.name}`;
                const htmlBody = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <div style="background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%); color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0;">
                            <h1 style="margin: 0; font-size: 28px;">üìã Quotation</h1>
                            <p style="margin: 10px 0 0 0; opacity: 0.9;">from ${companyInfo.name}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 30px; border-radius: 0 0 8px 8px;">
                            <p>Dear ${quot.clientName},</p>
                            <p>Thank you for your interest in our elevator solutions. Please find attached our quotation for your project.</p>
                            
                            <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #2563eb;">
                                <p style="margin: 5px 0;"><strong>Quotation Number:</strong> ${quot.quotationNumber}</p>
                                <p style="margin: 5px 0;"><strong>Date:</strong> ${new Date(quot.date).toLocaleDateString()}</p>
                                <p style="margin: 5px 0;"><strong>Type:</strong> ${quot.type}</p>
                                <p style="margin: 15px 0 5px 0; font-size: 18px; color: #2563eb;"><strong>Total Amount: ‚Çπ${quot.totalAmount.toLocaleString('en-IN')}</strong></p>
                            </div>

                            <p>Best Regards,<br><strong>${companyInfo.name}</strong><br>${companyInfo.contact}</p>
                        </div>
                    </div>
                `;

                // Send email
                await sendEmailDirectly(
                    quot.clientEmail,
                    subject,
                    htmlBody,
                    pdfBlob,
                    `Quotation_${quot.quotationNumber}.pdf`
                );

            } catch (error) {
                console.error('Error sending quotation email:', error);
                alert('‚ùå Error sending quotation email: ' + error.message);
            }
        };

        // Send Proforma Invoice Email
        window.sendProformaInvoiceEmail = async (piId) => {
            try {
                const pi = proformaInvoices.find(p => p.id === piId);
                if (!pi) {
                    alert('‚ùå Proforma Invoice not found!');
                    return;
                }

                if (!pi.clientEmail) {
                    alert('‚ö†Ô∏è No email address for this client!');
                    return;
                }

                // Generate PDF
                const pdfBlob = await generatePIPDFBlob(pi);
                
                const companyInfo = await getCompanyInfo();
                const subject = `Proforma Invoice ${pi.piNumber} from ${companyInfo.name}`;
                const htmlBody = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <div style="background: linear-gradient(135deg, #16a34a 0%, #059669 100%); color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0;">
                            <h1 style="margin: 0; font-size: 28px;">üìÑ Proforma Invoice</h1>
                            <p style="margin: 10px 0 0 0; opacity: 0.9;">from ${companyInfo.name}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 30px; border-radius: 0 0 8px 8px;">
                            <p>Dear ${pi.clientName},</p>
                            <p>Please find attached our proforma invoice.</p>
                            
                            <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #16a34a;">
                                <p style="margin: 5px 0;"><strong>PI Number:</strong> ${pi.piNumber}</p>
                                <p style="margin: 5px 0;"><strong>Date:</strong> ${new Date(pi.date).toLocaleDateString()}</p>
                                <p style="margin: 15px 0 5px 0; font-size: 20px; color: #16a34a;"><strong>Total: ‚Çπ${pi.totalAmount.toLocaleString('en-IN')}</strong></p>
                                ${pi.paidAmount > 0 ? `<p style="margin: 5px 0;">Balance: ‚Çπ${pi.balanceAmount.toLocaleString('en-IN')}</p>` : ''}
                            </div>

                            <p>Best Regards,<br><strong>${companyInfo.name}</strong><br>${companyInfo.contact}</p>
                        </div>
                    </div>
                `;

                await sendEmailDirectly(pi.clientEmail, subject, htmlBody, pdfBlob, `PI_${pi.piNumber}.pdf`);

            } catch (error) {
                console.error('Error sending PI email:', error);
                alert('‚ùå Error: ' + error.message);
            }
        };

        // Send Tax Invoice Email
        window.sendTaxInvoiceEmail = async (tiId) => {
            try {
                const ti = taxInvoices.find(t => t.id === tiId);
                if (!ti) {
                    alert('‚ùå Tax Invoice not found!');
                    return;
                }

                if (!ti.clientEmail) {
                    alert('‚ö†Ô∏è No email address for this client!');
                    return;
                }

                // Generate PDF
                const pdfBlob = await generateTaxInvoicePDFBlob(ti);
                
                const companyInfo = await getCompanyInfo();
                const subject = `Tax Invoice ${ti.invoiceNumber} from ${companyInfo.name}`;
                const htmlBody = `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                        <div style="background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%); color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0;">
                            <h1 style="margin: 0; font-size: 28px;">üíµ Tax Invoice</h1>
                            <p style="margin: 10px 0 0 0; opacity: 0.9;">from ${companyInfo.name}</p>
                        </div>
                        <div style="background: #f8fafc; padding: 30px; border-radius: 0 0 8px 8px;">
                            <p>Dear ${ti.clientName},</p>
                            <p>Please find attached your tax invoice.</p>
                            
                            <div style="background: white; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #dc2626;">
                                <p style="margin: 5px 0;"><strong>Invoice Number:</strong> ${ti.invoiceNumber}</p>
                                <p style="margin: 5px 0;"><strong>Date:</strong> ${new Date(ti.date).toLocaleDateString()}</p>
                                <p style="margin: 15px 0 5px 0; font-size: 20px; color: #dc2626;"><strong>Amount: ‚Çπ${ti.totalAmount.toLocaleString('en-IN')}</strong></p>
                            </div>

                            <p>Thank you for your business!<br><strong>${companyInfo.name}</strong><br>${companyInfo.contact}</p>
                        </div>
                    </div>
                `;

                await sendEmailDirectly(ti.clientEmail, subject, htmlBody, pdfBlob, `Invoice_${ti.invoiceNumber}.pdf`);

            } catch (error) {
                console.error('Error sending invoice email:', error);
                alert('‚ùå Error: ' + error.message);
            }
        };

        // Helper: Generate Quotation PDF as Blob
        async function generateQuotationPDFBlob(quot) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let y = await addCompanyHeaderToPDF(doc, 'QUOTATION', 10);
            y += 5;
            
            doc.setFontSize(10);
            doc.text(`Quotation No: ${quot.quotationNumber}`, 15, y);
            doc.text(`Date: ${new Date(quot.date).toLocaleDateString()}`, 120, y);
            y += 6;
            doc.text(`Client: ${quot.clientName}`, 15, y);
            y += 15;
            
            // Items
            doc.setFont(undefined, 'bold');
            doc.text('Items', 15, y);
            y += 5;
            doc.setFont(undefined, 'normal');
            
            quot.items.forEach(item => {
                if (y > 250) { doc.addPage(); y = 20; }
                doc.text(`${item.description} - Qty: ${item.quantity} @ ‚Çπ${item.rate}`, 15, y);
                y += 5;
            });
            
            y += 10;
            doc.setFont(undefined, 'bold');
            doc.text(`Total: ‚Çπ${quot.totalAmount.toFixed(2)}`, 15, y);
            
            await addCompanyFooterToPDF(doc);
            return doc.output('blob');
        }

        // Helper: Generate PI PDF as Blob
        async function generatePIPDFBlob(pi) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = await addCompanyHeaderToPDF(doc, 'PROFORMA INVOICE', 10);
            y += 5;
            doc.setFontSize(10);
            doc.text(`PI No: ${pi.piNumber}`, 15, y);
            doc.text(`Date: ${new Date(pi.date).toLocaleDateString()}`, 120, y);
            y += 6;
            doc.text(`Client: ${pi.clientName}`, 15, y);
            y += 15;
            doc.setFont(undefined, 'bold');
            doc.text(`Total: ‚Çπ${pi.totalAmount.toFixed(2)}`, 15, y);
            await addCompanyFooterToPDF(doc);
            return doc.output('blob');
        }

        // Helper: Generate Tax Invoice PDF as Blob
        async function generateTaxInvoicePDFBlob(ti) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = await addCompanyHeaderToPDF(doc, 'TAX INVOICE', 10);
            y += 5;
            doc.setFontSize(10);
            doc.text(`Invoice No: ${ti.invoiceNumber}`, 15, y);
            doc.text(`Date: ${new Date(ti.date).toLocaleDateString()}`, 120, y);
            y += 6;
            doc.text(`Client: ${ti.clientName}`, 15, y);
            y += 15;
            doc.setFont(undefined, 'bold');
            doc.text(`Total: ‚Çπ${ti.totalAmount.toFixed(2)}`, 15, y);
            await addCompanyFooterToPDF(doc);
            return doc.output('blob');
        }

    </script>

    <!-- Console Viewer Modal -->
    <div id="consoleViewerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; padding: 16px;">
        <div style="background: white; border-radius: 12px; width: 100%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
            <!-- Header -->
            <div style="padding: 20px; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; color: #1e293b; font-size: 18px; display: flex; align-items: center; gap: 8px;">
                    üêõ Console Logs Viewer
                </h3>
                <button onclick="closeConsoleViewer()" style="background: #ef4444; color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;">√ó</button>
            </div>
            
            <!-- Console Output -->
            <div id="consoleOutput" style="flex: 1; overflow-y: auto; padding: 16px; background: #f8fafc; font-family: 'Courier New', monospace; font-size: 13px; max-height: 60vh;">
                <div style="padding: 20px; text-align: center; color: #64748b;">Loading console logs...</div>
            </div>
            
            <!-- Footer Actions -->
            <div style="padding: 16px; border-top: 2px solid #e2e8f0; display: flex; gap: 8px; flex-wrap: wrap;">
                <button onclick="showConsoleViewer()" style="flex: 1; min-width: 120px; background: #3b82f6; color: white; border: none; padding: 12px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    üîÑ Refresh
                </button>
                <button onclick="copyConsoleLogs()" style="flex: 1; min-width: 120px; background: #10b981; color: white; border: none; padding: 12px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    üìã Copy All
                </button>
                <button onclick="clearConsoleLogs()" style="flex: 1; min-width: 120px; background: #f59e0b; color: white; border: none; padding: 12px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    üóëÔ∏è Clear
                </button>
            </div>
        </div>
    </div>

</body>
</html>
